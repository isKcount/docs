<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.51" />
    <meta name="theme" content="VuePress Theme Hope" />
    <link rel="icon" href="/docs/favicon.ico"><link rel="icon" href="/docs/assets/icon/chrome-mask-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/docs/assets/icon/chrome-mask-192.png" type="image/png" sizes="192x192"><link rel="icon" href="/docs/assets/icon/chrome-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/docs/assets/icon/chrome-192.png" type="image/png" sizes="192x192"><link rel="manifest" href="/docs/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#46bd87"><link rel="apple-touch-icon" href="/docs/assets/icon/apple-icon-152.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="msapplication-TileImage" content="/docs/assets/icon/ms-icon-144.png"><meta name="msapplication-TileColor" content="#ffffff"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"><title>Istio由浅入深 | 文档</title><meta name="description" content="个人知识库">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="stylesheet" href="/docs/assets/style.737193c6.css">
    <link rel="modulepreload" href="/docs/assets/app.ca0279c0.js"><link rel="modulepreload" href="/docs/assets/3.Istio的深入浅.html.d77f2f53.js"><link rel="modulepreload" href="/docs/assets/_plugin-vue_export-helper.cdc0426e.js"><link rel="modulepreload" href="/docs/assets/3.Istio的深入浅.html.dc29aaa9.js"><link rel="prefetch" href="/docs/assets/index.html.8473212f.js"><link rel="prefetch" href="/docs/assets/slides.html.2891796f.js"><link rel="prefetch" href="/docs/assets/disable.html.67dd1591.js"><link rel="prefetch" href="/docs/assets/encrypt.html.f5a75447.js"><link rel="prefetch" href="/docs/assets/markdown.html.6892c1e4.js"><link rel="prefetch" href="/docs/assets/page.html.8749d940.js"><link rel="prefetch" href="/docs/assets/index.html.e8d21891.js"><link rel="prefetch" href="/docs/assets/index.html.567e3006.js"><link rel="prefetch" href="/docs/assets/index.html.3888991b.js"><link rel="prefetch" href="/docs/assets/slides.html.6fa8549b.js"><link rel="prefetch" href="/docs/assets/baz.html.eff7bc1f.js"><link rel="prefetch" href="/docs/assets/index.html.bf470a8e.js"><link rel="prefetch" href="/docs/assets/ray.html.ab4d4d47.js"><link rel="prefetch" href="/docs/assets/index.html.398bdbd5.js"><link rel="prefetch" href="/docs/assets/disable.html.67b6b72d.js"><link rel="prefetch" href="/docs/assets/encrypt.html.14fba031.js"><link rel="prefetch" href="/docs/assets/markdown.html.8674e0c5.js"><link rel="prefetch" href="/docs/assets/page.html.266bf470.js"><link rel="prefetch" href="/docs/assets/index.html.5da7f899.js"><link rel="prefetch" href="/docs/assets/index.html.52d7fb2c.js"><link rel="prefetch" href="/docs/assets/index.html.6c969872.js"><link rel="prefetch" href="/docs/assets/index.html.b71381de.js"><link rel="prefetch" href="/docs/assets/index.html.cdacec6d.js"><link rel="prefetch" href="/docs/assets/index.html.49869ca7.js"><link rel="prefetch" href="/docs/assets/baz.html.fb0944a3.js"><link rel="prefetch" href="/docs/assets/index.html.1ce677c5.js"><link rel="prefetch" href="/docs/assets/ray.html.a251e01e.js"><link rel="prefetch" href="/docs/assets/index.html.120c630c.js"><link rel="prefetch" href="/docs/assets/kaifa.html.60c45165.js"><link rel="prefetch" href="/docs/assets/qukuailian.html.8de96e30.js"><link rel="prefetch" href="/docs/assets/CKA.html.5567b8cc.js"><link rel="prefetch" href="/docs/assets/CKS.html.87c6ef47.js"><link rel="prefetch" href="/docs/assets/index.html.b4d26096.js"><link rel="prefetch" href="/docs/assets/软件设计师.html.5fd855ec.js"><link rel="prefetch" href="/docs/assets/index.html.68da839b.js"><link rel="prefetch" href="/docs/assets/Go开发.html.bf42d178.js"><link rel="prefetch" href="/docs/assets/JavaPDF.html.f8737487.js"><link rel="prefetch" href="/docs/assets/Java开发.html.8628863a.js"><link rel="prefetch" href="/docs/assets/index.html.bbb5b4ac.js"><link rel="prefetch" href="/docs/assets/index.html.a0dc6170.js"><link rel="prefetch" href="/docs/assets/Ajax.html.4f3fb0f7.js"><link rel="prefetch" href="/docs/assets/CSS3.html.ee5d20b2.js"><link rel="prefetch" href="/docs/assets/HTML5.html.e8c40b69.js"><link rel="prefetch" href="/docs/assets/JavaScript DOM.html.bacb240a.js"><link rel="prefetch" href="/docs/assets/JavaScript开篇.html.cdbbd0bb.js"><link rel="prefetch" href="/docs/assets/JavaScript面向对象.html.3062e9bd.js"><link rel="prefetch" href="/docs/assets/JQuery.html.c43215a9.js"><link rel="prefetch" href="/docs/assets/index.html.d640bee3.js"><link rel="prefetch" href="/docs/assets/Vue.html.b256a928.js"><link rel="prefetch" href="/docs/assets/1.Gitlab-CI入门配置.html.a6a68d37.js"><link rel="prefetch" href="/docs/assets/2.Gitlab-Runer连接K8S.html.dace6002.js"><link rel="prefetch" href="/docs/assets/3.GitLab-CI _ Harbor _ Kubernetes.html.8e0614ce.js"><link rel="prefetch" href="/docs/assets/4.Gitea_K8s-Jenkins-master-slave(webhook钩子).html.0bf84552.js"><link rel="prefetch" href="/docs/assets/index.html.9eccf68b.js"><link rel="prefetch" href="/docs/assets/01.Docker基础.html.d1bad972.js"><link rel="prefetch" href="/docs/assets/02.Docker服务安装.html.1caffb35.js"><link rel="prefetch" href="/docs/assets/03.Dockerfile详解.html.9b0ebbbc.js"><link rel="prefetch" href="/docs/assets/04.Docker-compose.html.f1e746e0.js"><link rel="prefetch" href="/docs/assets/05.Docker swarm.html.4facdfb6.js"><link rel="prefetch" href="/docs/assets/06.Apache_PHP_MySQL架构访问PHP服务.html.1c7ad19c.js"><link rel="prefetch" href="/docs/assets/07.一文搞懂containerd.html.771b3e53.js"><link rel="prefetch" href="/docs/assets/1.常用Git命令清单.html.ed6a343c.js"><link rel="prefetch" href="/docs/assets/10.Git分支-变基.html.b673b46b.js"><link rel="prefetch" href="/docs/assets/11.Git工具-查看修订版本.html.7444bad2.js"><link rel="prefetch" href="/docs/assets/12.Git工具-交互式暂存.html.3e7ff352.js"><link rel="prefetch" href="/docs/assets/13.Git工具-重置揭密.html.03139516.js"><link rel="prefetch" href="/docs/assets/2.Git变基合并.html.29112858.js"><link rel="prefetch" href="/docs/assets/3.Git命令思维导图.html.6745739c.js"><link rel="prefetch" href="/docs/assets/4.Git基础与命令.html.efe500fd.js"><link rel="prefetch" href="/docs/assets/5.Git分支-分支原理.html.9f00e4cd.js"><link rel="prefetch" href="/docs/assets/6.Git分支的新建与合并-分支操作.html.60919e30.js"><link rel="prefetch" href="/docs/assets/7.Git分支管理-查看分支.html.f1e782fe.js"><link rel="prefetch" href="/docs/assets/8.Git分支开发工作流.html.195a49b1.js"><link rel="prefetch" href="/docs/assets/9.Git分支-远程分支.html.0fd9d015.js"><link rel="prefetch" href="/docs/assets/index.html.93398f90.js"><link rel="prefetch" href="/docs/assets/1.Istio概述.html.5c02c272.js"><link rel="prefetch" href="/docs/assets/2.Istio安装.html.0778ccef.js"><link rel="prefetch" href="/docs/assets/4.Istio练习题.html.1f04fd50.js"><link rel="prefetch" href="/docs/assets/index.html.17ef071c.js"><link rel="prefetch" href="/docs/assets/1.深入理解Operator.html.a3c1b0b3.js"><link rel="prefetch" href="/docs/assets/2.RESTclient原理.html.c1a3fabe.js"><link rel="prefetch" href="/docs/assets/3.访问Kubernetes API.html.ba5db241.js"><link rel="prefetch" href="/docs/assets/4.一文搞懂CRD.html.832cc325.js"><link rel="prefetch" href="/docs/assets/index.html.0537e50e.js"><link rel="prefetch" href="/docs/assets/index.html.c47fbb54.js"><link rel="prefetch" href="/docs/assets/01.搭建Fisco的联盟链(WeBase版).html.4eeda8b1.js"><link rel="prefetch" href="/docs/assets/02.FISCO BCOS Air搭建.html.8e3764e3.js"><link rel="prefetch" href="/docs/assets/03.FISCO BCOS Pro搭建.html.a68fa0d4.js"><link rel="prefetch" href="/docs/assets/04.FISCO BCOS Max搭建.html.eef81f9f.js"><link rel="prefetch" href="/docs/assets/index.html.e5d8ac6d.js"><link rel="prefetch" href="/docs/assets/01.Solidity基础.html.14773c23.js"><link rel="prefetch" href="/docs/assets/02.Solidity数据类型.html.90ff2848.js"><link rel="prefetch" href="/docs/assets/03.Solidity关系运算符.html.f5374b1d.js"><link rel="prefetch" href="/docs/assets/04.Solidity数组.html.d3f4e157.js"><link rel="prefetch" href="/docs/assets/05.Solidity条件判断.html.5b9698ac.js"><link rel="prefetch" href="/docs/assets/index.html.bf4e4aec.js"><link rel="prefetch" href="/docs/assets/index.html.338a7930.js"><link rel="prefetch" href="/docs/assets/01.初识Kubernetes.html.7e390b1a.js"><link rel="prefetch" href="/docs/assets/02.Kubernetes部署.html.93d077cf.js"><link rel="prefetch" href="/docs/assets/03.Containerd搭建Kubernets.html.8647ad6e.js"><link rel="prefetch" href="/docs/assets/04.kubernetes基本操作.html.fe795c52.js"><link rel="prefetch" href="/docs/assets/05.Kubernetes监控与日志管理.html.ab340c8d.js"><link rel="prefetch" href="/docs/assets/06.Kubernetes应用程序生命周期管理.html.0781ccab.js"><link rel="prefetch" href="/docs/assets/07.Kubernetes调度.html.bc466f6f.js"><link rel="prefetch" href="/docs/assets/08.Kubernetes网络.html.fd7f4e4e.js"><link rel="prefetch" href="/docs/assets/09.Kubernetes存储.html.b22ffdf1.js"><link rel="prefetch" href="/docs/assets/10.Kubernetes安全.html.85d40a57.js"><link rel="prefetch" href="/docs/assets/11.Kubernetes集群维护.html.2c0fef95.js"><link rel="prefetch" href="/docs/assets/12.Kubernetes集群故障排查.html.284ce0ad.js"><link rel="prefetch" href="/docs/assets/13.Helm.html.e46d8f58.js"><link rel="prefetch" href="/docs/assets/14.高级运维.html.578a23be.js"><link rel="prefetch" href="/docs/assets/15.NFS做K8S后端存储.html.20733821.js"><link rel="prefetch" href="/docs/assets/16.Glusterfs对接K8S.html.42a01891.js"><link rel="prefetch" href="/docs/assets/17.Ceph对接K8S存储(RBD).html.dd45a301.js"><link rel="prefetch" href="/docs/assets/18.Rook构建Ceph云原生存储.html.7e85914d.js"><link rel="prefetch" href="/docs/assets/19.Kubectl多集群配置.html.5ec76913.js"><link rel="prefetch" href="/docs/assets/20.系统守护进程预留计算资源.html.4dcd7b67.js"><link rel="prefetch" href="/docs/assets/21.Helm搭建EFK日志系统.html.0d3ba677.js"><link rel="prefetch" href="/docs/assets/22.Kubernetes的client-Python.html.020fef07.js"><link rel="prefetch" href="/docs/assets/01.集群部署与安全配置.html.322ba17c.js"><link rel="prefetch" href="/docs/assets/02.集群强化.html.c4217891.js"><link rel="prefetch" href="/docs/assets/03.容器运行环境安全加固.html.3ce5f30b.js"><link rel="prefetch" href="/docs/assets/04.最小化微服务漏洞.html.60cf3e99.js"><link rel="prefetch" href="/docs/assets/05.供应链安全.html.74156ff7.js"><link rel="prefetch" href="/docs/assets/06.监控、审计和运行时安全.html.f014d6cb.js"><link rel="prefetch" href="/docs/assets/01.计算机组成与体系结构.html.370a1be8.js"><link rel="prefetch" href="/docs/assets/02.操作系统基本原理.html.4fe3ac38.js"><link rel="prefetch" href="/docs/assets/03.数据库系统.html.e50999b4.js"><link rel="prefetch" href="/docs/assets/04.计算机网络.html.c838cc4a.js"><link rel="prefetch" href="/docs/assets/05.网络信息安全.html.9e7be8eb.js"><link rel="prefetch" href="/docs/assets/06.考试常用公式.html.886dbaf9.js"><link rel="prefetch" href="/docs/assets/10.软件设计师复习大纲.html.b82af843.js"><link rel="prefetch" href="/docs/assets/11.数据结构与算法复习大纲.html.f1e2e266.js"><link rel="prefetch" href="/docs/assets/21.计算机结构思维导图.html.19ddec9f.js"><link rel="prefetch" href="/docs/assets/22.程序设计语言思维导图.html.7d4167fb.js"><link rel="prefetch" href="/docs/assets/23.知识产权思维导图.html.5ae40862.js"><link rel="prefetch" href="/docs/assets/01.Ceph部署.html.3003e904.js"><link rel="prefetch" href="/docs/assets/01.Elasticsearch教程.html.fe1d10c4.js"><link rel="prefetch" href="/docs/assets/02.SpringBoot整合ES.html.61676afe.js"><link rel="prefetch" href="/docs/assets/01.MySQL安装.html.79f20e89.js"><link rel="prefetch" href="/docs/assets/02.MySQL概述.html.301afc7b.js"><link rel="prefetch" href="/docs/assets/03.MySQL的SQL详解.html.fcf5135e.js"><link rel="prefetch" href="/docs/assets/04.MySQL的函数.html.28aba038.js"><link rel="prefetch" href="/docs/assets/05.MySQL的约束.html.043af394.js"><link rel="prefetch" href="/docs/assets/06.MySQL多表查询.html.df92057c.js"><link rel="prefetch" href="/docs/assets/07.MySQL的事务.html.62475b0e.js"><link rel="prefetch" href="/docs/assets/08.MySQL索引.html.317dfa1a.js"><link rel="prefetch" href="/docs/assets/01.Nginx基础.html.fa00903a.js"><link rel="prefetch" href="/docs/assets/02.Nginx反向代理.html.2ddf6cb1.js"><link rel="prefetch" href="/docs/assets/03.Nginx负载均衡.html.99aba11a.js"><link rel="prefetch" href="/docs/assets/04.Nginx动静分离.html.00e2e22b.js"><link rel="prefetch" href="/docs/assets/05.Nginx高可用.html.1db67ed2.js"><link rel="prefetch" href="/docs/assets/01.Redis详解.html.a1a517b4.js"><link rel="prefetch" href="/docs/assets/02.SpringBoot整合Redis.html.60faacff.js"><link rel="prefetch" href="/docs/assets/01.Vue基础.html.b6d7d71d.js"><link rel="prefetch" href="/docs/assets/02.Vue的事件和表单绑定.html.fd755ddf.js"><link rel="prefetch" href="/docs/assets/03.Vue的计算属性和侦听器.html.e22a51a9.js"><link rel="prefetch" href="/docs/assets/04.Webpack打包TS.html.2c7f7de4.js"><link rel="prefetch" href="/docs/assets/05.vue2脚手架组件化开发.html.1d58ecb8.js"><link rel="prefetch" href="/docs/assets/06.Vue3安装Element-plus.html.f60517f3.js"><link rel="prefetch" href="/docs/assets/1.html.4dc29448.js"><link rel="prefetch" href="/docs/assets/2.html.b8715214.js"><link rel="prefetch" href="/docs/assets/3.html.ddd25a21.js"><link rel="prefetch" href="/docs/assets/4.html.0ad26d78.js"><link rel="prefetch" href="/docs/assets/5.html.e98ecab4.js"><link rel="prefetch" href="/docs/assets/6.html.ee938092.js"><link rel="prefetch" href="/docs/assets/7.html.f0a39229.js"><link rel="prefetch" href="/docs/assets/8.html.27df4e94.js"><link rel="prefetch" href="/docs/assets/9.html.af449031.js"><link rel="prefetch" href="/docs/assets/1.html.7e2f26f4.js"><link rel="prefetch" href="/docs/assets/10.html.f8b1c95e.js"><link rel="prefetch" href="/docs/assets/2.html.beae2264.js"><link rel="prefetch" href="/docs/assets/3.html.dabd6c15.js"><link rel="prefetch" href="/docs/assets/4.html.cccf6516.js"><link rel="prefetch" href="/docs/assets/5.html.6ed02ef5.js"><link rel="prefetch" href="/docs/assets/6.html.1524d989.js"><link rel="prefetch" href="/docs/assets/7.html.e067b1c2.js"><link rel="prefetch" href="/docs/assets/8.html.322e7535.js"><link rel="prefetch" href="/docs/assets/9.html.3fbe64b2.js"><link rel="prefetch" href="/docs/assets/10.html.05272cc2.js"><link rel="prefetch" href="/docs/assets/11.html.66027a12.js"><link rel="prefetch" href="/docs/assets/2.html.ababf87a.js"><link rel="prefetch" href="/docs/assets/3.html.93dae1b5.js"><link rel="prefetch" href="/docs/assets/4.html.5c681e8a.js"><link rel="prefetch" href="/docs/assets/5.html.6a938324.js"><link rel="prefetch" href="/docs/assets/6.html.825b8bff.js"><link rel="prefetch" href="/docs/assets/7.html.7fee9bb3.js"><link rel="prefetch" href="/docs/assets/8.html.e37d7f38.js"><link rel="prefetch" href="/docs/assets/9.html.16dd4da7.js"><link rel="prefetch" href="/docs/assets/awk.html.c4b57f20.js"><link rel="prefetch" href="/docs/assets/01.Java环境配置.html.c437e343.js"><link rel="prefetch" href="/docs/assets/02.Java基础概念.html.f3d75539.js"><link rel="prefetch" href="/docs/assets/03.Java运算符.html.ab3bc524.js"><link rel="prefetch" href="/docs/assets/04.Java循环和判断.html.f73c3ead.js"><link rel="prefetch" href="/docs/assets/05.Java循环高级和数组.html.d075a39e.js"><link rel="prefetch" href="/docs/assets/06.Java方法.html.49b0d306.js"><link rel="prefetch" href="/docs/assets/07.Java面向对象.html.96e489c9.js"><link rel="prefetch" href="/docs/assets/08.Java字符串.html.fa08b014.js"><link rel="prefetch" href="/docs/assets/00.Java面对对象进阶.html.5df6b2ef.js"><link rel="prefetch" href="/docs/assets/01.日期和时间.html.6a931c00.js"><link rel="prefetch" href="/docs/assets/02.正则表达式.html.d08c30df.js"><link rel="prefetch" href="/docs/assets/03.集合.html.f963f147.js"><link rel="prefetch" href="/docs/assets/04.Stream流.html.95642ff9.js"><link rel="prefetch" href="/docs/assets/05.异常处理.html.27dbe528.js"><link rel="prefetch" href="/docs/assets/06.日志框架.html.c8737796.js"><link rel="prefetch" href="/docs/assets/07.File类、IO流.html.6d05432b.js"><link rel="prefetch" href="/docs/assets/08.IO流进阶.html.aa1d4a79.js"><link rel="prefetch" href="/docs/assets/09.多线程.html.a743f4a5.js"><link rel="prefetch" href="/docs/assets/10.网络编程.html.5981e8ac.js"><link rel="prefetch" href="/docs/assets/11.单元测试和反射.html.ba16e90e.js"><link rel="prefetch" href="/docs/assets/12.注解和动态代理.html.1ffb92ce.js"><link rel="prefetch" href="/docs/assets/13.XML和设计模式.html.de62738d.js"><link rel="prefetch" href="/docs/assets/01.SpringBoot快速入门.html.6e6720bb.js"><link rel="prefetch" href="/docs/assets/02.SpringBoot配置文件.html.b7415c01.js"><link rel="prefetch" href="/docs/assets/03.整合Junit和Mybatis.html.b7e4a3a5.js"><link rel="prefetch" href="/docs/assets/04.SpringBoot日志.html.d277b9a7.js"><link rel="prefetch" href="/docs/assets/05.SpringBoot常用注解.html.d4d77a5b.js"><link rel="prefetch" href="/docs/assets/06.SpringBoot开发配置.html.99072422.js"><link rel="prefetch" href="/docs/assets/07.SpringBoot数据层方案.html.5057d815.js"><link rel="prefetch" href="/docs/assets/08.SpringBoot整合第三方技术.html.419e1993.js"><link rel="prefetch" href="/docs/assets/01.Spring的IoC和DI.html.b64e631e.js"><link rel="prefetch" href="/docs/assets/02.IoC和DI注解开发.html.df4b3571.js"><link rel="prefetch" href="/docs/assets/03.Spring的MVC入门.html.8d8b4216.js"><link rel="prefetch" href="/docs/assets/04.SpringMVC的请求和响应.html.24f8b4a6.js"><link rel="prefetch" href="/docs/assets/05.Spring整合Jdbc.html.91cd371f.js"><link rel="prefetch" href="/docs/assets/06.SpringMVC项目的常用配置.html.31f04ad3.js"><link rel="prefetch" href="/docs/assets/07.SpringMVC拦截器.html.347c9643.js"><link rel="prefetch" href="/docs/assets/08.Spring的异常处理.html.9deb2a65.js"><link rel="prefetch" href="/docs/assets/09.Spring的AOP.html.a0d716fc.js"><link rel="prefetch" href="/docs/assets/10.Spring的事务管理.html.0fa2dfd1.js"><link rel="prefetch" href="/docs/assets/11.Mybatis入门.html.8ef5d3fa.js"><link rel="prefetch" href="/docs/assets/12.Mybatis多表查询.html.f4efe22a.js"><link rel="prefetch" href="/docs/assets/13.Mybatis注解开发.html.cb796ee2.js"><link rel="prefetch" href="/docs/assets/14.MyBatisPlus.html.934b7932.js"><link rel="prefetch" href="/docs/assets/404.html.a611e975.js"><link rel="prefetch" href="/docs/assets/index.html.a753c66d.js"><link rel="prefetch" href="/docs/assets/slides.html.75c46d79.js"><link rel="prefetch" href="/docs/assets/disable.html.bb8f2744.js"><link rel="prefetch" href="/docs/assets/encrypt.html.434477d8.js"><link rel="prefetch" href="/docs/assets/markdown.html.40bc98a0.js"><link rel="prefetch" href="/docs/assets/page.html.1b4b866e.js"><link rel="prefetch" href="/docs/assets/index.html.1f7fb53e.js"><link rel="prefetch" href="/docs/assets/index.html.55f76e53.js"><link rel="prefetch" href="/docs/assets/index.html.d747cee9.js"><link rel="prefetch" href="/docs/assets/slides.html.24bef075.js"><link rel="prefetch" href="/docs/assets/baz.html.4512d4e3.js"><link rel="prefetch" href="/docs/assets/index.html.4c704a52.js"><link rel="prefetch" href="/docs/assets/ray.html.be23661e.js"><link rel="prefetch" href="/docs/assets/index.html.f41350de.js"><link rel="prefetch" href="/docs/assets/disable.html.625d1aae.js"><link rel="prefetch" href="/docs/assets/encrypt.html.6428a095.js"><link rel="prefetch" href="/docs/assets/markdown.html.0258b243.js"><link rel="prefetch" href="/docs/assets/page.html.19cf4e7f.js"><link rel="prefetch" href="/docs/assets/index.html.6f428cb6.js"><link rel="prefetch" href="/docs/assets/index.html.087ab0b5.js"><link rel="prefetch" href="/docs/assets/index.html.18499161.js"><link rel="prefetch" href="/docs/assets/index.html.30812cf4.js"><link rel="prefetch" href="/docs/assets/index.html.2577a4c8.js"><link rel="prefetch" href="/docs/assets/index.html.2232a9c4.js"><link rel="prefetch" href="/docs/assets/baz.html.442d59a3.js"><link rel="prefetch" href="/docs/assets/index.html.8e303911.js"><link rel="prefetch" href="/docs/assets/ray.html.08c04131.js"><link rel="prefetch" href="/docs/assets/index.html.7d226bad.js"><link rel="prefetch" href="/docs/assets/kaifa.html.5d317d66.js"><link rel="prefetch" href="/docs/assets/qukuailian.html.ad64adea.js"><link rel="prefetch" href="/docs/assets/CKA.html.56961fd2.js"><link rel="prefetch" href="/docs/assets/CKS.html.72ac5667.js"><link rel="prefetch" href="/docs/assets/index.html.6174df04.js"><link rel="prefetch" href="/docs/assets/软件设计师.html.061132f3.js"><link rel="prefetch" href="/docs/assets/index.html.c136315a.js"><link rel="prefetch" href="/docs/assets/Go开发.html.84143e11.js"><link rel="prefetch" href="/docs/assets/JavaPDF.html.cbccdab6.js"><link rel="prefetch" href="/docs/assets/Java开发.html.13ff4c12.js"><link rel="prefetch" href="/docs/assets/index.html.a5138bc6.js"><link rel="prefetch" href="/docs/assets/index.html.a4f69797.js"><link rel="prefetch" href="/docs/assets/Ajax.html.be36fc57.js"><link rel="prefetch" href="/docs/assets/CSS3.html.5645adc5.js"><link rel="prefetch" href="/docs/assets/HTML5.html.a431804d.js"><link rel="prefetch" href="/docs/assets/JavaScript DOM.html.32bf78b6.js"><link rel="prefetch" href="/docs/assets/JavaScript开篇.html.24c1f67d.js"><link rel="prefetch" href="/docs/assets/JavaScript面向对象.html.944f50c2.js"><link rel="prefetch" href="/docs/assets/JQuery.html.88b1a790.js"><link rel="prefetch" href="/docs/assets/index.html.5aed65e0.js"><link rel="prefetch" href="/docs/assets/Vue.html.1c4a7f92.js"><link rel="prefetch" href="/docs/assets/1.Gitlab-CI入门配置.html.10b512d0.js"><link rel="prefetch" href="/docs/assets/2.Gitlab-Runer连接K8S.html.da996606.js"><link rel="prefetch" href="/docs/assets/3.GitLab-CI _ Harbor _ Kubernetes.html.3afdab73.js"><link rel="prefetch" href="/docs/assets/4.Gitea_K8s-Jenkins-master-slave(webhook钩子).html.1c0c6ee5.js"><link rel="prefetch" href="/docs/assets/index.html.cd64c39c.js"><link rel="prefetch" href="/docs/assets/01.Docker基础.html.9325ec49.js"><link rel="prefetch" href="/docs/assets/02.Docker服务安装.html.b8e8696e.js"><link rel="prefetch" href="/docs/assets/03.Dockerfile详解.html.93f73f10.js"><link rel="prefetch" href="/docs/assets/04.Docker-compose.html.489e9787.js"><link rel="prefetch" href="/docs/assets/05.Docker swarm.html.cc6c871b.js"><link rel="prefetch" href="/docs/assets/06.Apache_PHP_MySQL架构访问PHP服务.html.09b97454.js"><link rel="prefetch" href="/docs/assets/07.一文搞懂containerd.html.fe88496f.js"><link rel="prefetch" href="/docs/assets/1.常用Git命令清单.html.fbabdd2b.js"><link rel="prefetch" href="/docs/assets/10.Git分支-变基.html.36ced610.js"><link rel="prefetch" href="/docs/assets/11.Git工具-查看修订版本.html.fb0e4699.js"><link rel="prefetch" href="/docs/assets/12.Git工具-交互式暂存.html.65681e5e.js"><link rel="prefetch" href="/docs/assets/13.Git工具-重置揭密.html.cbbc9a61.js"><link rel="prefetch" href="/docs/assets/2.Git变基合并.html.9d51f623.js"><link rel="prefetch" href="/docs/assets/3.Git命令思维导图.html.4e07cffc.js"><link rel="prefetch" href="/docs/assets/4.Git基础与命令.html.0fb9c3ad.js"><link rel="prefetch" href="/docs/assets/5.Git分支-分支原理.html.4d5a5c3d.js"><link rel="prefetch" href="/docs/assets/6.Git分支的新建与合并-分支操作.html.5389c1c3.js"><link rel="prefetch" href="/docs/assets/7.Git分支管理-查看分支.html.0fad3c09.js"><link rel="prefetch" href="/docs/assets/8.Git分支开发工作流.html.330684eb.js"><link rel="prefetch" href="/docs/assets/9.Git分支-远程分支.html.96693989.js"><link rel="prefetch" href="/docs/assets/index.html.ecf7077d.js"><link rel="prefetch" href="/docs/assets/1.Istio概述.html.5f2dfbea.js"><link rel="prefetch" href="/docs/assets/2.Istio安装.html.68817be3.js"><link rel="prefetch" href="/docs/assets/4.Istio练习题.html.5a2b7b94.js"><link rel="prefetch" href="/docs/assets/index.html.762e496b.js"><link rel="prefetch" href="/docs/assets/1.深入理解Operator.html.0800af2b.js"><link rel="prefetch" href="/docs/assets/2.RESTclient原理.html.e0cdbeb9.js"><link rel="prefetch" href="/docs/assets/3.访问Kubernetes API.html.88d92c38.js"><link rel="prefetch" href="/docs/assets/4.一文搞懂CRD.html.a718d225.js"><link rel="prefetch" href="/docs/assets/index.html.c122ce3f.js"><link rel="prefetch" href="/docs/assets/index.html.0c94044a.js"><link rel="prefetch" href="/docs/assets/01.搭建Fisco的联盟链(WeBase版).html.6786c4f6.js"><link rel="prefetch" href="/docs/assets/02.FISCO BCOS Air搭建.html.1b067dc7.js"><link rel="prefetch" href="/docs/assets/03.FISCO BCOS Pro搭建.html.67fb8aaf.js"><link rel="prefetch" href="/docs/assets/04.FISCO BCOS Max搭建.html.f64d1c4f.js"><link rel="prefetch" href="/docs/assets/index.html.cca0e45f.js"><link rel="prefetch" href="/docs/assets/01.Solidity基础.html.8e4315b0.js"><link rel="prefetch" href="/docs/assets/02.Solidity数据类型.html.cd26001f.js"><link rel="prefetch" href="/docs/assets/03.Solidity关系运算符.html.e35ddf84.js"><link rel="prefetch" href="/docs/assets/04.Solidity数组.html.45a06584.js"><link rel="prefetch" href="/docs/assets/05.Solidity条件判断.html.72e608cb.js"><link rel="prefetch" href="/docs/assets/index.html.14acd37d.js"><link rel="prefetch" href="/docs/assets/index.html.f93bb6f2.js"><link rel="prefetch" href="/docs/assets/01.初识Kubernetes.html.630656bc.js"><link rel="prefetch" href="/docs/assets/02.Kubernetes部署.html.5ed32e89.js"><link rel="prefetch" href="/docs/assets/03.Containerd搭建Kubernets.html.3ff27450.js"><link rel="prefetch" href="/docs/assets/04.kubernetes基本操作.html.4e5f4081.js"><link rel="prefetch" href="/docs/assets/05.Kubernetes监控与日志管理.html.b6301430.js"><link rel="prefetch" href="/docs/assets/06.Kubernetes应用程序生命周期管理.html.8b2d8a7b.js"><link rel="prefetch" href="/docs/assets/07.Kubernetes调度.html.96c17e45.js"><link rel="prefetch" href="/docs/assets/08.Kubernetes网络.html.406acd25.js"><link rel="prefetch" href="/docs/assets/09.Kubernetes存储.html.4aef8c14.js"><link rel="prefetch" href="/docs/assets/10.Kubernetes安全.html.c4104c3a.js"><link rel="prefetch" href="/docs/assets/11.Kubernetes集群维护.html.75ee0781.js"><link rel="prefetch" href="/docs/assets/12.Kubernetes集群故障排查.html.ce56b99d.js"><link rel="prefetch" href="/docs/assets/13.Helm.html.1812ed02.js"><link rel="prefetch" href="/docs/assets/14.高级运维.html.de16428a.js"><link rel="prefetch" href="/docs/assets/15.NFS做K8S后端存储.html.7f1d76aa.js"><link rel="prefetch" href="/docs/assets/16.Glusterfs对接K8S.html.3f7c1431.js"><link rel="prefetch" href="/docs/assets/17.Ceph对接K8S存储(RBD).html.236d50e8.js"><link rel="prefetch" href="/docs/assets/18.Rook构建Ceph云原生存储.html.2f639789.js"><link rel="prefetch" href="/docs/assets/19.Kubectl多集群配置.html.19deeb7f.js"><link rel="prefetch" href="/docs/assets/20.系统守护进程预留计算资源.html.d835e221.js"><link rel="prefetch" href="/docs/assets/21.Helm搭建EFK日志系统.html.db68c03f.js"><link rel="prefetch" href="/docs/assets/22.Kubernetes的client-Python.html.83fc8101.js"><link rel="prefetch" href="/docs/assets/01.集群部署与安全配置.html.13f8a8df.js"><link rel="prefetch" href="/docs/assets/02.集群强化.html.bcc25fc3.js"><link rel="prefetch" href="/docs/assets/03.容器运行环境安全加固.html.20039fa4.js"><link rel="prefetch" href="/docs/assets/04.最小化微服务漏洞.html.8d586d29.js"><link rel="prefetch" href="/docs/assets/05.供应链安全.html.cfd54fba.js"><link rel="prefetch" href="/docs/assets/06.监控、审计和运行时安全.html.b218b618.js"><link rel="prefetch" href="/docs/assets/01.计算机组成与体系结构.html.585e8a71.js"><link rel="prefetch" href="/docs/assets/02.操作系统基本原理.html.6f6c114a.js"><link rel="prefetch" href="/docs/assets/03.数据库系统.html.b49eaaa4.js"><link rel="prefetch" href="/docs/assets/04.计算机网络.html.87cf9a10.js"><link rel="prefetch" href="/docs/assets/05.网络信息安全.html.31de5b98.js"><link rel="prefetch" href="/docs/assets/06.考试常用公式.html.0bb57f18.js"><link rel="prefetch" href="/docs/assets/10.软件设计师复习大纲.html.99b8382b.js"><link rel="prefetch" href="/docs/assets/11.数据结构与算法复习大纲.html.efc4102c.js"><link rel="prefetch" href="/docs/assets/21.计算机结构思维导图.html.a0e188f3.js"><link rel="prefetch" href="/docs/assets/22.程序设计语言思维导图.html.a6361232.js"><link rel="prefetch" href="/docs/assets/23.知识产权思维导图.html.69e73bda.js"><link rel="prefetch" href="/docs/assets/01.Ceph部署.html.6d8e8353.js"><link rel="prefetch" href="/docs/assets/01.Elasticsearch教程.html.0cdd7af1.js"><link rel="prefetch" href="/docs/assets/02.SpringBoot整合ES.html.9b608be8.js"><link rel="prefetch" href="/docs/assets/01.MySQL安装.html.262b64c8.js"><link rel="prefetch" href="/docs/assets/02.MySQL概述.html.285f3e32.js"><link rel="prefetch" href="/docs/assets/03.MySQL的SQL详解.html.b47ee35b.js"><link rel="prefetch" href="/docs/assets/04.MySQL的函数.html.06cb3eb0.js"><link rel="prefetch" href="/docs/assets/05.MySQL的约束.html.7ea5ea0b.js"><link rel="prefetch" href="/docs/assets/06.MySQL多表查询.html.ec8d57c8.js"><link rel="prefetch" href="/docs/assets/07.MySQL的事务.html.d1ec22a1.js"><link rel="prefetch" href="/docs/assets/08.MySQL索引.html.989a1482.js"><link rel="prefetch" href="/docs/assets/01.Nginx基础.html.9d7a6fd0.js"><link rel="prefetch" href="/docs/assets/02.Nginx反向代理.html.48438ee4.js"><link rel="prefetch" href="/docs/assets/03.Nginx负载均衡.html.11d81f87.js"><link rel="prefetch" href="/docs/assets/04.Nginx动静分离.html.4c0159d0.js"><link rel="prefetch" href="/docs/assets/05.Nginx高可用.html.ef7f51ca.js"><link rel="prefetch" href="/docs/assets/01.Redis详解.html.f0e6eb24.js"><link rel="prefetch" href="/docs/assets/02.SpringBoot整合Redis.html.4810d8ec.js"><link rel="prefetch" href="/docs/assets/01.Vue基础.html.ff481b6f.js"><link rel="prefetch" href="/docs/assets/02.Vue的事件和表单绑定.html.a578138c.js"><link rel="prefetch" href="/docs/assets/03.Vue的计算属性和侦听器.html.d2419e5d.js"><link rel="prefetch" href="/docs/assets/04.Webpack打包TS.html.a8e33ad9.js"><link rel="prefetch" href="/docs/assets/05.vue2脚手架组件化开发.html.cc279f24.js"><link rel="prefetch" href="/docs/assets/06.Vue3安装Element-plus.html.e100e69c.js"><link rel="prefetch" href="/docs/assets/1.html.102ab651.js"><link rel="prefetch" href="/docs/assets/2.html.c00ae202.js"><link rel="prefetch" href="/docs/assets/3.html.5f59847f.js"><link rel="prefetch" href="/docs/assets/4.html.1bbd8fff.js"><link rel="prefetch" href="/docs/assets/5.html.e5221603.js"><link rel="prefetch" href="/docs/assets/6.html.31287294.js"><link rel="prefetch" href="/docs/assets/7.html.36100821.js"><link rel="prefetch" href="/docs/assets/8.html.ef0352c2.js"><link rel="prefetch" href="/docs/assets/9.html.daaf4834.js"><link rel="prefetch" href="/docs/assets/1.html.c5f2c8d5.js"><link rel="prefetch" href="/docs/assets/10.html.fcaad621.js"><link rel="prefetch" href="/docs/assets/2.html.7dfde917.js"><link rel="prefetch" href="/docs/assets/3.html.8ddd080c.js"><link rel="prefetch" href="/docs/assets/4.html.f7ec4ddf.js"><link rel="prefetch" href="/docs/assets/5.html.7358cfb7.js"><link rel="prefetch" href="/docs/assets/6.html.536ac081.js"><link rel="prefetch" href="/docs/assets/7.html.74ca6217.js"><link rel="prefetch" href="/docs/assets/8.html.bd753e55.js"><link rel="prefetch" href="/docs/assets/9.html.07244166.js"><link rel="prefetch" href="/docs/assets/10.html.68b054a6.js"><link rel="prefetch" href="/docs/assets/11.html.83b7618e.js"><link rel="prefetch" href="/docs/assets/2.html.78af693a.js"><link rel="prefetch" href="/docs/assets/3.html.8281510c.js"><link rel="prefetch" href="/docs/assets/4.html.ec309ebc.js"><link rel="prefetch" href="/docs/assets/5.html.a8e534cb.js"><link rel="prefetch" href="/docs/assets/6.html.e9fdea2b.js"><link rel="prefetch" href="/docs/assets/7.html.ac95a4e6.js"><link rel="prefetch" href="/docs/assets/8.html.61a54551.js"><link rel="prefetch" href="/docs/assets/9.html.55a19e82.js"><link rel="prefetch" href="/docs/assets/awk.html.d5cb43b0.js"><link rel="prefetch" href="/docs/assets/01.Java环境配置.html.2a0f06bc.js"><link rel="prefetch" href="/docs/assets/02.Java基础概念.html.3a91af0e.js"><link rel="prefetch" href="/docs/assets/03.Java运算符.html.7f0a66aa.js"><link rel="prefetch" href="/docs/assets/04.Java循环和判断.html.b0367dc8.js"><link rel="prefetch" href="/docs/assets/05.Java循环高级和数组.html.7e83555a.js"><link rel="prefetch" href="/docs/assets/06.Java方法.html.ee9c987f.js"><link rel="prefetch" href="/docs/assets/07.Java面向对象.html.f730259d.js"><link rel="prefetch" href="/docs/assets/08.Java字符串.html.f985dc09.js"><link rel="prefetch" href="/docs/assets/00.Java面对对象进阶.html.e21dc5ba.js"><link rel="prefetch" href="/docs/assets/01.日期和时间.html.b20ef7b7.js"><link rel="prefetch" href="/docs/assets/02.正则表达式.html.008360b4.js"><link rel="prefetch" href="/docs/assets/03.集合.html.79199561.js"><link rel="prefetch" href="/docs/assets/04.Stream流.html.83a42680.js"><link rel="prefetch" href="/docs/assets/05.异常处理.html.7f2ec2a6.js"><link rel="prefetch" href="/docs/assets/06.日志框架.html.04d65ec5.js"><link rel="prefetch" href="/docs/assets/07.File类、IO流.html.307c3f88.js"><link rel="prefetch" href="/docs/assets/08.IO流进阶.html.05091a2e.js"><link rel="prefetch" href="/docs/assets/09.多线程.html.94daca19.js"><link rel="prefetch" href="/docs/assets/10.网络编程.html.0c2b4d85.js"><link rel="prefetch" href="/docs/assets/11.单元测试和反射.html.3125e735.js"><link rel="prefetch" href="/docs/assets/12.注解和动态代理.html.49da253b.js"><link rel="prefetch" href="/docs/assets/13.XML和设计模式.html.04865674.js"><link rel="prefetch" href="/docs/assets/01.SpringBoot快速入门.html.d7a1ebe1.js"><link rel="prefetch" href="/docs/assets/02.SpringBoot配置文件.html.d491c7fe.js"><link rel="prefetch" href="/docs/assets/03.整合Junit和Mybatis.html.8d1316d3.js"><link rel="prefetch" href="/docs/assets/04.SpringBoot日志.html.d736b75c.js"><link rel="prefetch" href="/docs/assets/05.SpringBoot常用注解.html.62366a9a.js"><link rel="prefetch" href="/docs/assets/06.SpringBoot开发配置.html.e7f03692.js"><link rel="prefetch" href="/docs/assets/07.SpringBoot数据层方案.html.dacceb7b.js"><link rel="prefetch" href="/docs/assets/08.SpringBoot整合第三方技术.html.703aeb91.js"><link rel="prefetch" href="/docs/assets/01.Spring的IoC和DI.html.3db59ecd.js"><link rel="prefetch" href="/docs/assets/02.IoC和DI注解开发.html.f358bc49.js"><link rel="prefetch" href="/docs/assets/03.Spring的MVC入门.html.3952f0d3.js"><link rel="prefetch" href="/docs/assets/04.SpringMVC的请求和响应.html.73e617d0.js"><link rel="prefetch" href="/docs/assets/05.Spring整合Jdbc.html.53a1d90b.js"><link rel="prefetch" href="/docs/assets/06.SpringMVC项目的常用配置.html.32e80789.js"><link rel="prefetch" href="/docs/assets/07.SpringMVC拦截器.html.a0caa3ce.js"><link rel="prefetch" href="/docs/assets/08.Spring的异常处理.html.475feb47.js"><link rel="prefetch" href="/docs/assets/09.Spring的AOP.html.867f4d9c.js"><link rel="prefetch" href="/docs/assets/10.Spring的事务管理.html.50e3508a.js"><link rel="prefetch" href="/docs/assets/11.Mybatis入门.html.0228d329.js"><link rel="prefetch" href="/docs/assets/12.Mybatis多表查询.html.6d0aa5ad.js"><link rel="prefetch" href="/docs/assets/13.Mybatis注解开发.html.c2591ccb.js"><link rel="prefetch" href="/docs/assets/14.MyBatisPlus.html.11df3aa3.js"><link rel="prefetch" href="/docs/assets/404.html.8311a4d5.js"><link rel="prefetch" href="/docs/assets/waline-meta.8c8f8f9e.js"><link rel="prefetch" href="/docs/assets/auto.264f6c8c.js"><link rel="prefetch" href="/docs/assets/index.cac02f97.js"><link rel="prefetch" href="/docs/assets/flowchart.parse.ee90d7e0.js"><link rel="prefetch" href="/docs/assets/mermaid.esm.min.e3b5d21d.js"><link rel="prefetch" href="/docs/assets/highlight.esm.d982e650.js"><link rel="prefetch" href="/docs/assets/markdown.esm.832a189d.js"><link rel="prefetch" href="/docs/assets/math.esm.a3f84b6f.js"><link rel="prefetch" href="/docs/assets/notes.esm.3c361cb7.js"><link rel="prefetch" href="/docs/assets/reveal.esm.b96f05d8.js"><link rel="prefetch" href="/docs/assets/search.esm.80da4a02.js"><link rel="prefetch" href="/docs/assets/zoom.esm.8514a202.js"><link rel="prefetch" href="/docs/assets/VuePlayground.093ac045.js"><link rel="prefetch" href="/docs/assets/photoswipe.esm.382b1873.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/docs/zh/" class="brand"><img class="logo" src="/docs/logo.svg" alt="文档"><!----><span class="site-name hide-in-pad">文档</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/docs/zh" class="nav-link active" aria-label="isKcount"><span class="icon iconfont icon-home"></span>isKcount<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="分类"><span class="title"><span class="icon iconfont icon-interact"></span>分类</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/docs/zh/isKcount/1/kaifa.html" class="nav-link" aria-label="学习路线规划"><span class="icon iconfont icon-ability"></span>学习路线规划<!----></a></li><li class="dropdown-item"><a href="/docs/zh/isKcount/2/" class="nav-link" aria-label="考证"><span class="icon iconfont icon-relation"></span>考证<!----></a></li><li class="dropdown-item"><a href="/docs/zh/isKcount/3/" class="nav-link" aria-label="运维笔记"><span class="icon iconfont icon-linux"></span>运维笔记<!----></a></li><li class="dropdown-item"><a href="/docs/zh/isKcount/4/" class="nav-link" aria-label="后端开发笔记"><span class="icon iconfont icon-note"></span>后端开发笔记<!----></a></li><li class="dropdown-item"><a href="/docs/zh/isKcount/5/" class="nav-link" aria-label="前端开发笔记"><span class="icon iconfont icon-like"></span>前端开发笔记<!----></a></li><li class="dropdown-item"><a href="/docs/zh/isKcount/6/" class="nav-link" aria-label="中间件服务笔记"><span class="icon iconfont icon-api"></span>中间件服务笔记<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Devops"><span class="title"><span class="icon iconfont icon-select"></span>Devops</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/docs/zh/pip/git/" class="nav-link" aria-label="Git开发手册"><span class="icon iconfont icon-git"></span>Git开发手册<!----></a></li><li class="dropdown-item"><a href="/docs/zh/pip/ci/" class="nav-link" aria-label="CICD"><span class="icon iconfont icon-ci"></span>CICD<!----></a></li><li class="dropdown-item"><a href="/docs/zh/pip/istio/1.Istio%E6%A6%82%E8%BF%B0.html" class="nav-link" aria-label="Istio"><span class="icon iconfont icon-material"></span>Istio<!----></a></li><li class="dropdown-item"><a href="/docs/zh/pip/operator/1.%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Operator.html" class="nav-link" aria-label="Operator"><span class="icon iconfont icon-proxy"></span>Operator<!----></a></li><li class="dropdown-item"><a href="/docs/zh/pip/docker/07.%E4%B8%80%E6%96%87%E6%90%9E%E6%87%82containerd.html" class="nav-link" aria-label="Docker"><span class="icon iconfont icon-bitbucket"></span>Docker<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Web3"><span class="title"><span class="icon iconfont icon-mount"></span>Web3</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/docs/zh/web3/fabric/" class="nav-link" aria-label="Fabric"><span class="icon iconfont icon-safe"></span>Fabric<!----></a></li><li class="dropdown-item"><a href="/docs/zh/web3/fisco/" class="nav-link" aria-label="FISCO"><span class="icon iconfont icon-safari"></span>FISCO<!----></a></li><li class="dropdown-item"><a href="/docs/zh/web3/solidity/01.Solidity%E5%9F%BA%E7%A1%80.html" class="nav-link" aria-label="智能合约"><span class="icon iconfont icon-license"></span>智能合约<!----></a></li><li class="dropdown-item"><a href="/docs/zh/web3/Web3/" class="nav-link" aria-label="Web3.0"><span class="icon iconfont icon-repo"></span>Web3.0<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a href="https://wallhaven.cc/" rel="noopener noreferrer" target="_blank" aria-label="Wallhaven" class="nav-link"><span class="icon iconfont icon-autumn"></span>Wallhaven<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-right"><!--[--><!----><!--]--><div class="nav-item"><div class="dropdown-wrapper i18n-dropdown"><button class="dropdown-title" type="button" aria-label="选择语言"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon i18n-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="i18n icon" style="width:1rem;height:1rem;vertical-align:middle;"><path d="M379.392 460.8 494.08 575.488l-42.496 102.4L307.2 532.48 138.24 701.44l-71.68-72.704L234.496 460.8l-45.056-45.056c-27.136-27.136-51.2-66.56-66.56-108.544h112.64c7.68 14.336 16.896 27.136 26.112 35.84l45.568 46.08 45.056-45.056C382.976 312.32 409.6 247.808 409.6 204.8H0V102.4h256V0h102.4v102.4h256v102.4H512c0 70.144-37.888 161.28-87.04 210.944L378.88 460.8zM576 870.4 512 1024H409.6l256-614.4H768l256 614.4H921.6l-64-153.6H576zM618.496 768h196.608L716.8 532.48 618.496 768z"></path></svg><!--]--><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/docs/" class="nav-link" aria-label="English"><!---->English<!----></a></li><li class="dropdown-item"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html" class="router-link-active router-link-exact-active nav-link active" aria-label="简体中文"><!---->简体中文<!----></a></li></ul></button></div></div><div class="nav-item"><a class="repo-link" href="https://github.com/vuepress-theme-hope/vuepress-theme-hope" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><a href="/docs/zh/pip/" class="nav-link sidebar-link sidebar-page" aria-label="Devops生态"><!---->Devops生态<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-github"></span><span class="title">Git手册</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-ci"></span><span class="title">CICD</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><span class="icon iconfont icon-material"></span><span class="title">Istio</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/docs/zh/pip/istio/1.Istio%E6%A6%82%E8%BF%B0.html" class="nav-link sidebar-link sidebar-page" aria-label="Istio概述"><!---->Istio概述<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/docs/zh/pip/istio/2.Istio%E5%AE%89%E8%A3%85.html" class="nav-link sidebar-link sidebar-page" aria-label="Istio安装"><!---->Istio安装<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="Istio由浅入深"><!---->Istio由浅入深<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#istio简介" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Istio简介"><!---->Istio简介<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#istio的安装" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Istio的安装"><!---->Istio的安装<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#使用-istioctl-安装" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="使用 Istioctl 安装"><!---->使用 Istioctl 安装<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#测试一个实例" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="测试一个实例"><!---->测试一个实例<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#介绍istio流量管理" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="介绍Istio流量管理"><!---->介绍Istio流量管理<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#sidecar注入" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Sidecar注入"><!---->Sidecar注入<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#请求路由" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="请求路由"><!---->请求路由<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#故障注入-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="故障注入"><!---->故障注入<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#流量转移" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="流量转移"><!---->流量转移<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#tcp-流量转移" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="TCP 流量转移"><!---->TCP 流量转移<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#请求超时" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="请求超时"><!---->请求超时<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#熔断-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="熔断"><!---->熔断<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#镜像" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="镜像"><!---->镜像<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#入口网关" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="入口网关"><!---->入口网关<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#安全网关" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="安全网关"><!---->安全网关<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#出口tls发起" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="出口TLS发起"><!---->出口TLS发起<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#出口网关" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="出口网关"><!---->出口网关<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a href="/docs/zh/pip/istio/4.Istio%E7%BB%83%E4%B9%A0%E9%A2%98.html" class="nav-link sidebar-link sidebar-page" aria-label="Istio练习题"><!---->Istio练习题<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-proxy"></span><span class="title">Operator</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-animation"></span><span class="title">Docker</span><span class="arrow right"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->Istio由浅入深</h1><div class="page-info"><span class="author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="author-item" href="https://www.github.isicman" target="_blank" rel="noopener noreferrer">isKcount</a></span><span property="author" content="isKcount"></span></span><!----><span class="date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span>2022年4月1日</span><meta property="datePublished" content="2022-04-01T13:59:49.000Z"></span><span class="category-info" aria-label="分类🌈" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><ul class="categories-wrapper"><li><span class="category category4" role>Istio</span></li></ul><meta property="articleSection" content="Istio"></span><span aria-label="标签🏷" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><ul class="tags-wrapper"><li><span class="tag tag4" role>Istio</span></li></ul><meta property="keywords" content="Istio"></span><span class="reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 83 分钟</span><meta property="timeRequired" content="PT83M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">此页内容</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#istio简介" class="router-link-active router-link-exact-active toc-link level2">Istio简介</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#istio的安装" class="router-link-active router-link-exact-active toc-link level2">Istio的安装</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#使用-istioctl-安装" class="router-link-active router-link-exact-active toc-link level3">使用 Istioctl 安装</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#测试一个实例" class="router-link-active router-link-exact-active toc-link level3">测试一个实例</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#介绍istio流量管理" class="router-link-active router-link-exact-active toc-link level2">介绍Istio流量管理</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#sidecar注入" class="router-link-active router-link-exact-active toc-link level2">Sidecar注入</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#请求路由" class="router-link-active router-link-exact-active toc-link level2">请求路由</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#故障注入-1" class="router-link-active router-link-exact-active toc-link level2">故障注入</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#流量转移" class="router-link-active router-link-exact-active toc-link level2">流量转移</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#tcp-流量转移" class="router-link-active router-link-exact-active toc-link level2">TCP 流量转移</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#请求超时" class="router-link-active router-link-exact-active toc-link level2">请求超时</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#熔断-1" class="router-link-active router-link-exact-active toc-link level2">熔断</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#镜像" class="router-link-active router-link-exact-active toc-link level2">镜像</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#入口网关" class="router-link-active router-link-exact-active toc-link level2">入口网关</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#安全网关" class="router-link-active router-link-exact-active toc-link level2">安全网关</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#出口tls发起" class="router-link-active router-link-exact-active toc-link level2">出口TLS发起</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#出口网关" class="router-link-active router-link-exact-active toc-link level2">出口网关</a></li><!----><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="istio由浅入深" tabindex="-1"><a class="header-anchor" href="#istio由浅入深" aria-hidden="true">#</a> Istio由浅入深</h1><h2 id="istio简介" tabindex="-1"><a class="header-anchor" href="#istio简介" aria-hidden="true">#</a> Istio简介</h2><h4 id="什么是istio" tabindex="-1"><a class="header-anchor" href="#什么是istio" aria-hidden="true">#</a> 什么是Istio?</h4><p>在企业普遍都做云平台的时代背景下，云平台架构带来的诸多好处，但是，不可否认的是，采用云技术架构会对DevOps团队造成很大的压力。 开发人员也必须使用微服务来构建可移植性，同时各大运营商正在管理超大型混合和多云部署。而Istio使得您可以连接，安全，控制和监控这些服务。</p><p>从更高的维度来看，Istio有助于降低部署的复杂性，减轻开发团队的负担。<code>Istio是一个完全开源的服务网格（service mesh），可以透明地分层到现有的分布式应用程序上。同时，它也是一个平台，通过其提供的API，可将其集成到任何日志平台，telemetry或策略系统中。</code></p><p>Istio的多样化功能集使您能够高效地运行分布式微服务架构，并提供统一的方式来保护，连接和监视微服务。</p><h4 id="什么是服务网格-serivce-mesh" tabindex="-1"><a class="header-anchor" href="#什么是服务网格-serivce-mesh" aria-hidden="true">#</a> 什么是服务网格（serivce mesh）？</h4><p>当整体应用程序向分布式微服务架构过渡时，Istio解决了开发人员和运营商面临的挑战。</p><p><code>服务网格</code>术语用于描述组成此类应用程序的微服务网络及其之间的交互。随着服务网格的大小和复杂性的增长，它变得越来越难以理解和管理。它的要求可以包括发现，负载平衡，故障恢复，指标和监控。服务网格通常还具有更复杂的操作要求，例如A/B测试，金丝雀，网速限制，访问控制和端到端的身份验证。</p><p>Istio提供了整个服务网格上的行为洞察力和操作控制，从而提供了完整的解决方案来满足微服务应用程序的各种需求。</p><h4 id="为什么使用istio" tabindex="-1"><a class="header-anchor" href="#为什么使用istio" aria-hidden="true">#</a> 为什么使用Istio？</h4><p>Istio可以轻松在已部署服务网络上创建带有负载平衡，服务到服务的身份验证，监控等功能，并且服务代码中的代码无需变动（或变动很少）。通过在整个环境中部署一个特殊的sidecar代理来拦截微服务之间的所有网络通信，然后使用其平台控制功能配置和管理Istio，包括：</p><ul><li>自动为HTTP，gRPC，WebSocket和TCP流量负载平衡。</li><li>通过丰富的路由规则，重试，故障转移和故障注入对流量行为进行细粒度控制。</li><li>可插拔的策略层和配置API，支持访问控制，速率限制和配额。</li><li>集群内所有流量的自动度量，日志和跟踪，包括集群的入口和出口。</li><li>通过强大的基于身份的身份验证和授权，在集群中进行安全的服务之间通信。</li></ul><p>Istio专为可扩展性而设计，可满足多种部署需求。</p><h4 id="核心功能" tabindex="-1"><a class="header-anchor" href="#核心功能" aria-hidden="true">#</a> 核心功能</h4><p>Istio在服务网络中统一提供了许多关键功能：</p><h4 id="流量管理" tabindex="-1"><a class="header-anchor" href="#流量管理" aria-hidden="true">#</a> 流量管理</h4><p>Istio规则配置和流量路由使您可以很容易的控制服务之间的流量和API调用的流量。Istio简化了诸如断路器，超时和重试之类的服务级别属性的配置，并使其轻而易举地设置重要任务，如A/B测试，金丝雀部署和基于百分比的流量拆分。</p><p>借助对流量的更好可见性和开箱即用的故障恢复功能，无论遇到什么情况，您都可以在问题引起故障之前及时发现问题，使得调用更加可靠，网络也更加强大。</p><h4 id="安全" tabindex="-1"><a class="header-anchor" href="#安全" aria-hidden="true">#</a> 安全</h4><p>Istio的安全功能使开发人员可以将精力集中在应用程序级别。Istio提供基础安全通信通道，并大规模管理服务通信的身份验证，授权和加密。 借助Istio，默认情况下可以保护服务通信的安全，从而使您能够在各种协议和运行时之间一致地执行策略 - 所有这些操作几乎不需要更改应用程序。</p><p>虽然Istio是独立于平台的，但将其与Kubernetes（或基础架构）网络策略配合使用，则好处更大，包括能够在网络和应用程序层保护Pod到Pod或服务到服务的通信的能力。</p><h4 id="可观察性-observability" tabindex="-1"><a class="header-anchor" href="#可观察性-observability" aria-hidden="true">#</a> 可观察性(Observability)</h4><p>Istio强大的跟踪，监控和日志记录功能使您可以深入了解服务网格部署。借助Istio的监视功能，您可以真正了解服务性能如何影响上游和下游事物，而其自定义dashboards（仪表盘）则可以提供对所有服务性能的可视性，并让您了解该性能如何影响您的其他的程序的。</p><p>Istio的Mixer组件负责策略控制和遥测(telemetry)采集。它提供了后端抽象和中介，使Istio的其余部分与各个基础架构后端的实现细节隔离开来，并为操作员提供了对网格和基础架构后端之间所有交互的精细控制。</p><p>所有这些功能使您可以更有效地设置，监控和执行服务上的SLO。当然，最重要的是您可以快速有效地检测和修复故障。</p><h4 id="平台支持" tabindex="-1"><a class="header-anchor" href="#平台支持" aria-hidden="true">#</a> 平台支持</h4><p>Istio是独立于平台的，旨在在多种环境中运行，包括跨Cloud，本地，Kubernetes，Mesos等的环境。您可以在Kubernetes或Consul的Nomad上部署Istio。Istio当前支持：</p><ul><li>Kubernetes上部署Service</li><li>向Consul注册Services</li><li>在单个虚拟机上运行Services</li></ul><h4 id="集成和自定义" tabindex="-1"><a class="header-anchor" href="#集成和自定义" aria-hidden="true">#</a> 集成和自定义</h4><p>Istio的策略执行组件可以扩展和自定义，以与现有的ACL，日志记录，监视，配额，审核等集成。</p><h4 id="架构" tabindex="-1"><a class="header-anchor" href="#架构" aria-hidden="true">#</a> 架构</h4><p>Istio服务网格在逻辑上分为数据平面和控制平面。</p><ul><li>数据plane由部署为sidecar的一组智能代理（Envoy）组成。这些代理中介和控制微服务与Mixer、通用策略和遥测集线器之间的所有网络通信。</li><li>控制平面管理并将代理配置为路由流量。另外，控制平面配置Mixers来执行策略和采集遥测数据。</li></ul><p>下图显示了组成每个平面的不同组件:</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062326606.jpeg" alt="screenshot" loading="lazy"></p><h4 id="envoy" tabindex="-1"><a class="header-anchor" href="#envoy" aria-hidden="true">#</a> Envoy</h4><p>Istio使用Envoy代理的扩展版本。Envoy是使用<code>C++</code>开发的高性能代理，可为服务网格中的所有服务调解所有入站和出站流量。Istio利用Envoy的许多内置功能，如：</p><ul><li>动态服务发现</li><li>负载均衡</li><li>TLS termination</li><li>HTTP/2和gRPC代理</li><li>熔断（Circuit breakers）</li><li>健康检查</li><li>分阶段推出，按百分比分配流量</li><li>故障注入</li><li>丰富的指标</li></ul><p>Sidecar代理模型还允许你将Istio功能添加到现有部署中，而无需重新构造或重写代码。你可以阅读更多关于为什么我们在设计目标中选择这种方法的信息。</p><h4 id="mixer" tabindex="-1"><a class="header-anchor" href="#mixer" aria-hidden="true">#</a> Mixer</h4><p>Mixer是一个与平台无关的组件。Mixer跨服务网格实施访问控制和使用策略，并从Envoy代理和其他服务收集遥测数据。 代理提取请求级别属性，并将其发送到Mixer进行评估。您可以在我们的“Mixer配置”文档中找到有关此属性提取和策略评估的更多信息。</p><p>Mixer包含一个灵活的插件模型。该模型使Istio可以与各种主机环境和基础架构后端交互。因此，Istio从这些细节中抽象了Envoy代理和Istio管理的服务。</p><h4 id="pilot" tabindex="-1"><a class="header-anchor" href="#pilot" aria-hidden="true">#</a> Pilot</h4><p>Pilot提供了Envoy sidecar的服务发现，智能路由的流量管理功能（例如 A/B测试，金丝雀等）和弹性（超时，重试，断路器等）。</p><p>Pilot将控制流量行为的高级路由规则转换为Envoy特定的配置，并在运行时将其传送到sidecar。Pilot提取了特定于平台的服务发现机制，并将它们合成为标准格式，任何符合Envoy数据平面API的Sidecar都可以使用。这种松散的耦合使得Istio可以在Kubernetes，Consul或Nomad等多种环境中运行，同时为流量管理保留相同的操作员界面。</p><h4 id="citadel" tabindex="-1"><a class="header-anchor" href="#citadel" aria-hidden="true">#</a> Citadel</h4><p>Citadel通过内置的身份和凭据管理实现了强大的服务到服务和终端用户的身份验证。可以使用Citadel来升级服务网格中的未加密流量。使用Citadel，运营商可以基于服务身份而不是相对不稳定的3层或4层网络识别码来实施策略。从版本0.5开始，您可以使用Istio的授权功能来控制谁可以访问您的服务。</p><h4 id="galley" tabindex="-1"><a class="header-anchor" href="#galley" aria-hidden="true">#</a> Galley</h4><p>Galley是Istio的配置验证，提取，处理和分发组件。它负责将其余Istio组件与从底层平台（例如Kubernetes）获取用户配置的细节隔离开来。</p><ul><li><code>最大化透明度</code>：要采用Istio，要求操作员或开发人员进行尽可能少的工作，以从系统中获得真正的价值。为此，Istio可以自动将其自身插入服务之间的所有网络路径中。Istio使用Sidecar代理来捕获流量，并在可能的情况下自动对网络层进行编程，以通过这些代理路由流量，而无需更改已部署的应用程序代码。 在Kubernetes中，代理被注入到Pod中，并通过对iptables规则进行编程来捕获流量。 一旦注入了sidecar代理并且对流量路由进行了编程，Istio就可以调解所有流量。此原则也适用于性能。将Istio应用于部署时，运营商会发现所提供功能的资源成本增加最小。组件和API必须在设计时充分考虑性能和规模。</li><li><code>可扩展性</code>：随着运营商和开发人员越来越依赖Istio提供的功能，系统也必须随着他们的需求而增长。在我们继续添加新功能的同时，最大的需求是扩展策略系统，与其他策略和控制源集成以及将有关网格行为的信号传送到的其他系统以进行分析。策略运行时支持插入其他服务的标准扩展机制。此外，它还允许扩展其词汇表，从而可以根据网格生成的新信号来实施策略。</li><li><code>可移植性</code>：使用Istio的生态系统在许多方面都不同。Istio必须能在任何云端或本地环境中运行，只需最少的努力。将基于Istio的服务移植到新环境的任务必须很简单。使用Istio，您可以操作部署到多个环境中的单个服务。例如，可以在多个云上部署以实现冗余。</li><li><code>策略统一性</code>：将策略应用于服务之间的API调用提供了对网格行为的大量控制。但是，将策略应用于不一定在API级别表达的资源也同样重要。例如，对ML训练任务消耗的CPU数量应用quota比对启动wrok的调用应用quota更有用。为此，Istio将策略系统作为具有其自己的API的独特服务来维护，而不是将策略系统烘焙到代理Sidecar中，从而使得服务根据需要直接与其集成。</li></ul><h2 id="istio的安装" tabindex="-1"><a class="header-anchor" href="#istio的安装" aria-hidden="true">#</a> Istio的安装</h2><h3 id="使用-istioctl-安装" tabindex="-1"><a class="header-anchor" href="#使用-istioctl-安装" aria-hidden="true">#</a> 使用 Istioctl 安装</h3><h4 id="_1-拉取istio的安装包" tabindex="-1"><a class="header-anchor" href="#_1-拉取istio的安装包" aria-hidden="true">#</a> 1.拉取Istio的安装包</h4><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-O</span> http://192.168.1.110/file/istio-1.9.5-linux-amd64.tar.gz

$ <span class="token function">ls</span> 
istio-1.9.5-linux-amd64.tar.gz
$ <span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> istio-1.9.5-linux-amd64.tar.gz
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-复制istioctl工具" tabindex="-1"><a class="header-anchor" href="#_2-复制istioctl工具" aria-hidden="true">#</a> 2.复制istioctl工具</h4><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> istio-1.9.5/
$ <span class="token function">cp</span> bin/istioctl  /usr/local/bin/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-使用默认配置文件安装-istio" tabindex="-1"><a class="header-anchor" href="#_3-使用默认配置文件安装-istio" aria-hidden="true">#</a> 3.使用默认配置文件安装 Istio</h4><p>最简单的选择是 使用以下命令安装<code>default</code>Istio <a href="https://istio.io/latest/docs/setup/additional-setup/config-profiles/" target="_blank" rel="noopener noreferrer">配置文件<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ istioctl <span class="token function">install</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="_4-安装不同的配置文件" tabindex="-1"><a class="header-anchor" href="#_4-安装不同的配置文件" aria-hidden="true">#</a> 4.安装不同的配置文件</h4><p>通过在命令行上传递配置文件名称，可以将其他 Istio 配置文件安装到集群中。例如，以下命令可用于安装<code>demo</code>配置文件：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl  create  ns istio-system
$ istioctl <span class="token function">install</span> <span class="token parameter variable">--set</span> <span class="token assign-left variable">profile</span><span class="token operator">=</span>demo <span class="token parameter variable">-y</span>
✔ Istio core installed                                                   
✔ Istiod installed                                                  
✔ Egress gateways installed                                                        
✔ Ingress gateways installed                                                        
✔ Installation complete     
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-检查安装了什么" tabindex="-1"><a class="header-anchor" href="#_5-检查安装了什么" aria-hidden="true">#</a> 5.检查安装了什么</h4><p>该<code>istioctl</code>命令将<code>IstioOperator</code>用于安装 Istio的CR保存在名为<code>installed-state</code>. 而不是检查 Istio 安装的部署、pod、服务和其他资源，例如：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token parameter variable">-n</span> istio-system get deploy
NAME                   READY   UP-TO-DATE   AVAILABLE   AGE
istio-egressgateway    <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           25s
istio-ingressgateway   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           24s
istiod                 <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           20s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-注入默认变量" tabindex="-1"><a class="header-anchor" href="#_6-注入默认变量" aria-hidden="true">#</a> 6.注入默认变量</h4><p>将目录更改为 Istio 安装的根目录。</p><p>默认的 Istio 安装使用<a href="https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection" target="_blank" rel="noopener noreferrer">自动边车注入<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。标记将托管应用程序的命名空间<code>istio-injection=enabled</code>：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl label namespace default istio-injection<span class="token operator">=</span>enabled 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="_7-卸载-istio" tabindex="-1"><a class="header-anchor" href="#_7-卸载-istio" aria-hidden="true">#</a> 7.卸载 Istio</h4><p>要从集群中完全卸载 Istio，请运行以下命令：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ istioctl x uninstall <span class="token parameter variable">--purge</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>可选<code>--purge</code>标志将删除所有 Istio 资源，包括可能与其他 Istio 控制平面共享的集群范围的资源。</p><h3 id="测试一个实例" tabindex="-1"><a class="header-anchor" href="#测试一个实例" aria-hidden="true">#</a> 测试一个实例</h3><h4 id="bookinfo" tabindex="-1"><a class="header-anchor" href="#bookinfo" aria-hidden="true">#</a> Bookinfo</h4><p><strong>Bookinfo 应用程序分为四个独立的微服务：</strong></p><ul><li><code>productpage</code>. 该<code>productpage</code>微服务调用<code>details</code>和<code>reviews</code>微服务来填充页面。</li><li><code>details</code>. 该<code>details</code>微服务包含图书信息。</li><li><code>reviews</code>. 该<code>reviews</code>微服务包含了书评。它还调用<code>ratings</code>微服务。</li><li><code>ratings</code>. 该<code>ratings</code>微服务包含预定伴随书评排名信息。</li></ul><p><strong><code>reviews</code>微服务有 3 个版本：</strong></p><ul><li>版本 v1 不调用该<code>ratings</code>服务。</li><li>版本 v2 调用该<code>ratings</code>服务，并将每个评级显示为 1 到 5 颗黑星。</li><li>版本 v3 调用该<code>ratings</code>服务，并将每个评级显示为 1 到 5 颗红星。</li></ul><p>该应用程序的端到端架构如下所示。</p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062326474.png" alt="image-20211214154321190" style="zoom:80%;"><h4 id="使用istio部署应用程序🚀" tabindex="-1"><a class="header-anchor" href="#使用istio部署应用程序🚀" aria-hidden="true">#</a> 使用Istio部署应用程序🚀</h4><p>使用 Istio 运行示例不需要更改应用程序本身。相反，您只需要在支持 Istio 的环境中配置和运行服务，并在每个服务旁边注入 Envoy sidecar。生成的部署将如下所示：</p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062326222.png" alt="image-20211214154410424" style="zoom:80%;"><h4 id="启动应用服务🚀" tabindex="-1"><a class="header-anchor" href="#启动应用服务🚀" aria-hidden="true">#</a> 启动应用服务🚀</h4><p>使用以下<code>kubectl</code>命令部署您的应用程序：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/platform/kube/bookinfo.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="查看所有服务🚀" tabindex="-1"><a class="header-anchor" href="#查看所有服务🚀" aria-hidden="true">#</a> 查看所有服务🚀</h4><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl get svc </span>
NAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>    AGE
details       ClusterIP   <span class="token number">10.104</span>.17.202    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9080</span>/TCP   21m
kubernetes    ClusterIP   <span class="token number">10.96</span>.0.1        <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP    41m
productpage   ClusterIP   <span class="token number">10.110</span>.235.179   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9080</span>/TCP   21m
ratings       ClusterIP   <span class="token number">10.104</span>.53.51     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9080</span>/TCP   21m
reviews       ClusterIP   <span class="token number">10.101</span>.21.63     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9080</span>/TCP   21m

<span class="token punctuation">[</span>root@master istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl get pods </span>
NAME                              READY   STATUS    RESTARTS   AGE
details-v1-79f774bdb9-gwhkf       <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m
productpage-v1-6b746f74dc-6dtg8   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m
ratings-v1-b6994bb9-9h2wn         <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m
reviews-v1-545db77b95-6cmmv       <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m
reviews-v2-7bf8c9648f-m2k9d       <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m
reviews-v3-84779c7bbc-vd86b       <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="通过curl请求测试🚀" tabindex="-1"><a class="header-anchor" href="#通过curl请求测试🚀" aria-hidden="true">#</a> 通过Curl请求测试🚀</h4><p>要确认 Bookinfo 应用程序正在运行，请通过<code>curl</code>来自某个 pod的命令向其发送请求，例如来自<code>ratings</code>：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl exec &quot;$(kubectl get pod -l app=ratings -o jsonpath=&#39;{.items[0].metadata.name}&#39;)&quot; -c ratings -- curl -sS productpage:9080/productpage | grep -o &quot;&lt;title&gt;.*&lt;/title&gt;&quot;</span>
<span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Simple Bookstore App<span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="确定入口ip和端口🚀" tabindex="-1"><a class="header-anchor" href="#确定入口ip和端口🚀" aria-hidden="true">#</a> 确定入口IP和端口🚀</h4><p>现在 Bookinfo 服务已启动并运行，您需要使应用程序可从 Kubernetes 集群外部访问，例如从浏览器访问。一个<a href="https://istio.io/latest/docs/concepts/traffic-management/#gateways" target="_blank" rel="noopener noreferrer">Istio网关<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 用于此目的。</p><ol><li><strong><code>为应用定义入口网关</code></strong></li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml </span>
gateway.networking.istio.io/bookinfo-gateway created
virtualservice.networking.istio.io/bookinfo created
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><strong><code>确认网关已创建</code></strong></li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl get gateway </span>
NAME               AGE
bookinfo-gateway   61s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><strong><code>改为NodePort</code></strong></li></ol><p>此处我们并没有外部负载，所以要将svc修改成NodePort的方式。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -n istio-system </span>
NAME                   TYPE         CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>                                                                      AGE
istio-egressgateway    ClusterIP    <span class="token number">10.102</span>.197.30   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>/TCP,443/TCP,15443/TCP                                                     89m
istio-ingressgateway   LoadBalancer <span class="token number">10.109</span>.71.35    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">15021</span>:31964/TCP,80:31467/TCP,443:31845/TCP,31400:31077/TCP,15443:30757/TCP   89m
istiod                 ClusterIP    <span class="token number">10.111</span>.156.86   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">15010</span>/TCP,15012/TCP,443/TCP,15014/TCP                                        90m

<span class="token comment">#访问masterIP+80端口对应暴露的31962</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><code>注意： 如果 EXTERNAL-IP 设置了该值，则要求您的环境具有可用于 Ingress 网关的外部负载均衡器。如果 EXTERNAL-IP 值是 &lt;none&gt;（或一直是 &lt;pending&gt; ），则说明可能您的环境不支持为 ingress 网关提供外部负载均衡器的功能。在这种情况下，您可以使用 Service 的 node port 方式访问网关。</code></p></blockquote><p>使用 kubectl patch 更新 istio-ingressgateway 服务网关类型</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl patch service istio-ingressgateway -n istio-system -p &#39;{&quot;spec&quot;:{&quot;type&quot;:&quot;NodePort&quot;}}&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>设置入口端口</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.spec.ports[?(@.name==&quot;http2&quot;)].nodePort}&#39;</span><span class="token variable">)</span></span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">SECURE_INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.spec.ports[?(@.name==&quot;https&quot;)].nodePort}&#39;</span><span class="token variable">)</span></span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">TCP_INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.spec.ports[?(@.name==&quot;tcp&quot;)].nodePort}&#39;</span><span class="token variable">)</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>获取ingress ip地址</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">INGRESS_HOST</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get po <span class="token parameter variable">-l</span> <span class="token assign-left variable">istio</span><span class="token operator">=</span>ingressgateway <span class="token parameter variable">-n</span> istio-system <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.items[0].status.hostIP}&#39;</span><span class="token variable">)</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062327570.png" alt="image-20211214170233622"><h4 id="应用默认目标规则🚀" tabindex="-1"><a class="header-anchor" href="#应用默认目标规则🚀" aria-hidden="true">#</a> 应用默认目标规则🚀</h4><p>在使用 Istio 控制 Bookinfo 版本路由之前，您需要在<a href="https://istio.io/latest/docs/concepts/traffic-management/#destination-rules" target="_blank" rel="noopener noreferrer">目标规则中<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>定义可用版本，称为子集。</p><p>运行以下命令为 Bookinfo 服务创建默认目标规则：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/destination-rule-all.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p>在<code>default</code>与<code>demo</code> <a href="https://istio.io/latest/docs/setup/additional-setup/config-profiles/" target="_blank" rel="noopener noreferrer">配置轮廓<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>具有<a href="https://istio.io/latest/docs/tasks/security/authentication/authn-policy/#auto-mutual-tls" target="_blank" rel="noopener noreferrer">自动相互TLS<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>启用默认情况下。要强制实施双向 TLS，请使用<code>samples/bookinfo/networking/destination-rule-all-mtls.yaml</code>.</p></blockquote><h4 id="清理🚀" tabindex="-1"><a class="header-anchor" href="#清理🚀" aria-hidden="true">#</a> 清理🚀</h4><p>当您完成 Bookinfo 示例的试验后，请按照以下说明卸载并清理它：</p><p>删除路由规则并终止应用程序 Pod</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ samples/bookinfo/platform/kube/cleanup.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>确认关机</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl get virtualservices   <span class="token comment">#-- there should be no virtual services</span>
$ kubectl get destinationrules  <span class="token comment">#-- there should be no destination rules</span>
$ kubectl get gateway           <span class="token comment">#-- there should be no gateway</span>
$ kubectl get pods              <span class="token comment">#-- the Bookinfo pods should be deleted</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="介绍istio流量管理" tabindex="-1"><a class="header-anchor" href="#介绍istio流量管理" aria-hidden="true">#</a> 介绍Istio流量管理</h2><h4 id="首先是istio如何在网格种引导流量的" tabindex="-1"><a class="header-anchor" href="#首先是istio如何在网格种引导流量的" aria-hidden="true">#</a> 首先是Istio如何在网格种引导流量的？</h4><ol><li>首先要知道所在的端点在哪里？</li><li>以及它们属于哪些服务？</li><li>填充自己的服务注册（就是内部的注册表，用来生成一些Envoy配置）连接到服务发现系统。</li><li>在Kubernetes中安装Istio，那么Istio会自动检测集群中的服务和端点。</li></ol><h4 id="在kubernetes中如何使用istio" tabindex="-1"><a class="header-anchor" href="#在kubernetes中如何使用istio" aria-hidden="true">#</a> 在Kubernetes中如何使用istio？</h4><p>1.通过Kubernetes安装istio之后对<code>K8S使用CRD扩展， 也就是Kubernetes的 API扩展</code>，istio也能像其他 的resouces一样使用。 2.通过使用Kubrenetes API的扩展，可以使用资源有 虚拟服务、目的规则、网关、服务条目、边车。</p><h4 id="在istio中能学到什么" tabindex="-1"><a class="header-anchor" href="#在istio中能学到什么" aria-hidden="true">#</a> 在istio中能学到什么？</h4><p>1.可以学习到流量的管理、入口出口流量管理。</p><ul><li><code>请求路由</code></li><li><code>故障注入</code></li><li><code>交通转移</code></li><li><code>TCP流量转移</code></li><li><code>请求超时</code></li><li><code>熔断</code></li><li><code>镜像</code></li><li><code>局部负载均衡</code></li><li><code>入口的网关</code></li><li><code>出口的访问外部服务</code></li></ul><h4 id="什么是虚拟服务" tabindex="-1"><a class="header-anchor" href="#什么是虚拟服务" aria-hidden="true">#</a> 什么是虚拟服务？</h4><p>虚拟服务以及目标规则是Istio流量路由功能的关键构建块。虚拟服务允许您配置如何将请求的路由到Istio的服务网格中的服务。 建立在Istio和您的平台提供基本的连接和发现之上。每一个虚拟服务都包含了一组按顺序评估的路由规则，让Istio将每一个给定的虚拟服务请求匹配到网格中特定真实的目的地。</p><h4 id="为什么要使用虚拟服务" tabindex="-1"><a class="header-anchor" href="#为什么要使用虚拟服务" aria-hidden="true">#</a> 为什么要使用虚拟服务？</h4><p>1.通过将客户端从实际实现它们的目标工作负载发送请求的位置强解耦来做到这一点。虚拟服务还提供一种丰富的方式来指定不同的流量路由规则，以将流量发送到这些工作负载。</p><p>2.为什么说这很有用？ Envoy在所有服务实例之间使用循环负载平衡来分配流量，对此进行了改进，可以针对百分比进行特定的流量引导。</p><p>3.可以一个或者多个指定主机名指定流量行为。 在虚拟服务中，使用路由规则来告诉Envoy如何将虚拟服务的流量发送到合适的地方。</p><p>4.还可以将单个虚拟服务处理多个应用程序。 结合网关的流量规则，控制流量进出。</p><h4 id="虚拟服务实例" tabindex="-1"><a class="header-anchor" href="#虚拟服务实例" aria-hidden="true">#</a> 虚拟服务实例</h4><p>以下的虚拟服务根据请求是否来自特定的用户，将请求路由到不同版本的服务。</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
        <span class="token key atrule">end-user</span><span class="token punctuation">:</span>
          <span class="token key atrule">exact</span><span class="token punctuation">:</span> jason
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="主机字段" tabindex="-1"><a class="header-anchor" href="#主机字段" aria-hidden="true">#</a> 主机字段</h4><p>1.<code>hosts字段</code>列出了虚拟服务的主机，这些路由规则适用的用户可以寻址目的或目的地。这是客户端在向 服务发送请求时使用的地址。 2.主机名可以是<code>IP地址</code>，也可以是<code>DNS名称</code>以及解析的。</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">hosts</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> reviews
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="路由规则" tabindex="-1"><a class="header-anchor" href="#路由规则" aria-hidden="true">#</a> 路由规则</h4><p>1.该http部分包含虚拟服务的路由规则，描述了将<code>HTTP/1.1 HTTP2和gRPC流量</code>路由到hosts字段中指定的 目标的匹配条件和操作。 2.匹配条件（示例中的第一个路由有一个条件，因此以match字段开头。在这种情况下，您希望此路由适 用于来自用户‘jason’的所有请求，因此您使用headers、end-user和exact字段来选择适当的请求。）</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
   <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
       <span class="token key atrule">end-user</span><span class="token punctuation">:</span>
         <span class="token key atrule">exact</span><span class="token punctuation">:</span> jason
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="目的地" tabindex="-1"><a class="header-anchor" href="#目的地" aria-hidden="true">#</a> 目的地</h4><p>路由部分<code>destination字段</code>指定符合条件的流量实际目的地。 与虚拟主机不同，目标主机必须存在于istio服务注册表中真实目标，否则Envoy将不知道将流量发送到何处。</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>route：
<span class="token punctuation">-</span> <span class="token key atrule">destintion</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
    <span class="token key atrule">subnet</span><span class="token punctuation">:</span> v2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="路由规则优先级" tabindex="-1"><a class="header-anchor" href="#路由规则优先级" aria-hidden="true">#</a> 路由规则优先级</h4><p>路由规则按照上到下的顺序进行评估，<code>虚拟服务定义中的第一个规则被赋予最高优先级。</code> 在这种情况下 ，您希望任何第一条路由规则不匹配的东西都转到第二条规则中指定默认的目的地。 因此，第二条规则 没有匹配条件，只是将流量定向到v3子集。</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
      <span class="token key atrule">subnet</span><span class="token punctuation">:</span> v3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="有关路由的更多信息" tabindex="-1"><a class="header-anchor" href="#有关路由的更多信息" aria-hidden="true">#</a> 有关路由的更多信息</h4><p>路由规则是将特定流量子集路由到特定目的地的强大工具。<code>您可以对流量端口、标头字段、URL等设置匹 配条件</code>，例如：此虚拟服务允许用户将流量发送到两个单独的服务，评分和评论，就好像它们是更大的虚拟服务的一部分一样。虚拟服务规则根据请求的URL匹配流量，并将流量请求定向到合适的服务。</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> bookinfo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> bookinfo.com
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /reviews
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /ratings
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>除了使用匹配条件外，您还可以按&quot;权重&quot;百分比分配流量。这对于A/B测试和金丝雀发布很有用。</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> route
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subnet</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">75</span>
  <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
      <span class="token key atrule">subnet</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">25</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>您还可以使用路由规则对流量执行一些操作，例如：</p><ul><li><code>附加或删除标题</code></li><li><code>重写网址</code></li><li><code>为对该目的地的调用设置重试策略</code></li></ul><h4 id="目的地规则" tabindex="-1"><a class="header-anchor" href="#目的地规则" aria-hidden="true">#</a> 目的地规则</h4><p>1.目标规则是Istio流量路由功能的关键部分。可以将虚拟服务视为流量将路由给定目 的地的方式，目标规则在评估虚拟服务路由规则后应用，因此它们适用于流量的&quot;真实&quot;目标。 2.特别是，您使用目标规则来指定命名的服务子集，例如按版本对所有给定服务的实例进行分组。然后，您可以在虚拟服务的路由规则中使用这些服务子集来控制到不同服务实例的流量。 3.目标规则还允许您在调用整个目标服务或特定服务子集时自定义 Envoy 的流量策略，例如您首选的负 载平衡模型、TLS 安全模式或断路器设置。</p><h4 id="负载平衡选项" tabindex="-1"><a class="header-anchor" href="#负载平衡选项" aria-hidden="true">#</a> 负载平衡选项</h4><p>默认情况下，Istio 使用循环负载均衡策略，实例池中的每个服务实例依次收到请求。Istio 还支持以下模型，您可以在目标规则中为对特定服务或服务子集的请求指定这些模型。</p><ul><li><code>随机：</code>请求随机转发到池中的实例。</li><li><code>加权：</code>根据特定百分比将请求转发到池中的实例。</li><li><code>最少请求：</code>请求被转发到请求数量最少的实例。</li></ul><h4 id="目标规则示例" tabindex="-1"><a class="header-anchor" href="#目标规则示例" aria-hidden="true">#</a> 目标规则示例</h4><p>以下示例目标规则为my-svc目标服务配置了三个不同的子集，具有不同的负载平衡策略：</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>destination<span class="token punctuation">-</span>rule
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>svc
  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>
      <span class="token key atrule">simple</span><span class="token punctuation">:</span> RANDOM
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
      <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>
        <span class="token key atrule">simple</span><span class="token punctuation">:</span> ROUND_ROBIN
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v3
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>每个子集都是基于一个或多个定义的labels，在Kubernetes中，它们是附加到Pod等对象的键/值对。这些标签应用于Kubernetes服务的部署，metadata以识别不同的版本。</p><p>除了定义子集之外，此目标规则还具有针对此目标中所有子集的默认流量策略和仅针对该子集覆盖它的子集特定策略。在该字段上方定义的默认策略为和子集subsets 设置简单的随机负载均衡器。在 策略中， 在相应子集的字段中指定了循环负载均衡器。v1v3v2</p><h4 id="网关" tabindex="-1"><a class="header-anchor" href="#网关" aria-hidden="true">#</a> 网关</h4><p>1.您使用网关来管理网格的入站和出站流量，让您<code>指定要进入或离开网格的流量</code>。网关配置应用于在网格边缘运行的独立 Envoy 代理，而不是与服务工作负载一起运行的 Sidecar Envoy 代理。 2.与控制进入系统的流量的其他机制（例如 Kubernetes Ingress API）不同，<code>Istio 网关让您可以使用 Istio 流量路由的全部功能和灵活性</code>。您可以这样做，因为 Istio 的网关资源只允许您配置 4-6 层负载平衡属性，例如要公开的端口、TLS 设置等。然后，您无需将应用层流量路由 (L7) 添加到同一 API 资 源，而是将常规 Istio虚拟服务绑定到网关。这使您可以像管理 Istio 网格中的任何其他数据平面流量 一样管理网关流量。 3.<code>网关主要用于管理入口流量，但您也可以配置出口网关</code>。例如，出口网关允许您为离开网格的流量配置专用出口节点，让您限制哪些服务可以或应该访问外部网络，或者启用 对出口流量的安全控制 以增加网格的安全性。您还可以使用网关来配置纯内部代理。 4.Istio 提供了一些您可以使用的预配置网关代理部署 (istio-ingressgateway和istio-egressgateway)如果您使用我们的演示安装，则会部署两者，而仅使用我们的默认配置文件部署入口网关 。您可以将自 己的网关配置应用于这些部署，或者部署和配置自己的网关代理。</p><h4 id="网关示例" tabindex="-1"><a class="header-anchor" href="#网关示例" aria-hidden="true">#</a> 网关示例</h4><p>以下示例显示了外部 HTTPS 入口流量的可能网关配置： 此网关配置<code>允许 HTTPS 流量</code>从<code>ext-host.example.com端口 443 进入网格</code>，但没有为流量指定任何路由。</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ext<span class="token punctuation">-</span>host<span class="token punctuation">-</span>gwy
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>gateway<span class="token punctuation">-</span>controller
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> https
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ext<span class="token punctuation">-</span>host.example.com
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE
      <span class="token key atrule">credentialName</span><span class="token punctuation">:</span> ext<span class="token punctuation">-</span>host<span class="token punctuation">-</span>cert
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>要指定路由并使网关按预期工作，您还必须将网关绑定到虚拟服务。您可以使用虚拟服务的gateways字 段执行此操作，如以下示例所示：</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> virtual<span class="token punctuation">-</span>svc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ext<span class="token punctuation">-</span>host.example.com
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ext<span class="token punctuation">-</span>host<span class="token punctuation">-</span>gwy
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后，您可以使用外部流量的路由规则配置虚拟服务。</p><h4 id="服务条目" tabindex="-1"><a class="header-anchor" href="#服务条目" aria-hidden="true">#</a> 服务条目</h4><p>您可以使用服务条目向Istio内部维护的服务注册表添加一个条目。添加服务条目之后，Envoy代理可以将流量发送到服务，就好像它是网格中的服务一样。配置服务条目允许您管理在网格之外允许的服务流量，包括以下任务：</p><ul><li><code>重定向和转发外部目的地的流量</code>，例如从web使用的API，或到旧基础设施中的服务流量。</li><li><code>为外部目标定义重试、超时和故障注入策略。</code></li><li><code>通过虚拟机添加网格中，在虚拟机中允许网格服务。</code></li></ul><p>您无需希望网格服务使用的每个外部服务添加服务条目，默认情况下，Istio将Envoy代理设置为将请求传递给未知服务。但是，您不能使用Istio功能来控制到未来在网格中注册的目的地流量。</p><h4 id="服务入口示例" tabindex="-1"><a class="header-anchor" href="#服务入口示例" aria-hidden="true">#</a> 服务入口示例</h4><p>以下示例网格外部服务条目<code>将ext-svc.example.com 外部依赖项添加到 Istio 的服务注册表</code>： 您使用该hosts字段指定外部资源。您可以完全限定它或使用通配符前缀的域名。</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceEntry
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> svc<span class="token punctuation">-</span>entry
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ext<span class="token punctuation">-</span>svc.example.com
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> https
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
  <span class="token key atrule">location</span><span class="token punctuation">:</span> MESH_EXTERNAL
  <span class="token key atrule">resolution</span><span class="token punctuation">:</span> DNS
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>您可以配置虚拟服务和目标规则，以更精细的方式控制服务条目的流量，就像为网格中的任何其他服务配置流量一样。例如，以下目标规则将流量路由配置为使用<code>双向 TLS 来保护与 ext-svc.example.com我们 使用服务条目配置的外部服务的连接</code>：</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ext<span class="token punctuation">-</span>res<span class="token punctuation">-</span>dr
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> ext<span class="token punctuation">-</span>svc.example.com
  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> MUTUAL
      <span class="token key atrule">clientCertificate</span><span class="token punctuation">:</span> /etc/certs/myclientcert.pem
      <span class="token key atrule">privateKey</span><span class="token punctuation">:</span> /etc/certs/client_private_key.pem
      <span class="token key atrule">caCertificates</span><span class="token punctuation">:</span> /etc/certs/rootcacerts.pem
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="边车" tabindex="-1"><a class="header-anchor" href="#边车" aria-hidden="true">#</a> 边车</h4><p>默认情况下，Istio将每个Envo代理配置为接受其相关工作负载的所有端口上的流量，并在转发流量时到 达网格中的每个工作负载。您可以使用sidecar配置执行以下操作：</p><ul><li><code>微调Envoy代理接受的端口和协议集</code></li><li><code>限制Envoy代理可以访问的服务集</code></li></ul><p>您可能希望在大型的应用程序像这样限制sidecar的可访问性，其中将每个代理配置为访问网格中的所有 其他服务可能会由于高内存的使用率而影响网格的性能。</p><p>您可以指定希望将 sidecar 配置应用于特定命名空间中的所有工作负载，或者使用 workloadSelector. 例如，以下 sidecar 配置将命名空间中的所有服务配置bookinfo为仅访问在同一命名空间和 Istio 控制平面中运行的服务（Istio 的出口和遥测功能需要）：</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Sidecar
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> default
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> bookinfo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">egress</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;./*&quot;</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;istio-system/*&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="网络弹性和测试" tabindex="-1"><a class="header-anchor" href="#网络弹性和测试" aria-hidden="true">#</a> 网络弹性和测试</h4><p>除了帮助您引导网格周围的流量外，Istio 还提供了可选的故障恢复和故障注入功能，您可以在运行时动态配置这些功能。使用这些功能可以帮助您的应用程序可靠地运行，确保服务网格可以容忍故障节点并防止局部故障级联到其他节点。</p><h4 id="超时" tabindex="-1"><a class="header-anchor" href="#超时" aria-hidden="true">#</a> 超时</h4><p><code>超时是 Envoy 代理应该等待来自给定服务的回复的时间量，确保服务不会无限期地等待回复，并且调用 在可预测的时间范围内成功或失败。</code>默认情况下，Istio 中禁用了 HTTP 请求的 Envoy 超时.</p><p>对于某些应用程序和服务，Istio 的默认超时可能不合适。例如，过长的超时可能会导致等待来自失败服务的回复的延迟过长，而过短的超时可能会导致调用在等待涉及多个服务的操作返回时不必要地失败。为了找到并使用您的最佳超时设置，Istio 允许您使用虚拟服务轻松地在每个服务的基础上动态调整超时，而无需编辑您的服务代码。下面是一个虚拟服务，它为调用 rating 服务的 v1 子集指定了 10 秒的超时时间：</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 10s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="重试" tabindex="-1"><a class="header-anchor" href="#重试" aria-hidden="true">#</a> 重试</h4><p><code>重试设置指定 Envoy 代理在初始调用失败时尝试连接服务的最大次数。</code>重试可以通过确保调用不会因为 临时性问题（例如临时过载的服务或网络）而永久失败，从而提高服务可用性和应用程序性能。重试间隔（25ms+）是可变的，由 Istio 自动确定，防止被调用的服务被请求淹没。HTTP 请求的默认重试行为是 在返回错误之前重试两次。</p><p>与超时一样，Istio 的默认重试行为可能不适合您的应用程序在延迟（失败的服务重试次数过多可能会减慢速度）或可用性方面的需求。也像超时一样，您可以在虚拟服务中基于每个服务调整重试设置，而无需接触您的服务代码。您还可以通过添加每次重试超时来进一步优化您的重试行为，指定您希望等待每次重试尝试成功连接到服务的时间量。以下示例在初始调用失败后配置最多 3 次重试以连接到此服务子集， 每次重试时间为 2 秒。</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">retries</span><span class="token punctuation">:</span>
      <span class="token key atrule">attempts</span><span class="token punctuation">:</span> <span class="token number">3</span>
      <span class="token key atrule">perTryTimeout</span><span class="token punctuation">:</span> 2s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="熔断" tabindex="-1"><a class="header-anchor" href="#熔断" aria-hidden="true">#</a> 熔断</h4><p><code>熔断是 Istio 提供的另一种有用的机制，用于创建基于微服务的弹性应用程序。</code>在断路器中，您可以 设置对服务中各个主机的调用限制，例如并发连接数或对该主机的调用失败的次数。一旦达到该限制，断路器就会“跳闸”并停止与该主机的进一步连接。使用断路器模式可以实现快速故障，而不是客户端尝试连接到过载或故障主机。</p><p>由于断路器适用于负载平衡池中的“真实”网格目标，您可以在目标规则中配置断路器阈值 ，并将设置应 用于服务中的每个单独的主机。以下示例reviews将 v1 子集的服务工作负载的并发连接数限制为 100：</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
      <span class="token key atrule">connectionPool</span><span class="token punctuation">:</span>
        <span class="token key atrule">tcp</span><span class="token punctuation">:</span>
          <span class="token key atrule">maxConnections</span><span class="token punctuation">:</span> <span class="token number">100</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="故障注入" tabindex="-1"><a class="header-anchor" href="#故障注入" aria-hidden="true">#</a> 故障注入</h4><p><code>配置好网络（包括故障恢复策略）后，您可以使用 Istio 的故障注入机制来测试整个应用程序的故障恢复能力。</code>故障注入是一种将错误引入系统以确保系统能够承受并从错误条件中恢复的测试方法。使用故障注入对于确保您的故障恢复策略不会不兼容或限制过多，可能会导致关键服务不可用特别有用。</p><p>与其他引入错误的机制（例如延迟数据包或在网络层杀死 pod）不同，Istio 允许您在应用程序层注入故障。这使您可以注入更多相关故障，例如 HTTP 错误代码，以获得更多相关结果。</p><p>您可以注入两种类型的故障，均使用 虚拟服务进行配置：</p><ul><li><code>延迟：</code>延迟是计时失败。它们模仿增加的网络延迟或过载的上游服务。</li><li><code>中止：</code>中止是崩溃失败。它们模仿上游服务中的故障。中止通常以 HTTP 错误代码或 TCP 连接失败的 形式出现。</li></ul><p>例如，此虚拟服务对ratings服务的每 1000 个请求中的 1 个引入了 5 秒的延迟。</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">fault</span><span class="token punctuation">:</span>
      <span class="token key atrule">delay</span><span class="token punctuation">:</span>
        <span class="token key atrule">percentage</span><span class="token punctuation">:</span>
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">0.1</span>
        <span class="token key atrule">fixedDelay</span><span class="token punctuation">:</span> 5s
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="sidecar注入" tabindex="-1"><a class="header-anchor" href="#sidecar注入" aria-hidden="true">#</a> Sidecar注入</h2><h4 id="对工作负载的一些要求" tabindex="-1"><a class="header-anchor" href="#对工作负载的一些要求" aria-hidden="true">#</a> 对工作负载的一些要求</h4><p>支持的工作负载类型：</p><ul><li><code>Job</code></li><li><code>DaemonSet</code></li><li><code>ReplicaSet</code></li><li><code>Pod</code></li><li><code>Deployment</code></li></ul><p>等，对这些工作负载的要求如下：</p><ul><li>要正确命名服务端口： <ul><li><code>Service</code> 对象中的 <code>Port</code> 部分必须以 &quot;协议名&quot; 为前缀，目前支持的协议名包括 <code>http</code>，<code>http2</code>，<code>mongo</code>，<code>redis</code> 与 <code>grpc</code>；</li><li>istio 会命名来确定为端口提供什么样的服务，不符合命名规范的端口会被当做 TCP 服务器，其功能支持范围会大幅缩小。</li></ul></li><li>工作负载的 Pod 必须有关联的 Service： <ul><li>为满足服务发现的需要，所有 Pod 都必须有关联的服务；</li><li>官方建议为 Pod 模板加入两个标签：<code>app</code> 与 <code>version</code>，分别标注应用名称与版本，虽仅是个建议，但 istio 很多默认策略会引用这两个标签，如果没有会引发很多不必要的麻烦。</li></ul></li></ul><h4 id="手工注入" tabindex="-1"><a class="header-anchor" href="#手工注入" aria-hidden="true">#</a> 手工注入</h4><p>创建一个deployment做nginx的pod控制器，副本维持在2个。</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 ~<span class="token punctuation">]</span><span class="token comment"># cat deploymen.yaml  </span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> 
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> test 
  <span class="token key atrule">name</span><span class="token punctuation">:</span> test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> test
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> test
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx 
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent 
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
        
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f deploymen.yaml  </span>
deployment.apps/test created
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>istioctl kube-inject 会将 istio 相关容器注入应用，&quot;-o&quot; 参数将注入结果生成 yaml 文件 ，方便观察使用此命令与 &quot;kubectl apply -f&quot; 的区别；</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-work<span class="token punctuation">]</span><span class="token comment"># istioctl kube-inject -f deployment.yaml -o deployment-inject.yaml  </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>新的 yaml 文件中多出了 &quot;Sidecar&quot; 容器， 并且出现了1个初始化容器 (initContainers) &quot;istio-init&quot; ，初始化容器即用来劫持应用通信到 &quot;Sidecar&quot; 容器的工具；</p><p>可直接 &quot;kubectl apply -f&quot; 生成的 yaml 文件，<code>注入后 Nginx 应用 与 Istio-Proxy 共享网络命名空间</code> 。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-work<span class="token punctuation">]</span><span class="token comment"># istioctl kube-inject  -f /root/deploymen.yaml | kubectl apply -f - -n test </span>
deployment.apps/test configured
<span class="token punctuation">[</span>root@k8s-master-node1 istio-work<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n test </span>
NAME                    READY   STATUS    RESTARTS   AGE
test-67b6d4d78c-jzzml   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          20s
test-67b6d4d78c-sfxk8   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          20s

<span class="token punctuation">[</span>root@k8s-master-node1 istio-work<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it  -n test test-67b6d4d78c-jzzml -c istio-proxy -- netstat -ntlp</span>
Active Internet connections <span class="token punctuation">(</span>only servers<span class="token punctuation">)</span>
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15021           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15021           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:80              <span class="token number">0.0</span>.0.0:*               LISTEN      -                   
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15090           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15090           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:15000         <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15001           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15001           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:15004         <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">1</span>/pilot-agent       
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15006           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15006           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::15020                :::*                    LISTEN      <span class="token number">1</span>/pilot-agent       
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::80                   :::*                    LISTEN      -                   
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="请求路由" tabindex="-1"><a class="header-anchor" href="#请求路由" aria-hidden="true">#</a> 请求路由</h2><h4 id="环境准备" tabindex="-1"><a class="header-anchor" href="#环境准备" aria-hidden="true">#</a> 环境准备</h4><ul><li>部署<a href="https://istio.io/latest/docs/examples/bookinfo/" target="_blank" rel="noopener noreferrer">Bookinfo<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>示例应用程序。</li><li>了解了流量管理的基础概念，以及专业语术。</li></ul><blockquote><p>注意：</p><p>Istio <a href="https://istio.io/latest/docs/examples/bookinfo/" target="_blank" rel="noopener noreferrer">Bookinfo<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>示例由四个独立的微服务组成，每个微服务都有多个版本。其中一个微服务的三个不同版本<code>reviews</code>已部署并同时运行。为了说明这导致的问题，请<code>/productpage</code>在浏览器中访问 Bookinfo 应用程序并刷新几次。您会注意到，有时书评输出包含星级，有时则不包含。这是因为如果没有明确的默认服务版本来路由，Istio 会以循环方式将请求路由到所有可用版本。</p></blockquote><h4 id="应用虚拟服务" tabindex="-1"><a class="header-anchor" href="#应用虚拟服务" aria-hidden="true">#</a> 应用虚拟服务</h4><p>要仅路由到一个版本，您可以应用为微服务设置默认版本的虚拟服务。在这种情况下，虚拟服务会将所有流量路由到<code>v1</code>每个微服务。</p><ol><li>运行以下命令以应用虚拟服务：</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>因为配置传播最终是一致的，所以等待几秒钟让虚拟服务生效。</p><ol start="2"><li>使用以下命令显示定义的路由：</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ cat istio<span class="token punctuation">-</span>1.9.5/samples/bookinfo/networking/virtual<span class="token punctuation">-</span>service<span class="token punctuation">-</span>all<span class="token punctuation">-</span>v1.yaml 
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> productpage
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> productpage
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> productpage
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> details
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> details
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> details
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>您还可以<code>subset</code>使用以下命令显示相应的定义：</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl get destinationrules <span class="token parameter variable">-o</span> yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>您已将 Istio 配置为路由到<code>v1</code>Bookinfo 微服务的版本，最重要的是<code>reviews</code>服务版本 1。</p><h4 id="测试新的路由配置" tabindex="-1"><a class="header-anchor" href="#测试新的路由配置" aria-hidden="true">#</a> 测试新的路由配置</h4><p>您可以通过再次刷新<code>/productpage</code> Bookinfo 应用程序轻松测试新配置。</p><ol><li><p>在浏览器中打开 Bookinfo 站点。URL 是<code>http://$GATEWAY_URL/productpage</code>，其中<code>$GATEWAY_URL</code>是入口的外部 IP 地址，如<a href="https://istio.io/latest/docs/examples/bookinfo/#determine-the-ingress-ip-and-port" target="_blank" rel="noopener noreferrer">Bookinfo<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>文档中所述。</p><p>请注意，无论您刷新多少次，页面的评论部分都不会显示评分星。这是因为您将 Istio 配置为将评论服务的所有流量路由到该版本<code>reviews:v1</code>，并且该版本的服务不访问星级评分服务。</p></li></ol><p>您已成功完成此任务的第一部分：将流量路由到服务的一个版本</p><h4 id="基于用户身份的路由" tabindex="-1"><a class="header-anchor" href="#基于用户身份的路由" aria-hidden="true">#</a> 基于用户身份的路由</h4><p>接下来，您将更改路由配置，以便将来自特定用户的所有流量路由到特定服务版本。在这种情况下，来自名为 Jason 的用户的所有流量都将路由到服务<code>reviews:v2</code>。</p><p>该示例的启用是因为该<code>productpage</code>服务将自定义<code>end-user</code>标头添加到所有到评论服务的出站 HTTP 请求。</p><p>Istio 还支持在入口网关上基于强认证 JWT 的路由，有关更多详细信息，请参阅 <a href="https://istio.io/latest/docs/tasks/security/authentication/jwt-route" target="_blank" rel="noopener noreferrer">基于 JWT 声明的路由<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。</p><p>请记住，<code>reviews:v2</code>是包含星级评分功能的版本。</p><ol><li>运行以下命令以启用基于用户的路由：</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="2"><li>确认规则已创建：</li></ol><p>创建规则允许用户jasone</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 networking<span class="token punctuation">]</span><span class="token comment"># cat virtual-service-reviews-test-v2.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
        <span class="token key atrule">end-user</span><span class="token punctuation">:</span>
          <span class="token key atrule">exact</span><span class="token punctuation">:</span> jason
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><p>在<code>/productpage</code>Bookinfo 应用程序上，以 user 身份登录<code>jason</code>。刷新浏览器。你看到了什么？星级评分显示在每条评论旁边。</p></li><li><p>以其他用户身份登录（选择您想要的任何名称）。刷新浏览器。现在星星不见了。这是因为流量被路由到<code>reviews:v1</code>除了 Jason 之外的所有用户。您已成功配置 Istio 以根据用户身份路由流量。</p></li></ol><h4 id="清理" tabindex="-1"><a class="header-anchor" href="#清理" aria-hidden="true">#</a> 清理</h4><p>删除应用程序路由规则：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="故障注入-1" tabindex="-1"><a class="header-anchor" href="#故障注入-1" aria-hidden="true">#</a> 故障注入</h2><h4 id="环境准备-1" tabindex="-1"><a class="header-anchor" href="#环境准备-1" aria-hidden="true">#</a> 环境准备</h4><ul><li>部署<a href="https://istio.io/latest/docs/examples/bookinfo/" target="_blank" rel="noopener noreferrer">Bookinfo<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>示例应用程序，应用目标规则。</li><li>了解了流量管理的基础概念，以及专业语术。</li></ul><blockquote><p>通过执行 <a href="https://istio.io/latest/docs/tasks/traffic-management/request-routing/" target="_blank" rel="noopener noreferrer">请求路由<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>任务或运行以下命令来应用应用程序版本路由：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h4 id="注入http延迟错误" tabindex="-1"><a class="header-anchor" href="#注入http延迟错误" aria-hidden="true">#</a> 注入HTTP延迟错误</h4><p>要测试 Bookinfo 应用程序微服务的弹性，请在user<code>reviews:v2</code>和微服务之间注入 7s 延迟。此测试将发现一个有意引入 Bookinfo 应用程序的错误。<code>ratings jason</code></p><p>请注意，该<code>reviews:v2</code>服务对服务的调用有 10 秒的硬编码连接超时<code>ratings</code>。即使您引入了 7 秒延迟，您仍然希望端到端流程继续进行而不会出现任何错误。</p><ol><li>创建故障注入规则以延迟来自测试用户的流量 <code>jason</code>。</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="2"><li>确认规则已创建： <ul><li><code>创建规则通过jason用户登录</code></li><li><code>在微服务之间注入7s的延迟</code></li></ul></li></ol><blockquote><p><code>参数详解：</code></p><p><strong>fault:</strong> # 要应用于客户端HTTP流量的故障注入策略。 <strong>delay:</strong> # 延迟 <strong>percentage:</strong> # 百分率 <strong>value: 100.0</strong> # 键值为百分之一百 <strong>fixedDelay: 7s</strong> # 固定时间为7s</p></blockquote><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 networking<span class="token punctuation">]</span><span class="token comment"># cat virtual-service-ratings-test-delay.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
        <span class="token key atrule">end-user</span><span class="token punctuation">:</span>
          <span class="token key atrule">exact</span><span class="token punctuation">:</span> jason
    <span class="token key atrule">fault</span><span class="token punctuation">:</span>					
      <span class="token key atrule">delay</span><span class="token punctuation">:</span>				
        <span class="token key atrule">percentage</span><span class="token punctuation">:</span>			
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">100.0</span>
        <span class="token key atrule">fixedDelay</span><span class="token punctuation">:</span> 7s
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>等待几秒钟，让新规则传播到所有 pod。</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062327994.png" alt="image-20220316153536186" loading="lazy"></p><h4 id="测试延迟配置" tabindex="-1"><a class="header-anchor" href="#测试延迟配置" aria-hidden="true">#</a> 测试延迟配置</h4><ol><li><p>在浏览器中打开<a href="https://istio.io/latest/docs/examples/bookinfo" target="_blank" rel="noopener noreferrer">Bookinfo Web 应用程序。<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li><li><p>在<code>/productpage</code>网页上，以 user 身份登录<code>jason</code>。</p><p>您希望 Bookinfo 主页在大约 7 秒内加载而不会出现错误。但是，有一个问题：Reviews 部分显示一条错误消息：</p><p><code>Sorry, product reviews are currently unavailable for this book.</code></p></li><li><p>查看网页响应时间：</p><ol><li>在 Web 浏览器中打开<em>开发者工具</em>菜单。</li><li>打开网络选项卡</li><li>重新加载<code>/productpage</code>网页。您将看到页面实际加载大约需要 6 秒。</li></ol></li></ol><h4 id="修复错误" tabindex="-1"><a class="header-anchor" href="#修复错误" aria-hidden="true">#</a> 修复错误</h4><p>您通常会通过以下方式解决问题：</p><ol><li>增加服务超时或减少<code>productpage</code>服务超时<code>reviews reviews ratings</code></li><li>停止和重启固定的微服务</li><li>确认<code>/productpage</code>网页返回其响应没有任何错误。</li></ol><p>但是，您已经在<code>reviews</code>服务的 v3 中运行了一个修复程序。该<code>reviews:v3</code>服务将超时时间从 10s 减少<code>reviews</code>到2.5s，以便与下游请求<code>ratings</code>的超时时间兼容（小于） <code>productpage</code>。</p><p>如果您按照<a href="https://istio.io/latest/docs/tasks/traffic-management/traffic-shifting/" target="_blank" rel="noopener noreferrer">流量转移<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><code>reviews:v3</code>任务中的描述 将所有流量迁移到，您可以尝试将延迟规则更改为小于 2.5s 的任意量，例如 2s，并确认端到端流程继续没有任何错误。</p><h4 id="注入http中止错误" tabindex="-1"><a class="header-anchor" href="#注入http中止错误" aria-hidden="true">#</a> 注入HTTP中止错误</h4><p>测试微服务弹性的另一种方法是引入 HTTP 中止故障。<code>ratings</code>在此任务中，您将为测试用户的微服务引入 HTTP 中止<code>jason</code>。</p><p>在这种情况下，您希望页面立即加载并显示<code>Ratings service is currently unavailable</code>消息。</p><ol><li>创建一个故障注入规则，为用户发送 HTTP 中止<code>jason</code>：</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-ratings-test-abort.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="2"><li>确认规则已创建： <ul><li><code>创建规则通过jason用户流量</code></li><li><code>在微服务之间中止jason用户，httpstatus是500状态，百分率设置为100</code></li></ul></li></ol><blockquote><p><code>参数详解：</code></p><p><strong>fault:</strong> # 要应用于客户端HTTP流量的故障注入策略。 <strong>abort:</strong> # 中止策略 <strong>percentage:</strong> # 百分率 <strong>value: 100.0</strong> # 键值为百分之一百 <strong>httpStatus: 500</strong> # httpstatus设置为500报错</p></blockquote><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 networking<span class="token punctuation">]</span><span class="token comment"># cat virtual-service-ratings-test-abort.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
        <span class="token key atrule">end-user</span><span class="token punctuation">:</span>
          <span class="token key atrule">exact</span><span class="token punctuation">:</span> jason
    <span class="token key atrule">fault</span><span class="token punctuation">:</span>
      <span class="token key atrule">abort</span><span class="token punctuation">:</span>
        <span class="token key atrule">percentage</span><span class="token punctuation">:</span>
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">100.0</span>
        <span class="token key atrule">httpStatus</span><span class="token punctuation">:</span> <span class="token number">500</span>
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="测试中止配置" tabindex="-1"><a class="header-anchor" href="#测试中止配置" aria-hidden="true">#</a> 测试中止配置</h4><ol><li><p>在浏览器中打开<a href="https://istio.io/latest/docs/examples/bookinfo" target="_blank" rel="noopener noreferrer">Bookinfo Web 应用程序。<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li><li><p>在 上<code>/productpage</code>，以用户身份登录<code>jason</code>。</p><p>如果规则成功传播到所有 pod，页面会立即加载并显示<code>Ratings service is currently unavailable</code>消息。</p></li><li><p>如果您从用户注销<code>jason</code>或在匿名窗口（或其他浏览器）中打开 Bookinfo 应用程序，您 将<code>/productpage</code>看到除了. 因此，您不会看到任何错误消息。<code>reviews:v1 ratings jason</code></p></li></ol><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062327813.png" alt="image-20220316155324788" loading="lazy"></p><h4 id="清理-1" tabindex="-1"><a class="header-anchor" href="#清理-1" aria-hidden="true">#</a> 清理</h4><p>删除应用程序路由规则：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="流量转移" tabindex="-1"><a class="header-anchor" href="#流量转移" aria-hidden="true">#</a> 流量转移</h2><h4 id="什么是流量转移" tabindex="-1"><a class="header-anchor" href="#什么是流量转移" aria-hidden="true">#</a> 什么是流量转移？</h4><p>此任务向您展示如何将流量从一个微服务版本转移到另一个版本。</p><p>一个常见的用例是将流量从旧版本的微服务逐渐迁移到新版本。在 Istio 中，您可以通过配置一系列路由规则来实现这一目标，这些规则将一定比例的流量从一个目的地重定向到另一个目的地。</p><p>在此任务中，您将使用将 50% 的流量发送到<code>reviews:v1</code>和 50% 到<code>reviews:v3</code>。然后，您将通过将 100% 的流量发送到 来完成迁移<code>reviews:v3</code>。</p><h4 id="环境准备-2" tabindex="-1"><a class="header-anchor" href="#环境准备-2" aria-hidden="true">#</a> 环境准备</h4><ul><li>部署<a href="https://istio.io/latest/docs/examples/bookinfo/" target="_blank" rel="noopener noreferrer">Bookinfo<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>示例应用程序，应用目标规则。</li><li>了解了流量管理的基础概念，以及专业语术。</li></ul><blockquote><p>首先，运行此命令将所有流量路由到<code>v1</code>每个微服务的版本。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></blockquote><h4 id="应用基于权重的路由" tabindex="-1"><a class="header-anchor" href="#应用基于权重的路由" aria-hidden="true">#</a> 应用基于权重的路由</h4><ol><li><code>reviews:v1</code>使用<code>reviews:v3</code>以下命令传输 50% 的流量：</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-reviews-50-v3.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="2"><li>确认规则已被替换： <ul><li><code>创建v1版本的权重为50</code></li><li><code>创建v3版本的权重为50</code></li></ul></li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 networking<span class="token punctuation">]</span><span class="token comment"># cat virtual-service-reviews-50-v3.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">50</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v3
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">50</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>在您的浏览器中刷新<code>/productpage</code>，您现在大约有 50% 的时间会看到<code>红色</code>的星级。这是因为<code>v3</code>版本<code>reviews</code>访问了星级服务，而<code>v1</code>版本没有。</li></ol><blockquote><p>注意：</p><p>使用当前的 Envoy sidecar 实现，您可能需要 <code>/productpage</code>多次刷新（可能 15 次或更多）才能看到正确的分布。您可以修改规则以将 90% 的流量路由到<code>v3</code>更频繁地看到红星。</p></blockquote><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062327265.png" alt="image-20220316160723199" loading="lazy"></p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062327027.png" alt="image-20220316160736887" loading="lazy"></p><ol start="4"><li>假设您确定<code>reviews:v3</code>微服务是稳定的，您可以<code>reviews:v3</code>通过应用此虚拟服务将 100% 的流量路由到：</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 networking<span class="token punctuation">]</span><span class="token comment"># cat virtual-service-reviews-v3.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在，当您刷新时，<code>/productpage</code>您总是会看到每条评论带有<code>红色</code>星级的书评。</p><h4 id="清理-2" tabindex="-1"><a class="header-anchor" href="#清理-2" aria-hidden="true">#</a> 清理</h4><p>删除应用程序路由规则：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="tcp-流量转移" tabindex="-1"><a class="header-anchor" href="#tcp-流量转移" aria-hidden="true">#</a> TCP 流量转移</h2><h4 id="什么是tcp流量转移" tabindex="-1"><a class="header-anchor" href="#什么是tcp流量转移" aria-hidden="true">#</a> 什么是TCP流量转移？</h4><p>将 TCP 流量从一个微服务版本转移到另一个版本。</p><p>一个常见的用例是将 TCP 流量从旧版本的微服务逐渐迁移到新版本。在 Istio 中，您可以通过配置一系列路由规则来实现这一目标，这些规则将一定百分比的 TCP 流量从一个目的地重定向到另一个目的地。在此任务中，您将 100% 的 TCP 流量发送到<code>tcp-echo:v1</code>. 然后，您将<code>tcp-echo:v2</code>使用 Istio 的加权路由功能路由 20% 的 TCP 流量。</p><h4 id="基础环境" tabindex="-1"><a class="header-anchor" href="#基础环境" aria-hidden="true">#</a> 基础环境</h4><blockquote><ol><li>首先，创建一个用于测试 TCP 流量转移的命名空间并将其标记为启用自动边车注入。</li><li>部署<a href="https://github.com/istio/istio/tree/release-1.13/samples/sleep" target="_blank" rel="noopener noreferrer">sleep<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>示例应用程序以用作发送请求的测试源。</li><li>部署微服务的<code>v1</code>和<code>v2</code>版本<code>tcp-echo</code>。</li><li>按照 <a href="https://istio.io/latest/docs/tasks/traffic-management/ingress/ingress-control/#determining-the-ingress-ip-and-ports" target="_blank" rel="noopener noreferrer">确定入口 IP 和端口<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><code>TCP_INGRESS_PORT</code>中 的说明定义<code>INGRESS_HOST</code>环境变量。</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl create namespace istio-io-tcp-traffic-shifting
$ kubectl label namespace istio-io-tcp-traffic-shifting istio-injection<span class="token operator">=</span>enabled
$ kubectl apply <span class="token parameter variable">-f</span> samples/sleep/sleep.yaml <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting
$ kubectl apply <span class="token parameter variable">-f</span> samples/tcp-echo/tcp-echo-services.yaml <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h4 id="应用基于权重的tcp路由" tabindex="-1"><a class="header-anchor" href="#应用基于权重的tcp路由" aria-hidden="true">#</a> 应用基于权重的TCP路由</h4><ol><li>将所有 TCP 流量路由到微服务的<code>v1</code>版本<code>tcp-echo</code>。</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 samples<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f samples/tcp-echo/tcp-echo-all-v1.yaml -n istio-io-tcp-traffic-shifting</span>

<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 samples<span class="token punctuation">]</span><span class="token comment"># cat tcp-echo/tcp-echo-all-v1.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo<span class="token punctuation">-</span>gateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">31400</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo<span class="token punctuation">-</span>destination
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v2
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> tcp<span class="token punctuation">-</span>echo<span class="token punctuation">-</span>gateway
  <span class="token key atrule">tcp</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">31400</span>
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo
        <span class="token key atrule">port</span><span class="token punctuation">:</span>				<span class="token comment"># 这里修改成使用端口的方式</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">9000</span>		 <span class="token comment"># 端口号是9000</span>
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1            <span class="token comment"># 版本使用V1版本</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><code>tcp-echo</code>通过从客户端发送一些 TCP 流量来确认服务已启动并正在运行<code>sleep</code>。</li></ol><blockquote><p>下面的 <code>$INGRESS_HOST</code> 变量是 ingress 的外部 IP 地址，<code>$TCP_INGRESS_PORT</code>是ingress的端口</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.spec.ports[?(@.name==&quot;http2&quot;)].nodePort}&#39;</span><span class="token variable">)</span></span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">SECURE_INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.spec.ports[?(@.name==&quot;https&quot;)].nodePort}&#39;</span><span class="token variable">)</span></span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">TCP_INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.spec.ports[?(@.name==&quot;tcp&quot;)].nodePort}&#39;</span><span class="token variable">)</span></span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">INGRESS_HOST</span><span class="token operator">=</span>worker-node-address
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 samples<span class="token punctuation">]</span><span class="token comment"># for i in {1..20}; do \</span>
kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>sleep <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>&quot;</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-c</span> <span class="token function">sleep</span> <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting -- <span class="token function">sh</span> <span class="token parameter variable">-c</span> <span class="token string">&quot;(date; sleep 1) | nc <span class="token variable">$INGRESS_HOST</span> <span class="token variable">$TCP_INGRESS_PORT</span>&quot;</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
<span class="token keyword">done</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:24:57 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:00 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:02 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:05 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:07 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:10 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:12 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:15 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:17 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:19 UTC <span class="token number">2018</span>
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>您应该注意到所有时间戳的前缀都是<em>one</em>，这意味着所有流量都被路由到服务的<code>v1</code>版本<code>tcp-echo</code>。</p><ol start="3"><li><code>tcp-echo:v1</code>使用<code>tcp-echo:v2</code>以下命令传输 20% 的流量：</li></ol><blockquote><p>通过修改<code>weight的值</code>来确定流量的分布控制。</p></blockquote><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 istio<span class="token punctuation">-</span>1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f samples/tcp-echo/tcp-echo-20-v2.yaml</span>

<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 istio<span class="token punctuation">-</span>1.9.5<span class="token punctuation">]</span><span class="token comment"># cat samples/tcp-echo/tcp-echo-20-v2.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> tcp<span class="token punctuation">-</span>echo<span class="token punctuation">-</span>gateway
  <span class="token key atrule">tcp</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">31400</span>
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">9000</span>
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">9000</span>
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">20</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li><p>向微服务发送更多 TCP 流量<code>tcp-echo</code>。</p><p>您现在应该注意到大约 20% 的时间戳具有前缀<em>2</em>，这意味着 80% 的 TCP 流量被路由到服务<code>v1</code>版本<code>tcp-echo</code>，而 20% 被路由到<code>v2</code>.</p></li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-1.9.5<span class="token punctuation">]</span><span class="token comment">#  for i in {1..20}; do \</span>
kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>sleep <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>&quot;</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-c</span> <span class="token function">sleep</span> <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting -- <span class="token function">sh</span> <span class="token parameter variable">-c</span> <span class="token string">&quot;(date; sleep 1) | nc <span class="token variable">$INGRESS_HOST</span> <span class="token variable">$TCP_INGRESS_PORT</span>&quot;</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
<span class="token keyword">done</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:38:45 UTC <span class="token number">2018</span>
two Mon Nov <span class="token number">12</span> <span class="token number">23</span>:38:47 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:38:50 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:38:52 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:38:55 UTC <span class="token number">2018</span>
two Mon Nov <span class="token number">12</span> <span class="token number">23</span>:38:57 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:39:00 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:39:02 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:39:05 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:39:07 UTC <span class="token number">2018</span>
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="清理-3" tabindex="-1"><a class="header-anchor" href="#清理-3" aria-hidden="true">#</a> 清理</h4><p>删除<code>sleep</code>示例、<code>tcp-echo</code>应用程序和路由规则：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete <span class="token parameter variable">-f</span> samples/tcp-echo/tcp-echo-all-v1.yaml <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting
$ kubectl delete <span class="token parameter variable">-f</span> samples/tcp-echo/tcp-echo-services.yaml <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting
$ kubectl delete <span class="token parameter variable">-f</span> samples/sleep/sleep.yaml <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting
$ kubectl delete namespace istio-io-tcp-traffic-shifting
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="请求超时" tabindex="-1"><a class="header-anchor" href="#请求超时" aria-hidden="true">#</a> 请求超时</h2><h4 id="环境准备-3" tabindex="-1"><a class="header-anchor" href="#环境准备-3" aria-hidden="true">#</a> 环境准备</h4><ul><li>部署<a href="https://istio.io/latest/docs/examples/bookinfo/" target="_blank" rel="noopener noreferrer">Bookinfo<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>示例应用程序，应用目标规则。</li><li>了解了流量管理的基础概念，以及专业语术。</li></ul><blockquote><p>首先，运行此命令将所有流量路由到<code>v1</code>每个微服务的版本。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></blockquote><h4 id="请求超时-1" tabindex="-1"><a class="header-anchor" href="#请求超时-1" aria-hidden="true">#</a> 请求超时</h4><p>可以使用<a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/#HTTPRoute" target="_blank" rel="noopener noreferrer">路由规则的<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><em>timeout</em>字段指定 HTTP 请求的超时时间。默认情况下，请求超时被禁用，但在此任务中，您将服务超时覆盖为 1 秒。但是，要查看其效果，您还可以在调用服务时人为地引入 2 秒延迟。</p><ol><li>将请求路由到<code>reviews</code>服务的 v2，即调用<code>ratings</code>服务的版本：</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>对服务的调用添加 2 秒延迟<code>ratings</code>： <ul><li><code>使用http规则配置目的地版本为v1主机是ratings</code></li><li><code>配置百分比为100的2秒固定时间延迟</code></li></ul></li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">fault</span><span class="token punctuation">:</span>
      <span class="token key atrule">delay</span><span class="token punctuation">:</span>
        <span class="token key atrule">percent</span><span class="token punctuation">:</span> <span class="token number">100</span>
        <span class="token key atrule">fixedDelay</span><span class="token punctuation">:</span> 2s
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><code>http://$GATEWAY_URL/productpage</code>在浏览器中打开 Bookinfo URL 。</li></ol><p>您应该会看到 Bookinfo 应用程序正常工作（显示评级星），但是每当您刷新页面时都会有 2 秒的延迟。</p><ol start="4"><li>现在为对服务的调用添加半秒请求超时<code>reviews</code>：</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 0.5s
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li>刷新 Bookinfo 网页。</li></ol><p>您现在应该看到它在大约 1 秒内返回，而不是 2 秒，并且评论不可用。</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062327037.png" alt="image-20220318111010285" loading="lazy"></p><blockquote><p>注意：</p><p>响应需要1秒的原因，即使超时配置为半秒，也是因为服务中有硬编码的重试，所以它在返回之前调用了两次<code>productpage</code>超时服务。<code>reviews</code></p></blockquote><h4 id="清理-4" tabindex="-1"><a class="header-anchor" href="#清理-4" aria-hidden="true">#</a> 清理</h4><p>删除应用程序路由规则：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="熔断-1" tabindex="-1"><a class="header-anchor" href="#熔断-1" aria-hidden="true">#</a> 熔断</h2><h4 id="熔断的方式" tabindex="-1"><a class="header-anchor" href="#熔断的方式" aria-hidden="true">#</a> 熔断的方式</h4><p>此任务向您展示如何为连接、请求和异常值检测配置断路。</p><p>断路是创建弹性微服务应用程序的重要模式。断路允许您编写限制故障、延迟峰值和网络特性的其他不良影响的影响的应用程序。</p><p>在此任务中，您将配置断路器规则，然后通过有意“跳闸”断路器来测试配置。</p><h4 id="环境准备-4" tabindex="-1"><a class="header-anchor" href="#环境准备-4" aria-hidden="true">#</a> 环境准备</h4><p>启动<a href="https://github.com/istio/istio/tree/release-1.13/samples/httpbin" target="_blank" rel="noopener noreferrer">httpbin<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>示例。</p><p>如果您启用了<a href="https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection" target="_blank" rel="noopener noreferrer">自动边车注入<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>，请部署该<code>httpbin</code>服务：</p><p>否则，您必须在部署应用程序之前手动注入 sidecar <code>httpbin</code>：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/httpbin/httpbin.yaml
$ kubectl apply <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject <span class="token parameter variable">-f</span> samples/httpbin/httpbin.yaml<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="配置断路器" tabindex="-1"><a class="header-anchor" href="#配置断路器" aria-hidden="true">#</a> 配置断路器</h4><ol><li>创建<a href="https://istio.io/latest/docs/reference/config/networking/destination-rule/" target="_blank" rel="noopener noreferrer">目标规则<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>以在调用服务时应用断路设置<code>httpbin</code>： <ul><li><code>配置交通政策的连接池和异常检测</code></li><li><code>配置连接池的tcp规则到目标主机的最大HTTP1/TCP连接数为 1</code></li><li><code>配置连接池的http规则对目标的最大挂起HTTP请求数为 1 </code></li><li><code>配置连接池的http规则每个后端连接的最大请求数为 1</code></li><li><code>配置异常检测从连接池中弹出主机之前的5xx错误数为 1</code></li><li><code>配置异常检测弹射扫描分析之间的时间间隔为 1秒</code></li><li><code>配置异常检测最短弹射时间为 3分钟</code></li><li><code>配置异常检测最大弹射百分比为 100</code></li></ul></li></ol><blockquote><p>如果您安装/配置了启用双向 TLS 身份验证的 Istio，则必须在应用之前添加 TLS 流量<code>mode: ISTIO_MUTUAL</code>策略<code>DestinationRule</code>。否则请求将产生 503 错误，如此<a href="https://istio.io/latest/docs/ops/common-problems/network-issues/#503-errors-after-setting-destination-rule" target="_blank" rel="noopener noreferrer">处<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>所述。</p></blockquote><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">connectionPool</span><span class="token punctuation">:</span>
      <span class="token key atrule">tcp</span><span class="token punctuation">:</span>
        <span class="token key atrule">maxConnections</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">http</span><span class="token punctuation">:</span>
        <span class="token key atrule">http1MaxPendingRequests</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token key atrule">maxRequestsPerConnection</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">outlierDetection</span><span class="token punctuation">:</span>
      <span class="token key atrule">consecutive5xxErrors</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 1s
      <span class="token key atrule">baseEjectionTime</span><span class="token punctuation">:</span> 3m
      <span class="token key atrule">maxEjectionPercent</span><span class="token punctuation">:</span> <span class="token number">100</span>
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>验证目标规则是否已正确创建：</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl get destinationrules</span>
NAME                   HOST          AGE
details                details       4h41m
httpbin                httpbin       64m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="添加客户端" tabindex="-1"><a class="header-anchor" href="#添加客户端" aria-hidden="true">#</a> 添加客户端</h4><p>创建客户端以将流量发送到<code>httpbin</code>服务。<a href="https://github.com/istio/fortio" target="_blank" rel="noopener noreferrer">该客户端是一个名为fortio<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>的简单负载测试客户端。Fortio 允许您控制传出 HTTP 调用的连接数、并发性和延迟。您将使用此客户端“跳闸”您在<code>DestinationRule</code>.</p><ol><li>使用 Istio sidecar 代理注入客户端，以便网络交互由 Istio 管理。如果您启用了<a href="https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection" target="_blank" rel="noopener noreferrer">自动边车注入<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>，请部署该<code>fortio</code>服务：</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/httpbin/sample-client/fortio-deploy.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>否则，您必须在部署应用程序之前手动注入 sidecar <code>fortio</code>：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject <span class="token parameter variable">-f</span> samples/httpbin/sample-client/fortio-deploy.yaml<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="2"><li>登录客户端pod，使用fortio工具调用<code>httpbin</code>. 传入<code>curl</code>表示你只想打一个电话：</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">FORTIO_POD</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pods <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>fortio <span class="token parameter variable">-o</span> <span class="token string">&#39;jsonpath={.items[0].metadata.name}&#39;</span><span class="token variable">)</span></span>
$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">$FORTIO_POD</span>&quot;</span> <span class="token parameter variable">-c</span> fortio -- /usr/bin/fortio <span class="token function">curl</span> <span class="token parameter variable">-quiet</span> http://httpbin:8000/get
HTTP/1.1 <span class="token number">200</span> OK
server: envoy
date: Tue, <span class="token number">25</span> Feb <span class="token number">2020</span> <span class="token number">20</span>:25:52 GMT
content-type: application/json
content-length: <span class="token number">586</span>
access-control-allow-origin: *
access-control-allow-credentials: <span class="token boolean">true</span>
x-envoy-upstream-service-time: <span class="token number">36</span>

<span class="token punctuation">{</span>
  <span class="token string">&quot;args&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>,
  <span class="token string">&quot;headers&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;Content-Length&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;0&quot;</span>,
    <span class="token string">&quot;Host&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;httpbin:8000&quot;</span>,
    <span class="token string">&quot;User-Agent&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;fortio.org/fortio-1.3.1&quot;</span>,
    <span class="token string">&quot;X-B3-Parentspanid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;8fc453fb1dec2c22&quot;</span>,
    <span class="token string">&quot;X-B3-Sampled&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1&quot;</span>,
    <span class="token string">&quot;X-B3-Spanid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;071d7f06bc94943c&quot;</span>,
    <span class="token string">&quot;X-B3-Traceid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;86a929a0e76cda378fc453fb1dec2c22&quot;</span>,
    <span class="token string">&quot;X-Forwarded-Client-Cert&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;By=spiffe://cluster.local/ns/default/sa/httpbin;Hash=68bbaedefe01ef4cb99e17358ff63e92d04a4ce831a35ab9a31d3c8e06adb038;Subject=<span class="token entity" title="\&quot;">\&quot;</span><span class="token entity" title="\&quot;">\&quot;</span>;URI=spiffe://cluster.local/ns/default/sa/default&quot;</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;origin&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;127.0.0.1&quot;</span>,
  <span class="token string">&quot;url&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;http://httpbin:8000/get&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="使断路器跳闸" tabindex="-1"><a class="header-anchor" href="#使断路器跳闸" aria-hidden="true">#</a> 使断路器跳闸</h4><p>在<code>DestinationRule</code>设置中，您指定了<code>maxConnections: 1</code>和 <code>http1MaxPendingRequests: 1</code>。这些规则表明，如果您超过一个连接并同时请求，则当 <code>istio-proxy</code>打开更多请求和连接的电路时，您应该会看到一些失败。</p><ol><li>使用两个并发连接 ( <code>-c 2</code>) 调用服务并发送 20 个请求 ( <code>-n 20</code>)：</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl exec &quot;$FORTIO_POD&quot; -c fortio -- /usr/bin/fortio load -c 2 -qps 0 -n 20 -loglevel Warning http://httpbin:8000/get</span>
<span class="token number">15</span>:42:53 I logger.go:12<span class="token operator"><span class="token file-descriptor important">7</span>&gt;</span> Log level is now <span class="token number">3</span> Warning <span class="token punctuation">(</span>was <span class="token number">2</span> Info<span class="token punctuation">)</span>
Fortio <span class="token number">1.17</span>.1 running at <span class="token number">0</span> queries per second, <span class="token number">4</span>-<span class="token operator">&gt;</span><span class="token number">4</span> procs, <span class="token keyword">for</span> <span class="token number">20</span> calls: http://httpbin:8000/get
Starting at max qps with <span class="token number">2</span> thread<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">[</span>gomax <span class="token number">4</span><span class="token punctuation">]</span> <span class="token keyword">for</span> exactly <span class="token number">20</span> calls <span class="token punctuation">(</span><span class="token number">10</span> per thread + <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">15</span>:42:53 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:42:53 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:42:53 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:42:53 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:42:53 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:42:53 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
Ended after <span class="token number">90</span>.508623ms <span class="token builtin class-name">:</span> <span class="token number">20</span> calls. <span class="token assign-left variable">qps</span><span class="token operator">=</span><span class="token number">220.97</span>
Aggregated Function Time <span class="token builtin class-name">:</span> count <span class="token number">20</span> avg <span class="token number">0.0081634006</span> +/- <span class="token number">0.006652</span> min <span class="token number">0.000929244</span> max <span class="token number">0.027135759</span> <span class="token function">sum</span> <span class="token number">0.163268012</span>
<span class="token comment"># range, mid point, percentile, count</span>
<span class="token operator">&gt;=</span> <span class="token number">0.000929244</span> <span class="token operator">&lt;=</span> <span class="token number">0.001</span> , <span class="token number">0.000964622</span> , <span class="token number">5.00</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.001</span> <span class="token operator">&lt;=</span> <span class="token number">0.002</span> , <span class="token number">0.0015</span> , <span class="token number">25.00</span>, <span class="token number">4</span>
<span class="token operator">&gt;</span> <span class="token number">0.002</span> <span class="token operator">&lt;=</span> <span class="token number">0.003</span> , <span class="token number">0.0025</span> , <span class="token number">30.00</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.005</span> <span class="token operator">&lt;=</span> <span class="token number">0.006</span> , <span class="token number">0.0055</span> , <span class="token number">40.00</span>, <span class="token number">2</span>
<span class="token operator">&gt;</span> <span class="token number">0.006</span> <span class="token operator">&lt;=</span> <span class="token number">0.007</span> , <span class="token number">0.0065</span> , <span class="token number">50.00</span>, <span class="token number">2</span>
<span class="token operator">&gt;</span> <span class="token number">0.007</span> <span class="token operator">&lt;=</span> <span class="token number">0.008</span> , <span class="token number">0.0075</span> , <span class="token number">60.00</span>, <span class="token number">2</span>
<span class="token operator">&gt;</span> <span class="token number">0.008</span> <span class="token operator">&lt;=</span> <span class="token number">0.009</span> , <span class="token number">0.0085</span> , <span class="token number">65.00</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.009</span> <span class="token operator">&lt;=</span> <span class="token number">0.01</span> , <span class="token number">0.0095</span> , <span class="token number">80.00</span>, <span class="token number">3</span>
<span class="token operator">&gt;</span> <span class="token number">0.014</span> <span class="token operator">&lt;=</span> <span class="token number">0.016</span> , <span class="token number">0.015</span> , <span class="token number">85.00</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.018</span> <span class="token operator">&lt;=</span> <span class="token number">0.02</span> , <span class="token number">0.019</span> , <span class="token number">95.00</span>, <span class="token number">2</span>
<span class="token operator">&gt;</span> <span class="token number">0.025</span> <span class="token operator">&lt;=</span> <span class="token number">0.0271358</span> , <span class="token number">0.0260679</span> , <span class="token number">100.00</span>, <span class="token number">1</span>
<span class="token comment"># target 50% 0.007</span>
<span class="token comment"># target 75% 0.00966667</span>
<span class="token comment"># target 90% 0.019</span>
<span class="token comment"># target 99% 0.0267086</span>
<span class="token comment"># target 99.9% 0.027093</span>
Sockets used: <span class="token number">8</span> <span class="token punctuation">(</span>for perfect keepalive, would be <span class="token number">2</span><span class="token punctuation">)</span>
Jitter: <span class="token boolean">false</span>
Code <span class="token number">200</span> <span class="token builtin class-name">:</span> <span class="token number">14</span> <span class="token punctuation">(</span><span class="token number">70.0</span> %<span class="token punctuation">)</span>
Code <span class="token number">503</span> <span class="token builtin class-name">:</span> <span class="token number">6</span> <span class="token punctuation">(</span><span class="token number">30.0</span> %<span class="token punctuation">)</span>
Response Header Sizes <span class="token builtin class-name">:</span> count <span class="token number">20</span> avg <span class="token number">161.15</span> +/- <span class="token number">105.5</span> min <span class="token number">0</span> max <span class="token number">231</span> <span class="token function">sum</span> <span class="token number">3223</span>
Response Body/Total Sizes <span class="token builtin class-name">:</span> count <span class="token number">20</span> avg <span class="token number">649.25</span> +/- <span class="token number">267.3</span> min <span class="token number">241</span> max <span class="token number">825</span> <span class="token function">sum</span> <span class="token number">12985</span>
All <span class="token keyword">done</span> <span class="token number">20</span> calls <span class="token punctuation">(</span>plus <span class="token number">0</span> warmup<span class="token punctuation">)</span> <span class="token number">8.163</span> ms avg, <span class="token number">221.0</span> qps
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>有趣的是，几乎所有请求都通过了！<code>istio-proxy</code> 确实留有余地。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>Code 200 : 14 (70.0 %)
Code 503 : 6 (30.0 %)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>将并发连接数增加到 3：</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl exec &quot;$FORTIO_POD&quot; -c fortio -- /usr/bin/fortio load -c 3 -qps 0 -n 20 -loglevel Warning http://httpbin:8000/get</span>
<span class="token number">15</span>:44:49 I logger.go:12<span class="token operator"><span class="token file-descriptor important">7</span>&gt;</span> Log level is now <span class="token number">3</span> Warning <span class="token punctuation">(</span>was <span class="token number">2</span> Info<span class="token punctuation">)</span>
Fortio <span class="token number">1.17</span>.1 running at <span class="token number">0</span> queries per second, <span class="token number">4</span>-<span class="token operator">&gt;</span><span class="token number">4</span> procs, <span class="token keyword">for</span> <span class="token number">20</span> calls: http://httpbin:8000/get
Starting at max qps with <span class="token number">3</span> thread<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">[</span>gomax <span class="token number">4</span><span class="token punctuation">]</span> <span class="token keyword">for</span> exactly <span class="token number">20</span> calls <span class="token punctuation">(</span><span class="token number">6</span> per thread + <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
Ended after <span class="token number">32</span>.522699ms <span class="token builtin class-name">:</span> <span class="token number">20</span> calls. <span class="token assign-left variable">qps</span><span class="token operator">=</span><span class="token number">614.96</span>
Aggregated Function Time <span class="token builtin class-name">:</span> count <span class="token number">20</span> avg <span class="token number">0.0029114787</span> +/- <span class="token number">0.003681</span> min <span class="token number">0.000447652</span> max <span class="token number">0.016532305</span> <span class="token function">sum</span> <span class="token number">0.058229575</span>
<span class="token comment"># range, mid point, percentile, count</span>
<span class="token operator">&gt;=</span> <span class="token number">0.000447652</span> <span class="token operator">&lt;=</span> <span class="token number">0.001</span> , <span class="token number">0.000723826</span> , <span class="token number">30.00</span>, <span class="token number">6</span>
<span class="token operator">&gt;</span> <span class="token number">0.001</span> <span class="token operator">&lt;=</span> <span class="token number">0.002</span> , <span class="token number">0.0015</span> , <span class="token number">60.00</span>, <span class="token number">6</span>
<span class="token operator">&gt;</span> <span class="token number">0.002</span> <span class="token operator">&lt;=</span> <span class="token number">0.003</span> , <span class="token number">0.0025</span> , <span class="token number">70.00</span>, <span class="token number">2</span>
<span class="token operator">&gt;</span> <span class="token number">0.004</span> <span class="token operator">&lt;=</span> <span class="token number">0.005</span> , <span class="token number">0.0045</span> , <span class="token number">90.00</span>, <span class="token number">4</span>
<span class="token operator">&gt;</span> <span class="token number">0.008</span> <span class="token operator">&lt;=</span> <span class="token number">0.009</span> , <span class="token number">0.0085</span> , <span class="token number">95.00</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.016</span> <span class="token operator">&lt;=</span> <span class="token number">0.0165323</span> , <span class="token number">0.0162662</span> , <span class="token number">100.00</span>, <span class="token number">1</span>
<span class="token comment"># target 50% 0.00166667</span>
<span class="token comment"># target 75% 0.00425</span>
<span class="token comment"># target 90% 0.005</span>
<span class="token comment"># target 99% 0.0164258</span>
<span class="token comment"># target 99.9% 0.0165217</span>
Sockets used: <span class="token number">16</span> <span class="token punctuation">(</span>for perfect keepalive, would be <span class="token number">3</span><span class="token punctuation">)</span>
Jitter: <span class="token boolean">false</span>
Code <span class="token number">200</span> <span class="token builtin class-name">:</span> <span class="token number">5</span> <span class="token punctuation">(</span><span class="token number">25.0</span> %<span class="token punctuation">)</span>
Code <span class="token number">503</span> <span class="token builtin class-name">:</span> <span class="token number">15</span> <span class="token punctuation">(</span><span class="token number">75.0</span> %<span class="token punctuation">)</span>
Response Header Sizes <span class="token builtin class-name">:</span> count <span class="token number">20</span> avg <span class="token number">57.55</span> +/- <span class="token number">99.68</span> min <span class="token number">0</span> max <span class="token number">231</span> <span class="token function">sum</span> <span class="token number">1151</span>
Response Body/Total Sizes <span class="token builtin class-name">:</span> count <span class="token number">20</span> avg <span class="token number">386.8</span> +/- <span class="token number">252.5</span> min <span class="token number">241</span> max <span class="token number">825</span> <span class="token function">sum</span> <span class="token number">7736</span>
All <span class="token keyword">done</span> <span class="token number">20</span> calls <span class="token punctuation">(</span>plus <span class="token number">0</span> warmup<span class="token punctuation">)</span> <span class="token number">2.911</span> ms avg, <span class="token number">615.0</span> qps
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在您开始看到预期的断路行为。只有 36.7% 的请求成功，其余的则被熔断机制困住：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>Code 200 : 5 (25.0 %)
Code 503 : 15 (75.0 %)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><p>查询<code>istio-proxy</code>统计信息以查看更多信息：</p><p>您可以查看<code>21</code>该<code>upstream_rq_pending_overflow</code>值，这意味着<code>21</code> 到目前为止的调用已被标记为断路。</p></li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl exec &quot;$FORTIO_POD&quot; -c istio-proxy -- pilot-agent request GET stats | grep httpbin | grep pending</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.circuit_breakers.default.remaining_pending: <span class="token number">1</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.circuit_breakers.default.rq_pending_open: <span class="token number">0</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.circuit_breakers.high.rq_pending_open: <span class="token number">0</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.upstream_rq_pending_active: <span class="token number">0</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.upstream_rq_pending_failure_eject: <span class="token number">0</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.upstream_rq_pending_overflow: <span class="token number">40</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.upstream_rq_pending_total: <span class="token number">41</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="清理-5" tabindex="-1"><a class="header-anchor" href="#清理-5" aria-hidden="true">#</a> 清理</h4><p>删除规则：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete destinationrule httpbin
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>关闭<a href="https://github.com/istio/istio/tree/release-1.13/samples/httpbin" target="_blank" rel="noopener noreferrer">httpbin<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>服务和客户端：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete deploy httpbin fortio-deploy
$ kubectl delete svc httpbin fortio
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="镜像" tabindex="-1"><a class="header-anchor" href="#镜像" aria-hidden="true">#</a> 镜像</h2><h4 id="流量镜像" tabindex="-1"><a class="header-anchor" href="#流量镜像" aria-hidden="true">#</a> 流量镜像</h4><p>此任务演示了 Istio 的流量镜像功能。</p><p>流量镜像，也称为阴影，是一个强大的概念，它允许功能团队以尽可能小的风险将更改带入生产环境。镜像将实时流量的副本发送到镜像服务。镜像流量发生在主服务的关键请求路径的带外。</p><p>在此任务中，您将首先强制所有流量流向<code>v1</code>测试服务。然后，您将应用规则将一部分流量镜像到<code>v2</code>.</p><h4 id="基础环境-1" tabindex="-1"><a class="header-anchor" href="#基础环境-1" aria-hidden="true">#</a> 基础环境</h4><p>首先部署两个启用了访问日志记录的<a href="https://github.com/istio/istio/tree/release-1.13/samples/httpbin" target="_blank" rel="noopener noreferrer">httpbin服务版本：<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><strong>httpbin-v1：</strong></p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ cat &lt;&lt;EOF <span class="token punctuation">|</span> istioctl kube<span class="token punctuation">-</span>inject <span class="token punctuation">-</span>f <span class="token punctuation">-</span> <span class="token punctuation">|</span> kubectl create <span class="token punctuation">-</span>f <span class="token punctuation">-</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin<span class="token punctuation">-</span>v1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> httpbin
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> httpbin
        <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> docker.io/kennethreitz/httpbin
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;gunicorn&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--access-logfile&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0.0.0.0:80&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;httpbin:app&quot;</span><span class="token punctuation">]</span>
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>httpbin-v2：</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> istioctl kube-inject <span class="token parameter variable">-f</span> - <span class="token operator">|</span> kubectl create <span class="token parameter variable">-f</span> -</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  name: httpbin-v2
spec:
  replicas: 1
  selector:
    matchLabels:
      app: httpbin
      version: v2
  template:
    metadata:
      labels:
        app: httpbin
        version: v2
    spec:
      containers:
      - image: docker.io/kennethreitz/httpbin
        imagePullPolicy: IfNotPresent
        name: httpbin
        command: [&quot;gunicorn&quot;, &quot;--access-logfile&quot;, &quot;-&quot;, &quot;-b&quot;, &quot;0.0.0.0:80&quot;, &quot;httpbin:app&quot;]
        ports:
        - containerPort: 80
EOF</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>httpbin Kubernetes 服务：</strong></p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl create <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8000</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> httpbin
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动<code>sleep</code>服务，以便您可以使用它<code>curl</code>来提供负载：</p><p><strong>睡眠服务：</strong></p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ cat &lt;&lt;EOF <span class="token punctuation">|</span> istioctl kube<span class="token punctuation">-</span>inject <span class="token punctuation">-</span>f <span class="token punctuation">-</span> <span class="token punctuation">|</span> kubectl create <span class="token punctuation">-</span>f <span class="token punctuation">-</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> sleep
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> sleep
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> sleep
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> sleep
        <span class="token key atrule">image</span><span class="token punctuation">:</span> curlimages/curl
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/sleep&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;3650d&quot;</span><span class="token punctuation">]</span>
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="创建默认路由策略" tabindex="-1"><a class="header-anchor" href="#创建默认路由策略" aria-hidden="true">#</a> 创建默认路由策略</h4><p>默认情况下，Kubernetes 会在<code>httpbin</code>服务的两个版本之间进行负载平衡。在此步骤中，您将更改该行为，以便所有流量都转到<code>v1</code>.</p><ol><li>创建默认路由规则以将所有流量路由到<code>v1</code>服务，现在所有流量都流向<code>httpbin:v1</code>服务。：</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> httpbin
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v2
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>向服务发送一些流量：</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">SLEEP_POD</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>sleep <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>
$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">${SLEEP_POD}</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sS</span> http://httpbin:8000/headers
<span class="token punctuation">{</span>
  <span class="token string">&quot;headers&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;Accept&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;*/*&quot;</span>,
    <span class="token string">&quot;Content-Length&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;0&quot;</span>,
    <span class="token string">&quot;Host&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;httpbin:8000&quot;</span>,
    <span class="token string">&quot;User-Agent&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;curl/7.35.0&quot;</span>,
    <span class="token string">&quot;X-B3-Parentspanid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;57784f8bff90ae0b&quot;</span>,
    <span class="token string">&quot;X-B3-Sampled&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1&quot;</span>,
    <span class="token string">&quot;X-B3-Spanid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;3289ae7257c3f159&quot;</span>,
    <span class="token string">&quot;X-B3-Traceid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;b56eebd279a76f0b57784f8bff90ae0b&quot;</span>,
    <span class="token string">&quot;X-Envoy-Attempt-Count&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1&quot;</span>,
    <span class="token string">&quot;X-Forwarded-Client-Cert&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;By=spiffe://cluster.local/ns/default/sa/default;Hash=20afebed6da091c850264cc751b8c9306abac02993f80bdb76282237422bd098;Subject=<span class="token entity" title="\&quot;">\&quot;</span><span class="token entity" title="\&quot;">\&quot;</span>;URI=spiffe://cluster.local/ns/default/sa/default&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>检查pod<code>v1</code>的日志<code>v2</code>。<code>httpbin</code>您应该看到以下的访问日志条目，<code>v1</code>并且没有<code>v2</code>：</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">V1_POD</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>httpbin,version<span class="token operator">=</span>v1 <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>
$ kubectl logs <span class="token string">&quot;<span class="token variable">$V1_POD</span>&quot;</span> <span class="token parameter variable">-c</span> httpbin
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Starting gunicorn <span class="token number">19.9</span>.0
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Listening at: http://0.0.0.0:80 <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Using worker: <span class="token function">sync</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Booting worker with pid: <span class="token number">9</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:30:43 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">529</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>


$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">V2_POD</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>httpbin,version<span class="token operator">=</span>v2 <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>
$ kubectl logs <span class="token string">&quot;<span class="token variable">$V2_POD</span>&quot;</span> <span class="token parameter variable">-c</span> httpbin
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Starting gunicorn <span class="token number">19.9</span>.0
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Listening at: http://0.0.0.0:80 <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Using worker: <span class="token function">sync</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Booting worker with pid: <span class="token number">10</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="将流量镜像到v2" tabindex="-1"><a class="header-anchor" href="#将流量镜像到v2" aria-hidden="true">#</a> 将流量镜像到v2</h4><p><strong>更改路由规则以将流量镜像到 v2：</strong></p><p>此路由规则将 100% 的流量发送到<code>v1</code>. 最后一节指定您希望将 100% 的相同流量镜像（即，也发送）到 <code>httpbin:v2</code>服务。</p><p>当流量被镜像时，请求被发送到镜像服务，其 Host/Authority 标头附加<code>-shadow</code>. 例如，<code>cluster-1</code>变成<code>cluster-1-shadow</code>。</p><p>此外，重要的是要注意这些请求被镜像为“即发即弃”，这意味着响应被丢弃。您可以使用该<code>value</code>字段下的<code>mirrorPercentage</code>字段来镜像一部分流量，而不是镜像所有请求。如果没有这个字段，所有的流量都会被镜像。</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> httpbin
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>
    <span class="token key atrule">mirror</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
      <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">mirrorPercentage</span><span class="token punctuation">:</span>
      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">100.0</span>
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="发送流量" tabindex="-1"><a class="header-anchor" href="#发送流量" aria-hidden="true">#</a> 发送流量</h4><p>通过发送流量再次进行测试，情况如下：</p><ul><li><code>v1</code>现在，您应该会看到和的访问记录</li><li><code>v2</code>中创建的访问日志<code>v2</code>是实际将要访问的镜像请求<code>v1</code>。</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-work<span class="token punctuation">]</span><span class="token comment"># kubectl exec &quot;${SLEEP_POD}&quot; -c sleep -- curl -sS http://httpbin:8000/headers</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;headers&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;Accept&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;*/*&quot;</span>,
    <span class="token string">&quot;Host&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;httpbin:8000&quot;</span>,
    <span class="token string">&quot;User-Agent&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>,
    <span class="token string">&quot;X-B3-Parentspanid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;a422ba4aefe02440&quot;</span>,
    <span class="token string">&quot;X-B3-Sampled&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1&quot;</span>,
    <span class="token string">&quot;X-B3-Spanid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;acd7163f70c9aa89&quot;</span>,
    <span class="token string">&quot;X-B3-Traceid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;f7ca9fb1e0581d6ba422ba4aefe02440&quot;</span>,
    <span class="token string">&quot;X-Envoy-Attempt-Count&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1&quot;</span>,
    <span class="token string">&quot;X-Forwarded-Client-Cert&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;By=spiffe://cluster.local/ns/default/sa/default;Hash=ab53dec650eb79f2aa9dc051ed27a2b4b698ee40ffd557cd885495105916a139;Subject=<span class="token entity" title="\&quot;">\&quot;</span><span class="token entity" title="\&quot;">\&quot;</span>;URI=spiffe://cluster.local/ns/default/sa/default&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">[</span>root@k8s-master-node1 istio-work<span class="token punctuation">]</span><span class="token comment"># kubectl logs &quot;$V1_POD&quot; -c httpbin</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Starting gunicorn <span class="token number">19.9</span>.0
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Listening at: http://0.0.0.0:80 <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Using worker: <span class="token function">sync</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Booting worker with pid: <span class="token number">9</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:30:43 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">529</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:33:03 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">529</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:33:48 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">529</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:33:52 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">529</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:34:05 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">529</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>


<span class="token punctuation">[</span>root@k8s-master-node1 istio-work<span class="token punctuation">]</span><span class="token comment"># kubectl logs &quot;$V2_POD&quot; -c httpbin</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Starting gunicorn <span class="token number">19.9</span>.0
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Listening at: http://0.0.0.0:80 <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Using worker: <span class="token function">sync</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Booting worker with pid: <span class="token number">10</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:33:03 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">569</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:33:48 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">569</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:33:52 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">569</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:34:05 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">569</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="清理-6" tabindex="-1"><a class="header-anchor" href="#清理-6" aria-hidden="true">#</a> 清理</h4><p>删除规则：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete virtualservice httpbin
$ kubectl delete destinationrule httpbin
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>关闭<a href="https://github.com/istio/istio/tree/release-1.13/samples/httpbin" target="_blank" rel="noopener noreferrer">httpbin<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>服务和客户端：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete deploy httpbin-v1 httpbin-v2 <span class="token function">sleep</span>
$ kubectl delete svc httpbin
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="入口网关" tabindex="-1"><a class="header-anchor" href="#入口网关" aria-hidden="true">#</a> 入口网关</h2><h4 id="入口网关简要" tabindex="-1"><a class="header-anchor" href="#入口网关简要" aria-hidden="true">#</a> 入口网关简要</h4><p>除了支持 Kubernetes <a href="https://istio.io/latest/docs/tasks/traffic-management/ingress/kubernetes-ingress/" target="_blank" rel="noopener noreferrer">Ingress<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>，Istio 还提供了另一种配置模型，<a href="https://istio.io/latest/docs/reference/config/networking/gateway/" target="_blank" rel="noopener noreferrer">即 Istio Gateway<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。A<code>Gateway</code>提供了比 更广泛的自定义和灵活性<code>Ingress</code>，并允许将监控和路由规则等 Istio 功能应用于进入集群的流量。</p><p>此任务描述了如何配置 Istio 以使用 Istio 在服务网格之外公开服务<code>Gateway</code>。</p><h4 id="环境准备-5" tabindex="-1"><a class="header-anchor" href="#环境准备-5" aria-hidden="true">#</a> 环境准备</h4><ul><li>确保您的当前目录是该<code>istio</code>目录。</li><li>启动<a href="https://github.com/istio/istio/tree/release-1.13/samples/httpbin" target="_blank" rel="noopener noreferrer">httpbin<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>示例。</li></ul><p>​ 如果您启用了<a href="https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection" target="_blank" rel="noopener noreferrer">自动边车注入<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>，请部署该<code>httpbin</code>服务：</p><p>​ 否则，您必须在部署应用程序之前手动注入 sidecar <code>httpbin</code>：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/httpbin/httpbin.yaml
$ kubectl apply <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject <span class="token parameter variable">-f</span> samples/httpbin/httpbin.yaml<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="确定入口ip和端口" tabindex="-1"><a class="header-anchor" href="#确定入口ip和端口" aria-hidden="true">#</a> 确定入口IP和端口</h4><p>执行以下命令来确定您的 Kubernetes 集群是否在支持外部负载均衡器的环境中运行（<code>这里没有负载均衡器改为NodePort模式</code>）：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -n istio-system istio-ingressgateway</span>
NAME                   TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>                                                                    AGE
istio-ingressgateway   NodePort   <span class="token number">10.96</span>.88.217   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">15021</span>:28214/TCP,80:27007/TCP,443:9673/TCP,31400:3938/TCP,15443:41053/TCP   4d2h
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果<code>EXTERNAL-IP</code>设置了该值，则您的环境具有可用于入口网关的外部负载均衡器。如果<code>EXTERNAL-IP</code>值为<code>&lt;none&gt;</code>或永久<code>&lt;pending&gt;</code>，则您的环境不为入口网关提供外部负载均衡器。<a href="https://kubernetes.io/docs/concepts/services-networking/service/#nodeport" target="_blank" rel="noopener noreferrer">在这种情况下，您可以使用服务的节点端口<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>访问网关。</p><h4 id="添加环境说明" tabindex="-1"><a class="header-anchor" href="#添加环境说明" aria-hidden="true">#</a> 添加环境说明</h4><p>如果您确定您的环境没有外部负载均衡器，请按照这些说明进行操作，因此您需要改用节点端口。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.spec.ports[?(@.name==&quot;http2&quot;)].nodePort}&#39;</span><span class="token variable">)</span></span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">SECURE_INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.spec.ports[?(@.name==&quot;https&quot;)].nodePort}&#39;</span><span class="token variable">)</span></span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">TCP_INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.spec.ports[?(@.name==&quot;tcp&quot;)].nodePort}&#39;</span><span class="token variable">)</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062328622.png" alt="image-20220318172145022" loading="lazy"></p><h4 id="使用istio网关配置入口" tabindex="-1"><a class="header-anchor" href="#使用istio网关配置入口" aria-hidden="true">#</a> 使用Istio网关配置入口</h4><p>入口<a href="https://istio.io/latest/docs/reference/config/networking/gateway/" target="_blank" rel="noopener noreferrer">网关<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>描述了在网格边缘运行的负载均衡器，用于接收传入的 HTTP/TCP 连接。它配置暴露的端口、协议等，但与<a href="https://kubernetes.io/docs/concepts/services-networking/ingress/" target="_blank" rel="noopener noreferrer">Kubernetes Ingress Resources<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>不同，它不包括任何流量路由配置。入口流量的流量路由是使用 Istio 路由规则配置的，与内部服务请求的方式完全相同。</p><p>让我们看看如何<code>Gateway</code>为 HTTP 流量配置端口 80。</p><ol><li>创建一个 Istio <code>Gateway</code>： <ul><li><code>使用默认的ingressgateway网关</code></li><li><code>创建一个服务器规范列表，分别是主机和端口</code></li><li><code>配置http服务的80端口以及主机httpbin.example.com</code></li></ul></li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin<span class="token punctuation">-</span>gateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway <span class="token comment"># use Istio default gateway implementation</span>
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;httpbin.example.com&quot;</span>
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>为通过以下方式进入的流量配置路由<code>Gateway</code>： <ul><li><code>配置虚拟服务允许主机httpbin.example.com</code></li><li><code>配追http的规则为两个uri的两个允许路径、分别是status和delay</code></li><li><code>配置目的地规则为主机是httpbin端口为8080的</code></li><li><code>网关列表指定只允许通过您的请求httpbin-gateway。所有其他外部请求都将被 404 响应拒绝。</code></li></ul></li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;httpbin.example.com&quot;</span>
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> httpbin<span class="token punctuation">-</span>gateway
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /status
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /delay
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">8000</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>注意：</p><p>网格中其他服务的内部请求不受这些规则的约束，而是默认使用循环路由。要将这些规则也应用于内部调用，您可以将特殊值添加<code>mesh</code>到<code>gateways</code>. 由于服务的内部主机名可能与外部主机名不同（例如，<code>httpbin.default.svc.cluster.local</code>），因此您还需要将其添加到<code>hosts</code>列表中。</p></blockquote><ol start="3"><li><em>使用curl</em>访问<em>httpbin</em>服务：</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 ~<span class="token punctuation">]</span><span class="token comment"># curl -s -I -HHost:httpbin.example.com &quot;http://$INGRESS_HOST:$INGRESS_PORT/status/200&quot;</span>
HTTP/1.1 <span class="token number">200</span> OK
server: istio-envoy
date: Sun, <span class="token number">20</span> Mar <span class="token number">2022</span> <span class="token number">14</span>:05:09 GMT
content-type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
access-control-allow-origin: *
access-control-allow-credentials: <span class="token boolean">true</span>
content-length: <span class="token number">0</span>
x-envoy-upstream-service-time: <span class="token number">24</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>请注意，您使用该<code>-H</code>标志将<em>Host</em> HTTP 标头设置为“<a href="http://httpbin.example.com" target="_blank" rel="noopener noreferrer">httpbin.example.com<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>”。这是必需的，因为您的入口<code>Gateway</code>配置为处理“<a href="http://httpbin.example.com" target="_blank" rel="noopener noreferrer">httpbin.example.com<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>”，但在您的测试环境中，您没有该主机的 DNS 绑定，只是将您的请求发送到入口 IP。</p><ol start="4"><li>访问尚未明确公开的任何其他 URL。您应该会看到 HTTP 404 错误：</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 ~<span class="token punctuation">]</span><span class="token comment"># curl -s -I -HHost:httpbin.example.com &quot;http://$INGRESS_HOST:$INGRESS_PORT/headers&quot;</span>
HTTP/1.1 <span class="token number">404</span> Not Found
date: Sun, <span class="token number">20</span> Mar <span class="token number">2022</span> <span class="token number">14</span>:29:26 GMT
server: istio-envoy
transfer-encoding: chunked
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="使用浏览器访问入口服务" tabindex="-1"><a class="header-anchor" href="#使用浏览器访问入口服务" aria-hidden="true">#</a> 使用浏览器访问入口服务</h4><p>在浏览器中输入<code>httpbin</code>服务 URL 将不起作用，因为您无法将<em>Host</em>标头传递给浏览器，就像使用<code>curl</code>. 在现实世界的情况下，这不是问题，因为您正确配置了请求的主机并且 DNS 可解析。因此，您在 URL 中使用主机的域名，例如<code>https://httpbin.example.com/status/200</code>.</p><p>要为简单的测试和演示解决此问题，请在 和配置<code>*</code>中为主机使用通配符值。例如，如果您将入口配置更改为以下内容：<code>Gateway VirtualService</code></p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin<span class="token punctuation">-</span>gateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway <span class="token comment"># use Istio default gateway implementation</span>
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> httpbin<span class="token punctuation">-</span>gateway
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /headers
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">8000</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在本机的hosts<code>配置192.168.1.6:44526/headers httpbin.example.com</code>映射，然后通过浏览器访问。</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062328976.png" alt="image-20220320230630481" loading="lazy"></p><h4 id="清理-7" tabindex="-1"><a class="header-anchor" href="#清理-7" aria-hidden="true">#</a> 清理</h4><p>删除<code>Gateway</code>and<code>VirtualService</code>配置，关闭<a href="https://github.com/istio/istio/tree/release-1.13/samples/httpbin" target="_blank" rel="noopener noreferrer">httpbin<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>服务：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete gateway httpbin-gateway
$ kubectl delete virtualservice httpbin
$ kubectl delete --ignore-not-found<span class="token operator">=</span>true <span class="token parameter variable">-f</span> samples/httpbin/httpbin.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="安全网关" tabindex="-1"><a class="header-anchor" href="#安全网关" aria-hidden="true">#</a> 安全网关</h2><h4 id="安全网关的作用" tabindex="-1"><a class="header-anchor" href="#安全网关的作用" aria-hidden="true">#</a> 安全网关的作用</h4><p>控制入口<a href="https://istio.io/latest/docs/tasks/traffic-management/ingress/ingress-control" target="_blank" rel="noopener noreferrer">流量任务<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 描述了如何配置入口网关以将 HTTP 服务公开给外部流量。此任务显示如何使用简单或双向 TLS 公开安全的 HTTPS 服务。</p><h4 id="环境准备-6" tabindex="-1"><a class="header-anchor" href="#环境准备-6" aria-hidden="true">#</a> 环境准备</h4><ul><li>确保您的当前目录是该<code>istio</code>目录。</li><li>启动<a href="https://github.com/istio/istio/tree/release-1.13/samples/httpbin" target="_blank" rel="noopener noreferrer">httpbin<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>示例。</li></ul><p>​ 如果您启用了<a href="https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection" target="_blank" rel="noopener noreferrer">自动边车注入<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>，请部署该<code>httpbin</code>服务：</p><p>​ 否则，您必须在部署应用程序之前手动注入 sidecar <code>httpbin</code>：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/httpbin/httpbin.yaml
$ kubectl apply <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject <span class="token parameter variable">-f</span> samples/httpbin/httpbin.yaml<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="生成证书和密钥" tabindex="-1"><a class="header-anchor" href="#生成证书和密钥" aria-hidden="true">#</a> 生成证书和密钥</h4><p>对于此任务，您可以使用您喜欢的工具来生成证书和密钥。下面的命令使用 <a href="https://man.openbsd.org/openssl.1" target="_blank" rel="noopener noreferrer">openssl<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><ol><li>创建根证书和私钥来为您的服务签署证书：</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ openssl req <span class="token parameter variable">-x509</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-days</span> <span class="token number">365</span> <span class="token parameter variable">-newkey</span> rsa:2048 <span class="token parameter variable">-subj</span> <span class="token string">&#39;/O=example Inc./CN=example.com&#39;</span> <span class="token parameter variable">-keyout</span> example.com.key <span class="token parameter variable">-out</span> example.com.crt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="2"><li>创建证书和私钥<code>httpbin.example.com</code>：</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ openssl req <span class="token parameter variable">-out</span> httpbin.example.com.csr <span class="token parameter variable">-newkey</span> rsa:2048 <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-keyout</span> httpbin.example.com.key <span class="token parameter variable">-subj</span> <span class="token string">&quot;/CN=httpbin.example.com/O=httpbin organization&quot;</span>
$ openssl x509 <span class="token parameter variable">-req</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-days</span> <span class="token number">365</span> <span class="token parameter variable">-CA</span> example.com.crt <span class="token parameter variable">-CAkey</span> example.com.key <span class="token parameter variable">-set_serial</span> <span class="token number">0</span> <span class="token parameter variable">-in</span> httpbin.example.com.csr <span class="token parameter variable">-out</span> httpbin.example.com.crt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="为单个主机配置tls入口网关" tabindex="-1"><a class="header-anchor" href="#为单个主机配置tls入口网关" aria-hidden="true">#</a> 为单个主机配置TLS入口网关</h4><ol><li>为入口网关创建一个密钥：</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl create <span class="token parameter variable">-n</span> istio-system secret tls httpbin-credential <span class="token parameter variable">--key</span><span class="token operator">=</span>httpbin.example.com.key <span class="token parameter variable">--cert</span><span class="token operator">=</span>httpbin.example.com.crt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="2"><li>使用端口 443的部分定义网关<code>servers:</code>，并指定 <code>credentialName</code>to be的值<code>httpbin-credential</code>。这些值与密钥的名称相同。TLS 模式的值应为<code>SIMPLE</code>.</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ cat &lt;&lt;EOF <span class="token punctuation">|</span> kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mygateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway <span class="token comment"># use istio default ingress gateway</span>
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> https
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE
      <span class="token key atrule">credentialName</span><span class="token punctuation">:</span> httpbin<span class="token punctuation">-</span>credential <span class="token comment"># must be the same as secret</span>
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> httpbin.example.com
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>配置网关的入口流量路由。定义相应的虚拟服务。</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ cat &lt;&lt;EOF <span class="token punctuation">|</span> kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;httpbin.example.com&quot;</span>
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> mygateway
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /status
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /delay
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">8000</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>发送 HTTPS 请求以<code>httpbin</code>通过 HTTPS 访问服务，该<code>httpbin</code>服务将返回 <a href="https://tools.ietf.org/html/rfc7168#section-2.3.3" target="_blank" rel="noopener noreferrer">418 I&#39;m a Teapot<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>代码。</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-HHost:httpbin.example.com</span> <span class="token parameter variable">--resolve</span> <span class="token string">&quot;httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>:<span class="token variable">$INGRESS_HOST</span>&quot;</span> <span class="token parameter variable">--cacert</span> example.com.crt <span class="token string">&quot;https://httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>/status/418&quot;</span>
* Added httpbin.example.com:7339:192.168.1.6 to DNS cache
* About to connect<span class="token punctuation">(</span><span class="token punctuation">)</span> to httpbin.example.com port <span class="token number">7339</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
*   Trying <span class="token number">192.168</span>.1.6<span class="token punctuation">..</span>.
* Connected to httpbin.example.com <span class="token punctuation">(</span><span class="token number">192.168</span>.1.6<span class="token punctuation">)</span> port <span class="token number">7339</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
* Initializing NSS with certpath: sql:/etc/pki/nssdb
*   CAfile: example.com.crt
  CApath: none
* SSL connection using TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
* Server certificate:
*       subject: <span class="token assign-left variable">O</span><span class="token operator">=</span>httpbin organization,CN<span class="token operator">=</span>httpbin.example.com
*       start date: Mar <span class="token number">20</span> <span class="token number">15</span>:18:42 <span class="token number">2022</span> GMT
*       expire date: Mar <span class="token number">20</span> <span class="token number">15</span>:18:42 <span class="token number">2023</span> GMT
*       common name: httpbin.example.com
*       issuer: <span class="token assign-left variable">CN</span><span class="token operator">=</span>example.com,O<span class="token operator">=</span>example Inc.
<span class="token operator">&gt;</span> GET /status/418 HTTP/1.1
<span class="token operator">&gt;</span> User-Agent: curl/7.29.0
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span> Host:httpbin.example.com
<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">418</span> Unknown
<span class="token operator">&lt;</span> server: istio-envoy
<span class="token operator">&lt;</span> date: Sun, <span class="token number">20</span> Mar <span class="token number">2022</span> <span class="token number">15</span>:41:25 GMT
<span class="token operator">&lt;</span> x-more-info: http://tools.ietf.org/html/rfc2324
<span class="token operator">&lt;</span> access-control-allow-origin: *
<span class="token operator">&lt;</span> access-control-allow-credentials: <span class="token boolean">true</span>
<span class="token operator">&lt;</span> content-length: <span class="token number">135</span>
<span class="token operator">&lt;</span> x-envoy-upstream-service-time: <span class="token number">23</span>
<span class="token operator">&lt;</span>

    -<span class="token operator">=</span><span class="token punctuation">[</span> teapot <span class="token punctuation">]</span><span class="token operator">=</span>-

       _<span class="token punctuation">..</span><span class="token punctuation">..</span>_
     .&#39;  _ _ <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">.</span>
    <span class="token operator">|</span> .&quot;<span class="token variable">`</span></span> ^ <span class="token variable"><span class="token variable">`</span>&quot;. _,
    <span class="token punctuation">\</span>_<span class="token punctuation">;</span><span class="token variable">`</span></span><span class="token string">&quot;---&quot;</span><span class="token variable"><span class="token variable">`</span><span class="token operator">|</span>//
      <span class="token operator">|</span>       <span class="token punctuation">;</span>/
      <span class="token punctuation">\</span>_     _/
        <span class="token variable">`</span></span><span class="token string">&quot;&quot;</span>&quot;`
* Connection <span class="token comment">#0 to host httpbin.example.com left intact</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li>删除网关的密码并创建一个新密码以更改入口网关的凭据。</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token parameter variable">-n</span> istio-system delete secret httpbin-credential
$ <span class="token function">mkdir</span> new_certificates
$ openssl req <span class="token parameter variable">-x509</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-days</span> <span class="token number">365</span> <span class="token parameter variable">-newkey</span> rsa:2048 <span class="token parameter variable">-subj</span> <span class="token string">&#39;/O=example Inc./CN=example.com&#39;</span> <span class="token parameter variable">-keyout</span> new_certificates/example.com.key <span class="token parameter variable">-out</span> new_certificates/example.com.crt
$ openssl req <span class="token parameter variable">-out</span> new_certificates/httpbin.example.com.csr <span class="token parameter variable">-newkey</span> rsa:2048 <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-keyout</span> new_certificates/httpbin.example.com.key <span class="token parameter variable">-subj</span> <span class="token string">&quot;/CN=httpbin.example.com/O=httpbin organization&quot;</span>
$ openssl x509 <span class="token parameter variable">-req</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-days</span> <span class="token number">365</span> <span class="token parameter variable">-CA</span> new_certificates/example.com.crt <span class="token parameter variable">-CAkey</span> new_certificates/example.com.key <span class="token parameter variable">-set_serial</span> <span class="token number">0</span> <span class="token parameter variable">-in</span> new_certificates/httpbin.example.com.csr <span class="token parameter variable">-out</span> new_certificates/httpbin.example.com.crt
$ kubectl create <span class="token parameter variable">-n</span> istio-system secret tls httpbin-credential <span class="token punctuation">\</span>
<span class="token parameter variable">--key</span><span class="token operator">=</span>new_certificates/httpbin.example.com.key <span class="token punctuation">\</span>
<span class="token parameter variable">--cert</span><span class="token operator">=</span>new_certificates/httpbin.example.com.crt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="6"><li>使用新的证书链访问<code>httpbin</code>服务：<code>curl</code></li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-HHost:httpbin.example.com</span> <span class="token parameter variable">--resolve</span> <span class="token string">&quot;httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>:<span class="token variable">$INGRESS_HOST</span>&quot;</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--cacert</span> new_certificates/example.com.crt <span class="token string">&quot;https://httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>/status/418&quot;</span>
<span class="token punctuation">..</span>.
HTTP/2 <span class="token number">418</span>
<span class="token punctuation">..</span>.
    -<span class="token operator">=</span><span class="token punctuation">[</span> teapot <span class="token punctuation">]</span><span class="token operator">=</span>-

       _<span class="token punctuation">..</span><span class="token punctuation">..</span>_
     .&#39;  _ _ <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">.</span>
    <span class="token operator">|</span> .&quot;<span class="token variable">`</span></span> ^ <span class="token variable"><span class="token variable">`</span>&quot;. _,
    <span class="token punctuation">\</span>_<span class="token punctuation">;</span><span class="token variable">`</span></span><span class="token string">&quot;---&quot;</span><span class="token variable"><span class="token variable">`</span><span class="token operator">|</span>//
      <span class="token operator">|</span>       <span class="token punctuation">;</span>/
      <span class="token punctuation">\</span>_     _/
        <span class="token variable">`</span></span><span class="token string">&quot;&quot;</span>&quot;`
        
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="7"><li>如果您尝试使用<code>httpbin</code>以前的证书链进行访问，则现在尝试失败。</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-HHost:httpbin.example.com</span> <span class="token parameter variable">--resolve</span> <span class="token string">&quot;httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>:<span class="token variable">$INGRESS_HOST</span>&quot;</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--cacert</span> example.com.crt <span class="token string">&quot;https://httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>/status/418&quot;</span>
<span class="token punctuation">..</span>.
* TLSv1.2 <span class="token punctuation">(</span>OUT<span class="token punctuation">)</span>, TLS handshake, Client hello <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>:
* TLSv1.2 <span class="token punctuation">(</span>IN<span class="token punctuation">)</span>, TLS handshake, Server hello <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>:
* TLSv1.2 <span class="token punctuation">(</span>IN<span class="token punctuation">)</span>, TLS handshake, Certificate <span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>:
* TLSv1.2 <span class="token punctuation">(</span>OUT<span class="token punctuation">)</span>, TLS alert, Server hello <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>:
* curl: <span class="token punctuation">(</span><span class="token number">35</span><span class="token punctuation">)</span> error:04FFF06A:rsa routines:CRYPTO_internal:block <span class="token builtin class-name">type</span> is not 01
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="为多个主机配置tls入口网关" tabindex="-1"><a class="header-anchor" href="#为多个主机配置tls入口网关" aria-hidden="true">#</a> 为多个主机配置TLS入口网关</h4><p>您可以为多个主机配置一个入口网关 <code>httpbin.example.com</code>，<code>helloworld-v1.example.com</code>例如。入口网关检索与特定<code>credentialName</code>.</p><ol><li>要恢复 的凭据<code>httpbin</code>，请删除其密钥并重新创建。</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token parameter variable">-n</span> istio-system delete secret httpbin-credential
$ kubectl create <span class="token parameter variable">-n</span> istio-system secret tls httpbin-credential <span class="token punctuation">\</span>
<span class="token parameter variable">--key</span><span class="token operator">=</span>httpbin.example.com.key <span class="token punctuation">\</span>
<span class="token parameter variable">--cert</span><span class="token operator">=</span>httpbin.example.com.crt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>启动<code>helloworld-v1</code>示例</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ cat &lt;&lt;EOF <span class="token punctuation">|</span> kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5000</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
        <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> helloworld
        <span class="token key atrule">image</span><span class="token punctuation">:</span> istio/examples<span class="token punctuation">-</span>helloworld<span class="token punctuation">-</span>v1
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;100m&quot;</span>
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent <span class="token comment">#Always</span>
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">5000</span>
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>生成证书和私钥<code>helloworld-v1.example.com</code>：</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ openssl req <span class="token parameter variable">-out</span> helloworld-v1.example.com.csr <span class="token parameter variable">-newkey</span> rsa:2048 <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-keyout</span> helloworld-v1.example.com.key <span class="token parameter variable">-subj</span> <span class="token string">&quot;/CN=helloworld-v1.example.com/O=helloworld organization&quot;</span>
$ openssl x509 <span class="token parameter variable">-req</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-days</span> <span class="token number">365</span> <span class="token parameter variable">-CA</span> example.com.crt <span class="token parameter variable">-CAkey</span> example.com.key <span class="token parameter variable">-set_serial</span> <span class="token number">1</span> <span class="token parameter variable">-in</span> helloworld-v1.example.com.csr <span class="token parameter variable">-out</span> helloworld-v1.example.com.crt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>创建<code>helloworld-credential</code>密钥：</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl create <span class="token parameter variable">-n</span> istio-system secret tls helloworld-credential <span class="token parameter variable">--key</span><span class="token operator">=</span>helloworld-v1.example.com.key <span class="token parameter variable">--cert</span><span class="token operator">=</span>helloworld-v1.example.com.crt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="5"><li>为端口 443 定义一个具有两个服务器部分的网关。将 <code>credentialName</code>每个端口上的值分别设置为<code>httpbin-credential</code>和<code>helloworld-credential</code> 。 <ul><li>将 TLS 模式设置为<code>SIMPLE</code>是单向TLS入口网关.</li><li>将 TLS 模式设置为<code>MUTUAL</code>是双向TLS入口网关</li></ul></li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ cat &lt;&lt;EOF <span class="token punctuation">|</span> kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mygateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway <span class="token comment"># use istio default ingress gateway</span>
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>httpbin
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE
      <span class="token key atrule">credentialName</span><span class="token punctuation">:</span> httpbin<span class="token punctuation">-</span>credential
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> httpbin.example.com
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>helloworld
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE
      <span class="token key atrule">credentialName</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>credential
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> helloworld<span class="token punctuation">-</span>v1.example.com
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="6"><li>配置网关的流量路由。定义相应的虚拟服务。</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ cat &lt;&lt;EOF <span class="token punctuation">|</span> kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> helloworld<span class="token punctuation">-</span>v1.example.com
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> mygateway
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">exact</span><span class="token punctuation">:</span> /hello
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">5000</span>
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="7"><li>发送 HTTPS 请求到<code>helloworld-v1.example.com</code>：</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-HHost:httpbin.example.com</span> <span class="token parameter variable">--resolve</span> <span class="token string">&quot;httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>:<span class="token variable">$INGRESS_HOST</span>&quot;</span> <span class="token punctuation">\</span>
<span class="token operator">&gt;</span> <span class="token parameter variable">--cacert</span> example.com.crt <span class="token string">&quot;https://httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>/status/418&quot;</span>
* Added httpbin.example.com:7339:192.168.1.6 to DNS cache
* About to connect<span class="token punctuation">(</span><span class="token punctuation">)</span> to httpbin.example.com port <span class="token number">7339</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
*   Trying <span class="token number">192.168</span>.1.6<span class="token punctuation">..</span>.
* Connected to httpbin.example.com <span class="token punctuation">(</span><span class="token number">192.168</span>.1.6<span class="token punctuation">)</span> port <span class="token number">7339</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
* Initializing NSS with certpath: sql:/etc/pki/nssdb
*   CAfile: example.com.crt
  CApath: none
* SSL connection using TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
* Server certificate:
*       subject: <span class="token assign-left variable">O</span><span class="token operator">=</span>httpbin organization,CN<span class="token operator">=</span>httpbin.example.com
*       start date: Mar <span class="token number">20</span> <span class="token number">15</span>:18:42 <span class="token number">2022</span> GMT
*       expire date: Mar <span class="token number">20</span> <span class="token number">15</span>:18:42 <span class="token number">2023</span> GMT
*       common name: httpbin.example.com
*       issuer: <span class="token assign-left variable">CN</span><span class="token operator">=</span>example.com,O<span class="token operator">=</span>example Inc.
<span class="token operator">&gt;</span> GET /status/418 HTTP/1.1
<span class="token operator">&gt;</span> User-Agent: curl/7.29.0
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span> Host:httpbin.example.com
<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">418</span> Unknown
<span class="token operator">&lt;</span> server: istio-envoy
<span class="token operator">&lt;</span> date: Mon, <span class="token number">21</span> Mar <span class="token number">2022</span> 00:58:24 GMT
<span class="token operator">&lt;</span> x-more-info: http://tools.ietf.org/html/rfc2324
<span class="token operator">&lt;</span> access-control-allow-origin: *
<span class="token operator">&lt;</span> access-control-allow-credentials: <span class="token boolean">true</span>
<span class="token operator">&lt;</span> content-length: <span class="token number">135</span>
<span class="token operator">&lt;</span> x-envoy-upstream-service-time: <span class="token number">2</span>
<span class="token operator">&lt;</span>

    -<span class="token operator">=</span><span class="token punctuation">[</span> teapot <span class="token punctuation">]</span><span class="token operator">=</span>-

       _<span class="token punctuation">..</span><span class="token punctuation">..</span>_
     .&#39;  _ _ <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">.</span>
    <span class="token operator">|</span> .&quot;<span class="token variable">`</span></span> ^ <span class="token variable"><span class="token variable">`</span>&quot;. _,
    <span class="token punctuation">\</span>_<span class="token punctuation">;</span><span class="token variable">`</span></span><span class="token string">&quot;---&quot;</span><span class="token variable"><span class="token variable">`</span><span class="token operator">|</span>//
      <span class="token operator">|</span>       <span class="token punctuation">;</span>/
      <span class="token punctuation">\</span>_     _/
        <span class="token variable">`</span></span><span class="token string">&quot;&quot;</span>&quot;`
* Connection <span class="token comment">#0 to host httpbin.example.com left intact</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="8"><li>发送一个 HTTPS 请求<code>httpbin.example.com</code>并仍然得到一个茶壶作为回报：</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-HHost:httpbin.example.com</span> <span class="token parameter variable">--resolve</span> <span class="token string">&quot;httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>:<span class="token variable">$INGRESS_HOST</span>&quot;</span> <span class="token punctuation">\</span>
<span class="token operator">&gt;</span> <span class="token parameter variable">--cacert</span> example.com.crt <span class="token string">&quot;https://httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>/status/418&quot;</span>
* Added httpbin.example.com:7339:192.168.1.6 to DNS cache
* About to connect<span class="token punctuation">(</span><span class="token punctuation">)</span> to httpbin.example.com port <span class="token number">7339</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
*   Trying <span class="token number">192.168</span>.1.6<span class="token punctuation">..</span>.
* Connected to httpbin.example.com <span class="token punctuation">(</span><span class="token number">192.168</span>.1.6<span class="token punctuation">)</span> port <span class="token number">7339</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
* Initializing NSS with certpath: sql:/etc/pki/nssdb
*   CAfile: example.com.crt
  CApath: none
* SSL connection using TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
* Server certificate:
*       subject: <span class="token assign-left variable">O</span><span class="token operator">=</span>httpbin organization,CN<span class="token operator">=</span>httpbin.example.com
*       start date: Mar <span class="token number">20</span> <span class="token number">15</span>:18:42 <span class="token number">2022</span> GMT
*       expire date: Mar <span class="token number">20</span> <span class="token number">15</span>:18:42 <span class="token number">2023</span> GMT
*       common name: httpbin.example.com
*       issuer: <span class="token assign-left variable">CN</span><span class="token operator">=</span>example.com,O<span class="token operator">=</span>example Inc.
<span class="token operator">&gt;</span> GET /status/418 HTTP/1.1
<span class="token operator">&gt;</span> User-Agent: curl/7.29.0
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span> Host:httpbin.example.com
<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">418</span> Unknown
<span class="token operator">&lt;</span> server: istio-envoy
<span class="token operator">&lt;</span> date: Mon, <span class="token number">21</span> Mar <span class="token number">2022</span> 01:13:48 GMT
<span class="token operator">&lt;</span> x-more-info: http://tools.ietf.org/html/rfc2324
<span class="token operator">&lt;</span> access-control-allow-origin: *
<span class="token operator">&lt;</span> access-control-allow-credentials: <span class="token boolean">true</span>
<span class="token operator">&lt;</span> content-length: <span class="token number">135</span>
<span class="token operator">&lt;</span> x-envoy-upstream-service-time: <span class="token number">3</span>
<span class="token operator">&lt;</span>

    -<span class="token operator">=</span><span class="token punctuation">[</span> teapot <span class="token punctuation">]</span><span class="token operator">=</span>-

       _<span class="token punctuation">..</span><span class="token punctuation">..</span>_
     .&#39;  _ _ <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">.</span>
    <span class="token operator">|</span> .&quot;<span class="token variable">`</span></span> ^ <span class="token variable"><span class="token variable">`</span>&quot;. _,
    <span class="token punctuation">\</span>_<span class="token punctuation">;</span><span class="token variable">`</span></span><span class="token string">&quot;---&quot;</span><span class="token variable"><span class="token variable">`</span><span class="token operator">|</span>//
      <span class="token operator">|</span>       <span class="token punctuation">;</span>/
      <span class="token punctuation">\</span>_     _/
        <span class="token variable">`</span></span><span class="token string">&quot;&quot;</span>&quot;`
* Connection <span class="token comment">#0 to host httpbin.example.com left intact</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="密钥格式" tabindex="-1"><a class="header-anchor" href="#密钥格式" aria-hidden="true">#</a> 密钥格式</h4><p>Istio 支持读取几种不同的 Secret 格式，以支持与各种工具的集成，例如<a href="https://istio.io/latest/docs/ops/integrations/certmanager/" target="_blank" rel="noopener noreferrer">cert-manager<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>：</p><ul><li>一个 TLS 密钥，带有<code>tls.key</code>和<code>tls.crt</code>，如上所述。对于双向 TLS，<code>ca.crt</code>可以使用密钥。</li><li>带有键的通用 Secret<code>key</code>和<code>cert</code>. 对于双向 TLS，<code>cacert</code>可以使用密钥。</li><li>带有键的通用 Secret<code>key</code>和<code>cert</code>. 对于双向 TLS，一个名为 的单独通用 Secret<code>&lt;secret&gt;-cacert</code>带有一个<code>cacert</code>密钥。例如，<code>httpbin-credential</code>有<code>key</code>和<code>cert</code>，并且<code>httpbin-credential-cacert</code>有<code>cacert</code>。</li><li><code>cacert</code>键值可以是一个 CA 捆绑包，由串联的各个 CA 证书组成。</li></ul><h4 id="清理-8" tabindex="-1"><a class="header-anchor" href="#清理-8" aria-hidden="true">#</a> 清理</h4><p>删除网关配置、虚拟服务定义和机密：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete gateway mygateway
$ kubectl delete virtualservice httpbin
$ kubectl delete --ignore-not-found<span class="token operator">=</span>true <span class="token parameter variable">-n</span> istio-system secret httpbin-credential <span class="token punctuation">\</span>
helloworld-credential
$ kubectl delete --ignore-not-found<span class="token operator">=</span>true virtualservice helloworld-v1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>删除证书和密钥：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">rm</span> <span class="token parameter variable">-rf</span> example.com.crt example.com.key httpbin.example.com.crt httpbin.example.com.key httpbin.example.com.csr helloworld-v1.example.com.crt helloworld-v1.example.com.key helloworld-v1.example.com.csr client.example.com.crt client.example.com.csr client.example.com.key ./new_certificates
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>关闭<code>httpbin</code>和<code>helloworld-v1</code>服务：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete deployment --ignore-not-found<span class="token operator">=</span>true httpbin helloworld-v1
$ kubectl delete <span class="token function">service</span> --ignore-not-found<span class="token operator">=</span>true httpbin helloworld-v1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="出口tls发起" tabindex="-1"><a class="header-anchor" href="#出口tls发起" aria-hidden="true">#</a> 出口TLS发起</h2><h4 id="什么是tls发起" tabindex="-1"><a class="header-anchor" href="#什么是tls发起" aria-hidden="true">#</a> 什么是TLS发起</h4><p>用于配置 Istio 以受控方式访问外部服务。这个例子展示了如何配置 Istio 来执行<a href="https://istio.io/latest/docs/reference/config/networking/service-entry/" target="_blank" rel="noopener noreferrer"><code>ServiceEntry</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>TLS 发起 用于到外部服务的流量。当原始流量为 HTTP 时，Istio 将打开与外部服务的 HTTPS 连接。</p><p>考虑一个对外部站点执行 HTTP 调用的遗留应用程序。假设运行应用程序的组织收到一个新要求，要求所有外部流量都必须加密。使用 Istio，只需配置即可实现此要求，无需更改应用程序中的任何代码。应用程序可以发送未加密的 HTTP 请求，然后 Istio 将为应用程序加密它们。</p><p>从源发送未加密的 HTTP 请求并让 Istio 执行 TLS 升级的另一个好处是 Istio 可以生成更好的遥测数据并为未加密的请求提供更多的路由控制。</p><h4 id="环境准备-7" tabindex="-1"><a class="header-anchor" href="#环境准备-7" aria-hidden="true">#</a> 环境准备</h4><p>启动将用作外部调用测试源的<a href="https://github.com/istio/istio/tree/release-1.13/samples/sleep" target="_blank" rel="noopener noreferrer">睡眠样本。<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>如果您启用了<a href="https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection" target="_blank" rel="noopener noreferrer">自动边车注入<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>，请部署<code>sleep</code>应用程序：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/sleep/sleep.yaml
$ kubectl apply <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject <span class="token parameter variable">-f</span> samples/sleep/sleep.yaml<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>请注意，您可以<code>exec</code>和<code>curl</code>来自的任何 pod 都将执行以下过程。</p><p>创建一个 shell 变量来保存用于向外部服务发送请求的源 pod 的名称。如果您使用了<a href="https://github.com/istio/istio/tree/release-1.13/samples/sleep" target="_blank" rel="noopener noreferrer">sleep<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>示例，请运行：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">SOURCE_POD</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>sleep <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="配置对外部服务的访问" tabindex="-1"><a class="header-anchor" href="#配置对外部服务的访问" aria-hidden="true">#</a> 配置对外部服务的访问</h4><p>首先使用<a href="https://istio.io/latest/docs/tasks/traffic-management/egress/egress-control" target="_blank" rel="noopener noreferrer">访问外部服务<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>任务<code>edition.cnn.com</code>中显示的相同技术配置对外部服务的访问。但是，这一次使用单个来启用对服务的 HTTP 和 HTTPS 访问。<code>ServiceEntry</code></p><ol><li>创建一个<code>ServiceEntry</code>以启用对<code>edition.cnn.com</code>：</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceEntry
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> edition<span class="token punctuation">-</span>cnn<span class="token punctuation">-</span>com
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> edition.cnn.com
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>port
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>port
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
  <span class="token key atrule">resolution</span><span class="token punctuation">:</span> DNS
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>向外部 HTTP 服务发出请求：</li></ol><blockquote><p>注意 curl 的<em>标志</em><code>-L</code>，它指示<em>curl</em>遵循重定向。在这种情况下，服务器为 HTTP 请求返回了重定向响应（<a href="https://tools.ietf.org/html/rfc2616#section-10.3.2" target="_blank" rel="noopener noreferrer">301 Moved Permanently<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ） 。重定向响应指示客户端发送一个额外的请求，这次使用 HTTPS，到. 对于第二个请求，服务器返回请求的内容和<em>200 OK</em>状态码。<code>http://edition.cnn.com/politics``https://edition.cnn.com/politics</code></p><p>尽管<em>curl</em>命令透明地处理了重定向，但这里有两个问题。第一个问题是冗余请求，它使获取<code>http://edition.cnn.com/politics</code>. 第二个问题是 URL 的路径，在这种情况下是<em>政治</em>，是以明文形式发送的。如果有攻击者嗅探你的应用程序和 之间的通信<code>edition.cnn.com</code>，攻击者就会知道<code>edition.cnn.com</code>应用程序获取了哪些特定主题。出于隐私原因，您可能希望阻止此类披露。</p><p><strong>这两个问题都可以通过配置 Istio 来执行 TLS 发起来解决。</strong></p></blockquote><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">${SOURCE_POD}</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-D</span> - http://edition.cnn.com/politics
HTTP/1.1 <span class="token number">301</span> Moved Permanently
<span class="token punctuation">..</span>.
location: https://edition.cnn.com/politics
<span class="token punctuation">..</span>.

HTTP/2 <span class="token number">200</span>
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="出口流量的tls发起" tabindex="-1"><a class="header-anchor" href="#出口流量的tls发起" aria-hidden="true">#</a> 出口流量的TLS发起</h4><ol><li>重新定义<code>ServiceEntry</code>上一节中的将 HTTP 请求重定向到端口 443 并添加一个<code>DestinationRule</code>以执行 TLS 发起： <ul><li><code>配置服务入口的http重定向到443端口</code></li><li><code>配置交通策略针对80端口使用模式为SIMPLE的tls</code></li></ul></li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceEntry
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> edition<span class="token punctuation">-</span>cnn<span class="token punctuation">-</span>com
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> edition.cnn.com
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>port
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">443</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>port
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
  <span class="token key atrule">resolution</span><span class="token punctuation">:</span> DNS
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> edition<span class="token punctuation">-</span>cnn<span class="token punctuation">-</span>com
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> edition.cnn.com
  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">portLevelSettings</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
        <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">tls</span><span class="token punctuation">:</span>
        <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE <span class="token comment"># initiates HTTPS when accessing edition.cnn.com</span>
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上<code>DestinationRule</code>将为端口 80 上的 HTTP 请求执行 TLS 发起，<code>ServiceEntry</code> 然后将端口 80 上的请求重定向到目标端口 443。</p><ol start="2"><li>向 发送 HTTP 请求<code>http://edition.cnn.com/politics</code>，如上一节所述：</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">${SOURCE_POD}</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-D</span> - http://edition.cnn.com/politics
HTTP/1.1 <span class="token number">200</span> OK
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这次您收到<em>200 OK</em>作为第一个也是唯一的响应。Istio 为<em>curl</em>执行 TLS 发起，因此原始 HTTP 请求被转发<code>edition.cnn.com</code>为 HTTPS。服务器直接返回内容，无需重定向。您消除了客户端和服务器之间的双重往返，并且请求使网格加密，而没有披露您的应用程序<em>获取</em>.<code>edition.cnn.com</code></p><p>请注意，您使用了与上一节中相同的命令。对于以编程方式访问外部服务的应用程序，无需更改代码。您可以通过配置 Istio 获得 TLS 发起的好处，而无需更改一行代码。</p><ol start="3"><li>请注意，使用 HTTPS 访问外部服务的应用程序继续像以前一样工作：</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">${SOURCE_POD}</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-D</span> - https://edition.cnn.com/politics
HTTP/2 <span class="token number">200</span>
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="清理-9" tabindex="-1"><a class="header-anchor" href="#清理-9" aria-hidden="true">#</a> 清理</h4><p>删除您创建的 Istio 配置项、关闭<a href="https://github.com/istio/istio/tree/release-1.13/samples/sleep" target="_blank" rel="noopener noreferrer">睡眠<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>服务：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete serviceentry edition-cnn-com
$ kubectl delete destinationrule edition-cnn-com
$ kubectl delete <span class="token parameter variable">-f</span> samples/sleep/sleep.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="出口网关" tabindex="-1"><a class="header-anchor" href="#出口网关" aria-hidden="true">#</a> 出口网关</h2><h4 id="什么是出口网关" tabindex="-1"><a class="header-anchor" href="#什么是出口网关" aria-hidden="true">#</a> 什么是出口网关</h4><p>Istio 使用<a href="https://istio.io/latest/docs/reference/config/networking/gateway/" target="_blank" rel="noopener noreferrer">入口和出口网关<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 来配置在服务网格边缘执行的负载均衡器。入口网关允许您定义所有传入流量流过的网格的入口点。出口网关是一个对称的概念；它定义了网格的出口点。出口网关允许您将 Istio 功能（例如监控和路由规则）应用于退出网格的流量。</p><p>考虑一个具有严格安全要求的组织，即所有离开服务网格的流量都必须流经一组专用节点。这些节点将在专用机器上运行，与集群中运行应用程序的其余节点分开。这些特殊节点将用于对出口流量执行策略，并且将比其他节点更彻底地监控。</p><p>另一个用例是应用程序节点没有公共 IP 的集群，因此在它们上运行的网内服务无法访问 Internet。定义一个出口网关，引导所有出口流量通过它，并将公共 IP 分配给出口网关节点，允许应用程序节点以受控方式访问外部服务。</p><h4 id="基础环境-2" tabindex="-1"><a class="header-anchor" href="#基础环境-2" aria-hidden="true">#</a> 基础环境</h4><p>部署<a href="https://github.com/istio/istio/tree/release-1.13/samples/sleep" target="_blank" rel="noopener noreferrer">sleep<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>示例应用程序以用作发送请求的测试源。如果您 启用了<a href="https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection" target="_blank" rel="noopener noreferrer">自动 Sidecar 注入<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ，请运行以下命令来部署示例应用程序：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/sleep/sleep.yaml
$ kubectl apply <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject <span class="token parameter variable">-f</span> samples/sleep/sleep.yaml<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>将<code>SOURCE_POD</code>环境变量设置为源 pod 的名称：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">SOURCE_POD</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>sleep <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="部署istio出口网关" tabindex="-1"><a class="header-anchor" href="#部署istio出口网关" aria-hidden="true">#</a> 部署Istio出口网关</h4><ol><li>检查是否部署了 Istio 出口网关：</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">istio</span><span class="token operator">=</span>egressgateway <span class="token parameter variable">-n</span> istio-system
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>如果没有返回 pod，请执行以下步骤部署 Istio 出口网关。</p><ol start="2"><li>如果您使用<code>IstioOperator</code>CR 安装 Istio，请将以下字段添加到您的配置中：</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">components</span><span class="token punctuation">:</span>
    <span class="token key atrule">egressGateways</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>否则，将等效设置添加到您的原始<code>istioctl install</code>命令，例如：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ istioctl <span class="token function">install</span> <span class="token operator">&lt;</span>flags-you-used-to-install-Istio<span class="token operator">&gt;</span> <span class="token punctuation">\</span>
                   <span class="token parameter variable">--set</span> components.egressGateways<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.name<span class="token operator">=</span>istio-egressgateway <span class="token punctuation">\</span>
                   <span class="token parameter variable">--set</span> components.egressGateways<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.enabled<span class="token operator">=</span>true
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="http流量的出口网关" tabindex="-1"><a class="header-anchor" href="#http流量的出口网关" aria-hidden="true">#</a> HTTP流量的出口网关</h4><p>首先创建一个<code>ServiceEntry</code>允许直接流量到外部服务。</p><ol><li><code>ServiceEntry</code>为定义一个<code>edition.cnn.com</code>。 <ul><li><code>配置主机为edition.cnn.com</code></li><li><code>配置主机发现模式为DNS</code></li><li><code>配置HTTP和HTTPS两个协议</code></li></ul></li></ol><blockquote><p><code>DNS</code>必须在下面的服务条目中使用分辨率。如果分辨率为<code>NONE</code>，网关将在无限循环中将流量定向到自身。这是因为网关接收到一个请求，其原始目标 IP 地址等于网关的服务 IP（因为请求是由 Sidecar 代理定向到网关的）。通过<code>DNS</code>解析，网关执行 DNS 查询以获取外部服务的 IP 地址并将流量定向到该 IP 地址。</p></blockquote><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceEntry
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cnn
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> edition.cnn.com
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>port
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> https
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
  <span class="token key atrule">resolution</span><span class="token punctuation">:</span> DNS
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><p><a href="http://edition.cnn.com/politics" target="_blank" rel="noopener noreferrer">通过向http://edition.cnn.com/politics<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><code>ServiceEntry</code>发送 HTTP 请求来验证您的应用是否正确。</p><p>输出应与 <a href="https://istio.io/latest/docs/tasks/traffic-management/egress/egress-tls-origination/" target="_blank" rel="noopener noreferrer">TLS Origination for Egress Traffic<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>示例中的相同，但没有 TLS 发起。</p></li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">$SOURCE_POD</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-D</span> - http://edition.cnn.com/politics
<span class="token punctuation">..</span>.
HTTP/1.1 <span class="token number">301</span> Moved Permanently
<span class="token punctuation">..</span>.
location: https://edition.cnn.com/politics
<span class="token punctuation">..</span>.

HTTP/2 <span class="token number">200</span>
Content-Type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><code>Gateway</code>为<em><a href="http://edition.cnn.com" target="_blank" rel="noopener noreferrer">edition.cnn.com<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></em>创建一个出口，端口 80，并为定向到出口网关的流量创建一个目标规则。 <ul><li><code>配置出口网关为egressgateway</code></li><li><code>配置主机edition.cnn.com规范为允许80端口</code></li><li><code>创建路由规则主机使用 istio-egressgateway.istio-system.svc.cluster.local</code></li><li><code>路由规则下的子集使用cnn</code></li></ul></li></ol><blockquote><p>要通过出口网关引导多个主机，您可以<code>*</code>在<code>Gateway</code>. 应将 中的<code>subset</code>字段重新用于其他主机。<code>DestinationRule</code></p></blockquote><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> egressgateway
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> edition.cnn.com
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> egressgateway<span class="token punctuation">-</span>for<span class="token punctuation">-</span>cnn
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway.istio<span class="token punctuation">-</span>system.svc.cluster.local
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cnn
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>定义 <code>VirtualService</code>以将流量从 sidecar 引导到 egress 网关，并从 egress 网关引导到外部服务： <ul><li><code>定义主机地址为edition.cnn.com</code></li><li><code>配置虚拟服务使用两个网关 istio-egressgateway和mesh</code></li><li><code>配置http规则分别使用两个网关都是允许80端口</code></li><li><code>配置mesh的路由规则允许主机 istio-egressgateway.istio-system.svc.cluster.local 、子集为cnn、端口是80 、权重分配为100</code></li><li><code>配置istio-egressgateway的路由规则允许主机为edition.cnn.com、端口是80、权重分配也是100</code></li></ul></li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> direct<span class="token punctuation">-</span>cnn<span class="token punctuation">-</span>through<span class="token punctuation">-</span>egress<span class="token punctuation">-</span>gateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> edition.cnn.com
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> istio<span class="token punctuation">-</span>egressgateway
  <span class="token punctuation">-</span> mesh
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> mesh
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway.istio<span class="token punctuation">-</span>system.svc.cluster.local
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> cnn
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> istio<span class="token punctuation">-</span>egressgateway
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> edition.cnn.com
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li>将 HTTP 请求重新发送到<a href="https://edition.cnn.com/politics" target="_blank" rel="noopener noreferrer">http://edition.cnn.com/politics<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">$SOURCE_POD</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-D</span> - http://edition.cnn.com/politics
<span class="token punctuation">..</span>.
HTTP/1.1 <span class="token number">301</span> Moved Permanently
<span class="token punctuation">..</span>.
location: https://edition.cnn.com/politics
<span class="token punctuation">..</span>.

HTTP/2 <span class="token number">200</span>
Content-Type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="6"><li><p>检查<code>istio-egressgateway</code>pod 的日志中是否有与我们的请求相对应的行。如果 Istio 部署在<code>istio-system</code>命名空间中，打印日志的命令是：</p><p>请注意，您仅将流量从端口 80 重定向到出口网关。到端口 443 的 HTTPS 流量直接转到<em><a href="http://edition.cnn.com" target="_blank" rel="noopener noreferrer">edition.cnn.com<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></em>。</p></li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl logs -l istio=egressgateway -c istio-proxy -n istio-system | tail</span>
<span class="token number">2022</span>-03-21T09:42:18.336211Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T10:14:36.196020Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T10:47:07.424114Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T11:15:16.460832Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T11:42:49.235363Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token punctuation">[</span><span class="token number">2022</span>-03-21T11:52:20.947Z<span class="token punctuation">]</span> <span class="token string">&quot;- - -&quot;</span> <span class="token number">0</span> UF,URX - - <span class="token string">&quot;-&quot;</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">15</span> - <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;151.101.65.67:443&quot;</span> outbound<span class="token operator">|</span><span class="token number">443</span><span class="token operator">||</span>edition.cnn.com - <span class="token number">10.244</span>.1.4:8443 <span class="token number">10.244</span>.1.20:33384 edition.cnn.com -
<span class="token punctuation">[</span><span class="token number">2022</span>-03-21T11:52:28.733Z<span class="token punctuation">]</span> <span class="token string">&quot;- - -&quot;</span> <span class="token number">0</span> - - - <span class="token string">&quot;-&quot;</span> <span class="token number">910</span> <span class="token number">1262165</span> <span class="token number">45829</span> - <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;151.101.193.67:443&quot;</span> outbound<span class="token operator">|</span><span class="token number">443</span><span class="token operator">||</span>edition.cnn.com <span class="token number">10.244</span>.1.4:49136 <span class="token number">10.244</span>.1.4:8443 <span class="token number">10.244</span>.1.20:33440 edition.cnn.com -
<span class="token number">2022</span>-03-21T12:15:16.256967Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T12:45:27.104242Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token punctuation">[</span><span class="token number">2022</span>-03-21T13:06:35.033Z<span class="token punctuation">]</span> <span class="token string">&quot;GET /politics HTTP/2&quot;</span> <span class="token number">301</span> - via_upstream - <span class="token string">&quot;-&quot;</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">356</span> <span class="token number">356</span> <span class="token string">&quot;10.244.1.20&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span> <span class="token string">&quot;82a2b1d1-70f0-9907-bfc3-1a86cfd91721&quot;</span> <span class="token string">&quot;edition.cnn.com&quot;</span> <span class="token string">&quot;151.101.129.67:80&quot;</span> outbound<span class="token operator">|</span><span class="token number">80</span><span class="token operator">||</span>edition.cnn.com <span class="token number">10.244</span>.1.4:47896 <span class="token number">10.244</span>.1.4:8080 <span class="token number">10.244</span>.1.20:42962 - -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="清理http网关" tabindex="-1"><a class="header-anchor" href="#清理http网关" aria-hidden="true">#</a> 清理HTTP网关</h4><p>在继续下一步之前删除以前的定义：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete gateway istio-egressgateway
$ kubectl delete serviceentry cnn
$ kubectl delete virtualservice direct-cnn-through-egress-gateway
$ kubectl delete destinationrule egressgateway-for-cnn
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="https流量的出口网关" tabindex="-1"><a class="header-anchor" href="#https流量的出口网关" aria-hidden="true">#</a> HTTPS流量的出口网关</h4><p>在本节中，您将通过出口网关引导 HTTPS 流量（由应用程序发起的 TLS）。您需要<code>TLS</code>在一个对应<code>ServiceEntry</code>的、一个出口<code>Gateway</code>和一个<code>VirtualService</code>.</p><ol><li><code>ServiceEntry</code>为定义一个<code>edition.cnn.com</code>： <ul><li><code>配置服务入口的主机列表为 edition.cnn.com</code></li><li><code>配置ports规则为TLS模式以及443端口</code></li><li><code>配置主机发现模式为DNS</code></li></ul></li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceEntry
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cnn
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> edition.cnn.com
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> tls
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TLS
  <span class="token key atrule">resolution</span><span class="token punctuation">:</span> DNS
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><a href="https://edition.cnn.com/politics" target="_blank" rel="noopener noreferrer">通过向https://edition.cnn.com/politics<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><code>ServiceEntry</code>发送 HTTPS 请求来验证您的应用是否正确。</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">$SOURCE_POD</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-D</span> - https://edition.cnn.com/politics
<span class="token punctuation">..</span>.
HTTP/2 <span class="token number">200</span>
Content-Type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><code>Gateway</code>为<em><a href="http://edition.cnn.com" target="_blank" rel="noopener noreferrer">edition.cnn.com<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></em>创建一个出口、一个目标规则和一个虚拟服务，以引导流量通过出口网关并从出口网关到外部服务。 <ul><li><code>创建服务网关和目标规则以及虚拟服务</code></li><li><code>配置Gateway使用egressgateway的出口网关,服务规则为允许443端口使用TLS</code></li><li><code>Gateway允许的主机为 edition.cnn.com tls的模式使用PASSTHROUGH</code></li><li><code>配置目标规则允许的主机列表istio-egressgateway.istio-system.svc.cluster.local 子集为cnn</code></li><li><code>配置虚拟服务允许主机列表为edition.cnn.com</code></li><li><code>配置虚拟服务使用出口网关istio-egressgateway和mesh</code></li><li><code>配置虚拟服务的mesh网关要匹配的SNI（服务器名称指示器）edition.cnn.com 允许443端口</code></li><li><code>配置虚拟服务的mesh网关目标规则允许主机列表istio-egressgateway.istio-system.svc.cluster.local并且允许443端口</code></li><li><code>配置虚拟服务的istio-egressgateway网关要匹配的SNI（服务器名称指示器）edition.cnn.com 允许443端口</code></li><li><code>配置虚拟服务的istio-egressgateway网关目标规则允许主机列表edition.cnn.com并且允许443端口、权重为100</code></li></ul></li></ol><blockquote><p>要通过出口网关引导多个主机，您可以<code>*</code>在<code>Gateway</code>. 应将 中的<code>subset</code>字段重新用于其他主机。<code>DestinationRule</code></p></blockquote><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> egressgateway
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> tls
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TLS
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> edition.cnn.com
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> PASSTHROUGH
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> egressgateway<span class="token punctuation">-</span>for<span class="token punctuation">-</span>cnn
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway.istio<span class="token punctuation">-</span>system.svc.cluster.local
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cnn
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> direct<span class="token punctuation">-</span>cnn<span class="token punctuation">-</span>through<span class="token punctuation">-</span>egress<span class="token punctuation">-</span>gateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> edition.cnn.com
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> mesh
  <span class="token punctuation">-</span> istio<span class="token punctuation">-</span>egressgateway
  <span class="token key atrule">tls</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> mesh
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">sniHosts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> edition.cnn.com
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway.istio<span class="token punctuation">-</span>system.svc.cluster.local
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> cnn
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> istio<span class="token punctuation">-</span>egressgateway
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">sniHosts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> edition.cnn.com
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> edition.cnn.com
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li><a href="https://edition.cnn.com/politics" target="_blank" rel="noopener noreferrer">向https://edition.cnn.com/politics<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>发送 HTTPS 请求。输出应该和以前一样。</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">$SOURCE_POD</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-D</span> - https://edition.cnn.com/politics
<span class="token punctuation">..</span>.
HTTP/2 <span class="token number">200</span>
Content-Type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li>查看出口网关代理的日志。如果 Istio 部署在<code>istio-system</code>命名空间中，打印日志的命令是：</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl logs -l istio=egressgateway -n istio-system</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-21T11:52:28.733Z<span class="token punctuation">]</span> <span class="token string">&quot;- - -&quot;</span> <span class="token number">0</span> - - - <span class="token string">&quot;-&quot;</span> <span class="token number">910</span> <span class="token number">1262165</span> <span class="token number">45829</span> - <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;151.101.193.67:443&quot;</span> outbound<span class="token operator">|</span><span class="token number">443</span><span class="token operator">||</span>edition.cnn.com <span class="token number">10.244</span>.1.4:49136 <span class="token number">10.244</span>.1.4:8443 <span class="token number">10.244</span>.1.20:33440 edition.cnn.com -
<span class="token number">2022</span>-03-21T12:15:16.256967Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T12:45:27.104242Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token punctuation">[</span><span class="token number">2022</span>-03-21T13:06:35.033Z<span class="token punctuation">]</span> <span class="token string">&quot;GET /politics HTTP/2&quot;</span> <span class="token number">301</span> - via_upstream - <span class="token string">&quot;-&quot;</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">356</span> <span class="token number">356</span> <span class="token string">&quot;10.244.1.20&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span> <span class="token string">&quot;82a2b1d1-70f0-9907-bfc3-1a86cfd91721&quot;</span> <span class="token string">&quot;edition.cnn.com&quot;</span> <span class="token string">&quot;151.101.129.67:80&quot;</span> outbound<span class="token operator">|</span><span class="token number">80</span><span class="token operator">||</span>edition.cnn.com <span class="token number">10.244</span>.1.4:47896 <span class="token number">10.244</span>.1.4:8080 <span class="token number">10.244</span>.1.20:42962 - -
<span class="token number">2022</span>-03-21T13:15:59.020699Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T13:40:14.303559Z     info    ads     XDS: Incremental Pushing:0 ConnectedEndpoints:2 Version:
<span class="token number">2022</span>-03-21T13:40:14.597921Z     info    cache   generated new workload certificate   <span class="token assign-left variable">latency</span><span class="token operator">=</span><span class="token number">294</span>.218007ms <span class="token assign-left variable">ttl</span><span class="token operator">=</span>23h59m59.402089572s
<span class="token number">2022</span>-03-21T13:40:14.598006Z     info    ads     SDS: PUSH <span class="token keyword">for</span> node:istio-egressgateway-7f4864f59c-q5cdv.istio-system resources:1 size:4.0kB resource:default
<span class="token number">2022</span>-03-21T13:47:00.985263Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T14:18:49.713637Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="清理https网关" tabindex="-1"><a class="header-anchor" href="#清理https网关" aria-hidden="true">#</a> 清理HTTPS网关</h4><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete serviceentry cnn
$ kubectl delete gateway istio-egressgateway
$ kubectl delete virtualservice direct-cnn-through-egress-gateway
$ kubectl delete destinationrule egressgateway-for-cnn
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/vuepress-theme-hope/vuepress-theme-hope/edit/main/demo/theme-docs/src/zh/pip/istio/3.Istio的深入浅.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><!----><!----></footer><nav class="page-nav"><a href="/docs/zh/pip/istio/2.Istio%E5%AE%89%E8%A3%85.html" class="nav-link prev" aria-label="Istio安装"><div class="hint"><span class="arrow left"></span>上一页</div><div class="link"><!---->Istio安装</div></a><a href="/docs/zh/pip/istio/4.Istio%E7%BB%83%E4%B9%A0%E9%A2%98.html" class="nav-link next" aria-label="Istio练习题"><div class="hint">下一页<span class="arrow right"></span></div><div class="link">Istio练习题<!----></div></a></nav><div class="waline-wrapper" darkmode="false" style="display:block;"><div data-waline provider="Waline"><!--v-if--><div class="wl-comment"><!--v-if--><div class="wl-panel"><div class="wl-header item3"><!--[--><div class="wl-header-item"><label for="wl-nick">昵称</label><input id="wl-nick" class="wl-input wl-nick" name="nick" type="text" value></div><div class="wl-header-item"><label for="wl-mail">邮箱</label><input id="wl-mail" class="wl-input wl-mail" name="mail" type="email" value></div><div class="wl-header-item"><label for="wl-link">网址</label><input id="wl-link" class="wl-input wl-link" name="link" type="text" value></div><!--]--></div><textarea id="wl-edit" class="wl-editor" placeholder="请留言。(填写邮箱可在被回复时收到邮件提醒)"></textarea><div class="wl-preview" style="display:none;"><hr><h4>预览:</h4><!-- eslint-disable-next-line vue/no-v-html --><div class="wl-content"></div></div><div class="wl-footer"><div class="wl-actions"><a href="https://guides.github.com/features/mastering-markdown/" title="Markdown Guide" aria-label="Markdown is supported" class="wl-action" target="_blank" rel="noreferrer"><svg width="16" height="16" ariaHidden="true"><path d="M14.85 3H1.15C.52 3 0 3.52 0 4.15v7.69C0 12.48.52 13 1.15 13h13.69c.64 0 1.15-.52 1.15-1.15v-7.7C16 3.52 15.48 3 14.85 3zM9 11H7V8L5.5 9.92 4 8v3H2V5h2l1.5 2L7 5h2v6zm2.99.5L9.5 8H11V5h2v3h1.5l-2.51 3.5z" fill="currentColor"></path></svg></a><button class="wl-action" title="表情" style="display:none;"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M563.2 463.3 677 540c1.7 1.2 3.7 1.8 5.8 1.8.7 0 1.4-.1 2-.2 2.7-.5 5.1-2.1 6.6-4.4l25.3-37.8c1.5-2.3 2.1-5.1 1.6-7.8s-2.1-5.1-4.4-6.6l-73.6-49.1 73.6-49.1c2.3-1.5 3.9-3.9 4.4-6.6.5-2.7 0-5.5-1.6-7.8l-25.3-37.8a10.1 10.1 0 0 0-6.6-4.4c-.7-.1-1.3-.2-2-.2-2.1 0-4.1.6-5.8 1.8l-113.8 76.6c-9.2 6.2-14.7 16.4-14.7 27.5.1 11 5.5 21.3 14.7 27.4zM387 348.8h-45.5c-5.7 0-10.4 4.7-10.4 10.4v153.3c0 5.7 4.7 10.4 10.4 10.4H387c5.7 0 10.4-4.7 10.4-10.4V359.2c0-5.7-4.7-10.4-10.4-10.4zm333.8 241.3-41-20a10.3 10.3 0 0 0-8.1-.5c-2.6.9-4.8 2.9-5.9 5.4-30.1 64.9-93.1 109.1-164.4 115.2-5.7.5-9.9 5.5-9.5 11.2l3.9 45.5c.5 5.3 5 9.5 10.3 9.5h.9c94.8-8 178.5-66.5 218.6-152.7 2.4-5 .3-11.2-4.8-13.6zm186-186.1c-11.9-42-30.5-81.4-55.2-117.1-24.1-34.9-53.5-65.6-87.5-91.2-33.9-25.6-71.5-45.5-111.6-59.2-41.2-14-84.1-21.1-127.8-21.1h-1.2c-75.4 0-148.8 21.4-212.5 61.7-63.7 40.3-114.3 97.6-146.5 165.8-32.2 68.1-44.3 143.6-35.1 218.4 9.3 74.8 39.4 145 87.3 203.3.1.2.3.3.4.5l36.2 38.4c1.1 1.2 2.5 2.1 3.9 2.6 73.3 66.7 168.2 103.5 267.5 103.5 73.3 0 145.2-20.3 207.7-58.7 37.3-22.9 70.3-51.5 98.1-85 27.1-32.7 48.7-69.5 64.2-109.1 15.5-39.7 24.4-81.3 26.6-123.8 2.4-43.6-2.5-87-14.5-129zm-60.5 181.1c-8.3 37-22.8 72-43 104-19.7 31.1-44.3 58.6-73.1 81.7-28.8 23.1-61 41-95.7 53.4-35.6 12.7-72.9 19.1-110.9 19.1-82.6 0-161.7-30.6-222.8-86.2l-34.1-35.8c-23.9-29.3-42.4-62.2-55.1-97.7-12.4-34.7-18.8-71-19.2-107.9-.4-36.9 5.4-73.3 17.1-108.2 12-35.8 30-69.2 53.4-99.1 31.7-40.4 71.1-72 117.2-94.1 44.5-21.3 94-32.6 143.4-32.6 49.3 0 97 10.8 141.8 32 34.3 16.3 65.3 38.1 92 64.8 26.1 26 47.5 56 63.6 89.2 16.2 33.2 26.6 68.5 31 105.1 4.6 37.5 2.7 75.3-5.6 112.3z" fill="currentColor"></path></svg></button><button class="wl-action" title="表情包"><svg width="24" height="24" fill="currentcolor" viewBox="0 0 24 24"><path style="transform: translateY(0.5px)" d="M18.968 10.5H15.968V11.484H17.984V12.984H15.968V15H14.468V9H18.968V10.5V10.5ZM8.984 9C9.26533 9 9.49967 9.09367 9.687 9.281C9.87433 9.46833 9.968 9.70267 9.968 9.984V10.5H6.499V13.5H8.468V12H9.968V14.016C9.968 14.2973 9.87433 14.5317 9.687 14.719C9.49967 14.9063 9.26533 15 8.984 15H5.984C5.70267 15 5.46833 14.9063 5.281 14.719C5.09367 14.5317 5 14.2973 5 14.016V9.985C5 9.70367 5.09367 9.46933 5.281 9.282C5.46833 9.09467 5.70267 9.001 5.984 9.001H8.984V9ZM11.468 9H12.968V15H11.468V9V9Z"></path><path d="M18.5 3H5.75C3.6875 3 2 4.6875 2 6.75V18C2 20.0625 3.6875 21.75 5.75 21.75H18.5C20.5625 21.75 22.25 20.0625 22.25 18V6.75C22.25 4.6875 20.5625 3 18.5 3ZM20.75 18C20.75 19.2375 19.7375 20.25 18.5 20.25H5.75C4.5125 20.25 3.5 19.2375 3.5 18V6.75C3.5 5.5125 4.5125 4.5 5.75 4.5H18.5C19.7375 4.5 20.75 5.5125 20.75 6.75V18Z"></path></svg></button><input id="wl-image-upload" class="upload" type="file" accept=".png,.jpg,.jpeg,.webp,.bmp,.gif"><label for="wl-image-upload" class="wl-action" title="上传图片"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M784 112H240c-88 0-160 72-160 160v480c0 88 72 160 160 160h544c88 0 160-72 160-160V272c0-88-72-160-160-160zm96 640c0 52.8-43.2 96-96 96H240c-52.8 0-96-43.2-96-96V272c0-52.8 43.2-96 96-96h544c52.8 0 96 43.2 96 96v480z" fill="currentColor"></path><path d="M352 480c52.8 0 96-43.2 96-96s-43.2-96-96-96-96 43.2-96 96 43.2 96 96 96zm0-128c17.6 0 32 14.4 32 32s-14.4 32-32 32-32-14.4-32-32 14.4-32 32-32zm462.4 379.2-3.2-3.2-177.6-177.6c-25.6-25.6-65.6-25.6-91.2 0l-80 80-36.8-36.8c-25.6-25.6-65.6-25.6-91.2 0L200 728c-4.8 6.4-8 14.4-8 24 0 17.6 14.4 32 32 32 9.6 0 16-3.2 22.4-9.6L380.8 640l134.4 134.4c6.4 6.4 14.4 9.6 24 9.6 17.6 0 32-14.4 32-32 0-9.6-4.8-17.6-9.6-24l-52.8-52.8 80-80L769.6 776c6.4 4.8 12.8 8 20.8 8 17.6 0 32-14.4 32-32 0-8-3.2-16-8-20.8z" fill="currentColor"></path></svg></label><button class="wl-action" title="预览"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M710.816 654.301c70.323-96.639 61.084-230.578-23.705-314.843-46.098-46.098-107.183-71.109-172.28-71.109-65.008 0-126.092 25.444-172.28 71.109-45.227 46.098-70.756 107.183-70.756 172.106 0 64.923 25.444 126.007 71.194 172.106 46.099 46.098 107.184 71.109 172.28 71.109 51.414 0 100.648-16.212 142.824-47.404l126.53 126.006c7.058 7.06 16.297 10.979 26.406 10.979 10.105 0 19.343-3.919 26.402-10.979 14.467-14.467 14.467-38.172 0-52.723L710.816 654.301zm-315.107-23.265c-65.88-65.88-65.88-172.54 0-238.42 32.069-32.07 74.245-49.149 119.471-49.149 45.227 0 87.407 17.603 119.472 49.149 65.88 65.879 65.88 172.539 0 238.42-63.612 63.178-175.242 63.178-238.943 0zm0 0" fill="currentColor"></path><path d="M703.319 121.603H321.03c-109.8 0-199.469 89.146-199.469 199.38v382.034c0 109.796 89.236 199.38 199.469 199.38h207.397c20.653 0 37.384-16.645 37.384-37.299 0-20.649-16.731-37.296-37.384-37.296H321.03c-68.582 0-124.352-55.77-124.352-124.267V321.421c0-68.496 55.77-124.267 124.352-124.267h382.289c68.582 0 124.352 55.771 124.352 124.267V524.72c0 20.654 16.736 37.299 37.385 37.299 20.654 0 37.384-16.645 37.384-37.299V320.549c-.085-109.8-89.321-198.946-199.121-198.946zm0 0" fill="currentColor"></path></svg></button></div><div class="wl-info"><div class="wl-text-number">0 <!--v-if-->  字</div><button class="wl-btn">登录</button><button class="wl-btn primary" title="Cmd|Ctrl + Enter"><!--[-->提交<!--]--></button></div><div class="wl-gif-popup"><input type="text" placeholder="搜索表情包"><div class="wl-gallery" style="gap:6px;"><!--[--><!--]--></div><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div></div><div class="wl-emoji-popup"><!--[--><!--]--><!--v-if--></div></div></div><!--v-if--></div><div class="wl-meta-head"><div class="wl-count"><!--v-if--> 评论</div><ul class="wl-sort"><!--[--><li class="active">按正序</li><li class="">按倒序</li><li class="">按热度</li><!--]--></ul></div><div class="wl-cards"><!--[--><!--]--></div><!--[--><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div><!--]--><!-- Copyright Information --><div class="wl-power"> Powered by <a href="https://github.com/walinejs/waline" target="_blank" rel="noreferrer"> Waline </a> v2.13.0</div></div></div><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer">默认页脚</div><div class="copyright">Copyright © 2022 isKcount</div></footer><!--]--></div><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/docs/assets/app.ca0279c0.js" defer></script>
  </body>
</html>
