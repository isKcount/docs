import{_ as n}from"./_plugin-vue_export-helper.cdc0426e.js";import{o as a,c as s,f as e}from"./app.ca0279c0.js";const i={},l=e(`<h1 id="nginx\u9AD8\u53EF\u7528" tabindex="-1"><a class="header-anchor" href="#nginx\u9AD8\u53EF\u7528" aria-hidden="true">#</a> Nginx\u9AD8\u53EF\u7528</h1><h2 id="\u4EC0\u4E48\u662Fkeepalived" tabindex="-1"><a class="header-anchor" href="#\u4EC0\u4E48\u662Fkeepalived" aria-hidden="true">#</a> \u4EC0\u4E48\u662FKeepalived</h2><p>Keepalived\u662F\u4E00\u4E2A\u514D\u8D39\u5F00\u6E90\u7684\uFF0C\u7528C\u7F16\u5199\u7684\u7C7B\u4F3C\u4E8Elayer3, 4 &amp; 7\u4EA4\u6362\u673A\u5236\u8F6F\u4EF6\uFF0C\u5177\u5907\u6211\u4EEC\u5E73\u65F6\u8BF4\u7684\u7B2C3\u5C42\u3001\u7B2C4\u5C42\u548C\u7B2C7\u5C42\u4EA4\u6362\u673A\u7684\u529F\u80FD\u3002\u4E3B\u8981\u63D0\u4F9Bloadbalancing\uFF08\u8D1F\u8F7D\u5747\u8861\uFF09\u548C high-availability\uFF08\u9AD8\u53EF\u7528\uFF09\u529F\u80FD\uFF0C\u8D1F\u8F7D\u5747\u8861\u5B9E\u73B0\u9700\u8981\u4F9D\u8D56Linux\u7684\u865A\u62DF\u670D\u52A1\u5185\u6838\u6A21\u5757\uFF08ipvs\uFF09\uFF0C\u800C\u9AD8\u53EF\u7528\u662F\u901A\u8FC7VRRP\u534F\u8BAE\u5B9E\u73B0\u591A\u53F0\u673A\u5668\u4E4B\u95F4\u7684\u6545\u969C\u8F6C\u79FB\u670D\u52A1\u3002</p><p><img src="https://img-blog.csdnimg.cn/20181114103932859.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM3OTM5MjUx,size_16,color_FFFFFF,t_70" alt="img" loading="lazy"></p><p>\u4E0A\u56FE\u662FKeepalived\u7684\u529F\u80FD\u4F53\u7CFB\u7ED3\u6784\uFF0C\u5927\u81F4\u5206\u4E24\u5C42\uFF1A\u7528\u6237\u7A7A\u95F4\uFF08user space\uFF09\u548C\u5185\u6838\u7A7A\u95F4\uFF08kernel space\uFF09\u3002</p><h2 id="keepalived\u7279\u70B9" tabindex="-1"><a class="header-anchor" href="#keepalived\u7279\u70B9" aria-hidden="true">#</a> Keepalived\u7279\u70B9</h2><ul><li><p>**<code>\u5185\u6838\u7A7A\u95F4\uFF1A</code>**\u4E3B\u8981\u5305\u62ECIPVS\uFF08IP\u865A\u62DF\u670D\u52A1\u5668\uFF0C\u7528\u4E8E\u5B9E\u73B0\u7F51\u7EDC\u670D\u52A1\u7684\u8D1F\u8F7D\u5747\u8861\uFF09\u548CNETLINK\uFF08\u63D0\u4F9B\u9AD8\u7EA7\u8DEF\u7531\u53CA\u5176\u4ED6\u76F8\u5173\u7684\u7F51\u7EDC\u529F\u80FD\uFF09\u4E24\u4E2A\u90E8\u4EFD\u3002</p></li><li><p><strong><code>\u7528\u6237\u7A7A\u95F4\uFF1A</code></strong></p><ul><li><p>WatchDog\uFF1A\u8D1F\u8F7D\u76D1\u63A7checkers\u548CVRRP\u8FDB\u7A0B\u7684\u72B6\u51B5</p></li><li><p>VRRP Stack\uFF1A\u8D1F\u8F7D\u8D1F\u8F7D\u5747\u8861\u5668\u4E4B\u95F4\u7684\u5931\u8D25\u5207\u6362FailOver\uFF0C\u5982\u679C\u53EA\u7528\u4E00\u4E2A\u8D1F\u8F7D\u5747\u7A00\u5668\uFF0C\u5219VRRP\u4E0D\u662F\u5FC5\u987B\u7684\u3002</p></li><li><p>Checkers\uFF1A\u8D1F\u8D23\u771F\u5B9E\u670D\u52A1\u5668\u7684\u5065\u5EB7\u68C0\u67E5healthchecking\uFF0C\u662Fkeepalived\u6700\u4E3B\u8981\u7684\u529F\u80FD\u3002\u6362\u8A00\u4E4B\uFF0C\u53EF\u4EE5\u6CA1\u6709VRRP Stack\uFF0C\u4F46\u5065\u5EB7\u68C0\u67E5healthchecking\u662F\u4E00\u5B9A\u8981\u6709\u7684\u3002</p></li><li><p>IPVS wrapper\uFF1A\u7528\u6237\u53D1\u9001\u8BBE\u5B9A\u7684\u89C4\u5219\u5230\u5185\u6838ipvs\u4EE3\u7801</p></li><li><p>Netlink Reflector\uFF1A\u7528\u6765\u8BBE\u5B9Avrrp\u7684vip\u5730\u5740\u7B49\u3002</p></li><li><p>Keepalived\u7684\u6240\u6709\u529F\u80FD\u662F\u914D\u7F6Ekeepalived.conf\u6587\u4EF6\u6765\u5B9E\u73B0\u7684\u3002</p></li></ul></li></ul><h2 id="keepalived\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#keepalived\u5B9E\u73B0" aria-hidden="true">#</a> Keepalived\u5B9E\u73B0</h2><ul><li>\u9700\u8981\u4E24\u53F0nginx\u670D\u52A1\u5668</li><li>\u9700\u8981keepalived</li><li>\u9700\u8981\u865A\u62DFIP</li></ul><p><img src="https://i.bmp.ovh/imgs/2022/02/50cf6d99b1d04309.png" alt="" loading="lazy"></p><h2 id="\u914D\u7F6E\u9AD8\u53EF\u7528\u51C6\u5907\u5DE5\u4F5C" tabindex="-1"><a class="header-anchor" href="#\u914D\u7F6E\u9AD8\u53EF\u7528\u51C6\u5907\u5DE5\u4F5C" aria-hidden="true">#</a> \u914D\u7F6E\u9AD8\u53EF\u7528\u51C6\u5907\u5DE5\u4F5C</h2><ul><li>\u9700\u8981\u4E24\u53F0\u670D\u52A1\u5668192.168.0.136\u548C192.168.0.137</li><li>\u5728\u4E24\u53F0\u670D\u52A1\u5668\u5B89\u88C5nginx</li><li>\u5728\u4E24\u53F0\u670D\u52A1\u5668\u5B89\u88C5keepalived</li></ul><h3 id="_1\u3001\u4E24\u53F0\u670D\u52A1\u5668\u5B89\u88C5nginx" tabindex="-1"><a class="header-anchor" href="#_1\u3001\u4E24\u53F0\u670D\u52A1\u5668\u5B89\u88C5nginx" aria-hidden="true">#</a> 1\u3001\u4E24\u53F0\u670D\u52A1\u5668\u5B89\u88C5nginx</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@apache ~<span class="token punctuation">]</span><span class="token comment"># wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span>
<span class="token punctuation">[</span>root@apache ~<span class="token punctuation">]</span><span class="token comment"># yum install -y  nginx</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2\u3001\u4E24\u53F0\u670D\u52A1\u5668\u5B89\u88C5keepalived" tabindex="-1"><a class="header-anchor" href="#_2\u3001\u4E24\u53F0\u670D\u52A1\u5668\u5B89\u88C5keepalived" aria-hidden="true">#</a> 2\u3001\u4E24\u53F0\u670D\u52A1\u5668\u5B89\u88C5Keepalived</h3><p>\u5B89\u88C5\u4E4B\u540E\uFF0C\u5728etc/\u91CC\u9762\u751F\u6210\u76EE\u5F55keepalived\uFF0C\u6709\u6587\u4EF6keepalived.conf</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@nginx1 ~<span class="token punctuation">]</span><span class="token comment"># yum install -y keepalived</span>
<span class="token punctuation">[</span>root@nginx2 ~<span class="token punctuation">]</span><span class="token comment"># yum install -y keepalived</span>


<span class="token punctuation">[</span>root@nginx1 ~<span class="token punctuation">]</span><span class="token comment"># cd /etc/keepalived/</span>
<span class="token punctuation">[</span>root@nginx1 keepalived<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">4</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">3598</span> Oct  <span class="token number">1</span>  <span class="token number">2020</span> keepalived.conf    <span class="token comment">#\u57FA\u672C\u7684\u914D\u7F6E\u90FD\u662F\u8FD9\u8FD9\u91CC\u5B8C\u6210</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2\u3001\u914D\u7F6Ekeepalived" tabindex="-1"><a class="header-anchor" href="#_2\u3001\u914D\u7F6Ekeepalived" aria-hidden="true">#</a> 2\u3001\u914D\u7F6EKeepalived</h3><p>keepalived\u7684\u914D\u7F6E\u6587\u4EF6\u8BE6\u89E3\uFF0C\u914D\u7F6E\u6210\u5982\u4E0B\u914D\u7F6E</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@nginx1 keepalived<span class="token punctuation">]</span><span class="token comment"># echo &quot;127.0.0.1 LVS_DEVEL&quot; &gt;&gt; /etc/hosts </span>
<span class="token punctuation">[</span>root@nginx2 keepalived<span class="token punctuation">]</span><span class="token comment"># echo &quot;127.0.0.1 LVS_DEVEL&quot; &gt;&gt; /etc/hosts </span>
<span class="token punctuation">[</span>root@nginx1 keepalived<span class="token punctuation">]</span><span class="token comment"># cat keepalived.conf</span>
<span class="token operator">!</span> Configuration File <span class="token keyword">for</span> keepalived
	
global_defs <span class="token punctuation">{</span>					<span class="token comment"># \u5168\u5C40\u6A21\u5757</span>
   notification_email <span class="token punctuation">{</span>
     acassen@firewall.loc
     failover@firewall.loc
     sysadmin@firewall.loc
   <span class="token punctuation">}</span>
   notification_email_from Alexandre.Cassen@firewall.loc
   smtp_server <span class="token number">192.168</span>.200.1
   smtp_connect_timeout <span class="token number">30</span>
   router_id LVS_DEVELBACK  <span class="token comment"># \u8BBF\u95EE\u5230\u4E3B\u673A</span>
   vrrp_skip_check_adv_addr
   vrrp_garp_interval <span class="token number">0</span>
   vrrp_gna_interval <span class="token number">0</span>
<span class="token punctuation">}</span>

vrrp_script chk_http_port <span class="token punctuation">{</span>    <span class="token comment"># \u6267\u884C\u811A\u672C</span>
	script <span class="token string">&quot;/opt/nginx_check.sh&quot;</span>   
    interval <span class="token number">2</span>       <span class="token comment"># \u68C0\u6D4B\u811A\u672C\u6267\u884C\u7684\u95F4\u9694</span>
    weight <span class="token number">2</span>
<span class="token punctuation">}</span>

vrrp_instance VI_1 <span class="token punctuation">{</span>
    state MASTER        <span class="token comment"># \u5907\u4EFD\u670D\u52A1\u5668\u4E0A\u5C06MASTER\u4FEE\u6539\u6210BACKUP</span>
    interface eth0		<span class="token comment"># \u6307\u5B9A\u7F51\u5361\u540D\u79F0</span>
    virtual_router_id <span class="token number">51</span>	<span class="token comment"># \u4E3B\u5907\u673A\u7684virtual_router_id\u5FC5\u987B\u76F8\u540C</span>
    priority <span class="token number">100</span>			<span class="token comment"># \u4E3B\u5907\u673A\u53D6\u503C\u4E0D\u540C\u7684\u4F18\u5148\u7EA7\uFF0C\u4E3B\u673A\u503C\u6BD4\u8F83\u5927\uFF0C\u5907\u4EFD\u503C\u6BD4\u8F83\u5C0F</span>
    advert_int <span class="token number">1</span>
    authentication <span class="token punctuation">{</span>
        auth_type PASS
        auth_pass <span class="token number">1111</span>
    <span class="token punctuation">}</span>

    track_script <span class="token punctuation">{</span>
        chk_http_port
<span class="token punctuation">}</span>

    virtual_ipaddress <span class="token punctuation">{</span>   <span class="token comment"># \u865A\u62DFIP\u5730\u5740</span>
       <span class="token number">192.168</span>.0.119
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3\u3001\u7F16\u5199\u6267\u884C\u811A\u672C" tabindex="-1"><a class="header-anchor" href="#_3\u3001\u7F16\u5199\u6267\u884C\u811A\u672C" aria-hidden="true">#</a> 3\u3001\u7F16\u5199\u6267\u884C\u811A\u672C</h3><p>\u8BE5\u811A\u672C\u662F\u5B58\u653E\u5728opt\u4E0B\u9762\u7684</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@nginx1 opt<span class="token punctuation">]</span><span class="token comment"># cat nginx_check.sh</span>
<span class="token comment">#!/bin/bash</span>

<span class="token assign-left variable">A</span><span class="token operator">=</span><span class="token variable"><span class="token variable">\`</span><span class="token function">ps</span> <span class="token parameter variable">-C</span> nginx - no-header <span class="token operator">|</span> <span class="token function">wc</span> <span class="token parameter variable">-l</span><span class="token variable">\`</span></span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$A</span> <span class="token parameter variable">-eq</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
        systemctl start nginx
        <span class="token function">sleep</span> <span class="token number">2</span>
        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable"><span class="token variable">\`</span><span class="token function">ps</span> <span class="token parameter variable">-C</span> nginx --no-header <span class="token operator">|</span> <span class="token function">wc</span> <span class="token parameter variable">-l</span> <span class="token variable">\`</span></span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
                <span class="token function">killall</span> keepalived
        <span class="token keyword">fi</span>
<span class="token keyword">fi</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4\u3001\u542F\u52A8\u6D4B\u8BD5" tabindex="-1"><a class="header-anchor" href="#_4\u3001\u542F\u52A8\u6D4B\u8BD5" aria-hidden="true">#</a> 4\u3001\u542F\u52A8\u6D4B\u8BD5</h3><p>\u91CD\u542F\u670D\u52A1\u4E4B\u540E\u901A\u8FC7\u8BBF\u95EE192.168.0.119\u7684\u865A\u62DFip</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@nginx1 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart keepalived</span>
<span class="token punctuation">[</span>root@nginx2 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart keepalived</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://i.bmp.ovh/imgs/2022/02/cdb72fb92d1f65cf.png" alt="" loading="lazy"></p>`,27),t=[l];function p(c,o){return a(),s("div",null,t)}const u=n(i,[["render",p],["__file","05.Nginx\u9AD8\u53EF\u7528.html.vue"]]);export{u as default};
