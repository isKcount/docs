import{_ as n}from"./_plugin-vue_export-helper.cdc0426e.js";import{o as s,c as a,f as e}from"./app.ca0279c0.js";const t={},p=e(`<h1 id="\u96C6\u7FA4\u5F3A\u5316" tabindex="-1"><a class="header-anchor" href="#\u96C6\u7FA4\u5F3A\u5316" aria-hidden="true">#</a> \u96C6\u7FA4\u5F3A\u5316</h1><h3 id="\u4E3B\u8981\u5185\u5BB9" tabindex="-1"><a class="header-anchor" href="#\u4E3B\u8981\u5185\u5BB9" aria-hidden="true">#</a> \u4E3B\u8981\u5185\u5BB9</h3><p>\u2756 K8s\u5B89\u5168\u6846\u67B6</p><p>\u2756 RBAC\u8BA4\u8BC1\u6388\u6743\u6848\u4F8B</p><p>\u2756 \u8D44\u6E90\u914D\u989D ResourceQuota</p><p>\u2756 \u8D44\u6E90\u9650\u5236 LimitRange</p><h3 id="kubernetes-\u5B89\u5168\u6846\u67B6" tabindex="-1"><a class="header-anchor" href="#kubernetes-\u5B89\u5168\u6846\u67B6" aria-hidden="true">#</a> Kubernetes \u5B89\u5168\u6846\u67B6</h3><p>K8S\u5B89\u5168\u63A7\u5236\u6846\u67B6\u4E3B\u8981\u7531\u4E0B\u97623\u4E2A\u9636\u6BB5\u8FDB\u884C\u63A7\u5236\uFF0C\u6BCF\u4E00\u4E2A\u9636\u6BB5\u90FD\u652F\u6301 \u63D2\u4EF6\u65B9\u5F0F\uFF0C\u901A\u8FC7API Server\u914D\u7F6E\u6765\u542F\u7528\u63D2\u4EF6\u3002</p><ol><li><code>Authentication</code>\uFF08\u9274\u6743\uFF09</li><li><code>Authorization</code>\uFF08\u6388\u6743\uFF09</li><li><code>Admission Control</code>\uFF08\u51C6\u5165\u63A7\u5236\uFF09</li></ol><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204120958219.png" alt="image-20220412095759505" style="zoom:80%;"><h4 id="\u9274\u6743-authentication" tabindex="-1"><a class="header-anchor" href="#\u9274\u6743-authentication" aria-hidden="true">#</a> \u9274\u6743\uFF08Authentication\uFF09</h4><p><code>K8s Apiserver\u63D0\u4F9B\u4E09\u79CD\u5BA2\u6237\u7AEF\u8EAB\u4EFD\u8BA4\u8BC1</code>\uFF1A</p><ul><li><strong>HTTPS \u8BC1\u4E66\u8BA4\u8BC1</strong>\uFF1A\u57FA\u4E8ECA\u8BC1\u4E66\u7B7E\u540D\u7684\u6570\u5B57\u8BC1\u4E66\u8BA4\u8BC1\uFF08kubeconfig\uFF09</li><li><strong>HTTP Token\u8BA4\u8BC1</strong>\uFF1A\u901A\u8FC7\u4E00\u4E2AToken\u6765\u8BC6\u522B\u7528\u6237\uFF08serviceaccount\uFF09</li><li><strong>HTTP Base\u8BA4\u8BC1</strong>\uFF1A\u7528\u6237\u540D+\u5BC6\u7801\u7684\u65B9\u5F0F\u8BA4\u8BC1\uFF081.19\u7248\u672C\u5F03\u7528\uFF09</li></ul><h4 id="\u6388\u6743-authorization" tabindex="-1"><a class="header-anchor" href="#\u6388\u6743-authorization" aria-hidden="true">#</a> \u6388\u6743\uFF08Authorization\uFF09</h4><p><code>RBAC\uFF08Role-Based Access Control\uFF0C\u57FA\u4E8E\u89D2\u8272\u7684\u8BBF\u95EE\u63A7\u5236\uFF09</code>\uFF1A\u8D1F\u8D23\u5B8C\u6210\u6388\u6743\uFF08Authorization\uFF09\u5DE5\u4F5C\u3002</p><p>RBAC\u6839\u636EAPI\u8BF7\u6C42\u5C5E\u6027\uFF0C\u51B3\u5B9A\u5141\u8BB8\u8FD8\u662F\u62D2\u7EDD\u3002</p><p>\u6BD4\u8F83\u5E38\u89C1\u7684\u6388\u6743\u7EF4\u5EA6\uFF1A</p><ol><li>user\uFF1A\u7528\u6237\u540D</li><li>group\uFF1A\u7528\u6237\u5206\u7EC4</li><li>\u8D44\u6E90\uFF0C\u4F8B\u5982pod\u3001deployment</li><li>\u8D44\u6E90\u64CD\u4F5C\u65B9\u6CD5\uFF1Aget\uFF0Clist\uFF0Ccreate\uFF0Cupdate\uFF0Cpatch\uFF0Cwatch\uFF0Cdelete</li><li>\u547D\u540D\u7A7A\u95F4</li><li>API\u7EC4</li></ol><h4 id="\u51C6\u5165\u63A7\u5236-admission-control" tabindex="-1"><a class="header-anchor" href="#\u51C6\u5165\u63A7\u5236-admission-control" aria-hidden="true">#</a> \u51C6\u5165\u63A7\u5236\uFF08Admission Control\uFF09</h4><p>Adminssion Control\u5B9E\u9645\u4E0A\u662F\u4E00\u4E2A\u51C6\u5165\u63A7\u5236\u5668\u63D2\u4EF6\u5217\u8868\uFF0C\u53D1\u9001\u5230API Server\u7684\u8BF7\u6C42\u90FD\u9700\u8981\u7ECF\u8FC7\u8FD9\u4E2A\u5217\u8868\u4E2D\u7684\u6BCF\u4E2A\u51C6\u5165\u63A7\u5236\u5668 \u63D2\u4EF6\u7684\u68C0\u67E5\uFF0C\u68C0\u67E5\u4E0D\u901A\u8FC7\uFF0C\u5219\u62D2\u7EDD\u8BF7\u6C42\u3002</p><p><strong>\u542F\u7528\u4E00\u4E2A\u51C6\u5165\u63A7\u5236\u5668\uFF1A</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kube-apiserver --enable-admission-plugins<span class="token operator">=</span>NamespaceLifecycle,LimitRanger <span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>\u5173\u95ED\u4E00\u4E2A\u51C6\u5165\u63A7\u5236\u5668\uFF1A</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kube-apiserver --disable-admission-plugins<span class="token operator">=</span>PodNodeSelector,AlwaysDeny <span class="token punctuation">..</span>. 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>\u67E5\u770B\u9ED8\u8BA4\u542F\u7528\uFF1A</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> kube-apiserver-k8s-master <span class="token parameter variable">-n</span> kube-system -- kube-apiserver <span class="token parameter variable">-h</span> <span class="token operator">|</span> <span class="token function">grep</span> enable-admission-plugins
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="\u57FA\u4E8E\u89D2\u8272\u7684\u6743\u9650\u8BBF\u95EE\u63A7\u5236-rbac" tabindex="-1"><a class="header-anchor" href="#\u57FA\u4E8E\u89D2\u8272\u7684\u6743\u9650\u8BBF\u95EE\u63A7\u5236-rbac" aria-hidden="true">#</a> \u57FA\u4E8E\u89D2\u8272\u7684\u6743\u9650\u8BBF\u95EE\u63A7\u5236\uFF1ARBAC</h4><p><code>RBAC\uFF08Role-Based Access Control\uFF0C\u57FA\u4E8E\u89D2\u8272\u7684\u8BBF\u95EE\u63A7\u5236\uFF09</code>\uFF0C \u662FK8s\u9ED8\u8BA4\u6388\u6743\u7B56\u7565\uFF0C\u5E76\u4E14\u662F\u52A8\u6001\u914D\u7F6E\u7B56\u7565\uFF08\u4FEE\u6539\u5373\u65F6\u751F\u6548\uFF09\u3002</p><p><strong>\u4E3B\u4F53\uFF08subject\uFF09</strong></p><ul><li>User\uFF1A\u7528\u6237</li><li>Group\uFF1A\u7528\u6237\u7EC4</li><li>ServiceAccount\uFF1A\u670D\u52A1\u8D26\u53F7</li></ul><p><strong>\u89D2\u8272</strong></p><ul><li>Role\uFF1A\u6388\u6743\u7279\u5B9A\u547D\u540D\u7A7A\u95F4\u7684\u8BBF\u95EE\u6743\u9650</li><li>ClusterRole\uFF1A\u6388\u6743\u6240\u6709\u547D\u540D\u7A7A\u95F4\u7684\u8BBF\u95EE\u6743\u9650</li></ul><p><strong>\u89D2\u8272\u7ED1\u5B9A</strong></p><ul><li>RoleBinding\uFF1A\u5C06\u89D2\u8272\u7ED1\u5B9A\u5230\u4E3B\u4F53\uFF08\u5373subject\uFF09</li><li>ClusterRoleBinding\uFF1A\u5C06\u96C6\u7FA4\u89D2\u8272\u7ED1\u5B9A\u5230\u4E3B\u4F53</li></ul><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204121007979.png" alt="image-20220412100724042" style="zoom:80%;"><blockquote><p>\u6CE8\uFF1ARoleBinding\u5728\u6307\u5B9A\u547D\u540D\u7A7A\u95F4\u4E2D\u6267\u884C\u6388\u6743\uFF0CClusterRoleBinding\u5728\u96C6\u7FA4\u8303\u56F4\u6267\u884C\u6388\u6743\u3002</p></blockquote><h4 id="\u57FA\u4E8E\u89D2\u8272\u7684\u6743\u9650\u8BBF\u95EE\u63A7\u5236-rbac-1" tabindex="-1"><a class="header-anchor" href="#\u57FA\u4E8E\u89D2\u8272\u7684\u6743\u9650\u8BBF\u95EE\u63A7\u5236-rbac-1" aria-hidden="true">#</a> \u57FA\u4E8E\u89D2\u8272\u7684\u6743\u9650\u8BBF\u95EE\u63A7\u5236\uFF1ARBAC</h4><p>k8s\u9884\u5B9A\u597D\u4E86\u56DB\u4E2A\u96C6\u7FA4\u89D2\u8272\u4F9B\u7528\u6237\u4F7F\u7528\uFF0C\u4F7F\u7528kubectl get clusterrole\u67E5\u770B\uFF0C\u5176\u4E2Dsystemd:\u5F00\u5934\u7684\u4E3A\u7CFB\u7EDF\u5185\u90E8\u4F7F\u7528\u3002</p><table><thead><tr><th>\u5185\u7F6E\u96C6\u7FA4\u89D2\u8272</th><th>\u63CF\u8FF0</th></tr></thead><tbody><tr><td>cluster-admin</td><td>\u8D85\u7EA7\u7BA1\u7406\u5458\uFF0C\u5BF9\u96C6\u7FA4\u6240\u6709\u6743\u9650</td></tr><tr><td>admin</td><td>\u4E3B\u8981\u7528\u4E8E\u6388\u6743\u547D\u540D\u7A7A\u95F4\u6240\u6709\u8BFB\u5199\u6743\u9650</td></tr><tr><td>edit</td><td>\u5141\u8BB8\u5BF9\u547D\u540D\u7A7A\u95F4\u5927\u591A\u6570\u5BF9\u8C61\u8BFB\u5199\u64CD\u4F5C\uFF0C\u4E0D\u5141\u8BB8\u67E5\u770B\u6216\u8005\u4FEE\u6539\u89D2\u8272\uFF0C\u89D2\u8272\u7ED1\u5B9A</td></tr><tr><td>view</td><td>\u5141\u8BB8\u5BF9\u547D\u540D\u7A7A\u95F4\u5927\u591A\u6570\u5BF9\u8C61\u53EA\u8BFB\u6743\u9650\uFF0C\u4E0D\u5141\u8BB8\u67E5\u770B\u89D2\u8272\u3001\u89D2\u8272\u7ED1\u5B9A\u548Csecret</td></tr></tbody></table><h3 id="\u6848\u4F8B\u5B9E\u65BD" tabindex="-1"><a class="header-anchor" href="#\u6848\u4F8B\u5B9E\u65BD" aria-hidden="true">#</a> \u6848\u4F8B\u5B9E\u65BD</h3><h4 id="\u6848\u4F8B1-\u5BF9\u7528\u6237\u6388\u6743\u8BBF\u95EEk8s-tls\u8BC1\u4E66" tabindex="-1"><a class="header-anchor" href="#\u6848\u4F8B1-\u5BF9\u7528\u6237\u6388\u6743\u8BBF\u95EEk8s-tls\u8BC1\u4E66" aria-hidden="true">#</a> \u6848\u4F8B1\uFF1A\u5BF9\u7528\u6237\u6388\u6743\u8BBF\u95EEK8s\uFF08TLS\u8BC1\u4E66\uFF09</h4><p>\u9700\u6C42\uFF1A\u4E3A\u6307\u5B9A\u7528\u6237\u6388\u6743\u8BBF\u95EE\u4E0D\u540C\u547D\u540D\u7A7A\u95F4\u6743\u9650\uFF0C\u4F8B\u5982\u65B0\u5165\u804C\u4E00\u4E2A\u5C0F\u5F1F\uFF0C\u5E0C\u671B\u8BA9\u4ED6\u5148\u719F\u6089K8s\u96C6 \u7FA4\uFF0C\u4E3A\u4E86\u5B89\u5168\u6027\uFF0C\u5148\u4E0D\u80FD\u7ED9\u4ED6\u592A\u5927\u6743\u9650\uFF0C\u56E0\u6B64\u5148\u7ED9\u4ED6\u6388\u6743\u8BBF\u95EEdefault\u547D\u540D\u7A7A\u95F4Pod\u8BFB\u53D6\u6743\u9650\u3002 \u5B9E\u65BD\u5927\u81F4\u6B65\u9AA4\uFF1A</p><ol><li><code>\u7528K8S CA\u7B7E\u53D1\u5BA2\u6237\u7AEF\u8BC1\u4E66</code></li><li><code>\u751F\u6210kubeconfig\u6388\u6743\u6587\u4EF6</code></li><li><code>\u521B\u5EFARBAC\u6743\u9650\u7B56\u7565</code></li><li><code>\u6307\u5B9Akubeconfig\u6587\u4EF6\u6D4B\u8BD5\u6743\u9650\uFF1Akubectl get pods --kubeconfig=./aliang.kubeconfig</code></li></ol><h5 id="\u5BF9\u7528\u6237\u6388\u6743\u8BBF\u95EEk8s-tls\u8BC1\u4E66" tabindex="-1"><a class="header-anchor" href="#\u5BF9\u7528\u6237\u6388\u6743\u8BBF\u95EEk8s-tls\u8BC1\u4E66" aria-hidden="true">#</a> \u5BF9\u7528\u6237\u6388\u6743\u8BBF\u95EEK8s\uFF08TLS\u8BC1\u4E66\uFF09</h5><ul><li>\u5229\u7528<code>cfssl\u5DE5\u5177</code>\u751F\u6210\u8BC1\u4E66</li><li>\u5728\u5F53\u524D\u7684\u76EE\u5F55\u4E0B\u4F1A\u751F\u6210\u65B0\u7684<code>TLS\u81EA\u7B7E\u540D\u8BC1\u4E66</code></li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~/RBAC<span class="token punctuation">]</span><span class="token comment"># ./cert.sh </span>
<span class="token number">2022</span>/04/12 02:42:42 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2022</span>/04/12 02:42:42 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2022</span>/04/12 02:42:42 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2022</span>/04/12 02:42:43 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2022</span>/04/12 02:42:43 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">66521569005511148107562700581322500464829062465</span>
<span class="token number">2022</span>/04/12 02:42:43 <span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span> This certificate lacks a <span class="token string">&quot;hosts&quot;</span> field. This makes it unsuitable <span class="token keyword">for</span>
websites. For <span class="token function">more</span> information see the Baseline Requirements <span class="token keyword">for</span> the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum <span class="token punctuation">(</span>https://cabforum.org<span class="token punctuation">)</span><span class="token punctuation">;</span>
specifically, section <span class="token number">10.2</span>.3 <span class="token punctuation">(</span><span class="token string">&quot;Information Requirements&quot;</span><span class="token punctuation">)</span>.

<span class="token punctuation">[</span>root@master01:~/RBAC<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">48</span>
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">997</span> Apr <span class="token number">12</span> 02:42 aliang.csr
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">219</span> Apr <span class="token number">12</span> 02:42 aliang-csr.json
-rw------- <span class="token number">1</span> root root <span class="token number">1679</span> Apr <span class="token number">12</span> 02:42 aliang-key.pem
-rw------- <span class="token number">1</span> root root <span class="token number">5759</span> Apr <span class="token number">12</span> 02:44 aliang.kubeconfig
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1277</span> Apr <span class="token number">12</span> 02:42 aliang.pem
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">292</span> Apr <span class="token number">12</span> 02:42 ca-config.json
-rwxr-xr-x <span class="token number">1</span> root root  <span class="token number">741</span> Sep  <span class="token number">1</span>  <span class="token number">2019</span> cert.sh
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1048</span> Jun <span class="token number">23</span>  <span class="token number">2021</span> k8s-api-test.py
-rwxr-xr-x <span class="token number">1</span> root root  <span class="token number">622</span> Apr <span class="token number">12</span> 02:41 kubeconfig.sh
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">664</span> Jun <span class="token number">14</span>  <span class="token number">2021</span> python-pod-sa.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="\u751F\u6210kubeconfig\u6388\u6743\u6587\u4EF6" tabindex="-1"><a class="header-anchor" href="#\u751F\u6210kubeconfig\u6388\u6743\u6587\u4EF6" aria-hidden="true">#</a> \u751F\u6210kubeconfig\u6388\u6743\u6587\u4EF6</h5><ul><li>\u4F7F\u7528kubectl config\u547D\u4EE4\u751F\u6210\u65B0\u7684\u6388\u6743\u6587\u4EF6</li><li>\u914D\u7F6E\u5BA2\u6237\u7AEF\u8BA4\u8BC1\u4EE5\u53CA\u914D\u7F6E\u96C6\u7FA4\u4E0A\u4E0B\u6587</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~/RBAC<span class="token punctuation">]</span><span class="token comment"># kubectl config set-cluster kubernetes \\</span>
  --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.crt <span class="token punctuation">\\</span>
  --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\\</span>
  <span class="token parameter variable">--server</span><span class="token operator">=</span>https://10.11.121.118:6443 <span class="token punctuation">\\</span>
  <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>aliang.kubeconfig
Cluster <span class="token string">&quot;kubernetes&quot;</span> set.

<span class="token comment">#\u8BBE\u7F6E\u5BA2\u6237\u7AEF\u8BA4\u8BC1</span>
<span class="token punctuation">[</span>root@master01:~/RBAC<span class="token punctuation">]</span><span class="token comment"># kubectl config set-credentials aliang \\</span>
  --client-key<span class="token operator">=</span>aliang-key.pem <span class="token punctuation">\\</span>
  --client-certificate<span class="token operator">=</span>aliang.pem <span class="token punctuation">\\</span>
  --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\\</span>
  <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>aliang.kubeconfig
User <span class="token string">&quot;aliang&quot;</span> set.

<span class="token comment">#\u8BBE\u7F6E\u9ED8\u8BA4\u4E0A\u4E0B\u6587</span>
<span class="token punctuation">[</span>root@master01:~/RBAC<span class="token punctuation">]</span><span class="token comment"># kubectl config set-context kubernetes \\</span>
  <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\\</span>
  <span class="token parameter variable">--user</span><span class="token operator">=</span>aliang <span class="token punctuation">\\</span>
  <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>aliang.kubeconfig
Context <span class="token string">&quot;kubernetes&quot;</span> created.

<span class="token comment">#\u8BBE\u7F6E\u5F53\u524D\u4F7F\u7528\u914D\u7F6E</span>
<span class="token punctuation">[</span>root@master01:~/RBAC<span class="token punctuation">]</span><span class="token comment"># kubectl config use-context kubernetes --kubeconfig=aliang.kubeconfig</span>
Switched to context <span class="token string">&quot;kubernetes&quot;</span><span class="token builtin class-name">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6B64\u65F6\u6D4B\u8BD5\u4F1A\u53D1\u73B0\u62A5\u9519</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~/RBAC<span class="token punctuation">]</span><span class="token comment"># kubectl get pods --kubeconfig=aliang.kubeconfig </span>
Error from server <span class="token punctuation">(</span>Forbidden<span class="token punctuation">)</span>: pods is forbidden: User <span class="token string">&quot;aliang&quot;</span> cannot list resource <span class="token string">&quot;pods&quot;</span> <span class="token keyword">in</span> API group <span class="token string">&quot;&quot;</span> <span class="token keyword">in</span> the namespace <span class="token string">&quot;default&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="\u521B\u5EFArbac\u7B56\u7565" tabindex="-1"><a class="header-anchor" href="#\u521B\u5EFArbac\u7B56\u7565" aria-hidden="true">#</a> \u521B\u5EFARBAC\u7B56\u7565</h5><ul><li>\u521B\u5EFARole\u7684\u540D\u79F0\u4E3A<code>pod-reader</code></li><li>\u521B\u5EFARole\u7ED1\u5B9A<code>pods</code>\u548C<code>services</code>\u8D44\u6E90</li><li>Role\u7684\u6743\u9650\u4E3A<code>get\u3001watch\u3001list</code></li><li>\u7ED1\u5B9ARoleBinding\u4F7F\u7528<code>User\u4E3Aaliang</code></li><li>\u7ED1\u5B9ARoleBinding\u7684<code>Role\u4E3Apod-preader</code></li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>reader
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;pods&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;services&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;watch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">]</span>

<span class="token punctuation">---</span>

<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> read<span class="token punctuation">-</span>pods
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> User
  <span class="token key atrule">name</span><span class="token punctuation">:</span> aliang
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>reader
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/RBAC<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f rbac.yaml </span>
role.rbac.authorization.k8s.io/pod<span class="token punctuation">-</span>reader created
rolebinding.rbac.authorization.k8s.io/read<span class="token punctuation">-</span>pods created
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6D4B\u8BD5\u67E5\u770B\u53EF\u4EE5\u53D1\u73B0pods\u548Cservice\u7684\u8D44\u6E90\u53EF\u4EE5\u4F7F\u7528\u7528\u6237\u8BBF\u95EE\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~/RBAC<span class="token punctuation">]</span><span class="token comment"># kubectl get pods  --kubeconfig=aliang.kubeconfig    </span>
No resources found <span class="token keyword">in</span> default namespace.

<span class="token punctuation">[</span>root@master01:~/RBAC<span class="token punctuation">]</span><span class="token comment"># kubectl get svc --kubeconfig=aliang.kubeconfig </span>
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
kubernetes   ClusterIP   <span class="token number">10.96</span>.0.1    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP   4d23h
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>**\u7528\u6237\u7EC4\uFF1A**\u7528\u6237\u7EC4\u7684\u597D\u5904\u662F\u65E0\u9700\u5355\u72EC\u4E3A\u67D0\u4E2A\u7528\u6237\u521B\u5EFA\u6743\u9650\uFF0C\u7EDF\u4E00\u4E3A\u8FD9\u4E2A\u7EC4\u540D\u8FDB \u884C\u6388\u6743\uFF0C\u6240\u6709\u7684\u7528\u6237\u90FD\u4EE5\u7EC4\u7684\u8EAB\u4EFD\u8BBF\u95EE\u8D44\u6E90\u3002</p></blockquote><p>\u4F8B\u5982\uFF1A\u4E3Adev\u7528\u6237\u7EC4\u7EDF\u4E00\u6388\u6743</p><ol><li>\u5C06certs.sh\u6587\u4EF6\u4E2D\u7684aliang-csr.json\u4E0B\u7684O\u5B57\u6BB5\u6539\u4E3Adev\uFF0C\u5E76\u91CD\u65B0\u751F\u6210\u8BC1 \u4E66\u548Ckubeconfig\u6587\u4EF6</li><li>\u5C06dev\u7528\u6237\u7EC4\u7ED1\u5B9ARole\uFF08pod-reader\uFF09</li><li>\u6D4B\u8BD5\uFF0C\u53EA\u8981O\u5B57\u6BB5\u90FD\u662Fdev\uFF0C\u8FD9\u4E9B\u7528\u6237\u6301\u6709\u7684kubeconfig\u6587\u4EF6\u90FD\u62E5\u6709\u76F8 \u540C\u7684\u6743\u9650</li></ol><h4 id="\u6848\u4F8B2-\u5BF9\u5E94\u7528\u7A0B\u5E8F\u6388\u6743\u8BBF\u95EEk8s-sa" tabindex="-1"><a class="header-anchor" href="#\u6848\u4F8B2-\u5BF9\u5E94\u7528\u7A0B\u5E8F\u6388\u6743\u8BBF\u95EEk8s-sa" aria-hidden="true">#</a> \u6848\u4F8B2\uFF1A\u5BF9\u5E94\u7528\u7A0B\u5E8F\u6388\u6743\u8BBF\u95EEK8s \uFF08SA\uFF09</h4><p><strong>\u5148\u4E86\u89E3\u4E0BServiceAccount\uFF0C\u7B80\u79F0SA\uFF0C\u662F\u4E00\u79CD\u7528\u4E8E\u8BA9\u7A0B\u5E8F\u8BBF\u95EEK8s API\u7684\u670D\u52A1\u8D26\u53F7\u3002</strong></p><ul><li>\u5F53\u521B\u5EFAnamespace\u65F6\uFF0C\u4F1A\u81EA\u52A8\u521B\u5EFA\u4E00\u4E2A\u540D\u4E3Adefault\u7684SA\uFF0C\u8FD9\u4E2ASA\u6CA1\u6709\u7ED1\u5B9A\u4EFB\u4F55\u6743\u9650</li><li>\u5F53default SA\u521B\u5EFA\u65F6\uFF0C\u4F1A\u81EA\u52A8\u521B\u5EFA\u4E00\u4E2Adefault-token-xxx\u7684secret\uFF0C\u5E76\u81EA\u52A8\u5173\u8054\u5230SA</li><li>\u5F53\u521B\u5EFAPod\u65F6\uFF0C\u5982\u679C\u6CA1\u6709\u6307\u5B9ASA\uFF0C\u4F1A\u81EA\u52A8\u4E3Apod\u4EE5volume\u65B9\u5F0F\u6302\u8F7D\u8FD9\u4E2Adefault SA\uFF0C\u5728\u5BB9 \u5668\u76EE\u5F55\uFF1A<code>/var/run/secrets/kubernetes.io/serviceaccount</code></li></ul><p>\u9A8C\u8BC1\u9ED8\u8BA4SA\u6743\u9650\uFF1A</p><blockquote><p>kubectl --as=system:serviceaccount:default:default get pods</p></blockquote><p>\u9700\u6C42\uFF1A\u6388\u6743\u5BB9\u5668\u4E2DPython\u7A0B\u5E8F\u5BF9K8s API\u8BBF\u95EE\u6743\u9650 \u5B9E\u65BD\u5927\u81F4\u6B65\u9AA4\uFF1A</p><ol><li><code>\u521B\u5EFARole</code></li><li><code>\u521B\u5EFAServiceAccount</code></li><li><code>\u5C06ServiceAccount\u4E0ERole\u7ED1\u5B9A</code></li><li><code>\u4E3APod\u6307\u5B9A\u81EA\u5B9A\u4E49\u7684SA</code></li><li><code>\u8FDB\u5165\u5BB9\u5668\u91CC\u6267\u884CPython\u7A0B\u5E8F\u6D4B\u8BD5\u64CD\u4F5CK8s API\u6743\u9650</code></li></ol><h5 id="\u521B\u5EFArole" tabindex="-1"><a class="header-anchor" href="#\u521B\u5EFArole" aria-hidden="true">#</a> \u521B\u5EFARole</h5><ul><li>\u521B\u5EFA\u540D\u79F0\u4E3A<code>py-role</code>\u7684Role</li><li>\u53EF\u8BBF\u95EE\u8D44\u6E90\u4E3A<code>pods</code></li><li>\u5BF9pods\u8D44\u6E90\u53EF\u6267\u884C<code>get\u3001watch\u3001list</code>\u7684\u6743\u9650</li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">name</span><span class="token punctuation">:</span> py<span class="token punctuation">-</span>role
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;pods&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;watch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="\u521B\u5EFAserviceaccount" tabindex="-1"><a class="header-anchor" href="#\u521B\u5EFAserviceaccount" aria-hidden="true">#</a> \u521B\u5EFAServiceAccount</h5><ul><li>\u521B\u5EFAserviceaccount\u7684\u540D\u79F0\u4E3A<code>py-role</code></li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> py<span class="token punctuation">-</span>k8s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="\u5C06serviceaccount\u4E0Erole\u7ED1\u5B9A" tabindex="-1"><a class="header-anchor" href="#\u5C06serviceaccount\u4E0Erole\u7ED1\u5B9A" aria-hidden="true">#</a> \u5C06ServiceAccount\u4E0ERole\u7ED1\u5B9A</h5><ul><li>\u521B\u5EFA\u540D\u79F0\u4E3A<code>py-role</code>\u7684RoleBinding</li><li>\u7ED1\u5B9A\u9ED8\u8BA4\u547D\u540D\u7A7A\u95F4\u7684<code>py-k8s</code>\u540D\u79F0\u7684sa</li><li>\u7ED1\u5B9A<code>py-role</code>\u7684Role</li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> py<span class="token punctuation">-</span>role
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
  <span class="token key atrule">name</span><span class="token punctuation">:</span> py<span class="token punctuation">-</span>k8s
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
  <span class="token key atrule">name</span><span class="token punctuation">:</span> py<span class="token punctuation">-</span>role
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="\u521B\u5EFA\u7ED1\u5B9Asa\u7684pod" tabindex="-1"><a class="header-anchor" href="#\u521B\u5EFA\u7ED1\u5B9Asa\u7684pod" aria-hidden="true">#</a> \u521B\u5EFA\u7ED1\u5B9ASA\u7684Pod</h5><ul><li>\u521B\u5EFA\u540D\u79F0\u4E3A<code>py-k8s</code>\u7684Pod</li><li>\u7ED1\u5B9ASA\u8BA4\u8BC1\u4E3A<code>py-k8s</code></li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> py<span class="token punctuation">-</span>k8s
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> py<span class="token punctuation">-</span>k8s
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> python<span class="token punctuation">:</span><span class="token number">3</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> python
    <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> sleep
    <span class="token punctuation">-</span> 24h
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u521B\u5EFA\u6D4B\u8BD5\uFF0C\u5E76\u4F7F\u7528Python\u811A\u672C\u901A\u8FC7\u8BBF\u95EESA\u7684\u8BA4\u8BC1\uFF0C\u8FDE\u63A5K8S\u7684apiserver\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~/RBAC<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f python-pod-sa.yaml</span>
serviceaccount/py-k8s created
role.rbac.authorization.k8s.io/py-role created
rolebinding.rbac.authorization.k8s.io/py-role created
pod/py-k8s created

<span class="token punctuation">[</span>root@master01:~/RBAC<span class="token punctuation">]</span><span class="token comment"># cp k8s-api-test.py py-k8s:/opt/</span>
<span class="token punctuation">[</span>root@master01:~/RBAC<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it py-k8s -- bash</span>
root@py-k8s:/<span class="token comment"># pip install kubernetes</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u67E5\u770B\u5F53\u524D\u7684\u811A\u672C\u5E76\u8FD0\u884C\u67E5\u770B\u7ED3\u679C\uFF1A</p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code>root@py<span class="token operator">-</span>k8s<span class="token punctuation">:</span><span class="token operator">/</span>opt<span class="token comment"># cat k8s-api-test.py</span>
<span class="token keyword">from</span> kubernetes <span class="token keyword">import</span> client<span class="token punctuation">,</span> config

<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&#39;/var/run/secrets/kubernetes.io/serviceaccount/token&#39;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
     token <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

configuration <span class="token operator">=</span> client<span class="token punctuation">.</span>Configuration<span class="token punctuation">(</span><span class="token punctuation">)</span>
configuration<span class="token punctuation">.</span>host <span class="token operator">=</span> <span class="token string">&quot;https://kubernetes&quot;</span>  <span class="token comment"># APISERVER\u5730\u5740</span>
configuration<span class="token punctuation">.</span>ssl_ca_cert<span class="token operator">=</span><span class="token string">&quot;/var/run/secrets/kubernetes.io/serviceaccount/ca.crt&quot;</span>  <span class="token comment"># CA\u8BC1\u4E66</span>
configuration<span class="token punctuation">.</span>verify_ssl <span class="token operator">=</span> <span class="token boolean">True</span>   <span class="token comment"># \u542F\u7528\u8BC1\u4E66\u9A8C\u8BC1</span>
configuration<span class="token punctuation">.</span>api_key <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;authorization&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Bearer &quot;</span> <span class="token operator">+</span> token<span class="token punctuation">}</span>  <span class="token comment"># \u6307\u5B9AToken\u5B57\u7B26\u4E32</span>
client<span class="token punctuation">.</span>Configuration<span class="token punctuation">.</span>set_default<span class="token punctuation">(</span>configuration<span class="token punctuation">)</span>
apps_api <span class="token operator">=</span> client<span class="token punctuation">.</span>AppsV1Api<span class="token punctuation">(</span><span class="token punctuation">)</span>
core_api <span class="token operator">=</span> client<span class="token punctuation">.</span>CoreV1Api<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;###### Deployment\u5217\u8868 ######&quot;</span><span class="token punctuation">)</span>
  <span class="token comment">#\u5217\u51FAdefault\u547D\u540D\u7A7A\u95F4\u6240\u6709deployment\u540D\u79F0</span>
  <span class="token keyword">for</span> dp <span class="token keyword">in</span> apps_api<span class="token punctuation">.</span>list_namespaced_deployment<span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>dp<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token keyword">except</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\u6CA1\u6709\u6743\u9650\u8BBF\u95EEDeployment\u8D44\u6E90\uFF01&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token comment">#\u5217\u51FAdefault\u547D\u540D\u7A7A\u95F4\u6240\u6709pod\u540D\u79F0</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;###### Pod\u5217\u8868 ######&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> po <span class="token keyword">in</span> core_api<span class="token punctuation">.</span>list_namespaced_pod<span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items<span class="token punctuation">:</span>
    	<span class="token keyword">print</span><span class="token punctuation">(</span>po<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token keyword">except</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\u6CA1\u6709\u6743\u9650\u8BBF\u95EEPod\u8D44\u6E90\uFF01&quot;</span><span class="token punctuation">)</span>

root@py<span class="token operator">-</span>k8s<span class="token punctuation">:</span><span class="token operator">/</span>opt<span class="token comment"># python3 k8s-api-test.py</span>
<span class="token comment">###### Deployment\u5217\u8868 ######</span>
\u6CA1\u6709\u6743\u9650\u8BBF\u95EEDeployment\u8D44\u6E90\uFF01
<span class="token comment">###### Pod\u5217\u8868 ######</span>
py<span class="token operator">-</span>k8s
python
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><strong>\u547D\u4EE4\u884C\u4F7F\u7528\uFF1A\u6388\u6743SA\u53EA\u80FD\u67E5\u770Btest\u547D\u540D\u7A7A\u95F4\u63A7\u5236\u5668\u7684\u6743\u9650</strong></p></blockquote><p><strong>1.\u521B\u5EFA\u89D2\u8272</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl create role role-test <span class="token parameter variable">--verb</span><span class="token operator">=</span>get,list <span class="token punctuation">\\</span> 
<span class="token parameter variable">--resource</span><span class="token operator">=</span>deployments,daemonsets,statefulsets <span class="token parameter variable">-n</span> <span class="token builtin class-name">test</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2.\u521B\u5EFA\u670D\u52A1\u8D26\u53F7</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl create serviceaccount app-demo <span class="token parameter variable">-n</span> <span class="token builtin class-name">test</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>3.\u5C06\u670D\u52A1\u8D26\u53F7\u7ED1\u5B9A\u89D2\u8272</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl create rolebinding role-test:app-demo <span class="token punctuation">\\</span> 
<span class="token parameter variable">--serviceaccount</span><span class="token operator">=</span>test:app-demo <span class="token parameter variable">--role</span><span class="token operator">=</span>role-test <span class="token parameter variable">-n</span> <span class="token builtin class-name">test</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>4.\u6D4B\u8BD5</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token parameter variable">--as</span><span class="token operator">=</span>system:serviceaccount:test:app-demo get pods <span class="token parameter variable">-n</span> <span class="token builtin class-name">test</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="\u8D44\u6E90\u914D\u989D-resourcequota" tabindex="-1"><a class="header-anchor" href="#\u8D44\u6E90\u914D\u989D-resourcequota" aria-hidden="true">#</a> \u8D44\u6E90\u914D\u989D ResourceQuota</h3><p>\u5F53\u591A\u4E2A\u56E2\u961F\u3001\u591A\u4E2A\u7528\u6237\u5171\u4EAB\u4F7F\u7528K8s\u96C6\u7FA4\u65F6\uFF0C\u4F1A\u51FA\u73B0\u4E0D\u5747\u5300\u8D44\u6E90\u4F7F\u7528\uFF0C\u9ED8\u8BA4\u60C5\u51B5\u4E0B\u5148\u5230\u5148\u5F97\uFF0C\u8FD9\u65F6\u53EF\u4EE5\u901A\u8FC7 ResourceQuota\u6765\u5BF9\u547D\u540D\u7A7A\u95F4\u8D44\u6E90\u4F7F\u7528\u603B\u91CF\u505A\u9650\u5236\uFF0C\u4ECE\u800C\u89E3\u51B3\u8FD9\u4E2A\u95EE\u9898\u3002</p><p>\u4F7F\u7528\u6D41\u7A0B\uFF1A<code>k8s\u7BA1\u7406\u5458\u4E3A\u6BCF\u4E2A\u547D\u540D\u7A7A\u95F4\u521B\u5EFA\u4E00\u4E2A\u6216\u591A\u4E2AResourceQuota\u5BF9\u8C61\uFF0C\u5B9A\u4E49\u8D44\u6E90\u4F7F\u7528\u603B\u91CF</code>\uFF0CK8s\u4F1A\u8DDF\u8E2A\u547D\u540D\u7A7A\u95F4 \u8D44\u6E90\u4F7F\u7528\u60C5\u51B5\uFF0C\u5F53\u8D85\u8FC7\u5B9A\u4E49\u7684\u8D44\u6E90\u914D\u989D\u4F1A\u8FD4\u56DE\u62D2\u7EDD\u3002</p><p>ResourceQuota\u529F\u80FD\u662F\u4E00\u4E2A\u51C6\u5165\u63A7\u5236\u63D2\u4EF6\uFF0C\u9ED8\u8BA4\u5DF2\u7ECF\u542F\u7528\u3002</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204121520062.png" alt="image-20220412151959092" loading="lazy"></p><h4 id="\u547D\u540D\u7A7A\u95F4\u8D44\u6E90\u914D\u989D" tabindex="-1"><a class="header-anchor" href="#\u547D\u540D\u7A7A\u95F4\u8D44\u6E90\u914D\u989D" aria-hidden="true">#</a> \u547D\u540D\u7A7A\u95F4\u8D44\u6E90\u914D\u989D</h4><ul><li>\u9996\u5148\u9700\u8981\u521B\u5EFA\u4E00\u4E2A\u547D\u540D\u7A7A\u95F4\uFF0C\u6211\u4EEC\u5BF9\u8FD9\u4E2A\u547D\u540D\u7A7A\u95F4\u8D44\u6E90\u8FDB\u884C\u9650\u5236</li><li>\u521B\u5EFAQuota\u8D44\u6E90\u9650\u5236\u5BF9test\u547D\u540D\u7A7A\u95F4\u8BBE\u7F6E\u8D44\u6E90\u5927\u5C0F</li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># kubectl create ns test</span>
namespace/test created
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># cat  quota.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ResourceQuota
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> compute<span class="token punctuation">-</span>resources
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hard</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests.cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;2&quot;</span>
    <span class="token key atrule">requests.memory</span><span class="token punctuation">:</span> 4Gi
    <span class="token key atrule">limits.cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;4&quot;</span>
    <span class="token key atrule">limits.memory</span><span class="token punctuation">:</span> 6Gi
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6267\u884Cyaml\u6587\u4EF6\u67E5\u770B\u5F53\u524D\u7684quota\u8D44\u6E90\u4F7F\u7528\u60C5\u51B5\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f quota.yaml</span>
resourcequota/compute-resources configured
<span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl get quota -n test</span>
NAME                AGE     REQUEST                                     LIMIT
compute-resources   8m43s   requests.cpu: <span class="token number">0</span>/2, requests.memory: <span class="token number">0</span>/4Gi   limits.cpu: <span class="token number">0</span>/4, limits.memory: <span class="token number">0</span>/6Gi
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u521B\u5EFADeployment\u5E76\u4E14\u4F7F\u7528\u4E09\u4E2A\u526F\u672C\u6570\uFF0C\u4F7F\u7528\u8D44\u6E90\u914D\u989D\uFF1A</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">limits</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 500m
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 512Mi
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 256m
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 256Mi
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u518D\u6B21\u67E5\u770B\u5F53\u524D\u7684\u8D44\u6E90\u4F7F\u7528\u60C5\u51B5\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n test</span>
NAME                     READY   STATUS    RESTARTS   AGE
nginx-646967b68d-cpwlt   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11m
nginx-646967b68d-gfz6h   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11m
nginx-646967b68d-lz5hp   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11m

<span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl get quota -n test</span>
NAME                AGE   REQUEST                                            LIMIT
compute-resources   22m   requests.cpu: 768m/2, requests.memory: 768Mi/4Gi   limits.cpu: 1500m/4, limits.memory: 1536Mi/6Gi
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u5BF9\u8C61\u6570\u91CF\u914D\u989D" tabindex="-1"><a class="header-anchor" href="#\u5BF9\u8C61\u6570\u91CF\u914D\u989D" aria-hidden="true">#</a> \u5BF9\u8C61\u6570\u91CF\u914D\u989D</h4><ul><li>\u914D\u7F6Etest\u547D\u540D\u7A7A\u95F4\u4E0B\u7684\u5BF9\u8C61\u6570\u91CF\u914D\u989D</li><li>\u63A7\u5236deployment\u7684\u6570\u91CF\u57283\u4E2A</li><li>\u63A7\u5236services\u7684\u6570\u91CF\u57283\u4E2A</li><li>\u63A7\u5236pods\u7684\u6570\u91CF\u4E3A4\u4E2A</li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ResourceQuota
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> count<span class="token punctuation">-</span>quota
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hard</span><span class="token punctuation">:</span>
    <span class="token key atrule">pods</span><span class="token punctuation">:</span> <span class="token string">&quot;4&quot;</span>
    <span class="token key atrule">count/deployments.apps</span><span class="token punctuation">:</span> <span class="token string">&quot;3&quot;</span>
    <span class="token key atrule">count/services</span><span class="token punctuation">:</span> <span class="token string">&quot;3&quot;</span>
    
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># kubectl get quota -n test</span>
NAME          AGE   REQUEST                                                       LIMIT
<span class="token key atrule">count-quota   49s   count/deployments.apps</span><span class="token punctuation">:</span> 0/3<span class="token punctuation">,</span> <span class="token key atrule">count/services</span><span class="token punctuation">:</span> 0/3<span class="token punctuation">,</span> <span class="token key atrule">pods</span><span class="token punctuation">:</span> 0/4
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u521B\u5EFADeployment\u7684\u526F\u672C\u6570\u4E3A2\u4E2A\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl create deployment nginx --image=nginx --replicas=2 -n test</span>
deployment.apps/nginx created
<span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl get  pods -n test</span>
NAME                     READY   STATUS    RESTARTS   AGE
nginx-6799fc88d8-gcnqv   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6s
nginx-6799fc88d8-vhttg   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6B64\u65F6\u67E5\u770B\u5F53\u524D\u7684\u9650\u5236\u4F7F\u7528\u60C5\u51B5\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl get quota -n test</span>
NAME          AGE    REQUEST                                                       LIMIT
count-quota   2m2s   count/deployments.apps: <span class="token number">1</span>/3, count/services: <span class="token number">0</span>/3, pods: <span class="token number">2</span>/4
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u73B0\u5728\u6211\u4EEC\u5C06Deployment\u7684\u526F\u672C\u6570\u6269\u5BB9\u52305\u4E2A\u526F\u672C\u770B\u770B\u4F1A\u53D1\u751F\u4EC0\u4E48\uFF1A</p><ol><li><code>Deployment\u7684\u526F\u672C\u6570\u5E76\u6CA1\u6709\u6269\u5BB9\u52304</code></li><li><code>\u5F53\u524D\u7684quota\u9650\u5236\u91CC\uFF0CDeployment\u7684\u8D44\u6E90\u8017\u5C3D</code></li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl scale deployment nginx --replicas=5 -n test</span>
deployment.apps/nginx scaled

<span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span> <span class="token comment"># kubectl get pods -n test</span>
NAME                     READY   STATUS    RESTARTS   AGE
nginx-6799fc88d8-2nkjg   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          21s
nginx-6799fc88d8-fnmhj   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          21s
nginx-6799fc88d8-gcnqv   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          71s
nginx-6799fc88d8-vhttg   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          71s

<span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl get quota -n test</span>
NAME          AGE   REQUEST                                                       LIMIT
count-quota   3m    count/deployments.apps: <span class="token number">1</span>/3, count/services: <span class="token number">0</span>/3, pods: <span class="token number">4</span>/4
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u8D44\u6E90\u9650\u5236-limitrange" tabindex="-1"><a class="header-anchor" href="#\u8D44\u6E90\u9650\u5236-limitrange" aria-hidden="true">#</a> \u8D44\u6E90\u9650\u5236 LimitRange</h3><p>\u9ED8\u8BA4\u60C5\u51B5\u4E0B\uFF0CK8s\u96C6\u7FA4\u4E0A\u7684\u5BB9\u5668\u5BF9\u8BA1\u7B97\u8D44\u6E90\u6CA1\u6709\u4EFB\u4F55\u9650\u5236\uFF0C\u53EF\u80FD\u4F1A\u5BFC\u81F4\u4E2A\u522B\u5BB9\u5668\u8D44\u6E90\u8FC7\u5927\u5BFC\u81F4\u5F71\u54CD\u5176\u4ED6\u5BB9\u5668\u6B63\u5E38\u5DE5 \u4F5C\uFF0C\u8FD9\u65F6\u53EF\u4EE5\u4F7F\u7528LimitRange\u5B9A\u4E49\u5BB9\u5668\u9ED8\u8BA4CPU\u548C\u5185\u5B58\u8BF7\u6C42\u503C\u6216\u8005\u6700\u5927\u4E0A\u9650\u3002</p><p>LimitRange\u9650\u5236\u7EF4\u5EA6\uFF1A</p><ul><li>\u9650\u5236\u5BB9\u5668\u914D\u7F6E<code>requests.cpu/memory\uFF0Climits.cpu/memory</code>\u7684\u6700\u5C0F\u3001\u6700\u5927\u503C</li><li>\u9650\u5236\u5BB9\u5668\u914D\u7F6E<code>requests.cpu/memory\uFF0Climits.cpu/memory</code>\u7684\u9ED8\u8BA4\u503C</li><li>\u9650\u5236PVC\u914D\u7F6E<code>requests.storage</code>\u7684\u6700\u5C0F\u3001\u6700\u5927\u503C</li></ul><h4 id="\u8BA1\u7B97\u8D44\u6E90\u5927\u5C0F\u9650\u5236" tabindex="-1"><a class="header-anchor" href="#\u8BA1\u7B97\u8D44\u6E90\u5927\u5C0F\u9650\u5236" aria-hidden="true">#</a> \u8BA1\u7B97\u8D44\u6E90\u5927\u5C0F\u9650\u5236</h4><ul><li>\u521B\u5EFA\u4E00\u4E2ALimitRange\u7684\u8D44\u6E90</li><li>\u8BBE\u7F6Ecpu\u6700\u5C0F\u80FD\u8BBE\u7F6E\u4E3A<code>200m\uFF0C\u6700\u59271\u4E2A</code></li><li>\u8BBE\u7F6E\u5185\u5B58\u6700\u5C0F\u80FD\u8BBE\u7F6E\u4E3A<code>200Mi\uFF0C\u6700\u59271Gi</code></li><li>\u4F4E\u4E8E\u6700\u5C0F\u7684\u8BF7\u6C42\u6216\u8005\u8D85\u8FC7\u6700\u5927\u7684\u8BF7\u6C42\u5C06\u4F1A\u62A5\u9519</li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> LimitRange
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cpu<span class="token punctuation">-</span>memory<span class="token punctuation">-</span>min<span class="token punctuation">-</span>max
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">limits</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">max</span><span class="token punctuation">:</span> <span class="token comment"># \u5BB9\u5668\u80FD\u8BBE\u7F6Elimit\u7684\u6700\u5927\u503C</span>
      <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi
    <span class="token key atrule">min</span><span class="token punctuation">:</span> <span class="token comment"># \u5BB9\u5668\u80FD\u8BBE\u7F6Erequest\u7684\u6700\u5C0F\u503C</span>
      <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 200m
      <span class="token key atrule">memory</span><span class="token punctuation">:</span> 200Mi
    <span class="token key atrule">type</span><span class="token punctuation">:</span> Container
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u521B\u5EFA\u4E00\u4E2APod\u67E5\u770B\u8D44\u6E90\u4F7F\u7528\u60C5\u51B5\uFF1A</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/work<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f pod.yaml</span>
pod/nginx created
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/work<span class="token punctuation">]</span><span class="token comment"># cat pod.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">limits</span><span class="token punctuation">:</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 500m
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> 256Mi
      <span class="token key atrule">requests</span><span class="token punctuation">:</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 300m
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> 200Mi
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u67E5\u770B\u5F53\u524D\u7684\u8D44\u6E90\u9650\u5236\u72B6\u6001\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~/work<span class="token punctuation">]</span><span class="token comment"># kubectl describe limitranges -n test cpu-memory-min-max</span>
Name:       cpu-memory-min-max
Namespace:  <span class="token builtin class-name">test</span>
Type        Resource  Min    Max  Default Request  Default Limit  Max Limit/Request Ratio
----        --------  ---    ---  ---------------  -------------  -----------------------
Container   cpu       200m   <span class="token number">1</span>    <span class="token number">1</span>                <span class="token number">1</span>              -
Container   memory    200Mi  1Gi  1Gi              1Gi            -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5C1D\u8BD5\u521B\u5EFA\u4E00\u4E2A\u8D85\u8FC7\u5927\u5C0F\u7684Pod\uFF0C\u5C06\u4EE5\u4E0APod\u6539\u6210\u6700\u5927\u8BF7\u6C422Gi\u5185\u5B58\u548C2\u4E2ACPU:</p><ol><li><code>\u63D0\u793A\u62A5\u9519\u8B66\u544A\u4E0D\u80FD\u8D85\u8FC7\u6700\u5927\u8BF7\u6C42</code></li><li><code>\u6240\u4EE5\u8D44\u6E90\u9650\u5236\u751F\u6548</code></li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~/work<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f pod.yaml</span>
Error from server <span class="token punctuation">(</span>Forbidden<span class="token punctuation">)</span>: error when creating <span class="token string">&quot;pod.yaml&quot;</span><span class="token builtin class-name">:</span> pods <span class="token string">&quot;nginx&quot;</span> is forbidden: <span class="token punctuation">[</span>maximum cpu usage per Container is <span class="token number">1</span>, but limit is <span class="token number">2</span>, maximum memory usage per Container is 1Gi, but limit is 2Gi<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u8BA1\u7B97\u8D44\u6E90\u9ED8\u8BA4\u503C\u9650\u5236" tabindex="-1"><a class="header-anchor" href="#\u8BA1\u7B97\u8D44\u6E90\u9ED8\u8BA4\u503C\u9650\u5236" aria-hidden="true">#</a> \u8BA1\u7B97\u8D44\u6E90\u9ED8\u8BA4\u503C\u9650\u5236</h4><ul><li>\u521B\u5EFALimitRange\u8D44\u6E90</li><li>\u8BBE\u7F6E\u9ED8\u8BA4\u7684\u5185\u5B58\u9650\u5236<code>\u6700\u5C0F300m\uFF0C\u6700\u5927500m</code></li><li>\u8BBE\u7F6E\u9ED8\u8BA4\u7684cpu\u9650\u5236\u6700<code>\u5C0F300m\uFF0C\u6700\u5927500m</code></li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> LimitRange
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cpu<span class="token punctuation">-</span>memory<span class="token punctuation">-</span>min<span class="token punctuation">-</span>max
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">limits</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">default</span><span class="token punctuation">:</span>
      <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 500m
      <span class="token key atrule">memory</span><span class="token punctuation">:</span> 500Mi
    <span class="token key atrule">defaultRequest</span><span class="token punctuation">:</span>
      <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 300m
      <span class="token key atrule">memory</span><span class="token punctuation">:</span> 300Mi
    <span class="token key atrule">type</span><span class="token punctuation">:</span> Container
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u521B\u5EFA\u8D44\u6E90\u9650\u5236\u67E5\u770B\u5F53\u524D\u7684\u72B6\u6001\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~/work<span class="token punctuation">]</span><span class="token comment"># kubectl describe limitranges -n test cpu-memory-min-max</span>
Name:       cpu-memory-min-max
Namespace:  <span class="token builtin class-name">test</span>
Type        Resource  Min  Max  Default Request  Default Limit  Max Limit/Request Ratio
----        --------  ---  ---  ---------------  -------------  -----------------------
Container   memory    -    -    300Mi            500Mi          -
Container   cpu       -    -    300m             500m           -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u521B\u5EFAPod\u6D4B\u8BD5\uFF0C\u4E0D\u9700\u8981\u8BBE\u7F6E\u5F53\u524DPod\u7684\u8D44\u6E90\u8BF7\u6C42\u90E8\u5206\uFF0C\u521B\u5EFA\u4E4B\u540E\u67E5\u770B\uFF1A</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/work<span class="token punctuation">]</span><span class="token comment"># cat pod.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/work<span class="token punctuation">]</span><span class="token comment"># kubectl describe pods -n test | grep Limits -A 5</span>
    <span class="token key atrule">Limits</span><span class="token punctuation">:</span>
      <span class="token key atrule">cpu</span><span class="token punctuation">:</span>     500m
      <span class="token key atrule">memory</span><span class="token punctuation">:</span>  500Mi
    <span class="token key atrule">Requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">cpu</span><span class="token punctuation">:</span>        300m
      <span class="token key atrule">memory</span><span class="token punctuation">:</span>     300Mi
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u5B58\u50A8\u8D44\u6E90\u6700\u5927\u3001\u6700\u5C0F\u9650\u5236" tabindex="-1"><a class="header-anchor" href="#\u5B58\u50A8\u8D44\u6E90\u6700\u5927\u3001\u6700\u5C0F\u9650\u5236" aria-hidden="true">#</a> \u5B58\u50A8\u8D44\u6E90\u6700\u5927\u3001\u6700\u5C0F\u9650\u5236</h4><ul><li>\u521B\u5EFALimitRange\u8D44\u6E90</li><li>\u8BBE\u7F6E\u6700\u5C0F\u7684\u7533\u8BF7PVC\u9650\u5236<code>\u6700\u5C0F\u4E3A1Gi\uFF0C\u6700\u592710Gi</code></li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> LimitRange
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> storage<span class="token punctuation">-</span>min<span class="token punctuation">-</span>max
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">limits</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> PersistentVolumeClaim
    <span class="token key atrule">max</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi
    <span class="token key atrule">min</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6B64\u8D44\u6E90\u5728PVC\u4E2D\u4F7F\u7528\u5982\u4E0B\uFF1A</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> test
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pvc<span class="token punctuation">-</span>quota<span class="token punctuation">-</span>demo2
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> manual
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteOnce
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,141),i=[p];function l(c,o){return s(),a("div",null,i)}const d=n(t,[["render",l],["__file","02.\u96C6\u7FA4\u5F3A\u5316.html.vue"]]);export{d as default};
