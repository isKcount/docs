import{_ as p}from"./_plugin-vue_export-helper.cdc0426e.js";import{o as l,c as i,a as n,b as s,d as e,f as t,r as o}from"./app.ca0279c0.js";const c={},u=t(`<h1 id="istio\u7531\u6D45\u5165\u6DF1" tabindex="-1"><a class="header-anchor" href="#istio\u7531\u6D45\u5165\u6DF1" aria-hidden="true">#</a> Istio\u7531\u6D45\u5165\u6DF1</h1><h2 id="istio\u7B80\u4ECB" tabindex="-1"><a class="header-anchor" href="#istio\u7B80\u4ECB" aria-hidden="true">#</a> Istio\u7B80\u4ECB</h2><h4 id="\u4EC0\u4E48\u662Fistio" tabindex="-1"><a class="header-anchor" href="#\u4EC0\u4E48\u662Fistio" aria-hidden="true">#</a> \u4EC0\u4E48\u662FIstio?</h4><p>\u5728\u4F01\u4E1A\u666E\u904D\u90FD\u505A\u4E91\u5E73\u53F0\u7684\u65F6\u4EE3\u80CC\u666F\u4E0B\uFF0C\u4E91\u5E73\u53F0\u67B6\u6784\u5E26\u6765\u7684\u8BF8\u591A\u597D\u5904\uFF0C\u4F46\u662F\uFF0C\u4E0D\u53EF\u5426\u8BA4\u7684\u662F\uFF0C\u91C7\u7528\u4E91\u6280\u672F\u67B6\u6784\u4F1A\u5BF9DevOps\u56E2\u961F\u9020\u6210\u5F88\u5927\u7684\u538B\u529B\u3002 \u5F00\u53D1\u4EBA\u5458\u4E5F\u5FC5\u987B\u4F7F\u7528\u5FAE\u670D\u52A1\u6765\u6784\u5EFA\u53EF\u79FB\u690D\u6027\uFF0C\u540C\u65F6\u5404\u5927\u8FD0\u8425\u5546\u6B63\u5728\u7BA1\u7406\u8D85\u5927\u578B\u6DF7\u5408\u548C\u591A\u4E91\u90E8\u7F72\u3002\u800CIstio\u4F7F\u5F97\u60A8\u53EF\u4EE5\u8FDE\u63A5\uFF0C\u5B89\u5168\uFF0C\u63A7\u5236\u548C\u76D1\u63A7\u8FD9\u4E9B\u670D\u52A1\u3002</p><p>\u4ECE\u66F4\u9AD8\u7684\u7EF4\u5EA6\u6765\u770B\uFF0CIstio\u6709\u52A9\u4E8E\u964D\u4F4E\u90E8\u7F72\u7684\u590D\u6742\u6027\uFF0C\u51CF\u8F7B\u5F00\u53D1\u56E2\u961F\u7684\u8D1F\u62C5\u3002<code>Istio\u662F\u4E00\u4E2A\u5B8C\u5168\u5F00\u6E90\u7684\u670D\u52A1\u7F51\u683C\uFF08service mesh\uFF09\uFF0C\u53EF\u4EE5\u900F\u660E\u5730\u5206\u5C42\u5230\u73B0\u6709\u7684\u5206\u5E03\u5F0F\u5E94\u7528\u7A0B\u5E8F\u4E0A\u3002\u540C\u65F6\uFF0C\u5B83\u4E5F\u662F\u4E00\u4E2A\u5E73\u53F0\uFF0C\u901A\u8FC7\u5176\u63D0\u4F9B\u7684API\uFF0C\u53EF\u5C06\u5176\u96C6\u6210\u5230\u4EFB\u4F55\u65E5\u5FD7\u5E73\u53F0\uFF0Ctelemetry\u6216\u7B56\u7565\u7CFB\u7EDF\u4E2D\u3002</code></p><p>Istio\u7684\u591A\u6837\u5316\u529F\u80FD\u96C6\u4F7F\u60A8\u80FD\u591F\u9AD8\u6548\u5730\u8FD0\u884C\u5206\u5E03\u5F0F\u5FAE\u670D\u52A1\u67B6\u6784\uFF0C\u5E76\u63D0\u4F9B\u7EDF\u4E00\u7684\u65B9\u5F0F\u6765\u4FDD\u62A4\uFF0C\u8FDE\u63A5\u548C\u76D1\u89C6\u5FAE\u670D\u52A1\u3002</p><h4 id="\u4EC0\u4E48\u662F\u670D\u52A1\u7F51\u683C-serivce-mesh" tabindex="-1"><a class="header-anchor" href="#\u4EC0\u4E48\u662F\u670D\u52A1\u7F51\u683C-serivce-mesh" aria-hidden="true">#</a> \u4EC0\u4E48\u662F\u670D\u52A1\u7F51\u683C\uFF08serivce mesh\uFF09\uFF1F</h4><p>\u5F53\u6574\u4F53\u5E94\u7528\u7A0B\u5E8F\u5411\u5206\u5E03\u5F0F\u5FAE\u670D\u52A1\u67B6\u6784\u8FC7\u6E21\u65F6\uFF0CIstio\u89E3\u51B3\u4E86\u5F00\u53D1\u4EBA\u5458\u548C\u8FD0\u8425\u5546\u9762\u4E34\u7684\u6311\u6218\u3002</p><p><code>\u670D\u52A1\u7F51\u683C</code>\u672F\u8BED\u7528\u4E8E\u63CF\u8FF0\u7EC4\u6210\u6B64\u7C7B\u5E94\u7528\u7A0B\u5E8F\u7684\u5FAE\u670D\u52A1\u7F51\u7EDC\u53CA\u5176\u4E4B\u95F4\u7684\u4EA4\u4E92\u3002\u968F\u7740\u670D\u52A1\u7F51\u683C\u7684\u5927\u5C0F\u548C\u590D\u6742\u6027\u7684\u589E\u957F\uFF0C\u5B83\u53D8\u5F97\u8D8A\u6765\u8D8A\u96BE\u4EE5\u7406\u89E3\u548C\u7BA1\u7406\u3002\u5B83\u7684\u8981\u6C42\u53EF\u4EE5\u5305\u62EC\u53D1\u73B0\uFF0C\u8D1F\u8F7D\u5E73\u8861\uFF0C\u6545\u969C\u6062\u590D\uFF0C\u6307\u6807\u548C\u76D1\u63A7\u3002\u670D\u52A1\u7F51\u683C\u901A\u5E38\u8FD8\u5177\u6709\u66F4\u590D\u6742\u7684\u64CD\u4F5C\u8981\u6C42\uFF0C\u4F8B\u5982A/B\u6D4B\u8BD5\uFF0C\u91D1\u4E1D\u96C0\uFF0C\u7F51\u901F\u9650\u5236\uFF0C\u8BBF\u95EE\u63A7\u5236\u548C\u7AEF\u5230\u7AEF\u7684\u8EAB\u4EFD\u9A8C\u8BC1\u3002</p><p>Istio\u63D0\u4F9B\u4E86\u6574\u4E2A\u670D\u52A1\u7F51\u683C\u4E0A\u7684\u884C\u4E3A\u6D1E\u5BDF\u529B\u548C\u64CD\u4F5C\u63A7\u5236\uFF0C\u4ECE\u800C\u63D0\u4F9B\u4E86\u5B8C\u6574\u7684\u89E3\u51B3\u65B9\u6848\u6765\u6EE1\u8DB3\u5FAE\u670D\u52A1\u5E94\u7528\u7A0B\u5E8F\u7684\u5404\u79CD\u9700\u6C42\u3002</p><h4 id="\u4E3A\u4EC0\u4E48\u4F7F\u7528istio" tabindex="-1"><a class="header-anchor" href="#\u4E3A\u4EC0\u4E48\u4F7F\u7528istio" aria-hidden="true">#</a> \u4E3A\u4EC0\u4E48\u4F7F\u7528Istio\uFF1F</h4><p>Istio\u53EF\u4EE5\u8F7B\u677E\u5728\u5DF2\u90E8\u7F72\u670D\u52A1\u7F51\u7EDC\u4E0A\u521B\u5EFA\u5E26\u6709\u8D1F\u8F7D\u5E73\u8861\uFF0C\u670D\u52A1\u5230\u670D\u52A1\u7684\u8EAB\u4EFD\u9A8C\u8BC1\uFF0C\u76D1\u63A7\u7B49\u529F\u80FD\uFF0C\u5E76\u4E14\u670D\u52A1\u4EE3\u7801\u4E2D\u7684\u4EE3\u7801\u65E0\u9700\u53D8\u52A8\uFF08\u6216\u53D8\u52A8\u5F88\u5C11\uFF09\u3002\u901A\u8FC7\u5728\u6574\u4E2A\u73AF\u5883\u4E2D\u90E8\u7F72\u4E00\u4E2A\u7279\u6B8A\u7684sidecar\u4EE3\u7406\u6765\u62E6\u622A\u5FAE\u670D\u52A1\u4E4B\u95F4\u7684\u6240\u6709\u7F51\u7EDC\u901A\u4FE1\uFF0C\u7136\u540E\u4F7F\u7528\u5176\u5E73\u53F0\u63A7\u5236\u529F\u80FD\u914D\u7F6E\u548C\u7BA1\u7406Istio\uFF0C\u5305\u62EC\uFF1A</p><ul><li>\u81EA\u52A8\u4E3AHTTP\uFF0CgRPC\uFF0CWebSocket\u548CTCP\u6D41\u91CF\u8D1F\u8F7D\u5E73\u8861\u3002</li><li>\u901A\u8FC7\u4E30\u5BCC\u7684\u8DEF\u7531\u89C4\u5219\uFF0C\u91CD\u8BD5\uFF0C\u6545\u969C\u8F6C\u79FB\u548C\u6545\u969C\u6CE8\u5165\u5BF9\u6D41\u91CF\u884C\u4E3A\u8FDB\u884C\u7EC6\u7C92\u5EA6\u63A7\u5236\u3002</li><li>\u53EF\u63D2\u62D4\u7684\u7B56\u7565\u5C42\u548C\u914D\u7F6EAPI\uFF0C\u652F\u6301\u8BBF\u95EE\u63A7\u5236\uFF0C\u901F\u7387\u9650\u5236\u548C\u914D\u989D\u3002</li><li>\u96C6\u7FA4\u5185\u6240\u6709\u6D41\u91CF\u7684\u81EA\u52A8\u5EA6\u91CF\uFF0C\u65E5\u5FD7\u548C\u8DDF\u8E2A\uFF0C\u5305\u62EC\u96C6\u7FA4\u7684\u5165\u53E3\u548C\u51FA\u53E3\u3002</li><li>\u901A\u8FC7\u5F3A\u5927\u7684\u57FA\u4E8E\u8EAB\u4EFD\u7684\u8EAB\u4EFD\u9A8C\u8BC1\u548C\u6388\u6743\uFF0C\u5728\u96C6\u7FA4\u4E2D\u8FDB\u884C\u5B89\u5168\u7684\u670D\u52A1\u4E4B\u95F4\u901A\u4FE1\u3002</li></ul><p>Istio\u4E13\u4E3A\u53EF\u6269\u5C55\u6027\u800C\u8BBE\u8BA1\uFF0C\u53EF\u6EE1\u8DB3\u591A\u79CD\u90E8\u7F72\u9700\u6C42\u3002</p><h4 id="\u6838\u5FC3\u529F\u80FD" tabindex="-1"><a class="header-anchor" href="#\u6838\u5FC3\u529F\u80FD" aria-hidden="true">#</a> \u6838\u5FC3\u529F\u80FD</h4><p>Istio\u5728\u670D\u52A1\u7F51\u7EDC\u4E2D\u7EDF\u4E00\u63D0\u4F9B\u4E86\u8BB8\u591A\u5173\u952E\u529F\u80FD\uFF1A</p><h4 id="\u6D41\u91CF\u7BA1\u7406" tabindex="-1"><a class="header-anchor" href="#\u6D41\u91CF\u7BA1\u7406" aria-hidden="true">#</a> \u6D41\u91CF\u7BA1\u7406</h4><p>Istio\u89C4\u5219\u914D\u7F6E\u548C\u6D41\u91CF\u8DEF\u7531\u4F7F\u60A8\u53EF\u4EE5\u5F88\u5BB9\u6613\u7684\u63A7\u5236\u670D\u52A1\u4E4B\u95F4\u7684\u6D41\u91CF\u548CAPI\u8C03\u7528\u7684\u6D41\u91CF\u3002Istio\u7B80\u5316\u4E86\u8BF8\u5982\u65AD\u8DEF\u5668\uFF0C\u8D85\u65F6\u548C\u91CD\u8BD5\u4E4B\u7C7B\u7684\u670D\u52A1\u7EA7\u522B\u5C5E\u6027\u7684\u914D\u7F6E\uFF0C\u5E76\u4F7F\u5176\u8F7B\u800C\u6613\u4E3E\u5730\u8BBE\u7F6E\u91CD\u8981\u4EFB\u52A1\uFF0C\u5982A/B\u6D4B\u8BD5\uFF0C\u91D1\u4E1D\u96C0\u90E8\u7F72\u548C\u57FA\u4E8E\u767E\u5206\u6BD4\u7684\u6D41\u91CF\u62C6\u5206\u3002</p><p>\u501F\u52A9\u5BF9\u6D41\u91CF\u7684\u66F4\u597D\u53EF\u89C1\u6027\u548C\u5F00\u7BB1\u5373\u7528\u7684\u6545\u969C\u6062\u590D\u529F\u80FD\uFF0C\u65E0\u8BBA\u9047\u5230\u4EC0\u4E48\u60C5\u51B5\uFF0C\u60A8\u90FD\u53EF\u4EE5\u5728\u95EE\u9898\u5F15\u8D77\u6545\u969C\u4E4B\u524D\u53CA\u65F6\u53D1\u73B0\u95EE\u9898\uFF0C\u4F7F\u5F97\u8C03\u7528\u66F4\u52A0\u53EF\u9760\uFF0C\u7F51\u7EDC\u4E5F\u66F4\u52A0\u5F3A\u5927\u3002</p><h4 id="\u5B89\u5168" tabindex="-1"><a class="header-anchor" href="#\u5B89\u5168" aria-hidden="true">#</a> \u5B89\u5168</h4><p>Istio\u7684\u5B89\u5168\u529F\u80FD\u4F7F\u5F00\u53D1\u4EBA\u5458\u53EF\u4EE5\u5C06\u7CBE\u529B\u96C6\u4E2D\u5728\u5E94\u7528\u7A0B\u5E8F\u7EA7\u522B\u3002Istio\u63D0\u4F9B\u57FA\u7840\u5B89\u5168\u901A\u4FE1\u901A\u9053\uFF0C\u5E76\u5927\u89C4\u6A21\u7BA1\u7406\u670D\u52A1\u901A\u4FE1\u7684\u8EAB\u4EFD\u9A8C\u8BC1\uFF0C\u6388\u6743\u548C\u52A0\u5BC6\u3002 \u501F\u52A9Istio\uFF0C\u9ED8\u8BA4\u60C5\u51B5\u4E0B\u53EF\u4EE5\u4FDD\u62A4\u670D\u52A1\u901A\u4FE1\u7684\u5B89\u5168\uFF0C\u4ECE\u800C\u4F7F\u60A8\u80FD\u591F\u5728\u5404\u79CD\u534F\u8BAE\u548C\u8FD0\u884C\u65F6\u4E4B\u95F4\u4E00\u81F4\u5730\u6267\u884C\u7B56\u7565 - \u6240\u6709\u8FD9\u4E9B\u64CD\u4F5C\u51E0\u4E4E\u4E0D\u9700\u8981\u66F4\u6539\u5E94\u7528\u7A0B\u5E8F\u3002</p><p>\u867D\u7136Istio\u662F\u72EC\u7ACB\u4E8E\u5E73\u53F0\u7684\uFF0C\u4F46\u5C06\u5176\u4E0EKubernetes\uFF08\u6216\u57FA\u7840\u67B6\u6784\uFF09\u7F51\u7EDC\u7B56\u7565\u914D\u5408\u4F7F\u7528\uFF0C\u5219\u597D\u5904\u66F4\u5927\uFF0C\u5305\u62EC\u80FD\u591F\u5728\u7F51\u7EDC\u548C\u5E94\u7528\u7A0B\u5E8F\u5C42\u4FDD\u62A4Pod\u5230Pod\u6216\u670D\u52A1\u5230\u670D\u52A1\u7684\u901A\u4FE1\u7684\u80FD\u529B\u3002</p><h4 id="\u53EF\u89C2\u5BDF\u6027-observability" tabindex="-1"><a class="header-anchor" href="#\u53EF\u89C2\u5BDF\u6027-observability" aria-hidden="true">#</a> \u53EF\u89C2\u5BDF\u6027(Observability)</h4><p>Istio\u5F3A\u5927\u7684\u8DDF\u8E2A\uFF0C\u76D1\u63A7\u548C\u65E5\u5FD7\u8BB0\u5F55\u529F\u80FD\u4F7F\u60A8\u53EF\u4EE5\u6DF1\u5165\u4E86\u89E3\u670D\u52A1\u7F51\u683C\u90E8\u7F72\u3002\u501F\u52A9Istio\u7684\u76D1\u89C6\u529F\u80FD\uFF0C\u60A8\u53EF\u4EE5\u771F\u6B63\u4E86\u89E3\u670D\u52A1\u6027\u80FD\u5982\u4F55\u5F71\u54CD\u4E0A\u6E38\u548C\u4E0B\u6E38\u4E8B\u7269\uFF0C\u800C\u5176\u81EA\u5B9A\u4E49dashboards\uFF08\u4EEA\u8868\u76D8\uFF09\u5219\u53EF\u4EE5\u63D0\u4F9B\u5BF9\u6240\u6709\u670D\u52A1\u6027\u80FD\u7684\u53EF\u89C6\u6027\uFF0C\u5E76\u8BA9\u60A8\u4E86\u89E3\u8BE5\u6027\u80FD\u5982\u4F55\u5F71\u54CD\u60A8\u7684\u5176\u4ED6\u7684\u7A0B\u5E8F\u7684\u3002</p><p>Istio\u7684Mixer\u7EC4\u4EF6\u8D1F\u8D23\u7B56\u7565\u63A7\u5236\u548C\u9065\u6D4B(telemetry)\u91C7\u96C6\u3002\u5B83\u63D0\u4F9B\u4E86\u540E\u7AEF\u62BD\u8C61\u548C\u4E2D\u4ECB\uFF0C\u4F7FIstio\u7684\u5176\u4F59\u90E8\u5206\u4E0E\u5404\u4E2A\u57FA\u7840\u67B6\u6784\u540E\u7AEF\u7684\u5B9E\u73B0\u7EC6\u8282\u9694\u79BB\u5F00\u6765\uFF0C\u5E76\u4E3A\u64CD\u4F5C\u5458\u63D0\u4F9B\u4E86\u5BF9\u7F51\u683C\u548C\u57FA\u7840\u67B6\u6784\u540E\u7AEF\u4E4B\u95F4\u6240\u6709\u4EA4\u4E92\u7684\u7CBE\u7EC6\u63A7\u5236\u3002</p><p>\u6240\u6709\u8FD9\u4E9B\u529F\u80FD\u4F7F\u60A8\u53EF\u4EE5\u66F4\u6709\u6548\u5730\u8BBE\u7F6E\uFF0C\u76D1\u63A7\u548C\u6267\u884C\u670D\u52A1\u4E0A\u7684SLO\u3002\u5F53\u7136\uFF0C\u6700\u91CD\u8981\u7684\u662F\u60A8\u53EF\u4EE5\u5FEB\u901F\u6709\u6548\u5730\u68C0\u6D4B\u548C\u4FEE\u590D\u6545\u969C\u3002</p><h4 id="\u5E73\u53F0\u652F\u6301" tabindex="-1"><a class="header-anchor" href="#\u5E73\u53F0\u652F\u6301" aria-hidden="true">#</a> \u5E73\u53F0\u652F\u6301</h4><p>Istio\u662F\u72EC\u7ACB\u4E8E\u5E73\u53F0\u7684\uFF0C\u65E8\u5728\u5728\u591A\u79CD\u73AF\u5883\u4E2D\u8FD0\u884C\uFF0C\u5305\u62EC\u8DE8Cloud\uFF0C\u672C\u5730\uFF0CKubernetes\uFF0CMesos\u7B49\u7684\u73AF\u5883\u3002\u60A8\u53EF\u4EE5\u5728Kubernetes\u6216Consul\u7684Nomad\u4E0A\u90E8\u7F72Istio\u3002Istio\u5F53\u524D\u652F\u6301\uFF1A</p><ul><li>Kubernetes\u4E0A\u90E8\u7F72Service</li><li>\u5411Consul\u6CE8\u518CServices</li><li>\u5728\u5355\u4E2A\u865A\u62DF\u673A\u4E0A\u8FD0\u884CServices</li></ul><h4 id="\u96C6\u6210\u548C\u81EA\u5B9A\u4E49" tabindex="-1"><a class="header-anchor" href="#\u96C6\u6210\u548C\u81EA\u5B9A\u4E49" aria-hidden="true">#</a> \u96C6\u6210\u548C\u81EA\u5B9A\u4E49</h4><p>Istio\u7684\u7B56\u7565\u6267\u884C\u7EC4\u4EF6\u53EF\u4EE5\u6269\u5C55\u548C\u81EA\u5B9A\u4E49\uFF0C\u4EE5\u4E0E\u73B0\u6709\u7684ACL\uFF0C\u65E5\u5FD7\u8BB0\u5F55\uFF0C\u76D1\u89C6\uFF0C\u914D\u989D\uFF0C\u5BA1\u6838\u7B49\u96C6\u6210\u3002</p><h4 id="\u67B6\u6784" tabindex="-1"><a class="header-anchor" href="#\u67B6\u6784" aria-hidden="true">#</a> \u67B6\u6784</h4><p>Istio\u670D\u52A1\u7F51\u683C\u5728\u903B\u8F91\u4E0A\u5206\u4E3A\u6570\u636E\u5E73\u9762\u548C\u63A7\u5236\u5E73\u9762\u3002</p><ul><li>\u6570\u636Eplane\u7531\u90E8\u7F72\u4E3Asidecar\u7684\u4E00\u7EC4\u667A\u80FD\u4EE3\u7406\uFF08Envoy\uFF09\u7EC4\u6210\u3002\u8FD9\u4E9B\u4EE3\u7406\u4E2D\u4ECB\u548C\u63A7\u5236\u5FAE\u670D\u52A1\u4E0EMixer\u3001\u901A\u7528\u7B56\u7565\u548C\u9065\u6D4B\u96C6\u7EBF\u5668\u4E4B\u95F4\u7684\u6240\u6709\u7F51\u7EDC\u901A\u4FE1\u3002</li><li>\u63A7\u5236\u5E73\u9762\u7BA1\u7406\u5E76\u5C06\u4EE3\u7406\u914D\u7F6E\u4E3A\u8DEF\u7531\u6D41\u91CF\u3002\u53E6\u5916\uFF0C\u63A7\u5236\u5E73\u9762\u914D\u7F6EMixers\u6765\u6267\u884C\u7B56\u7565\u548C\u91C7\u96C6\u9065\u6D4B\u6570\u636E\u3002</li></ul><p>\u4E0B\u56FE\u663E\u793A\u4E86\u7EC4\u6210\u6BCF\u4E2A\u5E73\u9762\u7684\u4E0D\u540C\u7EC4\u4EF6:</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062326606.jpeg" alt="screenshot" loading="lazy"></p><h4 id="envoy" tabindex="-1"><a class="header-anchor" href="#envoy" aria-hidden="true">#</a> Envoy</h4><p>Istio\u4F7F\u7528Envoy\u4EE3\u7406\u7684\u6269\u5C55\u7248\u672C\u3002Envoy\u662F\u4F7F\u7528<code>C++</code>\u5F00\u53D1\u7684\u9AD8\u6027\u80FD\u4EE3\u7406\uFF0C\u53EF\u4E3A\u670D\u52A1\u7F51\u683C\u4E2D\u7684\u6240\u6709\u670D\u52A1\u8C03\u89E3\u6240\u6709\u5165\u7AD9\u548C\u51FA\u7AD9\u6D41\u91CF\u3002Istio\u5229\u7528Envoy\u7684\u8BB8\u591A\u5185\u7F6E\u529F\u80FD\uFF0C\u5982\uFF1A</p><ul><li>\u52A8\u6001\u670D\u52A1\u53D1\u73B0</li><li>\u8D1F\u8F7D\u5747\u8861</li><li>TLS termination</li><li>HTTP/2\u548CgRPC\u4EE3\u7406</li><li>\u7194\u65AD\uFF08Circuit breakers\uFF09</li><li>\u5065\u5EB7\u68C0\u67E5</li><li>\u5206\u9636\u6BB5\u63A8\u51FA\uFF0C\u6309\u767E\u5206\u6BD4\u5206\u914D\u6D41\u91CF</li><li>\u6545\u969C\u6CE8\u5165</li><li>\u4E30\u5BCC\u7684\u6307\u6807</li></ul><p>Sidecar\u4EE3\u7406\u6A21\u578B\u8FD8\u5141\u8BB8\u4F60\u5C06Istio\u529F\u80FD\u6DFB\u52A0\u5230\u73B0\u6709\u90E8\u7F72\u4E2D\uFF0C\u800C\u65E0\u9700\u91CD\u65B0\u6784\u9020\u6216\u91CD\u5199\u4EE3\u7801\u3002\u4F60\u53EF\u4EE5\u9605\u8BFB\u66F4\u591A\u5173\u4E8E\u4E3A\u4EC0\u4E48\u6211\u4EEC\u5728\u8BBE\u8BA1\u76EE\u6807\u4E2D\u9009\u62E9\u8FD9\u79CD\u65B9\u6CD5\u7684\u4FE1\u606F\u3002</p><h4 id="mixer" tabindex="-1"><a class="header-anchor" href="#mixer" aria-hidden="true">#</a> Mixer</h4><p>Mixer\u662F\u4E00\u4E2A\u4E0E\u5E73\u53F0\u65E0\u5173\u7684\u7EC4\u4EF6\u3002Mixer\u8DE8\u670D\u52A1\u7F51\u683C\u5B9E\u65BD\u8BBF\u95EE\u63A7\u5236\u548C\u4F7F\u7528\u7B56\u7565\uFF0C\u5E76\u4ECEEnvoy\u4EE3\u7406\u548C\u5176\u4ED6\u670D\u52A1\u6536\u96C6\u9065\u6D4B\u6570\u636E\u3002 \u4EE3\u7406\u63D0\u53D6\u8BF7\u6C42\u7EA7\u522B\u5C5E\u6027\uFF0C\u5E76\u5C06\u5176\u53D1\u9001\u5230Mixer\u8FDB\u884C\u8BC4\u4F30\u3002\u60A8\u53EF\u4EE5\u5728\u6211\u4EEC\u7684\u201CMixer\u914D\u7F6E\u201D\u6587\u6863\u4E2D\u627E\u5230\u6709\u5173\u6B64\u5C5E\u6027\u63D0\u53D6\u548C\u7B56\u7565\u8BC4\u4F30\u7684\u66F4\u591A\u4FE1\u606F\u3002</p><p>Mixer\u5305\u542B\u4E00\u4E2A\u7075\u6D3B\u7684\u63D2\u4EF6\u6A21\u578B\u3002\u8BE5\u6A21\u578B\u4F7FIstio\u53EF\u4EE5\u4E0E\u5404\u79CD\u4E3B\u673A\u73AF\u5883\u548C\u57FA\u7840\u67B6\u6784\u540E\u7AEF\u4EA4\u4E92\u3002\u56E0\u6B64\uFF0CIstio\u4ECE\u8FD9\u4E9B\u7EC6\u8282\u4E2D\u62BD\u8C61\u4E86Envoy\u4EE3\u7406\u548CIstio\u7BA1\u7406\u7684\u670D\u52A1\u3002</p><h4 id="pilot" tabindex="-1"><a class="header-anchor" href="#pilot" aria-hidden="true">#</a> Pilot</h4><p>Pilot\u63D0\u4F9B\u4E86Envoy sidecar\u7684\u670D\u52A1\u53D1\u73B0\uFF0C\u667A\u80FD\u8DEF\u7531\u7684\u6D41\u91CF\u7BA1\u7406\u529F\u80FD\uFF08\u4F8B\u5982 A/B\u6D4B\u8BD5\uFF0C\u91D1\u4E1D\u96C0\u7B49\uFF09\u548C\u5F39\u6027\uFF08\u8D85\u65F6\uFF0C\u91CD\u8BD5\uFF0C\u65AD\u8DEF\u5668\u7B49\uFF09\u3002</p><p>Pilot\u5C06\u63A7\u5236\u6D41\u91CF\u884C\u4E3A\u7684\u9AD8\u7EA7\u8DEF\u7531\u89C4\u5219\u8F6C\u6362\u4E3AEnvoy\u7279\u5B9A\u7684\u914D\u7F6E\uFF0C\u5E76\u5728\u8FD0\u884C\u65F6\u5C06\u5176\u4F20\u9001\u5230sidecar\u3002Pilot\u63D0\u53D6\u4E86\u7279\u5B9A\u4E8E\u5E73\u53F0\u7684\u670D\u52A1\u53D1\u73B0\u673A\u5236\uFF0C\u5E76\u5C06\u5B83\u4EEC\u5408\u6210\u4E3A\u6807\u51C6\u683C\u5F0F\uFF0C\u4EFB\u4F55\u7B26\u5408Envoy\u6570\u636E\u5E73\u9762API\u7684Sidecar\u90FD\u53EF\u4EE5\u4F7F\u7528\u3002\u8FD9\u79CD\u677E\u6563\u7684\u8026\u5408\u4F7F\u5F97Istio\u53EF\u4EE5\u5728Kubernetes\uFF0CConsul\u6216Nomad\u7B49\u591A\u79CD\u73AF\u5883\u4E2D\u8FD0\u884C\uFF0C\u540C\u65F6\u4E3A\u6D41\u91CF\u7BA1\u7406\u4FDD\u7559\u76F8\u540C\u7684\u64CD\u4F5C\u5458\u754C\u9762\u3002</p><h4 id="citadel" tabindex="-1"><a class="header-anchor" href="#citadel" aria-hidden="true">#</a> Citadel</h4><p>Citadel\u901A\u8FC7\u5185\u7F6E\u7684\u8EAB\u4EFD\u548C\u51ED\u636E\u7BA1\u7406\u5B9E\u73B0\u4E86\u5F3A\u5927\u7684\u670D\u52A1\u5230\u670D\u52A1\u548C\u7EC8\u7AEF\u7528\u6237\u7684\u8EAB\u4EFD\u9A8C\u8BC1\u3002\u53EF\u4EE5\u4F7F\u7528Citadel\u6765\u5347\u7EA7\u670D\u52A1\u7F51\u683C\u4E2D\u7684\u672A\u52A0\u5BC6\u6D41\u91CF\u3002\u4F7F\u7528Citadel\uFF0C\u8FD0\u8425\u5546\u53EF\u4EE5\u57FA\u4E8E\u670D\u52A1\u8EAB\u4EFD\u800C\u4E0D\u662F\u76F8\u5BF9\u4E0D\u7A33\u5B9A\u76843\u5C42\u62164\u5C42\u7F51\u7EDC\u8BC6\u522B\u7801\u6765\u5B9E\u65BD\u7B56\u7565\u3002\u4ECE\u7248\u672C0.5\u5F00\u59CB\uFF0C\u60A8\u53EF\u4EE5\u4F7F\u7528Istio\u7684\u6388\u6743\u529F\u80FD\u6765\u63A7\u5236\u8C01\u53EF\u4EE5\u8BBF\u95EE\u60A8\u7684\u670D\u52A1\u3002</p><h4 id="galley" tabindex="-1"><a class="header-anchor" href="#galley" aria-hidden="true">#</a> Galley</h4><p>Galley\u662FIstio\u7684\u914D\u7F6E\u9A8C\u8BC1\uFF0C\u63D0\u53D6\uFF0C\u5904\u7406\u548C\u5206\u53D1\u7EC4\u4EF6\u3002\u5B83\u8D1F\u8D23\u5C06\u5176\u4F59Istio\u7EC4\u4EF6\u4E0E\u4ECE\u5E95\u5C42\u5E73\u53F0\uFF08\u4F8B\u5982Kubernetes\uFF09\u83B7\u53D6\u7528\u6237\u914D\u7F6E\u7684\u7EC6\u8282\u9694\u79BB\u5F00\u6765\u3002</p><ul><li><code>\u6700\u5927\u5316\u900F\u660E\u5EA6</code>\uFF1A\u8981\u91C7\u7528Istio\uFF0C\u8981\u6C42\u64CD\u4F5C\u5458\u6216\u5F00\u53D1\u4EBA\u5458\u8FDB\u884C\u5C3D\u53EF\u80FD\u5C11\u7684\u5DE5\u4F5C\uFF0C\u4EE5\u4ECE\u7CFB\u7EDF\u4E2D\u83B7\u5F97\u771F\u6B63\u7684\u4EF7\u503C\u3002\u4E3A\u6B64\uFF0CIstio\u53EF\u4EE5\u81EA\u52A8\u5C06\u5176\u81EA\u8EAB\u63D2\u5165\u670D\u52A1\u4E4B\u95F4\u7684\u6240\u6709\u7F51\u7EDC\u8DEF\u5F84\u4E2D\u3002Istio\u4F7F\u7528Sidecar\u4EE3\u7406\u6765\u6355\u83B7\u6D41\u91CF\uFF0C\u5E76\u5728\u53EF\u80FD\u7684\u60C5\u51B5\u4E0B\u81EA\u52A8\u5BF9\u7F51\u7EDC\u5C42\u8FDB\u884C\u7F16\u7A0B\uFF0C\u4EE5\u901A\u8FC7\u8FD9\u4E9B\u4EE3\u7406\u8DEF\u7531\u6D41\u91CF\uFF0C\u800C\u65E0\u9700\u66F4\u6539\u5DF2\u90E8\u7F72\u7684\u5E94\u7528\u7A0B\u5E8F\u4EE3\u7801\u3002 \u5728Kubernetes\u4E2D\uFF0C\u4EE3\u7406\u88AB\u6CE8\u5165\u5230Pod\u4E2D\uFF0C\u5E76\u901A\u8FC7\u5BF9iptables\u89C4\u5219\u8FDB\u884C\u7F16\u7A0B\u6765\u6355\u83B7\u6D41\u91CF\u3002 \u4E00\u65E6\u6CE8\u5165\u4E86sidecar\u4EE3\u7406\u5E76\u4E14\u5BF9\u6D41\u91CF\u8DEF\u7531\u8FDB\u884C\u4E86\u7F16\u7A0B\uFF0CIstio\u5C31\u53EF\u4EE5\u8C03\u89E3\u6240\u6709\u6D41\u91CF\u3002\u6B64\u539F\u5219\u4E5F\u9002\u7528\u4E8E\u6027\u80FD\u3002\u5C06Istio\u5E94\u7528\u4E8E\u90E8\u7F72\u65F6\uFF0C\u8FD0\u8425\u5546\u4F1A\u53D1\u73B0\u6240\u63D0\u4F9B\u529F\u80FD\u7684\u8D44\u6E90\u6210\u672C\u589E\u52A0\u6700\u5C0F\u3002\u7EC4\u4EF6\u548CAPI\u5FC5\u987B\u5728\u8BBE\u8BA1\u65F6\u5145\u5206\u8003\u8651\u6027\u80FD\u548C\u89C4\u6A21\u3002</li><li><code>\u53EF\u6269\u5C55\u6027</code>\uFF1A\u968F\u7740\u8FD0\u8425\u5546\u548C\u5F00\u53D1\u4EBA\u5458\u8D8A\u6765\u8D8A\u4F9D\u8D56Istio\u63D0\u4F9B\u7684\u529F\u80FD\uFF0C\u7CFB\u7EDF\u4E5F\u5FC5\u987B\u968F\u7740\u4ED6\u4EEC\u7684\u9700\u6C42\u800C\u589E\u957F\u3002\u5728\u6211\u4EEC\u7EE7\u7EED\u6DFB\u52A0\u65B0\u529F\u80FD\u7684\u540C\u65F6\uFF0C\u6700\u5927\u7684\u9700\u6C42\u662F\u6269\u5C55\u7B56\u7565\u7CFB\u7EDF\uFF0C\u4E0E\u5176\u4ED6\u7B56\u7565\u548C\u63A7\u5236\u6E90\u96C6\u6210\u4EE5\u53CA\u5C06\u6709\u5173\u7F51\u683C\u884C\u4E3A\u7684\u4FE1\u53F7\u4F20\u9001\u5230\u7684\u5176\u4ED6\u7CFB\u7EDF\u4EE5\u8FDB\u884C\u5206\u6790\u3002\u7B56\u7565\u8FD0\u884C\u65F6\u652F\u6301\u63D2\u5165\u5176\u4ED6\u670D\u52A1\u7684\u6807\u51C6\u6269\u5C55\u673A\u5236\u3002\u6B64\u5916\uFF0C\u5B83\u8FD8\u5141\u8BB8\u6269\u5C55\u5176\u8BCD\u6C47\u8868\uFF0C\u4ECE\u800C\u53EF\u4EE5\u6839\u636E\u7F51\u683C\u751F\u6210\u7684\u65B0\u4FE1\u53F7\u6765\u5B9E\u65BD\u7B56\u7565\u3002</li><li><code>\u53EF\u79FB\u690D\u6027</code>\uFF1A\u4F7F\u7528Istio\u7684\u751F\u6001\u7CFB\u7EDF\u5728\u8BB8\u591A\u65B9\u9762\u90FD\u4E0D\u540C\u3002Istio\u5FC5\u987B\u80FD\u5728\u4EFB\u4F55\u4E91\u7AEF\u6216\u672C\u5730\u73AF\u5883\u4E2D\u8FD0\u884C\uFF0C\u53EA\u9700\u6700\u5C11\u7684\u52AA\u529B\u3002\u5C06\u57FA\u4E8EIstio\u7684\u670D\u52A1\u79FB\u690D\u5230\u65B0\u73AF\u5883\u7684\u4EFB\u52A1\u5FC5\u987B\u5F88\u7B80\u5355\u3002\u4F7F\u7528Istio\uFF0C\u60A8\u53EF\u4EE5\u64CD\u4F5C\u90E8\u7F72\u5230\u591A\u4E2A\u73AF\u5883\u4E2D\u7684\u5355\u4E2A\u670D\u52A1\u3002\u4F8B\u5982\uFF0C\u53EF\u4EE5\u5728\u591A\u4E2A\u4E91\u4E0A\u90E8\u7F72\u4EE5\u5B9E\u73B0\u5197\u4F59\u3002</li><li><code>\u7B56\u7565\u7EDF\u4E00\u6027</code>\uFF1A\u5C06\u7B56\u7565\u5E94\u7528\u4E8E\u670D\u52A1\u4E4B\u95F4\u7684API\u8C03\u7528\u63D0\u4F9B\u4E86\u5BF9\u7F51\u683C\u884C\u4E3A\u7684\u5927\u91CF\u63A7\u5236\u3002\u4F46\u662F\uFF0C\u5C06\u7B56\u7565\u5E94\u7528\u4E8E\u4E0D\u4E00\u5B9A\u5728API\u7EA7\u522B\u8868\u8FBE\u7684\u8D44\u6E90\u4E5F\u540C\u6837\u91CD\u8981\u3002\u4F8B\u5982\uFF0C\u5BF9ML\u8BAD\u7EC3\u4EFB\u52A1\u6D88\u8017\u7684CPU\u6570\u91CF\u5E94\u7528quota\u6BD4\u5BF9\u542F\u52A8wrok\u7684\u8C03\u7528\u5E94\u7528quota\u66F4\u6709\u7528\u3002\u4E3A\u6B64\uFF0CIstio\u5C06\u7B56\u7565\u7CFB\u7EDF\u4F5C\u4E3A\u5177\u6709\u5176\u81EA\u5DF1\u7684API\u7684\u72EC\u7279\u670D\u52A1\u6765\u7EF4\u62A4\uFF0C\u800C\u4E0D\u662F\u5C06\u7B56\u7565\u7CFB\u7EDF\u70D8\u7119\u5230\u4EE3\u7406Sidecar\u4E2D\uFF0C\u4ECE\u800C\u4F7F\u5F97\u670D\u52A1\u6839\u636E\u9700\u8981\u76F4\u63A5\u4E0E\u5176\u96C6\u6210\u3002</li></ul><h2 id="istio\u7684\u5B89\u88C5" tabindex="-1"><a class="header-anchor" href="#istio\u7684\u5B89\u88C5" aria-hidden="true">#</a> Istio\u7684\u5B89\u88C5</h2><h3 id="\u4F7F\u7528-istioctl-\u5B89\u88C5" tabindex="-1"><a class="header-anchor" href="#\u4F7F\u7528-istioctl-\u5B89\u88C5" aria-hidden="true">#</a> \u4F7F\u7528 Istioctl \u5B89\u88C5</h3><h4 id="_1-\u62C9\u53D6istio\u7684\u5B89\u88C5\u5305" tabindex="-1"><a class="header-anchor" href="#_1-\u62C9\u53D6istio\u7684\u5B89\u88C5\u5305" aria-hidden="true">#</a> 1.\u62C9\u53D6Istio\u7684\u5B89\u88C5\u5305</h4><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-O</span> http://192.168.1.110/file/istio-1.9.5-linux-amd64.tar.gz

$ <span class="token function">ls</span> 
istio-1.9.5-linux-amd64.tar.gz
$ <span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> istio-1.9.5-linux-amd64.tar.gz
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-\u590D\u5236istioctl\u5DE5\u5177" tabindex="-1"><a class="header-anchor" href="#_2-\u590D\u5236istioctl\u5DE5\u5177" aria-hidden="true">#</a> 2.\u590D\u5236istioctl\u5DE5\u5177</h4><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> istio-1.9.5/
$ <span class="token function">cp</span> bin/istioctl  /usr/local/bin/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-\u4F7F\u7528\u9ED8\u8BA4\u914D\u7F6E\u6587\u4EF6\u5B89\u88C5-istio" tabindex="-1"><a class="header-anchor" href="#_3-\u4F7F\u7528\u9ED8\u8BA4\u914D\u7F6E\u6587\u4EF6\u5B89\u88C5-istio" aria-hidden="true">#</a> 3.\u4F7F\u7528\u9ED8\u8BA4\u914D\u7F6E\u6587\u4EF6\u5B89\u88C5 Istio</h4>`,58),r=n("code",null,"default",-1),d={href:"https://istio.io/latest/docs/setup/additional-setup/config-profiles/",target:"_blank",rel:"noopener noreferrer"},k=t(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ istioctl <span class="token function">install</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="_4-\u5B89\u88C5\u4E0D\u540C\u7684\u914D\u7F6E\u6587\u4EF6" tabindex="-1"><a class="header-anchor" href="#_4-\u5B89\u88C5\u4E0D\u540C\u7684\u914D\u7F6E\u6587\u4EF6" aria-hidden="true">#</a> 4.\u5B89\u88C5\u4E0D\u540C\u7684\u914D\u7F6E\u6587\u4EF6</h4><p>\u901A\u8FC7\u5728\u547D\u4EE4\u884C\u4E0A\u4F20\u9012\u914D\u7F6E\u6587\u4EF6\u540D\u79F0\uFF0C\u53EF\u4EE5\u5C06\u5176\u4ED6 Istio \u914D\u7F6E\u6587\u4EF6\u5B89\u88C5\u5230\u96C6\u7FA4\u4E2D\u3002\u4F8B\u5982\uFF0C\u4EE5\u4E0B\u547D\u4EE4\u53EF\u7528\u4E8E\u5B89\u88C5<code>demo</code>\u914D\u7F6E\u6587\u4EF6\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl  create  ns istio-system
$ istioctl <span class="token function">install</span> <span class="token parameter variable">--set</span> <span class="token assign-left variable">profile</span><span class="token operator">=</span>demo <span class="token parameter variable">-y</span>
\u2714 Istio core installed                                                   
\u2714 Istiod installed                                                  
\u2714 Egress gateways installed                                                        
\u2714 Ingress gateways installed                                                        
\u2714 Installation complete     
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-\u68C0\u67E5\u5B89\u88C5\u4E86\u4EC0\u4E48" tabindex="-1"><a class="header-anchor" href="#_5-\u68C0\u67E5\u5B89\u88C5\u4E86\u4EC0\u4E48" aria-hidden="true">#</a> 5.\u68C0\u67E5\u5B89\u88C5\u4E86\u4EC0\u4E48</h4><p>\u8BE5<code>istioctl</code>\u547D\u4EE4\u5C06<code>IstioOperator</code>\u7528\u4E8E\u5B89\u88C5 Istio\u7684CR\u4FDD\u5B58\u5728\u540D\u4E3A<code>installed-state</code>. \u800C\u4E0D\u662F\u68C0\u67E5 Istio \u5B89\u88C5\u7684\u90E8\u7F72\u3001pod\u3001\u670D\u52A1\u548C\u5176\u4ED6\u8D44\u6E90\uFF0C\u4F8B\u5982\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token parameter variable">-n</span> istio-system get deploy
NAME                   READY   UP-TO-DATE   AVAILABLE   AGE
istio-egressgateway    <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           25s
istio-ingressgateway   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           24s
istiod                 <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           20s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-\u6CE8\u5165\u9ED8\u8BA4\u53D8\u91CF" tabindex="-1"><a class="header-anchor" href="#_6-\u6CE8\u5165\u9ED8\u8BA4\u53D8\u91CF" aria-hidden="true">#</a> 6.\u6CE8\u5165\u9ED8\u8BA4\u53D8\u91CF</h4><p>\u5C06\u76EE\u5F55\u66F4\u6539\u4E3A Istio \u5B89\u88C5\u7684\u6839\u76EE\u5F55\u3002</p>`,9),v={href:"https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection",target:"_blank",rel:"noopener noreferrer"},m=n("code",null,"istio-injection=enabled",-1),b=t(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl label namespace default istio-injection<span class="token operator">=</span>enabled 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="_7-\u5378\u8F7D-istio" tabindex="-1"><a class="header-anchor" href="#_7-\u5378\u8F7D-istio" aria-hidden="true">#</a> 7.\u5378\u8F7D Istio</h4><p>\u8981\u4ECE\u96C6\u7FA4\u4E2D\u5B8C\u5168\u5378\u8F7D Istio\uFF0C\u8BF7\u8FD0\u884C\u4EE5\u4E0B\u547D\u4EE4\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ istioctl x uninstall <span class="token parameter variable">--purge</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u53EF\u9009<code>--purge</code>\u6807\u5FD7\u5C06\u5220\u9664\u6240\u6709 Istio \u8D44\u6E90\uFF0C\u5305\u62EC\u53EF\u80FD\u4E0E\u5176\u4ED6 Istio \u63A7\u5236\u5E73\u9762\u5171\u4EAB\u7684\u96C6\u7FA4\u8303\u56F4\u7684\u8D44\u6E90\u3002</p><h3 id="\u6D4B\u8BD5\u4E00\u4E2A\u5B9E\u4F8B" tabindex="-1"><a class="header-anchor" href="#\u6D4B\u8BD5\u4E00\u4E2A\u5B9E\u4F8B" aria-hidden="true">#</a> \u6D4B\u8BD5\u4E00\u4E2A\u5B9E\u4F8B</h3><h4 id="bookinfo" tabindex="-1"><a class="header-anchor" href="#bookinfo" aria-hidden="true">#</a> Bookinfo</h4><p><strong>Bookinfo \u5E94\u7528\u7A0B\u5E8F\u5206\u4E3A\u56DB\u4E2A\u72EC\u7ACB\u7684\u5FAE\u670D\u52A1\uFF1A</strong></p><ul><li><code>productpage</code>. \u8BE5<code>productpage</code>\u5FAE\u670D\u52A1\u8C03\u7528<code>details</code>\u548C<code>reviews</code>\u5FAE\u670D\u52A1\u6765\u586B\u5145\u9875\u9762\u3002</li><li><code>details</code>. \u8BE5<code>details</code>\u5FAE\u670D\u52A1\u5305\u542B\u56FE\u4E66\u4FE1\u606F\u3002</li><li><code>reviews</code>. \u8BE5<code>reviews</code>\u5FAE\u670D\u52A1\u5305\u542B\u4E86\u4E66\u8BC4\u3002\u5B83\u8FD8\u8C03\u7528<code>ratings</code>\u5FAE\u670D\u52A1\u3002</li><li><code>ratings</code>. \u8BE5<code>ratings</code>\u5FAE\u670D\u52A1\u5305\u542B\u9884\u5B9A\u4F34\u968F\u4E66\u8BC4\u6392\u540D\u4FE1\u606F\u3002</li></ul><p><strong><code>reviews</code>\u5FAE\u670D\u52A1\u6709 3 \u4E2A\u7248\u672C\uFF1A</strong></p><ul><li>\u7248\u672C v1 \u4E0D\u8C03\u7528\u8BE5<code>ratings</code>\u670D\u52A1\u3002</li><li>\u7248\u672C v2 \u8C03\u7528\u8BE5<code>ratings</code>\u670D\u52A1\uFF0C\u5E76\u5C06\u6BCF\u4E2A\u8BC4\u7EA7\u663E\u793A\u4E3A 1 \u5230 5 \u9897\u9ED1\u661F\u3002</li><li>\u7248\u672C v3 \u8C03\u7528\u8BE5<code>ratings</code>\u670D\u52A1\uFF0C\u5E76\u5C06\u6BCF\u4E2A\u8BC4\u7EA7\u663E\u793A\u4E3A 1 \u5230 5 \u9897\u7EA2\u661F\u3002</li></ul><p>\u8BE5\u5E94\u7528\u7A0B\u5E8F\u7684\u7AEF\u5230\u7AEF\u67B6\u6784\u5982\u4E0B\u6240\u793A\u3002</p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062326474.png" alt="image-20211214154321190" style="zoom:80%;"><h4 id="\u4F7F\u7528istio\u90E8\u7F72\u5E94\u7528\u7A0B\u5E8F\u{1F680}" tabindex="-1"><a class="header-anchor" href="#\u4F7F\u7528istio\u90E8\u7F72\u5E94\u7528\u7A0B\u5E8F\u{1F680}" aria-hidden="true">#</a> \u4F7F\u7528Istio\u90E8\u7F72\u5E94\u7528\u7A0B\u5E8F\u{1F680}</h4><p>\u4F7F\u7528 Istio \u8FD0\u884C\u793A\u4F8B\u4E0D\u9700\u8981\u66F4\u6539\u5E94\u7528\u7A0B\u5E8F\u672C\u8EAB\u3002\u76F8\u53CD\uFF0C\u60A8\u53EA\u9700\u8981\u5728\u652F\u6301 Istio \u7684\u73AF\u5883\u4E2D\u914D\u7F6E\u548C\u8FD0\u884C\u670D\u52A1\uFF0C\u5E76\u5728\u6BCF\u4E2A\u670D\u52A1\u65C1\u8FB9\u6CE8\u5165 Envoy sidecar\u3002\u751F\u6210\u7684\u90E8\u7F72\u5C06\u5982\u4E0B\u6240\u793A\uFF1A</p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062326222.png" alt="image-20211214154410424" style="zoom:80%;"><h4 id="\u542F\u52A8\u5E94\u7528\u670D\u52A1\u{1F680}" tabindex="-1"><a class="header-anchor" href="#\u542F\u52A8\u5E94\u7528\u670D\u52A1\u{1F680}" aria-hidden="true">#</a> \u542F\u52A8\u5E94\u7528\u670D\u52A1\u{1F680}</h4><p>\u4F7F\u7528\u4EE5\u4E0B<code>kubectl</code>\u547D\u4EE4\u90E8\u7F72\u60A8\u7684\u5E94\u7528\u7A0B\u5E8F\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/platform/kube/bookinfo.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="\u67E5\u770B\u6240\u6709\u670D\u52A1\u{1F680}" tabindex="-1"><a class="header-anchor" href="#\u67E5\u770B\u6240\u6709\u670D\u52A1\u{1F680}" aria-hidden="true">#</a> \u67E5\u770B\u6240\u6709\u670D\u52A1\u{1F680}</h4><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl get svc </span>
NAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>    AGE
details       ClusterIP   <span class="token number">10.104</span>.17.202    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9080</span>/TCP   21m
kubernetes    ClusterIP   <span class="token number">10.96</span>.0.1        <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP    41m
productpage   ClusterIP   <span class="token number">10.110</span>.235.179   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9080</span>/TCP   21m
ratings       ClusterIP   <span class="token number">10.104</span>.53.51     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9080</span>/TCP   21m
reviews       ClusterIP   <span class="token number">10.101</span>.21.63     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9080</span>/TCP   21m

<span class="token punctuation">[</span>root@master istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl get pods </span>
NAME                              READY   STATUS    RESTARTS   AGE
details-v1-79f774bdb9-gwhkf       <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m
productpage-v1-6b746f74dc-6dtg8   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m
ratings-v1-b6994bb9-9h2wn         <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m
reviews-v1-545db77b95-6cmmv       <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m
reviews-v2-7bf8c9648f-m2k9d       <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m
reviews-v3-84779c7bbc-vd86b       <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u901A\u8FC7curl\u8BF7\u6C42\u6D4B\u8BD5\u{1F680}" tabindex="-1"><a class="header-anchor" href="#\u901A\u8FC7curl\u8BF7\u6C42\u6D4B\u8BD5\u{1F680}" aria-hidden="true">#</a> \u901A\u8FC7Curl\u8BF7\u6C42\u6D4B\u8BD5\u{1F680}</h4><p>\u8981\u786E\u8BA4 Bookinfo \u5E94\u7528\u7A0B\u5E8F\u6B63\u5728\u8FD0\u884C\uFF0C\u8BF7\u901A\u8FC7<code>curl</code>\u6765\u81EA\u67D0\u4E2A pod\u7684\u547D\u4EE4\u5411\u5176\u53D1\u9001\u8BF7\u6C42\uFF0C\u4F8B\u5982\u6765\u81EA<code>ratings</code>\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl exec &quot;$(kubectl get pod -l app=ratings -o jsonpath=&#39;{.items[0].metadata.name}&#39;)&quot; -c ratings -- curl -sS productpage:9080/productpage | grep -o &quot;&lt;title&gt;.*&lt;/title&gt;&quot;</span>
<span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Simple Bookstore App<span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u786E\u5B9A\u5165\u53E3ip\u548C\u7AEF\u53E3\u{1F680}" tabindex="-1"><a class="header-anchor" href="#\u786E\u5B9A\u5165\u53E3ip\u548C\u7AEF\u53E3\u{1F680}" aria-hidden="true">#</a> \u786E\u5B9A\u5165\u53E3IP\u548C\u7AEF\u53E3\u{1F680}</h4>`,25),h={href:"https://istio.io/latest/docs/concepts/traffic-management/#gateways",target:"_blank",rel:"noopener noreferrer"},g=t(`<ol><li><strong><code>\u4E3A\u5E94\u7528\u5B9A\u4E49\u5165\u53E3\u7F51\u5173</code></strong></li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml </span>
gateway.networking.istio.io/bookinfo-gateway created
virtualservice.networking.istio.io/bookinfo created
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><strong><code>\u786E\u8BA4\u7F51\u5173\u5DF2\u521B\u5EFA</code></strong></li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl get gateway </span>
NAME               AGE
bookinfo-gateway   61s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><strong><code>\u6539\u4E3ANodePort</code></strong></li></ol><p>\u6B64\u5904\u6211\u4EEC\u5E76\u6CA1\u6709\u5916\u90E8\u8D1F\u8F7D\uFF0C\u6240\u4EE5\u8981\u5C06svc\u4FEE\u6539\u6210NodePort\u7684\u65B9\u5F0F\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -n istio-system </span>
NAME                   TYPE         CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>                                                                      AGE
istio-egressgateway    ClusterIP    <span class="token number">10.102</span>.197.30   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>/TCP,443/TCP,15443/TCP                                                     89m
istio-ingressgateway   LoadBalancer <span class="token number">10.109</span>.71.35    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">15021</span>:31964/TCP,80:31467/TCP,443:31845/TCP,31400:31077/TCP,15443:30757/TCP   89m
istiod                 ClusterIP    <span class="token number">10.111</span>.156.86   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">15010</span>/TCP,15012/TCP,443/TCP,15014/TCP                                        90m

<span class="token comment">#\u8BBF\u95EEmasterIP+80\u7AEF\u53E3\u5BF9\u5E94\u66B4\u9732\u768431962</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><code>\u6CE8\u610F\uFF1A \u5982\u679C EXTERNAL-IP \u8BBE\u7F6E\u4E86\u8BE5\u503C\uFF0C\u5219\u8981\u6C42\u60A8\u7684\u73AF\u5883\u5177\u6709\u53EF\u7528\u4E8E Ingress \u7F51\u5173\u7684\u5916\u90E8\u8D1F\u8F7D\u5747\u8861\u5668\u3002\u5982\u679C EXTERNAL-IP \u503C\u662F &lt;none&gt;\uFF08\u6216\u4E00\u76F4\u662F &lt;pending&gt; \uFF09\uFF0C\u5219\u8BF4\u660E\u53EF\u80FD\u60A8\u7684\u73AF\u5883\u4E0D\u652F\u6301\u4E3A ingress \u7F51\u5173\u63D0\u4F9B\u5916\u90E8\u8D1F\u8F7D\u5747\u8861\u5668\u7684\u529F\u80FD\u3002\u5728\u8FD9\u79CD\u60C5\u51B5\u4E0B\uFF0C\u60A8\u53EF\u4EE5\u4F7F\u7528 Service \u7684 node port \u65B9\u5F0F\u8BBF\u95EE\u7F51\u5173\u3002</code></p></blockquote><p>\u4F7F\u7528 kubectl patch \u66F4\u65B0 istio-ingressgateway \u670D\u52A1\u7F51\u5173\u7C7B\u578B</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl patch service istio-ingressgateway -n istio-system -p &#39;{&quot;spec&quot;:{&quot;type&quot;:&quot;NodePort&quot;}}&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u8BBE\u7F6E\u5165\u53E3\u7AEF\u53E3</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.spec.ports[?(@.name==&quot;http2&quot;)].nodePort}&#39;</span><span class="token variable">)</span></span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">SECURE_INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.spec.ports[?(@.name==&quot;https&quot;)].nodePort}&#39;</span><span class="token variable">)</span></span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">TCP_INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.spec.ports[?(@.name==&quot;tcp&quot;)].nodePort}&#39;</span><span class="token variable">)</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u83B7\u53D6ingress ip\u5730\u5740</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">INGRESS_HOST</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get po <span class="token parameter variable">-l</span> <span class="token assign-left variable">istio</span><span class="token operator">=</span>ingressgateway <span class="token parameter variable">-n</span> istio-system <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.items[0].status.hostIP}&#39;</span><span class="token variable">)</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062327570.png" alt="image-20211214170233622"><h4 id="\u5E94\u7528\u9ED8\u8BA4\u76EE\u6807\u89C4\u5219\u{1F680}" tabindex="-1"><a class="header-anchor" href="#\u5E94\u7528\u9ED8\u8BA4\u76EE\u6807\u89C4\u5219\u{1F680}" aria-hidden="true">#</a> \u5E94\u7528\u9ED8\u8BA4\u76EE\u6807\u89C4\u5219\u{1F680}</h4>`,16),y={href:"https://istio.io/latest/docs/concepts/traffic-management/#destination-rules",target:"_blank",rel:"noopener noreferrer"},f=t(`<p>\u8FD0\u884C\u4EE5\u4E0B\u547D\u4EE4\u4E3A Bookinfo \u670D\u52A1\u521B\u5EFA\u9ED8\u8BA4\u76EE\u6807\u89C4\u5219\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/destination-rule-all.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,2),_=n("code",null,"default",-1),x=n("code",null,"demo",-1),T={href:"https://istio.io/latest/docs/setup/additional-setup/config-profiles/",target:"_blank",rel:"noopener noreferrer"},q={href:"https://istio.io/latest/docs/tasks/security/authentication/authn-policy/#auto-mutual-tls",target:"_blank",rel:"noopener noreferrer"},w=n("code",null,"samples/bookinfo/networking/destination-rule-all-mtls.yaml",-1),S=t(`<h4 id="\u6E05\u7406\u{1F680}" tabindex="-1"><a class="header-anchor" href="#\u6E05\u7406\u{1F680}" aria-hidden="true">#</a> \u6E05\u7406\u{1F680}</h4><p>\u5F53\u60A8\u5B8C\u6210 Bookinfo \u793A\u4F8B\u7684\u8BD5\u9A8C\u540E\uFF0C\u8BF7\u6309\u7167\u4EE5\u4E0B\u8BF4\u660E\u5378\u8F7D\u5E76\u6E05\u7406\u5B83\uFF1A</p><p>\u5220\u9664\u8DEF\u7531\u89C4\u5219\u5E76\u7EC8\u6B62\u5E94\u7528\u7A0B\u5E8F Pod</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ samples/bookinfo/platform/kube/cleanup.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u786E\u8BA4\u5173\u673A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl get virtualservices   <span class="token comment">#-- there should be no virtual services</span>
$ kubectl get destinationrules  <span class="token comment">#-- there should be no destination rules</span>
$ kubectl get gateway           <span class="token comment">#-- there should be no gateway</span>
$ kubectl get pods              <span class="token comment">#-- the Bookinfo pods should be deleted</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u4ECB\u7ECDistio\u6D41\u91CF\u7BA1\u7406" tabindex="-1"><a class="header-anchor" href="#\u4ECB\u7ECDistio\u6D41\u91CF\u7BA1\u7406" aria-hidden="true">#</a> \u4ECB\u7ECDIstio\u6D41\u91CF\u7BA1\u7406</h2><h4 id="\u9996\u5148\u662Fistio\u5982\u4F55\u5728\u7F51\u683C\u79CD\u5F15\u5BFC\u6D41\u91CF\u7684" tabindex="-1"><a class="header-anchor" href="#\u9996\u5148\u662Fistio\u5982\u4F55\u5728\u7F51\u683C\u79CD\u5F15\u5BFC\u6D41\u91CF\u7684" aria-hidden="true">#</a> \u9996\u5148\u662FIstio\u5982\u4F55\u5728\u7F51\u683C\u79CD\u5F15\u5BFC\u6D41\u91CF\u7684\uFF1F</h4><ol><li>\u9996\u5148\u8981\u77E5\u9053\u6240\u5728\u7684\u7AEF\u70B9\u5728\u54EA\u91CC\uFF1F</li><li>\u4EE5\u53CA\u5B83\u4EEC\u5C5E\u4E8E\u54EA\u4E9B\u670D\u52A1\uFF1F</li><li>\u586B\u5145\u81EA\u5DF1\u7684\u670D\u52A1\u6CE8\u518C\uFF08\u5C31\u662F\u5185\u90E8\u7684\u6CE8\u518C\u8868\uFF0C\u7528\u6765\u751F\u6210\u4E00\u4E9BEnvoy\u914D\u7F6E\uFF09\u8FDE\u63A5\u5230\u670D\u52A1\u53D1\u73B0\u7CFB\u7EDF\u3002</li><li>\u5728Kubernetes\u4E2D\u5B89\u88C5Istio\uFF0C\u90A3\u4E48Istio\u4F1A\u81EA\u52A8\u68C0\u6D4B\u96C6\u7FA4\u4E2D\u7684\u670D\u52A1\u548C\u7AEF\u70B9\u3002</li></ol><h4 id="\u5728kubernetes\u4E2D\u5982\u4F55\u4F7F\u7528istio" tabindex="-1"><a class="header-anchor" href="#\u5728kubernetes\u4E2D\u5982\u4F55\u4F7F\u7528istio" aria-hidden="true">#</a> \u5728Kubernetes\u4E2D\u5982\u4F55\u4F7F\u7528istio\uFF1F</h4><p>1.\u901A\u8FC7Kubernetes\u5B89\u88C5istio\u4E4B\u540E\u5BF9<code>K8S\u4F7F\u7528CRD\u6269\u5C55\uFF0C \u4E5F\u5C31\u662FKubernetes\u7684 API\u6269\u5C55</code>\uFF0Cistio\u4E5F\u80FD\u50CF\u5176\u4ED6 \u7684resouces\u4E00\u6837\u4F7F\u7528\u3002 2.\u901A\u8FC7\u4F7F\u7528Kubrenetes API\u7684\u6269\u5C55\uFF0C\u53EF\u4EE5\u4F7F\u7528\u8D44\u6E90\u6709 \u865A\u62DF\u670D\u52A1\u3001\u76EE\u7684\u89C4\u5219\u3001\u7F51\u5173\u3001\u670D\u52A1\u6761\u76EE\u3001\u8FB9\u8F66\u3002</p><h4 id="\u5728istio\u4E2D\u80FD\u5B66\u5230\u4EC0\u4E48" tabindex="-1"><a class="header-anchor" href="#\u5728istio\u4E2D\u80FD\u5B66\u5230\u4EC0\u4E48" aria-hidden="true">#</a> \u5728istio\u4E2D\u80FD\u5B66\u5230\u4EC0\u4E48\uFF1F</h4><p>1.\u53EF\u4EE5\u5B66\u4E60\u5230\u6D41\u91CF\u7684\u7BA1\u7406\u3001\u5165\u53E3\u51FA\u53E3\u6D41\u91CF\u7BA1\u7406\u3002</p><ul><li><code>\u8BF7\u6C42\u8DEF\u7531</code></li><li><code>\u6545\u969C\u6CE8\u5165</code></li><li><code>\u4EA4\u901A\u8F6C\u79FB</code></li><li><code>TCP\u6D41\u91CF\u8F6C\u79FB</code></li><li><code>\u8BF7\u6C42\u8D85\u65F6</code></li><li><code>\u7194\u65AD</code></li><li><code>\u955C\u50CF</code></li><li><code>\u5C40\u90E8\u8D1F\u8F7D\u5747\u8861</code></li><li><code>\u5165\u53E3\u7684\u7F51\u5173</code></li><li><code>\u51FA\u53E3\u7684\u8BBF\u95EE\u5916\u90E8\u670D\u52A1</code></li></ul><h4 id="\u4EC0\u4E48\u662F\u865A\u62DF\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#\u4EC0\u4E48\u662F\u865A\u62DF\u670D\u52A1" aria-hidden="true">#</a> \u4EC0\u4E48\u662F\u865A\u62DF\u670D\u52A1\uFF1F</h4><p>\u865A\u62DF\u670D\u52A1\u4EE5\u53CA\u76EE\u6807\u89C4\u5219\u662FIstio\u6D41\u91CF\u8DEF\u7531\u529F\u80FD\u7684\u5173\u952E\u6784\u5EFA\u5757\u3002\u865A\u62DF\u670D\u52A1\u5141\u8BB8\u60A8\u914D\u7F6E\u5982\u4F55\u5C06\u8BF7\u6C42\u7684\u8DEF\u7531\u5230Istio\u7684\u670D\u52A1\u7F51\u683C\u4E2D\u7684\u670D\u52A1\u3002 \u5EFA\u7ACB\u5728Istio\u548C\u60A8\u7684\u5E73\u53F0\u63D0\u4F9B\u57FA\u672C\u7684\u8FDE\u63A5\u548C\u53D1\u73B0\u4E4B\u4E0A\u3002\u6BCF\u4E00\u4E2A\u865A\u62DF\u670D\u52A1\u90FD\u5305\u542B\u4E86\u4E00\u7EC4\u6309\u987A\u5E8F\u8BC4\u4F30\u7684\u8DEF\u7531\u89C4\u5219\uFF0C\u8BA9Istio\u5C06\u6BCF\u4E00\u4E2A\u7ED9\u5B9A\u7684\u865A\u62DF\u670D\u52A1\u8BF7\u6C42\u5339\u914D\u5230\u7F51\u683C\u4E2D\u7279\u5B9A\u771F\u5B9E\u7684\u76EE\u7684\u5730\u3002</p><h4 id="\u4E3A\u4EC0\u4E48\u8981\u4F7F\u7528\u865A\u62DF\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#\u4E3A\u4EC0\u4E48\u8981\u4F7F\u7528\u865A\u62DF\u670D\u52A1" aria-hidden="true">#</a> \u4E3A\u4EC0\u4E48\u8981\u4F7F\u7528\u865A\u62DF\u670D\u52A1\uFF1F</h4><p>1.\u901A\u8FC7\u5C06\u5BA2\u6237\u7AEF\u4ECE\u5B9E\u9645\u5B9E\u73B0\u5B83\u4EEC\u7684\u76EE\u6807\u5DE5\u4F5C\u8D1F\u8F7D\u53D1\u9001\u8BF7\u6C42\u7684\u4F4D\u7F6E\u5F3A\u89E3\u8026\u6765\u505A\u5230\u8FD9\u4E00\u70B9\u3002\u865A\u62DF\u670D\u52A1\u8FD8\u63D0\u4F9B\u4E00\u79CD\u4E30\u5BCC\u7684\u65B9\u5F0F\u6765\u6307\u5B9A\u4E0D\u540C\u7684\u6D41\u91CF\u8DEF\u7531\u89C4\u5219\uFF0C\u4EE5\u5C06\u6D41\u91CF\u53D1\u9001\u5230\u8FD9\u4E9B\u5DE5\u4F5C\u8D1F\u8F7D\u3002</p><p>2.\u4E3A\u4EC0\u4E48\u8BF4\u8FD9\u5F88\u6709\u7528\uFF1F Envoy\u5728\u6240\u6709\u670D\u52A1\u5B9E\u4F8B\u4E4B\u95F4\u4F7F\u7528\u5FAA\u73AF\u8D1F\u8F7D\u5E73\u8861\u6765\u5206\u914D\u6D41\u91CF\uFF0C\u5BF9\u6B64\u8FDB\u884C\u4E86\u6539\u8FDB\uFF0C\u53EF\u4EE5\u9488\u5BF9\u767E\u5206\u6BD4\u8FDB\u884C\u7279\u5B9A\u7684\u6D41\u91CF\u5F15\u5BFC\u3002</p><p>3.\u53EF\u4EE5\u4E00\u4E2A\u6216\u8005\u591A\u4E2A\u6307\u5B9A\u4E3B\u673A\u540D\u6307\u5B9A\u6D41\u91CF\u884C\u4E3A\u3002 \u5728\u865A\u62DF\u670D\u52A1\u4E2D\uFF0C\u4F7F\u7528\u8DEF\u7531\u89C4\u5219\u6765\u544A\u8BC9Envoy\u5982\u4F55\u5C06\u865A\u62DF\u670D\u52A1\u7684\u6D41\u91CF\u53D1\u9001\u5230\u5408\u9002\u7684\u5730\u65B9\u3002</p><p>4.\u8FD8\u53EF\u4EE5\u5C06\u5355\u4E2A\u865A\u62DF\u670D\u52A1\u5904\u7406\u591A\u4E2A\u5E94\u7528\u7A0B\u5E8F\u3002 \u7ED3\u5408\u7F51\u5173\u7684\u6D41\u91CF\u89C4\u5219\uFF0C\u63A7\u5236\u6D41\u91CF\u8FDB\u51FA\u3002</p><h4 id="\u865A\u62DF\u670D\u52A1\u5B9E\u4F8B" tabindex="-1"><a class="header-anchor" href="#\u865A\u62DF\u670D\u52A1\u5B9E\u4F8B" aria-hidden="true">#</a> \u865A\u62DF\u670D\u52A1\u5B9E\u4F8B</h4><p>\u4EE5\u4E0B\u7684\u865A\u62DF\u670D\u52A1\u6839\u636E\u8BF7\u6C42\u662F\u5426\u6765\u81EA\u7279\u5B9A\u7684\u7528\u6237\uFF0C\u5C06\u8BF7\u6C42\u8DEF\u7531\u5230\u4E0D\u540C\u7248\u672C\u7684\u670D\u52A1\u3002</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
        <span class="token key atrule">end-user</span><span class="token punctuation">:</span>
          <span class="token key atrule">exact</span><span class="token punctuation">:</span> jason
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u4E3B\u673A\u5B57\u6BB5" tabindex="-1"><a class="header-anchor" href="#\u4E3B\u673A\u5B57\u6BB5" aria-hidden="true">#</a> \u4E3B\u673A\u5B57\u6BB5</h4><p>1.<code>hosts\u5B57\u6BB5</code>\u5217\u51FA\u4E86\u865A\u62DF\u670D\u52A1\u7684\u4E3B\u673A\uFF0C\u8FD9\u4E9B\u8DEF\u7531\u89C4\u5219\u9002\u7528\u7684\u7528\u6237\u53EF\u4EE5\u5BFB\u5740\u76EE\u7684\u6216\u76EE\u7684\u5730\u3002\u8FD9\u662F\u5BA2\u6237\u7AEF\u5728\u5411 \u670D\u52A1\u53D1\u9001\u8BF7\u6C42\u65F6\u4F7F\u7528\u7684\u5730\u5740\u3002 2.\u4E3B\u673A\u540D\u53EF\u4EE5\u662F<code>IP\u5730\u5740</code>\uFF0C\u4E5F\u53EF\u4EE5\u662F<code>DNS\u540D\u79F0</code>\u4EE5\u53CA\u89E3\u6790\u7684\u3002</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">hosts</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> reviews
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u8DEF\u7531\u89C4\u5219" tabindex="-1"><a class="header-anchor" href="#\u8DEF\u7531\u89C4\u5219" aria-hidden="true">#</a> \u8DEF\u7531\u89C4\u5219</h4><p>1.\u8BE5http\u90E8\u5206\u5305\u542B\u865A\u62DF\u670D\u52A1\u7684\u8DEF\u7531\u89C4\u5219\uFF0C\u63CF\u8FF0\u4E86\u5C06<code>HTTP/1.1 HTTP2\u548CgRPC\u6D41\u91CF</code>\u8DEF\u7531\u5230hosts\u5B57\u6BB5\u4E2D\u6307\u5B9A\u7684 \u76EE\u6807\u7684\u5339\u914D\u6761\u4EF6\u548C\u64CD\u4F5C\u3002 2.\u5339\u914D\u6761\u4EF6\uFF08\u793A\u4F8B\u4E2D\u7684\u7B2C\u4E00\u4E2A\u8DEF\u7531\u6709\u4E00\u4E2A\u6761\u4EF6\uFF0C\u56E0\u6B64\u4EE5match\u5B57\u6BB5\u5F00\u5934\u3002\u5728\u8FD9\u79CD\u60C5\u51B5\u4E0B\uFF0C\u60A8\u5E0C\u671B\u6B64\u8DEF\u7531\u9002 \u7528\u4E8E\u6765\u81EA\u7528\u6237\u2018jason\u2019\u7684\u6240\u6709\u8BF7\u6C42\uFF0C\u56E0\u6B64\u60A8\u4F7F\u7528headers\u3001end-user\u548Cexact\u5B57\u6BB5\u6765\u9009\u62E9\u9002\u5F53\u7684\u8BF7\u6C42\u3002\uFF09</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
   <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
       <span class="token key atrule">end-user</span><span class="token punctuation">:</span>
         <span class="token key atrule">exact</span><span class="token punctuation">:</span> jason
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u76EE\u7684\u5730" tabindex="-1"><a class="header-anchor" href="#\u76EE\u7684\u5730" aria-hidden="true">#</a> \u76EE\u7684\u5730</h4><p>\u8DEF\u7531\u90E8\u5206<code>destination\u5B57\u6BB5</code>\u6307\u5B9A\u7B26\u5408\u6761\u4EF6\u7684\u6D41\u91CF\u5B9E\u9645\u76EE\u7684\u5730\u3002 \u4E0E\u865A\u62DF\u4E3B\u673A\u4E0D\u540C\uFF0C\u76EE\u6807\u4E3B\u673A\u5FC5\u987B\u5B58\u5728\u4E8Eistio\u670D\u52A1\u6CE8\u518C\u8868\u4E2D\u771F\u5B9E\u76EE\u6807\uFF0C\u5426\u5219Envoy\u5C06\u4E0D\u77E5\u9053\u5C06\u6D41\u91CF\u53D1\u9001\u5230\u4F55\u5904\u3002</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>route\uFF1A
<span class="token punctuation">-</span> <span class="token key atrule">destintion</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
    <span class="token key atrule">subnet</span><span class="token punctuation">:</span> v2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u8DEF\u7531\u89C4\u5219\u4F18\u5148\u7EA7" tabindex="-1"><a class="header-anchor" href="#\u8DEF\u7531\u89C4\u5219\u4F18\u5148\u7EA7" aria-hidden="true">#</a> \u8DEF\u7531\u89C4\u5219\u4F18\u5148\u7EA7</h4><p>\u8DEF\u7531\u89C4\u5219\u6309\u7167\u4E0A\u5230\u4E0B\u7684\u987A\u5E8F\u8FDB\u884C\u8BC4\u4F30\uFF0C<code>\u865A\u62DF\u670D\u52A1\u5B9A\u4E49\u4E2D\u7684\u7B2C\u4E00\u4E2A\u89C4\u5219\u88AB\u8D4B\u4E88\u6700\u9AD8\u4F18\u5148\u7EA7\u3002</code> \u5728\u8FD9\u79CD\u60C5\u51B5\u4E0B \uFF0C\u60A8\u5E0C\u671B\u4EFB\u4F55\u7B2C\u4E00\u6761\u8DEF\u7531\u89C4\u5219\u4E0D\u5339\u914D\u7684\u4E1C\u897F\u90FD\u8F6C\u5230\u7B2C\u4E8C\u6761\u89C4\u5219\u4E2D\u6307\u5B9A\u9ED8\u8BA4\u7684\u76EE\u7684\u5730\u3002 \u56E0\u6B64\uFF0C\u7B2C\u4E8C\u6761\u89C4\u5219 \u6CA1\u6709\u5339\u914D\u6761\u4EF6\uFF0C\u53EA\u662F\u5C06\u6D41\u91CF\u5B9A\u5411\u5230v3\u5B50\u96C6\u3002</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
      <span class="token key atrule">subnet</span><span class="token punctuation">:</span> v3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u6709\u5173\u8DEF\u7531\u7684\u66F4\u591A\u4FE1\u606F" tabindex="-1"><a class="header-anchor" href="#\u6709\u5173\u8DEF\u7531\u7684\u66F4\u591A\u4FE1\u606F" aria-hidden="true">#</a> \u6709\u5173\u8DEF\u7531\u7684\u66F4\u591A\u4FE1\u606F</h4><p>\u8DEF\u7531\u89C4\u5219\u662F\u5C06\u7279\u5B9A\u6D41\u91CF\u5B50\u96C6\u8DEF\u7531\u5230\u7279\u5B9A\u76EE\u7684\u5730\u7684\u5F3A\u5927\u5DE5\u5177\u3002<code>\u60A8\u53EF\u4EE5\u5BF9\u6D41\u91CF\u7AEF\u53E3\u3001\u6807\u5934\u5B57\u6BB5\u3001URL\u7B49\u8BBE\u7F6E\u5339 \u914D\u6761\u4EF6</code>\uFF0C\u4F8B\u5982\uFF1A\u6B64\u865A\u62DF\u670D\u52A1\u5141\u8BB8\u7528\u6237\u5C06\u6D41\u91CF\u53D1\u9001\u5230\u4E24\u4E2A\u5355\u72EC\u7684\u670D\u52A1\uFF0C\u8BC4\u5206\u548C\u8BC4\u8BBA\uFF0C\u5C31\u597D\u50CF\u5B83\u4EEC\u662F\u66F4\u5927\u7684\u865A\u62DF\u670D\u52A1\u7684\u4E00\u90E8\u5206\u4E00\u6837\u3002\u865A\u62DF\u670D\u52A1\u89C4\u5219\u6839\u636E\u8BF7\u6C42\u7684URL\u5339\u914D\u6D41\u91CF\uFF0C\u5E76\u5C06\u6D41\u91CF\u8BF7\u6C42\u5B9A\u5411\u5230\u5408\u9002\u7684\u670D\u52A1\u3002</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> bookinfo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> bookinfo.com
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /reviews
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /ratings
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u9664\u4E86\u4F7F\u7528\u5339\u914D\u6761\u4EF6\u5916\uFF0C\u60A8\u8FD8\u53EF\u4EE5\u6309&quot;\u6743\u91CD&quot;\u767E\u5206\u6BD4\u5206\u914D\u6D41\u91CF\u3002\u8FD9\u5BF9\u4E8EA/B\u6D4B\u8BD5\u548C\u91D1\u4E1D\u96C0\u53D1\u5E03\u5F88\u6709\u7528\u3002</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> route
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subnet</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">75</span>
  <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
      <span class="token key atrule">subnet</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">25</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u60A8\u8FD8\u53EF\u4EE5\u4F7F\u7528\u8DEF\u7531\u89C4\u5219\u5BF9\u6D41\u91CF\u6267\u884C\u4E00\u4E9B\u64CD\u4F5C\uFF0C\u4F8B\u5982\uFF1A</p><ul><li><code>\u9644\u52A0\u6216\u5220\u9664\u6807\u9898</code></li><li><code>\u91CD\u5199\u7F51\u5740</code></li><li><code>\u4E3A\u5BF9\u8BE5\u76EE\u7684\u5730\u7684\u8C03\u7528\u8BBE\u7F6E\u91CD\u8BD5\u7B56\u7565</code></li></ul><h4 id="\u76EE\u7684\u5730\u89C4\u5219" tabindex="-1"><a class="header-anchor" href="#\u76EE\u7684\u5730\u89C4\u5219" aria-hidden="true">#</a> \u76EE\u7684\u5730\u89C4\u5219</h4><p>1.\u76EE\u6807\u89C4\u5219\u662FIstio\u6D41\u91CF\u8DEF\u7531\u529F\u80FD\u7684\u5173\u952E\u90E8\u5206\u3002\u53EF\u4EE5\u5C06\u865A\u62DF\u670D\u52A1\u89C6\u4E3A\u6D41\u91CF\u5C06\u8DEF\u7531\u7ED9\u5B9A\u76EE \u7684\u5730\u7684\u65B9\u5F0F\uFF0C\u76EE\u6807\u89C4\u5219\u5728\u8BC4\u4F30\u865A\u62DF\u670D\u52A1\u8DEF\u7531\u89C4\u5219\u540E\u5E94\u7528\uFF0C\u56E0\u6B64\u5B83\u4EEC\u9002\u7528\u4E8E\u6D41\u91CF\u7684&quot;\u771F\u5B9E&quot;\u76EE\u6807\u3002 2.\u7279\u522B\u662F\uFF0C\u60A8\u4F7F\u7528\u76EE\u6807\u89C4\u5219\u6765\u6307\u5B9A\u547D\u540D\u7684\u670D\u52A1\u5B50\u96C6\uFF0C\u4F8B\u5982\u6309\u7248\u672C\u5BF9\u6240\u6709\u7ED9\u5B9A\u670D\u52A1\u7684\u5B9E\u4F8B\u8FDB\u884C\u5206\u7EC4\u3002\u7136\u540E\uFF0C\u60A8\u53EF\u4EE5\u5728\u865A\u62DF\u670D\u52A1\u7684\u8DEF\u7531\u89C4\u5219\u4E2D\u4F7F\u7528\u8FD9\u4E9B\u670D\u52A1\u5B50\u96C6\u6765\u63A7\u5236\u5230\u4E0D\u540C\u670D\u52A1\u5B9E\u4F8B\u7684\u6D41\u91CF\u3002 3.\u76EE\u6807\u89C4\u5219\u8FD8\u5141\u8BB8\u60A8\u5728\u8C03\u7528\u6574\u4E2A\u76EE\u6807\u670D\u52A1\u6216\u7279\u5B9A\u670D\u52A1\u5B50\u96C6\u65F6\u81EA\u5B9A\u4E49 Envoy \u7684\u6D41\u91CF\u7B56\u7565\uFF0C\u4F8B\u5982\u60A8\u9996\u9009\u7684\u8D1F \u8F7D\u5E73\u8861\u6A21\u578B\u3001TLS \u5B89\u5168\u6A21\u5F0F\u6216\u65AD\u8DEF\u5668\u8BBE\u7F6E\u3002</p><h4 id="\u8D1F\u8F7D\u5E73\u8861\u9009\u9879" tabindex="-1"><a class="header-anchor" href="#\u8D1F\u8F7D\u5E73\u8861\u9009\u9879" aria-hidden="true">#</a> \u8D1F\u8F7D\u5E73\u8861\u9009\u9879</h4><p>\u9ED8\u8BA4\u60C5\u51B5\u4E0B\uFF0CIstio \u4F7F\u7528\u5FAA\u73AF\u8D1F\u8F7D\u5747\u8861\u7B56\u7565\uFF0C\u5B9E\u4F8B\u6C60\u4E2D\u7684\u6BCF\u4E2A\u670D\u52A1\u5B9E\u4F8B\u4F9D\u6B21\u6536\u5230\u8BF7\u6C42\u3002Istio \u8FD8\u652F\u6301\u4EE5\u4E0B\u6A21\u578B\uFF0C\u60A8\u53EF\u4EE5\u5728\u76EE\u6807\u89C4\u5219\u4E2D\u4E3A\u5BF9\u7279\u5B9A\u670D\u52A1\u6216\u670D\u52A1\u5B50\u96C6\u7684\u8BF7\u6C42\u6307\u5B9A\u8FD9\u4E9B\u6A21\u578B\u3002</p><ul><li><code>\u968F\u673A\uFF1A</code>\u8BF7\u6C42\u968F\u673A\u8F6C\u53D1\u5230\u6C60\u4E2D\u7684\u5B9E\u4F8B\u3002</li><li><code>\u52A0\u6743\uFF1A</code>\u6839\u636E\u7279\u5B9A\u767E\u5206\u6BD4\u5C06\u8BF7\u6C42\u8F6C\u53D1\u5230\u6C60\u4E2D\u7684\u5B9E\u4F8B\u3002</li><li><code>\u6700\u5C11\u8BF7\u6C42\uFF1A</code>\u8BF7\u6C42\u88AB\u8F6C\u53D1\u5230\u8BF7\u6C42\u6570\u91CF\u6700\u5C11\u7684\u5B9E\u4F8B\u3002</li></ul><h4 id="\u76EE\u6807\u89C4\u5219\u793A\u4F8B" tabindex="-1"><a class="header-anchor" href="#\u76EE\u6807\u89C4\u5219\u793A\u4F8B" aria-hidden="true">#</a> \u76EE\u6807\u89C4\u5219\u793A\u4F8B</h4><p>\u4EE5\u4E0B\u793A\u4F8B\u76EE\u6807\u89C4\u5219\u4E3Amy-svc\u76EE\u6807\u670D\u52A1\u914D\u7F6E\u4E86\u4E09\u4E2A\u4E0D\u540C\u7684\u5B50\u96C6\uFF0C\u5177\u6709\u4E0D\u540C\u7684\u8D1F\u8F7D\u5E73\u8861\u7B56\u7565\uFF1A</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>destination<span class="token punctuation">-</span>rule
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>svc
  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>
      <span class="token key atrule">simple</span><span class="token punctuation">:</span> RANDOM
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
      <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>
        <span class="token key atrule">simple</span><span class="token punctuation">:</span> ROUND_ROBIN
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v3
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6BCF\u4E2A\u5B50\u96C6\u90FD\u662F\u57FA\u4E8E\u4E00\u4E2A\u6216\u591A\u4E2A\u5B9A\u4E49\u7684labels\uFF0C\u5728Kubernetes\u4E2D\uFF0C\u5B83\u4EEC\u662F\u9644\u52A0\u5230Pod\u7B49\u5BF9\u8C61\u7684\u952E/\u503C\u5BF9\u3002\u8FD9\u4E9B\u6807\u7B7E\u5E94\u7528\u4E8EKubernetes\u670D\u52A1\u7684\u90E8\u7F72\uFF0Cmetadata\u4EE5\u8BC6\u522B\u4E0D\u540C\u7684\u7248\u672C\u3002</p><p>\u9664\u4E86\u5B9A\u4E49\u5B50\u96C6\u4E4B\u5916\uFF0C\u6B64\u76EE\u6807\u89C4\u5219\u8FD8\u5177\u6709\u9488\u5BF9\u6B64\u76EE\u6807\u4E2D\u6240\u6709\u5B50\u96C6\u7684\u9ED8\u8BA4\u6D41\u91CF\u7B56\u7565\u548C\u4EC5\u9488\u5BF9\u8BE5\u5B50\u96C6\u8986\u76D6\u5B83\u7684\u5B50\u96C6\u7279\u5B9A\u7B56\u7565\u3002\u5728\u8BE5\u5B57\u6BB5\u4E0A\u65B9\u5B9A\u4E49\u7684\u9ED8\u8BA4\u7B56\u7565\u4E3A\u548C\u5B50\u96C6subsets \u8BBE\u7F6E\u7B80\u5355\u7684\u968F\u673A\u8D1F\u8F7D\u5747\u8861\u5668\u3002\u5728 \u7B56\u7565\u4E2D\uFF0C \u5728\u76F8\u5E94\u5B50\u96C6\u7684\u5B57\u6BB5\u4E2D\u6307\u5B9A\u4E86\u5FAA\u73AF\u8D1F\u8F7D\u5747\u8861\u5668\u3002v1v3v2</p><h4 id="\u7F51\u5173" tabindex="-1"><a class="header-anchor" href="#\u7F51\u5173" aria-hidden="true">#</a> \u7F51\u5173</h4><p>1.\u60A8\u4F7F\u7528\u7F51\u5173\u6765\u7BA1\u7406\u7F51\u683C\u7684\u5165\u7AD9\u548C\u51FA\u7AD9\u6D41\u91CF\uFF0C\u8BA9\u60A8<code>\u6307\u5B9A\u8981\u8FDB\u5165\u6216\u79BB\u5F00\u7F51\u683C\u7684\u6D41\u91CF</code>\u3002\u7F51\u5173\u914D\u7F6E\u5E94\u7528\u4E8E\u5728\u7F51\u683C\u8FB9\u7F18\u8FD0\u884C\u7684\u72EC\u7ACB Envoy \u4EE3\u7406\uFF0C\u800C\u4E0D\u662F\u4E0E\u670D\u52A1\u5DE5\u4F5C\u8D1F\u8F7D\u4E00\u8D77\u8FD0\u884C\u7684 Sidecar Envoy \u4EE3\u7406\u3002 2.\u4E0E\u63A7\u5236\u8FDB\u5165\u7CFB\u7EDF\u7684\u6D41\u91CF\u7684\u5176\u4ED6\u673A\u5236\uFF08\u4F8B\u5982 Kubernetes Ingress API\uFF09\u4E0D\u540C\uFF0C<code>Istio \u7F51\u5173\u8BA9\u60A8\u53EF\u4EE5\u4F7F\u7528 Istio \u6D41\u91CF\u8DEF\u7531\u7684\u5168\u90E8\u529F\u80FD\u548C\u7075\u6D3B\u6027</code>\u3002\u60A8\u53EF\u4EE5\u8FD9\u6837\u505A\uFF0C\u56E0\u4E3A Istio \u7684\u7F51\u5173\u8D44\u6E90\u53EA\u5141\u8BB8\u60A8\u914D\u7F6E 4-6 \u5C42\u8D1F\u8F7D\u5E73\u8861\u5C5E\u6027\uFF0C\u4F8B\u5982\u8981\u516C\u5F00\u7684\u7AEF\u53E3\u3001TLS \u8BBE\u7F6E\u7B49\u3002\u7136\u540E\uFF0C\u60A8\u65E0\u9700\u5C06\u5E94\u7528\u5C42\u6D41\u91CF\u8DEF\u7531 (L7) \u6DFB\u52A0\u5230\u540C\u4E00 API \u8D44 \u6E90\uFF0C\u800C\u662F\u5C06\u5E38\u89C4 Istio\u865A\u62DF\u670D\u52A1\u7ED1\u5B9A\u5230\u7F51\u5173\u3002\u8FD9\u4F7F\u60A8\u53EF\u4EE5\u50CF\u7BA1\u7406 Istio \u7F51\u683C\u4E2D\u7684\u4EFB\u4F55\u5176\u4ED6\u6570\u636E\u5E73\u9762\u6D41\u91CF \u4E00\u6837\u7BA1\u7406\u7F51\u5173\u6D41\u91CF\u3002 3.<code>\u7F51\u5173\u4E3B\u8981\u7528\u4E8E\u7BA1\u7406\u5165\u53E3\u6D41\u91CF\uFF0C\u4F46\u60A8\u4E5F\u53EF\u4EE5\u914D\u7F6E\u51FA\u53E3\u7F51\u5173</code>\u3002\u4F8B\u5982\uFF0C\u51FA\u53E3\u7F51\u5173\u5141\u8BB8\u60A8\u4E3A\u79BB\u5F00\u7F51\u683C\u7684\u6D41\u91CF\u914D\u7F6E\u4E13\u7528\u51FA\u53E3\u8282\u70B9\uFF0C\u8BA9\u60A8\u9650\u5236\u54EA\u4E9B\u670D\u52A1\u53EF\u4EE5\u6216\u5E94\u8BE5\u8BBF\u95EE\u5916\u90E8\u7F51\u7EDC\uFF0C\u6216\u8005\u542F\u7528 \u5BF9\u51FA\u53E3\u6D41\u91CF\u7684\u5B89\u5168\u63A7\u5236 \u4EE5\u589E\u52A0\u7F51\u683C\u7684\u5B89\u5168\u6027\u3002\u60A8\u8FD8\u53EF\u4EE5\u4F7F\u7528\u7F51\u5173\u6765\u914D\u7F6E\u7EAF\u5185\u90E8\u4EE3\u7406\u3002 4.Istio \u63D0\u4F9B\u4E86\u4E00\u4E9B\u60A8\u53EF\u4EE5\u4F7F\u7528\u7684\u9884\u914D\u7F6E\u7F51\u5173\u4EE3\u7406\u90E8\u7F72 (istio-ingressgateway\u548Cistio-egressgateway)\u5982\u679C\u60A8\u4F7F\u7528\u6211\u4EEC\u7684\u6F14\u793A\u5B89\u88C5\uFF0C\u5219\u4F1A\u90E8\u7F72\u4E24\u8005\uFF0C\u800C\u4EC5\u4F7F\u7528\u6211\u4EEC\u7684\u9ED8\u8BA4\u914D\u7F6E\u6587\u4EF6\u90E8\u7F72\u5165\u53E3\u7F51\u5173 \u3002\u60A8\u53EF\u4EE5\u5C06\u81EA \u5DF1\u7684\u7F51\u5173\u914D\u7F6E\u5E94\u7528\u4E8E\u8FD9\u4E9B\u90E8\u7F72\uFF0C\u6216\u8005\u90E8\u7F72\u548C\u914D\u7F6E\u81EA\u5DF1\u7684\u7F51\u5173\u4EE3\u7406\u3002</p><h4 id="\u7F51\u5173\u793A\u4F8B" tabindex="-1"><a class="header-anchor" href="#\u7F51\u5173\u793A\u4F8B" aria-hidden="true">#</a> \u7F51\u5173\u793A\u4F8B</h4><p>\u4EE5\u4E0B\u793A\u4F8B\u663E\u793A\u4E86\u5916\u90E8 HTTPS \u5165\u53E3\u6D41\u91CF\u7684\u53EF\u80FD\u7F51\u5173\u914D\u7F6E\uFF1A \u6B64\u7F51\u5173\u914D\u7F6E<code>\u5141\u8BB8 HTTPS \u6D41\u91CF</code>\u4ECE<code>ext-host.example.com\u7AEF\u53E3 443 \u8FDB\u5165\u7F51\u683C</code>\uFF0C\u4F46\u6CA1\u6709\u4E3A\u6D41\u91CF\u6307\u5B9A\u4EFB\u4F55\u8DEF\u7531\u3002</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ext<span class="token punctuation">-</span>host<span class="token punctuation">-</span>gwy
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>gateway<span class="token punctuation">-</span>controller
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> https
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ext<span class="token punctuation">-</span>host.example.com
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE
      <span class="token key atrule">credentialName</span><span class="token punctuation">:</span> ext<span class="token punctuation">-</span>host<span class="token punctuation">-</span>cert
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8981\u6307\u5B9A\u8DEF\u7531\u5E76\u4F7F\u7F51\u5173\u6309\u9884\u671F\u5DE5\u4F5C\uFF0C\u60A8\u8FD8\u5FC5\u987B\u5C06\u7F51\u5173\u7ED1\u5B9A\u5230\u865A\u62DF\u670D\u52A1\u3002\u60A8\u53EF\u4EE5\u4F7F\u7528\u865A\u62DF\u670D\u52A1\u7684gateways\u5B57 \u6BB5\u6267\u884C\u6B64\u64CD\u4F5C\uFF0C\u5982\u4EE5\u4E0B\u793A\u4F8B\u6240\u793A\uFF1A</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> virtual<span class="token punctuation">-</span>svc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ext<span class="token punctuation">-</span>host.example.com
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ext<span class="token punctuation">-</span>host<span class="token punctuation">-</span>gwy
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7136\u540E\uFF0C\u60A8\u53EF\u4EE5\u4F7F\u7528\u5916\u90E8\u6D41\u91CF\u7684\u8DEF\u7531\u89C4\u5219\u914D\u7F6E\u865A\u62DF\u670D\u52A1\u3002</p><h4 id="\u670D\u52A1\u6761\u76EE" tabindex="-1"><a class="header-anchor" href="#\u670D\u52A1\u6761\u76EE" aria-hidden="true">#</a> \u670D\u52A1\u6761\u76EE</h4><p>\u60A8\u53EF\u4EE5\u4F7F\u7528\u670D\u52A1\u6761\u76EE\u5411Istio\u5185\u90E8\u7EF4\u62A4\u7684\u670D\u52A1\u6CE8\u518C\u8868\u6DFB\u52A0\u4E00\u4E2A\u6761\u76EE\u3002\u6DFB\u52A0\u670D\u52A1\u6761\u76EE\u4E4B\u540E\uFF0CEnvoy\u4EE3\u7406\u53EF\u4EE5\u5C06\u6D41\u91CF\u53D1\u9001\u5230\u670D\u52A1\uFF0C\u5C31\u597D\u50CF\u5B83\u662F\u7F51\u683C\u4E2D\u7684\u670D\u52A1\u4E00\u6837\u3002\u914D\u7F6E\u670D\u52A1\u6761\u76EE\u5141\u8BB8\u60A8\u7BA1\u7406\u5728\u7F51\u683C\u4E4B\u5916\u5141\u8BB8\u7684\u670D\u52A1\u6D41\u91CF\uFF0C\u5305\u62EC\u4EE5\u4E0B\u4EFB\u52A1\uFF1A</p><ul><li><code>\u91CD\u5B9A\u5411\u548C\u8F6C\u53D1\u5916\u90E8\u76EE\u7684\u5730\u7684\u6D41\u91CF</code>\uFF0C\u4F8B\u5982\u4ECEweb\u4F7F\u7528\u7684API\uFF0C\u6216\u5230\u65E7\u57FA\u7840\u8BBE\u65BD\u4E2D\u7684\u670D\u52A1\u6D41\u91CF\u3002</li><li><code>\u4E3A\u5916\u90E8\u76EE\u6807\u5B9A\u4E49\u91CD\u8BD5\u3001\u8D85\u65F6\u548C\u6545\u969C\u6CE8\u5165\u7B56\u7565\u3002</code></li><li><code>\u901A\u8FC7\u865A\u62DF\u673A\u6DFB\u52A0\u7F51\u683C\u4E2D\uFF0C\u5728\u865A\u62DF\u673A\u4E2D\u5141\u8BB8\u7F51\u683C\u670D\u52A1\u3002</code></li></ul><p>\u60A8\u65E0\u9700\u5E0C\u671B\u7F51\u683C\u670D\u52A1\u4F7F\u7528\u7684\u6BCF\u4E2A\u5916\u90E8\u670D\u52A1\u6DFB\u52A0\u670D\u52A1\u6761\u76EE\uFF0C\u9ED8\u8BA4\u60C5\u51B5\u4E0B\uFF0CIstio\u5C06Envoy\u4EE3\u7406\u8BBE\u7F6E\u4E3A\u5C06\u8BF7\u6C42\u4F20\u9012\u7ED9\u672A\u77E5\u670D\u52A1\u3002\u4F46\u662F\uFF0C\u60A8\u4E0D\u80FD\u4F7F\u7528Istio\u529F\u80FD\u6765\u63A7\u5236\u5230\u672A\u6765\u5728\u7F51\u683C\u4E2D\u6CE8\u518C\u7684\u76EE\u7684\u5730\u6D41\u91CF\u3002</p><h4 id="\u670D\u52A1\u5165\u53E3\u793A\u4F8B" tabindex="-1"><a class="header-anchor" href="#\u670D\u52A1\u5165\u53E3\u793A\u4F8B" aria-hidden="true">#</a> \u670D\u52A1\u5165\u53E3\u793A\u4F8B</h4><p>\u4EE5\u4E0B\u793A\u4F8B\u7F51\u683C\u5916\u90E8\u670D\u52A1\u6761\u76EE<code>\u5C06ext-svc.example.com \u5916\u90E8\u4F9D\u8D56\u9879\u6DFB\u52A0\u5230 Istio \u7684\u670D\u52A1\u6CE8\u518C\u8868</code>\uFF1A \u60A8\u4F7F\u7528\u8BE5hosts\u5B57\u6BB5\u6307\u5B9A\u5916\u90E8\u8D44\u6E90\u3002\u60A8\u53EF\u4EE5\u5B8C\u5168\u9650\u5B9A\u5B83\u6216\u4F7F\u7528\u901A\u914D\u7B26\u524D\u7F00\u7684\u57DF\u540D\u3002</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceEntry
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> svc<span class="token punctuation">-</span>entry
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ext<span class="token punctuation">-</span>svc.example.com
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> https
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
  <span class="token key atrule">location</span><span class="token punctuation">:</span> MESH_EXTERNAL
  <span class="token key atrule">resolution</span><span class="token punctuation">:</span> DNS
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u60A8\u53EF\u4EE5\u914D\u7F6E\u865A\u62DF\u670D\u52A1\u548C\u76EE\u6807\u89C4\u5219\uFF0C\u4EE5\u66F4\u7CBE\u7EC6\u7684\u65B9\u5F0F\u63A7\u5236\u670D\u52A1\u6761\u76EE\u7684\u6D41\u91CF\uFF0C\u5C31\u50CF\u4E3A\u7F51\u683C\u4E2D\u7684\u4EFB\u4F55\u5176\u4ED6\u670D\u52A1\u914D\u7F6E\u6D41\u91CF\u4E00\u6837\u3002\u4F8B\u5982\uFF0C\u4EE5\u4E0B\u76EE\u6807\u89C4\u5219\u5C06\u6D41\u91CF\u8DEF\u7531\u914D\u7F6E\u4E3A\u4F7F\u7528<code>\u53CC\u5411 TLS \u6765\u4FDD\u62A4\u4E0E ext-svc.example.com\u6211\u4EEC \u4F7F\u7528\u670D\u52A1\u6761\u76EE\u914D\u7F6E\u7684\u5916\u90E8\u670D\u52A1\u7684\u8FDE\u63A5</code>\uFF1A</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ext<span class="token punctuation">-</span>res<span class="token punctuation">-</span>dr
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> ext<span class="token punctuation">-</span>svc.example.com
  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> MUTUAL
      <span class="token key atrule">clientCertificate</span><span class="token punctuation">:</span> /etc/certs/myclientcert.pem
      <span class="token key atrule">privateKey</span><span class="token punctuation">:</span> /etc/certs/client_private_key.pem
      <span class="token key atrule">caCertificates</span><span class="token punctuation">:</span> /etc/certs/rootcacerts.pem
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u8FB9\u8F66" tabindex="-1"><a class="header-anchor" href="#\u8FB9\u8F66" aria-hidden="true">#</a> \u8FB9\u8F66</h4><p>\u9ED8\u8BA4\u60C5\u51B5\u4E0B\uFF0CIstio\u5C06\u6BCF\u4E2AEnvo\u4EE3\u7406\u914D\u7F6E\u4E3A\u63A5\u53D7\u5176\u76F8\u5173\u5DE5\u4F5C\u8D1F\u8F7D\u7684\u6240\u6709\u7AEF\u53E3\u4E0A\u7684\u6D41\u91CF\uFF0C\u5E76\u5728\u8F6C\u53D1\u6D41\u91CF\u65F6\u5230 \u8FBE\u7F51\u683C\u4E2D\u7684\u6BCF\u4E2A\u5DE5\u4F5C\u8D1F\u8F7D\u3002\u60A8\u53EF\u4EE5\u4F7F\u7528sidecar\u914D\u7F6E\u6267\u884C\u4EE5\u4E0B\u64CD\u4F5C\uFF1A</p><ul><li><code>\u5FAE\u8C03Envoy\u4EE3\u7406\u63A5\u53D7\u7684\u7AEF\u53E3\u548C\u534F\u8BAE\u96C6</code></li><li><code>\u9650\u5236Envoy\u4EE3\u7406\u53EF\u4EE5\u8BBF\u95EE\u7684\u670D\u52A1\u96C6</code></li></ul><p>\u60A8\u53EF\u80FD\u5E0C\u671B\u5728\u5927\u578B\u7684\u5E94\u7528\u7A0B\u5E8F\u50CF\u8FD9\u6837\u9650\u5236sidecar\u7684\u53EF\u8BBF\u95EE\u6027\uFF0C\u5176\u4E2D\u5C06\u6BCF\u4E2A\u4EE3\u7406\u914D\u7F6E\u4E3A\u8BBF\u95EE\u7F51\u683C\u4E2D\u7684\u6240\u6709 \u5176\u4ED6\u670D\u52A1\u53EF\u80FD\u4F1A\u7531\u4E8E\u9AD8\u5185\u5B58\u7684\u4F7F\u7528\u7387\u800C\u5F71\u54CD\u7F51\u683C\u7684\u6027\u80FD\u3002</p><p>\u60A8\u53EF\u4EE5\u6307\u5B9A\u5E0C\u671B\u5C06 sidecar \u914D\u7F6E\u5E94\u7528\u4E8E\u7279\u5B9A\u547D\u540D\u7A7A\u95F4\u4E2D\u7684\u6240\u6709\u5DE5\u4F5C\u8D1F\u8F7D\uFF0C\u6216\u8005\u4F7F\u7528 workloadSelector. \u4F8B\u5982\uFF0C\u4EE5\u4E0B sidecar \u914D\u7F6E\u5C06\u547D\u540D\u7A7A\u95F4\u4E2D\u7684\u6240\u6709\u670D\u52A1\u914D\u7F6Ebookinfo\u4E3A\u4EC5\u8BBF\u95EE\u5728\u540C\u4E00\u547D\u540D\u7A7A\u95F4\u548C Istio \u63A7\u5236\u5E73\u9762\u4E2D\u8FD0\u884C\u7684\u670D\u52A1\uFF08Istio \u7684\u51FA\u53E3\u548C\u9065\u6D4B\u529F\u80FD\u9700\u8981\uFF09\uFF1A</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Sidecar
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> default
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> bookinfo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">egress</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;./*&quot;</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;istio-system/*&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u7F51\u7EDC\u5F39\u6027\u548C\u6D4B\u8BD5" tabindex="-1"><a class="header-anchor" href="#\u7F51\u7EDC\u5F39\u6027\u548C\u6D4B\u8BD5" aria-hidden="true">#</a> \u7F51\u7EDC\u5F39\u6027\u548C\u6D4B\u8BD5</h4><p>\u9664\u4E86\u5E2E\u52A9\u60A8\u5F15\u5BFC\u7F51\u683C\u5468\u56F4\u7684\u6D41\u91CF\u5916\uFF0CIstio \u8FD8\u63D0\u4F9B\u4E86\u53EF\u9009\u7684\u6545\u969C\u6062\u590D\u548C\u6545\u969C\u6CE8\u5165\u529F\u80FD\uFF0C\u60A8\u53EF\u4EE5\u5728\u8FD0\u884C\u65F6\u52A8\u6001\u914D\u7F6E\u8FD9\u4E9B\u529F\u80FD\u3002\u4F7F\u7528\u8FD9\u4E9B\u529F\u80FD\u53EF\u4EE5\u5E2E\u52A9\u60A8\u7684\u5E94\u7528\u7A0B\u5E8F\u53EF\u9760\u5730\u8FD0\u884C\uFF0C\u786E\u4FDD\u670D\u52A1\u7F51\u683C\u53EF\u4EE5\u5BB9\u5FCD\u6545\u969C\u8282\u70B9\u5E76\u9632\u6B62\u5C40\u90E8\u6545\u969C\u7EA7\u8054\u5230\u5176\u4ED6\u8282\u70B9\u3002</p><h4 id="\u8D85\u65F6" tabindex="-1"><a class="header-anchor" href="#\u8D85\u65F6" aria-hidden="true">#</a> \u8D85\u65F6</h4><p><code>\u8D85\u65F6\u662F Envoy \u4EE3\u7406\u5E94\u8BE5\u7B49\u5F85\u6765\u81EA\u7ED9\u5B9A\u670D\u52A1\u7684\u56DE\u590D\u7684\u65F6\u95F4\u91CF\uFF0C\u786E\u4FDD\u670D\u52A1\u4E0D\u4F1A\u65E0\u9650\u671F\u5730\u7B49\u5F85\u56DE\u590D\uFF0C\u5E76\u4E14\u8C03\u7528 \u5728\u53EF\u9884\u6D4B\u7684\u65F6\u95F4\u8303\u56F4\u5185\u6210\u529F\u6216\u5931\u8D25\u3002</code>\u9ED8\u8BA4\u60C5\u51B5\u4E0B\uFF0CIstio \u4E2D\u7981\u7528\u4E86 HTTP \u8BF7\u6C42\u7684 Envoy \u8D85\u65F6.</p><p>\u5BF9\u4E8E\u67D0\u4E9B\u5E94\u7528\u7A0B\u5E8F\u548C\u670D\u52A1\uFF0CIstio \u7684\u9ED8\u8BA4\u8D85\u65F6\u53EF\u80FD\u4E0D\u5408\u9002\u3002\u4F8B\u5982\uFF0C\u8FC7\u957F\u7684\u8D85\u65F6\u53EF\u80FD\u4F1A\u5BFC\u81F4\u7B49\u5F85\u6765\u81EA\u5931\u8D25\u670D\u52A1\u7684\u56DE\u590D\u7684\u5EF6\u8FDF\u8FC7\u957F\uFF0C\u800C\u8FC7\u77ED\u7684\u8D85\u65F6\u53EF\u80FD\u4F1A\u5BFC\u81F4\u8C03\u7528\u5728\u7B49\u5F85\u6D89\u53CA\u591A\u4E2A\u670D\u52A1\u7684\u64CD\u4F5C\u8FD4\u56DE\u65F6\u4E0D\u5FC5\u8981\u5730\u5931\u8D25\u3002\u4E3A\u4E86\u627E\u5230\u5E76\u4F7F\u7528\u60A8\u7684\u6700\u4F73\u8D85\u65F6\u8BBE\u7F6E\uFF0CIstio \u5141\u8BB8\u60A8\u4F7F\u7528\u865A\u62DF\u670D\u52A1\u8F7B\u677E\u5730\u5728\u6BCF\u4E2A\u670D\u52A1\u7684\u57FA\u7840\u4E0A\u52A8\u6001\u8C03\u6574\u8D85\u65F6\uFF0C\u800C\u65E0\u9700\u7F16\u8F91\u60A8\u7684\u670D\u52A1\u4EE3\u7801\u3002\u4E0B\u9762\u662F\u4E00\u4E2A\u865A\u62DF\u670D\u52A1\uFF0C\u5B83\u4E3A\u8C03\u7528 rating \u670D\u52A1\u7684 v1 \u5B50\u96C6\u6307\u5B9A\u4E86 10 \u79D2\u7684\u8D85\u65F6\u65F6\u95F4\uFF1A</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 10s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u91CD\u8BD5" tabindex="-1"><a class="header-anchor" href="#\u91CD\u8BD5" aria-hidden="true">#</a> \u91CD\u8BD5</h4><p><code>\u91CD\u8BD5\u8BBE\u7F6E\u6307\u5B9A Envoy \u4EE3\u7406\u5728\u521D\u59CB\u8C03\u7528\u5931\u8D25\u65F6\u5C1D\u8BD5\u8FDE\u63A5\u670D\u52A1\u7684\u6700\u5927\u6B21\u6570\u3002</code>\u91CD\u8BD5\u53EF\u4EE5\u901A\u8FC7\u786E\u4FDD\u8C03\u7528\u4E0D\u4F1A\u56E0\u4E3A \u4E34\u65F6\u6027\u95EE\u9898\uFF08\u4F8B\u5982\u4E34\u65F6\u8FC7\u8F7D\u7684\u670D\u52A1\u6216\u7F51\u7EDC\uFF09\u800C\u6C38\u4E45\u5931\u8D25\uFF0C\u4ECE\u800C\u63D0\u9AD8\u670D\u52A1\u53EF\u7528\u6027\u548C\u5E94\u7528\u7A0B\u5E8F\u6027\u80FD\u3002\u91CD\u8BD5\u95F4\u9694\uFF0825ms+\uFF09\u662F\u53EF\u53D8\u7684\uFF0C\u7531 Istio \u81EA\u52A8\u786E\u5B9A\uFF0C\u9632\u6B62\u88AB\u8C03\u7528\u7684\u670D\u52A1\u88AB\u8BF7\u6C42\u6DF9\u6CA1\u3002HTTP \u8BF7\u6C42\u7684\u9ED8\u8BA4\u91CD\u8BD5\u884C\u4E3A\u662F \u5728\u8FD4\u56DE\u9519\u8BEF\u4E4B\u524D\u91CD\u8BD5\u4E24\u6B21\u3002</p><p>\u4E0E\u8D85\u65F6\u4E00\u6837\uFF0CIstio \u7684\u9ED8\u8BA4\u91CD\u8BD5\u884C\u4E3A\u53EF\u80FD\u4E0D\u9002\u5408\u60A8\u7684\u5E94\u7528\u7A0B\u5E8F\u5728\u5EF6\u8FDF\uFF08\u5931\u8D25\u7684\u670D\u52A1\u91CD\u8BD5\u6B21\u6570\u8FC7\u591A\u53EF\u80FD\u4F1A\u51CF\u6162\u901F\u5EA6\uFF09\u6216\u53EF\u7528\u6027\u65B9\u9762\u7684\u9700\u6C42\u3002\u4E5F\u50CF\u8D85\u65F6\u4E00\u6837\uFF0C\u60A8\u53EF\u4EE5\u5728\u865A\u62DF\u670D\u52A1\u4E2D\u57FA\u4E8E\u6BCF\u4E2A\u670D\u52A1\u8C03\u6574\u91CD\u8BD5\u8BBE\u7F6E\uFF0C\u800C\u65E0\u9700\u63A5\u89E6\u60A8\u7684\u670D\u52A1\u4EE3\u7801\u3002\u60A8\u8FD8\u53EF\u4EE5\u901A\u8FC7\u6DFB\u52A0\u6BCF\u6B21\u91CD\u8BD5\u8D85\u65F6\u6765\u8FDB\u4E00\u6B65\u4F18\u5316\u60A8\u7684\u91CD\u8BD5\u884C\u4E3A\uFF0C\u6307\u5B9A\u60A8\u5E0C\u671B\u7B49\u5F85\u6BCF\u6B21\u91CD\u8BD5\u5C1D\u8BD5\u6210\u529F\u8FDE\u63A5\u5230\u670D\u52A1\u7684\u65F6\u95F4\u91CF\u3002\u4EE5\u4E0B\u793A\u4F8B\u5728\u521D\u59CB\u8C03\u7528\u5931\u8D25\u540E\u914D\u7F6E\u6700\u591A 3 \u6B21\u91CD\u8BD5\u4EE5\u8FDE\u63A5\u5230\u6B64\u670D\u52A1\u5B50\u96C6\uFF0C \u6BCF\u6B21\u91CD\u8BD5\u65F6\u95F4\u4E3A 2 \u79D2\u3002</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">retries</span><span class="token punctuation">:</span>
      <span class="token key atrule">attempts</span><span class="token punctuation">:</span> <span class="token number">3</span>
      <span class="token key atrule">perTryTimeout</span><span class="token punctuation">:</span> 2s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u7194\u65AD" tabindex="-1"><a class="header-anchor" href="#\u7194\u65AD" aria-hidden="true">#</a> \u7194\u65AD</h4><p><code>\u7194\u65AD\u662F Istio \u63D0\u4F9B\u7684\u53E6\u4E00\u79CD\u6709\u7528\u7684\u673A\u5236\uFF0C\u7528\u4E8E\u521B\u5EFA\u57FA\u4E8E\u5FAE\u670D\u52A1\u7684\u5F39\u6027\u5E94\u7528\u7A0B\u5E8F\u3002</code>\u5728\u65AD\u8DEF\u5668\u4E2D\uFF0C\u60A8\u53EF\u4EE5 \u8BBE\u7F6E\u5BF9\u670D\u52A1\u4E2D\u5404\u4E2A\u4E3B\u673A\u7684\u8C03\u7528\u9650\u5236\uFF0C\u4F8B\u5982\u5E76\u53D1\u8FDE\u63A5\u6570\u6216\u5BF9\u8BE5\u4E3B\u673A\u7684\u8C03\u7528\u5931\u8D25\u7684\u6B21\u6570\u3002\u4E00\u65E6\u8FBE\u5230\u8BE5\u9650\u5236\uFF0C\u65AD\u8DEF\u5668\u5C31\u4F1A\u201C\u8DF3\u95F8\u201D\u5E76\u505C\u6B62\u4E0E\u8BE5\u4E3B\u673A\u7684\u8FDB\u4E00\u6B65\u8FDE\u63A5\u3002\u4F7F\u7528\u65AD\u8DEF\u5668\u6A21\u5F0F\u53EF\u4EE5\u5B9E\u73B0\u5FEB\u901F\u6545\u969C\uFF0C\u800C\u4E0D\u662F\u5BA2\u6237\u7AEF\u5C1D\u8BD5\u8FDE\u63A5\u5230\u8FC7\u8F7D\u6216\u6545\u969C\u4E3B\u673A\u3002</p><p>\u7531\u4E8E\u65AD\u8DEF\u5668\u9002\u7528\u4E8E\u8D1F\u8F7D\u5E73\u8861\u6C60\u4E2D\u7684\u201C\u771F\u5B9E\u201D\u7F51\u683C\u76EE\u6807\uFF0C\u60A8\u53EF\u4EE5\u5728\u76EE\u6807\u89C4\u5219\u4E2D\u914D\u7F6E\u65AD\u8DEF\u5668\u9608\u503C \uFF0C\u5E76\u5C06\u8BBE\u7F6E\u5E94 \u7528\u4E8E\u670D\u52A1\u4E2D\u7684\u6BCF\u4E2A\u5355\u72EC\u7684\u4E3B\u673A\u3002\u4EE5\u4E0B\u793A\u4F8Breviews\u5C06 v1 \u5B50\u96C6\u7684\u670D\u52A1\u5DE5\u4F5C\u8D1F\u8F7D\u7684\u5E76\u53D1\u8FDE\u63A5\u6570\u9650\u5236\u4E3A 100\uFF1A</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
      <span class="token key atrule">connectionPool</span><span class="token punctuation">:</span>
        <span class="token key atrule">tcp</span><span class="token punctuation">:</span>
          <span class="token key atrule">maxConnections</span><span class="token punctuation">:</span> <span class="token number">100</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u6545\u969C\u6CE8\u5165" tabindex="-1"><a class="header-anchor" href="#\u6545\u969C\u6CE8\u5165" aria-hidden="true">#</a> \u6545\u969C\u6CE8\u5165</h4><p><code>\u914D\u7F6E\u597D\u7F51\u7EDC\uFF08\u5305\u62EC\u6545\u969C\u6062\u590D\u7B56\u7565\uFF09\u540E\uFF0C\u60A8\u53EF\u4EE5\u4F7F\u7528 Istio \u7684\u6545\u969C\u6CE8\u5165\u673A\u5236\u6765\u6D4B\u8BD5\u6574\u4E2A\u5E94\u7528\u7A0B\u5E8F\u7684\u6545\u969C\u6062\u590D\u80FD\u529B\u3002</code>\u6545\u969C\u6CE8\u5165\u662F\u4E00\u79CD\u5C06\u9519\u8BEF\u5F15\u5165\u7CFB\u7EDF\u4EE5\u786E\u4FDD\u7CFB\u7EDF\u80FD\u591F\u627F\u53D7\u5E76\u4ECE\u9519\u8BEF\u6761\u4EF6\u4E2D\u6062\u590D\u7684\u6D4B\u8BD5\u65B9\u6CD5\u3002\u4F7F\u7528\u6545\u969C\u6CE8\u5165\u5BF9\u4E8E\u786E\u4FDD\u60A8\u7684\u6545\u969C\u6062\u590D\u7B56\u7565\u4E0D\u4F1A\u4E0D\u517C\u5BB9\u6216\u9650\u5236\u8FC7\u591A\uFF0C\u53EF\u80FD\u4F1A\u5BFC\u81F4\u5173\u952E\u670D\u52A1\u4E0D\u53EF\u7528\u7279\u522B\u6709\u7528\u3002</p><p>\u4E0E\u5176\u4ED6\u5F15\u5165\u9519\u8BEF\u7684\u673A\u5236\uFF08\u4F8B\u5982\u5EF6\u8FDF\u6570\u636E\u5305\u6216\u5728\u7F51\u7EDC\u5C42\u6740\u6B7B pod\uFF09\u4E0D\u540C\uFF0CIstio \u5141\u8BB8\u60A8\u5728\u5E94\u7528\u7A0B\u5E8F\u5C42\u6CE8\u5165\u6545\u969C\u3002\u8FD9\u4F7F\u60A8\u53EF\u4EE5\u6CE8\u5165\u66F4\u591A\u76F8\u5173\u6545\u969C\uFF0C\u4F8B\u5982 HTTP \u9519\u8BEF\u4EE3\u7801\uFF0C\u4EE5\u83B7\u5F97\u66F4\u591A\u76F8\u5173\u7ED3\u679C\u3002</p><p>\u60A8\u53EF\u4EE5\u6CE8\u5165\u4E24\u79CD\u7C7B\u578B\u7684\u6545\u969C\uFF0C\u5747\u4F7F\u7528 \u865A\u62DF\u670D\u52A1\u8FDB\u884C\u914D\u7F6E\uFF1A</p><ul><li><code>\u5EF6\u8FDF\uFF1A</code>\u5EF6\u8FDF\u662F\u8BA1\u65F6\u5931\u8D25\u3002\u5B83\u4EEC\u6A21\u4EFF\u589E\u52A0\u7684\u7F51\u7EDC\u5EF6\u8FDF\u6216\u8FC7\u8F7D\u7684\u4E0A\u6E38\u670D\u52A1\u3002</li><li><code>\u4E2D\u6B62\uFF1A</code>\u4E2D\u6B62\u662F\u5D29\u6E83\u5931\u8D25\u3002\u5B83\u4EEC\u6A21\u4EFF\u4E0A\u6E38\u670D\u52A1\u4E2D\u7684\u6545\u969C\u3002\u4E2D\u6B62\u901A\u5E38\u4EE5 HTTP \u9519\u8BEF\u4EE3\u7801\u6216 TCP \u8FDE\u63A5\u5931\u8D25\u7684 \u5F62\u5F0F\u51FA\u73B0\u3002</li></ul><p>\u4F8B\u5982\uFF0C\u6B64\u865A\u62DF\u670D\u52A1\u5BF9ratings\u670D\u52A1\u7684\u6BCF 1000 \u4E2A\u8BF7\u6C42\u4E2D\u7684 1 \u4E2A\u5F15\u5165\u4E86 5 \u79D2\u7684\u5EF6\u8FDF\u3002</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">fault</span><span class="token punctuation">:</span>
      <span class="token key atrule">delay</span><span class="token punctuation">:</span>
        <span class="token key atrule">percentage</span><span class="token punctuation">:</span>
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">0.1</span>
        <span class="token key atrule">fixedDelay</span><span class="token punctuation">:</span> 5s
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="sidecar\u6CE8\u5165" tabindex="-1"><a class="header-anchor" href="#sidecar\u6CE8\u5165" aria-hidden="true">#</a> Sidecar\u6CE8\u5165</h2><h4 id="\u5BF9\u5DE5\u4F5C\u8D1F\u8F7D\u7684\u4E00\u4E9B\u8981\u6C42" tabindex="-1"><a class="header-anchor" href="#\u5BF9\u5DE5\u4F5C\u8D1F\u8F7D\u7684\u4E00\u4E9B\u8981\u6C42" aria-hidden="true">#</a> \u5BF9\u5DE5\u4F5C\u8D1F\u8F7D\u7684\u4E00\u4E9B\u8981\u6C42</h4><p>\u652F\u6301\u7684\u5DE5\u4F5C\u8D1F\u8F7D\u7C7B\u578B\uFF1A</p><ul><li><code>Job</code></li><li><code>DaemonSet</code></li><li><code>ReplicaSet</code></li><li><code>Pod</code></li><li><code>Deployment</code></li></ul><p>\u7B49\uFF0C\u5BF9\u8FD9\u4E9B\u5DE5\u4F5C\u8D1F\u8F7D\u7684\u8981\u6C42\u5982\u4E0B\uFF1A</p><ul><li>\u8981\u6B63\u786E\u547D\u540D\u670D\u52A1\u7AEF\u53E3\uFF1A <ul><li><code>Service</code> \u5BF9\u8C61\u4E2D\u7684 <code>Port</code> \u90E8\u5206\u5FC5\u987B\u4EE5 &quot;\u534F\u8BAE\u540D&quot; \u4E3A\u524D\u7F00\uFF0C\u76EE\u524D\u652F\u6301\u7684\u534F\u8BAE\u540D\u5305\u62EC <code>http</code>\uFF0C<code>http2</code>\uFF0C<code>mongo</code>\uFF0C<code>redis</code> \u4E0E <code>grpc</code>\uFF1B</li><li>istio \u4F1A\u547D\u540D\u6765\u786E\u5B9A\u4E3A\u7AEF\u53E3\u63D0\u4F9B\u4EC0\u4E48\u6837\u7684\u670D\u52A1\uFF0C\u4E0D\u7B26\u5408\u547D\u540D\u89C4\u8303\u7684\u7AEF\u53E3\u4F1A\u88AB\u5F53\u505A TCP \u670D\u52A1\u5668\uFF0C\u5176\u529F\u80FD\u652F\u6301\u8303\u56F4\u4F1A\u5927\u5E45\u7F29\u5C0F\u3002</li></ul></li><li>\u5DE5\u4F5C\u8D1F\u8F7D\u7684 Pod \u5FC5\u987B\u6709\u5173\u8054\u7684 Service\uFF1A <ul><li>\u4E3A\u6EE1\u8DB3\u670D\u52A1\u53D1\u73B0\u7684\u9700\u8981\uFF0C\u6240\u6709 Pod \u90FD\u5FC5\u987B\u6709\u5173\u8054\u7684\u670D\u52A1\uFF1B</li><li>\u5B98\u65B9\u5EFA\u8BAE\u4E3A Pod \u6A21\u677F\u52A0\u5165\u4E24\u4E2A\u6807\u7B7E\uFF1A<code>app</code> \u4E0E <code>version</code>\uFF0C\u5206\u522B\u6807\u6CE8\u5E94\u7528\u540D\u79F0\u4E0E\u7248\u672C\uFF0C\u867D\u4EC5\u662F\u4E2A\u5EFA\u8BAE\uFF0C\u4F46 istio \u5F88\u591A\u9ED8\u8BA4\u7B56\u7565\u4F1A\u5F15\u7528\u8FD9\u4E24\u4E2A\u6807\u7B7E\uFF0C\u5982\u679C\u6CA1\u6709\u4F1A\u5F15\u53D1\u5F88\u591A\u4E0D\u5FC5\u8981\u7684\u9EBB\u70E6\u3002</li></ul></li></ul><h4 id="\u624B\u5DE5\u6CE8\u5165" tabindex="-1"><a class="header-anchor" href="#\u624B\u5DE5\u6CE8\u5165" aria-hidden="true">#</a> \u624B\u5DE5\u6CE8\u5165</h4><p>\u521B\u5EFA\u4E00\u4E2Adeployment\u505Anginx\u7684pod\u63A7\u5236\u5668\uFF0C\u526F\u672C\u7EF4\u6301\u57282\u4E2A\u3002</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 ~<span class="token punctuation">]</span><span class="token comment"># cat deploymen.yaml  </span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> 
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> test 
  <span class="token key atrule">name</span><span class="token punctuation">:</span> test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> test
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> test
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx 
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent 
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
        
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f deploymen.yaml  </span>
deployment.apps/test created
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>istioctl kube-inject \u4F1A\u5C06 istio \u76F8\u5173\u5BB9\u5668\u6CE8\u5165\u5E94\u7528\uFF0C&quot;-o&quot; \u53C2\u6570\u5C06\u6CE8\u5165\u7ED3\u679C\u751F\u6210 yaml \u6587\u4EF6 \uFF0C\u65B9\u4FBF\u89C2\u5BDF\u4F7F\u7528\u6B64\u547D\u4EE4\u4E0E &quot;kubectl apply -f&quot; \u7684\u533A\u522B\uFF1B</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-work<span class="token punctuation">]</span><span class="token comment"># istioctl kube-inject -f deployment.yaml -o deployment-inject.yaml  </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u65B0\u7684 yaml \u6587\u4EF6\u4E2D\u591A\u51FA\u4E86 &quot;Sidecar&quot; \u5BB9\u5668\uFF0C \u5E76\u4E14\u51FA\u73B0\u4E861\u4E2A\u521D\u59CB\u5316\u5BB9\u5668 (initContainers) &quot;istio-init&quot; \uFF0C\u521D\u59CB\u5316\u5BB9\u5668\u5373\u7528\u6765\u52AB\u6301\u5E94\u7528\u901A\u4FE1\u5230 &quot;Sidecar&quot; \u5BB9\u5668\u7684\u5DE5\u5177\uFF1B</p><p>\u53EF\u76F4\u63A5 &quot;kubectl apply -f&quot; \u751F\u6210\u7684 yaml \u6587\u4EF6\uFF0C<code>\u6CE8\u5165\u540E Nginx \u5E94\u7528 \u4E0E Istio-Proxy \u5171\u4EAB\u7F51\u7EDC\u547D\u540D\u7A7A\u95F4</code> \u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-work<span class="token punctuation">]</span><span class="token comment"># istioctl kube-inject  -f /root/deploymen.yaml | kubectl apply -f - -n test </span>
deployment.apps/test configured
<span class="token punctuation">[</span>root@k8s-master-node1 istio-work<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n test </span>
NAME                    READY   STATUS    RESTARTS   AGE
test-67b6d4d78c-jzzml   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          20s
test-67b6d4d78c-sfxk8   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          20s

<span class="token punctuation">[</span>root@k8s-master-node1 istio-work<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it  -n test test-67b6d4d78c-jzzml -c istio-proxy -- netstat -ntlp</span>
Active Internet connections <span class="token punctuation">(</span>only servers<span class="token punctuation">)</span>
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15021           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15021           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:80              <span class="token number">0.0</span>.0.0:*               LISTEN      -                   
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15090           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15090           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:15000         <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15001           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15001           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:15004         <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">1</span>/pilot-agent       
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15006           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15006           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::15020                :::*                    LISTEN      <span class="token number">1</span>/pilot-agent       
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::80                   :::*                    LISTEN      -                   
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u8BF7\u6C42\u8DEF\u7531" tabindex="-1"><a class="header-anchor" href="#\u8BF7\u6C42\u8DEF\u7531" aria-hidden="true">#</a> \u8BF7\u6C42\u8DEF\u7531</h2><h4 id="\u73AF\u5883\u51C6\u5907" tabindex="-1"><a class="header-anchor" href="#\u73AF\u5883\u51C6\u5907" aria-hidden="true">#</a> \u73AF\u5883\u51C6\u5907</h4>`,113),P={href:"https://istio.io/latest/docs/examples/bookinfo/",target:"_blank",rel:"noopener noreferrer"},I=n("li",null,"\u4E86\u89E3\u4E86\u6D41\u91CF\u7BA1\u7406\u7684\u57FA\u7840\u6982\u5FF5\uFF0C\u4EE5\u53CA\u4E13\u4E1A\u8BED\u672F\u3002",-1),E=n("p",null,"\u6CE8\u610F\uFF1A",-1),$={href:"https://istio.io/latest/docs/examples/bookinfo/",target:"_blank",rel:"noopener noreferrer"},C=n("code",null,"reviews",-1),H=n("code",null,"/productpage",-1),N=t(`<h4 id="\u5E94\u7528\u865A\u62DF\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#\u5E94\u7528\u865A\u62DF\u670D\u52A1" aria-hidden="true">#</a> \u5E94\u7528\u865A\u62DF\u670D\u52A1</h4><p>\u8981\u4EC5\u8DEF\u7531\u5230\u4E00\u4E2A\u7248\u672C\uFF0C\u60A8\u53EF\u4EE5\u5E94\u7528\u4E3A\u5FAE\u670D\u52A1\u8BBE\u7F6E\u9ED8\u8BA4\u7248\u672C\u7684\u865A\u62DF\u670D\u52A1\u3002\u5728\u8FD9\u79CD\u60C5\u51B5\u4E0B\uFF0C\u865A\u62DF\u670D\u52A1\u4F1A\u5C06\u6240\u6709\u6D41\u91CF\u8DEF\u7531\u5230<code>v1</code>\u6BCF\u4E2A\u5FAE\u670D\u52A1\u3002</p><ol><li>\u8FD0\u884C\u4EE5\u4E0B\u547D\u4EE4\u4EE5\u5E94\u7528\u865A\u62DF\u670D\u52A1\uFF1A</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u56E0\u4E3A\u914D\u7F6E\u4F20\u64AD\u6700\u7EC8\u662F\u4E00\u81F4\u7684\uFF0C\u6240\u4EE5\u7B49\u5F85\u51E0\u79D2\u949F\u8BA9\u865A\u62DF\u670D\u52A1\u751F\u6548\u3002</p><ol start="2"><li>\u4F7F\u7528\u4EE5\u4E0B\u547D\u4EE4\u663E\u793A\u5B9A\u4E49\u7684\u8DEF\u7531\uFF1A</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ cat istio<span class="token punctuation">-</span>1.9.5/samples/bookinfo/networking/virtual<span class="token punctuation">-</span>service<span class="token punctuation">-</span>all<span class="token punctuation">-</span>v1.yaml 
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> productpage
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> productpage
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> productpage
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> details
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> details
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> details
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>\u60A8\u8FD8\u53EF\u4EE5<code>subset</code>\u4F7F\u7528\u4EE5\u4E0B\u547D\u4EE4\u663E\u793A\u76F8\u5E94\u7684\u5B9A\u4E49\uFF1A</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl get destinationrules <span class="token parameter variable">-o</span> yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u60A8\u5DF2\u5C06 Istio \u914D\u7F6E\u4E3A\u8DEF\u7531\u5230<code>v1</code>Bookinfo \u5FAE\u670D\u52A1\u7684\u7248\u672C\uFF0C\u6700\u91CD\u8981\u7684\u662F<code>reviews</code>\u670D\u52A1\u7248\u672C 1\u3002</p><h4 id="\u6D4B\u8BD5\u65B0\u7684\u8DEF\u7531\u914D\u7F6E" tabindex="-1"><a class="header-anchor" href="#\u6D4B\u8BD5\u65B0\u7684\u8DEF\u7531\u914D\u7F6E" aria-hidden="true">#</a> \u6D4B\u8BD5\u65B0\u7684\u8DEF\u7531\u914D\u7F6E</h4><p>\u60A8\u53EF\u4EE5\u901A\u8FC7\u518D\u6B21\u5237\u65B0<code>/productpage</code> Bookinfo \u5E94\u7528\u7A0B\u5E8F\u8F7B\u677E\u6D4B\u8BD5\u65B0\u914D\u7F6E\u3002</p>`,12),O=n("code",null,"http://$GATEWAY_URL/productpage",-1),R=n("code",null,"$GATEWAY_URL",-1),L={href:"https://istio.io/latest/docs/examples/bookinfo/#determine-the-ingress-ip-and-port",target:"_blank",rel:"noopener noreferrer"},A=n("p",null,[s("\u8BF7\u6CE8\u610F\uFF0C\u65E0\u8BBA\u60A8\u5237\u65B0\u591A\u5C11\u6B21\uFF0C\u9875\u9762\u7684\u8BC4\u8BBA\u90E8\u5206\u90FD\u4E0D\u4F1A\u663E\u793A\u8BC4\u5206\u661F\u3002\u8FD9\u662F\u56E0\u4E3A\u60A8\u5C06 Istio \u914D\u7F6E\u4E3A\u5C06\u8BC4\u8BBA\u670D\u52A1\u7684\u6240\u6709\u6D41\u91CF\u8DEF\u7531\u5230\u8BE5\u7248\u672C"),n("code",null,"reviews:v1"),s("\uFF0C\u5E76\u4E14\u8BE5\u7248\u672C\u7684\u670D\u52A1\u4E0D\u8BBF\u95EE\u661F\u7EA7\u8BC4\u5206\u670D\u52A1\u3002")],-1),V=n("p",null,"\u60A8\u5DF2\u6210\u529F\u5B8C\u6210\u6B64\u4EFB\u52A1\u7684\u7B2C\u4E00\u90E8\u5206\uFF1A\u5C06\u6D41\u91CF\u8DEF\u7531\u5230\u670D\u52A1\u7684\u4E00\u4E2A\u7248\u672C",-1),D=n("h4",{id:"\u57FA\u4E8E\u7528\u6237\u8EAB\u4EFD\u7684\u8DEF\u7531",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#\u57FA\u4E8E\u7528\u6237\u8EAB\u4EFD\u7684\u8DEF\u7531","aria-hidden":"true"},"#"),s(" \u57FA\u4E8E\u7528\u6237\u8EAB\u4EFD\u7684\u8DEF\u7531")],-1),G=n("p",null,[s("\u63A5\u4E0B\u6765\uFF0C\u60A8\u5C06\u66F4\u6539\u8DEF\u7531\u914D\u7F6E\uFF0C\u4EE5\u4FBF\u5C06\u6765\u81EA\u7279\u5B9A\u7528\u6237\u7684\u6240\u6709\u6D41\u91CF\u8DEF\u7531\u5230\u7279\u5B9A\u670D\u52A1\u7248\u672C\u3002\u5728\u8FD9\u79CD\u60C5\u51B5\u4E0B\uFF0C\u6765\u81EA\u540D\u4E3A Jason \u7684\u7528\u6237\u7684\u6240\u6709\u6D41\u91CF\u90FD\u5C06\u8DEF\u7531\u5230\u670D\u52A1"),n("code",null,"reviews:v2"),s("\u3002")],-1),M=n("p",null,[s("\u8BE5\u793A\u4F8B\u7684\u542F\u7528\u662F\u56E0\u4E3A\u8BE5"),n("code",null,"productpage"),s("\u670D\u52A1\u5C06\u81EA\u5B9A\u4E49"),n("code",null,"end-user"),s("\u6807\u5934\u6DFB\u52A0\u5230\u6240\u6709\u5230\u8BC4\u8BBA\u670D\u52A1\u7684\u51FA\u7AD9 HTTP \u8BF7\u6C42\u3002")],-1),U={href:"https://istio.io/latest/docs/tasks/security/authentication/jwt-route",target:"_blank",rel:"noopener noreferrer"},j=t(`<p>\u8BF7\u8BB0\u4F4F\uFF0C<code>reviews:v2</code>\u662F\u5305\u542B\u661F\u7EA7\u8BC4\u5206\u529F\u80FD\u7684\u7248\u672C\u3002</p><ol><li>\u8FD0\u884C\u4EE5\u4E0B\u547D\u4EE4\u4EE5\u542F\u7528\u57FA\u4E8E\u7528\u6237\u7684\u8DEF\u7531\uFF1A</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="2"><li>\u786E\u8BA4\u89C4\u5219\u5DF2\u521B\u5EFA\uFF1A</li></ol><p>\u521B\u5EFA\u89C4\u5219\u5141\u8BB8\u7528\u6237jasone</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 networking<span class="token punctuation">]</span><span class="token comment"># cat virtual-service-reviews-test-v2.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
        <span class="token key atrule">end-user</span><span class="token punctuation">:</span>
          <span class="token key atrule">exact</span><span class="token punctuation">:</span> jason
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><p>\u5728<code>/productpage</code>Bookinfo \u5E94\u7528\u7A0B\u5E8F\u4E0A\uFF0C\u4EE5 user \u8EAB\u4EFD\u767B\u5F55<code>jason</code>\u3002\u5237\u65B0\u6D4F\u89C8\u5668\u3002\u4F60\u770B\u5230\u4E86\u4EC0\u4E48\uFF1F\u661F\u7EA7\u8BC4\u5206\u663E\u793A\u5728\u6BCF\u6761\u8BC4\u8BBA\u65C1\u8FB9\u3002</p></li><li><p>\u4EE5\u5176\u4ED6\u7528\u6237\u8EAB\u4EFD\u767B\u5F55\uFF08\u9009\u62E9\u60A8\u60F3\u8981\u7684\u4EFB\u4F55\u540D\u79F0\uFF09\u3002\u5237\u65B0\u6D4F\u89C8\u5668\u3002\u73B0\u5728\u661F\u661F\u4E0D\u89C1\u4E86\u3002\u8FD9\u662F\u56E0\u4E3A\u6D41\u91CF\u88AB\u8DEF\u7531\u5230<code>reviews:v1</code>\u9664\u4E86 Jason \u4E4B\u5916\u7684\u6240\u6709\u7528\u6237\u3002\u60A8\u5DF2\u6210\u529F\u914D\u7F6E Istio \u4EE5\u6839\u636E\u7528\u6237\u8EAB\u4EFD\u8DEF\u7531\u6D41\u91CF\u3002</p></li></ol><h4 id="\u6E05\u7406" tabindex="-1"><a class="header-anchor" href="#\u6E05\u7406" aria-hidden="true">#</a> \u6E05\u7406</h4><p>\u5220\u9664\u5E94\u7528\u7A0B\u5E8F\u8DEF\u7531\u89C4\u5219\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="\u6545\u969C\u6CE8\u5165-1" tabindex="-1"><a class="header-anchor" href="#\u6545\u969C\u6CE8\u5165-1" aria-hidden="true">#</a> \u6545\u969C\u6CE8\u5165</h2><h4 id="\u73AF\u5883\u51C6\u5907-1" tabindex="-1"><a class="header-anchor" href="#\u73AF\u5883\u51C6\u5907-1" aria-hidden="true">#</a> \u73AF\u5883\u51C6\u5907</h4>`,12),F={href:"https://istio.io/latest/docs/examples/bookinfo/",target:"_blank",rel:"noopener noreferrer"},B=n("li",null,"\u4E86\u89E3\u4E86\u6D41\u91CF\u7BA1\u7406\u7684\u57FA\u7840\u6982\u5FF5\uFF0C\u4EE5\u53CA\u4E13\u4E1A\u8BED\u672F\u3002",-1),z={href:"https://istio.io/latest/docs/tasks/traffic-management/request-routing/",target:"_blank",rel:"noopener noreferrer"},X=t(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div>`,1),W=t(`<h4 id="\u6CE8\u5165http\u5EF6\u8FDF\u9519\u8BEF" tabindex="-1"><a class="header-anchor" href="#\u6CE8\u5165http\u5EF6\u8FDF\u9519\u8BEF" aria-hidden="true">#</a> \u6CE8\u5165HTTP\u5EF6\u8FDF\u9519\u8BEF</h4><p>\u8981\u6D4B\u8BD5 Bookinfo \u5E94\u7528\u7A0B\u5E8F\u5FAE\u670D\u52A1\u7684\u5F39\u6027\uFF0C\u8BF7\u5728user<code>reviews:v2</code>\u548C\u5FAE\u670D\u52A1\u4E4B\u95F4\u6CE8\u5165 7s \u5EF6\u8FDF\u3002\u6B64\u6D4B\u8BD5\u5C06\u53D1\u73B0\u4E00\u4E2A\u6709\u610F\u5F15\u5165 Bookinfo \u5E94\u7528\u7A0B\u5E8F\u7684\u9519\u8BEF\u3002<code>ratings jason</code></p><p>\u8BF7\u6CE8\u610F\uFF0C\u8BE5<code>reviews:v2</code>\u670D\u52A1\u5BF9\u670D\u52A1\u7684\u8C03\u7528\u6709 10 \u79D2\u7684\u786C\u7F16\u7801\u8FDE\u63A5\u8D85\u65F6<code>ratings</code>\u3002\u5373\u4F7F\u60A8\u5F15\u5165\u4E86 7 \u79D2\u5EF6\u8FDF\uFF0C\u60A8\u4ECD\u7136\u5E0C\u671B\u7AEF\u5230\u7AEF\u6D41\u7A0B\u7EE7\u7EED\u8FDB\u884C\u800C\u4E0D\u4F1A\u51FA\u73B0\u4EFB\u4F55\u9519\u8BEF\u3002</p><ol><li>\u521B\u5EFA\u6545\u969C\u6CE8\u5165\u89C4\u5219\u4EE5\u5EF6\u8FDF\u6765\u81EA\u6D4B\u8BD5\u7528\u6237\u7684\u6D41\u91CF <code>jason</code>\u3002</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="2"><li>\u786E\u8BA4\u89C4\u5219\u5DF2\u521B\u5EFA\uFF1A <ul><li><code>\u521B\u5EFA\u89C4\u5219\u901A\u8FC7jason\u7528\u6237\u767B\u5F55</code></li><li><code>\u5728\u5FAE\u670D\u52A1\u4E4B\u95F4\u6CE8\u51657s\u7684\u5EF6\u8FDF</code></li></ul></li></ol><blockquote><p><code>\u53C2\u6570\u8BE6\u89E3\uFF1A</code></p><p><strong>fault:</strong> # \u8981\u5E94\u7528\u4E8E\u5BA2\u6237\u7AEFHTTP\u6D41\u91CF\u7684\u6545\u969C\u6CE8\u5165\u7B56\u7565\u3002 <strong>delay:</strong> # \u5EF6\u8FDF <strong>percentage:</strong> # \u767E\u5206\u7387 <strong>value: 100.0</strong> # \u952E\u503C\u4E3A\u767E\u5206\u4E4B\u4E00\u767E <strong>fixedDelay: 7s</strong> # \u56FA\u5B9A\u65F6\u95F4\u4E3A7s</p></blockquote><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 networking<span class="token punctuation">]</span><span class="token comment"># cat virtual-service-ratings-test-delay.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
        <span class="token key atrule">end-user</span><span class="token punctuation">:</span>
          <span class="token key atrule">exact</span><span class="token punctuation">:</span> jason
    <span class="token key atrule">fault</span><span class="token punctuation">:</span>					
      <span class="token key atrule">delay</span><span class="token punctuation">:</span>				
        <span class="token key atrule">percentage</span><span class="token punctuation">:</span>			
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">100.0</span>
        <span class="token key atrule">fixedDelay</span><span class="token punctuation">:</span> 7s
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7B49\u5F85\u51E0\u79D2\u949F\uFF0C\u8BA9\u65B0\u89C4\u5219\u4F20\u64AD\u5230\u6240\u6709 pod\u3002</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062327994.png" alt="image-20220316153536186" loading="lazy"></p><h4 id="\u6D4B\u8BD5\u5EF6\u8FDF\u914D\u7F6E" tabindex="-1"><a class="header-anchor" href="#\u6D4B\u8BD5\u5EF6\u8FDF\u914D\u7F6E" aria-hidden="true">#</a> \u6D4B\u8BD5\u5EF6\u8FDF\u914D\u7F6E</h4>`,11),K={href:"https://istio.io/latest/docs/examples/bookinfo",target:"_blank",rel:"noopener noreferrer"},Z=t("<li><p>\u5728<code>/productpage</code>\u7F51\u9875\u4E0A\uFF0C\u4EE5 user \u8EAB\u4EFD\u767B\u5F55<code>jason</code>\u3002</p><p>\u60A8\u5E0C\u671B Bookinfo \u4E3B\u9875\u5728\u5927\u7EA6 7 \u79D2\u5185\u52A0\u8F7D\u800C\u4E0D\u4F1A\u51FA\u73B0\u9519\u8BEF\u3002\u4F46\u662F\uFF0C\u6709\u4E00\u4E2A\u95EE\u9898\uFF1AReviews \u90E8\u5206\u663E\u793A\u4E00\u6761\u9519\u8BEF\u6D88\u606F\uFF1A</p><p><code>Sorry, product reviews are currently unavailable for this book.</code></p></li><li><p>\u67E5\u770B\u7F51\u9875\u54CD\u5E94\u65F6\u95F4\uFF1A</p><ol><li>\u5728 Web \u6D4F\u89C8\u5668\u4E2D\u6253\u5F00<em>\u5F00\u53D1\u8005\u5DE5\u5177</em>\u83DC\u5355\u3002</li><li>\u6253\u5F00\u7F51\u7EDC\u9009\u9879\u5361</li><li>\u91CD\u65B0\u52A0\u8F7D<code>/productpage</code>\u7F51\u9875\u3002\u60A8\u5C06\u770B\u5230\u9875\u9762\u5B9E\u9645\u52A0\u8F7D\u5927\u7EA6\u9700\u8981 6 \u79D2\u3002</li></ol></li>",2),Y=t('<h4 id="\u4FEE\u590D\u9519\u8BEF" tabindex="-1"><a class="header-anchor" href="#\u4FEE\u590D\u9519\u8BEF" aria-hidden="true">#</a> \u4FEE\u590D\u9519\u8BEF</h4><p>\u60A8\u901A\u5E38\u4F1A\u901A\u8FC7\u4EE5\u4E0B\u65B9\u5F0F\u89E3\u51B3\u95EE\u9898\uFF1A</p><ol><li>\u589E\u52A0\u670D\u52A1\u8D85\u65F6\u6216\u51CF\u5C11<code>productpage</code>\u670D\u52A1\u8D85\u65F6<code>reviews reviews ratings</code></li><li>\u505C\u6B62\u548C\u91CD\u542F\u56FA\u5B9A\u7684\u5FAE\u670D\u52A1</li><li>\u786E\u8BA4<code>/productpage</code>\u7F51\u9875\u8FD4\u56DE\u5176\u54CD\u5E94\u6CA1\u6709\u4EFB\u4F55\u9519\u8BEF\u3002</li></ol><p>\u4F46\u662F\uFF0C\u60A8\u5DF2\u7ECF\u5728<code>reviews</code>\u670D\u52A1\u7684 v3 \u4E2D\u8FD0\u884C\u4E86\u4E00\u4E2A\u4FEE\u590D\u7A0B\u5E8F\u3002\u8BE5<code>reviews:v3</code>\u670D\u52A1\u5C06\u8D85\u65F6\u65F6\u95F4\u4ECE 10s \u51CF\u5C11<code>reviews</code>\u52302.5s\uFF0C\u4EE5\u4FBF\u4E0E\u4E0B\u6E38\u8BF7\u6C42<code>ratings</code>\u7684\u8D85\u65F6\u65F6\u95F4\u517C\u5BB9\uFF08\u5C0F\u4E8E\uFF09 <code>productpage</code>\u3002</p>',4),J={href:"https://istio.io/latest/docs/tasks/traffic-management/traffic-shifting/",target:"_blank",rel:"noopener noreferrer"},Q=n("code",null,"reviews:v3",-1),nn=t(`<h4 id="\u6CE8\u5165http\u4E2D\u6B62\u9519\u8BEF" tabindex="-1"><a class="header-anchor" href="#\u6CE8\u5165http\u4E2D\u6B62\u9519\u8BEF" aria-hidden="true">#</a> \u6CE8\u5165HTTP\u4E2D\u6B62\u9519\u8BEF</h4><p>\u6D4B\u8BD5\u5FAE\u670D\u52A1\u5F39\u6027\u7684\u53E6\u4E00\u79CD\u65B9\u6CD5\u662F\u5F15\u5165 HTTP \u4E2D\u6B62\u6545\u969C\u3002<code>ratings</code>\u5728\u6B64\u4EFB\u52A1\u4E2D\uFF0C\u60A8\u5C06\u4E3A\u6D4B\u8BD5\u7528\u6237\u7684\u5FAE\u670D\u52A1\u5F15\u5165 HTTP \u4E2D\u6B62<code>jason</code>\u3002</p><p>\u5728\u8FD9\u79CD\u60C5\u51B5\u4E0B\uFF0C\u60A8\u5E0C\u671B\u9875\u9762\u7ACB\u5373\u52A0\u8F7D\u5E76\u663E\u793A<code>Ratings service is currently unavailable</code>\u6D88\u606F\u3002</p><ol><li>\u521B\u5EFA\u4E00\u4E2A\u6545\u969C\u6CE8\u5165\u89C4\u5219\uFF0C\u4E3A\u7528\u6237\u53D1\u9001 HTTP \u4E2D\u6B62<code>jason</code>\uFF1A</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-ratings-test-abort.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="2"><li>\u786E\u8BA4\u89C4\u5219\u5DF2\u521B\u5EFA\uFF1A <ul><li><code>\u521B\u5EFA\u89C4\u5219\u901A\u8FC7jason\u7528\u6237\u6D41\u91CF</code></li><li><code>\u5728\u5FAE\u670D\u52A1\u4E4B\u95F4\u4E2D\u6B62jason\u7528\u6237\uFF0Chttpstatus\u662F500\u72B6\u6001\uFF0C\u767E\u5206\u7387\u8BBE\u7F6E\u4E3A100</code></li></ul></li></ol><blockquote><p><code>\u53C2\u6570\u8BE6\u89E3\uFF1A</code></p><p><strong>fault:</strong> # \u8981\u5E94\u7528\u4E8E\u5BA2\u6237\u7AEFHTTP\u6D41\u91CF\u7684\u6545\u969C\u6CE8\u5165\u7B56\u7565\u3002 <strong>abort:</strong> # \u4E2D\u6B62\u7B56\u7565 <strong>percentage:</strong> # \u767E\u5206\u7387 <strong>value: 100.0</strong> # \u952E\u503C\u4E3A\u767E\u5206\u4E4B\u4E00\u767E <strong>httpStatus: 500</strong> # httpstatus\u8BBE\u7F6E\u4E3A500\u62A5\u9519</p></blockquote><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 networking<span class="token punctuation">]</span><span class="token comment"># cat virtual-service-ratings-test-abort.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
        <span class="token key atrule">end-user</span><span class="token punctuation">:</span>
          <span class="token key atrule">exact</span><span class="token punctuation">:</span> jason
    <span class="token key atrule">fault</span><span class="token punctuation">:</span>
      <span class="token key atrule">abort</span><span class="token punctuation">:</span>
        <span class="token key atrule">percentage</span><span class="token punctuation">:</span>
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">100.0</span>
        <span class="token key atrule">httpStatus</span><span class="token punctuation">:</span> <span class="token number">500</span>
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u6D4B\u8BD5\u4E2D\u6B62\u914D\u7F6E" tabindex="-1"><a class="header-anchor" href="#\u6D4B\u8BD5\u4E2D\u6B62\u914D\u7F6E" aria-hidden="true">#</a> \u6D4B\u8BD5\u4E2D\u6B62\u914D\u7F6E</h4>`,9),sn={href:"https://istio.io/latest/docs/examples/bookinfo",target:"_blank",rel:"noopener noreferrer"},an=t("<li><p>\u5728 \u4E0A<code>/productpage</code>\uFF0C\u4EE5\u7528\u6237\u8EAB\u4EFD\u767B\u5F55<code>jason</code>\u3002</p><p>\u5982\u679C\u89C4\u5219\u6210\u529F\u4F20\u64AD\u5230\u6240\u6709 pod\uFF0C\u9875\u9762\u4F1A\u7ACB\u5373\u52A0\u8F7D\u5E76\u663E\u793A<code>Ratings service is currently unavailable</code>\u6D88\u606F\u3002</p></li><li><p>\u5982\u679C\u60A8\u4ECE\u7528\u6237\u6CE8\u9500<code>jason</code>\u6216\u5728\u533F\u540D\u7A97\u53E3\uFF08\u6216\u5176\u4ED6\u6D4F\u89C8\u5668\uFF09\u4E2D\u6253\u5F00 Bookinfo \u5E94\u7528\u7A0B\u5E8F\uFF0C\u60A8 \u5C06<code>/productpage</code>\u770B\u5230\u9664\u4E86. \u56E0\u6B64\uFF0C\u60A8\u4E0D\u4F1A\u770B\u5230\u4EFB\u4F55\u9519\u8BEF\u6D88\u606F\u3002<code>reviews:v1 ratings jason</code></p></li>",2),en=t(`<p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062327813.png" alt="image-20220316155324788" loading="lazy"></p><h4 id="\u6E05\u7406-1" tabindex="-1"><a class="header-anchor" href="#\u6E05\u7406-1" aria-hidden="true">#</a> \u6E05\u7406</h4><p>\u5220\u9664\u5E94\u7528\u7A0B\u5E8F\u8DEF\u7531\u89C4\u5219\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="\u6D41\u91CF\u8F6C\u79FB" tabindex="-1"><a class="header-anchor" href="#\u6D41\u91CF\u8F6C\u79FB" aria-hidden="true">#</a> \u6D41\u91CF\u8F6C\u79FB</h2><h4 id="\u4EC0\u4E48\u662F\u6D41\u91CF\u8F6C\u79FB" tabindex="-1"><a class="header-anchor" href="#\u4EC0\u4E48\u662F\u6D41\u91CF\u8F6C\u79FB" aria-hidden="true">#</a> \u4EC0\u4E48\u662F\u6D41\u91CF\u8F6C\u79FB\uFF1F</h4><p>\u6B64\u4EFB\u52A1\u5411\u60A8\u5C55\u793A\u5982\u4F55\u5C06\u6D41\u91CF\u4ECE\u4E00\u4E2A\u5FAE\u670D\u52A1\u7248\u672C\u8F6C\u79FB\u5230\u53E6\u4E00\u4E2A\u7248\u672C\u3002</p><p>\u4E00\u4E2A\u5E38\u89C1\u7684\u7528\u4F8B\u662F\u5C06\u6D41\u91CF\u4ECE\u65E7\u7248\u672C\u7684\u5FAE\u670D\u52A1\u9010\u6E10\u8FC1\u79FB\u5230\u65B0\u7248\u672C\u3002\u5728 Istio \u4E2D\uFF0C\u60A8\u53EF\u4EE5\u901A\u8FC7\u914D\u7F6E\u4E00\u7CFB\u5217\u8DEF\u7531\u89C4\u5219\u6765\u5B9E\u73B0\u8FD9\u4E00\u76EE\u6807\uFF0C\u8FD9\u4E9B\u89C4\u5219\u5C06\u4E00\u5B9A\u6BD4\u4F8B\u7684\u6D41\u91CF\u4ECE\u4E00\u4E2A\u76EE\u7684\u5730\u91CD\u5B9A\u5411\u5230\u53E6\u4E00\u4E2A\u76EE\u7684\u5730\u3002</p><p>\u5728\u6B64\u4EFB\u52A1\u4E2D\uFF0C\u60A8\u5C06\u4F7F\u7528\u5C06 50% \u7684\u6D41\u91CF\u53D1\u9001\u5230<code>reviews:v1</code>\u548C 50% \u5230<code>reviews:v3</code>\u3002\u7136\u540E\uFF0C\u60A8\u5C06\u901A\u8FC7\u5C06 100% \u7684\u6D41\u91CF\u53D1\u9001\u5230 \u6765\u5B8C\u6210\u8FC1\u79FB<code>reviews:v3</code>\u3002</p><h4 id="\u73AF\u5883\u51C6\u5907-2" tabindex="-1"><a class="header-anchor" href="#\u73AF\u5883\u51C6\u5907-2" aria-hidden="true">#</a> \u73AF\u5883\u51C6\u5907</h4>`,10),tn={href:"https://istio.io/latest/docs/examples/bookinfo/",target:"_blank",rel:"noopener noreferrer"},pn=n("li",null,"\u4E86\u89E3\u4E86\u6D41\u91CF\u7BA1\u7406\u7684\u57FA\u7840\u6982\u5FF5\uFF0C\u4EE5\u53CA\u4E13\u4E1A\u8BED\u672F\u3002",-1),ln=t(`<blockquote><p>\u9996\u5148\uFF0C\u8FD0\u884C\u6B64\u547D\u4EE4\u5C06\u6240\u6709\u6D41\u91CF\u8DEF\u7531\u5230<code>v1</code>\u6BCF\u4E2A\u5FAE\u670D\u52A1\u7684\u7248\u672C\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></blockquote><h4 id="\u5E94\u7528\u57FA\u4E8E\u6743\u91CD\u7684\u8DEF\u7531" tabindex="-1"><a class="header-anchor" href="#\u5E94\u7528\u57FA\u4E8E\u6743\u91CD\u7684\u8DEF\u7531" aria-hidden="true">#</a> \u5E94\u7528\u57FA\u4E8E\u6743\u91CD\u7684\u8DEF\u7531</h4><ol><li><code>reviews:v1</code>\u4F7F\u7528<code>reviews:v3</code>\u4EE5\u4E0B\u547D\u4EE4\u4F20\u8F93 50% \u7684\u6D41\u91CF\uFF1A</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-reviews-50-v3.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="2"><li>\u786E\u8BA4\u89C4\u5219\u5DF2\u88AB\u66FF\u6362\uFF1A <ul><li><code>\u521B\u5EFAv1\u7248\u672C\u7684\u6743\u91CD\u4E3A50</code></li><li><code>\u521B\u5EFAv3\u7248\u672C\u7684\u6743\u91CD\u4E3A50</code></li></ul></li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 networking<span class="token punctuation">]</span><span class="token comment"># cat virtual-service-reviews-50-v3.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">50</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v3
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">50</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>\u5728\u60A8\u7684\u6D4F\u89C8\u5668\u4E2D\u5237\u65B0<code>/productpage</code>\uFF0C\u60A8\u73B0\u5728\u5927\u7EA6\u6709 50% \u7684\u65F6\u95F4\u4F1A\u770B\u5230<code>\u7EA2\u8272</code>\u7684\u661F\u7EA7\u3002\u8FD9\u662F\u56E0\u4E3A<code>v3</code>\u7248\u672C<code>reviews</code>\u8BBF\u95EE\u4E86\u661F\u7EA7\u670D\u52A1\uFF0C\u800C<code>v1</code>\u7248\u672C\u6CA1\u6709\u3002</li></ol><blockquote><p>\u6CE8\u610F\uFF1A</p><p>\u4F7F\u7528\u5F53\u524D\u7684 Envoy sidecar \u5B9E\u73B0\uFF0C\u60A8\u53EF\u80FD\u9700\u8981 <code>/productpage</code>\u591A\u6B21\u5237\u65B0\uFF08\u53EF\u80FD 15 \u6B21\u6216\u66F4\u591A\uFF09\u624D\u80FD\u770B\u5230\u6B63\u786E\u7684\u5206\u5E03\u3002\u60A8\u53EF\u4EE5\u4FEE\u6539\u89C4\u5219\u4EE5\u5C06 90% \u7684\u6D41\u91CF\u8DEF\u7531\u5230<code>v3</code>\u66F4\u9891\u7E41\u5730\u770B\u5230\u7EA2\u661F\u3002</p></blockquote><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062327265.png" alt="image-20220316160723199" loading="lazy"></p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062327027.png" alt="image-20220316160736887" loading="lazy"></p><ol start="4"><li>\u5047\u8BBE\u60A8\u786E\u5B9A<code>reviews:v3</code>\u5FAE\u670D\u52A1\u662F\u7A33\u5B9A\u7684\uFF0C\u60A8\u53EF\u4EE5<code>reviews:v3</code>\u901A\u8FC7\u5E94\u7528\u6B64\u865A\u62DF\u670D\u52A1\u5C06 100% \u7684\u6D41\u91CF\u8DEF\u7531\u5230\uFF1A</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 networking<span class="token punctuation">]</span><span class="token comment"># cat virtual-service-reviews-v3.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u73B0\u5728\uFF0C\u5F53\u60A8\u5237\u65B0\u65F6\uFF0C<code>/productpage</code>\u60A8\u603B\u662F\u4F1A\u770B\u5230\u6BCF\u6761\u8BC4\u8BBA\u5E26\u6709<code>\u7EA2\u8272</code>\u661F\u7EA7\u7684\u4E66\u8BC4\u3002</p><h4 id="\u6E05\u7406-2" tabindex="-1"><a class="header-anchor" href="#\u6E05\u7406-2" aria-hidden="true">#</a> \u6E05\u7406</h4><p>\u5220\u9664\u5E94\u7528\u7A0B\u5E8F\u8DEF\u7531\u89C4\u5219\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="tcp-\u6D41\u91CF\u8F6C\u79FB" tabindex="-1"><a class="header-anchor" href="#tcp-\u6D41\u91CF\u8F6C\u79FB" aria-hidden="true">#</a> TCP \u6D41\u91CF\u8F6C\u79FB</h2><h4 id="\u4EC0\u4E48\u662Ftcp\u6D41\u91CF\u8F6C\u79FB" tabindex="-1"><a class="header-anchor" href="#\u4EC0\u4E48\u662Ftcp\u6D41\u91CF\u8F6C\u79FB" aria-hidden="true">#</a> \u4EC0\u4E48\u662FTCP\u6D41\u91CF\u8F6C\u79FB\uFF1F</h4><p>\u5C06 TCP \u6D41\u91CF\u4ECE\u4E00\u4E2A\u5FAE\u670D\u52A1\u7248\u672C\u8F6C\u79FB\u5230\u53E6\u4E00\u4E2A\u7248\u672C\u3002</p><p>\u4E00\u4E2A\u5E38\u89C1\u7684\u7528\u4F8B\u662F\u5C06 TCP \u6D41\u91CF\u4ECE\u65E7\u7248\u672C\u7684\u5FAE\u670D\u52A1\u9010\u6E10\u8FC1\u79FB\u5230\u65B0\u7248\u672C\u3002\u5728 Istio \u4E2D\uFF0C\u60A8\u53EF\u4EE5\u901A\u8FC7\u914D\u7F6E\u4E00\u7CFB\u5217\u8DEF\u7531\u89C4\u5219\u6765\u5B9E\u73B0\u8FD9\u4E00\u76EE\u6807\uFF0C\u8FD9\u4E9B\u89C4\u5219\u5C06\u4E00\u5B9A\u767E\u5206\u6BD4\u7684 TCP \u6D41\u91CF\u4ECE\u4E00\u4E2A\u76EE\u7684\u5730\u91CD\u5B9A\u5411\u5230\u53E6\u4E00\u4E2A\u76EE\u7684\u5730\u3002\u5728\u6B64\u4EFB\u52A1\u4E2D\uFF0C\u60A8\u5C06 100% \u7684 TCP \u6D41\u91CF\u53D1\u9001\u5230<code>tcp-echo:v1</code>. \u7136\u540E\uFF0C\u60A8\u5C06<code>tcp-echo:v2</code>\u4F7F\u7528 Istio \u7684\u52A0\u6743\u8DEF\u7531\u529F\u80FD\u8DEF\u7531 20% \u7684 TCP \u6D41\u91CF\u3002</p><h4 id="\u57FA\u7840\u73AF\u5883" tabindex="-1"><a class="header-anchor" href="#\u57FA\u7840\u73AF\u5883" aria-hidden="true">#</a> \u57FA\u7840\u73AF\u5883</h4>`,21),on=n("li",null,"\u9996\u5148\uFF0C\u521B\u5EFA\u4E00\u4E2A\u7528\u4E8E\u6D4B\u8BD5 TCP \u6D41\u91CF\u8F6C\u79FB\u7684\u547D\u540D\u7A7A\u95F4\u5E76\u5C06\u5176\u6807\u8BB0\u4E3A\u542F\u7528\u81EA\u52A8\u8FB9\u8F66\u6CE8\u5165\u3002",-1),cn={href:"https://github.com/istio/istio/tree/release-1.13/samples/sleep",target:"_blank",rel:"noopener noreferrer"},un=n("li",null,[s("\u90E8\u7F72\u5FAE\u670D\u52A1\u7684"),n("code",null,"v1"),s("\u548C"),n("code",null,"v2"),s("\u7248\u672C"),n("code",null,"tcp-echo"),s("\u3002")],-1),rn={href:"https://istio.io/latest/docs/tasks/traffic-management/ingress/ingress-control/#determining-the-ingress-ip-and-ports",target:"_blank",rel:"noopener noreferrer"},dn=n("code",null,"TCP_INGRESS_PORT",-1),kn=n("code",null,"INGRESS_HOST",-1),vn=t(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl create namespace istio-io-tcp-traffic-shifting
$ kubectl label namespace istio-io-tcp-traffic-shifting istio-injection<span class="token operator">=</span>enabled
$ kubectl apply <span class="token parameter variable">-f</span> samples/sleep/sleep.yaml <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting
$ kubectl apply <span class="token parameter variable">-f</span> samples/tcp-echo/tcp-echo-services.yaml <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1),mn=t(`<h4 id="\u5E94\u7528\u57FA\u4E8E\u6743\u91CD\u7684tcp\u8DEF\u7531" tabindex="-1"><a class="header-anchor" href="#\u5E94\u7528\u57FA\u4E8E\u6743\u91CD\u7684tcp\u8DEF\u7531" aria-hidden="true">#</a> \u5E94\u7528\u57FA\u4E8E\u6743\u91CD\u7684TCP\u8DEF\u7531</h4><ol><li>\u5C06\u6240\u6709 TCP \u6D41\u91CF\u8DEF\u7531\u5230\u5FAE\u670D\u52A1\u7684<code>v1</code>\u7248\u672C<code>tcp-echo</code>\u3002</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 samples<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f samples/tcp-echo/tcp-echo-all-v1.yaml -n istio-io-tcp-traffic-shifting</span>

<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 samples<span class="token punctuation">]</span><span class="token comment"># cat tcp-echo/tcp-echo-all-v1.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo<span class="token punctuation">-</span>gateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">31400</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo<span class="token punctuation">-</span>destination
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v2
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> tcp<span class="token punctuation">-</span>echo<span class="token punctuation">-</span>gateway
  <span class="token key atrule">tcp</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">31400</span>
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo
        <span class="token key atrule">port</span><span class="token punctuation">:</span>				<span class="token comment"># \u8FD9\u91CC\u4FEE\u6539\u6210\u4F7F\u7528\u7AEF\u53E3\u7684\u65B9\u5F0F</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">9000</span>		 <span class="token comment"># \u7AEF\u53E3\u53F7\u662F9000</span>
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1            <span class="token comment"># \u7248\u672C\u4F7F\u7528V1\u7248\u672C</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><code>tcp-echo</code>\u901A\u8FC7\u4ECE\u5BA2\u6237\u7AEF\u53D1\u9001\u4E00\u4E9B TCP \u6D41\u91CF\u6765\u786E\u8BA4\u670D\u52A1\u5DF2\u542F\u52A8\u5E76\u6B63\u5728\u8FD0\u884C<code>sleep</code>\u3002</li></ol><blockquote><p>\u4E0B\u9762\u7684 <code>$INGRESS_HOST</code> \u53D8\u91CF\u662F ingress \u7684\u5916\u90E8 IP \u5730\u5740\uFF0C<code>$TCP_INGRESS_PORT</code>\u662Fingress\u7684\u7AEF\u53E3</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.spec.ports[?(@.name==&quot;http2&quot;)].nodePort}&#39;</span><span class="token variable">)</span></span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">SECURE_INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.spec.ports[?(@.name==&quot;https&quot;)].nodePort}&#39;</span><span class="token variable">)</span></span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">TCP_INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.spec.ports[?(@.name==&quot;tcp&quot;)].nodePort}&#39;</span><span class="token variable">)</span></span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">INGRESS_HOST</span><span class="token operator">=</span>worker-node-address
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 samples<span class="token punctuation">]</span><span class="token comment"># for i in {1..20}; do \\</span>
kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>sleep <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>&quot;</span> <span class="token punctuation">\\</span>
<span class="token parameter variable">-c</span> <span class="token function">sleep</span> <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting -- <span class="token function">sh</span> <span class="token parameter variable">-c</span> <span class="token string">&quot;(date; sleep 1) | nc <span class="token variable">$INGRESS_HOST</span> <span class="token variable">$TCP_INGRESS_PORT</span>&quot;</span><span class="token punctuation">;</span> <span class="token punctuation">\\</span>
<span class="token keyword">done</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:24:57 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:00 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:02 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:05 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:07 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:10 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:12 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:15 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:17 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:19 UTC <span class="token number">2018</span>
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u60A8\u5E94\u8BE5\u6CE8\u610F\u5230\u6240\u6709\u65F6\u95F4\u6233\u7684\u524D\u7F00\u90FD\u662F<em>one</em>\uFF0C\u8FD9\u610F\u5473\u7740\u6240\u6709\u6D41\u91CF\u90FD\u88AB\u8DEF\u7531\u5230\u670D\u52A1\u7684<code>v1</code>\u7248\u672C<code>tcp-echo</code>\u3002</p><ol start="3"><li><code>tcp-echo:v1</code>\u4F7F\u7528<code>tcp-echo:v2</code>\u4EE5\u4E0B\u547D\u4EE4\u4F20\u8F93 20% \u7684\u6D41\u91CF\uFF1A</li></ol><blockquote><p>\u901A\u8FC7\u4FEE\u6539<code>weight\u7684\u503C</code>\u6765\u786E\u5B9A\u6D41\u91CF\u7684\u5206\u5E03\u63A7\u5236\u3002</p></blockquote><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 istio<span class="token punctuation">-</span>1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f samples/tcp-echo/tcp-echo-20-v2.yaml</span>

<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 istio<span class="token punctuation">-</span>1.9.5<span class="token punctuation">]</span><span class="token comment"># cat samples/tcp-echo/tcp-echo-20-v2.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> tcp<span class="token punctuation">-</span>echo<span class="token punctuation">-</span>gateway
  <span class="token key atrule">tcp</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">31400</span>
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">9000</span>
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">9000</span>
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">20</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li><p>\u5411\u5FAE\u670D\u52A1\u53D1\u9001\u66F4\u591A TCP \u6D41\u91CF<code>tcp-echo</code>\u3002</p><p>\u60A8\u73B0\u5728\u5E94\u8BE5\u6CE8\u610F\u5230\u5927\u7EA6 20% \u7684\u65F6\u95F4\u6233\u5177\u6709\u524D\u7F00<em>2</em>\uFF0C\u8FD9\u610F\u5473\u7740 80% \u7684 TCP \u6D41\u91CF\u88AB\u8DEF\u7531\u5230\u670D\u52A1<code>v1</code>\u7248\u672C<code>tcp-echo</code>\uFF0C\u800C 20% \u88AB\u8DEF\u7531\u5230<code>v2</code>.</p></li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-1.9.5<span class="token punctuation">]</span><span class="token comment">#  for i in {1..20}; do \\</span>
kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>sleep <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>&quot;</span> <span class="token punctuation">\\</span>
<span class="token parameter variable">-c</span> <span class="token function">sleep</span> <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting -- <span class="token function">sh</span> <span class="token parameter variable">-c</span> <span class="token string">&quot;(date; sleep 1) | nc <span class="token variable">$INGRESS_HOST</span> <span class="token variable">$TCP_INGRESS_PORT</span>&quot;</span><span class="token punctuation">;</span> <span class="token punctuation">\\</span>
<span class="token keyword">done</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:38:45 UTC <span class="token number">2018</span>
two Mon Nov <span class="token number">12</span> <span class="token number">23</span>:38:47 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:38:50 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:38:52 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:38:55 UTC <span class="token number">2018</span>
two Mon Nov <span class="token number">12</span> <span class="token number">23</span>:38:57 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:39:00 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:39:02 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:39:05 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:39:07 UTC <span class="token number">2018</span>
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u6E05\u7406-3" tabindex="-1"><a class="header-anchor" href="#\u6E05\u7406-3" aria-hidden="true">#</a> \u6E05\u7406</h4><p>\u5220\u9664<code>sleep</code>\u793A\u4F8B\u3001<code>tcp-echo</code>\u5E94\u7528\u7A0B\u5E8F\u548C\u8DEF\u7531\u89C4\u5219\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete <span class="token parameter variable">-f</span> samples/tcp-echo/tcp-echo-all-v1.yaml <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting
$ kubectl delete <span class="token parameter variable">-f</span> samples/tcp-echo/tcp-echo-services.yaml <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting
$ kubectl delete <span class="token parameter variable">-f</span> samples/sleep/sleep.yaml <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting
$ kubectl delete namespace istio-io-tcp-traffic-shifting
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u8BF7\u6C42\u8D85\u65F6" tabindex="-1"><a class="header-anchor" href="#\u8BF7\u6C42\u8D85\u65F6" aria-hidden="true">#</a> \u8BF7\u6C42\u8D85\u65F6</h2><h4 id="\u73AF\u5883\u51C6\u5907-3" tabindex="-1"><a class="header-anchor" href="#\u73AF\u5883\u51C6\u5907-3" aria-hidden="true">#</a> \u73AF\u5883\u51C6\u5907</h4>`,17),bn={href:"https://istio.io/latest/docs/examples/bookinfo/",target:"_blank",rel:"noopener noreferrer"},hn=n("li",null,"\u4E86\u89E3\u4E86\u6D41\u91CF\u7BA1\u7406\u7684\u57FA\u7840\u6982\u5FF5\uFF0C\u4EE5\u53CA\u4E13\u4E1A\u8BED\u672F\u3002",-1),gn=t(`<blockquote><p>\u9996\u5148\uFF0C\u8FD0\u884C\u6B64\u547D\u4EE4\u5C06\u6240\u6709\u6D41\u91CF\u8DEF\u7531\u5230<code>v1</code>\u6BCF\u4E2A\u5FAE\u670D\u52A1\u7684\u7248\u672C\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></blockquote><h4 id="\u8BF7\u6C42\u8D85\u65F6-1" tabindex="-1"><a class="header-anchor" href="#\u8BF7\u6C42\u8D85\u65F6-1" aria-hidden="true">#</a> \u8BF7\u6C42\u8D85\u65F6</h4>`,2),yn={href:"https://istio.io/latest/docs/reference/config/networking/virtual-service/#HTTPRoute",target:"_blank",rel:"noopener noreferrer"},fn=n("em",null,"timeout",-1),_n=t(`<ol><li>\u5C06\u8BF7\u6C42\u8DEF\u7531\u5230<code>reviews</code>\u670D\u52A1\u7684 v2\uFF0C\u5373\u8C03\u7528<code>ratings</code>\u670D\u52A1\u7684\u7248\u672C\uFF1A</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>\u5BF9\u670D\u52A1\u7684\u8C03\u7528\u6DFB\u52A0 2 \u79D2\u5EF6\u8FDF<code>ratings</code>\uFF1A <ul><li><code>\u4F7F\u7528http\u89C4\u5219\u914D\u7F6E\u76EE\u7684\u5730\u7248\u672C\u4E3Av1\u4E3B\u673A\u662Fratings</code></li><li><code>\u914D\u7F6E\u767E\u5206\u6BD4\u4E3A100\u76842\u79D2\u56FA\u5B9A\u65F6\u95F4\u5EF6\u8FDF</code></li></ul></li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">fault</span><span class="token punctuation">:</span>
      <span class="token key atrule">delay</span><span class="token punctuation">:</span>
        <span class="token key atrule">percent</span><span class="token punctuation">:</span> <span class="token number">100</span>
        <span class="token key atrule">fixedDelay</span><span class="token punctuation">:</span> 2s
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><code>http://$GATEWAY_URL/productpage</code>\u5728\u6D4F\u89C8\u5668\u4E2D\u6253\u5F00 Bookinfo URL \u3002</li></ol><p>\u60A8\u5E94\u8BE5\u4F1A\u770B\u5230 Bookinfo \u5E94\u7528\u7A0B\u5E8F\u6B63\u5E38\u5DE5\u4F5C\uFF08\u663E\u793A\u8BC4\u7EA7\u661F\uFF09\uFF0C\u4F46\u662F\u6BCF\u5F53\u60A8\u5237\u65B0\u9875\u9762\u65F6\u90FD\u4F1A\u6709 2 \u79D2\u7684\u5EF6\u8FDF\u3002</p><ol start="4"><li>\u73B0\u5728\u4E3A\u5BF9\u670D\u52A1\u7684\u8C03\u7528\u6DFB\u52A0\u534A\u79D2\u8BF7\u6C42\u8D85\u65F6<code>reviews</code>\uFF1A</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 0.5s
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li>\u5237\u65B0 Bookinfo \u7F51\u9875\u3002</li></ol><p>\u60A8\u73B0\u5728\u5E94\u8BE5\u770B\u5230\u5B83\u5728\u5927\u7EA6 1 \u79D2\u5185\u8FD4\u56DE\uFF0C\u800C\u4E0D\u662F 2 \u79D2\uFF0C\u5E76\u4E14\u8BC4\u8BBA\u4E0D\u53EF\u7528\u3002</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062327037.png" alt="image-20220318111010285" loading="lazy"></p><blockquote><p>\u6CE8\u610F\uFF1A</p><p>\u54CD\u5E94\u9700\u89811\u79D2\u7684\u539F\u56E0\uFF0C\u5373\u4F7F\u8D85\u65F6\u914D\u7F6E\u4E3A\u534A\u79D2\uFF0C\u4E5F\u662F\u56E0\u4E3A\u670D\u52A1\u4E2D\u6709\u786C\u7F16\u7801\u7684\u91CD\u8BD5\uFF0C\u6240\u4EE5\u5B83\u5728\u8FD4\u56DE\u4E4B\u524D\u8C03\u7528\u4E86\u4E24\u6B21<code>productpage</code>\u8D85\u65F6\u670D\u52A1\u3002<code>reviews</code></p></blockquote><h4 id="\u6E05\u7406-4" tabindex="-1"><a class="header-anchor" href="#\u6E05\u7406-4" aria-hidden="true">#</a> \u6E05\u7406</h4><p>\u5220\u9664\u5E94\u7528\u7A0B\u5E8F\u8DEF\u7531\u89C4\u5219\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="\u7194\u65AD-1" tabindex="-1"><a class="header-anchor" href="#\u7194\u65AD-1" aria-hidden="true">#</a> \u7194\u65AD</h2><h4 id="\u7194\u65AD\u7684\u65B9\u5F0F" tabindex="-1"><a class="header-anchor" href="#\u7194\u65AD\u7684\u65B9\u5F0F" aria-hidden="true">#</a> \u7194\u65AD\u7684\u65B9\u5F0F</h4><p>\u6B64\u4EFB\u52A1\u5411\u60A8\u5C55\u793A\u5982\u4F55\u4E3A\u8FDE\u63A5\u3001\u8BF7\u6C42\u548C\u5F02\u5E38\u503C\u68C0\u6D4B\u914D\u7F6E\u65AD\u8DEF\u3002</p><p>\u65AD\u8DEF\u662F\u521B\u5EFA\u5F39\u6027\u5FAE\u670D\u52A1\u5E94\u7528\u7A0B\u5E8F\u7684\u91CD\u8981\u6A21\u5F0F\u3002\u65AD\u8DEF\u5141\u8BB8\u60A8\u7F16\u5199\u9650\u5236\u6545\u969C\u3001\u5EF6\u8FDF\u5CF0\u503C\u548C\u7F51\u7EDC\u7279\u6027\u7684\u5176\u4ED6\u4E0D\u826F\u5F71\u54CD\u7684\u5F71\u54CD\u7684\u5E94\u7528\u7A0B\u5E8F\u3002</p><p>\u5728\u6B64\u4EFB\u52A1\u4E2D\uFF0C\u60A8\u5C06\u914D\u7F6E\u65AD\u8DEF\u5668\u89C4\u5219\uFF0C\u7136\u540E\u901A\u8FC7\u6709\u610F\u201C\u8DF3\u95F8\u201D\u65AD\u8DEF\u5668\u6765\u6D4B\u8BD5\u914D\u7F6E\u3002</p><h4 id="\u73AF\u5883\u51C6\u5907-4" tabindex="-1"><a class="header-anchor" href="#\u73AF\u5883\u51C6\u5907-4" aria-hidden="true">#</a> \u73AF\u5883\u51C6\u5907</h4>`,21),xn={href:"https://github.com/istio/istio/tree/release-1.13/samples/httpbin",target:"_blank",rel:"noopener noreferrer"},Tn={href:"https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection",target:"_blank",rel:"noopener noreferrer"},qn=n("code",null,"httpbin",-1),wn=t(`<p>\u5426\u5219\uFF0C\u60A8\u5FC5\u987B\u5728\u90E8\u7F72\u5E94\u7528\u7A0B\u5E8F\u4E4B\u524D\u624B\u52A8\u6CE8\u5165 sidecar <code>httpbin</code>\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/httpbin/httpbin.yaml
$ kubectl apply <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject <span class="token parameter variable">-f</span> samples/httpbin/httpbin.yaml<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u914D\u7F6E\u65AD\u8DEF\u5668" tabindex="-1"><a class="header-anchor" href="#\u914D\u7F6E\u65AD\u8DEF\u5668" aria-hidden="true">#</a> \u914D\u7F6E\u65AD\u8DEF\u5668</h4>`,3),Sn={href:"https://istio.io/latest/docs/reference/config/networking/destination-rule/",target:"_blank",rel:"noopener noreferrer"},Pn=n("code",null,"httpbin",-1),In=t("<ul><li><code>\u914D\u7F6E\u4EA4\u901A\u653F\u7B56\u7684\u8FDE\u63A5\u6C60\u548C\u5F02\u5E38\u68C0\u6D4B</code></li><li><code>\u914D\u7F6E\u8FDE\u63A5\u6C60\u7684tcp\u89C4\u5219\u5230\u76EE\u6807\u4E3B\u673A\u7684\u6700\u5927HTTP1/TCP\u8FDE\u63A5\u6570\u4E3A 1</code></li><li><code>\u914D\u7F6E\u8FDE\u63A5\u6C60\u7684http\u89C4\u5219\u5BF9\u76EE\u6807\u7684\u6700\u5927\u6302\u8D77HTTP\u8BF7\u6C42\u6570\u4E3A 1 </code></li><li><code>\u914D\u7F6E\u8FDE\u63A5\u6C60\u7684http\u89C4\u5219\u6BCF\u4E2A\u540E\u7AEF\u8FDE\u63A5\u7684\u6700\u5927\u8BF7\u6C42\u6570\u4E3A 1</code></li><li><code>\u914D\u7F6E\u5F02\u5E38\u68C0\u6D4B\u4ECE\u8FDE\u63A5\u6C60\u4E2D\u5F39\u51FA\u4E3B\u673A\u4E4B\u524D\u76845xx\u9519\u8BEF\u6570\u4E3A 1</code></li><li><code>\u914D\u7F6E\u5F02\u5E38\u68C0\u6D4B\u5F39\u5C04\u626B\u63CF\u5206\u6790\u4E4B\u95F4\u7684\u65F6\u95F4\u95F4\u9694\u4E3A 1\u79D2</code></li><li><code>\u914D\u7F6E\u5F02\u5E38\u68C0\u6D4B\u6700\u77ED\u5F39\u5C04\u65F6\u95F4\u4E3A 3\u5206\u949F</code></li><li><code>\u914D\u7F6E\u5F02\u5E38\u68C0\u6D4B\u6700\u5927\u5F39\u5C04\u767E\u5206\u6BD4\u4E3A 100</code></li></ul>",1),En=n("code",null,"mode: ISTIO_MUTUAL",-1),$n=n("code",null,"DestinationRule",-1),Cn={href:"https://istio.io/latest/docs/ops/common-problems/network-issues/#503-errors-after-setting-destination-rule",target:"_blank",rel:"noopener noreferrer"},Hn=t(`<div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">connectionPool</span><span class="token punctuation">:</span>
      <span class="token key atrule">tcp</span><span class="token punctuation">:</span>
        <span class="token key atrule">maxConnections</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">http</span><span class="token punctuation">:</span>
        <span class="token key atrule">http1MaxPendingRequests</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token key atrule">maxRequestsPerConnection</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">outlierDetection</span><span class="token punctuation">:</span>
      <span class="token key atrule">consecutive5xxErrors</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 1s
      <span class="token key atrule">baseEjectionTime</span><span class="token punctuation">:</span> 3m
      <span class="token key atrule">maxEjectionPercent</span><span class="token punctuation">:</span> <span class="token number">100</span>
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>\u9A8C\u8BC1\u76EE\u6807\u89C4\u5219\u662F\u5426\u5DF2\u6B63\u786E\u521B\u5EFA\uFF1A</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl get destinationrules</span>
NAME                   HOST          AGE
details                details       4h41m
httpbin                httpbin       64m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u6DFB\u52A0\u5BA2\u6237\u7AEF" tabindex="-1"><a class="header-anchor" href="#\u6DFB\u52A0\u5BA2\u6237\u7AEF" aria-hidden="true">#</a> \u6DFB\u52A0\u5BA2\u6237\u7AEF</h4>`,4),Nn=n("code",null,"httpbin",-1),On={href:"https://github.com/istio/fortio",target:"_blank",rel:"noopener noreferrer"},Rn=n("code",null,"DestinationRule",-1),Ln={href:"https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection",target:"_blank",rel:"noopener noreferrer"},An=n("code",null,"fortio",-1),Vn=t(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/httpbin/sample-client/fortio-deploy.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u5426\u5219\uFF0C\u60A8\u5FC5\u987B\u5728\u90E8\u7F72\u5E94\u7528\u7A0B\u5E8F\u4E4B\u524D\u624B\u52A8\u6CE8\u5165 sidecar <code>fortio</code>\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject <span class="token parameter variable">-f</span> samples/httpbin/sample-client/fortio-deploy.yaml<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="2"><li>\u767B\u5F55\u5BA2\u6237\u7AEFpod\uFF0C\u4F7F\u7528fortio\u5DE5\u5177\u8C03\u7528<code>httpbin</code>. \u4F20\u5165<code>curl</code>\u8868\u793A\u4F60\u53EA\u60F3\u6253\u4E00\u4E2A\u7535\u8BDD\uFF1A</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">FORTIO_POD</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pods <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>fortio <span class="token parameter variable">-o</span> <span class="token string">&#39;jsonpath={.items[0].metadata.name}&#39;</span><span class="token variable">)</span></span>
$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">$FORTIO_POD</span>&quot;</span> <span class="token parameter variable">-c</span> fortio -- /usr/bin/fortio <span class="token function">curl</span> <span class="token parameter variable">-quiet</span> http://httpbin:8000/get
HTTP/1.1 <span class="token number">200</span> OK
server: envoy
date: Tue, <span class="token number">25</span> Feb <span class="token number">2020</span> <span class="token number">20</span>:25:52 GMT
content-type: application/json
content-length: <span class="token number">586</span>
access-control-allow-origin: *
access-control-allow-credentials: <span class="token boolean">true</span>
x-envoy-upstream-service-time: <span class="token number">36</span>

<span class="token punctuation">{</span>
  <span class="token string">&quot;args&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>,
  <span class="token string">&quot;headers&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;Content-Length&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;0&quot;</span>,
    <span class="token string">&quot;Host&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;httpbin:8000&quot;</span>,
    <span class="token string">&quot;User-Agent&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;fortio.org/fortio-1.3.1&quot;</span>,
    <span class="token string">&quot;X-B3-Parentspanid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;8fc453fb1dec2c22&quot;</span>,
    <span class="token string">&quot;X-B3-Sampled&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1&quot;</span>,
    <span class="token string">&quot;X-B3-Spanid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;071d7f06bc94943c&quot;</span>,
    <span class="token string">&quot;X-B3-Traceid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;86a929a0e76cda378fc453fb1dec2c22&quot;</span>,
    <span class="token string">&quot;X-Forwarded-Client-Cert&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;By=spiffe://cluster.local/ns/default/sa/httpbin;Hash=68bbaedefe01ef4cb99e17358ff63e92d04a4ce831a35ab9a31d3c8e06adb038;Subject=<span class="token entity" title="\\&quot;">\\&quot;</span><span class="token entity" title="\\&quot;">\\&quot;</span>;URI=spiffe://cluster.local/ns/default/sa/default&quot;</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;origin&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;127.0.0.1&quot;</span>,
  <span class="token string">&quot;url&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;http://httpbin:8000/get&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u4F7F\u65AD\u8DEF\u5668\u8DF3\u95F8" tabindex="-1"><a class="header-anchor" href="#\u4F7F\u65AD\u8DEF\u5668\u8DF3\u95F8" aria-hidden="true">#</a> \u4F7F\u65AD\u8DEF\u5668\u8DF3\u95F8</h4><p>\u5728<code>DestinationRule</code>\u8BBE\u7F6E\u4E2D\uFF0C\u60A8\u6307\u5B9A\u4E86<code>maxConnections: 1</code>\u548C <code>http1MaxPendingRequests: 1</code>\u3002\u8FD9\u4E9B\u89C4\u5219\u8868\u660E\uFF0C\u5982\u679C\u60A8\u8D85\u8FC7\u4E00\u4E2A\u8FDE\u63A5\u5E76\u540C\u65F6\u8BF7\u6C42\uFF0C\u5219\u5F53 <code>istio-proxy</code>\u6253\u5F00\u66F4\u591A\u8BF7\u6C42\u548C\u8FDE\u63A5\u7684\u7535\u8DEF\u65F6\uFF0C\u60A8\u5E94\u8BE5\u4F1A\u770B\u5230\u4E00\u4E9B\u5931\u8D25\u3002</p><ol><li>\u4F7F\u7528\u4E24\u4E2A\u5E76\u53D1\u8FDE\u63A5 ( <code>-c 2</code>) \u8C03\u7528\u670D\u52A1\u5E76\u53D1\u9001 20 \u4E2A\u8BF7\u6C42 ( <code>-n 20</code>)\uFF1A</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl exec &quot;$FORTIO_POD&quot; -c fortio -- /usr/bin/fortio load -c 2 -qps 0 -n 20 -loglevel Warning http://httpbin:8000/get</span>
<span class="token number">15</span>:42:53 I logger.go:12<span class="token operator"><span class="token file-descriptor important">7</span>&gt;</span> Log level is now <span class="token number">3</span> Warning <span class="token punctuation">(</span>was <span class="token number">2</span> Info<span class="token punctuation">)</span>
Fortio <span class="token number">1.17</span>.1 running at <span class="token number">0</span> queries per second, <span class="token number">4</span>-<span class="token operator">&gt;</span><span class="token number">4</span> procs, <span class="token keyword">for</span> <span class="token number">20</span> calls: http://httpbin:8000/get
Starting at max qps with <span class="token number">2</span> thread<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">[</span>gomax <span class="token number">4</span><span class="token punctuation">]</span> <span class="token keyword">for</span> exactly <span class="token number">20</span> calls <span class="token punctuation">(</span><span class="token number">10</span> per thread + <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">15</span>:42:53 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:42:53 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:42:53 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:42:53 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:42:53 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:42:53 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
Ended after <span class="token number">90</span>.508623ms <span class="token builtin class-name">:</span> <span class="token number">20</span> calls. <span class="token assign-left variable">qps</span><span class="token operator">=</span><span class="token number">220.97</span>
Aggregated Function Time <span class="token builtin class-name">:</span> count <span class="token number">20</span> avg <span class="token number">0.0081634006</span> +/- <span class="token number">0.006652</span> min <span class="token number">0.000929244</span> max <span class="token number">0.027135759</span> <span class="token function">sum</span> <span class="token number">0.163268012</span>
<span class="token comment"># range, mid point, percentile, count</span>
<span class="token operator">&gt;=</span> <span class="token number">0.000929244</span> <span class="token operator">&lt;=</span> <span class="token number">0.001</span> , <span class="token number">0.000964622</span> , <span class="token number">5.00</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.001</span> <span class="token operator">&lt;=</span> <span class="token number">0.002</span> , <span class="token number">0.0015</span> , <span class="token number">25.00</span>, <span class="token number">4</span>
<span class="token operator">&gt;</span> <span class="token number">0.002</span> <span class="token operator">&lt;=</span> <span class="token number">0.003</span> , <span class="token number">0.0025</span> , <span class="token number">30.00</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.005</span> <span class="token operator">&lt;=</span> <span class="token number">0.006</span> , <span class="token number">0.0055</span> , <span class="token number">40.00</span>, <span class="token number">2</span>
<span class="token operator">&gt;</span> <span class="token number">0.006</span> <span class="token operator">&lt;=</span> <span class="token number">0.007</span> , <span class="token number">0.0065</span> , <span class="token number">50.00</span>, <span class="token number">2</span>
<span class="token operator">&gt;</span> <span class="token number">0.007</span> <span class="token operator">&lt;=</span> <span class="token number">0.008</span> , <span class="token number">0.0075</span> , <span class="token number">60.00</span>, <span class="token number">2</span>
<span class="token operator">&gt;</span> <span class="token number">0.008</span> <span class="token operator">&lt;=</span> <span class="token number">0.009</span> , <span class="token number">0.0085</span> , <span class="token number">65.00</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.009</span> <span class="token operator">&lt;=</span> <span class="token number">0.01</span> , <span class="token number">0.0095</span> , <span class="token number">80.00</span>, <span class="token number">3</span>
<span class="token operator">&gt;</span> <span class="token number">0.014</span> <span class="token operator">&lt;=</span> <span class="token number">0.016</span> , <span class="token number">0.015</span> , <span class="token number">85.00</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.018</span> <span class="token operator">&lt;=</span> <span class="token number">0.02</span> , <span class="token number">0.019</span> , <span class="token number">95.00</span>, <span class="token number">2</span>
<span class="token operator">&gt;</span> <span class="token number">0.025</span> <span class="token operator">&lt;=</span> <span class="token number">0.0271358</span> , <span class="token number">0.0260679</span> , <span class="token number">100.00</span>, <span class="token number">1</span>
<span class="token comment"># target 50% 0.007</span>
<span class="token comment"># target 75% 0.00966667</span>
<span class="token comment"># target 90% 0.019</span>
<span class="token comment"># target 99% 0.0267086</span>
<span class="token comment"># target 99.9% 0.027093</span>
Sockets used: <span class="token number">8</span> <span class="token punctuation">(</span>for perfect keepalive, would be <span class="token number">2</span><span class="token punctuation">)</span>
Jitter: <span class="token boolean">false</span>
Code <span class="token number">200</span> <span class="token builtin class-name">:</span> <span class="token number">14</span> <span class="token punctuation">(</span><span class="token number">70.0</span> %<span class="token punctuation">)</span>
Code <span class="token number">503</span> <span class="token builtin class-name">:</span> <span class="token number">6</span> <span class="token punctuation">(</span><span class="token number">30.0</span> %<span class="token punctuation">)</span>
Response Header Sizes <span class="token builtin class-name">:</span> count <span class="token number">20</span> avg <span class="token number">161.15</span> +/- <span class="token number">105.5</span> min <span class="token number">0</span> max <span class="token number">231</span> <span class="token function">sum</span> <span class="token number">3223</span>
Response Body/Total Sizes <span class="token builtin class-name">:</span> count <span class="token number">20</span> avg <span class="token number">649.25</span> +/- <span class="token number">267.3</span> min <span class="token number">241</span> max <span class="token number">825</span> <span class="token function">sum</span> <span class="token number">12985</span>
All <span class="token keyword">done</span> <span class="token number">20</span> calls <span class="token punctuation">(</span>plus <span class="token number">0</span> warmup<span class="token punctuation">)</span> <span class="token number">8.163</span> ms avg, <span class="token number">221.0</span> qps
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6709\u8DA3\u7684\u662F\uFF0C\u51E0\u4E4E\u6240\u6709\u8BF7\u6C42\u90FD\u901A\u8FC7\u4E86\uFF01<code>istio-proxy</code> \u786E\u5B9E\u7559\u6709\u4F59\u5730\u3002</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>Code 200 : 14 (70.0 %)
Code 503 : 6 (30.0 %)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>\u5C06\u5E76\u53D1\u8FDE\u63A5\u6570\u589E\u52A0\u5230 3\uFF1A</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl exec &quot;$FORTIO_POD&quot; -c fortio -- /usr/bin/fortio load -c 3 -qps 0 -n 20 -loglevel Warning http://httpbin:8000/get</span>
<span class="token number">15</span>:44:49 I logger.go:12<span class="token operator"><span class="token file-descriptor important">7</span>&gt;</span> Log level is now <span class="token number">3</span> Warning <span class="token punctuation">(</span>was <span class="token number">2</span> Info<span class="token punctuation">)</span>
Fortio <span class="token number">1.17</span>.1 running at <span class="token number">0</span> queries per second, <span class="token number">4</span>-<span class="token operator">&gt;</span><span class="token number">4</span> procs, <span class="token keyword">for</span> <span class="token number">20</span> calls: http://httpbin:8000/get
Starting at max qps with <span class="token number">3</span> thread<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">[</span>gomax <span class="token number">4</span><span class="token punctuation">]</span> <span class="token keyword">for</span> exactly <span class="token number">20</span> calls <span class="token punctuation">(</span><span class="token number">6</span> per thread + <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
Ended after <span class="token number">32</span>.522699ms <span class="token builtin class-name">:</span> <span class="token number">20</span> calls. <span class="token assign-left variable">qps</span><span class="token operator">=</span><span class="token number">614.96</span>
Aggregated Function Time <span class="token builtin class-name">:</span> count <span class="token number">20</span> avg <span class="token number">0.0029114787</span> +/- <span class="token number">0.003681</span> min <span class="token number">0.000447652</span> max <span class="token number">0.016532305</span> <span class="token function">sum</span> <span class="token number">0.058229575</span>
<span class="token comment"># range, mid point, percentile, count</span>
<span class="token operator">&gt;=</span> <span class="token number">0.000447652</span> <span class="token operator">&lt;=</span> <span class="token number">0.001</span> , <span class="token number">0.000723826</span> , <span class="token number">30.00</span>, <span class="token number">6</span>
<span class="token operator">&gt;</span> <span class="token number">0.001</span> <span class="token operator">&lt;=</span> <span class="token number">0.002</span> , <span class="token number">0.0015</span> , <span class="token number">60.00</span>, <span class="token number">6</span>
<span class="token operator">&gt;</span> <span class="token number">0.002</span> <span class="token operator">&lt;=</span> <span class="token number">0.003</span> , <span class="token number">0.0025</span> , <span class="token number">70.00</span>, <span class="token number">2</span>
<span class="token operator">&gt;</span> <span class="token number">0.004</span> <span class="token operator">&lt;=</span> <span class="token number">0.005</span> , <span class="token number">0.0045</span> , <span class="token number">90.00</span>, <span class="token number">4</span>
<span class="token operator">&gt;</span> <span class="token number">0.008</span> <span class="token operator">&lt;=</span> <span class="token number">0.009</span> , <span class="token number">0.0085</span> , <span class="token number">95.00</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.016</span> <span class="token operator">&lt;=</span> <span class="token number">0.0165323</span> , <span class="token number">0.0162662</span> , <span class="token number">100.00</span>, <span class="token number">1</span>
<span class="token comment"># target 50% 0.00166667</span>
<span class="token comment"># target 75% 0.00425</span>
<span class="token comment"># target 90% 0.005</span>
<span class="token comment"># target 99% 0.0164258</span>
<span class="token comment"># target 99.9% 0.0165217</span>
Sockets used: <span class="token number">16</span> <span class="token punctuation">(</span>for perfect keepalive, would be <span class="token number">3</span><span class="token punctuation">)</span>
Jitter: <span class="token boolean">false</span>
Code <span class="token number">200</span> <span class="token builtin class-name">:</span> <span class="token number">5</span> <span class="token punctuation">(</span><span class="token number">25.0</span> %<span class="token punctuation">)</span>
Code <span class="token number">503</span> <span class="token builtin class-name">:</span> <span class="token number">15</span> <span class="token punctuation">(</span><span class="token number">75.0</span> %<span class="token punctuation">)</span>
Response Header Sizes <span class="token builtin class-name">:</span> count <span class="token number">20</span> avg <span class="token number">57.55</span> +/- <span class="token number">99.68</span> min <span class="token number">0</span> max <span class="token number">231</span> <span class="token function">sum</span> <span class="token number">1151</span>
Response Body/Total Sizes <span class="token builtin class-name">:</span> count <span class="token number">20</span> avg <span class="token number">386.8</span> +/- <span class="token number">252.5</span> min <span class="token number">241</span> max <span class="token number">825</span> <span class="token function">sum</span> <span class="token number">7736</span>
All <span class="token keyword">done</span> <span class="token number">20</span> calls <span class="token punctuation">(</span>plus <span class="token number">0</span> warmup<span class="token punctuation">)</span> <span class="token number">2.911</span> ms avg, <span class="token number">615.0</span> qps
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u73B0\u5728\u60A8\u5F00\u59CB\u770B\u5230\u9884\u671F\u7684\u65AD\u8DEF\u884C\u4E3A\u3002\u53EA\u6709 36.7% \u7684\u8BF7\u6C42\u6210\u529F\uFF0C\u5176\u4F59\u7684\u5219\u88AB\u7194\u65AD\u673A\u5236\u56F0\u4F4F\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>Code 200 : 5 (25.0 %)
Code 503 : 15 (75.0 %)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><p>\u67E5\u8BE2<code>istio-proxy</code>\u7EDF\u8BA1\u4FE1\u606F\u4EE5\u67E5\u770B\u66F4\u591A\u4FE1\u606F\uFF1A</p><p>\u60A8\u53EF\u4EE5\u67E5\u770B<code>21</code>\u8BE5<code>upstream_rq_pending_overflow</code>\u503C\uFF0C\u8FD9\u610F\u5473\u7740<code>21</code> \u5230\u76EE\u524D\u4E3A\u6B62\u7684\u8C03\u7528\u5DF2\u88AB\u6807\u8BB0\u4E3A\u65AD\u8DEF\u3002</p></li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl exec &quot;$FORTIO_POD&quot; -c istio-proxy -- pilot-agent request GET stats | grep httpbin | grep pending</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.circuit_breakers.default.remaining_pending: <span class="token number">1</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.circuit_breakers.default.rq_pending_open: <span class="token number">0</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.circuit_breakers.high.rq_pending_open: <span class="token number">0</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.upstream_rq_pending_active: <span class="token number">0</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.upstream_rq_pending_failure_eject: <span class="token number">0</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.upstream_rq_pending_overflow: <span class="token number">40</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.upstream_rq_pending_total: <span class="token number">41</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u6E05\u7406-5" tabindex="-1"><a class="header-anchor" href="#\u6E05\u7406-5" aria-hidden="true">#</a> \u6E05\u7406</h4><p>\u5220\u9664\u89C4\u5219\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete destinationrule httpbin
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,20),Dn={href:"https://github.com/istio/istio/tree/release-1.13/samples/httpbin",target:"_blank",rel:"noopener noreferrer"},Gn=t(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete deploy httpbin fortio-deploy
$ kubectl delete svc httpbin fortio
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u955C\u50CF" tabindex="-1"><a class="header-anchor" href="#\u955C\u50CF" aria-hidden="true">#</a> \u955C\u50CF</h2><h4 id="\u6D41\u91CF\u955C\u50CF" tabindex="-1"><a class="header-anchor" href="#\u6D41\u91CF\u955C\u50CF" aria-hidden="true">#</a> \u6D41\u91CF\u955C\u50CF</h4><p>\u6B64\u4EFB\u52A1\u6F14\u793A\u4E86 Istio \u7684\u6D41\u91CF\u955C\u50CF\u529F\u80FD\u3002</p><p>\u6D41\u91CF\u955C\u50CF\uFF0C\u4E5F\u79F0\u4E3A\u9634\u5F71\uFF0C\u662F\u4E00\u4E2A\u5F3A\u5927\u7684\u6982\u5FF5\uFF0C\u5B83\u5141\u8BB8\u529F\u80FD\u56E2\u961F\u4EE5\u5C3D\u53EF\u80FD\u5C0F\u7684\u98CE\u9669\u5C06\u66F4\u6539\u5E26\u5165\u751F\u4EA7\u73AF\u5883\u3002\u955C\u50CF\u5C06\u5B9E\u65F6\u6D41\u91CF\u7684\u526F\u672C\u53D1\u9001\u5230\u955C\u50CF\u670D\u52A1\u3002\u955C\u50CF\u6D41\u91CF\u53D1\u751F\u5728\u4E3B\u670D\u52A1\u7684\u5173\u952E\u8BF7\u6C42\u8DEF\u5F84\u7684\u5E26\u5916\u3002</p><p>\u5728\u6B64\u4EFB\u52A1\u4E2D\uFF0C\u60A8\u5C06\u9996\u5148\u5F3A\u5236\u6240\u6709\u6D41\u91CF\u6D41\u5411<code>v1</code>\u6D4B\u8BD5\u670D\u52A1\u3002\u7136\u540E\uFF0C\u60A8\u5C06\u5E94\u7528\u89C4\u5219\u5C06\u4E00\u90E8\u5206\u6D41\u91CF\u955C\u50CF\u5230<code>v2</code>.</p><h4 id="\u57FA\u7840\u73AF\u5883-1" tabindex="-1"><a class="header-anchor" href="#\u57FA\u7840\u73AF\u5883-1" aria-hidden="true">#</a> \u57FA\u7840\u73AF\u5883</h4>`,7),Mn={href:"https://github.com/istio/istio/tree/release-1.13/samples/httpbin",target:"_blank",rel:"noopener noreferrer"},Un=t(`<p><strong>httpbin-v1\uFF1A</strong></p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ cat &lt;&lt;EOF <span class="token punctuation">|</span> istioctl kube<span class="token punctuation">-</span>inject <span class="token punctuation">-</span>f <span class="token punctuation">-</span> <span class="token punctuation">|</span> kubectl create <span class="token punctuation">-</span>f <span class="token punctuation">-</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin<span class="token punctuation">-</span>v1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> httpbin
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> httpbin
        <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> docker.io/kennethreitz/httpbin
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;gunicorn&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--access-logfile&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0.0.0.0:80&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;httpbin:app&quot;</span><span class="token punctuation">]</span>
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>httpbin-v2\uFF1A</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> istioctl kube-inject <span class="token parameter variable">-f</span> - <span class="token operator">|</span> kubectl create <span class="token parameter variable">-f</span> -</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  name: httpbin-v2
spec:
  replicas: 1
  selector:
    matchLabels:
      app: httpbin
      version: v2
  template:
    metadata:
      labels:
        app: httpbin
        version: v2
    spec:
      containers:
      - image: docker.io/kennethreitz/httpbin
        imagePullPolicy: IfNotPresent
        name: httpbin
        command: [&quot;gunicorn&quot;, &quot;--access-logfile&quot;, &quot;-&quot;, &quot;-b&quot;, &quot;0.0.0.0:80&quot;, &quot;httpbin:app&quot;]
        ports:
        - containerPort: 80
EOF</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>httpbin Kubernetes \u670D\u52A1\uFF1A</strong></p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl create <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8000</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> httpbin
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u542F\u52A8<code>sleep</code>\u670D\u52A1\uFF0C\u4EE5\u4FBF\u60A8\u53EF\u4EE5\u4F7F\u7528\u5B83<code>curl</code>\u6765\u63D0\u4F9B\u8D1F\u8F7D\uFF1A</p><p><strong>\u7761\u7720\u670D\u52A1\uFF1A</strong></p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ cat &lt;&lt;EOF <span class="token punctuation">|</span> istioctl kube<span class="token punctuation">-</span>inject <span class="token punctuation">-</span>f <span class="token punctuation">-</span> <span class="token punctuation">|</span> kubectl create <span class="token punctuation">-</span>f <span class="token punctuation">-</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> sleep
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> sleep
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> sleep
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> sleep
        <span class="token key atrule">image</span><span class="token punctuation">:</span> curlimages/curl
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/sleep&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;3650d&quot;</span><span class="token punctuation">]</span>
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u521B\u5EFA\u9ED8\u8BA4\u8DEF\u7531\u7B56\u7565" tabindex="-1"><a class="header-anchor" href="#\u521B\u5EFA\u9ED8\u8BA4\u8DEF\u7531\u7B56\u7565" aria-hidden="true">#</a> \u521B\u5EFA\u9ED8\u8BA4\u8DEF\u7531\u7B56\u7565</h4><p>\u9ED8\u8BA4\u60C5\u51B5\u4E0B\uFF0CKubernetes \u4F1A\u5728<code>httpbin</code>\u670D\u52A1\u7684\u4E24\u4E2A\u7248\u672C\u4E4B\u95F4\u8FDB\u884C\u8D1F\u8F7D\u5E73\u8861\u3002\u5728\u6B64\u6B65\u9AA4\u4E2D\uFF0C\u60A8\u5C06\u66F4\u6539\u8BE5\u884C\u4E3A\uFF0C\u4EE5\u4FBF\u6240\u6709\u6D41\u91CF\u90FD\u8F6C\u5230<code>v1</code>.</p><ol><li>\u521B\u5EFA\u9ED8\u8BA4\u8DEF\u7531\u89C4\u5219\u4EE5\u5C06\u6240\u6709\u6D41\u91CF\u8DEF\u7531\u5230<code>v1</code>\u670D\u52A1\uFF0C\u73B0\u5728\u6240\u6709\u6D41\u91CF\u90FD\u6D41\u5411<code>httpbin:v1</code>\u670D\u52A1\u3002\uFF1A</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> httpbin
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v2
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>\u5411\u670D\u52A1\u53D1\u9001\u4E00\u4E9B\u6D41\u91CF\uFF1A</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">SLEEP_POD</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>sleep <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>
$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">\${SLEEP_POD}</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sS</span> http://httpbin:8000/headers
<span class="token punctuation">{</span>
  <span class="token string">&quot;headers&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;Accept&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;*/*&quot;</span>,
    <span class="token string">&quot;Content-Length&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;0&quot;</span>,
    <span class="token string">&quot;Host&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;httpbin:8000&quot;</span>,
    <span class="token string">&quot;User-Agent&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;curl/7.35.0&quot;</span>,
    <span class="token string">&quot;X-B3-Parentspanid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;57784f8bff90ae0b&quot;</span>,
    <span class="token string">&quot;X-B3-Sampled&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1&quot;</span>,
    <span class="token string">&quot;X-B3-Spanid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;3289ae7257c3f159&quot;</span>,
    <span class="token string">&quot;X-B3-Traceid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;b56eebd279a76f0b57784f8bff90ae0b&quot;</span>,
    <span class="token string">&quot;X-Envoy-Attempt-Count&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1&quot;</span>,
    <span class="token string">&quot;X-Forwarded-Client-Cert&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;By=spiffe://cluster.local/ns/default/sa/default;Hash=20afebed6da091c850264cc751b8c9306abac02993f80bdb76282237422bd098;Subject=<span class="token entity" title="\\&quot;">\\&quot;</span><span class="token entity" title="\\&quot;">\\&quot;</span>;URI=spiffe://cluster.local/ns/default/sa/default&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>\u68C0\u67E5pod<code>v1</code>\u7684\u65E5\u5FD7<code>v2</code>\u3002<code>httpbin</code>\u60A8\u5E94\u8BE5\u770B\u5230\u4EE5\u4E0B\u7684\u8BBF\u95EE\u65E5\u5FD7\u6761\u76EE\uFF0C<code>v1</code>\u5E76\u4E14\u6CA1\u6709<code>v2</code>\uFF1A</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">V1_POD</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>httpbin,version<span class="token operator">=</span>v1 <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>
$ kubectl logs <span class="token string">&quot;<span class="token variable">$V1_POD</span>&quot;</span> <span class="token parameter variable">-c</span> httpbin
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Starting gunicorn <span class="token number">19.9</span>.0
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Listening at: http://0.0.0.0:80 <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Using worker: <span class="token function">sync</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Booting worker with pid: <span class="token number">9</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:30:43 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">529</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>


$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">V2_POD</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>httpbin,version<span class="token operator">=</span>v2 <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>
$ kubectl logs <span class="token string">&quot;<span class="token variable">$V2_POD</span>&quot;</span> <span class="token parameter variable">-c</span> httpbin
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Starting gunicorn <span class="token number">19.9</span>.0
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Listening at: http://0.0.0.0:80 <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Using worker: <span class="token function">sync</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Booting worker with pid: <span class="token number">10</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u5C06\u6D41\u91CF\u955C\u50CF\u5230v2" tabindex="-1"><a class="header-anchor" href="#\u5C06\u6D41\u91CF\u955C\u50CF\u5230v2" aria-hidden="true">#</a> \u5C06\u6D41\u91CF\u955C\u50CF\u5230v2</h4><p><strong>\u66F4\u6539\u8DEF\u7531\u89C4\u5219\u4EE5\u5C06\u6D41\u91CF\u955C\u50CF\u5230 v2\uFF1A</strong></p><p>\u6B64\u8DEF\u7531\u89C4\u5219\u5C06 100% \u7684\u6D41\u91CF\u53D1\u9001\u5230<code>v1</code>. \u6700\u540E\u4E00\u8282\u6307\u5B9A\u60A8\u5E0C\u671B\u5C06 100% \u7684\u76F8\u540C\u6D41\u91CF\u955C\u50CF\uFF08\u5373\uFF0C\u4E5F\u53D1\u9001\uFF09\u5230 <code>httpbin:v2</code>\u670D\u52A1\u3002</p><p>\u5F53\u6D41\u91CF\u88AB\u955C\u50CF\u65F6\uFF0C\u8BF7\u6C42\u88AB\u53D1\u9001\u5230\u955C\u50CF\u670D\u52A1\uFF0C\u5176 Host/Authority \u6807\u5934\u9644\u52A0<code>-shadow</code>. \u4F8B\u5982\uFF0C<code>cluster-1</code>\u53D8\u6210<code>cluster-1-shadow</code>\u3002</p><p>\u6B64\u5916\uFF0C\u91CD\u8981\u7684\u662F\u8981\u6CE8\u610F\u8FD9\u4E9B\u8BF7\u6C42\u88AB\u955C\u50CF\u4E3A\u201C\u5373\u53D1\u5373\u5F03\u201D\uFF0C\u8FD9\u610F\u5473\u7740\u54CD\u5E94\u88AB\u4E22\u5F03\u3002\u60A8\u53EF\u4EE5\u4F7F\u7528\u8BE5<code>value</code>\u5B57\u6BB5\u4E0B\u7684<code>mirrorPercentage</code>\u5B57\u6BB5\u6765\u955C\u50CF\u4E00\u90E8\u5206\u6D41\u91CF\uFF0C\u800C\u4E0D\u662F\u955C\u50CF\u6240\u6709\u8BF7\u6C42\u3002\u5982\u679C\u6CA1\u6709\u8FD9\u4E2A\u5B57\u6BB5\uFF0C\u6240\u6709\u7684\u6D41\u91CF\u90FD\u4F1A\u88AB\u955C\u50CF\u3002</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> httpbin
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>
    <span class="token key atrule">mirror</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
      <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">mirrorPercentage</span><span class="token punctuation">:</span>
      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">100.0</span>
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u53D1\u9001\u6D41\u91CF" tabindex="-1"><a class="header-anchor" href="#\u53D1\u9001\u6D41\u91CF" aria-hidden="true">#</a> \u53D1\u9001\u6D41\u91CF</h4><p>\u901A\u8FC7\u53D1\u9001\u6D41\u91CF\u518D\u6B21\u8FDB\u884C\u6D4B\u8BD5\uFF0C\u60C5\u51B5\u5982\u4E0B\uFF1A</p><ul><li><code>v1</code>\u73B0\u5728\uFF0C\u60A8\u5E94\u8BE5\u4F1A\u770B\u5230\u548C\u7684\u8BBF\u95EE\u8BB0\u5F55</li><li><code>v2</code>\u4E2D\u521B\u5EFA\u7684\u8BBF\u95EE\u65E5\u5FD7<code>v2</code>\u662F\u5B9E\u9645\u5C06\u8981\u8BBF\u95EE\u7684\u955C\u50CF\u8BF7\u6C42<code>v1</code>\u3002</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-work<span class="token punctuation">]</span><span class="token comment"># kubectl exec &quot;\${SLEEP_POD}&quot; -c sleep -- curl -sS http://httpbin:8000/headers</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;headers&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;Accept&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;*/*&quot;</span>,
    <span class="token string">&quot;Host&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;httpbin:8000&quot;</span>,
    <span class="token string">&quot;User-Agent&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>,
    <span class="token string">&quot;X-B3-Parentspanid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;a422ba4aefe02440&quot;</span>,
    <span class="token string">&quot;X-B3-Sampled&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1&quot;</span>,
    <span class="token string">&quot;X-B3-Spanid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;acd7163f70c9aa89&quot;</span>,
    <span class="token string">&quot;X-B3-Traceid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;f7ca9fb1e0581d6ba422ba4aefe02440&quot;</span>,
    <span class="token string">&quot;X-Envoy-Attempt-Count&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1&quot;</span>,
    <span class="token string">&quot;X-Forwarded-Client-Cert&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;By=spiffe://cluster.local/ns/default/sa/default;Hash=ab53dec650eb79f2aa9dc051ed27a2b4b698ee40ffd557cd885495105916a139;Subject=<span class="token entity" title="\\&quot;">\\&quot;</span><span class="token entity" title="\\&quot;">\\&quot;</span>;URI=spiffe://cluster.local/ns/default/sa/default&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">[</span>root@k8s-master-node1 istio-work<span class="token punctuation">]</span><span class="token comment"># kubectl logs &quot;$V1_POD&quot; -c httpbin</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Starting gunicorn <span class="token number">19.9</span>.0
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Listening at: http://0.0.0.0:80 <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Using worker: <span class="token function">sync</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Booting worker with pid: <span class="token number">9</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:30:43 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">529</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:33:03 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">529</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:33:48 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">529</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:33:52 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">529</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:34:05 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">529</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>


<span class="token punctuation">[</span>root@k8s-master-node1 istio-work<span class="token punctuation">]</span><span class="token comment"># kubectl logs &quot;$V2_POD&quot; -c httpbin</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Starting gunicorn <span class="token number">19.9</span>.0
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Listening at: http://0.0.0.0:80 <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Using worker: <span class="token function">sync</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Booting worker with pid: <span class="token number">10</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:33:03 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">569</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:33:48 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">569</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:33:52 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">569</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:34:05 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">569</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u6E05\u7406-6" tabindex="-1"><a class="header-anchor" href="#\u6E05\u7406-6" aria-hidden="true">#</a> \u6E05\u7406</h4><p>\u5220\u9664\u89C4\u5219\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete virtualservice httpbin
$ kubectl delete destinationrule httpbin
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div>`,30),jn={href:"https://github.com/istio/istio/tree/release-1.13/samples/httpbin",target:"_blank",rel:"noopener noreferrer"},Fn=t(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete deploy httpbin-v1 httpbin-v2 <span class="token function">sleep</span>
$ kubectl delete svc httpbin
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u5165\u53E3\u7F51\u5173" tabindex="-1"><a class="header-anchor" href="#\u5165\u53E3\u7F51\u5173" aria-hidden="true">#</a> \u5165\u53E3\u7F51\u5173</h2><h4 id="\u5165\u53E3\u7F51\u5173\u7B80\u8981" tabindex="-1"><a class="header-anchor" href="#\u5165\u53E3\u7F51\u5173\u7B80\u8981" aria-hidden="true">#</a> \u5165\u53E3\u7F51\u5173\u7B80\u8981</h4>`,3),Bn={href:"https://istio.io/latest/docs/tasks/traffic-management/ingress/kubernetes-ingress/",target:"_blank",rel:"noopener noreferrer"},zn={href:"https://istio.io/latest/docs/reference/config/networking/gateway/",target:"_blank",rel:"noopener noreferrer"},Xn=n("code",null,"Gateway",-1),Wn=n("code",null,"Ingress",-1),Kn=n("p",null,[s("\u6B64\u4EFB\u52A1\u63CF\u8FF0\u4E86\u5982\u4F55\u914D\u7F6E Istio \u4EE5\u4F7F\u7528 Istio \u5728\u670D\u52A1\u7F51\u683C\u4E4B\u5916\u516C\u5F00\u670D\u52A1"),n("code",null,"Gateway"),s("\u3002")],-1),Zn=n("h4",{id:"\u73AF\u5883\u51C6\u5907-5",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#\u73AF\u5883\u51C6\u5907-5","aria-hidden":"true"},"#"),s(" \u73AF\u5883\u51C6\u5907")],-1),Yn=n("li",null,[s("\u786E\u4FDD\u60A8\u7684\u5F53\u524D\u76EE\u5F55\u662F\u8BE5"),n("code",null,"istio"),s("\u76EE\u5F55\u3002")],-1),Jn={href:"https://github.com/istio/istio/tree/release-1.13/samples/httpbin",target:"_blank",rel:"noopener noreferrer"},Qn={href:"https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection",target:"_blank",rel:"noopener noreferrer"},ns=n("code",null,"httpbin",-1),ss=t(`<p>\u200B \u5426\u5219\uFF0C\u60A8\u5FC5\u987B\u5728\u90E8\u7F72\u5E94\u7528\u7A0B\u5E8F\u4E4B\u524D\u624B\u52A8\u6CE8\u5165 sidecar <code>httpbin</code>\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/httpbin/httpbin.yaml
$ kubectl apply <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject <span class="token parameter variable">-f</span> samples/httpbin/httpbin.yaml<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u786E\u5B9A\u5165\u53E3ip\u548C\u7AEF\u53E3" tabindex="-1"><a class="header-anchor" href="#\u786E\u5B9A\u5165\u53E3ip\u548C\u7AEF\u53E3" aria-hidden="true">#</a> \u786E\u5B9A\u5165\u53E3IP\u548C\u7AEF\u53E3</h4><p>\u6267\u884C\u4EE5\u4E0B\u547D\u4EE4\u6765\u786E\u5B9A\u60A8\u7684 Kubernetes \u96C6\u7FA4\u662F\u5426\u5728\u652F\u6301\u5916\u90E8\u8D1F\u8F7D\u5747\u8861\u5668\u7684\u73AF\u5883\u4E2D\u8FD0\u884C\uFF08<code>\u8FD9\u91CC\u6CA1\u6709\u8D1F\u8F7D\u5747\u8861\u5668\u6539\u4E3ANodePort\u6A21\u5F0F</code>\uFF09\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -n istio-system istio-ingressgateway</span>
NAME                   TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>                                                                    AGE
istio-ingressgateway   NodePort   <span class="token number">10.96</span>.88.217   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">15021</span>:28214/TCP,80:27007/TCP,443:9673/TCP,31400:3938/TCP,15443:41053/TCP   4d2h
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,5),as=n("code",null,"EXTERNAL-IP",-1),es=n("code",null,"EXTERNAL-IP",-1),ts=n("code",null,"<none>",-1),ps=n("code",null,"<pending>",-1),ls={href:"https://kubernetes.io/docs/concepts/services-networking/service/#nodeport",target:"_blank",rel:"noopener noreferrer"},is=t(`<h4 id="\u6DFB\u52A0\u73AF\u5883\u8BF4\u660E" tabindex="-1"><a class="header-anchor" href="#\u6DFB\u52A0\u73AF\u5883\u8BF4\u660E" aria-hidden="true">#</a> \u6DFB\u52A0\u73AF\u5883\u8BF4\u660E</h4><p>\u5982\u679C\u60A8\u786E\u5B9A\u60A8\u7684\u73AF\u5883\u6CA1\u6709\u5916\u90E8\u8D1F\u8F7D\u5747\u8861\u5668\uFF0C\u8BF7\u6309\u7167\u8FD9\u4E9B\u8BF4\u660E\u8FDB\u884C\u64CD\u4F5C\uFF0C\u56E0\u6B64\u60A8\u9700\u8981\u6539\u7528\u8282\u70B9\u7AEF\u53E3\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.spec.ports[?(@.name==&quot;http2&quot;)].nodePort}&#39;</span><span class="token variable">)</span></span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">SECURE_INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.spec.ports[?(@.name==&quot;https&quot;)].nodePort}&#39;</span><span class="token variable">)</span></span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">TCP_INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.spec.ports[?(@.name==&quot;tcp&quot;)].nodePort}&#39;</span><span class="token variable">)</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062328622.png" alt="image-20220318172145022" loading="lazy"></p><h4 id="\u4F7F\u7528istio\u7F51\u5173\u914D\u7F6E\u5165\u53E3" tabindex="-1"><a class="header-anchor" href="#\u4F7F\u7528istio\u7F51\u5173\u914D\u7F6E\u5165\u53E3" aria-hidden="true">#</a> \u4F7F\u7528Istio\u7F51\u5173\u914D\u7F6E\u5165\u53E3</h4>`,5),os={href:"https://istio.io/latest/docs/reference/config/networking/gateway/",target:"_blank",rel:"noopener noreferrer"},cs={href:"https://kubernetes.io/docs/concepts/services-networking/ingress/",target:"_blank",rel:"noopener noreferrer"},us=t(`<p>\u8BA9\u6211\u4EEC\u770B\u770B\u5982\u4F55<code>Gateway</code>\u4E3A HTTP \u6D41\u91CF\u914D\u7F6E\u7AEF\u53E3 80\u3002</p><ol><li>\u521B\u5EFA\u4E00\u4E2A Istio <code>Gateway</code>\uFF1A <ul><li><code>\u4F7F\u7528\u9ED8\u8BA4\u7684ingressgateway\u7F51\u5173</code></li><li><code>\u521B\u5EFA\u4E00\u4E2A\u670D\u52A1\u5668\u89C4\u8303\u5217\u8868\uFF0C\u5206\u522B\u662F\u4E3B\u673A\u548C\u7AEF\u53E3</code></li><li><code>\u914D\u7F6Ehttp\u670D\u52A1\u768480\u7AEF\u53E3\u4EE5\u53CA\u4E3B\u673Ahttpbin.example.com</code></li></ul></li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin<span class="token punctuation">-</span>gateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway <span class="token comment"># use Istio default gateway implementation</span>
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;httpbin.example.com&quot;</span>
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>\u4E3A\u901A\u8FC7\u4EE5\u4E0B\u65B9\u5F0F\u8FDB\u5165\u7684\u6D41\u91CF\u914D\u7F6E\u8DEF\u7531<code>Gateway</code>\uFF1A <ul><li><code>\u914D\u7F6E\u865A\u62DF\u670D\u52A1\u5141\u8BB8\u4E3B\u673Ahttpbin.example.com</code></li><li><code>\u914D\u8FFDhttp\u7684\u89C4\u5219\u4E3A\u4E24\u4E2Auri\u7684\u4E24\u4E2A\u5141\u8BB8\u8DEF\u5F84\u3001\u5206\u522B\u662Fstatus\u548Cdelay</code></li><li><code>\u914D\u7F6E\u76EE\u7684\u5730\u89C4\u5219\u4E3A\u4E3B\u673A\u662Fhttpbin\u7AEF\u53E3\u4E3A8080\u7684</code></li><li><code>\u7F51\u5173\u5217\u8868\u6307\u5B9A\u53EA\u5141\u8BB8\u901A\u8FC7\u60A8\u7684\u8BF7\u6C42httpbin-gateway\u3002\u6240\u6709\u5176\u4ED6\u5916\u90E8\u8BF7\u6C42\u90FD\u5C06\u88AB 404 \u54CD\u5E94\u62D2\u7EDD\u3002</code></li></ul></li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;httpbin.example.com&quot;</span>
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> httpbin<span class="token punctuation">-</span>gateway
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /status
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /delay
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">8000</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>\u6CE8\u610F\uFF1A</p><p>\u7F51\u683C\u4E2D\u5176\u4ED6\u670D\u52A1\u7684\u5185\u90E8\u8BF7\u6C42\u4E0D\u53D7\u8FD9\u4E9B\u89C4\u5219\u7684\u7EA6\u675F\uFF0C\u800C\u662F\u9ED8\u8BA4\u4F7F\u7528\u5FAA\u73AF\u8DEF\u7531\u3002\u8981\u5C06\u8FD9\u4E9B\u89C4\u5219\u4E5F\u5E94\u7528\u4E8E\u5185\u90E8\u8C03\u7528\uFF0C\u60A8\u53EF\u4EE5\u5C06\u7279\u6B8A\u503C\u6DFB\u52A0<code>mesh</code>\u5230<code>gateways</code>. \u7531\u4E8E\u670D\u52A1\u7684\u5185\u90E8\u4E3B\u673A\u540D\u53EF\u80FD\u4E0E\u5916\u90E8\u4E3B\u673A\u540D\u4E0D\u540C\uFF08\u4F8B\u5982\uFF0C<code>httpbin.default.svc.cluster.local</code>\uFF09\uFF0C\u56E0\u6B64\u60A8\u8FD8\u9700\u8981\u5C06\u5176\u6DFB\u52A0\u5230<code>hosts</code>\u5217\u8868\u4E2D\u3002</p></blockquote><ol start="3"><li><em>\u4F7F\u7528curl</em>\u8BBF\u95EE<em>httpbin</em>\u670D\u52A1\uFF1A</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 ~<span class="token punctuation">]</span><span class="token comment"># curl -s -I -HHost:httpbin.example.com &quot;http://$INGRESS_HOST:$INGRESS_PORT/status/200&quot;</span>
HTTP/1.1 <span class="token number">200</span> OK
server: istio-envoy
date: Sun, <span class="token number">20</span> Mar <span class="token number">2022</span> <span class="token number">14</span>:05:09 GMT
content-type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
access-control-allow-origin: *
access-control-allow-credentials: <span class="token boolean">true</span>
content-length: <span class="token number">0</span>
x-envoy-upstream-service-time: <span class="token number">24</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,8),rs=n("code",null,"-H",-1),ds=n("em",null,"Host",-1),ks={href:"http://httpbin.example.com",target:"_blank",rel:"noopener noreferrer"},vs=n("code",null,"Gateway",-1),ms={href:"http://httpbin.example.com",target:"_blank",rel:"noopener noreferrer"},bs=t(`<ol start="4"><li>\u8BBF\u95EE\u5C1A\u672A\u660E\u786E\u516C\u5F00\u7684\u4EFB\u4F55\u5176\u4ED6 URL\u3002\u60A8\u5E94\u8BE5\u4F1A\u770B\u5230 HTTP 404 \u9519\u8BEF\uFF1A</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 ~<span class="token punctuation">]</span><span class="token comment"># curl -s -I -HHost:httpbin.example.com &quot;http://$INGRESS_HOST:$INGRESS_PORT/headers&quot;</span>
HTTP/1.1 <span class="token number">404</span> Not Found
date: Sun, <span class="token number">20</span> Mar <span class="token number">2022</span> <span class="token number">14</span>:29:26 GMT
server: istio-envoy
transfer-encoding: chunked
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u4F7F\u7528\u6D4F\u89C8\u5668\u8BBF\u95EE\u5165\u53E3\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#\u4F7F\u7528\u6D4F\u89C8\u5668\u8BBF\u95EE\u5165\u53E3\u670D\u52A1" aria-hidden="true">#</a> \u4F7F\u7528\u6D4F\u89C8\u5668\u8BBF\u95EE\u5165\u53E3\u670D\u52A1</h4><p>\u5728\u6D4F\u89C8\u5668\u4E2D\u8F93\u5165<code>httpbin</code>\u670D\u52A1 URL \u5C06\u4E0D\u8D77\u4F5C\u7528\uFF0C\u56E0\u4E3A\u60A8\u65E0\u6CD5\u5C06<em>Host</em>\u6807\u5934\u4F20\u9012\u7ED9\u6D4F\u89C8\u5668\uFF0C\u5C31\u50CF\u4F7F\u7528<code>curl</code>. \u5728\u73B0\u5B9E\u4E16\u754C\u7684\u60C5\u51B5\u4E0B\uFF0C\u8FD9\u4E0D\u662F\u95EE\u9898\uFF0C\u56E0\u4E3A\u60A8\u6B63\u786E\u914D\u7F6E\u4E86\u8BF7\u6C42\u7684\u4E3B\u673A\u5E76\u4E14 DNS \u53EF\u89E3\u6790\u3002\u56E0\u6B64\uFF0C\u60A8\u5728 URL \u4E2D\u4F7F\u7528\u4E3B\u673A\u7684\u57DF\u540D\uFF0C\u4F8B\u5982<code>https://httpbin.example.com/status/200</code>.</p><p>\u8981\u4E3A\u7B80\u5355\u7684\u6D4B\u8BD5\u548C\u6F14\u793A\u89E3\u51B3\u6B64\u95EE\u9898\uFF0C\u8BF7\u5728 \u548C\u914D\u7F6E<code>*</code>\u4E2D\u4E3A\u4E3B\u673A\u4F7F\u7528\u901A\u914D\u7B26\u503C\u3002\u4F8B\u5982\uFF0C\u5982\u679C\u60A8\u5C06\u5165\u53E3\u914D\u7F6E\u66F4\u6539\u4E3A\u4EE5\u4E0B\u5185\u5BB9\uFF1A<code>Gateway VirtualService</code></p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin<span class="token punctuation">-</span>gateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway <span class="token comment"># use Istio default gateway implementation</span>
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> httpbin<span class="token punctuation">-</span>gateway
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /headers
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">8000</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728\u672C\u673A\u7684hosts<code>\u914D\u7F6E192.168.1.6:44526/headers httpbin.example.com</code>\u6620\u5C04\uFF0C\u7136\u540E\u901A\u8FC7\u6D4F\u89C8\u5668\u8BBF\u95EE\u3002</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062328976.png" alt="image-20220320230630481" loading="lazy"></p><h4 id="\u6E05\u7406-7" tabindex="-1"><a class="header-anchor" href="#\u6E05\u7406-7" aria-hidden="true">#</a> \u6E05\u7406</h4>`,9),hs=n("code",null,"Gateway",-1),gs=n("code",null,"VirtualService",-1),ys={href:"https://github.com/istio/istio/tree/release-1.13/samples/httpbin",target:"_blank",rel:"noopener noreferrer"},fs=t(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete gateway httpbin-gateway
$ kubectl delete virtualservice httpbin
$ kubectl delete --ignore-not-found<span class="token operator">=</span>true <span class="token parameter variable">-f</span> samples/httpbin/httpbin.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u5B89\u5168\u7F51\u5173" tabindex="-1"><a class="header-anchor" href="#\u5B89\u5168\u7F51\u5173" aria-hidden="true">#</a> \u5B89\u5168\u7F51\u5173</h2><h4 id="\u5B89\u5168\u7F51\u5173\u7684\u4F5C\u7528" tabindex="-1"><a class="header-anchor" href="#\u5B89\u5168\u7F51\u5173\u7684\u4F5C\u7528" aria-hidden="true">#</a> \u5B89\u5168\u7F51\u5173\u7684\u4F5C\u7528</h4>`,3),_s={href:"https://istio.io/latest/docs/tasks/traffic-management/ingress/ingress-control",target:"_blank",rel:"noopener noreferrer"},xs=n("h4",{id:"\u73AF\u5883\u51C6\u5907-6",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#\u73AF\u5883\u51C6\u5907-6","aria-hidden":"true"},"#"),s(" \u73AF\u5883\u51C6\u5907")],-1),Ts=n("li",null,[s("\u786E\u4FDD\u60A8\u7684\u5F53\u524D\u76EE\u5F55\u662F\u8BE5"),n("code",null,"istio"),s("\u76EE\u5F55\u3002")],-1),qs={href:"https://github.com/istio/istio/tree/release-1.13/samples/httpbin",target:"_blank",rel:"noopener noreferrer"},ws={href:"https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection",target:"_blank",rel:"noopener noreferrer"},Ss=n("code",null,"httpbin",-1),Ps=t(`<p>\u200B \u5426\u5219\uFF0C\u60A8\u5FC5\u987B\u5728\u90E8\u7F72\u5E94\u7528\u7A0B\u5E8F\u4E4B\u524D\u624B\u52A8\u6CE8\u5165 sidecar <code>httpbin</code>\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/httpbin/httpbin.yaml
$ kubectl apply <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject <span class="token parameter variable">-f</span> samples/httpbin/httpbin.yaml<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u751F\u6210\u8BC1\u4E66\u548C\u5BC6\u94A5" tabindex="-1"><a class="header-anchor" href="#\u751F\u6210\u8BC1\u4E66\u548C\u5BC6\u94A5" aria-hidden="true">#</a> \u751F\u6210\u8BC1\u4E66\u548C\u5BC6\u94A5</h4>`,3),Is={href:"https://man.openbsd.org/openssl.1",target:"_blank",rel:"noopener noreferrer"},Es=t(`<ol><li>\u521B\u5EFA\u6839\u8BC1\u4E66\u548C\u79C1\u94A5\u6765\u4E3A\u60A8\u7684\u670D\u52A1\u7B7E\u7F72\u8BC1\u4E66\uFF1A</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ openssl req <span class="token parameter variable">-x509</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-days</span> <span class="token number">365</span> <span class="token parameter variable">-newkey</span> rsa:2048 <span class="token parameter variable">-subj</span> <span class="token string">&#39;/O=example Inc./CN=example.com&#39;</span> <span class="token parameter variable">-keyout</span> example.com.key <span class="token parameter variable">-out</span> example.com.crt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="2"><li>\u521B\u5EFA\u8BC1\u4E66\u548C\u79C1\u94A5<code>httpbin.example.com</code>\uFF1A</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ openssl req <span class="token parameter variable">-out</span> httpbin.example.com.csr <span class="token parameter variable">-newkey</span> rsa:2048 <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-keyout</span> httpbin.example.com.key <span class="token parameter variable">-subj</span> <span class="token string">&quot;/CN=httpbin.example.com/O=httpbin organization&quot;</span>
$ openssl x509 <span class="token parameter variable">-req</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-days</span> <span class="token number">365</span> <span class="token parameter variable">-CA</span> example.com.crt <span class="token parameter variable">-CAkey</span> example.com.key <span class="token parameter variable">-set_serial</span> <span class="token number">0</span> <span class="token parameter variable">-in</span> httpbin.example.com.csr <span class="token parameter variable">-out</span> httpbin.example.com.crt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u4E3A\u5355\u4E2A\u4E3B\u673A\u914D\u7F6Etls\u5165\u53E3\u7F51\u5173" tabindex="-1"><a class="header-anchor" href="#\u4E3A\u5355\u4E2A\u4E3B\u673A\u914D\u7F6Etls\u5165\u53E3\u7F51\u5173" aria-hidden="true">#</a> \u4E3A\u5355\u4E2A\u4E3B\u673A\u914D\u7F6ETLS\u5165\u53E3\u7F51\u5173</h4><ol><li>\u4E3A\u5165\u53E3\u7F51\u5173\u521B\u5EFA\u4E00\u4E2A\u5BC6\u94A5\uFF1A</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl create <span class="token parameter variable">-n</span> istio-system secret tls httpbin-credential <span class="token parameter variable">--key</span><span class="token operator">=</span>httpbin.example.com.key <span class="token parameter variable">--cert</span><span class="token operator">=</span>httpbin.example.com.crt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="2"><li>\u4F7F\u7528\u7AEF\u53E3 443\u7684\u90E8\u5206\u5B9A\u4E49\u7F51\u5173<code>servers:</code>\uFF0C\u5E76\u6307\u5B9A <code>credentialName</code>to be\u7684\u503C<code>httpbin-credential</code>\u3002\u8FD9\u4E9B\u503C\u4E0E\u5BC6\u94A5\u7684\u540D\u79F0\u76F8\u540C\u3002TLS \u6A21\u5F0F\u7684\u503C\u5E94\u4E3A<code>SIMPLE</code>.</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ cat &lt;&lt;EOF <span class="token punctuation">|</span> kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mygateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway <span class="token comment"># use istio default ingress gateway</span>
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> https
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE
      <span class="token key atrule">credentialName</span><span class="token punctuation">:</span> httpbin<span class="token punctuation">-</span>credential <span class="token comment"># must be the same as secret</span>
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> httpbin.example.com
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>\u914D\u7F6E\u7F51\u5173\u7684\u5165\u53E3\u6D41\u91CF\u8DEF\u7531\u3002\u5B9A\u4E49\u76F8\u5E94\u7684\u865A\u62DF\u670D\u52A1\u3002</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ cat &lt;&lt;EOF <span class="token punctuation">|</span> kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;httpbin.example.com&quot;</span>
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> mygateway
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /status
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /delay
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">8000</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,11),$s={start:"4"},Cs=n("code",null,"httpbin",-1),Hs=n("code",null,"httpbin",-1),Ns={href:"https://tools.ietf.org/html/rfc7168#section-2.3.3",target:"_blank",rel:"noopener noreferrer"},Os=t(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-HHost:httpbin.example.com</span> <span class="token parameter variable">--resolve</span> <span class="token string">&quot;httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>:<span class="token variable">$INGRESS_HOST</span>&quot;</span> <span class="token parameter variable">--cacert</span> example.com.crt <span class="token string">&quot;https://httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>/status/418&quot;</span>
* Added httpbin.example.com:7339:192.168.1.6 to DNS cache
* About to connect<span class="token punctuation">(</span><span class="token punctuation">)</span> to httpbin.example.com port <span class="token number">7339</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
*   Trying <span class="token number">192.168</span>.1.6<span class="token punctuation">..</span>.
* Connected to httpbin.example.com <span class="token punctuation">(</span><span class="token number">192.168</span>.1.6<span class="token punctuation">)</span> port <span class="token number">7339</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
* Initializing NSS with certpath: sql:/etc/pki/nssdb
*   CAfile: example.com.crt
  CApath: none
* SSL connection using TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
* Server certificate:
*       subject: <span class="token assign-left variable">O</span><span class="token operator">=</span>httpbin organization,CN<span class="token operator">=</span>httpbin.example.com
*       start date: Mar <span class="token number">20</span> <span class="token number">15</span>:18:42 <span class="token number">2022</span> GMT
*       expire date: Mar <span class="token number">20</span> <span class="token number">15</span>:18:42 <span class="token number">2023</span> GMT
*       common name: httpbin.example.com
*       issuer: <span class="token assign-left variable">CN</span><span class="token operator">=</span>example.com,O<span class="token operator">=</span>example Inc.
<span class="token operator">&gt;</span> GET /status/418 HTTP/1.1
<span class="token operator">&gt;</span> User-Agent: curl/7.29.0
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span> Host:httpbin.example.com
<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">418</span> Unknown
<span class="token operator">&lt;</span> server: istio-envoy
<span class="token operator">&lt;</span> date: Sun, <span class="token number">20</span> Mar <span class="token number">2022</span> <span class="token number">15</span>:41:25 GMT
<span class="token operator">&lt;</span> x-more-info: http://tools.ietf.org/html/rfc2324
<span class="token operator">&lt;</span> access-control-allow-origin: *
<span class="token operator">&lt;</span> access-control-allow-credentials: <span class="token boolean">true</span>
<span class="token operator">&lt;</span> content-length: <span class="token number">135</span>
<span class="token operator">&lt;</span> x-envoy-upstream-service-time: <span class="token number">23</span>
<span class="token operator">&lt;</span>

    -<span class="token operator">=</span><span class="token punctuation">[</span> teapot <span class="token punctuation">]</span><span class="token operator">=</span>-

       _<span class="token punctuation">..</span><span class="token punctuation">..</span>_
     .&#39;  _ _ <span class="token variable"><span class="token variable">\`</span><span class="token builtin class-name">.</span>
    <span class="token operator">|</span> .&quot;<span class="token variable">\`</span></span> ^ <span class="token variable"><span class="token variable">\`</span>&quot;. _,
    <span class="token punctuation">\\</span>_<span class="token punctuation">;</span><span class="token variable">\`</span></span><span class="token string">&quot;---&quot;</span><span class="token variable"><span class="token variable">\`</span><span class="token operator">|</span>//
      <span class="token operator">|</span>       <span class="token punctuation">;</span>/
      <span class="token punctuation">\\</span>_     _/
        <span class="token variable">\`</span></span><span class="token string">&quot;&quot;</span>&quot;\`
* Connection <span class="token comment">#0 to host httpbin.example.com left intact</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li>\u5220\u9664\u7F51\u5173\u7684\u5BC6\u7801\u5E76\u521B\u5EFA\u4E00\u4E2A\u65B0\u5BC6\u7801\u4EE5\u66F4\u6539\u5165\u53E3\u7F51\u5173\u7684\u51ED\u636E\u3002</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token parameter variable">-n</span> istio-system delete secret httpbin-credential
$ <span class="token function">mkdir</span> new_certificates
$ openssl req <span class="token parameter variable">-x509</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-days</span> <span class="token number">365</span> <span class="token parameter variable">-newkey</span> rsa:2048 <span class="token parameter variable">-subj</span> <span class="token string">&#39;/O=example Inc./CN=example.com&#39;</span> <span class="token parameter variable">-keyout</span> new_certificates/example.com.key <span class="token parameter variable">-out</span> new_certificates/example.com.crt
$ openssl req <span class="token parameter variable">-out</span> new_certificates/httpbin.example.com.csr <span class="token parameter variable">-newkey</span> rsa:2048 <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-keyout</span> new_certificates/httpbin.example.com.key <span class="token parameter variable">-subj</span> <span class="token string">&quot;/CN=httpbin.example.com/O=httpbin organization&quot;</span>
$ openssl x509 <span class="token parameter variable">-req</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-days</span> <span class="token number">365</span> <span class="token parameter variable">-CA</span> new_certificates/example.com.crt <span class="token parameter variable">-CAkey</span> new_certificates/example.com.key <span class="token parameter variable">-set_serial</span> <span class="token number">0</span> <span class="token parameter variable">-in</span> new_certificates/httpbin.example.com.csr <span class="token parameter variable">-out</span> new_certificates/httpbin.example.com.crt
$ kubectl create <span class="token parameter variable">-n</span> istio-system secret tls httpbin-credential <span class="token punctuation">\\</span>
<span class="token parameter variable">--key</span><span class="token operator">=</span>new_certificates/httpbin.example.com.key <span class="token punctuation">\\</span>
<span class="token parameter variable">--cert</span><span class="token operator">=</span>new_certificates/httpbin.example.com.crt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="6"><li>\u4F7F\u7528\u65B0\u7684\u8BC1\u4E66\u94FE\u8BBF\u95EE<code>httpbin</code>\u670D\u52A1\uFF1A<code>curl</code></li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-HHost:httpbin.example.com</span> <span class="token parameter variable">--resolve</span> <span class="token string">&quot;httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>:<span class="token variable">$INGRESS_HOST</span>&quot;</span> <span class="token punctuation">\\</span>
<span class="token parameter variable">--cacert</span> new_certificates/example.com.crt <span class="token string">&quot;https://httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>/status/418&quot;</span>
<span class="token punctuation">..</span>.
HTTP/2 <span class="token number">418</span>
<span class="token punctuation">..</span>.
    -<span class="token operator">=</span><span class="token punctuation">[</span> teapot <span class="token punctuation">]</span><span class="token operator">=</span>-

       _<span class="token punctuation">..</span><span class="token punctuation">..</span>_
     .&#39;  _ _ <span class="token variable"><span class="token variable">\`</span><span class="token builtin class-name">.</span>
    <span class="token operator">|</span> .&quot;<span class="token variable">\`</span></span> ^ <span class="token variable"><span class="token variable">\`</span>&quot;. _,
    <span class="token punctuation">\\</span>_<span class="token punctuation">;</span><span class="token variable">\`</span></span><span class="token string">&quot;---&quot;</span><span class="token variable"><span class="token variable">\`</span><span class="token operator">|</span>//
      <span class="token operator">|</span>       <span class="token punctuation">;</span>/
      <span class="token punctuation">\\</span>_     _/
        <span class="token variable">\`</span></span><span class="token string">&quot;&quot;</span>&quot;\`
        
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="7"><li>\u5982\u679C\u60A8\u5C1D\u8BD5\u4F7F\u7528<code>httpbin</code>\u4EE5\u524D\u7684\u8BC1\u4E66\u94FE\u8FDB\u884C\u8BBF\u95EE\uFF0C\u5219\u73B0\u5728\u5C1D\u8BD5\u5931\u8D25\u3002</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-HHost:httpbin.example.com</span> <span class="token parameter variable">--resolve</span> <span class="token string">&quot;httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>:<span class="token variable">$INGRESS_HOST</span>&quot;</span> <span class="token punctuation">\\</span>
<span class="token parameter variable">--cacert</span> example.com.crt <span class="token string">&quot;https://httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>/status/418&quot;</span>
<span class="token punctuation">..</span>.
* TLSv1.2 <span class="token punctuation">(</span>OUT<span class="token punctuation">)</span>, TLS handshake, Client hello <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>:
* TLSv1.2 <span class="token punctuation">(</span>IN<span class="token punctuation">)</span>, TLS handshake, Server hello <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>:
* TLSv1.2 <span class="token punctuation">(</span>IN<span class="token punctuation">)</span>, TLS handshake, Certificate <span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>:
* TLSv1.2 <span class="token punctuation">(</span>OUT<span class="token punctuation">)</span>, TLS alert, Server hello <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>:
* curl: <span class="token punctuation">(</span><span class="token number">35</span><span class="token punctuation">)</span> error:04FFF06A:rsa routines:CRYPTO_internal:block <span class="token builtin class-name">type</span> is not 01
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u4E3A\u591A\u4E2A\u4E3B\u673A\u914D\u7F6Etls\u5165\u53E3\u7F51\u5173" tabindex="-1"><a class="header-anchor" href="#\u4E3A\u591A\u4E2A\u4E3B\u673A\u914D\u7F6Etls\u5165\u53E3\u7F51\u5173" aria-hidden="true">#</a> \u4E3A\u591A\u4E2A\u4E3B\u673A\u914D\u7F6ETLS\u5165\u53E3\u7F51\u5173</h4><p>\u60A8\u53EF\u4EE5\u4E3A\u591A\u4E2A\u4E3B\u673A\u914D\u7F6E\u4E00\u4E2A\u5165\u53E3\u7F51\u5173 <code>httpbin.example.com</code>\uFF0C<code>helloworld-v1.example.com</code>\u4F8B\u5982\u3002\u5165\u53E3\u7F51\u5173\u68C0\u7D22\u4E0E\u7279\u5B9A<code>credentialName</code>.</p><ol><li>\u8981\u6062\u590D \u7684\u51ED\u636E<code>httpbin</code>\uFF0C\u8BF7\u5220\u9664\u5176\u5BC6\u94A5\u5E76\u91CD\u65B0\u521B\u5EFA\u3002</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token parameter variable">-n</span> istio-system delete secret httpbin-credential
$ kubectl create <span class="token parameter variable">-n</span> istio-system secret tls httpbin-credential <span class="token punctuation">\\</span>
<span class="token parameter variable">--key</span><span class="token operator">=</span>httpbin.example.com.key <span class="token punctuation">\\</span>
<span class="token parameter variable">--cert</span><span class="token operator">=</span>httpbin.example.com.crt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>\u542F\u52A8<code>helloworld-v1</code>\u793A\u4F8B</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ cat &lt;&lt;EOF <span class="token punctuation">|</span> kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5000</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
        <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> helloworld
        <span class="token key atrule">image</span><span class="token punctuation">:</span> istio/examples<span class="token punctuation">-</span>helloworld<span class="token punctuation">-</span>v1
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;100m&quot;</span>
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent <span class="token comment">#Always</span>
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">5000</span>
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>\u751F\u6210\u8BC1\u4E66\u548C\u79C1\u94A5<code>helloworld-v1.example.com</code>\uFF1A</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ openssl req <span class="token parameter variable">-out</span> helloworld-v1.example.com.csr <span class="token parameter variable">-newkey</span> rsa:2048 <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-keyout</span> helloworld-v1.example.com.key <span class="token parameter variable">-subj</span> <span class="token string">&quot;/CN=helloworld-v1.example.com/O=helloworld organization&quot;</span>
$ openssl x509 <span class="token parameter variable">-req</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-days</span> <span class="token number">365</span> <span class="token parameter variable">-CA</span> example.com.crt <span class="token parameter variable">-CAkey</span> example.com.key <span class="token parameter variable">-set_serial</span> <span class="token number">1</span> <span class="token parameter variable">-in</span> helloworld-v1.example.com.csr <span class="token parameter variable">-out</span> helloworld-v1.example.com.crt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>\u521B\u5EFA<code>helloworld-credential</code>\u5BC6\u94A5\uFF1A</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl create <span class="token parameter variable">-n</span> istio-system secret tls helloworld-credential <span class="token parameter variable">--key</span><span class="token operator">=</span>helloworld-v1.example.com.key <span class="token parameter variable">--cert</span><span class="token operator">=</span>helloworld-v1.example.com.crt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="5"><li>\u4E3A\u7AEF\u53E3 443 \u5B9A\u4E49\u4E00\u4E2A\u5177\u6709\u4E24\u4E2A\u670D\u52A1\u5668\u90E8\u5206\u7684\u7F51\u5173\u3002\u5C06 <code>credentialName</code>\u6BCF\u4E2A\u7AEF\u53E3\u4E0A\u7684\u503C\u5206\u522B\u8BBE\u7F6E\u4E3A<code>httpbin-credential</code>\u548C<code>helloworld-credential</code> \u3002 <ul><li>\u5C06 TLS \u6A21\u5F0F\u8BBE\u7F6E\u4E3A<code>SIMPLE</code>\u662F\u5355\u5411TLS\u5165\u53E3\u7F51\u5173.</li><li>\u5C06 TLS \u6A21\u5F0F\u8BBE\u7F6E\u4E3A<code>MUTUAL</code>\u662F\u53CC\u5411TLS\u5165\u53E3\u7F51\u5173</li></ul></li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ cat &lt;&lt;EOF <span class="token punctuation">|</span> kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mygateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway <span class="token comment"># use istio default ingress gateway</span>
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>httpbin
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE
      <span class="token key atrule">credentialName</span><span class="token punctuation">:</span> httpbin<span class="token punctuation">-</span>credential
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> httpbin.example.com
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>helloworld
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE
      <span class="token key atrule">credentialName</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>credential
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> helloworld<span class="token punctuation">-</span>v1.example.com
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="6"><li>\u914D\u7F6E\u7F51\u5173\u7684\u6D41\u91CF\u8DEF\u7531\u3002\u5B9A\u4E49\u76F8\u5E94\u7684\u865A\u62DF\u670D\u52A1\u3002</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ cat &lt;&lt;EOF <span class="token punctuation">|</span> kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> helloworld<span class="token punctuation">-</span>v1.example.com
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> mygateway
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">exact</span><span class="token punctuation">:</span> /hello
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">5000</span>
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="7"><li>\u53D1\u9001 HTTPS \u8BF7\u6C42\u5230<code>helloworld-v1.example.com</code>\uFF1A</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-HHost:httpbin.example.com</span> <span class="token parameter variable">--resolve</span> <span class="token string">&quot;httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>:<span class="token variable">$INGRESS_HOST</span>&quot;</span> <span class="token punctuation">\\</span>
<span class="token operator">&gt;</span> <span class="token parameter variable">--cacert</span> example.com.crt <span class="token string">&quot;https://httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>/status/418&quot;</span>
* Added httpbin.example.com:7339:192.168.1.6 to DNS cache
* About to connect<span class="token punctuation">(</span><span class="token punctuation">)</span> to httpbin.example.com port <span class="token number">7339</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
*   Trying <span class="token number">192.168</span>.1.6<span class="token punctuation">..</span>.
* Connected to httpbin.example.com <span class="token punctuation">(</span><span class="token number">192.168</span>.1.6<span class="token punctuation">)</span> port <span class="token number">7339</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
* Initializing NSS with certpath: sql:/etc/pki/nssdb
*   CAfile: example.com.crt
  CApath: none
* SSL connection using TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
* Server certificate:
*       subject: <span class="token assign-left variable">O</span><span class="token operator">=</span>httpbin organization,CN<span class="token operator">=</span>httpbin.example.com
*       start date: Mar <span class="token number">20</span> <span class="token number">15</span>:18:42 <span class="token number">2022</span> GMT
*       expire date: Mar <span class="token number">20</span> <span class="token number">15</span>:18:42 <span class="token number">2023</span> GMT
*       common name: httpbin.example.com
*       issuer: <span class="token assign-left variable">CN</span><span class="token operator">=</span>example.com,O<span class="token operator">=</span>example Inc.
<span class="token operator">&gt;</span> GET /status/418 HTTP/1.1
<span class="token operator">&gt;</span> User-Agent: curl/7.29.0
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span> Host:httpbin.example.com
<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">418</span> Unknown
<span class="token operator">&lt;</span> server: istio-envoy
<span class="token operator">&lt;</span> date: Mon, <span class="token number">21</span> Mar <span class="token number">2022</span> 00:58:24 GMT
<span class="token operator">&lt;</span> x-more-info: http://tools.ietf.org/html/rfc2324
<span class="token operator">&lt;</span> access-control-allow-origin: *
<span class="token operator">&lt;</span> access-control-allow-credentials: <span class="token boolean">true</span>
<span class="token operator">&lt;</span> content-length: <span class="token number">135</span>
<span class="token operator">&lt;</span> x-envoy-upstream-service-time: <span class="token number">2</span>
<span class="token operator">&lt;</span>

    -<span class="token operator">=</span><span class="token punctuation">[</span> teapot <span class="token punctuation">]</span><span class="token operator">=</span>-

       _<span class="token punctuation">..</span><span class="token punctuation">..</span>_
     .&#39;  _ _ <span class="token variable"><span class="token variable">\`</span><span class="token builtin class-name">.</span>
    <span class="token operator">|</span> .&quot;<span class="token variable">\`</span></span> ^ <span class="token variable"><span class="token variable">\`</span>&quot;. _,
    <span class="token punctuation">\\</span>_<span class="token punctuation">;</span><span class="token variable">\`</span></span><span class="token string">&quot;---&quot;</span><span class="token variable"><span class="token variable">\`</span><span class="token operator">|</span>//
      <span class="token operator">|</span>       <span class="token punctuation">;</span>/
      <span class="token punctuation">\\</span>_     _/
        <span class="token variable">\`</span></span><span class="token string">&quot;&quot;</span>&quot;\`
* Connection <span class="token comment">#0 to host httpbin.example.com left intact</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="8"><li>\u53D1\u9001\u4E00\u4E2A HTTPS \u8BF7\u6C42<code>httpbin.example.com</code>\u5E76\u4ECD\u7136\u5F97\u5230\u4E00\u4E2A\u8336\u58F6\u4F5C\u4E3A\u56DE\u62A5\uFF1A</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-HHost:httpbin.example.com</span> <span class="token parameter variable">--resolve</span> <span class="token string">&quot;httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>:<span class="token variable">$INGRESS_HOST</span>&quot;</span> <span class="token punctuation">\\</span>
<span class="token operator">&gt;</span> <span class="token parameter variable">--cacert</span> example.com.crt <span class="token string">&quot;https://httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>/status/418&quot;</span>
* Added httpbin.example.com:7339:192.168.1.6 to DNS cache
* About to connect<span class="token punctuation">(</span><span class="token punctuation">)</span> to httpbin.example.com port <span class="token number">7339</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
*   Trying <span class="token number">192.168</span>.1.6<span class="token punctuation">..</span>.
* Connected to httpbin.example.com <span class="token punctuation">(</span><span class="token number">192.168</span>.1.6<span class="token punctuation">)</span> port <span class="token number">7339</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
* Initializing NSS with certpath: sql:/etc/pki/nssdb
*   CAfile: example.com.crt
  CApath: none
* SSL connection using TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
* Server certificate:
*       subject: <span class="token assign-left variable">O</span><span class="token operator">=</span>httpbin organization,CN<span class="token operator">=</span>httpbin.example.com
*       start date: Mar <span class="token number">20</span> <span class="token number">15</span>:18:42 <span class="token number">2022</span> GMT
*       expire date: Mar <span class="token number">20</span> <span class="token number">15</span>:18:42 <span class="token number">2023</span> GMT
*       common name: httpbin.example.com
*       issuer: <span class="token assign-left variable">CN</span><span class="token operator">=</span>example.com,O<span class="token operator">=</span>example Inc.
<span class="token operator">&gt;</span> GET /status/418 HTTP/1.1
<span class="token operator">&gt;</span> User-Agent: curl/7.29.0
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span> Host:httpbin.example.com
<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">418</span> Unknown
<span class="token operator">&lt;</span> server: istio-envoy
<span class="token operator">&lt;</span> date: Mon, <span class="token number">21</span> Mar <span class="token number">2022</span> 01:13:48 GMT
<span class="token operator">&lt;</span> x-more-info: http://tools.ietf.org/html/rfc2324
<span class="token operator">&lt;</span> access-control-allow-origin: *
<span class="token operator">&lt;</span> access-control-allow-credentials: <span class="token boolean">true</span>
<span class="token operator">&lt;</span> content-length: <span class="token number">135</span>
<span class="token operator">&lt;</span> x-envoy-upstream-service-time: <span class="token number">3</span>
<span class="token operator">&lt;</span>

    -<span class="token operator">=</span><span class="token punctuation">[</span> teapot <span class="token punctuation">]</span><span class="token operator">=</span>-

       _<span class="token punctuation">..</span><span class="token punctuation">..</span>_
     .&#39;  _ _ <span class="token variable"><span class="token variable">\`</span><span class="token builtin class-name">.</span>
    <span class="token operator">|</span> .&quot;<span class="token variable">\`</span></span> ^ <span class="token variable"><span class="token variable">\`</span>&quot;. _,
    <span class="token punctuation">\\</span>_<span class="token punctuation">;</span><span class="token variable">\`</span></span><span class="token string">&quot;---&quot;</span><span class="token variable"><span class="token variable">\`</span><span class="token operator">|</span>//
      <span class="token operator">|</span>       <span class="token punctuation">;</span>/
      <span class="token punctuation">\\</span>_     _/
        <span class="token variable">\`</span></span><span class="token string">&quot;&quot;</span>&quot;\`
* Connection <span class="token comment">#0 to host httpbin.example.com left intact</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u5BC6\u94A5\u683C\u5F0F" tabindex="-1"><a class="header-anchor" href="#\u5BC6\u94A5\u683C\u5F0F" aria-hidden="true">#</a> \u5BC6\u94A5\u683C\u5F0F</h4>`,26),Rs={href:"https://istio.io/latest/docs/ops/integrations/certmanager/",target:"_blank",rel:"noopener noreferrer"},Ls=t(`<ul><li>\u4E00\u4E2A TLS \u5BC6\u94A5\uFF0C\u5E26\u6709<code>tls.key</code>\u548C<code>tls.crt</code>\uFF0C\u5982\u4E0A\u6240\u8FF0\u3002\u5BF9\u4E8E\u53CC\u5411 TLS\uFF0C<code>ca.crt</code>\u53EF\u4EE5\u4F7F\u7528\u5BC6\u94A5\u3002</li><li>\u5E26\u6709\u952E\u7684\u901A\u7528 Secret<code>key</code>\u548C<code>cert</code>. \u5BF9\u4E8E\u53CC\u5411 TLS\uFF0C<code>cacert</code>\u53EF\u4EE5\u4F7F\u7528\u5BC6\u94A5\u3002</li><li>\u5E26\u6709\u952E\u7684\u901A\u7528 Secret<code>key</code>\u548C<code>cert</code>. \u5BF9\u4E8E\u53CC\u5411 TLS\uFF0C\u4E00\u4E2A\u540D\u4E3A \u7684\u5355\u72EC\u901A\u7528 Secret<code>&lt;secret&gt;-cacert</code>\u5E26\u6709\u4E00\u4E2A<code>cacert</code>\u5BC6\u94A5\u3002\u4F8B\u5982\uFF0C<code>httpbin-credential</code>\u6709<code>key</code>\u548C<code>cert</code>\uFF0C\u5E76\u4E14<code>httpbin-credential-cacert</code>\u6709<code>cacert</code>\u3002</li><li><code>cacert</code>\u952E\u503C\u53EF\u4EE5\u662F\u4E00\u4E2A CA \u6346\u7ED1\u5305\uFF0C\u7531\u4E32\u8054\u7684\u5404\u4E2A CA \u8BC1\u4E66\u7EC4\u6210\u3002</li></ul><h4 id="\u6E05\u7406-8" tabindex="-1"><a class="header-anchor" href="#\u6E05\u7406-8" aria-hidden="true">#</a> \u6E05\u7406</h4><p>\u5220\u9664\u7F51\u5173\u914D\u7F6E\u3001\u865A\u62DF\u670D\u52A1\u5B9A\u4E49\u548C\u673A\u5BC6\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete gateway mygateway
$ kubectl delete virtualservice httpbin
$ kubectl delete --ignore-not-found<span class="token operator">=</span>true <span class="token parameter variable">-n</span> istio-system secret httpbin-credential <span class="token punctuation">\\</span>
helloworld-credential
$ kubectl delete --ignore-not-found<span class="token operator">=</span>true virtualservice helloworld-v1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5220\u9664\u8BC1\u4E66\u548C\u5BC6\u94A5\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">rm</span> <span class="token parameter variable">-rf</span> example.com.crt example.com.key httpbin.example.com.crt httpbin.example.com.key httpbin.example.com.csr helloworld-v1.example.com.crt helloworld-v1.example.com.key helloworld-v1.example.com.csr client.example.com.crt client.example.com.csr client.example.com.key ./new_certificates
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u5173\u95ED<code>httpbin</code>\u548C<code>helloworld-v1</code>\u670D\u52A1\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete deployment --ignore-not-found<span class="token operator">=</span>true httpbin helloworld-v1
$ kubectl delete <span class="token function">service</span> --ignore-not-found<span class="token operator">=</span>true httpbin helloworld-v1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u51FA\u53E3tls\u53D1\u8D77" tabindex="-1"><a class="header-anchor" href="#\u51FA\u53E3tls\u53D1\u8D77" aria-hidden="true">#</a> \u51FA\u53E3TLS\u53D1\u8D77</h2><h4 id="\u4EC0\u4E48\u662Ftls\u53D1\u8D77" tabindex="-1"><a class="header-anchor" href="#\u4EC0\u4E48\u662Ftls\u53D1\u8D77" aria-hidden="true">#</a> \u4EC0\u4E48\u662FTLS\u53D1\u8D77</h4>`,10),As={href:"https://istio.io/latest/docs/reference/config/networking/service-entry/",target:"_blank",rel:"noopener noreferrer"},Vs=n("code",null,"ServiceEntry",-1),Ds=n("p",null,"\u8003\u8651\u4E00\u4E2A\u5BF9\u5916\u90E8\u7AD9\u70B9\u6267\u884C HTTP \u8C03\u7528\u7684\u9057\u7559\u5E94\u7528\u7A0B\u5E8F\u3002\u5047\u8BBE\u8FD0\u884C\u5E94\u7528\u7A0B\u5E8F\u7684\u7EC4\u7EC7\u6536\u5230\u4E00\u4E2A\u65B0\u8981\u6C42\uFF0C\u8981\u6C42\u6240\u6709\u5916\u90E8\u6D41\u91CF\u90FD\u5FC5\u987B\u52A0\u5BC6\u3002\u4F7F\u7528 Istio\uFF0C\u53EA\u9700\u914D\u7F6E\u5373\u53EF\u5B9E\u73B0\u6B64\u8981\u6C42\uFF0C\u65E0\u9700\u66F4\u6539\u5E94\u7528\u7A0B\u5E8F\u4E2D\u7684\u4EFB\u4F55\u4EE3\u7801\u3002\u5E94\u7528\u7A0B\u5E8F\u53EF\u4EE5\u53D1\u9001\u672A\u52A0\u5BC6\u7684 HTTP \u8BF7\u6C42\uFF0C\u7136\u540E Istio \u5C06\u4E3A\u5E94\u7528\u7A0B\u5E8F\u52A0\u5BC6\u5B83\u4EEC\u3002",-1),Gs=n("p",null,"\u4ECE\u6E90\u53D1\u9001\u672A\u52A0\u5BC6\u7684 HTTP \u8BF7\u6C42\u5E76\u8BA9 Istio \u6267\u884C TLS \u5347\u7EA7\u7684\u53E6\u4E00\u4E2A\u597D\u5904\u662F Istio \u53EF\u4EE5\u751F\u6210\u66F4\u597D\u7684\u9065\u6D4B\u6570\u636E\u5E76\u4E3A\u672A\u52A0\u5BC6\u7684\u8BF7\u6C42\u63D0\u4F9B\u66F4\u591A\u7684\u8DEF\u7531\u63A7\u5236\u3002",-1),Ms=n("h4",{id:"\u73AF\u5883\u51C6\u5907-7",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#\u73AF\u5883\u51C6\u5907-7","aria-hidden":"true"},"#"),s(" \u73AF\u5883\u51C6\u5907")],-1),Us={href:"https://github.com/istio/istio/tree/release-1.13/samples/sleep",target:"_blank",rel:"noopener noreferrer"},js={href:"https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection",target:"_blank",rel:"noopener noreferrer"},Fs=n("code",null,"sleep",-1),Bs=t(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/sleep/sleep.yaml
$ kubectl apply <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject <span class="token parameter variable">-f</span> samples/sleep/sleep.yaml<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8BF7\u6CE8\u610F\uFF0C\u60A8\u53EF\u4EE5<code>exec</code>\u548C<code>curl</code>\u6765\u81EA\u7684\u4EFB\u4F55 pod \u90FD\u5C06\u6267\u884C\u4EE5\u4E0B\u8FC7\u7A0B\u3002</p>`,2),zs={href:"https://github.com/istio/istio/tree/release-1.13/samples/sleep",target:"_blank",rel:"noopener noreferrer"},Xs=t(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">SOURCE_POD</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>sleep <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="\u914D\u7F6E\u5BF9\u5916\u90E8\u670D\u52A1\u7684\u8BBF\u95EE" tabindex="-1"><a class="header-anchor" href="#\u914D\u7F6E\u5BF9\u5916\u90E8\u670D\u52A1\u7684\u8BBF\u95EE" aria-hidden="true">#</a> \u914D\u7F6E\u5BF9\u5916\u90E8\u670D\u52A1\u7684\u8BBF\u95EE</h4>`,2),Ws={href:"https://istio.io/latest/docs/tasks/traffic-management/egress/egress-control",target:"_blank",rel:"noopener noreferrer"},Ks=n("code",null,"edition.cnn.com",-1),Zs=n("code",null,"ServiceEntry",-1),Ys=t(`<ol><li>\u521B\u5EFA\u4E00\u4E2A<code>ServiceEntry</code>\u4EE5\u542F\u7528\u5BF9<code>edition.cnn.com</code>\uFF1A</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceEntry
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> edition<span class="token punctuation">-</span>cnn<span class="token punctuation">-</span>com
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> edition.cnn.com
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>port
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>port
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
  <span class="token key atrule">resolution</span><span class="token punctuation">:</span> DNS
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>\u5411\u5916\u90E8 HTTP \u670D\u52A1\u53D1\u51FA\u8BF7\u6C42\uFF1A</li></ol>`,3),Js=n("em",null,"\u6807\u5FD7",-1),Qs=n("code",null,"-L",-1),na=n("em",null,"curl",-1),sa={href:"https://tools.ietf.org/html/rfc2616#section-10.3.2",target:"_blank",rel:"noopener noreferrer"},aa=n("em",null,"200 OK",-1),ea=n("code",null,"http://edition.cnn.com/politics``https://edition.cnn.com/politics",-1),ta=t("<p>\u5C3D\u7BA1<em>curl</em>\u547D\u4EE4\u900F\u660E\u5730\u5904\u7406\u4E86\u91CD\u5B9A\u5411\uFF0C\u4F46\u8FD9\u91CC\u6709\u4E24\u4E2A\u95EE\u9898\u3002\u7B2C\u4E00\u4E2A\u95EE\u9898\u662F\u5197\u4F59\u8BF7\u6C42\uFF0C\u5B83\u4F7F\u83B7\u53D6<code>http://edition.cnn.com/politics</code>. \u7B2C\u4E8C\u4E2A\u95EE\u9898\u662F URL \u7684\u8DEF\u5F84\uFF0C\u5728\u8FD9\u79CD\u60C5\u51B5\u4E0B\u662F<em>\u653F\u6CBB</em>\uFF0C\u662F\u4EE5\u660E\u6587\u5F62\u5F0F\u53D1\u9001\u7684\u3002\u5982\u679C\u6709\u653B\u51FB\u8005\u55C5\u63A2\u4F60\u7684\u5E94\u7528\u7A0B\u5E8F\u548C \u4E4B\u95F4\u7684\u901A\u4FE1<code>edition.cnn.com</code>\uFF0C\u653B\u51FB\u8005\u5C31\u4F1A\u77E5\u9053<code>edition.cnn.com</code>\u5E94\u7528\u7A0B\u5E8F\u83B7\u53D6\u4E86\u54EA\u4E9B\u7279\u5B9A\u4E3B\u9898\u3002\u51FA\u4E8E\u9690\u79C1\u539F\u56E0\uFF0C\u60A8\u53EF\u80FD\u5E0C\u671B\u963B\u6B62\u6B64\u7C7B\u62AB\u9732\u3002</p><p><strong>\u8FD9\u4E24\u4E2A\u95EE\u9898\u90FD\u53EF\u4EE5\u901A\u8FC7\u914D\u7F6E Istio \u6765\u6267\u884C TLS \u53D1\u8D77\u6765\u89E3\u51B3\u3002</strong></p>",2),pa=t(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">\${SOURCE_POD}</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-D</span> - http://edition.cnn.com/politics
HTTP/1.1 <span class="token number">301</span> Moved Permanently
<span class="token punctuation">..</span>.
location: https://edition.cnn.com/politics
<span class="token punctuation">..</span>.

HTTP/2 <span class="token number">200</span>
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u51FA\u53E3\u6D41\u91CF\u7684tls\u53D1\u8D77" tabindex="-1"><a class="header-anchor" href="#\u51FA\u53E3\u6D41\u91CF\u7684tls\u53D1\u8D77" aria-hidden="true">#</a> \u51FA\u53E3\u6D41\u91CF\u7684TLS\u53D1\u8D77</h4><ol><li>\u91CD\u65B0\u5B9A\u4E49<code>ServiceEntry</code>\u4E0A\u4E00\u8282\u4E2D\u7684\u5C06 HTTP \u8BF7\u6C42\u91CD\u5B9A\u5411\u5230\u7AEF\u53E3 443 \u5E76\u6DFB\u52A0\u4E00\u4E2A<code>DestinationRule</code>\u4EE5\u6267\u884C TLS \u53D1\u8D77\uFF1A <ul><li><code>\u914D\u7F6E\u670D\u52A1\u5165\u53E3\u7684http\u91CD\u5B9A\u5411\u5230443\u7AEF\u53E3</code></li><li><code>\u914D\u7F6E\u4EA4\u901A\u7B56\u7565\u9488\u5BF980\u7AEF\u53E3\u4F7F\u7528\u6A21\u5F0F\u4E3ASIMPLE\u7684tls</code></li></ul></li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceEntry
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> edition<span class="token punctuation">-</span>cnn<span class="token punctuation">-</span>com
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> edition.cnn.com
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>port
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">443</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>port
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
  <span class="token key atrule">resolution</span><span class="token punctuation">:</span> DNS
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> edition<span class="token punctuation">-</span>cnn<span class="token punctuation">-</span>com
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> edition.cnn.com
  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">portLevelSettings</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
        <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">tls</span><span class="token punctuation">:</span>
        <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE <span class="token comment"># initiates HTTPS when accessing edition.cnn.com</span>
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4EE5\u4E0A<code>DestinationRule</code>\u5C06\u4E3A\u7AEF\u53E3 80 \u4E0A\u7684 HTTP \u8BF7\u6C42\u6267\u884C TLS \u53D1\u8D77\uFF0C<code>ServiceEntry</code> \u7136\u540E\u5C06\u7AEF\u53E3 80 \u4E0A\u7684\u8BF7\u6C42\u91CD\u5B9A\u5411\u5230\u76EE\u6807\u7AEF\u53E3 443\u3002</p><ol start="2"><li>\u5411 \u53D1\u9001 HTTP \u8BF7\u6C42<code>http://edition.cnn.com/politics</code>\uFF0C\u5982\u4E0A\u4E00\u8282\u6240\u8FF0\uFF1A</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">\${SOURCE_POD}</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-D</span> - http://edition.cnn.com/politics
HTTP/1.1 <span class="token number">200</span> OK
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u6B21\u60A8\u6536\u5230<em>200 OK</em>\u4F5C\u4E3A\u7B2C\u4E00\u4E2A\u4E5F\u662F\u552F\u4E00\u7684\u54CD\u5E94\u3002Istio \u4E3A<em>curl</em>\u6267\u884C TLS \u53D1\u8D77\uFF0C\u56E0\u6B64\u539F\u59CB HTTP \u8BF7\u6C42\u88AB\u8F6C\u53D1<code>edition.cnn.com</code>\u4E3A HTTPS\u3002\u670D\u52A1\u5668\u76F4\u63A5\u8FD4\u56DE\u5185\u5BB9\uFF0C\u65E0\u9700\u91CD\u5B9A\u5411\u3002\u60A8\u6D88\u9664\u4E86\u5BA2\u6237\u7AEF\u548C\u670D\u52A1\u5668\u4E4B\u95F4\u7684\u53CC\u91CD\u5F80\u8FD4\uFF0C\u5E76\u4E14\u8BF7\u6C42\u4F7F\u7F51\u683C\u52A0\u5BC6\uFF0C\u800C\u6CA1\u6709\u62AB\u9732\u60A8\u7684\u5E94\u7528\u7A0B\u5E8F<em>\u83B7\u53D6</em>.<code>edition.cnn.com</code></p><p>\u8BF7\u6CE8\u610F\uFF0C\u60A8\u4F7F\u7528\u4E86\u4E0E\u4E0A\u4E00\u8282\u4E2D\u76F8\u540C\u7684\u547D\u4EE4\u3002\u5BF9\u4E8E\u4EE5\u7F16\u7A0B\u65B9\u5F0F\u8BBF\u95EE\u5916\u90E8\u670D\u52A1\u7684\u5E94\u7528\u7A0B\u5E8F\uFF0C\u65E0\u9700\u66F4\u6539\u4EE3\u7801\u3002\u60A8\u53EF\u4EE5\u901A\u8FC7\u914D\u7F6E Istio \u83B7\u5F97 TLS \u53D1\u8D77\u7684\u597D\u5904\uFF0C\u800C\u65E0\u9700\u66F4\u6539\u4E00\u884C\u4EE3\u7801\u3002</p><ol start="3"><li>\u8BF7\u6CE8\u610F\uFF0C\u4F7F\u7528 HTTPS \u8BBF\u95EE\u5916\u90E8\u670D\u52A1\u7684\u5E94\u7528\u7A0B\u5E8F\u7EE7\u7EED\u50CF\u4EE5\u524D\u4E00\u6837\u5DE5\u4F5C\uFF1A</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">\${SOURCE_POD}</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-D</span> - https://edition.cnn.com/politics
HTTP/2 <span class="token number">200</span>
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u6E05\u7406-9" tabindex="-1"><a class="header-anchor" href="#\u6E05\u7406-9" aria-hidden="true">#</a> \u6E05\u7406</h4>`,12),la={href:"https://github.com/istio/istio/tree/release-1.13/samples/sleep",target:"_blank",rel:"noopener noreferrer"},ia=t(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete serviceentry edition-cnn-com
$ kubectl delete destinationrule edition-cnn-com
$ kubectl delete <span class="token parameter variable">-f</span> samples/sleep/sleep.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u51FA\u53E3\u7F51\u5173" tabindex="-1"><a class="header-anchor" href="#\u51FA\u53E3\u7F51\u5173" aria-hidden="true">#</a> \u51FA\u53E3\u7F51\u5173</h2><h4 id="\u4EC0\u4E48\u662F\u51FA\u53E3\u7F51\u5173" tabindex="-1"><a class="header-anchor" href="#\u4EC0\u4E48\u662F\u51FA\u53E3\u7F51\u5173" aria-hidden="true">#</a> \u4EC0\u4E48\u662F\u51FA\u53E3\u7F51\u5173</h4>`,3),oa={href:"https://istio.io/latest/docs/reference/config/networking/gateway/",target:"_blank",rel:"noopener noreferrer"},ca=n("p",null,"\u8003\u8651\u4E00\u4E2A\u5177\u6709\u4E25\u683C\u5B89\u5168\u8981\u6C42\u7684\u7EC4\u7EC7\uFF0C\u5373\u6240\u6709\u79BB\u5F00\u670D\u52A1\u7F51\u683C\u7684\u6D41\u91CF\u90FD\u5FC5\u987B\u6D41\u7ECF\u4E00\u7EC4\u4E13\u7528\u8282\u70B9\u3002\u8FD9\u4E9B\u8282\u70B9\u5C06\u5728\u4E13\u7528\u673A\u5668\u4E0A\u8FD0\u884C\uFF0C\u4E0E\u96C6\u7FA4\u4E2D\u8FD0\u884C\u5E94\u7528\u7A0B\u5E8F\u7684\u5176\u4F59\u8282\u70B9\u5206\u5F00\u3002\u8FD9\u4E9B\u7279\u6B8A\u8282\u70B9\u5C06\u7528\u4E8E\u5BF9\u51FA\u53E3\u6D41\u91CF\u6267\u884C\u7B56\u7565\uFF0C\u5E76\u4E14\u5C06\u6BD4\u5176\u4ED6\u8282\u70B9\u66F4\u5F7B\u5E95\u5730\u76D1\u63A7\u3002",-1),ua=n("p",null,"\u53E6\u4E00\u4E2A\u7528\u4F8B\u662F\u5E94\u7528\u7A0B\u5E8F\u8282\u70B9\u6CA1\u6709\u516C\u5171 IP \u7684\u96C6\u7FA4\uFF0C\u56E0\u6B64\u5728\u5B83\u4EEC\u4E0A\u8FD0\u884C\u7684\u7F51\u5185\u670D\u52A1\u65E0\u6CD5\u8BBF\u95EE Internet\u3002\u5B9A\u4E49\u4E00\u4E2A\u51FA\u53E3\u7F51\u5173\uFF0C\u5F15\u5BFC\u6240\u6709\u51FA\u53E3\u6D41\u91CF\u901A\u8FC7\u5B83\uFF0C\u5E76\u5C06\u516C\u5171 IP \u5206\u914D\u7ED9\u51FA\u53E3\u7F51\u5173\u8282\u70B9\uFF0C\u5141\u8BB8\u5E94\u7528\u7A0B\u5E8F\u8282\u70B9\u4EE5\u53D7\u63A7\u65B9\u5F0F\u8BBF\u95EE\u5916\u90E8\u670D\u52A1\u3002",-1),ra=n("h4",{id:"\u57FA\u7840\u73AF\u5883-2",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#\u57FA\u7840\u73AF\u5883-2","aria-hidden":"true"},"#"),s(" \u57FA\u7840\u73AF\u5883")],-1),da={href:"https://github.com/istio/istio/tree/release-1.13/samples/sleep",target:"_blank",rel:"noopener noreferrer"},ka={href:"https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection",target:"_blank",rel:"noopener noreferrer"},va=t(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/sleep/sleep.yaml
$ kubectl apply <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject <span class="token parameter variable">-f</span> samples/sleep/sleep.yaml<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5C06<code>SOURCE_POD</code>\u73AF\u5883\u53D8\u91CF\u8BBE\u7F6E\u4E3A\u6E90 pod \u7684\u540D\u79F0\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">SOURCE_POD</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>sleep <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="\u90E8\u7F72istio\u51FA\u53E3\u7F51\u5173" tabindex="-1"><a class="header-anchor" href="#\u90E8\u7F72istio\u51FA\u53E3\u7F51\u5173" aria-hidden="true">#</a> \u90E8\u7F72Istio\u51FA\u53E3\u7F51\u5173</h4><ol><li>\u68C0\u67E5\u662F\u5426\u90E8\u7F72\u4E86 Istio \u51FA\u53E3\u7F51\u5173\uFF1A</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">istio</span><span class="token operator">=</span>egressgateway <span class="token parameter variable">-n</span> istio-system
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u5982\u679C\u6CA1\u6709\u8FD4\u56DE pod\uFF0C\u8BF7\u6267\u884C\u4EE5\u4E0B\u6B65\u9AA4\u90E8\u7F72 Istio \u51FA\u53E3\u7F51\u5173\u3002</p><ol start="2"><li>\u5982\u679C\u60A8\u4F7F\u7528<code>IstioOperator</code>CR \u5B89\u88C5 Istio\uFF0C\u8BF7\u5C06\u4EE5\u4E0B\u5B57\u6BB5\u6DFB\u52A0\u5230\u60A8\u7684\u914D\u7F6E\u4E2D\uFF1A</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">components</span><span class="token punctuation">:</span>
    <span class="token key atrule">egressGateways</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5426\u5219\uFF0C\u5C06\u7B49\u6548\u8BBE\u7F6E\u6DFB\u52A0\u5230\u60A8\u7684\u539F\u59CB<code>istioctl install</code>\u547D\u4EE4\uFF0C\u4F8B\u5982\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ istioctl <span class="token function">install</span> <span class="token operator">&lt;</span>flags-you-used-to-install-Istio<span class="token operator">&gt;</span> <span class="token punctuation">\\</span>
                   <span class="token parameter variable">--set</span> components.egressGateways<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.name<span class="token operator">=</span>istio-egressgateway <span class="token punctuation">\\</span>
                   <span class="token parameter variable">--set</span> components.egressGateways<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.enabled<span class="token operator">=</span>true
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="http\u6D41\u91CF\u7684\u51FA\u53E3\u7F51\u5173" tabindex="-1"><a class="header-anchor" href="#http\u6D41\u91CF\u7684\u51FA\u53E3\u7F51\u5173" aria-hidden="true">#</a> HTTP\u6D41\u91CF\u7684\u51FA\u53E3\u7F51\u5173</h4><p>\u9996\u5148\u521B\u5EFA\u4E00\u4E2A<code>ServiceEntry</code>\u5141\u8BB8\u76F4\u63A5\u6D41\u91CF\u5230\u5916\u90E8\u670D\u52A1\u3002</p><ol><li><code>ServiceEntry</code>\u4E3A\u5B9A\u4E49\u4E00\u4E2A<code>edition.cnn.com</code>\u3002 <ul><li><code>\u914D\u7F6E\u4E3B\u673A\u4E3Aedition.cnn.com</code></li><li><code>\u914D\u7F6E\u4E3B\u673A\u53D1\u73B0\u6A21\u5F0F\u4E3ADNS</code></li><li><code>\u914D\u7F6EHTTP\u548CHTTPS\u4E24\u4E2A\u534F\u8BAE</code></li></ul></li></ol><blockquote><p><code>DNS</code>\u5FC5\u987B\u5728\u4E0B\u9762\u7684\u670D\u52A1\u6761\u76EE\u4E2D\u4F7F\u7528\u5206\u8FA8\u7387\u3002\u5982\u679C\u5206\u8FA8\u7387\u4E3A<code>NONE</code>\uFF0C\u7F51\u5173\u5C06\u5728\u65E0\u9650\u5FAA\u73AF\u4E2D\u5C06\u6D41\u91CF\u5B9A\u5411\u5230\u81EA\u8EAB\u3002\u8FD9\u662F\u56E0\u4E3A\u7F51\u5173\u63A5\u6536\u5230\u4E00\u4E2A\u8BF7\u6C42\uFF0C\u5176\u539F\u59CB\u76EE\u6807 IP \u5730\u5740\u7B49\u4E8E\u7F51\u5173\u7684\u670D\u52A1 IP\uFF08\u56E0\u4E3A\u8BF7\u6C42\u662F\u7531 Sidecar \u4EE3\u7406\u5B9A\u5411\u5230\u7F51\u5173\u7684\uFF09\u3002\u901A\u8FC7<code>DNS</code>\u89E3\u6790\uFF0C\u7F51\u5173\u6267\u884C DNS \u67E5\u8BE2\u4EE5\u83B7\u53D6\u5916\u90E8\u670D\u52A1\u7684 IP \u5730\u5740\u5E76\u5C06\u6D41\u91CF\u5B9A\u5411\u5230\u8BE5 IP \u5730\u5740\u3002</p></blockquote><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceEntry
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cnn
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> edition.cnn.com
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>port
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> https
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
  <span class="token key atrule">resolution</span><span class="token punctuation">:</span> DNS
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,16),ma={start:"2"},ba={href:"http://edition.cnn.com/politics",target:"_blank",rel:"noopener noreferrer"},ha=n("code",null,"ServiceEntry",-1),ga={href:"https://istio.io/latest/docs/tasks/traffic-management/egress/egress-tls-origination/",target:"_blank",rel:"noopener noreferrer"},ya=t(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">$SOURCE_POD</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-D</span> - http://edition.cnn.com/politics
<span class="token punctuation">..</span>.
HTTP/1.1 <span class="token number">301</span> Moved Permanently
<span class="token punctuation">..</span>.
location: https://edition.cnn.com/politics
<span class="token punctuation">..</span>.

HTTP/2 <span class="token number">200</span>
Content-Type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1),fa={start:"3"},_a=n("code",null,"Gateway",-1),xa={href:"http://edition.cnn.com",target:"_blank",rel:"noopener noreferrer"},Ta=n("ul",null,[n("li",null,[n("code",null,"\u914D\u7F6E\u51FA\u53E3\u7F51\u5173\u4E3Aegressgateway")]),n("li",null,[n("code",null,"\u914D\u7F6E\u4E3B\u673Aedition.cnn.com\u89C4\u8303\u4E3A\u5141\u8BB880\u7AEF\u53E3")]),n("li",null,[n("code",null,"\u521B\u5EFA\u8DEF\u7531\u89C4\u5219\u4E3B\u673A\u4F7F\u7528 istio-egressgateway.istio-system.svc.cluster.local")]),n("li",null,[n("code",null,"\u8DEF\u7531\u89C4\u5219\u4E0B\u7684\u5B50\u96C6\u4F7F\u7528cnn")])],-1),qa=t(`<blockquote><p>\u8981\u901A\u8FC7\u51FA\u53E3\u7F51\u5173\u5F15\u5BFC\u591A\u4E2A\u4E3B\u673A\uFF0C\u60A8\u53EF\u4EE5<code>*</code>\u5728<code>Gateway</code>. \u5E94\u5C06 \u4E2D\u7684<code>subset</code>\u5B57\u6BB5\u91CD\u65B0\u7528\u4E8E\u5176\u4ED6\u4E3B\u673A\u3002<code>DestinationRule</code></p></blockquote><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> egressgateway
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> edition.cnn.com
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> egressgateway<span class="token punctuation">-</span>for<span class="token punctuation">-</span>cnn
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway.istio<span class="token punctuation">-</span>system.svc.cluster.local
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cnn
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>\u5B9A\u4E49 <code>VirtualService</code>\u4EE5\u5C06\u6D41\u91CF\u4ECE sidecar \u5F15\u5BFC\u5230 egress \u7F51\u5173\uFF0C\u5E76\u4ECE egress \u7F51\u5173\u5F15\u5BFC\u5230\u5916\u90E8\u670D\u52A1\uFF1A <ul><li><code>\u5B9A\u4E49\u4E3B\u673A\u5730\u5740\u4E3Aedition.cnn.com</code></li><li><code>\u914D\u7F6E\u865A\u62DF\u670D\u52A1\u4F7F\u7528\u4E24\u4E2A\u7F51\u5173 istio-egressgateway\u548Cmesh</code></li><li><code>\u914D\u7F6Ehttp\u89C4\u5219\u5206\u522B\u4F7F\u7528\u4E24\u4E2A\u7F51\u5173\u90FD\u662F\u5141\u8BB880\u7AEF\u53E3</code></li><li><code>\u914D\u7F6Emesh\u7684\u8DEF\u7531\u89C4\u5219\u5141\u8BB8\u4E3B\u673A istio-egressgateway.istio-system.svc.cluster.local \u3001\u5B50\u96C6\u4E3Acnn\u3001\u7AEF\u53E3\u662F80 \u3001\u6743\u91CD\u5206\u914D\u4E3A100</code></li><li><code>\u914D\u7F6Eistio-egressgateway\u7684\u8DEF\u7531\u89C4\u5219\u5141\u8BB8\u4E3B\u673A\u4E3Aedition.cnn.com\u3001\u7AEF\u53E3\u662F80\u3001\u6743\u91CD\u5206\u914D\u4E5F\u662F100</code></li></ul></li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> direct<span class="token punctuation">-</span>cnn<span class="token punctuation">-</span>through<span class="token punctuation">-</span>egress<span class="token punctuation">-</span>gateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> edition.cnn.com
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> istio<span class="token punctuation">-</span>egressgateway
  <span class="token punctuation">-</span> mesh
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> mesh
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway.istio<span class="token punctuation">-</span>system.svc.cluster.local
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> cnn
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> istio<span class="token punctuation">-</span>egressgateway
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> edition.cnn.com
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,4),wa={start:"5"},Sa={href:"https://edition.cnn.com/politics",target:"_blank",rel:"noopener noreferrer"},Pa=t(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">$SOURCE_POD</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-D</span> - http://edition.cnn.com/politics
<span class="token punctuation">..</span>.
HTTP/1.1 <span class="token number">301</span> Moved Permanently
<span class="token punctuation">..</span>.
location: https://edition.cnn.com/politics
<span class="token punctuation">..</span>.

HTTP/2 <span class="token number">200</span>
Content-Type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1),Ia={start:"6"},Ea=n("p",null,[s("\u68C0\u67E5"),n("code",null,"istio-egressgateway"),s("pod \u7684\u65E5\u5FD7\u4E2D\u662F\u5426\u6709\u4E0E\u6211\u4EEC\u7684\u8BF7\u6C42\u76F8\u5BF9\u5E94\u7684\u884C\u3002\u5982\u679C Istio \u90E8\u7F72\u5728"),n("code",null,"istio-system"),s("\u547D\u540D\u7A7A\u95F4\u4E2D\uFF0C\u6253\u5370\u65E5\u5FD7\u7684\u547D\u4EE4\u662F\uFF1A")],-1),$a={href:"http://edition.cnn.com",target:"_blank",rel:"noopener noreferrer"},Ca=t(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl logs -l istio=egressgateway -c istio-proxy -n istio-system | tail</span>
<span class="token number">2022</span>-03-21T09:42:18.336211Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T10:14:36.196020Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T10:47:07.424114Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T11:15:16.460832Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T11:42:49.235363Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token punctuation">[</span><span class="token number">2022</span>-03-21T11:52:20.947Z<span class="token punctuation">]</span> <span class="token string">&quot;- - -&quot;</span> <span class="token number">0</span> UF,URX - - <span class="token string">&quot;-&quot;</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">15</span> - <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;151.101.65.67:443&quot;</span> outbound<span class="token operator">|</span><span class="token number">443</span><span class="token operator">||</span>edition.cnn.com - <span class="token number">10.244</span>.1.4:8443 <span class="token number">10.244</span>.1.20:33384 edition.cnn.com -
<span class="token punctuation">[</span><span class="token number">2022</span>-03-21T11:52:28.733Z<span class="token punctuation">]</span> <span class="token string">&quot;- - -&quot;</span> <span class="token number">0</span> - - - <span class="token string">&quot;-&quot;</span> <span class="token number">910</span> <span class="token number">1262165</span> <span class="token number">45829</span> - <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;151.101.193.67:443&quot;</span> outbound<span class="token operator">|</span><span class="token number">443</span><span class="token operator">||</span>edition.cnn.com <span class="token number">10.244</span>.1.4:49136 <span class="token number">10.244</span>.1.4:8443 <span class="token number">10.244</span>.1.20:33440 edition.cnn.com -
<span class="token number">2022</span>-03-21T12:15:16.256967Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T12:45:27.104242Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token punctuation">[</span><span class="token number">2022</span>-03-21T13:06:35.033Z<span class="token punctuation">]</span> <span class="token string">&quot;GET /politics HTTP/2&quot;</span> <span class="token number">301</span> - via_upstream - <span class="token string">&quot;-&quot;</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">356</span> <span class="token number">356</span> <span class="token string">&quot;10.244.1.20&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span> <span class="token string">&quot;82a2b1d1-70f0-9907-bfc3-1a86cfd91721&quot;</span> <span class="token string">&quot;edition.cnn.com&quot;</span> <span class="token string">&quot;151.101.129.67:80&quot;</span> outbound<span class="token operator">|</span><span class="token number">80</span><span class="token operator">||</span>edition.cnn.com <span class="token number">10.244</span>.1.4:47896 <span class="token number">10.244</span>.1.4:8080 <span class="token number">10.244</span>.1.20:42962 - -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u6E05\u7406http\u7F51\u5173" tabindex="-1"><a class="header-anchor" href="#\u6E05\u7406http\u7F51\u5173" aria-hidden="true">#</a> \u6E05\u7406HTTP\u7F51\u5173</h4><p>\u5728\u7EE7\u7EED\u4E0B\u4E00\u6B65\u4E4B\u524D\u5220\u9664\u4EE5\u524D\u7684\u5B9A\u4E49\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete gateway istio-egressgateway
$ kubectl delete serviceentry cnn
$ kubectl delete virtualservice direct-cnn-through-egress-gateway
$ kubectl delete destinationrule egressgateway-for-cnn
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="https\u6D41\u91CF\u7684\u51FA\u53E3\u7F51\u5173" tabindex="-1"><a class="header-anchor" href="#https\u6D41\u91CF\u7684\u51FA\u53E3\u7F51\u5173" aria-hidden="true">#</a> HTTPS\u6D41\u91CF\u7684\u51FA\u53E3\u7F51\u5173</h4><p>\u5728\u672C\u8282\u4E2D\uFF0C\u60A8\u5C06\u901A\u8FC7\u51FA\u53E3\u7F51\u5173\u5F15\u5BFC HTTPS \u6D41\u91CF\uFF08\u7531\u5E94\u7528\u7A0B\u5E8F\u53D1\u8D77\u7684 TLS\uFF09\u3002\u60A8\u9700\u8981<code>TLS</code>\u5728\u4E00\u4E2A\u5BF9\u5E94<code>ServiceEntry</code>\u7684\u3001\u4E00\u4E2A\u51FA\u53E3<code>Gateway</code>\u548C\u4E00\u4E2A<code>VirtualService</code>.</p><ol><li><code>ServiceEntry</code>\u4E3A\u5B9A\u4E49\u4E00\u4E2A<code>edition.cnn.com</code>\uFF1A <ul><li><code>\u914D\u7F6E\u670D\u52A1\u5165\u53E3\u7684\u4E3B\u673A\u5217\u8868\u4E3A edition.cnn.com</code></li><li><code>\u914D\u7F6Eports\u89C4\u5219\u4E3ATLS\u6A21\u5F0F\u4EE5\u53CA443\u7AEF\u53E3</code></li><li><code>\u914D\u7F6E\u4E3B\u673A\u53D1\u73B0\u6A21\u5F0F\u4E3ADNS</code></li></ul></li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceEntry
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cnn
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> edition.cnn.com
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> tls
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TLS
  <span class="token key atrule">resolution</span><span class="token punctuation">:</span> DNS
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,8),Ha={start:"2"},Na={href:"https://edition.cnn.com/politics",target:"_blank",rel:"noopener noreferrer"},Oa=n("code",null,"ServiceEntry",-1),Ra=t(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">$SOURCE_POD</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-D</span> - https://edition.cnn.com/politics
<span class="token punctuation">..</span>.
HTTP/2 <span class="token number">200</span>
Content-Type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1),La={start:"3"},Aa=n("code",null,"Gateway",-1),Va={href:"http://edition.cnn.com",target:"_blank",rel:"noopener noreferrer"},Da=t("<ul><li><code>\u521B\u5EFA\u670D\u52A1\u7F51\u5173\u548C\u76EE\u6807\u89C4\u5219\u4EE5\u53CA\u865A\u62DF\u670D\u52A1</code></li><li><code>\u914D\u7F6EGateway\u4F7F\u7528egressgateway\u7684\u51FA\u53E3\u7F51\u5173,\u670D\u52A1\u89C4\u5219\u4E3A\u5141\u8BB8443\u7AEF\u53E3\u4F7F\u7528TLS</code></li><li><code>Gateway\u5141\u8BB8\u7684\u4E3B\u673A\u4E3A edition.cnn.com tls\u7684\u6A21\u5F0F\u4F7F\u7528PASSTHROUGH</code></li><li><code>\u914D\u7F6E\u76EE\u6807\u89C4\u5219\u5141\u8BB8\u7684\u4E3B\u673A\u5217\u8868istio-egressgateway.istio-system.svc.cluster.local \u5B50\u96C6\u4E3Acnn</code></li><li><code>\u914D\u7F6E\u865A\u62DF\u670D\u52A1\u5141\u8BB8\u4E3B\u673A\u5217\u8868\u4E3Aedition.cnn.com</code></li><li><code>\u914D\u7F6E\u865A\u62DF\u670D\u52A1\u4F7F\u7528\u51FA\u53E3\u7F51\u5173istio-egressgateway\u548Cmesh</code></li><li><code>\u914D\u7F6E\u865A\u62DF\u670D\u52A1\u7684mesh\u7F51\u5173\u8981\u5339\u914D\u7684SNI\uFF08\u670D\u52A1\u5668\u540D\u79F0\u6307\u793A\u5668\uFF09edition.cnn.com \u5141\u8BB8443\u7AEF\u53E3</code></li><li><code>\u914D\u7F6E\u865A\u62DF\u670D\u52A1\u7684mesh\u7F51\u5173\u76EE\u6807\u89C4\u5219\u5141\u8BB8\u4E3B\u673A\u5217\u8868istio-egressgateway.istio-system.svc.cluster.local\u5E76\u4E14\u5141\u8BB8443\u7AEF\u53E3</code></li><li><code>\u914D\u7F6E\u865A\u62DF\u670D\u52A1\u7684istio-egressgateway\u7F51\u5173\u8981\u5339\u914D\u7684SNI\uFF08\u670D\u52A1\u5668\u540D\u79F0\u6307\u793A\u5668\uFF09edition.cnn.com \u5141\u8BB8443\u7AEF\u53E3</code></li><li><code>\u914D\u7F6E\u865A\u62DF\u670D\u52A1\u7684istio-egressgateway\u7F51\u5173\u76EE\u6807\u89C4\u5219\u5141\u8BB8\u4E3B\u673A\u5217\u8868edition.cnn.com\u5E76\u4E14\u5141\u8BB8443\u7AEF\u53E3\u3001\u6743\u91CD\u4E3A100</code></li></ul>",1),Ga=t(`<blockquote><p>\u8981\u901A\u8FC7\u51FA\u53E3\u7F51\u5173\u5F15\u5BFC\u591A\u4E2A\u4E3B\u673A\uFF0C\u60A8\u53EF\u4EE5<code>*</code>\u5728<code>Gateway</code>. \u5E94\u5C06 \u4E2D\u7684<code>subset</code>\u5B57\u6BB5\u91CD\u65B0\u7528\u4E8E\u5176\u4ED6\u4E3B\u673A\u3002<code>DestinationRule</code></p></blockquote><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> egressgateway
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> tls
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TLS
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> edition.cnn.com
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> PASSTHROUGH
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> egressgateway<span class="token punctuation">-</span>for<span class="token punctuation">-</span>cnn
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway.istio<span class="token punctuation">-</span>system.svc.cluster.local
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cnn
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> direct<span class="token punctuation">-</span>cnn<span class="token punctuation">-</span>through<span class="token punctuation">-</span>egress<span class="token punctuation">-</span>gateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> edition.cnn.com
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> mesh
  <span class="token punctuation">-</span> istio<span class="token punctuation">-</span>egressgateway
  <span class="token key atrule">tls</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> mesh
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">sniHosts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> edition.cnn.com
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway.istio<span class="token punctuation">-</span>system.svc.cluster.local
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> cnn
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> istio<span class="token punctuation">-</span>egressgateway
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">sniHosts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> edition.cnn.com
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> edition.cnn.com
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,2),Ma={start:"4"},Ua={href:"https://edition.cnn.com/politics",target:"_blank",rel:"noopener noreferrer"},ja=t(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">$SOURCE_POD</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-D</span> - https://edition.cnn.com/politics
<span class="token punctuation">..</span>.
HTTP/2 <span class="token number">200</span>
Content-Type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li>\u67E5\u770B\u51FA\u53E3\u7F51\u5173\u4EE3\u7406\u7684\u65E5\u5FD7\u3002\u5982\u679C Istio \u90E8\u7F72\u5728<code>istio-system</code>\u547D\u540D\u7A7A\u95F4\u4E2D\uFF0C\u6253\u5370\u65E5\u5FD7\u7684\u547D\u4EE4\u662F\uFF1A</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl logs -l istio=egressgateway -n istio-system</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-21T11:52:28.733Z<span class="token punctuation">]</span> <span class="token string">&quot;- - -&quot;</span> <span class="token number">0</span> - - - <span class="token string">&quot;-&quot;</span> <span class="token number">910</span> <span class="token number">1262165</span> <span class="token number">45829</span> - <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;151.101.193.67:443&quot;</span> outbound<span class="token operator">|</span><span class="token number">443</span><span class="token operator">||</span>edition.cnn.com <span class="token number">10.244</span>.1.4:49136 <span class="token number">10.244</span>.1.4:8443 <span class="token number">10.244</span>.1.20:33440 edition.cnn.com -
<span class="token number">2022</span>-03-21T12:15:16.256967Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T12:45:27.104242Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token punctuation">[</span><span class="token number">2022</span>-03-21T13:06:35.033Z<span class="token punctuation">]</span> <span class="token string">&quot;GET /politics HTTP/2&quot;</span> <span class="token number">301</span> - via_upstream - <span class="token string">&quot;-&quot;</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">356</span> <span class="token number">356</span> <span class="token string">&quot;10.244.1.20&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span> <span class="token string">&quot;82a2b1d1-70f0-9907-bfc3-1a86cfd91721&quot;</span> <span class="token string">&quot;edition.cnn.com&quot;</span> <span class="token string">&quot;151.101.129.67:80&quot;</span> outbound<span class="token operator">|</span><span class="token number">80</span><span class="token operator">||</span>edition.cnn.com <span class="token number">10.244</span>.1.4:47896 <span class="token number">10.244</span>.1.4:8080 <span class="token number">10.244</span>.1.20:42962 - -
<span class="token number">2022</span>-03-21T13:15:59.020699Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T13:40:14.303559Z     info    ads     XDS: Incremental Pushing:0 ConnectedEndpoints:2 Version:
<span class="token number">2022</span>-03-21T13:40:14.597921Z     info    cache   generated new workload certificate   <span class="token assign-left variable">latency</span><span class="token operator">=</span><span class="token number">294</span>.218007ms <span class="token assign-left variable">ttl</span><span class="token operator">=</span>23h59m59.402089572s
<span class="token number">2022</span>-03-21T13:40:14.598006Z     info    ads     SDS: PUSH <span class="token keyword">for</span> node:istio-egressgateway-7f4864f59c-q5cdv.istio-system resources:1 size:4.0kB resource:default
<span class="token number">2022</span>-03-21T13:47:00.985263Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T14:18:49.713637Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u6E05\u7406https\u7F51\u5173" tabindex="-1"><a class="header-anchor" href="#\u6E05\u7406https\u7F51\u5173" aria-hidden="true">#</a> \u6E05\u7406HTTPS\u7F51\u5173</h4><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete serviceentry cnn
$ kubectl delete gateway istio-egressgateway
$ kubectl delete virtualservice direct-cnn-through-egress-gateway
$ kubectl delete destinationrule egressgateway-for-cnn
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,5);function Fa(Ba,za){const a=o("ExternalLinkIcon");return l(),i("div",null,[u,n("p",null,[s("\u6700\u7B80\u5355\u7684\u9009\u62E9\u662F \u4F7F\u7528\u4EE5\u4E0B\u547D\u4EE4\u5B89\u88C5"),r,s("Istio "),n("a",d,[s("\u914D\u7F6E\u6587\u4EF6"),e(a)]),s("\uFF1A")]),k,n("p",null,[s("\u9ED8\u8BA4\u7684 Istio \u5B89\u88C5\u4F7F\u7528"),n("a",v,[s("\u81EA\u52A8\u8FB9\u8F66\u6CE8\u5165"),e(a)]),s("\u3002\u6807\u8BB0\u5C06\u6258\u7BA1\u5E94\u7528\u7A0B\u5E8F\u7684\u547D\u540D\u7A7A\u95F4"),m,s("\uFF1A")]),b,n("p",null,[s("\u73B0\u5728 Bookinfo \u670D\u52A1\u5DF2\u542F\u52A8\u5E76\u8FD0\u884C\uFF0C\u60A8\u9700\u8981\u4F7F\u5E94\u7528\u7A0B\u5E8F\u53EF\u4ECE Kubernetes \u96C6\u7FA4\u5916\u90E8\u8BBF\u95EE\uFF0C\u4F8B\u5982\u4ECE\u6D4F\u89C8\u5668\u8BBF\u95EE\u3002\u4E00\u4E2A"),n("a",h,[s("Istio\u7F51\u5173"),e(a)]),s(" \u7528\u4E8E\u6B64\u76EE\u7684\u3002")]),g,n("p",null,[s("\u5728\u4F7F\u7528 Istio \u63A7\u5236 Bookinfo \u7248\u672C\u8DEF\u7531\u4E4B\u524D\uFF0C\u60A8\u9700\u8981\u5728"),n("a",y,[s("\u76EE\u6807\u89C4\u5219\u4E2D"),e(a)]),s("\u5B9A\u4E49\u53EF\u7528\u7248\u672C\uFF0C\u79F0\u4E3A\u5B50\u96C6\u3002")]),f,n("blockquote",null,[n("p",null,[s("\u5728"),_,s("\u4E0E"),x,s(),n("a",T,[s("\u914D\u7F6E\u8F6E\u5ED3"),e(a)]),s("\u5177\u6709"),n("a",q,[s("\u81EA\u52A8\u76F8\u4E92TLS"),e(a)]),s("\u542F\u7528\u9ED8\u8BA4\u60C5\u51B5\u4E0B\u3002\u8981\u5F3A\u5236\u5B9E\u65BD\u53CC\u5411 TLS\uFF0C\u8BF7\u4F7F\u7528"),w,s(".")])]),S,n("ul",null,[n("li",null,[s("\u90E8\u7F72"),n("a",P,[s("Bookinfo"),e(a)]),s("\u793A\u4F8B\u5E94\u7528\u7A0B\u5E8F\u3002")]),I]),n("blockquote",null,[E,n("p",null,[s("Istio "),n("a",$,[s("Bookinfo"),e(a)]),s("\u793A\u4F8B\u7531\u56DB\u4E2A\u72EC\u7ACB\u7684\u5FAE\u670D\u52A1\u7EC4\u6210\uFF0C\u6BCF\u4E2A\u5FAE\u670D\u52A1\u90FD\u6709\u591A\u4E2A\u7248\u672C\u3002\u5176\u4E2D\u4E00\u4E2A\u5FAE\u670D\u52A1\u7684\u4E09\u4E2A\u4E0D\u540C\u7248\u672C"),C,s("\u5DF2\u90E8\u7F72\u5E76\u540C\u65F6\u8FD0\u884C\u3002\u4E3A\u4E86\u8BF4\u660E\u8FD9\u5BFC\u81F4\u7684\u95EE\u9898\uFF0C\u8BF7"),H,s("\u5728\u6D4F\u89C8\u5668\u4E2D\u8BBF\u95EE Bookinfo \u5E94\u7528\u7A0B\u5E8F\u5E76\u5237\u65B0\u51E0\u6B21\u3002\u60A8\u4F1A\u6CE8\u610F\u5230\uFF0C\u6709\u65F6\u4E66\u8BC4\u8F93\u51FA\u5305\u542B\u661F\u7EA7\uFF0C\u6709\u65F6\u5219\u4E0D\u5305\u542B\u3002\u8FD9\u662F\u56E0\u4E3A\u5982\u679C\u6CA1\u6709\u660E\u786E\u7684\u9ED8\u8BA4\u670D\u52A1\u7248\u672C\u6765\u8DEF\u7531\uFF0CIstio \u4F1A\u4EE5\u5FAA\u73AF\u65B9\u5F0F\u5C06\u8BF7\u6C42\u8DEF\u7531\u5230\u6240\u6709\u53EF\u7528\u7248\u672C\u3002")])]),N,n("ol",null,[n("li",null,[n("p",null,[s("\u5728\u6D4F\u89C8\u5668\u4E2D\u6253\u5F00 Bookinfo \u7AD9\u70B9\u3002URL \u662F"),O,s("\uFF0C\u5176\u4E2D"),R,s("\u662F\u5165\u53E3\u7684\u5916\u90E8 IP \u5730\u5740\uFF0C\u5982"),n("a",L,[s("Bookinfo"),e(a)]),s("\u6587\u6863\u4E2D\u6240\u8FF0\u3002")]),A])]),V,D,G,M,n("p",null,[s("Istio \u8FD8\u652F\u6301\u5728\u5165\u53E3\u7F51\u5173\u4E0A\u57FA\u4E8E\u5F3A\u8BA4\u8BC1 JWT \u7684\u8DEF\u7531\uFF0C\u6709\u5173\u66F4\u591A\u8BE6\u7EC6\u4FE1\u606F\uFF0C\u8BF7\u53C2\u9605 "),n("a",U,[s("\u57FA\u4E8E JWT \u58F0\u660E\u7684\u8DEF\u7531"),e(a)]),s("\u3002")]),j,n("ul",null,[n("li",null,[s("\u90E8\u7F72"),n("a",F,[s("Bookinfo"),e(a)]),s("\u793A\u4F8B\u5E94\u7528\u7A0B\u5E8F\uFF0C\u5E94\u7528\u76EE\u6807\u89C4\u5219\u3002")]),B]),n("blockquote",null,[n("p",null,[s("\u901A\u8FC7\u6267\u884C "),n("a",z,[s("\u8BF7\u6C42\u8DEF\u7531"),e(a)]),s("\u4EFB\u52A1\u6216\u8FD0\u884C\u4EE5\u4E0B\u547D\u4EE4\u6765\u5E94\u7528\u5E94\u7528\u7A0B\u5E8F\u7248\u672C\u8DEF\u7531\uFF1A")]),X]),W,n("ol",null,[n("li",null,[n("p",null,[s("\u5728\u6D4F\u89C8\u5668\u4E2D\u6253\u5F00"),n("a",K,[s("Bookinfo Web \u5E94\u7528\u7A0B\u5E8F\u3002"),e(a)])])]),Z]),Y,n("p",null,[s("\u5982\u679C\u60A8\u6309\u7167"),n("a",J,[s("\u6D41\u91CF\u8F6C\u79FB"),e(a)]),Q,s("\u4EFB\u52A1\u4E2D\u7684\u63CF\u8FF0 \u5C06\u6240\u6709\u6D41\u91CF\u8FC1\u79FB\u5230\uFF0C\u60A8\u53EF\u4EE5\u5C1D\u8BD5\u5C06\u5EF6\u8FDF\u89C4\u5219\u66F4\u6539\u4E3A\u5C0F\u4E8E 2.5s \u7684\u4EFB\u610F\u91CF\uFF0C\u4F8B\u5982 2s\uFF0C\u5E76\u786E\u8BA4\u7AEF\u5230\u7AEF\u6D41\u7A0B\u7EE7\u7EED\u6CA1\u6709\u4EFB\u4F55\u9519\u8BEF\u3002")]),nn,n("ol",null,[n("li",null,[n("p",null,[s("\u5728\u6D4F\u89C8\u5668\u4E2D\u6253\u5F00"),n("a",sn,[s("Bookinfo Web \u5E94\u7528\u7A0B\u5E8F\u3002"),e(a)])])]),an]),en,n("ul",null,[n("li",null,[s("\u90E8\u7F72"),n("a",tn,[s("Bookinfo"),e(a)]),s("\u793A\u4F8B\u5E94\u7528\u7A0B\u5E8F\uFF0C\u5E94\u7528\u76EE\u6807\u89C4\u5219\u3002")]),pn]),ln,n("blockquote",null,[n("ol",null,[on,n("li",null,[s("\u90E8\u7F72"),n("a",cn,[s("sleep"),e(a)]),s("\u793A\u4F8B\u5E94\u7528\u7A0B\u5E8F\u4EE5\u7528\u4F5C\u53D1\u9001\u8BF7\u6C42\u7684\u6D4B\u8BD5\u6E90\u3002")]),un,n("li",null,[s("\u6309\u7167 "),n("a",rn,[s("\u786E\u5B9A\u5165\u53E3 IP \u548C\u7AEF\u53E3"),e(a)]),dn,s("\u4E2D \u7684\u8BF4\u660E\u5B9A\u4E49"),kn,s("\u73AF\u5883\u53D8\u91CF\u3002")])]),vn]),mn,n("ul",null,[n("li",null,[s("\u90E8\u7F72"),n("a",bn,[s("Bookinfo"),e(a)]),s("\u793A\u4F8B\u5E94\u7528\u7A0B\u5E8F\uFF0C\u5E94\u7528\u76EE\u6807\u89C4\u5219\u3002")]),hn]),gn,n("p",null,[s("\u53EF\u4EE5\u4F7F\u7528"),n("a",yn,[s("\u8DEF\u7531\u89C4\u5219\u7684"),e(a)]),fn,s("\u5B57\u6BB5\u6307\u5B9A HTTP \u8BF7\u6C42\u7684\u8D85\u65F6\u65F6\u95F4\u3002\u9ED8\u8BA4\u60C5\u51B5\u4E0B\uFF0C\u8BF7\u6C42\u8D85\u65F6\u88AB\u7981\u7528\uFF0C\u4F46\u5728\u6B64\u4EFB\u52A1\u4E2D\uFF0C\u60A8\u5C06\u670D\u52A1\u8D85\u65F6\u8986\u76D6\u4E3A 1 \u79D2\u3002\u4F46\u662F\uFF0C\u8981\u67E5\u770B\u5176\u6548\u679C\uFF0C\u60A8\u8FD8\u53EF\u4EE5\u5728\u8C03\u7528\u670D\u52A1\u65F6\u4EBA\u4E3A\u5730\u5F15\u5165 2 \u79D2\u5EF6\u8FDF\u3002")]),_n,n("p",null,[s("\u542F\u52A8"),n("a",xn,[s("httpbin"),e(a)]),s("\u793A\u4F8B\u3002")]),n("p",null,[s("\u5982\u679C\u60A8\u542F\u7528\u4E86"),n("a",Tn,[s("\u81EA\u52A8\u8FB9\u8F66\u6CE8\u5165"),e(a)]),s("\uFF0C\u8BF7\u90E8\u7F72\u8BE5"),qn,s("\u670D\u52A1\uFF1A")]),wn,n("ol",null,[n("li",null,[s("\u521B\u5EFA"),n("a",Sn,[s("\u76EE\u6807\u89C4\u5219"),e(a)]),s("\u4EE5\u5728\u8C03\u7528\u670D\u52A1\u65F6\u5E94\u7528\u65AD\u8DEF\u8BBE\u7F6E"),Pn,s("\uFF1A "),In])]),n("blockquote",null,[n("p",null,[s("\u5982\u679C\u60A8\u5B89\u88C5/\u914D\u7F6E\u4E86\u542F\u7528\u53CC\u5411 TLS \u8EAB\u4EFD\u9A8C\u8BC1\u7684 Istio\uFF0C\u5219\u5FC5\u987B\u5728\u5E94\u7528\u4E4B\u524D\u6DFB\u52A0 TLS \u6D41\u91CF"),En,s("\u7B56\u7565"),$n,s("\u3002\u5426\u5219\u8BF7\u6C42\u5C06\u4EA7\u751F 503 \u9519\u8BEF\uFF0C\u5982\u6B64"),n("a",Cn,[s("\u5904"),e(a)]),s("\u6240\u8FF0\u3002")])]),Hn,n("p",null,[s("\u521B\u5EFA\u5BA2\u6237\u7AEF\u4EE5\u5C06\u6D41\u91CF\u53D1\u9001\u5230"),Nn,s("\u670D\u52A1\u3002"),n("a",On,[s("\u8BE5\u5BA2\u6237\u7AEF\u662F\u4E00\u4E2A\u540D\u4E3Afortio"),e(a)]),s("\u7684\u7B80\u5355\u8D1F\u8F7D\u6D4B\u8BD5\u5BA2\u6237\u7AEF\u3002Fortio \u5141\u8BB8\u60A8\u63A7\u5236\u4F20\u51FA HTTP \u8C03\u7528\u7684\u8FDE\u63A5\u6570\u3001\u5E76\u53D1\u6027\u548C\u5EF6\u8FDF\u3002\u60A8\u5C06\u4F7F\u7528\u6B64\u5BA2\u6237\u7AEF\u201C\u8DF3\u95F8\u201D\u60A8\u5728"),Rn,s(".")]),n("ol",null,[n("li",null,[s("\u4F7F\u7528 Istio sidecar \u4EE3\u7406\u6CE8\u5165\u5BA2\u6237\u7AEF\uFF0C\u4EE5\u4FBF\u7F51\u7EDC\u4EA4\u4E92\u7531 Istio \u7BA1\u7406\u3002\u5982\u679C\u60A8\u542F\u7528\u4E86"),n("a",Ln,[s("\u81EA\u52A8\u8FB9\u8F66\u6CE8\u5165"),e(a)]),s("\uFF0C\u8BF7\u90E8\u7F72\u8BE5"),An,s("\u670D\u52A1\uFF1A")])]),Vn,n("p",null,[s("\u5173\u95ED"),n("a",Dn,[s("httpbin"),e(a)]),s("\u670D\u52A1\u548C\u5BA2\u6237\u7AEF\uFF1A")]),Gn,n("p",null,[s("\u9996\u5148\u90E8\u7F72\u4E24\u4E2A\u542F\u7528\u4E86\u8BBF\u95EE\u65E5\u5FD7\u8BB0\u5F55\u7684"),n("a",Mn,[s("httpbin\u670D\u52A1\u7248\u672C\uFF1A"),e(a)])]),Un,n("p",null,[s("\u5173\u95ED"),n("a",jn,[s("httpbin"),e(a)]),s("\u670D\u52A1\u548C\u5BA2\u6237\u7AEF\uFF1A")]),Fn,n("p",null,[s("\u9664\u4E86\u652F\u6301 Kubernetes "),n("a",Bn,[s("Ingress"),e(a)]),s("\uFF0CIstio \u8FD8\u63D0\u4F9B\u4E86\u53E6\u4E00\u79CD\u914D\u7F6E\u6A21\u578B\uFF0C"),n("a",zn,[s("\u5373 Istio Gateway"),e(a)]),s("\u3002A"),Xn,s("\u63D0\u4F9B\u4E86\u6BD4 \u66F4\u5E7F\u6CDB\u7684\u81EA\u5B9A\u4E49\u548C\u7075\u6D3B\u6027"),Wn,s("\uFF0C\u5E76\u5141\u8BB8\u5C06\u76D1\u63A7\u548C\u8DEF\u7531\u89C4\u5219\u7B49 Istio \u529F\u80FD\u5E94\u7528\u4E8E\u8FDB\u5165\u96C6\u7FA4\u7684\u6D41\u91CF\u3002")]),Kn,Zn,n("ul",null,[Yn,n("li",null,[s("\u542F\u52A8"),n("a",Jn,[s("httpbin"),e(a)]),s("\u793A\u4F8B\u3002")])]),n("p",null,[s("\u200B \u5982\u679C\u60A8\u542F\u7528\u4E86"),n("a",Qn,[s("\u81EA\u52A8\u8FB9\u8F66\u6CE8\u5165"),e(a)]),s("\uFF0C\u8BF7\u90E8\u7F72\u8BE5"),ns,s("\u670D\u52A1\uFF1A")]),ss,n("p",null,[s("\u5982\u679C"),as,s("\u8BBE\u7F6E\u4E86\u8BE5\u503C\uFF0C\u5219\u60A8\u7684\u73AF\u5883\u5177\u6709\u53EF\u7528\u4E8E\u5165\u53E3\u7F51\u5173\u7684\u5916\u90E8\u8D1F\u8F7D\u5747\u8861\u5668\u3002\u5982\u679C"),es,s("\u503C\u4E3A"),ts,s("\u6216\u6C38\u4E45"),ps,s("\uFF0C\u5219\u60A8\u7684\u73AF\u5883\u4E0D\u4E3A\u5165\u53E3\u7F51\u5173\u63D0\u4F9B\u5916\u90E8\u8D1F\u8F7D\u5747\u8861\u5668\u3002"),n("a",ls,[s("\u5728\u8FD9\u79CD\u60C5\u51B5\u4E0B\uFF0C\u60A8\u53EF\u4EE5\u4F7F\u7528\u670D\u52A1\u7684\u8282\u70B9\u7AEF\u53E3"),e(a)]),s("\u8BBF\u95EE\u7F51\u5173\u3002")]),is,n("p",null,[s("\u5165\u53E3"),n("a",os,[s("\u7F51\u5173"),e(a)]),s("\u63CF\u8FF0\u4E86\u5728\u7F51\u683C\u8FB9\u7F18\u8FD0\u884C\u7684\u8D1F\u8F7D\u5747\u8861\u5668\uFF0C\u7528\u4E8E\u63A5\u6536\u4F20\u5165\u7684 HTTP/TCP \u8FDE\u63A5\u3002\u5B83\u914D\u7F6E\u66B4\u9732\u7684\u7AEF\u53E3\u3001\u534F\u8BAE\u7B49\uFF0C\u4F46\u4E0E"),n("a",cs,[s("Kubernetes Ingress Resources"),e(a)]),s("\u4E0D\u540C\uFF0C\u5B83\u4E0D\u5305\u62EC\u4EFB\u4F55\u6D41\u91CF\u8DEF\u7531\u914D\u7F6E\u3002\u5165\u53E3\u6D41\u91CF\u7684\u6D41\u91CF\u8DEF\u7531\u662F\u4F7F\u7528 Istio \u8DEF\u7531\u89C4\u5219\u914D\u7F6E\u7684\uFF0C\u4E0E\u5185\u90E8\u670D\u52A1\u8BF7\u6C42\u7684\u65B9\u5F0F\u5B8C\u5168\u76F8\u540C\u3002")]),us,n("p",null,[s("\u8BF7\u6CE8\u610F\uFF0C\u60A8\u4F7F\u7528\u8BE5"),rs,s("\u6807\u5FD7\u5C06"),ds,s(" HTTP \u6807\u5934\u8BBE\u7F6E\u4E3A\u201C"),n("a",ks,[s("httpbin.example.com"),e(a)]),s("\u201D\u3002\u8FD9\u662F\u5FC5\u9700\u7684\uFF0C\u56E0\u4E3A\u60A8\u7684\u5165\u53E3"),vs,s("\u914D\u7F6E\u4E3A\u5904\u7406\u201C"),n("a",ms,[s("httpbin.example.com"),e(a)]),s("\u201D\uFF0C\u4F46\u5728\u60A8\u7684\u6D4B\u8BD5\u73AF\u5883\u4E2D\uFF0C\u60A8\u6CA1\u6709\u8BE5\u4E3B\u673A\u7684 DNS \u7ED1\u5B9A\uFF0C\u53EA\u662F\u5C06\u60A8\u7684\u8BF7\u6C42\u53D1\u9001\u5230\u5165\u53E3 IP\u3002")]),bs,n("p",null,[s("\u5220\u9664"),hs,s("and"),gs,s("\u914D\u7F6E\uFF0C\u5173\u95ED"),n("a",ys,[s("httpbin"),e(a)]),s("\u670D\u52A1\uFF1A")]),fs,n("p",null,[s("\u63A7\u5236\u5165\u53E3"),n("a",_s,[s("\u6D41\u91CF\u4EFB\u52A1"),e(a)]),s(" \u63CF\u8FF0\u4E86\u5982\u4F55\u914D\u7F6E\u5165\u53E3\u7F51\u5173\u4EE5\u5C06 HTTP \u670D\u52A1\u516C\u5F00\u7ED9\u5916\u90E8\u6D41\u91CF\u3002\u6B64\u4EFB\u52A1\u663E\u793A\u5982\u4F55\u4F7F\u7528\u7B80\u5355\u6216\u53CC\u5411 TLS \u516C\u5F00\u5B89\u5168\u7684 HTTPS \u670D\u52A1\u3002")]),xs,n("ul",null,[Ts,n("li",null,[s("\u542F\u52A8"),n("a",qs,[s("httpbin"),e(a)]),s("\u793A\u4F8B\u3002")])]),n("p",null,[s("\u200B \u5982\u679C\u60A8\u542F\u7528\u4E86"),n("a",ws,[s("\u81EA\u52A8\u8FB9\u8F66\u6CE8\u5165"),e(a)]),s("\uFF0C\u8BF7\u90E8\u7F72\u8BE5"),Ss,s("\u670D\u52A1\uFF1A")]),Ps,n("p",null,[s("\u5BF9\u4E8E\u6B64\u4EFB\u52A1\uFF0C\u60A8\u53EF\u4EE5\u4F7F\u7528\u60A8\u559C\u6B22\u7684\u5DE5\u5177\u6765\u751F\u6210\u8BC1\u4E66\u548C\u5BC6\u94A5\u3002\u4E0B\u9762\u7684\u547D\u4EE4\u4F7F\u7528 "),n("a",Is,[s("openssl"),e(a)])]),Es,n("ol",$s,[n("li",null,[s("\u53D1\u9001 HTTPS \u8BF7\u6C42\u4EE5"),Cs,s("\u901A\u8FC7 HTTPS \u8BBF\u95EE\u670D\u52A1\uFF0C\u8BE5"),Hs,s("\u670D\u52A1\u5C06\u8FD4\u56DE "),n("a",Ns,[s("418 I'm a Teapot"),e(a)]),s("\u4EE3\u7801\u3002")])]),Os,n("p",null,[s("Istio \u652F\u6301\u8BFB\u53D6\u51E0\u79CD\u4E0D\u540C\u7684 Secret \u683C\u5F0F\uFF0C\u4EE5\u652F\u6301\u4E0E\u5404\u79CD\u5DE5\u5177\u7684\u96C6\u6210\uFF0C\u4F8B\u5982"),n("a",Rs,[s("cert-manager"),e(a)]),s("\uFF1A")]),Ls,n("p",null,[s("\u7528\u4E8E\u914D\u7F6E Istio \u4EE5\u53D7\u63A7\u65B9\u5F0F\u8BBF\u95EE\u5916\u90E8\u670D\u52A1\u3002\u8FD9\u4E2A\u4F8B\u5B50\u5C55\u793A\u4E86\u5982\u4F55\u914D\u7F6E Istio \u6765\u6267\u884C"),n("a",As,[Vs,e(a)]),s("TLS \u53D1\u8D77 \u7528\u4E8E\u5230\u5916\u90E8\u670D\u52A1\u7684\u6D41\u91CF\u3002\u5F53\u539F\u59CB\u6D41\u91CF\u4E3A HTTP \u65F6\uFF0CIstio \u5C06\u6253\u5F00\u4E0E\u5916\u90E8\u670D\u52A1\u7684 HTTPS \u8FDE\u63A5\u3002")]),Ds,Gs,Ms,n("p",null,[s("\u542F\u52A8\u5C06\u7528\u4F5C\u5916\u90E8\u8C03\u7528\u6D4B\u8BD5\u6E90\u7684"),n("a",Us,[s("\u7761\u7720\u6837\u672C\u3002"),e(a)])]),n("p",null,[s("\u5982\u679C\u60A8\u542F\u7528\u4E86"),n("a",js,[s("\u81EA\u52A8\u8FB9\u8F66\u6CE8\u5165"),e(a)]),s("\uFF0C\u8BF7\u90E8\u7F72"),Fs,s("\u5E94\u7528\u7A0B\u5E8F\uFF1A")]),Bs,n("p",null,[s("\u521B\u5EFA\u4E00\u4E2A shell \u53D8\u91CF\u6765\u4FDD\u5B58\u7528\u4E8E\u5411\u5916\u90E8\u670D\u52A1\u53D1\u9001\u8BF7\u6C42\u7684\u6E90 pod \u7684\u540D\u79F0\u3002\u5982\u679C\u60A8\u4F7F\u7528\u4E86"),n("a",zs,[s("sleep"),e(a)]),s("\u793A\u4F8B\uFF0C\u8BF7\u8FD0\u884C\uFF1A")]),Xs,n("p",null,[s("\u9996\u5148\u4F7F\u7528"),n("a",Ws,[s("\u8BBF\u95EE\u5916\u90E8\u670D\u52A1"),e(a)]),s("\u4EFB\u52A1"),Ks,s("\u4E2D\u663E\u793A\u7684\u76F8\u540C\u6280\u672F\u914D\u7F6E\u5BF9\u5916\u90E8\u670D\u52A1\u7684\u8BBF\u95EE\u3002\u4F46\u662F\uFF0C\u8FD9\u4E00\u6B21\u4F7F\u7528\u5355\u4E2A\u6765\u542F\u7528\u5BF9\u670D\u52A1\u7684 HTTP \u548C HTTPS \u8BBF\u95EE\u3002"),Zs]),Ys,n("blockquote",null,[n("p",null,[s("\u6CE8\u610F curl \u7684"),Js,Qs,s("\uFF0C\u5B83\u6307\u793A"),na,s("\u9075\u5FAA\u91CD\u5B9A\u5411\u3002\u5728\u8FD9\u79CD\u60C5\u51B5\u4E0B\uFF0C\u670D\u52A1\u5668\u4E3A HTTP \u8BF7\u6C42\u8FD4\u56DE\u4E86\u91CD\u5B9A\u5411\u54CD\u5E94\uFF08"),n("a",sa,[s("301 Moved Permanently"),e(a)]),s(" \uFF09 \u3002\u91CD\u5B9A\u5411\u54CD\u5E94\u6307\u793A\u5BA2\u6237\u7AEF\u53D1\u9001\u4E00\u4E2A\u989D\u5916\u7684\u8BF7\u6C42\uFF0C\u8FD9\u6B21\u4F7F\u7528 HTTPS\uFF0C\u5230. \u5BF9\u4E8E\u7B2C\u4E8C\u4E2A\u8BF7\u6C42\uFF0C\u670D\u52A1\u5668\u8FD4\u56DE\u8BF7\u6C42\u7684\u5185\u5BB9\u548C"),aa,s("\u72B6\u6001\u7801\u3002"),ea]),ta]),pa,n("p",null,[s("\u5220\u9664\u60A8\u521B\u5EFA\u7684 Istio \u914D\u7F6E\u9879\u3001\u5173\u95ED"),n("a",la,[s("\u7761\u7720"),e(a)]),s("\u670D\u52A1\uFF1A")]),ia,n("p",null,[s("Istio \u4F7F\u7528"),n("a",oa,[s("\u5165\u53E3\u548C\u51FA\u53E3\u7F51\u5173"),e(a)]),s(" \u6765\u914D\u7F6E\u5728\u670D\u52A1\u7F51\u683C\u8FB9\u7F18\u6267\u884C\u7684\u8D1F\u8F7D\u5747\u8861\u5668\u3002\u5165\u53E3\u7F51\u5173\u5141\u8BB8\u60A8\u5B9A\u4E49\u6240\u6709\u4F20\u5165\u6D41\u91CF\u6D41\u8FC7\u7684\u7F51\u683C\u7684\u5165\u53E3\u70B9\u3002\u51FA\u53E3\u7F51\u5173\u662F\u4E00\u4E2A\u5BF9\u79F0\u7684\u6982\u5FF5\uFF1B\u5B83\u5B9A\u4E49\u4E86\u7F51\u683C\u7684\u51FA\u53E3\u70B9\u3002\u51FA\u53E3\u7F51\u5173\u5141\u8BB8\u60A8\u5C06 Istio \u529F\u80FD\uFF08\u4F8B\u5982\u76D1\u63A7\u548C\u8DEF\u7531\u89C4\u5219\uFF09\u5E94\u7528\u4E8E\u9000\u51FA\u7F51\u683C\u7684\u6D41\u91CF\u3002")]),ca,ua,ra,n("p",null,[s("\u90E8\u7F72"),n("a",da,[s("sleep"),e(a)]),s("\u793A\u4F8B\u5E94\u7528\u7A0B\u5E8F\u4EE5\u7528\u4F5C\u53D1\u9001\u8BF7\u6C42\u7684\u6D4B\u8BD5\u6E90\u3002\u5982\u679C\u60A8 \u542F\u7528\u4E86"),n("a",ka,[s("\u81EA\u52A8 Sidecar \u6CE8\u5165"),e(a)]),s(" \uFF0C\u8BF7\u8FD0\u884C\u4EE5\u4E0B\u547D\u4EE4\u6765\u90E8\u7F72\u793A\u4F8B\u5E94\u7528\u7A0B\u5E8F\uFF1A")]),va,n("ol",ma,[n("li",null,[n("p",null,[n("a",ba,[s("\u901A\u8FC7\u5411http://edition.cnn.com/politics"),e(a)]),ha,s("\u53D1\u9001 HTTP \u8BF7\u6C42\u6765\u9A8C\u8BC1\u60A8\u7684\u5E94\u7528\u662F\u5426\u6B63\u786E\u3002")]),n("p",null,[s("\u8F93\u51FA\u5E94\u4E0E "),n("a",ga,[s("TLS Origination for Egress Traffic"),e(a)]),s("\u793A\u4F8B\u4E2D\u7684\u76F8\u540C\uFF0C\u4F46\u6CA1\u6709 TLS \u53D1\u8D77\u3002")])])]),ya,n("ol",fa,[n("li",null,[_a,s("\u4E3A"),n("em",null,[n("a",xa,[s("edition.cnn.com"),e(a)])]),s("\u521B\u5EFA\u4E00\u4E2A\u51FA\u53E3\uFF0C\u7AEF\u53E3 80\uFF0C\u5E76\u4E3A\u5B9A\u5411\u5230\u51FA\u53E3\u7F51\u5173\u7684\u6D41\u91CF\u521B\u5EFA\u4E00\u4E2A\u76EE\u6807\u89C4\u5219\u3002 "),Ta])]),qa,n("ol",wa,[n("li",null,[s("\u5C06 HTTP \u8BF7\u6C42\u91CD\u65B0\u53D1\u9001\u5230"),n("a",Sa,[s("http://edition.cnn.com/politics"),e(a)]),s("\u3002")])]),Pa,n("ol",Ia,[n("li",null,[Ea,n("p",null,[s("\u8BF7\u6CE8\u610F\uFF0C\u60A8\u4EC5\u5C06\u6D41\u91CF\u4ECE\u7AEF\u53E3 80 \u91CD\u5B9A\u5411\u5230\u51FA\u53E3\u7F51\u5173\u3002\u5230\u7AEF\u53E3 443 \u7684 HTTPS \u6D41\u91CF\u76F4\u63A5\u8F6C\u5230"),n("em",null,[n("a",$a,[s("edition.cnn.com"),e(a)])]),s("\u3002")])])]),Ca,n("ol",Ha,[n("li",null,[n("a",Na,[s("\u901A\u8FC7\u5411https://edition.cnn.com/politics"),e(a)]),Oa,s("\u53D1\u9001 HTTPS \u8BF7\u6C42\u6765\u9A8C\u8BC1\u60A8\u7684\u5E94\u7528\u662F\u5426\u6B63\u786E\u3002")])]),Ra,n("ol",La,[n("li",null,[Aa,s("\u4E3A"),n("em",null,[n("a",Va,[s("edition.cnn.com"),e(a)])]),s("\u521B\u5EFA\u4E00\u4E2A\u51FA\u53E3\u3001\u4E00\u4E2A\u76EE\u6807\u89C4\u5219\u548C\u4E00\u4E2A\u865A\u62DF\u670D\u52A1\uFF0C\u4EE5\u5F15\u5BFC\u6D41\u91CF\u901A\u8FC7\u51FA\u53E3\u7F51\u5173\u5E76\u4ECE\u51FA\u53E3\u7F51\u5173\u5230\u5916\u90E8\u670D\u52A1\u3002 "),Da])]),Ga,n("ol",Ma,[n("li",null,[n("a",Ua,[s("\u5411https://edition.cnn.com/politics"),e(a)]),s("\u53D1\u9001 HTTPS \u8BF7\u6C42\u3002\u8F93\u51FA\u5E94\u8BE5\u548C\u4EE5\u524D\u4E00\u6837\u3002")])]),ja])}const Ka=p(c,[["render",Fa],["__file","3.Istio\u7684\u6DF1\u5165\u6D45.html.vue"]]);export{Ka as default};
