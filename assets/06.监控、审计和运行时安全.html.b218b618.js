import{_ as o}from"./_plugin-vue_export-helper.cdc0426e.js";import{o as p,c as l,a as s,b as n,d as t,f as e,r as i}from"./app.ca0279c0.js";const c={},u=e('<h1 id="\u76D1\u63A7\u3001\u5BA1\u8BA1\u548C\u8FD0\u884C\u65F6\u5B89\u5168" tabindex="-1"><a class="header-anchor" href="#\u76D1\u63A7\u3001\u5BA1\u8BA1\u548C\u8FD0\u884C\u65F6\u5B89\u5168" aria-hidden="true">#</a> \u76D1\u63A7\u3001\u5BA1\u8BA1\u548C\u8FD0\u884C\u65F6\u5B89\u5168</h1><h3 id="\u4E3B\u8981\u5185\u5BB9" tabindex="-1"><a class="header-anchor" href="#\u4E3B\u8981\u5185\u5BB9" aria-hidden="true">#</a> \u4E3B\u8981\u5185\u5BB9</h3><p>\u2756 \u5206\u6790\u5BB9\u5668\u7CFB\u7EDF\u8C03\u7528\uFF1ASysdig</p><p>\u2756 \u76D1\u63A7\u5BB9\u5668\u8FD0\u884C\u65F6\uFF1AFalco</p><p>\u2756 Kubernetes \u5BA1\u8BA1\u65E5\u5FD7</p><h3 id="\u5206\u6790\u5BB9\u5668\u7CFB\u7EDF\u8C03\u7528-sysdig" tabindex="-1"><a class="header-anchor" href="#\u5206\u6790\u5BB9\u5668\u7CFB\u7EDF\u8C03\u7528-sysdig" aria-hidden="true">#</a> \u5206\u6790\u5BB9\u5668\u7CFB\u7EDF\u8C03\u7528\uFF1ASysdig</h3><h4 id="sysdig\u7B80\u4ECB" tabindex="-1"><a class="header-anchor" href="#sysdig\u7B80\u4ECB" aria-hidden="true">#</a> Sysdig\u7B80\u4ECB</h4><p>Sysdig\uFF1A\u4E00\u4E2A\u975E\u5E38\u5F3A\u5927\u7684\u7CFB\u7EDF\u76D1\u63A7\u3001\u5206\u6790\u548C\u6545\u969C\u6392\u67E5\u5DE5\u5177\u3002</p><p>\u6C47\u805A strace+tcpdump+htop+iftop+lsof \u5DE5\u5177\u529F\u80FD\u4E8E\u4E00\u8EAB\uFF01</p><p>sysdig \u9664\u4E86\u80FD\u83B7\u53D6\u7CFB\u7EDF\u8D44\u6E90\u5229\u7528\u7387\u3001\u8FDB\u7A0B\u3001\u7F51\u7EDC\u8FDE\u63A5\u3001\u7CFB\u7EDF\u8C03\u7528\u7B49\u4FE1\u606F\uFF0C \u8FD8\u5177\u5907\u4E86\u5F88\u5F3A\u7684\u5206\u6790\u80FD\u529B\uFF0C\u4F8B\u5982\uFF1A</p><ul><li><p>\u6309\u7167CPU\u4F7F\u7528\u7387\u5BF9\u8FDB\u7A0B\u6392\u5E8F</p></li><li><p>\u6309\u7167\u6570\u636E\u5305\u5BF9\u8FDB\u7A0B\u6392\u5E8F</p></li><li><p>\u6253\u5F00\u6700\u591A\u7684\u6587\u4EF6\u63CF\u8FF0\u7B26\u8FDB\u7A0B</p></li><li><p>\u67E5\u770B\u8FDB\u7A0B\u6253\u5F00\u4E86\u54EA\u4E9B\u6587\u4EF6</p></li><li><p>\u67E5\u770B\u8FDB\u7A0B\u7684HTTP\u8BF7\u6C42\u62A5\u6587</p></li><li><p>\u67E5\u770B\u673A\u5668\u4E0A\u5BB9\u5668\u5217\u8868\u53CA\u8D44\u6E90\u4F7F\u7528\u60C5\u51B5</p></li></ul>',11),r={href:"https://github.com/draios/sysdig",target:"_blank",rel:"noopener noreferrer"},d={href:"https://github.com/draios/sysdig/wiki",target:"_blank",rel:"noopener noreferrer"},k=e(`<p>sysdig \u901A\u8FC7\u5728\u5185\u6838\u7684\u9A71\u52A8\u6A21\u5757\u6CE8\u518C\u7CFB\u7EDF\u8C03\u7528\u7684 hook\uFF0C\u8FD9\u6837\u5F53\u6709\u7CFB \u7EDF\u8C03\u7528\u53D1\u751F\u548C\u5B8C\u6210\u7684\u65F6\u5019\uFF0C\u5B83\u4F1A\u628A\u7CFB\u7EDF\u8C03\u7528\u4FE1\u606F\u62F7\u8D1D\u5230\u7279\u5B9A\u7684 buffer\uFF0C\u7136\u540E\u7528\u6237\u6001\u7EC4\u4EF6\u5BF9\u6570\u636E\u4FE1\u606F\u5904\u7406\uFF08\u89E3\u538B\u3001\u89E3\u6790\u3001\u8FC7\u6EE4\u7B49\uFF09\uFF0C \u5E76\u6700\u7EC8\u901A\u8FC7 sysdig \u547D\u4EE4\u884C\u548C\u7528\u6237\u8FDB\u884C\u4EA4\u4E92\u3002</p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204151059040.png" alt="image-20220414220604964" style="zoom:80%;"><h4 id="\u5B89\u88C5sysdig" tabindex="-1"><a class="header-anchor" href="#\u5B89\u88C5sysdig" aria-hidden="true">#</a> \u5B89\u88C5sysdig</h4><p>\u5BFC\u5165sysdig\u7684repo\u6E90\uFF0C\u5B89\u88C5epel\u6E90\u3002</p><p>\u5B89\u88C5\u5B8Csysdig\u7684\u65F6\u5019\uFF0C\u9700\u8981\u66F4\u65B0\u4E00\u4E0B\u8F6F\u4EF6\u5305\uFF0C\u4F1A\u66F4\u65B0sysdig\uFF0C\u624D\u80FD\u52A0\u8F7D\u6A21\u5757\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># rpm --import https://s3.amazonaws.com/download.draios.com/DRAIOS-GPG-KEY.public </span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># curl -s -o /etc/yum.repos.d/draios.repo https://s3.amazonaws.com/download.draios.com/stable/rpm/draios.repo</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># yum install epel-release -y</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># yum install sysdig -y</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># yum update -y </span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># /usr/bin/sysdig-probe-loader # \u52A0\u8F7D\u9A71\u52A8\u6A21\u5757</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="sysdig\u5E38\u7528\u53C2\u6570" tabindex="-1"><a class="header-anchor" href="#sysdig\u5E38\u7528\u53C2\u6570" aria-hidden="true">#</a> sysdig\u5E38\u7528\u53C2\u6570</h4><p><code>-l, --list</code>\uFF1A\u5217\u51FA\u53EF\u7528\u4E8E\u8FC7\u6EE4\u548C\u8F93\u51FA\u7684\u5B57\u6BB5</p><p><code>-M</code> \uFF1A\u591A\u5C11\u79D2\u540E\u505C\u6B62\u6536\u96C6</p><p><code>-p</code> , --print= \uFF1A\u6307\u5B9A\u6253\u5370\u4E8B\u4EF6\u65F6\u4F7F\u7528\u7684\u683C\u5F0F</p><ul><li>\u4F7F\u7528-pc\u6216-pcontainer \u5BB9\u5668\u53CB\u597D\u7684\u683C\u5F0F</li><li>\u4F7F\u7528-pk\u6216-pkubernetes k8s\u53CB\u597D\u7684\u683C\u5F0F</li></ul><p><code>-c</code> \uFF1A\u6307\u5B9A\u5185\u7F6E\u5DE5\u5177\uFF0C\u53EF\u76F4\u63A5\u5B8C\u6210\u5177\u4F53\u7684\u6570\u636E\u805A\u5408\u3001\u5206\u6790\u5DE5\u4F5C</p><p><code>-w</code> \uFF1A\u4FDD\u5B58\u5230\u6587\u4EF6\u4E2D</p><p><code>-r</code> \uFF1A\u4ECE\u6587\u4EF6\u4E2D\u8BFB\u53D6</p><p>\u6267\u884Csysdig\u547D\u4EE4\uFF0C\u5B9E\u65F6\u8F93\u51FA\u5927\u91CF\u7CFB\u7EDF\u8C03\u7528\u3002</p><p>\u793A\u4F8B\uFF1A59509 23:59:19.023099531 0 kubelet (1738) &lt; epoll_ctl</p>`,16),m={href:"http://proc.name",target:"_blank",rel:"noopener noreferrer"},v={href:"http://evt.info",target:"_blank",rel:"noopener noreferrer"},b=e('<p><code>evt.num</code>\uFF1A \u9012\u589E\u7684\u4E8B\u4EF6\u53F7</p><p><code>evt.time</code>\uFF1A \u4E8B\u4EF6\u53D1\u751F\u7684\u65F6\u95F4</p><p><code>evt.cpu</code>\uFF1A \u4E8B\u4EF6\u88AB\u6355\u83B7\u65F6\u6240\u5728\u7684 CPU\uFF0C\u4E5F\u5C31\u662F\u7CFB\u7EDF\u8C03\u7528\u662F\u5728\u54EA\u4E2A CPU \u6267\u884C\u7684</p><p><code>proc.name</code>\uFF1A \u751F\u6210\u4E8B\u4EF6\u7684\u8FDB\u7A0B\u540D\u5B57</p><p><code>thread.tid</code>\uFF1A \u7EBF\u7A0B\u7684 id\uFF0C\u5982\u679C\u662F\u5355\u7EBF\u7A0B\u7684\u7A0B\u5E8F\uFF0C\u8FD9\u4E5F\u662F\u8FDB\u7A0B\u7684 pid</p><p><code>evt.dir</code>\uFF1A \u4E8B\u4EF6\u7684\u65B9\u5411\uFF08direction\uFF09\uFF0C&gt; \u4EE3\u8868\u8FDB\u5165\u4E8B\u4EF6\uFF0C&lt; \u4EE3\u8868\u9000\u51FA\u4E8B\u4EF6</p><p><code>evt.type</code>\uFF1A \u4E8B\u4EF6\u7684\u540D\u79F0\uFF0C\u6BD4\u5982 open\u3001stat\u7B49\uFF0C\u4E00\u822C\u662F\u7CFB\u7EDF\u8C03\u7528</p><p><code>evt.args</code>\uFF1A \u4E8B\u4EF6\u7684\u53C2\u6570\u3002\u5982\u679C\u662F\u7CFB\u7EDF\u8C03\u7528\uFF0C\u8FD9\u4E9B\u5BF9\u5E94\u7740\u7CFB\u7EDF\u8C03\u7528\u7684\u53C2\u6570</p><blockquote><p><strong>\u81EA\u5B9A\u4E49\u683C\u5F0F\u8F93\u51FA</strong>\uFF1A<code>sysdig -p &quot;user:%user.name time:%evt.time proc_name:%proc.name&quot;</code></p></blockquote><h4 id="sysdig\u8FC7\u6EE4" tabindex="-1"><a class="header-anchor" href="#sysdig\u8FC7\u6EE4" aria-hidden="true">#</a> sysdig\u8FC7\u6EE4</h4>',10),g={href:"http://fd.name",target:"_blank",rel:"noopener noreferrer"},q={href:"http://proc.id",target:"_blank",rel:"noopener noreferrer"},h={href:"http://proc.name",target:"_blank",rel:"noopener noreferrer"},y=s("li",null,"**evt\uFF1A**\u6839\u636E\u4E8B\u4EF6\u4FE1\u606F\u8FC7\u6EE4\uFF0C\u6BD4\u5982\u4E8B\u4EF6\u7F16\u53F7\u3001\u4E8B\u4EF6\u540D",-1),f=s("li",null,"**user\uFF1A**\u6839\u636E\u7528\u6237\u4FE1\u606F\u8FC7\u6EE4\uFF0C\u6BD4\u5982\u7528\u6237 id\u3001\u7528\u6237\u540D\u3001\u7528\u6237 home \u76EE\u5F55",-1),_=s("li",null,"**syslog\uFF1A**\u6839\u636E\u7CFB\u7EDF\u65E5\u5FD7\u8FC7\u6EE4\uFF0C\u6BD4\u5982\u65E5\u5FD7\u7684\u4E25\u91CD\u7A0B\u5EA6\u3001\u65E5\u5FD7\u7684\u5185\u5BB9",-1),x=s("li",null,"**container\uFF1A**\u6839\u636E\u5BB9\u5668\u4FE1\u606F\u8FC7\u6EE4\uFF0C\u6BD4\u5982\u5BB9\u5668ID\u3001\u5BB9\u5668\u540D\u79F0\u3001\u5BB9\u5668\u955C\u50CF",-1),R=s("p",null,"\u67E5\u770B\u5B8C\u6574\u8FC7\u6EE4\u5668\u5217\u8868\uFF1Asysdig -l",-1),P=s("p",null,"\u793A\u4F8B\uFF1A",-1),T=s("p",null,"1\u3001\u67E5\u770B\u4E00\u4E2A\u8FDB\u7A0B\u7684\u7CFB\u7EDF\u8C03\u7528",-1),A=s("p",null,"sysdig proc.name=kubelet",-1),I=s("p",null,"2\u3001\u67E5\u770B\u5EFA\u7ACBTCP\u8FDE\u63A5\u7684\u4E8B\u4EF6",-1),w=s("p",null,"sysdig evt.type=accept",-1),S=s("p",null,"3\u3001\u67E5\u770B/etc\u76EE\u5F55\u4E0B\u6253\u5F00\u7684\u6587\u4EF6\u63CF\u8FF0\u7B26",-1),z={href:"http://fd.name",target:"_blank",rel:"noopener noreferrer"},C=e('<p>4\u3001\u67E5\u770B\u5BB9\u5668\u7684\u7CFB\u7EDF\u8C03\u7528</p><p>sysdig -M 10 container.name=web</p><blockquote><p>\u6CE8\uFF1A\u8FD8\u652F\u6301\u8FD0\u7B97\u64CD\u4F5C\u7B26\uFF0C= \u3001!=\u3001&gt;=\u3001&gt;\u3001&lt;\u3001 &lt;=\u3001contains\u3001in \u3001exists\u3001and\u3001or\u3001not</p></blockquote><h4 id="chisels\u5DE5\u5177\u7BB1" tabindex="-1"><a class="header-anchor" href="#chisels\u5DE5\u5177\u7BB1" aria-hidden="true">#</a> Chisels\u5DE5\u5177\u7BB1</h4><p>**Chisels\uFF1A**\u5B9E\u7528\u7684\u5DE5\u5177\u7BB1\uFF0C\u4E00\u7EC4\u9884\u5B9A\u4E49\u7684\u529F\u80FD\u96C6\u5408\uFF0C\u7528\u6765\u5206\u6790\u7279\u5B9A\u7684\u573A\u666F\u3002</p><p><strong>sysdig \u2013cl</strong> \u5217\u51FA\u6240\u6709Chisels\uFF0C\u4EE5\u4E0B\u662F\u4E00\u4E9B\u5E38\u7528\u7684\uFF1A</p><ul><li>topprocs_cpu\uFF1A\u8F93\u51FA\u6309\u7167 CPU \u4F7F\u7528\u7387\u6392\u5E8F\u7684\u8FDB\u7A0B\u5217\u8868\uFF0C\u4F8B\u5982sysdig -c</li><li>topprocs_net\uFF1A\u8F93\u51FA\u8FDB\u7A0B\u4F7F\u7528\u7F51\u7EDCTOP</li><li>topprocs_file\uFF1A\u8FDB\u7A0B\u8BFB\u5199\u78C1\u76D8\u6587\u4EF6TOP</li><li>topfiles_bytes\uFF1A\u8BFB\u5199\u78C1\u76D8\u6587\u4EF6TOP</li><li>netstat\uFF1A\u5217\u51FA\u7F51\u7EDC\u7684\u8FDE\u63A5\u60C5\u51B5</li></ul><h4 id="\u5176\u4ED6\u5E38\u7528\u547D\u4EE4" tabindex="-1"><a class="header-anchor" href="#\u5176\u4ED6\u5E38\u7528\u547D\u4EE4" aria-hidden="true">#</a> \u5176\u4ED6\u5E38\u7528\u547D\u4EE4</h4><p>sysdig -c netstat sysdig -c ps sysdig -c lsof</p>',9),N=s("thead",null,[s("tr",null,[s("th"),s("th")])],-1),U=s("tr",null,[s("td",null,"\u7F51\u7EDC"),s("td",null,[n("# \u67E5\u770B\u4F7F\u7528\u7F51\u7EDC\u7684\u8FDB\u7A0B"),s("br"),n("TOP sysdig -c topprocs_net "),s("br"),n("# \u67E5\u770B\u5EFA\u7ACB\u8FDE\u63A5\u7684\u7AEF\u53E3 "),s("br"),n('sysdig -c fdcount_by fd.sport "evt.type=accept" -M 10 '),s("br"),n("# \u67E5\u770B\u5EFA\u7ACB\u8FDE\u63A5\u7684\u7AEF\u53E3 "),s("br"),n("sysdig -c fdbytes_by fd.sport "),s("br"),n("# \u67E5\u770B\u5EFA\u7ACB\u8FDE\u63A5\u7684IP "),s("br"),n('sysdig -c fdcount_by fd.cip "evt.type=accept" -M 10 '),s("br"),n("# \u67E5\u770B\u5EFA\u7ACB\u8FDE\u63A5\u7684IP "),s("br"),n("sysdig -c fdbytes_by fd.cip")])],-1),M=s("td",null,"\u786C\u76D8",-1),F=s("br",null,null,-1),E=s("br",null,null,-1),V=s("br",null,null,-1),O={href:"http://proc.name",target:"_blank",rel:"noopener noreferrer"},j=s("br",null,null,-1),D=s("br",null,null,-1),L=s("br",null,null,-1),K=s("br",null,null,-1),W=s("tr",null,[s("td",null,"CPU"),s("td",null,[n("# \u67E5\u770BCPU\u4F7F\u7528\u7387TOP "),s("br"),n("sysdig -c topprocs_cpu "),s("br"),n("# \u67E5\u770B\u5BB9\u5668CPU\u4F7F\u7528\u7387TOP "),s("br"),n("sysdig -pc -c topprocs_cpu container.name=web "),s("br"),n("sysdig -pc -c topprocs_cpu container.id=web")])],-1),Z=s("tr",null,[s("td",null,"\u5BB9\u5668"),s("td",null,[n("# \u67E5\u770B\u673A\u5668\u4E0A\u5BB9\u5668\u5217\u8868\u53CA\u8D44\u6E90\u4F7F\u7528\u60C5\u51B5 "),s("br"),n("csysdig \u2013vcontainers "),s("br"),n("# \u67E5\u770B\u5BB9\u5668\u8D44\u6E90\u4F7F\u7528TOP "),s("br"),n("sysdig -c topcontainers_cpu/topcontainers_net/topcontainers_file")])],-1),G=e('<h3 id="\u76D1\u63A7\u5BB9\u5668\u8FD0\u884C\u65F6-falco" tabindex="-1"><a class="header-anchor" href="#\u76D1\u63A7\u5BB9\u5668\u8FD0\u884C\u65F6-falco" aria-hidden="true">#</a> \u76D1\u63A7\u5BB9\u5668\u8FD0\u884C\u65F6\uFF1AFalco</h3><h4 id="falco\u7B80\u4ECB" tabindex="-1"><a class="header-anchor" href="#falco\u7B80\u4ECB" aria-hidden="true">#</a> Falco\u7B80\u4ECB</h4><p>Falco \u662F\u4E00\u4E2A Linux \u5B89\u5168\u5DE5\u5177\uFF0C\u5B83\u4F7F\u7528\u7CFB\u7EDF\u8C03\u7528\u6765\u4FDD\u62A4\u548C\u76D1\u63A7\u7CFB\u7EDF\u3002 Falco\u6700\u521D\u662F\u7531Sysdig\u5F00\u53D1\u7684\uFF0C\u540E\u6765\u52A0\u5165CNCF\u5B75\u5316\u5668\uFF0C\u6210\u4E3A\u9996\u4E2A\u52A0\u5165CNCF\u7684\u8FD0\u884C\u65F6\u5B89\u5168\u9879\u76EE\u3002</p><p>Falco\u63D0\u4F9B\u4E86\u4E00\u7EC4\u9ED8\u8BA4\u89C4\u5219\uFF0C\u53EF\u4EE5\u76D1\u63A7\u5185\u6838\u6001\u7684\u5F02\u5E38\u884C\u4E3A\uFF0C\u4F8B\u5982\uFF1A</p><ul><li>\u5BF9\u4E8E\u7CFB\u7EDF\u76EE\u5F55/etc, /usr/bin, /usr/sbin\u7684\u8BFB\u5199\u884C\u4E3A</li><li>\u6587\u4EF6\u6240\u6709\u6743\u3001\u8BBF\u95EE\u6743\u9650\u7684\u53D8\u66F4</li><li>\u4ECE\u5BB9\u5668\u6253\u5F00shell\u4F1A\u8BDD</li><li>\u5BB9\u5668\u751F\u6210\u65B0\u8FDB\u7A0B</li><li>\u7279\u6743\u5BB9\u5668\u542F\u52A8</li></ul>',5),H={href:"https://github.com/falcosecurity/falco",target:"_blank",rel:"noopener noreferrer"},B=e('<h4 id="falco\u67B6\u6784\u56FE" tabindex="-1"><a class="header-anchor" href="#falco\u67B6\u6784\u56FE" aria-hidden="true">#</a> Falco\u67B6\u6784\u56FE</h4><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204151059595.png" alt="image-20220414231953852" loading="lazy"></p><h4 id="\u5B89\u88C5falco" tabindex="-1"><a class="header-anchor" href="#\u5B89\u88C5falco" aria-hidden="true">#</a> \u5B89\u88C5falco</h4><p>falco\u914D\u7F6E\u6587\u4EF6\u76EE\u5F55\uFF1A/etc/falco</p><ul><li><code>falco.yaml</code> falco\u914D\u7F6E\u4E0E\u8F93\u51FA\u544A\u8B66\u901A\u77E5\u65B9\u5F0F</li><li><code>falco_rules.yaml</code> \u89C4\u5219\u6587\u4EF6\uFF0C\u9ED8\u8BA4\u5DF2\u7ECF\u5B9A\u4E49\u5F88\u591A\u5A01\u80C1\u573A\u666F</li><li><code>falco_rules.local.yaml</code> \u81EA\u5B9A\u4E49\u6269\u5C55\u89C4\u5219\u6587\u4EF6</li><li><code>k8s_audit_rules.yaml</code> K8s\u5BA1\u8BA1\u65E5\u5FD7\u89C4\u5219</li></ul>',5),J={href:"https://falco.org/zh/docs/installation",target:"_blank",rel:"noopener noreferrer"},Y=e(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># rpm --import https://falco.org/repo/falcosecurity-3672BA8F.asc</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># curl -s -o /etc/yum.repos.d/falcosecurity.repo https://falco.org/repo/falcosecurity-rpm.repo</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># yum install epel-release -y</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># yum update</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># yum install falco -y</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start falco</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable falco</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># touch abc /usr/sbin/</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># tail -f /var/log/messages</span>

Apr <span class="token number">15</span> 02:04:03 master01 falco: 02:04:03.052503851: Error File below /etc opened <span class="token keyword">for</span> writing <span class="token punctuation">(</span>user<span class="token operator">=</span>root <span class="token assign-left variable">user_loginuid</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">command</span><span class="token operator">=</span>touch abc /usr/sbin/ <span class="token assign-left variable">parent</span><span class="token operator">=</span>bash <span class="token assign-left variable">pcmdline</span><span class="token operator">=</span>bash <span class="token assign-left variable">file</span><span class="token operator">=</span>/etc/falco/abc <span class="token assign-left variable">program</span><span class="token operator">=</span>touch <span class="token assign-left variable">gparent</span><span class="token operator">=</span>sshd <span class="token assign-left variable">ggparent</span><span class="token operator">=</span>sshd <span class="token assign-left variable">gggparent</span><span class="token operator">=</span>systemd <span class="token assign-left variable">container_id</span><span class="token operator">=</span>host <span class="token assign-left variable">image</span><span class="token operator">=</span><span class="token operator">&lt;</span>NA<span class="token operator">&gt;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="falco\u544A\u8B66\u89C4\u5219" tabindex="-1"><a class="header-anchor" href="#falco\u544A\u8B66\u89C4\u5219" aria-hidden="true">#</a> falco\u544A\u8B66\u89C4\u5219</h4><p>\u544A\u8B66\u89C4\u5219\u793A\u4F8B\uFF08falco_rules.local.yaml\uFF09\uFF1A</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># vim falco_rules.local.yaml</span>
<span class="token punctuation">-</span> <span class="token key atrule">rule</span><span class="token punctuation">:</span> The program &quot;sudo&quot; is run in a container
  <span class="token key atrule">desc</span><span class="token punctuation">:</span> An event will trigger every time you run sudo in a container
  <span class="token key atrule">condition</span><span class="token punctuation">:</span> evt.type = execve and evt.dir=&lt; and container.id <span class="token tag">!=</span> host and proc.name = sudo
  <span class="token key atrule">output</span><span class="token punctuation">:</span> <span class="token string">&quot;Sudo run in container (user=%user.name %container.info parent=%proc.pname cmdline=%proc.cmdline)&quot;</span>
  <span class="token key atrule">priority</span><span class="token punctuation">:</span> ERROR
  <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>users<span class="token punctuation">,</span> container<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u53C2\u6570\u8BF4\u660E" tabindex="-1"><a class="header-anchor" href="#\u53C2\u6570\u8BF4\u660E" aria-hidden="true">#</a> \u53C2\u6570\u8BF4\u660E</h4><ul><li><code>rule</code>\uFF1A\u89C4\u5219\u540D\u79F0\uFF0C\u552F\u4E00</li><li><code>desc</code>\uFF1A\u89C4\u5219\u7684\u63CF\u8FF0</li><li><code>condition</code>\uFF1A \u6761\u4EF6\u8868\u8FBE\u5F0F</li><li><code>output</code>\uFF1A\u7B26\u5408\u6761\u4EF6\u4E8B\u4EF6\u7684\u8F93\u51FA\u683C\u5F0F</li><li><code>priority</code>\uFF1A\u544A\u8B66\u7684\u4F18\u5148\u7EA7</li><li><code>tags</code>\uFF1A\u672C\u6761\u89C4\u5219\u7684 tags \u5206\u7C7B</li></ul><h4 id="\u5A01\u80C1\u573A\u666F\u6D4B\u8BD5" tabindex="-1"><a class="header-anchor" href="#\u5A01\u80C1\u573A\u666F\u6D4B\u8BD5" aria-hidden="true">#</a> <strong>\u5A01\u80C1\u573A\u666F\u6D4B\u8BD5</strong></h4><p>1\u3001\u76D1\u63A7\u7CFB\u7EDF\u4E8C\u8FDB\u5236\u6587\u4EF6\u76EE\u5F55\u8BFB\u5199\uFF08\u9ED8\u8BA4\u89C4\u5219\uFF09</p><p>2\u3001\u76D1\u63A7\u6839\u76EE\u5F55\u6216\u8005/root\u76EE\u5F55\u5199\u5165\u6587\u4EF6\uFF08\u9ED8\u8BA4\u89C4\u5219\uFF09</p><p>3\u3001\u76D1\u63A7\u8FD0\u884C\u4EA4\u4E92\u5F0FShell\u7684\u5BB9\u5668\uFF08\u9ED8\u8BA4\u89C4\u5219\uFF09</p><p>4\u3001\u76D1\u63A7\u5BB9\u5668\u521B\u5EFA\u7684\u4E0D\u53EF\u4FE1\u4EFB\u8FDB\u7A0B\uFF08\u81EA\u5B9A\u4E49\u89C4\u5219\uFF09</p><p>\u9A8C\u8BC1\uFF1Atail -f /var/log/messages\uFF08\u544A\u8B66\u901A\u77E5\u9ED8\u8BA4\u8F93\u51FA\u5230\u6807\u51C6\u8F93\u51FA\u548C\u7CFB\u7EDF\u65E5\u5FD7\uFF09</p><p><strong>\u76D1\u63A7\u5BB9\u5668\u521B\u5EFA\u7684\u4E0D\u53EF\u4FE1\u4EFB\u8FDB\u7A0B\u89C4\u5219</strong></p><p>\u5728falco_rules.local.yaml\u6587\u4EF6\u6DFB\u52A0\uFF1A</p><p>condition\u8868\u8FBE\u5F0F\u89E3\u8BFB\uFF1A</p><ol><li><code>spawned_process</code> \u8FD0\u884C\u65B0\u8FDB\u7A0B</li><li><code>container</code> \u5BB9\u5668</li><li><code>container.image startswith nginx</code> \u4EE5nginx\u5F00\u5934\u7684\u5BB9\u5668\u955C\u50CF</li><li><code>not proc.name in (nginx)</code> \u4E0D\u5C5E\u4E8Enginx\u7684\u8FDB\u7A0B\u540D\u79F0\uFF08\u5141\u8BB8\u8FDB\u7A0B\u540D\u79F0\u5217\u8868\uFF09</li></ol><blockquote><p>\u91CD\u542Ffalco\u5E94\u7528\u65B0\u914D\u7F6E\u6587\u4EF6\uFF1A</p><p><code>systemctl restart falco</code></p></blockquote><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01 falco<span class="token punctuation">]</span><span class="token comment"># vim falco_rules.local.yaml</span>
<span class="token punctuation">-</span> <span class="token key atrule">rule</span><span class="token punctuation">:</span> Unauthorized process on nginx containers
  <span class="token key atrule">condition</span><span class="token punctuation">:</span> spawned_process and container and container.image startswith nginx and not proc.name in (nginx)
  <span class="token key atrule">desc</span><span class="token punctuation">:</span> test
  <span class="token key atrule">output</span><span class="token punctuation">:</span> <span class="token string">&quot;Unauthorized process on nginx containers (user=%user.name container_name=%container.name container_id=%container.id image=%container.image.repository shell=%proc.name parent=%proc.pname cmdline=%proc.cmdline terminal=%proc.tty)&quot;</span>
  <span class="token key atrule">priority</span><span class="token punctuation">:</span> WARNING
  <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>container<span class="token punctuation">]</span>
  

<span class="token punctuation">[</span>root@master01 falco<span class="token punctuation">]</span><span class="token comment"># systemctl restart falco</span>
<span class="token punctuation">[</span>root@master01 falco<span class="token punctuation">]</span><span class="token comment"># journalctl -u falco -f  </span>
<span class="token punctuation">-</span><span class="token punctuation">-</span> Logs begin at Thu 2022<span class="token punctuation">-</span>04<span class="token punctuation">-</span>14 14<span class="token punctuation">:</span>39<span class="token punctuation">:</span>00 UTC. <span class="token punctuation">-</span><span class="token punctuation">-</span>
Apr 15 02<span class="token punctuation">:</span>38<span class="token punctuation">:</span>05 master01 systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token key atrule">Stopped Falco</span><span class="token punctuation">:</span> Container Native Runtime Security.
Apr 15 02<span class="token punctuation">:</span>38<span class="token punctuation">:</span>05 master01 systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token key atrule">Starting Falco</span><span class="token punctuation">:</span> Container Native Runtime Security<span class="token punctuation">...</span>
Apr 15 02<span class="token punctuation">:</span>38<span class="token punctuation">:</span>05 master01 systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token key atrule">Started Falco</span><span class="token punctuation">:</span> Container Native Runtime Security.
Apr 15 02<span class="token punctuation">:</span>38<span class="token punctuation">:</span>05 master01 falco<span class="token punctuation">[</span><span class="token number">116163</span><span class="token punctuation">]</span><span class="token punctuation">:</span> Falco version 0.31.1 (driver version b7eb0dd65226a8dc254d228c8d950d07bf3521d2)
Apr 15 02<span class="token punctuation">:</span>38<span class="token punctuation">:</span>05 master01 falco<span class="token punctuation">[</span><span class="token number">116163</span><span class="token punctuation">]</span><span class="token punctuation">:</span> Falco initialized with configuration file /etc/falco/falco.yaml
Apr 15 02<span class="token punctuation">:</span>38<span class="token punctuation">:</span>05 master01 falco<span class="token punctuation">[</span><span class="token number">116163</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token key atrule">Loading rules from file /etc/falco/falco_rules.yaml</span><span class="token punctuation">:</span>
Apr 15 02<span class="token punctuation">:</span>38<span class="token punctuation">:</span>05 master01 falco<span class="token punctuation">[</span><span class="token number">116163</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token key atrule">Loading rules from file /etc/falco/falco_rules.local.yaml</span><span class="token punctuation">:</span>
Apr 15 02<span class="token punctuation">:</span>38<span class="token punctuation">:</span>06 master01 falco<span class="token punctuation">[</span><span class="token number">116163</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token key atrule">Loading rules from file /etc/falco/k8s_audit_rules.yaml</span><span class="token punctuation">:</span>
Apr 15 02<span class="token punctuation">:</span>38<span class="token punctuation">:</span>07 master01 falco<span class="token punctuation">[</span><span class="token number">116163</span><span class="token punctuation">]</span><span class="token punctuation">:</span> Starting internal webserver<span class="token punctuation">,</span> listening on port 8765
Apr 15 02<span class="token punctuation">:</span>38<span class="token punctuation">:</span>07 master01 falco<span class="token punctuation">[</span><span class="token number">116163</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token key atrule">02:38:07.523070816</span><span class="token punctuation">:</span> Informational Privileged container started (user=&lt;NA<span class="token punctuation">&gt;</span> user_loginuid=0 command=container<span class="token punctuation">:</span>8ab8ea9eb331 kube<span class="token punctuation">-</span>proxy (id=8ab8ea9eb331) image=registry.aliyuncs.com/google_containers/kube<span class="token punctuation">-</span>proxy<span class="token punctuation">:</span>v1.22.1)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u521B\u5EFAcontainer\u5BB9\u5668\u4E4B\u540E\u89E6\u53D1falco</p><ol><li>\u7B2C\u4E00\u6B21\u521B\u5EFA<code>nginx</code>\u7684<code>container</code>\u7684\u65F6\u5019\u8F93\u5165\u521B\u5EFA</li><li>\u7B2C\u4E8C\u6B21\u4F7F\u7528tail\u67E5\u770B\u65E5\u5FD7\uFF0C\u89E6\u53D1<code>faclo</code>\u6709\u8F93\u51FA<code>shell=tail</code>\u5B57\u6BB5</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01 falco<span class="token punctuation">]</span><span class="token comment"># docker run -d nginx </span>
801e315438d5e62c0d02eff444df9b17a9e7d635061e85037df56be9eaa02c4d

<span class="token punctuation">[</span>root@master01 falco<span class="token punctuation">]</span><span class="token comment"># tail -f /var/log/messages</span>
Apr <span class="token number">15</span> 02:39:34 master01 falco: 02:39:34.313610957: Warning Unauthorized process on nginx containers <span class="token punctuation">(</span>user<span class="token operator">=</span>root <span class="token assign-left variable">container_name</span><span class="token operator">=</span>cool_heisenberg <span class="token assign-left variable">container_id</span><span class="token operator">=</span>801e315438d5 <span class="token assign-left variable">image</span><span class="token operator">=</span>nginx <span class="token assign-left variable">shell</span><span class="token operator">=</span>md5sum <span class="token assign-left variable">parent</span><span class="token operator">=</span><span class="token number">10</span>-listen-on-ip <span class="token assign-left variable">cmdline</span><span class="token operator">=</span>md5sum <span class="token parameter variable">-c</span> - <span class="token assign-left variable">terminal</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
Apr <span class="token number">15</span> 02:39:34 master01 falco: 02:39:34.319772871: Warning Unauthorized process on nginx containers <span class="token punctuation">(</span>user<span class="token operator">=</span>root <span class="token assign-left variable">container_name</span><span class="token operator">=</span>cool_heisenberg <span class="token assign-left variable">container_id</span><span class="token operator">=</span>801e315438d5 <span class="token assign-left variable">image</span><span class="token operator">=</span>nginx <span class="token assign-left variable">shell</span><span class="token operator">=</span>sed <span class="token assign-left variable">parent</span><span class="token operator">=</span><span class="token number">10</span>-listen-on-ip <span class="token assign-left variable">cmdline</span><span class="token operator">=</span>sed <span class="token parameter variable">-i</span> <span class="token parameter variable">-E</span> s,listen       <span class="token number">80</span><span class="token punctuation">;</span>,listen       <span class="token number">80</span><span class="token punctuation">;</span><span class="token punctuation">\\</span>n    listen  <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:80<span class="token punctuation">;</span>, /etc/nginx/conf.d/default.conf <span class="token assign-left variable">terminal</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token punctuation">[</span>root@master01 falco<span class="token punctuation">]</span><span class="token comment"># docker exec -it 801e315438d5 tail /var/log/nginx/access.log </span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># tail -f /var/log/messages</span>
Apr <span class="token number">15</span> 02:43:33 master01 falco: 02:43:33.449344235: Warning Unauthorized process on nginx containers <span class="token punctuation">(</span>user<span class="token operator">=</span>root <span class="token assign-left variable">container_name</span><span class="token operator">=</span>cool_heisenberg <span class="token assign-left variable">container_id</span><span class="token operator">=</span>801e315438d5 <span class="token assign-left variable">image</span><span class="token operator">=</span>nginx <span class="token assign-left variable">shell</span><span class="token operator">=</span>tail <span class="token assign-left variable">parent</span><span class="token operator">=</span>runc <span class="token assign-left variable">cmdline</span><span class="token operator">=</span>tail /var/log/nginx/access.log <span class="token assign-left variable">terminal</span><span class="token operator">=</span><span class="token number">34816</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="falco\u8F93\u51FA\u65B9\u5F0F" tabindex="-1"><a class="header-anchor" href="#falco\u8F93\u51FA\u65B9\u5F0F" aria-hidden="true">#</a> Falco\u8F93\u51FA\u65B9\u5F0F</h4><p><strong>Falco\u652F\u6301\u4E94\u79CD\u8F93\u51FA\u544A\u8B66\u901A\u77E5\u7684\u65B9\u5F0F\uFF1A</strong></p><ol><li>\u8F93\u51FA\u5230\u6807\u51C6\u8F93\u51FA\uFF08\u9ED8\u8BA4\u542F\u7528\uFF09</li><li>\u8F93\u51FA\u5230\u6587\u4EF6</li><li>\u8F93\u51FA\u5230Syslog\uFF08\u9ED8\u8BA4\u542F\u7528\uFF09</li><li>\u8F93\u51FA\u5230HTTP\u670D\u52A1</li><li>\u8F93\u51FA\u5230\u5176\u4ED6\u7A0B\u5E8F\uFF08\u547D\u4EE4\u884C\u7BA1\u9053\u65B9\u5F0F\uFF09</li></ol><p>\u544A\u8B66\u914D\u7F6E\u6587\u4EF6\uFF1A<code>/etc/falco/falco.yaml</code></p><p>\u4F8B\u5982\u8F93\u51FA\u5230\u6307\u5B9A\u6587\u4EF6\uFF0C\u4F7F\u7528json\u683C\u5F0F\uFF1A</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01 falco<span class="token punctuation">]</span><span class="token comment"># vim falco.yaml </span>
<span class="token key atrule">json_output</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
\xB7\xB7\xB7
<span class="token key atrule">syslog_output</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
\xB7\xB7\xB7
<span class="token key atrule">file_output</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">keep_alive</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">filename</span><span class="token punctuation">:</span> /var/log/falco_events.log
\xB7\xB7\xB7
<span class="token key atrule">stdout_output</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  
<span class="token punctuation">[</span>root@master01 falco<span class="token punctuation">]</span><span class="token comment"># systemctl restart falco </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="falco\u544A\u8B66\u96C6\u4E2D\u5316\u5C55\u793A" tabindex="-1"><a class="header-anchor" href="#falco\u544A\u8B66\u96C6\u4E2D\u5316\u5C55\u793A" aria-hidden="true">#</a> Falco\u544A\u8B66\u96C6\u4E2D\u5316\u5C55\u793A</h4><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204151059354.png" alt="image-20220415010916499" loading="lazy"></p><p>\u2022 FalcoSideKick\uFF1A\u4E00\u4E2A\u96C6\u4E2D\u6536\u96C6\u5E76\u6307\u5B9A\u8F93\u51FA\uFF0C\u652F\u6301\u5927\u91CF\u65B9\u5F0F\u8F93\u51FA\uFF0C\u4F8B\u5982Influxdb\u3001Elasticsearch\u7B49</p>`,30),Q={href:"https://github.com/falcosecurity/falcosidekick",target:"_blank",rel:"noopener noreferrer"},X=s("p",null,"\u2022 FalcoSideKick-UI\uFF1A\u544A\u8B66\u901A\u77E5\u96C6\u4E2D\u56FE\u5F62\u5C55\u793A\u7CFB\u7EDF",-1),$={href:"https://github.com/falcosecurity/falcosidekick-ui",target:"_blank",rel:"noopener noreferrer"},ss=e(`<h4 id="\u90E8\u7F72falco-ui" tabindex="-1"><a class="header-anchor" href="#\u90E8\u7F72falco-ui" aria-hidden="true">#</a> \u90E8\u7F72Falco UI</h4><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01 falco<span class="token punctuation">]</span><span class="token comment"># docker run -d \\</span>
<span class="token parameter variable">-p</span> <span class="token number">2801</span>:2801 <span class="token punctuation">\\</span>
<span class="token parameter variable">--name</span> falcosidekick <span class="token punctuation">\\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">WEBUI_URL</span><span class="token operator">=</span>http://10.11.121.118:2802 <span class="token punctuation">\\</span>
falcosecurity/falcosidekick

<span class="token punctuation">[</span>root@master01 falco<span class="token punctuation">]</span><span class="token comment"># docker run -d \\</span>
<span class="token parameter variable">-p</span> <span class="token number">2802</span>:2802 <span class="token punctuation">\\</span>
<span class="token parameter variable">--name</span> falcosidekick-ui <span class="token punctuation">\\</span>
falcosecurity/falcosidekick-ui 

<span class="token punctuation">[</span>root@master01 falco<span class="token punctuation">]</span><span class="token comment"># docker ps </span>
CONTAINER ID   IMAGE                            COMMAND                  CREATED          STATUS          PORTS                                       NAMES
9663f92ade3a   falcosecurity/falcosidekick-ui   <span class="token string">&quot;./falcosidekick-ui&quot;</span>     <span class="token number">6</span> minutes ago    Up <span class="token number">6</span> minutes    <span class="token number">0.0</span>.0.0:2802-<span class="token operator">&gt;</span><span class="token number">2802</span>/tcp, :::2802-<span class="token operator">&gt;</span><span class="token number">2802</span>/tcp   falcosidekick-ui
80c5d162842f   falcosecurity/falcosidekick      <span class="token string">&quot;./falcosidekick&quot;</span>        <span class="token number">7</span> minutes ago    Up <span class="token number">7</span> minutes    <span class="token number">0.0</span>.0.0:2801-<span class="token operator">&gt;</span><span class="token number">2801</span>/tcp, :::2801-<span class="token operator">&gt;</span><span class="token number">2801</span>/tcp   falcosidekick
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4FEE\u6539falco\u914D\u7F6E\u6587\u4EF6\u6307\u5B9Ahttp\u65B9\u5F0F\u8F93\u51FA\uFF1A</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01 falco<span class="token punctuation">]</span><span class="token comment"># vim falco.yaml </span>
<span class="token key atrule">json_output</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">json_include_output_property</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">http_output</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">&quot;http://10.11.121.118:2801/&quot;</span>
  
<span class="token punctuation">[</span>root@master01 falco<span class="token punctuation">]</span><span class="token comment"># systemctl restart falco</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,4),ns={href:"http://10.11.121.118:2802/ui/",target:"_blank",rel:"noopener noreferrer"},as=e('<p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204151058161.png" alt="image-20220415105834715" loading="lazy"></p><h3 id="kubernetes-\u5BA1\u8BA1\u65E5\u5FD7" tabindex="-1"><a class="header-anchor" href="#kubernetes-\u5BA1\u8BA1\u65E5\u5FD7" aria-hidden="true">#</a> Kubernetes \u5BA1\u8BA1\u65E5\u5FD7</h3><h4 id="\u4EC0\u4E48\u662F\u5BA1\u8BA1\u65E5\u5FD7" tabindex="-1"><a class="header-anchor" href="#\u4EC0\u4E48\u662F\u5BA1\u8BA1\u65E5\u5FD7" aria-hidden="true">#</a> \u4EC0\u4E48\u662F\u5BA1\u8BA1\u65E5\u5FD7\uFF1F</h4><p>\u5728Kubernetes\u96C6\u7FA4\u4E2D\uFF0CAPI Server\u7684\u5BA1\u8BA1\u65E5\u5FD7\u8BB0\u5F55\u4E86\u54EA\u4E9B\u7528\u6237\u3001\u54EA\u4E9B\u670D\u52A1\u8BF7\u6C42\u64CD\u4F5C\u96C6\u7FA4\u8D44\u6E90\uFF0C\u5E76\u4E14\u53EF\u4EE5\u7F16\u5199\u4E0D\u540C\u89C4\u5219\uFF0C \u63A7\u5236\u5FFD\u7565\u3001\u5B58\u50A8\u7684\u64CD\u4F5C\u65E5\u5FD7\u3002 \u5BA1\u8BA1\u65E5\u5FD7\u91C7\u7528JSON\u683C\u5F0F\u8F93\u51FA\uFF0C\u6BCF\u6761\u65E5\u5FD7\u90FD\u5305\u542B\u4E30\u5BCC\u7684\u5143\u6570\u636E\uFF0C\u4F8B\u5982\u8BF7\u6C42\u7684URL\u3001HTTP\u65B9\u6CD5\u3001\u5BA2\u6237\u7AEF\u6765\u6E90\u7B49\uFF0C\u4F60\u53EF\u4EE5\u4F7F \u7528\u76D1\u63A7\u670D\u52A1\u6765\u5206\u6790API\u6D41\u91CF\uFF0C\u4EE5\u68C0\u6D4B\u8D8B\u52BF\u6216\u53EF\u80FD\u5B58\u5728\u7684\u5B89\u5168\u9690\u60A3\u3002</p><p>\u8FD9\u4E9B\u53EF\u80FD\u670D\u52A1\u4F1A\u8BBF\u95EEAPI Server\uFF1A</p><ul><li><strong>\u7BA1\u7406\u8282\u70B9</strong>\uFF08controller-manager\u3001scheduler\uFF09</li><li><strong>\u5DE5\u4F5C\u8282\u70B9</strong>\uFF08kubelet\u3001kube-proxy\uFF09</li><li><strong>\u96C6\u7FA4\u670D\u52A1</strong>\uFF08CoreDNS\u3001Calico\u3001HPA\u7B49\uFF09</li><li>kubectl\u3001API\u3001Dashboard</li></ul><h4 id="\u4E8B\u4EF6\u9636\u6BB5" tabindex="-1"><a class="header-anchor" href="#\u4E8B\u4EF6\u9636\u6BB5" aria-hidden="true">#</a> \u4E8B\u4EF6\u9636\u6BB5</h4><p>\u5F53\u5BA2\u6237\u7AEF\u5411 API Server\u53D1\u51FA\u8BF7\u6C42\u65F6\uFF0C\u8BE5\u8BF7\u6C42\u5C06\u7ECF\u5386\u4E00\u4E2A\u6216\u591A\u4E2A\u9636\u6BB5\uFF1A</p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204151058322.png" alt="image-20220414232402761" style="zoom:80%;"><table><thead><tr><th>\u9636\u6BB5</th><th>\u8BF4\u660E</th></tr></thead><tbody><tr><td>RequestReceived</td><td>\u5BA1\u6838\u5904\u7406\u7A0B\u5E8F\u5DF2\u6536\u5230\u8BF7\u6C42</td></tr><tr><td>ResponseStarted</td><td>\u5DF2\u53D1\u9001\u54CD\u5E94\u6807\u5934\uFF0C\u4F46\u5C1A\u672A\u53D1\u9001\u54CD\u5E94\u6B63\u6587</td></tr><tr><td>ResponseComplete</td><td>\u54CD\u5E94\u6B63\u6587\u5DF2\u5B8C\u6210\uFF0C\u4E0D\u518D\u53D1\u9001\u4EFB\u4F55\u5B57\u8282</td></tr><tr><td>Panic</td><td>\u5185\u90E8\u670D\u52A1\u5668\u51FA\u9519\uFF0C\u8BF7\u6C42\u672A\u5B8C\u6210</td></tr></tbody></table><h4 id="\u5BA1\u8BA1\u65E5\u5FD7\u7B56\u7565\u89C4\u5219" tabindex="-1"><a class="header-anchor" href="#\u5BA1\u8BA1\u65E5\u5FD7\u7B56\u7565\u89C4\u5219" aria-hidden="true">#</a> \u5BA1\u8BA1\u65E5\u5FD7\u7B56\u7565\u89C4\u5219</h4><p>Kubernetes\u5BA1\u6838\u7B56\u7565\u6587\u4EF6\u5305\u542B\u4E00\u7CFB\u5217\u89C4\u5219\uFF0C\u63CF\u8FF0\u4E86\u8BB0\u5F55\u65E5\u5FD7\u7684\u7EA7\u522B\uFF0C \u91C7\u96C6\u54EA\u4E9B\u65E5\u5FD7\uFF0C\u4E0D\u91C7\u96C6\u54EA\u4E9B\u65E5\u5FD7\u3002 \u89C4\u5219\u7EA7\u522B\u5982\u4E0B\u8868\u6240\u793A\uFF1A</p><table><thead><tr><th>\u7EA7\u522B</th><th>\u8BF4\u660E</th></tr></thead><tbody><tr><td>None</td><td>\u4E0D\u4E3A\u4E8B\u4EF6\u521B\u5EFA\u65E5\u5FD7\u6761\u76EE</td></tr><tr><td>Metadata</td><td>\u521B\u5EFA\u65E5\u5FD7\u6761\u76EE\u3002\u5305\u62EC\u5143\u6570\u636E\uFF0C\u4F46\u4E0D\u5305\u62EC\u8BF7\u6C42\u6B63\u6587\u6216\u54CD\u5E94\u6B63\u6587</td></tr><tr><td>Request</td><td>\u521B\u5EFA\u65E5\u5FD7\u6761\u76EE\u3002\u5305\u62EC\u5143\u6570\u636E\u548C\u8BF7\u6C42\u6B63\u6587\uFF0C\u4F46\u4E0D\u5305\u62EC\u54CD\u5E94\u6B63\u6587</td></tr><tr><td>RequestResponse</td><td>\u521B\u5EFA\u65E5\u5FD7\u6761\u76EE\u3002\u5305\u62EC\u5143\u6570\u636E\u3001\u8BF7\u6C42\u6B63\u6587\u548C\u54CD\u5E94\u6B63\u6587</td></tr></tbody></table>',13),ts={href:"https://kubernetes.io/zh/docs/tasks/debug-application-cluster/audit/",target:"_blank",rel:"noopener noreferrer"},es=e(`<h4 id="\u65E5\u5FD7\u683C\u5F0F\u793A\u4F8B" tabindex="-1"><a class="header-anchor" href="#\u65E5\u5FD7\u683C\u5F0F\u793A\u4F8B" aria-hidden="true">#</a> \u65E5\u5FD7\u683C\u5F0F\u793A\u4F8B</h4><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204151058490.png" alt="image-20220414232719211" loading="lazy"></p><h4 id="\u914D\u7F6E\u5BA1\u8BA1\u65E5\u5FD7" tabindex="-1"><a class="header-anchor" href="#\u914D\u7F6E\u5BA1\u8BA1\u65E5\u5FD7" aria-hidden="true">#</a> \u914D\u7F6E\u5BA1\u8BA1\u65E5\u5FD7</h4><p>\u5BA1\u8BA1\u65E5\u5FD7\u652F\u6301\u5199\u5165\u672C\u5730\u6587\u4EF6\u548CWebhook\uFF08\u53D1\u9001\u5230\u5916\u90E8HTTP API\uFF09\u4E24\u79CD\u65B9\u5F0F\u3002</p><p><strong>\u914D\u7F6E\u6D41\u7A0B\uFF1A</strong></p><ol><li>\u51C6\u5907\u914D\u7F6E\u6587\u4EF6\uFF08\u5BA1\u8BA1\u89C4\u5219\uFF09</li><li>\u542F\u7528\u51C6\u5165\u63A7\u5236\u5668</li><li>\u67E5\u770B\u65E5\u5FD7\u60C5\u51B5</li></ol><p><strong>\u542F\u7528\u5BA1\u8BA1\u65E5\u5FD7\u529F\u80FD\uFF1A</strong></p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204151058955.png" alt="image-20220415000552047" loading="lazy"></p><blockquote><p>\u6CE8\uFF1A\u9700\u8981\u4F7F\u7528hostpath\u6570\u636E\u5377\u5C06\u5BBF\u4E3B \u673A\u7B56\u7565\u6587\u4EF6\u548C\u65E5\u5FD7\u6587\u4EF6\u6302\u8F7D\u5230\u5BB9\u5668\u4E2D</p></blockquote><h5 id="_1-\u51C6\u5907\u914D\u7F6E\u6587\u4EF6" tabindex="-1"><a class="header-anchor" href="#_1-\u51C6\u5907\u914D\u7F6E\u6587\u4EF6" aria-hidden="true">#</a> 1.\u51C6\u5907\u914D\u7F6E\u6587\u4EF6</h5><p>\u5728<code>/etc/kubernetes/</code>\u4E0B\u521B\u5EFA<code>audit</code>\u76EE\u5F55</p><p>\u914D\u7F6E\u6587\u4EF6\u4E3A<code>audit-policy.yaml</code>\uFF0C\u51C6\u5165\u63A7\u5236\u5668\u9700\u8981\u6302\u8F7D\u8BE5\u76EE\u5F55\u7684\u6587\u4EF6\u3002</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># mkdir /etc/kubernetes/audit &amp;&amp; cd /etc/kubernetes/audit</span>
<span class="token punctuation">[</span>root@master01 audit<span class="token punctuation">]</span><span class="token comment"># cat audit-policy.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> audit.k8s.io/v1 <span class="token comment"># This is required.</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Policy
<span class="token key atrule">omitStages</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;RequestReceived&quot;</span>
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> RequestResponse
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> Metadata
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;pods/log&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pods/status&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> None
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;configmaps&quot;</span><span class="token punctuation">]</span>
      <span class="token key atrule">resourceNames</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;controller-leader&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> None
    <span class="token key atrule">users</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;system:kube-proxy&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;watch&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span> <span class="token comment"># core API group</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;endpoints&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;services&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> None
    <span class="token key atrule">userGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;system:authenticated&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">nonResourceURLs</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;/api*&quot;</span> <span class="token comment"># Wildcard matching.</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;/version&quot;</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> Request
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span> <span class="token comment"># core API group</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;configmaps&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">namespaces</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;kube-system&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> Metadata
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span> <span class="token comment"># core API group</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;secrets&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;configmaps&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> Request
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span> <span class="token comment"># core API group</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">&quot;extensions&quot;</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> Metadata
    <span class="token key atrule">omitStages</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;RequestReceived&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-\u542F\u7528\u51C6\u5165\u63A7\u5236\u5668" tabindex="-1"><a class="header-anchor" href="#_2-\u542F\u7528\u51C6\u5165\u63A7\u5236\u5668" aria-hidden="true">#</a> 2.\u542F\u7528\u51C6\u5165\u63A7\u5236\u5668</h5><p>\u5BA1\u8BA1\u65E5\u5FD7\u652F\u6301\u5199\u5165\u672C\u5730\u6587\u4EF6\u548CWebhook\uFF08\u53D1\u9001\u5230\u5916\u90E8HTTP API\uFF09\u4E24\u79CD\u65B9\u5F0F\u3002</p><p>\u542F\u7528\u5BA1\u8BA1\u65E5\u5FD7\u529F\u80FD\uFF1A</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># vi /etc/kubernetes/manifests/kube-apiserver.yaml</span>
\u2026
	<span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>audit<span class="token punctuation">-</span>policy<span class="token punctuation">-</span>file=/etc/kubernetes/audit/audit<span class="token punctuation">-</span>policy.yaml
	<span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>audit<span class="token punctuation">-</span>log<span class="token punctuation">-</span>path=/var/log/k8s_audit.log
	<span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>audit<span class="token punctuation">-</span>log<span class="token punctuation">-</span>maxage=30
	<span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>audit<span class="token punctuation">-</span>log<span class="token punctuation">-</span>maxbackup=10
	<span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>audit<span class="token punctuation">-</span>log<span class="token punctuation">-</span>maxsize=100
<span class="token punctuation">...</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/kubernetes/audit/audit<span class="token punctuation">-</span>policy.yaml
      <span class="token key atrule">name</span><span class="token punctuation">:</span> audit
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/k8s_audit.log
      <span class="token key atrule">name</span><span class="token punctuation">:</span> audit<span class="token punctuation">-</span>log
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> audit
    <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/kubernetes/audit/audit<span class="token punctuation">-</span>policy.yaml
    <span class="token key atrule">type</span><span class="token punctuation">:</span> File
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> audit<span class="token punctuation">-</span>log
    <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/log/k8s_audit.log
    <span class="token key atrule">type</span><span class="token punctuation">:</span> FileOrCreate

<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart kubelet </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-\u67E5\u770B\u65E5\u5FD7" tabindex="-1"><a class="header-anchor" href="#_3-\u67E5\u770B\u65E5\u5FD7" aria-hidden="true">#</a> 3.\u67E5\u770B\u65E5\u5FD7</h5><p>\u6D4B\u8BD5\u67E5\u770B\u5F53\u524D\u7684\u8D44\u6E90\u64CD\u4F5C\u65E5\u5FD7\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat  /var/log/k8s_audit.log</span>
\xB7\xB7\xB7
<span class="token punctuation">{</span><span class="token string">&quot;kind&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Event&quot;</span>,<span class="token string">&quot;apiVersion&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;audit.k8s.io/v1&quot;</span>,<span class="token string">&quot;level&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Metadata&quot;</span>,<span class="token string">&quot;auditID&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;a2fb8bdd-1289-4045-b0f4-ccbafe4416c8&quot;</span>,<span class="token string">&quot;stage&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;ResponseComplete&quot;</span>,<span class="token string">&quot;requestURI&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;/apis/discovery.k8s.io/v1/namespaces/default/endpointslices/kubernetes&quot;</span>,<span class="token string">&quot;verb&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;get&quot;</span>,<span class="token string">&quot;user&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;username&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;system:apiserver&quot;</span>,<span class="token string">&quot;uid&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;bb28e427-363f-4841-9925-7ae0f7af6c1d&quot;</span>,<span class="token string">&quot;groups&quot;</span>:<span class="token punctuation">[</span><span class="token string">&quot;system:masters&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token string">&quot;sourceIPs&quot;</span>:<span class="token punctuation">[</span><span class="token string">&quot;::1&quot;</span><span class="token punctuation">]</span>,<span class="token string">&quot;userAgent&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;kube-apiserver/v1.22.1 (linux/amd64) kubernetes/632ed30&quot;</span>,<span class="token string">&quot;objectRef&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;resource&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;endpointslices&quot;</span>,<span class="token string">&quot;namespace&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;default&quot;</span>,<span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;kubernetes&quot;</span>,<span class="token string">&quot;apiGroup&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;discovery.k8s.io&quot;</span>,<span class="token string">&quot;apiVersion&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;v1&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;responseStatus&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;metadata&quot;</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span>,<span class="token string">&quot;code&quot;</span>:200<span class="token punctuation">}</span>,<span class="token string">&quot;requestReceivedTimestamp&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;2022-04-14T16:13:56.054960Z&quot;</span>,<span class="token string">&quot;stageTimestamp&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;2022-04-14T16:13:56.056415Z&quot;</span>,<span class="token string">&quot;annotations&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;authorization.k8s.io/decision&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;allow&quot;</span>,<span class="token string">&quot;authorization.k8s.io/reason&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;kind&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Event&quot;</span>,<span class="token string">&quot;apiVersion&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;audit.k8s.io/v1&quot;</span>,<span class="token string">&quot;level&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Metadata&quot;</span>,<span class="token string">&quot;auditID&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;51e01b26-c275-4953-9472-efec1f8b0ca2&quot;</span>,<span class="token string">&quot;stage&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;ResponseComplete&quot;</span>,<span class="token string">&quot;requestURI&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;/apis/coordination.k8s.io/v1/namespaces/kube-node-lease/leases/master02?timeout=10s&quot;</span>,<span class="token string">&quot;verb&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;update&quot;</span>,<span class="token string">&quot;user&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;username&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;system:node:master02&quot;</span>,<span class="token string">&quot;groups&quot;</span>:<span class="token punctuation">[</span><span class="token string">&quot;system:nodes&quot;</span>,<span class="token string">&quot;system:authenticated&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token string">&quot;sourceIPs&quot;</span>:<span class="token punctuation">[</span><span class="token string">&quot;10.11.121.116&quot;</span><span class="token punctuation">]</span>,<span class="token string">&quot;userAgent&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;kubelet/v1.22.1 (linux/amd64) kubernetes/632ed30&quot;</span>,<span class="token string">&quot;objectRef&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;resource&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;leases&quot;</span>,<span class="token string">&quot;namespace&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;kube-node-lease&quot;</span>,<span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;master02&quot;</span>,<span class="token string">&quot;uid&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;b2b0fc89-4220-48ee-86c9-b08e8c283f94&quot;</span>,<span class="token string">&quot;apiGroup&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;coordination.k8s.io&quot;</span>,<span class="token string">&quot;apiVersion&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;v1&quot;</span>,<span class="token string">&quot;resourceVersion&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;921237&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;responseStatus&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;metadata&quot;</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span>,<span class="token string">&quot;code&quot;</span>:200<span class="token punctuation">}</span>,<span class="token string">&quot;requestReceivedTimestamp&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;2022-04-14T16:13:56.316392Z&quot;</span>,<span class="token string">&quot;stageTimestamp&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;2022-04-14T16:13:56.324183Z&quot;</span>,<span class="token string">&quot;annotations&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;authorization.k8s.io/decision&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;allow&quot;</span>,<span class="token string">&quot;authorization.k8s.io/reason&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_4-\u53EA\u8BB0\u5F55\u6307\u5B9A\u8D44\u6E90\u64CD\u4F5C\u65E5\u5FD7" tabindex="-1"><a class="header-anchor" href="#_4-\u53EA\u8BB0\u5F55\u6307\u5B9A\u8D44\u6E90\u64CD\u4F5C\u65E5\u5FD7" aria-hidden="true">#</a> 4.\u53EA\u8BB0\u5F55\u6307\u5B9A\u8D44\u6E90\u64CD\u4F5C\u65E5\u5FD7</h5><p>\u521B\u5EFA\u65E5\u5FD7\u6761\u76EE,\u5305\u62EC\u5143\u6570\u636E\uFF0C\u4F46\u4E0D\u5305\u62EC\u8BF7\u6C42\u6B63\u6587\u6216\u54CD\u5E94\u6B63\u6587\u652F\u6301\u8D44\u6E90\u5982\u4E0B\uFF1A</p><ul><li>pods</li><li>deployments</li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat  /etc/kubernetes/audit/audit-policy.yaml  </span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> audit.k8s.io/v1 <span class="token comment"># This is required.</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Policy
<span class="token key atrule">omitStages</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;RequestReceived&quot;</span>
<span class="token key atrule">rules</span><span class="token punctuation">:</span> 
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> None 
    <span class="token key atrule">users</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> system<span class="token punctuation">:</span>apiserver 
    <span class="token punctuation">-</span> system<span class="token punctuation">:</span>kube<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>manager
    <span class="token punctuation">-</span> system<span class="token punctuation">:</span>kube<span class="token punctuation">-</span>scheduler
    <span class="token punctuation">-</span> system<span class="token punctuation">:</span>kube<span class="token punctuation">-</span>proxy
    <span class="token punctuation">-</span> kubelet 
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> Metadata
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span> 
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;pods&quot;</span><span class="token punctuation">]</span> 
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">&quot;apps&quot;</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;deployments&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> None 

<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># ps -ef | grep kubelet </span>
root      72326  72272 10 16<span class="token punctuation">:</span>04 <span class="token punctuation">?</span>        00<span class="token punctuation">:</span>04<span class="token punctuation">:</span>02 kube<span class="token punctuation">-</span>apiserver <span class="token punctuation">-</span><span class="token punctuation">-</span>advertise<span class="token punctuation">-</span>address=10.11.121.118 

<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># kill -9 72326 </span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart kubelet </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u521B\u5EFA\u4E00\u4E2APod\u67E5\u770B\u5F53\u524D\u7684\u65E5\u5FD7\u60C5\u51B5\u3001\u4F7F\u7528jq\u8F6C\u6362\u4E3Ajson\u67E5\u770B\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl run  web-test-my-pod --image=nginx --image-pull-policy=IfNotPresent </span>
pod/web created
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat /var/log/k8s_audit.log  | grep web-test-my-pod </span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># echo &#39;{&quot;kind&quot;:&quot;Event&quot;,&quot;apiVersion&quot;:&quot;audit.k8s.io/v1&quot;,&quot;level&quot;:&quot;Metadata&quot;,&quot;auditID&quot;:&quot;53298e83-3e00-471a-80b0-e7f9fa721be9&quot;,&quot;stage&quot;:&quot;ResponseComplete&quot;,&quot;requestURI&quot;:&quot;/api/v1/namespaces/default/pods?fieldManager=kubectl-run&quot;,&quot;verb&quot;:&quot;create&quot;,&quot;user&quot;:{&quot;username&quot;:&quot;kubernetes-admin&quot;,&quot;groups&quot;:[&quot;system:masters&quot;,&quot;system:authenticated&quot;]},&quot;sourceIPs&quot;:[&quot;10.11.121.118&quot;],&quot;userAgent&quot;:&quot;kubectl/v1.23.5 (linux/amd64) kubernetes/c285e78&quot;,&quot;objectRef&quot;:{&quot;resource&quot;:&quot;pods&quot;,&quot;namespace&quot;:&quot;default&quot;,&quot;name&quot;:&quot;web-test-my-pod&quot;,&quot;apiVersion&quot;:&quot;v1&quot;},&quot;responseStatus&quot;:{&quot;metadata&quot;:{},&quot;code&quot;:201},&quot;requestReceivedTimestamp&quot;:&quot;2022-04-14T16:51:26.948369Z&quot;,&quot;stageTimestamp&quot;:&quot;2022-04-14T16:51:26.959232Z&quot;,&quot;annotations&quot;:{&quot;authorization.k8s.io/decision&quot;:&quot;allow&quot;,&quot;authorization.k8s.io/reason&quot;:&quot;&quot;,&quot;imagepolicywebhook.image-policy.k8s.io/failed-open&quot;:&quot;true&quot;}}&#39; | jq .</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;kind&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Event&quot;</span>,
  <span class="token string">&quot;apiVersion&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;audit.k8s.io/v1&quot;</span>,
  <span class="token string">&quot;level&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Metadata&quot;</span>,
  <span class="token string">&quot;auditID&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;53298e83-3e00-471a-80b0-e7f9fa721be9&quot;</span>,
  <span class="token string">&quot;stage&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;ResponseComplete&quot;</span>,
  <span class="token string">&quot;requestURI&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;/api/v1/namespaces/default/pods?fieldManager=kubectl-run&quot;</span>,
  <span class="token string">&quot;verb&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;create&quot;</span>,
  <span class="token string">&quot;user&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;username&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;kubernetes-admin&quot;</span>,
    <span class="token string">&quot;groups&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;system:masters&quot;</span>,
      <span class="token string">&quot;system:authenticated&quot;</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;sourceIPs&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;10.11.121.118&quot;</span>
  <span class="token punctuation">]</span>,
  <span class="token string">&quot;userAgent&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;kubectl/v1.23.5 (linux/amd64) kubernetes/c285e78&quot;</span>,
  <span class="token string">&quot;objectRef&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;resource&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pods&quot;</span>,
    <span class="token string">&quot;namespace&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;default&quot;</span>,
    <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;web-test-my-pod&quot;</span>,
    <span class="token string">&quot;apiVersion&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;v1&quot;</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;responseStatus&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;metadata&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>,
    <span class="token string">&quot;code&quot;</span><span class="token builtin class-name">:</span> <span class="token number">201</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;requestReceivedTimestamp&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2022-04-14T16:51:26.948369Z&quot;</span>,
  <span class="token string">&quot;stageTimestamp&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2022-04-14T16:51:26.959232Z&quot;</span>,
  <span class="token string">&quot;annotations&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;authorization.k8s.io/decision&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;allow&quot;</span>,
    <span class="token string">&quot;authorization.k8s.io/reason&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
    <span class="token string">&quot;imagepolicywebhook.image-policy.k8s.io/failed-open&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;true&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-\u5BA1\u8BA1\u65E5\u5FD7\u7EC3\u4E60" tabindex="-1"><a class="header-anchor" href="#_5-\u5BA1\u8BA1\u65E5\u5FD7\u7EC3\u4E60" aria-hidden="true">#</a> 5.\u5BA1\u8BA1\u65E5\u5FD7\u7EC3\u4E60</h5><p>\u7F16\u8F91\u548C\u6269\u5C55\u57FA\u672C\u7B56\u7565\u5230\u65E5\u5FD7\uFF1A</p><ol><li>\u547D\u540D\u7A7A\u95F4\u5728 RequestResponse \u7EA7\u522B\u66F4\u6539</li><li>PV \u7684\u8BF7\u6C42\u5185\u5BB9\u5728 front-apps \u547D\u540D\u7A7A\u95F4\u53D1\u751F\u4E86\u66F4\u6539</li><li>Configmap \u548C secret \u5728\u6240\u6709\u547D\u540D\u7A7A\u95F4 Metadata \u7EA7\u522B\u66F4\u6539</li><li>\u53E6\u5916\uFF0C\u6DFB\u52A0\u4E00\u4E2Acatch-all\u6765\u8BB0\u5F55\u5728Metadata \u7EA7\u522B\u7684\u6240\u6709\u8BF7\u6C42\u3002</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/kubernetes/audit/audit-policy.yaml </span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> audit.k8s.io/v1 <span class="token comment"># This is required.</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Policy
<span class="token key atrule">omitStages</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;RequestReceived&quot;</span>
<span class="token key atrule">rules</span><span class="token punctuation">:</span>  
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> RequestResponse   
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span> 
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;namespaces&quot;</span><span class="token punctuation">]</span> 
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> Request
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;persistentvolumes&quot;</span><span class="token punctuation">]</span>    
    <span class="token key atrule">namespaces</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;front-apps&quot;</span><span class="token punctuation">]</span> 
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> Metadata
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;secrets&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;configmaps&quot;</span><span class="token punctuation">]</span> 
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> Metadata
    <span class="token key atrule">omitStages</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;RequestReceived&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,30);function os(ps,ls){const a=i("ExternalLinkIcon");return p(),l("div",null,[u,s("p",null,[n("\u9879\u76EE\u5730\u5740\uFF1A"),s("a",r,[n("https://github.com/draios/sysdig"),t(a)])]),s("p",null,[n("\u6587\u6863\uFF1A"),s("a",d,[n("https://github.com/draios/sysdig/wiki"),t(a)])]),k,s("p",null,[n("\u683C\u5F0F\uFF1A%evt.num %evt.outputtime %evt.cpu %"),s("a",m,[n("proc.name"),t(a)]),n(" (%thread.tid) %evt.dir %evt.type %"),s("a",v,[n("evt.info"),t(a)])]),b,s("ol",null,[s("li",null,[n("**fd\uFF1A**\u6839\u636E\u6587\u4EF6\u63CF\u8FF0\u7B26\u8FC7\u6EE4\uFF0C\u6BD4\u5982 fd \u6807\u53F7\uFF08fd.num\uFF09\u3001fd \u540D\u5B57\uFF08"),s("a",g,[n("fd.name"),t(a)]),n("\uFF09")]),s("li",null,[n("**process\uFF1A**\u6839\u636E\u8FDB\u7A0B\u4FE1\u606F\u8FC7\u6EE4\uFF0C\u6BD4\u5982\u8FDB\u7A0B id\uFF08"),s("a",q,[n("proc.id"),t(a)]),n("\uFF09\u3001\u8FDB\u7A0B\u540D\uFF08"),s("a",h,[n("proc.name"),t(a)]),n("\uFF09")]),y,f,_,x]),R,P,T,A,I,w,S,s("p",null,[n("sysdig "),s("a",z,[n("fd.name"),t(a)]),n(" contains /etc")]),C,s("table",null,[N,s("tbody",null,[U,s("tr",null,[M,s("td",null,[n("# \u67E5\u770B\u8FDB\u7A0B\u78C1\u76D8I/O\u8BFB\u5199 "),F,n("sysdig -c topprocs_file "),E,n("# \u67E5\u770B\u8FDB\u7A0B\u6253\u5F00\u7684\u6587\u4EF6\u63CF\u8FF0\u7B26\u6570\u91CF "),V,n("sysdig -c fdcount_by "),s("a",O,[n("proc.name"),t(a)]),n(' "fd.type=file" -M 10 '),j,n("# \u67E5\u770B\u8BFB\u5199\u78C1\u76D8\u6587\u4EF6 "),D,n("sysdig -c topfiles_bytes sysdig -c topfiles_bytes proc.name=etcd "),L,n("# \u67E5\u770B/tmp\u76EE\u5F55\u8BFB\u5199\u78C1\u76D8\u6D3B\u52A8\u6587\u4EF6 "),K,n('sysdig -c fdbytes_by fd.filename "fd.directory=/tmp/"')])]),W,Z])]),G,s("p",null,[n("\u9879\u76EE\u5730\u5740\uFF1A"),s("a",H,[n("https://github.com/falcosecurity/falco"),t(a)])]),B,s("p",null,[n("\u5B89\u88C5\u6587\u6863\uFF1A"),s("a",J,[n("https://falco.org/zh/docs/installation"),t(a)])]),Y,s("p",null,[n("\u9879\u76EE\u5730\u5740 "),s("a",Q,[n("https://github.com/falcosecurity/falcosidekick"),t(a)])]),X,s("p",null,[n("\u9879\u76EE\u5730\u5740 "),s("a",$,[n("https://github.com/falcosecurity/falcosidekick-ui"),t(a)])]),ss,s("p",null,[n("UI\u8BBF\u95EE\u5730\u5740\uFF1A"),s("a",ns,[n("http://10.11.121.118:2802/ui/"),t(a)])]),as,s("p",null,[n("\u53C2\u8003\u8D44\u6599\uFF1A"),s("a",ts,[n("https://kubernetes.io/zh/docs/tasks/debug-application-cluster/audit/"),t(a)])]),es])}const us=o(c,[["render",os],["__file","06.\u76D1\u63A7\u3001\u5BA1\u8BA1\u548C\u8FD0\u884C\u65F6\u5B89\u5168.html.vue"]]);export{us as default};
