import{_ as o}from"./_plugin-vue_export-helper.cdc0426e.js";import{o as p,c as i,a as n,b as s,d as e,f as t,r as l}from"./app.ca0279c0.js";const c={},r=t(`<h1 id="\u4F9B\u5E94\u94FE\u5B89\u5168" tabindex="-1"><a class="header-anchor" href="#\u4F9B\u5E94\u94FE\u5B89\u5168" aria-hidden="true">#</a> \u4F9B\u5E94\u94FE\u5B89\u5168</h1><h3 id="\u4E3B\u8981\u5185\u5BB9" tabindex="-1"><a class="header-anchor" href="#\u4E3B\u8981\u5185\u5BB9" aria-hidden="true">#</a> \u4E3B\u8981\u5185\u5BB9</h3><p>\u2756 \u53EF\u4FE1\u4EFB\u8F6F\u4EF6\u4F9B\u5E94\u94FE\u6982\u8FF0</p><p>\u2756 \u6784\u5EFA\u955C\u50CFDockerfile\u6587\u4EF6\u4F18\u5316</p><p>\u2756 \u955C\u50CF\u6F0F\u6D1E\u626B\u63CF\u5DE5\u5177\uFF1ATrivy</p><p>\u2756 \u68C0\u67E5YAML\u6587\u4EF6\u5B89\u5168\u914D\u7F6E\uFF1Akubesec</p><p>\u2756 \u51C6\u5165\u63A7\u5236\u5668\uFF1A Admission Webhook</p><p>\u2756 \u51C6\u5165\u63A7\u5236\u5668\uFF1A ImagePolicyWebhook</p><h3 id="\u53EF\u4FE1\u4EFB\u8F6F\u4EF6\u4F9B\u5E94\u94FE\u6982\u8FF0" tabindex="-1"><a class="header-anchor" href="#\u53EF\u4FE1\u4EFB\u8F6F\u4EF6\u4F9B\u5E94\u94FE\u6982\u8FF0" aria-hidden="true">#</a> \u53EF\u4FE1\u4EFB\u8F6F\u4EF6\u4F9B\u5E94\u94FE\u6982\u8FF0</h3><p>\u53EF\u4FE1\u4EFB\u8F6F\u4EF6\u4F9B\u5E94\u94FE\uFF1A\u6307\u5728\u5EFA\u8BBE\u57FA\u7840\u67B6\u6784\u8FC7\u7A0B\u4E2D\uFF0C\u6D89\u53CA\u7684\u8F6F\u4EF6\u90FD\u662F\u53EF\u4FE1\u4EFB\u7684\u3002</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204151356279.png" alt="image-20220414122733589" loading="lazy"></p><h3 id="\u6784\u5EFA\u955C\u50CFdockerfile\u6587\u4EF6\u4F18\u5316" tabindex="-1"><a class="header-anchor" href="#\u6784\u5EFA\u955C\u50CFdockerfile\u6587\u4EF6\u4F18\u5316" aria-hidden="true">#</a> \u6784\u5EFA\u955C\u50CFDockerfile\u6587\u4EF6\u4F18\u5316</h3><ul><li>**\u51CF\u5C11\u955C\u50CF\u5C42\uFF1A**\u4E00\u6B21RUN\u6307\u4EE4\u5F62\u6210\u65B0\u7684\u4E00\u5C42\uFF0C\u5C3D\u91CFShell\u547D\u4EE4\u90FD\u5199\u5728\u4E00\u884C\uFF0C\u51CF\u5C11\u955C\u50CF\u5C42\u3002</li><li>**\u6E05\u7406\u65E0\u7528\u6587\u4EF6\uFF1A**\u6E05\u7406\u5BF9\u5E94\u7684\u6B8B\u7559\u6570\u636E\uFF0C\u4F8B\u5982yum\u7F13\u5B58\u3002</li><li>**\u6E05\u7406\u65E0\u7528\u7684\u8F6F\u4EF6\u5305\uFF1A**\u57FA\u7840\u955C\u50CF\u9ED8\u8BA4\u4F1A\u5E26\u4E00\u4E9Bdebug\u5DE5\u5177\uFF0C\u53EF\u4EE5\u5220\u9664\u6389\uFF0C\u4EC5\u4FDD\u7559\u5E94\u7528\u7A0B\u5E8F\u6240\u9700\u8F6F\u4EF6\uFF0C\u9632\u6B62\u9ED1\u5BA2\u5229\u7528\u3002</li><li>**\u9009\u62E9\u6700\u5C0F\u7684\u57FA\u7840\u955C\u50CF\uFF1A**\u4F8B\u5982alpine</li><li>**\u4F7F\u7528\u975Eroot\u7528\u6237\u8FD0\u884C\uFF1A**USER\u6307\u4EE4\u6307\u5B9A\u666E\u901A\u7528\u6237</li></ul><p>\u793A\u4F8B\uFF1A\u6784\u5EFApython web\u955C\u50CF</p><p>\u53C2\u6570\u5316\u6784\u5EFA\u5982\u4E0B\uFF1A</p><ol><li>\u4F7F\u7528\u4E86\u975Eroot\u7528\u6237\u8FD0\u884C\u955C\u50CF</li><li>\u4F7F\u7528\u4E86\u4E00\u4E2A\u955C\u50CF\u5C42\uFF0C\u5E76\u975E\u591A\u5C42</li></ol><div class="language-docker ext-docker line-numbers-mode"><pre class="language-docker"><code><span class="token instruction"><span class="token keyword">FROM</span> python</span>
<span class="token instruction"><span class="token keyword">RUN</span> useradd python</span>
<span class="token instruction"><span class="token keyword">RUN</span> mkdir /data/www -p</span>
<span class="token instruction"><span class="token keyword">COPY</span> . /data/www</span>
<span class="token instruction"><span class="token keyword">RUN</span> chown -R python /data</span>
<span class="token instruction"><span class="token keyword">RUN</span> pip install flask -i https://mirrors.aliyun.com/pypi/simple/ &amp;&amp; yum makecache </span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /data/www</span>
<span class="token instruction"><span class="token keyword">USER</span> python</span>
<span class="token instruction"><span class="token keyword">CMD</span> python main.py </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u955C\u50CF\u6F0F\u6D1E\u626B\u63CF\u5DE5\u5177-trivy" tabindex="-1"><a class="header-anchor" href="#\u955C\u50CF\u6F0F\u6D1E\u626B\u63CF\u5DE5\u5177-trivy" aria-hidden="true">#</a> \u955C\u50CF\u6F0F\u6D1E\u626B\u63CF\u5DE5\u5177\uFF1ATrivy</h3><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204141243326.png" alt="image-20220414124314141" loading="lazy"></p><p>Trivy\uFF1A\u662F\u4E00\u79CD\u7528\u4E8E\u5BB9\u5668\u955C\u50CF\u3001\u6587\u4EF6\u7CFB\u7EDF\u3001Git\u4ED3\u5E93\u7684\u6F0F\u6D1E\u626B\u63CF\u5DE5\u5177\u3002\u53D1\u73B0\u76EE\u6807\u8F6F\u4EF6\u5B58\u5728\u7684\u6F0F\u6D1E\u3002 Trivy\u6613\u4E8E\u4F7F\u7528\uFF0C\u53EA\u9700\u5B89\u88C5\u4E8C\u8FDB\u5236\u6587\u4EF6\u5373\u53EF\u8FDB\u884C\u626B\u63CF\uFF0C\u65B9\u4FBF\u96C6\u6210CI\u7CFB\u7EDF\u3002</p>`,20),u={href:"https://github.com/aquasecurity/trivy",target:"_blank",rel:"noopener noreferrer"},k=t(`<h4 id="\u5B89\u88C5trivy" tabindex="-1"><a class="header-anchor" href="#\u5B89\u88C5trivy" aria-hidden="true">#</a> \u5B89\u88C5Trivy</h4><p>\u5728\u5B98\u7F51\u4E0B\u8F7D\u4E8C\u8FDB\u5236\u7684\u6587\u4EF6\uFF0C\u79FB\u5230<code>/usr/local/bin/</code>\u4E0B</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># mv trivy /usr/local/bin </span>
<span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># trivy --version </span>
Version: <span class="token number">0.18</span>.3
Vulnerability DB:
  Type: Light
  Version: <span class="token number">1</span>
  UpdatedAt: <span class="token number">2022</span>-04-14 00:51:13.721973471 +0000 UTC
  NextUpdate: <span class="token number">2022</span>-04-14 06:51:13.721972971 +0000 UTC
  DownloadedAt: 0001-01-01 00:00:00 +0000 UTC
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u4E0B\u8F7D\u6570\u636E\u5E93\u8D85\u65F6\u89E3\u51B3" tabindex="-1"><a class="header-anchor" href="#\u4E0B\u8F7D\u6570\u636E\u5E93\u8D85\u65F6\u89E3\u51B3" aria-hidden="true">#</a> \u4E0B\u8F7D\u6570\u636E\u5E93\u8D85\u65F6\u89E3\u51B3</h4><p>\u5B89\u5168\u626B\u63CF\u901A\u5E38\u90FD\u9700\u8981\u4E0B\u8F7D\u5B89\u5168\u6F0F\u6D1E\u7684\u4E0B\u8F7D\u6570\u636E\u5E93\u6BD4\u8F83\u5B8C\u6574\u7684\u7248\u672C\u3002\u6570\u636E\u5E93\u901F\u5EA6\u5F88\u6162\u800C\u4E14\u4ECEgithub\u4E0B\u8F7D\u3002\u6240\u4EE5\u9700\u8981\u79BB\u7EBF\u3002</p>`,5),d={href:"https://github.com/aquasecurity/trivy-db/releases",target:"_blank",rel:"noopener noreferrer"},m=t(`<p>\u4E0B\u8F7D trivy-offline.db.tgz \u653E\u5728trivy cache\u76EE\u5F55\u3002\u9ED8\u8BA4\u7684cache\u76EE\u5F55\u7684\u4F4D\u7F6E\u4E0A</p><p>\u76EE\u5F55\uFF1A <code>/home/.cache/trivy/db</code></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># cp  trivy-offline.db.tgz .cache/trivy/db/ </span>
<span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># cd .cache/trivy/db/ </span>
<span class="token punctuation">[</span>root@master01:~/.cache/trivy/db<span class="token punctuation">]</span> <span class="token comment"># tar zxvf trivy-offline.db.tgz &amp;&amp; rm -rf trivy-offline.db.tgz</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="trivy\u4F7F\u7528" tabindex="-1"><a class="header-anchor" href="#trivy\u4F7F\u7528" aria-hidden="true">#</a> Trivy\u4F7F\u7528</h4><p><strong>1.\u5BB9\u5668\u955C\u50CF\u626B\u63CF</strong></p><p>\u4E5F\u53EF\u4EE5\u6307\u5B9Atar\u4F7F\u7528<code>trivy image -i nginx.tar</code></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># trivy image nginx</span>

+---------------------+------------------+----------+--------------------+-------------------------+-----------------------------------------+
<span class="token operator">|</span> zlib1g              <span class="token operator">|</span> CVE-2018-25032   <span class="token operator">|</span> HIGH     <span class="token operator">|</span> <span class="token number">1</span>:1.2.11.dfsg-2    <span class="token operator">|</span> <span class="token number">1</span>:1.2.11.dfsg-2+deb11u1 <span class="token operator">|</span> zlib: A flaw found <span class="token keyword">in</span>                   <span class="token operator">|</span>
<span class="token operator">|</span>                     <span class="token operator">|</span>                  <span class="token operator">|</span>          <span class="token operator">|</span>                    <span class="token operator">|</span>                         <span class="token operator">|</span> zlib v1.2.2.2 through zlib              <span class="token operator">|</span>
<span class="token operator">|</span>                     <span class="token operator">|</span>                  <span class="token operator">|</span>          <span class="token operator">|</span>                    <span class="token operator">|</span>                         <span class="token operator">|</span> v1.2.11 when compressing<span class="token punctuation">..</span>.             <span class="token operator">|</span>
<span class="token operator">|</span>                     <span class="token operator">|</span>                  <span class="token operator">|</span>          <span class="token operator">|</span>                    <span class="token operator">|</span>                         <span class="token operator">|</span> --<span class="token operator">&gt;</span>avd.aquasec.com/nvd/cve-2018-25032   <span class="token operator">|</span>
+---------------------+------------------+----------+--------------------+-------------------------+-----------------------------------------+
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2. \u6253\u5370\u6307\u5B9A\uFF08\u9AD8\u5371\u3001\u4E25\u91CD\uFF09\u6F0F\u6D1E\u4FE1\u606F</strong></p><p>\u53EF\u4EE5\u901A\u8FC7-s \u53C2\u6570\u6307\u5B9A\u662F\u9AD8\u5371\u6F0F\u6D1E\u8FD8\u662F\u4E25\u91CD\u6F0F\u6D1E</p><p><code>HIGH</code> \u662F\u9AD8\u5371\u6F0F\u6D1E</p><p><code>CRITICAL</code> \u662F\u4E25\u91CD\u6F0F\u6D1E</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span> <span class="token comment"># trivy image -s HIGH,CRITICAL nginx </span>
<span class="token number">2022</span>-04-14T13:38:38.566+0800    INFO    Detected OS: debian
<span class="token number">2022</span>-04-14T13:38:38.567+0800    INFO    Detecting Debian vulnerabilities<span class="token punctuation">..</span>.
<span class="token number">2022</span>-04-14T13:38:38.579+0800    INFO    Number of PL dependency files: <span class="token number">1</span>
<span class="token number">2022</span>-04-14T13:38:38.579+0800    INFO    Detecting jar vulnerabilities<span class="token punctuation">..</span>.

nginx <span class="token punctuation">(</span>debian <span class="token number">11.2</span><span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
Total: <span class="token number">76</span> <span class="token punctuation">(</span>HIGH: <span class="token number">57</span>, CRITICAL: <span class="token number">19</span><span class="token punctuation">)</span>

+---------------------+------------------+----------+--------------------+-------------------------+-----------------------------------------+
<span class="token operator">|</span>       LIBRARY       <span class="token operator">|</span> VULNERABILITY ID <span class="token operator">|</span> SEVERITY <span class="token operator">|</span> INSTALLED VERSION  <span class="token operator">|</span>      FIXED VERSION      <span class="token operator">|</span>                  TITLE                  <span class="token operator">|</span>
+---------------------+------------------+----------+--------------------+-------------------------+-----------------------------------------+
<span class="token operator">|</span> <span class="token function">curl</span>                <span class="token operator">|</span> CVE-2021-22945   <span class="token operator">|</span> CRITICAL <span class="token operator">|</span> <span class="token number">7.74</span>.0-1.3+deb11u1 <span class="token operator">|</span>                         <span class="token operator">|</span> curl: use-after-free and                <span class="token operator">|</span>
<span class="token operator">|</span>                     <span class="token operator">|</span>                  <span class="token operator">|</span>          <span class="token operator">|</span>                    <span class="token operator">|</span>                         <span class="token operator">|</span> double-free <span class="token keyword">in</span> MQTT sending             <span class="token operator">|</span>
<span class="token operator">|</span>                     <span class="token operator">|</span>                  <span class="token operator">|</span>          <span class="token operator">|</span>                    <span class="token operator">|</span>                         <span class="token operator">|</span> --<span class="token operator">&gt;</span>avd.aquasec.com/nvd/cve-2021-22945   <span class="token operator">|</span>
+                     +------------------+----------+                    +-------------------------+-----------------------------------------+
<span class="token operator">|</span>                     <span class="token operator">|</span> CVE-2021-22946   <span class="token operator">|</span> HIGH     <span class="token operator">|</span>                    <span class="token operator">|</span>                         <span class="token operator">|</span> curl: Requirement to use                <span class="token operator">|</span>
<span class="token operator">|</span>                     <span class="token operator">|</span>                  <span class="token operator">|</span>          <span class="token operator">|</span>                    <span class="token operator">|</span>                         <span class="token operator">|</span> TLS not properly enforced               <span class="token operator">|</span>
<span class="token operator">|</span>                     <span class="token operator">|</span>                  <span class="token operator">|</span>          <span class="token operator">|</span>                    <span class="token operator">|</span>                         <span class="token operator">|</span> <span class="token keyword">for</span> IMAP, POP3, and<span class="token punctuation">..</span>.                  <span class="token operator">|</span>
<span class="token operator">|</span>                     <span class="token operator">|</span>                  <span class="token operator">|</span>          <span class="token operator">|</span>                    <span class="token operator">|</span>                         <span class="token operator">|</span> --<span class="token operator">&gt;</span>avd.aquasec.com/nvd/cve-2021-22946   <span class="token operator">|</span>
+---------------------+------------------+          +--------------------+-------------------------+-----------------------------------------+
<span class="token operator">|</span> e2fsprogs           <span class="token operator">|</span> CVE-2022-1304    <span class="token operator">|</span>          <span class="token operator">|</span> <span class="token number">1.46</span>.2-2           <span class="token operator">|</span>                         <span class="token operator">|</span> e2fsprogs: out-of-bounds                <span class="token operator">|</span>
<span class="token operator">|</span>                     <span class="token operator">|</span>                  <span class="token operator">|</span>          <span class="token operator">|</span>                    <span class="token operator">|</span>                         <span class="token operator">|</span> read/write via crafted filesystem       <span class="token operator">|</span>
<span class="token operator">|</span>                     <span class="token operator">|</span>                  <span class="token operator">|</span>          <span class="token operator">|</span>                    <span class="token operator">|</span>                         <span class="token operator">|</span> --<span class="token operator">&gt;</span>avd.aquasec.com/nvd/cve-2022-1304    <span class="token operator">|</span>
+---------------------+------------------+          +--------------------+-------------------------+-----------------------------------------+
<span class="token operator">|</span> <span class="token function">gzip</span>                <span class="token operator">|</span> CVE-2022-1271    <span class="token operator">|</span>          <span class="token operator">|</span> <span class="token number">1.10</span>-4             <span class="token operator">|</span>                         <span class="token operator">|</span> gzip: arbitrary-file-write              <span class="token operator">|</span>
<span class="token operator">|</span>                     <span class="token operator">|</span>                  <span class="token operator">|</span>          <span class="token operator">|</span>                    <span class="token operator">|</span>                         <span class="token operator">|</span> vulnerability                           <span class="token operator">|</span>
<span class="token operator">|</span>                     <span class="token operator">|</span>                  <span class="token operator">|</span>          <span class="token operator">|</span>                    <span class="token operator">|</span>                         <span class="token operator">|</span> --<span class="token operator">&gt;</span>avd.aquasec.com/nvd/cve-2022-1271    <span class="token operator">|</span>
+---------------------+------------------+----------+--------------------+-------------------------+-----------------------------------------+
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u68C0\u67E5yaml\u6587\u4EF6\u5B89\u5168\u914D\u7F6E-kubesec" tabindex="-1"><a class="header-anchor" href="#\u68C0\u67E5yaml\u6587\u4EF6\u5B89\u5168\u914D\u7F6E-kubesec" aria-hidden="true">#</a> \u68C0\u67E5YAML\u6587\u4EF6\u5B89\u5168\u914D\u7F6E\uFF1Akubesec</h3><h4 id="kubesec\u7B80\u4ECB" tabindex="-1"><a class="header-anchor" href="#kubesec\u7B80\u4ECB" aria-hidden="true">#</a> kubesec\u7B80\u4ECB</h4><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204141343065.png" alt="image-20220414134332943" loading="lazy"></p><p>kubesec\uFF1A\u662F\u4E00\u4E2A\u9488\u5BF9K8s\u8D44\u6E90\u6E05\u5355\u6587\u4EF6\u8FDB\u884C\u5B89\u5168\u914D\u7F6E\u8BC4\u4F30\u7684\u5DE5\u5177\uFF0C\u6839\u636E\u5B89\u5168\u914D\u7F6E \u6700\u4F73\u5B9E\u8DF5\u6765\u9A8C\u8BC1\u5E76\u7ED9\u51FA\u5EFA\u8BAE\u3002</p>`,16),b={href:"https://kubesec.io",target:"_blank",rel:"noopener noreferrer"},v={href:"https://github.com/controlplaneio/kubesec",target:"_blank",rel:"noopener noreferrer"},g=t(`<h4 id="kubesec\u5B89\u88C5" tabindex="-1"><a class="header-anchor" href="#kubesec\u5B89\u88C5" aria-hidden="true">#</a> kubesec\u5B89\u88C5</h4><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># tar zxvf kubesec_linux_amd64.tar.gz </span>
CHANGELOG.md
LICENSE
README.md
kubesec
<span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># mv kubesec /usr/local/bin/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="kubesec\u4F7F\u7528" tabindex="-1"><a class="header-anchor" href="#kubesec\u4F7F\u7528" aria-hidden="true">#</a> kubesec\u4F7F\u7528</h4><p>\u793A\u4F8B\uFF1A</p><ol><li>\u4F1A\u6709\u63D0\u793A\u544A\u8BC9\u4F60\u662F\u5426\u4F7F\u7528\u8D44\u6E90\u9650\u5236</li><li>\u53EF\u4EE5\u6839\u636E\u5EFA\u8BAE\u6DFB\u52A0\u8981\u6C42\u53BB\u52A0\u56FAPod\u7684\u5B89\u5168\u8303\u56F4</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubesec scan deployment.yaml 
\xB7\xB7\xB7
        <span class="token punctuation">{</span>
          <span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;RequestsMemory&quot;</span>,
          <span class="token string">&quot;selector&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;containers[] .resources .limits .memory&quot;</span>,
          <span class="token string">&quot;reason&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Enforcing memory limits prevents DOS via resource exhaustion&quot;</span>,
          <span class="token string">&quot;points&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>,
        <span class="token punctuation">{</span>
          <span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;RequestsCPU&quot;</span>,
          <span class="token string">&quot;selector&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;containers[] .resources .requests .cpu&quot;</span>,
          <span class="token string">&quot;reason&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Enforcing CPU requests aids a fair balancing of resources across the cluster&quot;</span>,
          <span class="token string">&quot;points&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>,
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6216\u8005\u4F7F\u7528\u5BB9\u5668\u73AF\u5883\u6267\u884C\u68C0\u67E5</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">docker</span> run <span class="token parameter variable">-i</span> kubesec/kubesec scan /dev/stdin <span class="token operator">&lt;</span> deployment.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>kubesec\u5185\u7F6E\u4E00\u4E2AHTTP\u670D\u52A1\u5668\uFF0C\u53EF\u4EE5\u76F4\u63A5\u542F\u7528\uFF0C\u8FDC\u7A0B\u8C03\u7528\u3002</p><p>\u4E8C\u8FDB\u5236</p><p><strong>kubesec http 8080 &amp;</strong></p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204141356188.png" alt="image-20220414135608347" loading="lazy"></p><p>Docker\u5BB9\u5668</p><p><strong>docker run -d -p 8080:8080 kubesec/kubesec http 8080</strong></p>`,14),h=n("p",null,"\u793A\u4F8B\uFF1A",-1),y={href:"http://192.168.31.71:8080/scan",target:"_blank",rel:"noopener noreferrer"},q=t(`<h3 id="admission-webhook" tabindex="-1"><a class="header-anchor" href="#admission-webhook" aria-hidden="true">#</a> Admission Webhook</h3><p><strong>Admission Webhook\uFF1A\u51C6\u5165\u63A7\u5236\u5668Webhook\u662F\u51C6\u5165\u63A7\u5236\u63D2\u4EF6\u7684\u4E00\u79CD</strong>\uFF0C\u7528\u4E8E\u62E6\u622A\u6240\u6709\u5411APISERVER\u53D1\u9001\u7684 \u8BF7\u6C42\uFF0C\u5E76\u4E14\u53EF\u4EE5\u4FEE\u6539\u8BF7\u6C42\u6216\u62D2\u7EDD\u8BF7\u6C42\u3002</p><p>Admission webhook\u4E3A\u5F00\u53D1\u8005\u63D0\u4F9B\u4E86\u975E\u5E38\u7075\u6D3B\u7684\u63D2\u4EF6\u6A21\u5F0F\uFF0C\u5728kubernetes\u8D44\u6E90\u6301\u4E45\u5316\u4E4B\u524D\uFF0C\u7BA1\u7406\u5458\u901A\u8FC7\u7A0B\u5E8F \u53EF\u4EE5\u5BF9\u6307\u5B9A\u8D44\u6E90\u505A\u6821\u9A8C\u3001\u4FEE\u6539\u7B49\u64CD\u4F5C\u3002\u4F8B\u5982\u4E3A\u8D44\u6E90\u81EA\u52A8\u6253\u6807\u7B7E\u3001pod\u8BBE\u7F6E\u9ED8\u8BA4SA\uFF0C\u81EA\u52A8\u6CE8\u5165sidecar\u5BB9\u5668\u7B49\u3002</p><p>\u76F8\u5173Webhook\u51C6\u5165\u63A7\u5236\u5668\uFF1A</p><ul><li><code>MutatingAdmissionWebhook\uFF1A</code>\u4FEE\u6539\u8D44\u6E90\uFF0C\u7406\u8BBA\u4E0A\u53EF\u4EE5\u76D1\u542C\u5E76\u4FEE\u6539\u4EFB\u4F55\u7ECF\u8FC7ApiServer\u5904\u7406\u7684\u8BF7\u6C42</li><li><code>ValidatingAdmissionWebhook\uFF1A</code>\u9A8C\u8BC1\u8D44\u6E90</li><li><code>ImagePolicyWebhook\uFF1A</code>\u955C\u50CF\u7B56\u7565\uFF0C\u4E3B\u8981\u9A8C\u8BC1\u955C\u50CF\u5B57\u6BB5\u662F\u5426\u6EE1\u8DB3\u6761\u4EF6</li></ul><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204141359941.png" alt="image-20220414135937964" loading="lazy"></p><h3 id="imagepolicywebhook" tabindex="-1"><a class="header-anchor" href="#imagepolicywebhook" aria-hidden="true">#</a> ImagePolicyWebhook</h3><h4 id="\u955C\u50CF\u7B56\u7565\u7684\u5DE5\u4F5C\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#\u955C\u50CF\u7B56\u7565\u7684\u5DE5\u4F5C\u6D41\u7A0B" aria-hidden="true">#</a> \u955C\u50CF\u7B56\u7565\u7684\u5DE5\u4F5C\u6D41\u7A0B</h4><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204141400570.png" alt="image-20220414140015972" loading="lazy"></p><h4 id="\u542F\u7528\u51C6\u5165\u63A7\u5236\u5668\u63D2\u4EF6" tabindex="-1"><a class="header-anchor" href="#\u542F\u7528\u51C6\u5165\u63A7\u5236\u5668\u63D2\u4EF6" aria-hidden="true">#</a> \u542F\u7528\u51C6\u5165\u63A7\u5236\u5668\u63D2\u4EF6</h4><ol><li>\u63D0\u4F9BHTTPS\u8BC1\u4E66</li><li>\u6DFB\u52A0\u914D\u7F6E\u6587\u4EF6</li><li>\u9700\u8981\u542F\u7528\u51C6\u5165\u63A7\u5236\u5668\u5F00\u542FImagePolicyWebhook\u63D2\u4EF6</li></ol><h5 id="_1-\u751F\u6210https\u8BC1\u4E66" tabindex="-1"><a class="header-anchor" href="#_1-\u751F\u6210https\u8BC1\u4E66" aria-hidden="true">#</a> 1.\u751F\u6210HTTPS\u8BC1\u4E66</h5><ul><li>\u9700\u8981\u4F7F\u7528<code>cfssl</code>\u5DE5\u5177\u3001\u751F\u6210<code>https</code>\u8BC1\u4E66</li><li>\u9700\u8981<code>admission_configuration</code>\u548C<code>connect_webhook</code>\u7684\u914D\u7F6E\u6587\u4EF6</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~/image-webhook<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">18820</span>
-rw-r--r-- <span class="token number">1</span> root root      <span class="token number">508</span> <span class="token number">10</span>\u6708 <span class="token number">21</span> <span class="token number">18</span>:53 admission_configuration.yaml
-rwxr-xr-x <span class="token number">1</span> root root <span class="token number">10376657</span> <span class="token number">11</span>\u6708 <span class="token number">24</span> <span class="token number">2019</span> cfssl
-rwxr-xr-x <span class="token number">1</span> root root  <span class="token number">6595195</span> <span class="token number">11</span>\u6708 <span class="token number">24</span> <span class="token number">2019</span> cfssl-certinfo
-rwxr-xr-x <span class="token number">1</span> root root  <span class="token number">2277873</span> <span class="token number">11</span>\u6708 <span class="token number">24</span> <span class="token number">2019</span> cfssljson
-rw-r--r-- <span class="token number">1</span> root root      <span class="token number">632</span> <span class="token number">10</span>\u6708 <span class="token number">21</span> <span class="token number">18</span>:46 connect_webhook.yaml
-rw-r--r-- <span class="token number">1</span> root root     <span class="token number">1367</span> <span class="token number">7</span>\u6708   <span class="token number">5</span> <span class="token number">2021</span> image-policy-certs.sh
drwxr-xr-x <span class="token number">2</span> root root       <span class="token number">39</span> <span class="token number">7</span>\u6708   <span class="token number">9</span> <span class="token number">2021</span> image-policy-webhook


<span class="token punctuation">[</span>root@master01:~/image-webhook<span class="token punctuation">]</span><span class="token comment"># vim image-policy-certs.sh</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> webhook-csr.json <span class="token operator">&lt;&lt;</span>EOF
<span class="token punctuation">{</span>
  <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;webhook&quot;</span>,
  <span class="token string">&quot;hosts&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
   <span class="token string">&quot;10.11.121.111&quot;</span>   <span class="token comment"># \u4FEE\u6539\u4E00\u4E0BIP\uFF0C\u6211\u8FD9\u91CC\u662Fmaster</span>
   <span class="token punctuation">]</span>,
  <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,
    <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,
      <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;BeiJing&quot;</span>,
      <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;BeiJing&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u901A\u8FC7cfssl\u5DE5\u5177\u751F\u6210https\u8BA4\u8BC1</p><ul><li>\u751F\u6210\u7684key\u548Cpem\u6587\u4EF6\u9700\u8981\u590D\u5236\u5230imagepolicywebhook\u9700\u8981\u7684\u76EE\u5F55</li><li>\u8FD8\u9700\u8981\u5C06\u4E24\u4E2A\u8FDE\u63A5webhook\u914D\u7F6E\u6587\u4EF6\u590D\u5236\u5230\u6307\u5B9A\u76EE\u5F55</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~/image-webhook<span class="token punctuation">]</span><span class="token comment"># mv cfssl* /usr/local/bin/</span>
<span class="token punctuation">[</span>root@master01:~/image-webhook<span class="token punctuation">]</span><span class="token comment"># chmod +x image-policy-certs.sh </span>
<span class="token punctuation">[</span>root@master01:~/image-webhook<span class="token punctuation">]</span><span class="token comment"># ./image-policy-certs.sh </span>
<span class="token punctuation">[</span>root@master01:~/image-webhook<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">64</span>
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">508</span> <span class="token number">10</span>\u6708 <span class="token number">21</span> <span class="token number">18</span>:53 admission_configuration.yaml
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">956</span> <span class="token number">4</span>\u6708  <span class="token number">14</span> 09:31 apiserver-client.csr
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">182</span> <span class="token number">4</span>\u6708  <span class="token number">14</span> 09:31 apiserver-client-csr.json
-rw------- <span class="token number">1</span> root root <span class="token number">1675</span> <span class="token number">4</span>\u6708  <span class="token number">14</span> 09:31 apiserver-client-key.pem
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1306</span> <span class="token number">4</span>\u6708  <span class="token number">14</span> 09:31 apiserver-client.pem
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">294</span> <span class="token number">4</span>\u6708  <span class="token number">14</span> 09:31 ca-config.json
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">960</span> <span class="token number">4</span>\u6708  <span class="token number">14</span> 09:31 ca.csr
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">212</span> <span class="token number">4</span>\u6708  <span class="token number">14</span> 09:31 ca-csr.json
-rw------- <span class="token number">1</span> root root <span class="token number">1675</span> <span class="token number">4</span>\u6708  <span class="token number">14</span> 09:31 ca-key.pem
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1273</span> <span class="token number">4</span>\u6708  <span class="token number">14</span> 09:31 ca.pem
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">632</span> <span class="token number">10</span>\u6708 <span class="token number">21</span> <span class="token number">18</span>:46 connect_webhook.yaml
-rwxr-xr-x <span class="token number">1</span> root root <span class="token number">1367</span> <span class="token number">7</span>\u6708   <span class="token number">5</span> <span class="token number">2021</span> image-policy-certs.sh
drwxr-xr-x <span class="token number">2</span> root root   <span class="token number">39</span> <span class="token number">7</span>\u6708   <span class="token number">9</span> <span class="token number">2021</span> image-policy-webhook
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1001</span> <span class="token number">4</span>\u6708  <span class="token number">14</span> 09:31 webhook.csr
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">204</span> <span class="token number">4</span>\u6708  <span class="token number">14</span> 09:31 webhook-csr.json
-rw------- <span class="token number">1</span> root root <span class="token number">1679</span> <span class="token number">4</span>\u6708  <span class="token number">14</span> 09:31 webhook-key.pem
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1330</span> <span class="token number">4</span>\u6708  <span class="token number">14</span> 09:31 webhook.pem
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-\u6DFB\u52A0\u914D\u7F6E\u6587\u4EF6" tabindex="-1"><a class="header-anchor" href="#_2-\u6DFB\u52A0\u914D\u7F6E\u6587\u4EF6" aria-hidden="true">#</a> 2.\u6DFB\u52A0\u914D\u7F6E\u6587\u4EF6</h5><ul><li>\u67E5\u770B<code>admission_configuration.yaml</code></li><li>\u67E5\u770B<code>connect_webhook.yaml</code></li><li><code>/etc/kubernetes/image-policy/</code>\u8BE5\u76EE\u5F55\u662F\u4E0D\u5B58\u5728\u7684\uFF0C\u6240\u4EE5\u9700\u8981\u521B\u5EFA\uFF0C\u7528\u4F5C\u6570\u636E\u5377\u6301\u4E45\u5316</li><li>\u9700\u8981\u4FEE\u6539\u7684\u662Fconnect_webhook\u7684server\u5730\u5740\uFF0C\u8BE5\u5730\u5740\u662F\u955C\u50CF\u7B56\u7565\u670D\u52A1\u5730\u5740\uFF0C\u8FD9\u91CC\u6211\u4F7F\u7528master01</li><li><code>admission_configuration.yaml</code>\u548C <code>connect_webhook.yaml</code>\u9700\u8981\u5B58\u653E\u5230<code>/etc/kubernetes/image-policy/</code>\u76EE\u5F55</li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/image<span class="token punctuation">-</span>webhook<span class="token punctuation">]</span> <span class="token comment"># cat admission_configuration.yaml </span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apiserver.config.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> AdmissionConfiguration
<span class="token key atrule">plugins</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ImagePolicyWebhook
  <span class="token key atrule">configuration</span><span class="token punctuation">:</span>
    <span class="token key atrule">imagePolicy</span><span class="token punctuation">:</span>
      <span class="token key atrule">kubeConfigFile</span><span class="token punctuation">:</span> /etc/kubernetes/image<span class="token punctuation">-</span>policy/connect_webhook.yaml  <span class="token comment"># \u8FDE\u63A5\u955C\u50CF\u7B56\u7565\u670D\u52A1\u5668\u914D\u7F6E\u6587\u4EF6</span>
      <span class="token key atrule">allowTTL</span><span class="token punctuation">:</span> <span class="token number">50</span> <span class="token comment"># \u63A7\u5236\u6279\u51C6\u8BF7\u6C42\u7684\u7F13\u5B58\u65F6\u95F4\uFF0C\u5355\u4F4D\u79D2</span>
      <span class="token key atrule">denyTTL</span><span class="token punctuation">:</span> <span class="token number">50</span> <span class="token comment"># \u63A7\u5236\u6279\u51C6\u8BF7\u6C42\u7684\u7F13\u5B58\u65F6\u95F4\uFF0C\u5355\u4F4D\u79D2</span>
      <span class="token key atrule">retryBackoff</span><span class="token punctuation">:</span> <span class="token number">500</span> <span class="token comment"># \u63A7\u5236\u91CD\u8BD5\u95F4\u9694\uFF0C\u5355\u4F4D\u6BEB\u79D2</span>
      <span class="token key atrule">defaultAllow</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># \u786E\u5B9Awebhook\u540E\u7AEF\u5931\u6548\u7684\u884C\u4E3A</span>
      
      
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/image<span class="token punctuation">-</span>webhook<span class="token punctuation">]</span> <span class="token comment"># cat connect_webhook.yaml </span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Config
<span class="token key atrule">clusters</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">cluster</span><span class="token punctuation">:</span>
    <span class="token key atrule">certificate-authority</span><span class="token punctuation">:</span> /etc/kubernetes/image<span class="token punctuation">-</span>policy/webhook.pem <span class="token comment"># \u6570\u5B57\u8BC1\u4E66\uFF0C\u7528\u4E8E\u9A8C\u8BC1\u8FDC\u7A0B\u670D\u52A1</span>
    <span class="token key atrule">server</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//10.11.121.111<span class="token punctuation">:</span>8080/image_policy <span class="token comment"># \u955C\u50CF\u7B56\u7565\u670D\u52A1\u5668\u5730\u5740\uFF0C\u5FC5\u987B\u662Fhttps</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> webhook
<span class="token key atrule">contexts</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">context</span><span class="token punctuation">:</span>
    <span class="token key atrule">cluster</span><span class="token punctuation">:</span> webhook
    <span class="token key atrule">user</span><span class="token punctuation">:</span> apiserver
  <span class="token key atrule">name</span><span class="token punctuation">:</span> webhook
<span class="token key atrule">current-context</span><span class="token punctuation">:</span> webhook 
<span class="token key atrule">preferences</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token key atrule">users</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> apiserver
  <span class="token key atrule">user</span><span class="token punctuation">:</span>
    <span class="token key atrule">client-certificate</span><span class="token punctuation">:</span> /etc/kubernetes/image<span class="token punctuation">-</span>policy/apiserver<span class="token punctuation">-</span>client.pem <span class="token comment"># webhook\u51C6\u5165\u63A7\u5236\u5668\u4F7F\u7528\u7684\u8BC1\u4E66</span>
    <span class="token key atrule">client-key</span><span class="token punctuation">:</span> /etc/kubernetes/image<span class="token punctuation">-</span>policy/apiserver<span class="token punctuation">-</span>client<span class="token punctuation">-</span>key.pem <span class="token comment"># \u5BF9\u5E94\u79C1\u94A5\u8BC1\u4E66 </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u65B0\u5EFA/etc/kubernetes/image-policy\u7684\u76EE\u5F55\uFF0C\u590D\u5236\u6587\u4EF6\u5230\u8BE5\u76EE\u5F55\u4E0B</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~/image-webhook<span class="token punctuation">]</span><span class="token comment"># mkdir /etc/kubernetes/image-policy</span>
<span class="token punctuation">[</span>root@master01:~/image-webhook<span class="token punctuation">]</span><span class="token comment"># cp admission_configuration.yaml connect_webhook.yaml /etc/kubernetes/image-policy/</span>
<span class="token punctuation">[</span>root@master01:~/image-webhook<span class="token punctuation">]</span><span class="token comment"># cp apiserver*  /etc/kubernetes/image-policy/</span>
<span class="token punctuation">[</span>root@master01:~/image-webhook<span class="token punctuation">]</span><span class="token comment"># cp webhook* /etc/kubernetes/image-policy/</span>
<span class="token punctuation">[</span>root@master01:~/image-webhook<span class="token punctuation">]</span><span class="token comment"># cp ca.pem  /etc/kubernetes/image-policy/</span>
<span class="token punctuation">[</span>root@master01:~/image-webhook<span class="token punctuation">]</span><span class="token comment"># ll /etc/kubernetes/image-policy/</span>
total <span class="token number">44</span>
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">508</span> <span class="token number">4</span>\u6708  <span class="token number">14</span> 09:38 admission_configuration.yaml
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">956</span> <span class="token number">4</span>\u6708  <span class="token number">14</span> 09:39 apiserver-client.csr
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">182</span> <span class="token number">4</span>\u6708  <span class="token number">14</span> 09:39 apiserver-client-csr.json
-rw------- <span class="token number">1</span> root root <span class="token number">1675</span> <span class="token number">4</span>\u6708  <span class="token number">14</span> 09:39 apiserver-client-key.pem
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1306</span> <span class="token number">4</span>\u6708  <span class="token number">14</span> 09:39 apiserver-client.pem
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1273</span> <span class="token number">4</span>\u6708  <span class="token number">14</span> 09:39 ca.pem
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">632</span> <span class="token number">4</span>\u6708  <span class="token number">14</span> 09:38 connect_webhook.yaml
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1001</span> <span class="token number">4</span>\u6708  <span class="token number">14</span> 09:39 webhook.csr
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">204</span> <span class="token number">4</span>\u6708  <span class="token number">14</span> 09:39 webhook-csr.json
-rw------- <span class="token number">1</span> root root <span class="token number">1679</span> <span class="token number">4</span>\u6708  <span class="token number">14</span> 09:39 webhook-key.pem
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1330</span> <span class="token number">4</span>\u6708  <span class="token number">14</span> 09:39 webhook.pem
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-\u5F00\u542Fimagepolicywebhook\u63D2\u4EF6" tabindex="-1"><a class="header-anchor" href="#_3-\u5F00\u542Fimagepolicywebhook\u63D2\u4EF6" aria-hidden="true">#</a> 3.\u5F00\u542FImagePolicyWebhook\u63D2\u4EF6</h5><p>\u4F7F\u7528hostpath\u6570\u636E\u5377\u5C06\u5BBF\u4E3B\u673A<code>/etc/kubernetes/image-policy</code>\u76EE\u5F55\u6302\u8F7D\u5230\u5BB9\u5668\u4E2D\u3002</p><p>\u91CD\u542Fkubelet\uFF0C\u7B49\u5F85\u4E00\u5206\u949F\u91CD\u5EFAkube-apiserver\u7684Pod\u3002</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/image<span class="token punctuation">-</span>webhook<span class="token punctuation">]</span><span class="token comment"># vim /etc/kubernetes/kube-apiserver.yaml </span>
 	<span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>enable<span class="token punctuation">-</span>admission<span class="token punctuation">-</span>plugins=NodeRestriction<span class="token punctuation">,</span>ImagePolicyWebhook
	<span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>admission<span class="token punctuation">-</span>control<span class="token punctuation">-</span>config<span class="token punctuation">-</span>file=/etc/kubernetes/image<span class="token punctuation">-</span>policy/admission_configuration.yaml
\xB7\xB7\xB7
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/kubernetes/image<span class="token punctuation">-</span>policy
      <span class="token key atrule">name</span><span class="token punctuation">:</span> image<span class="token punctuation">-</span>policy
\xB7\xB7\xB7
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/kubernetes/image<span class="token punctuation">-</span>policy
      <span class="token key atrule">type</span><span class="token punctuation">:</span> Directory
      <span class="token key atrule">name</span><span class="token punctuation">:</span> image<span class="token punctuation">-</span>policy
      
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/image<span class="token punctuation">-</span>webhook<span class="token punctuation">]</span><span class="token comment"># systemctl  restart  kubelet </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_4-\u90E8\u7F72\u955C\u50CF\u670D\u52A1\u5668" tabindex="-1"><a class="header-anchor" href="#_4-\u90E8\u7F72\u955C\u50CF\u670D\u52A1\u5668" aria-hidden="true">#</a> 4.\u90E8\u7F72\u955C\u50CF\u670D\u52A1\u5668</h5><p>\u5728\u672C\u673A\u7684master\u8282\u70B9\u90E8\u7F72\u955C\u50CF\u670D\u52A1\u5668\uFF0C\u6765\u5F53server\uFF0C\u8981\u6C42\u5982\u4E0B\uFF1A</p><ol><li>\u4F7F\u7528Python\u7F16\u5199\u4E00\u4E2A\u8FDE\u63A5<code>ImagePolicyWebhook\u7684api</code>\u63A5\u53E3</li><li>\u7F16\u5199\u4E00\u4E2A<code>Dockerfile</code>\u8FD0\u884C\u8FD9\u4E2A<code>python</code>\u6587\u4EF6</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~/image-webhook<span class="token punctuation">]</span><span class="token comment"># mv webhook* image-policy-webhook/</span>
<span class="token punctuation">[</span>root@master01:~/image-webhook/image-policy-webhook<span class="token punctuation">]</span> <span class="token comment"># ll</span>
total <span class="token number">24</span>
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">212</span> <span class="token number">7</span>\u6708   <span class="token number">9</span> <span class="token number">2021</span> Dockerfile
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">982</span> <span class="token number">7</span>\u6708   <span class="token number">9</span> <span class="token number">2021</span> main.py
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1001</span> <span class="token number">4</span>\u6708  <span class="token number">14</span> 09:31 webhook.csr
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">204</span> <span class="token number">4</span>\u6708  <span class="token number">14</span> 09:31 webhook-csr.json
-rw------- <span class="token number">1</span> root root <span class="token number">1679</span> <span class="token number">4</span>\u6708  <span class="token number">14</span> 09:31 webhook-key.pem
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1330</span> <span class="token number">4</span>\u6708  <span class="token number">14</span> 09:31 webhook.pem
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u67E5\u770B\u5F53\u524D\u7684Dockerfile\u6587\u4EF6</p><div class="language-docker ext-docker line-numbers-mode"><pre class="language-docker"><code>[root@master01:~/image-webhook/image-policy-webhook] # cat Dockerfile 
<span class="token instruction"><span class="token keyword">FROM</span> python</span>
<span class="token instruction"><span class="token keyword">RUN</span> useradd python</span>
<span class="token instruction"><span class="token keyword">RUN</span> mkdir /data/www -p</span>
<span class="token instruction"><span class="token keyword">COPY</span> . /data/www</span>
<span class="token instruction"><span class="token keyword">RUN</span> chown -R python /data</span>
<span class="token instruction"><span class="token keyword">RUN</span> pip install flask -i https://mirrors.aliyun.com/pypi/simple/</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /data/www</span>
<span class="token instruction"><span class="token keyword">USER</span> python</span>
<span class="token instruction"><span class="token keyword">CMD</span> python main.py </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u67E5\u770B\u5F53\u524D\u7684Python\u811A\u672C</p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>image<span class="token operator">-</span>webhook<span class="token operator">/</span>image<span class="token operator">-</span>policy<span class="token operator">-</span>webhook<span class="token punctuation">]</span> <span class="token comment"># cat main.py </span>
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span>request
<span class="token keyword">import</span> json

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&#39;/image_policy&#39;</span><span class="token punctuation">,</span>methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">image_policy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    post_data <span class="token operator">=</span> request<span class="token punctuation">.</span>get_data<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">#print(&quot;POST\u6570\u636E: %s&quot; %post_data)</span>
    data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>post_data<span class="token punctuation">)</span>
    <span class="token keyword">for</span> c <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">&#39;spec&#39;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&#39;containers&#39;</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token comment"># \u5982\u679C\u955C\u50CF\u91CC\u4E0D\u5E26\u5192\u53F7\u6216\u8005\u5E26:latest\u8BF4\u660E\u662F\u955C\u50CF\u4F7F\u7528latest\u6807\u7B7E</span>
        <span class="token keyword">if</span> <span class="token string">&quot;:&quot;</span> <span class="token keyword">not</span> <span class="token keyword">in</span> c<span class="token punctuation">[</span><span class="token string">&#39;image&#39;</span><span class="token punctuation">]</span> <span class="token keyword">or</span> <span class="token string">&quot;:latest&quot;</span> <span class="token keyword">in</span> c<span class="token punctuation">[</span><span class="token string">&#39;image&#39;</span><span class="token punctuation">]</span><span class="token punctuation">:</span>  
            allowed<span class="token punctuation">,</span> reason <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">&quot;\u68C0\u67E5\u955C\u50CF\u5931\u8D25\uFF01\u955C\u50CF\u6807\u7B7E\u4E0D\u5141\u8BB8\u4F7F\u7528latest!&quot;</span>
            <span class="token keyword">break</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            allowed<span class="token punctuation">,</span> reason <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">&quot;\u68C0\u67E5\u955C\u50CF\u901A\u8FC7.&quot;</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\u68C0\u67E5\u7ED3\u679C: %s&quot;</span> <span class="token operator">%</span>reason<span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;apiVersion&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;imagepolicy.k8s.io/v1alpha1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;kind&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;ImageReview&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;status&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&quot;allowed&quot;</span><span class="token punctuation">:</span> allowed<span class="token punctuation">,</span><span class="token string">&quot;reason&quot;</span><span class="token punctuation">:</span> reason<span class="token punctuation">}</span><span class="token punctuation">}</span>

    <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>result<span class="token punctuation">,</span>ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span> 

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">&quot;0.0.0.0&quot;</span><span class="token punctuation">,</span>port<span class="token operator">=</span><span class="token number">8080</span><span class="token punctuation">,</span>ssl_context<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">&#39;/data/www/webhook.pem&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;/data/www/webhook-key.pem&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6784\u5EFADockerfile</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~/image-webhook/image-policy-webhook<span class="token punctuation">]</span><span class="token comment"># docker build -t image-policy-webhook .</span>
Digest: sha256:dbbfcbf95f6b596d2be1d8f3b368016619f78f829facf6f2e361bea1151794e5
Status: Downloaded newer image <span class="token keyword">for</span> python:latest
 ---<span class="token operator">&gt;</span> a5d7930b60cc
Step <span class="token number">2</span>/9 <span class="token builtin class-name">:</span> RUN <span class="token function">useradd</span> python
 ---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> fcd9fcc7e44f
Removing intermediate container fcd9fcc7e44f
 ---<span class="token operator">&gt;</span> 10b842f26fed
Step <span class="token number">3</span>/9 <span class="token builtin class-name">:</span> RUN <span class="token function">mkdir</span> /data/www <span class="token parameter variable">-p</span>
 ---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> cffd0d6f3bbd
Removing intermediate container cffd0d6f3bbd
 ---<span class="token operator">&gt;</span> 4db5fe4dc849
Step <span class="token number">4</span>/9 <span class="token builtin class-name">:</span> COPY <span class="token builtin class-name">.</span> /data/www
 ---<span class="token operator">&gt;</span> d27fa5502133
Step <span class="token number">5</span>/9 <span class="token builtin class-name">:</span> RUN <span class="token function">chown</span> <span class="token parameter variable">-R</span> python /data
 ---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> 7559149b085b
Removing intermediate container 7559149b085b
 ---<span class="token operator">&gt;</span> a35d92963cfd
Step <span class="token number">6</span>/9 <span class="token builtin class-name">:</span> RUN pip <span class="token function">install</span> flask <span class="token parameter variable">-i</span> https://mirrors.aliyun.com/pypi/simple/
 ---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> 8aea1cb3d0fe
 Removing intermediate container 8aea1cb3d0fe
 ---<span class="token operator">&gt;</span> b81eed200f98
Step <span class="token number">7</span>/9 <span class="token builtin class-name">:</span> WORKDIR /data/www
 ---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> fb82b0cc633e
Removing intermediate container fb82b0cc633e
 ---<span class="token operator">&gt;</span> 2e43f0dff4ad
Step <span class="token number">8</span>/9 <span class="token builtin class-name">:</span> <span class="token environment constant">USER</span> python
 ---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> 5faeb5a8566e
Removing intermediate container 5faeb5a8566e
 ---<span class="token operator">&gt;</span> 6797205b1622
Step <span class="token number">9</span>/9 <span class="token builtin class-name">:</span> CMD python main.py
 ---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> da4ae6eabc00
Removing intermediate container da4ae6eabc00
 ---<span class="token operator">&gt;</span> d49ca131fdb9
Successfully built d49ca131fdb9
Successfully tagged image-policy-webhook:latest
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-\u90E8\u7F72\u955C\u50CF\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#_5-\u90E8\u7F72\u955C\u50CF\u670D\u52A1" aria-hidden="true">#</a> 5.\u90E8\u7F72\u955C\u50CF\u670D\u52A1</h5><p>\u81EA\u5DF1\u7528python\u5F00\u53D1\u4E00\u4E2A\u7B80\u5355\u7684webhook\u7AEF\u70B9\u670D\u52A1\u5668\uFF0C\u4F5C\u7528\u662F\u62D2\u7EDD\u90E8\u7F72\u7684\u955C\u50CF\u4E5C\u6709\u6307\u5B9A\u6807\u7B7E\uFF08\u5373latest\uFF09\u3002</p><ol><li>\u81EA\u7B7E<code>HTTPS</code>\u8BC1\u4E66</li><li><code>Docker</code>\u5BB9\u5668\u542F\u52A8\u955C\u50CF\u7B56\u7565\u670D\u52A1</li><li>\u67E5\u770B\u5F53\u524D\u7684Docker\u65E5\u5FD7</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~/image-webhook/image-policy-webhook<span class="token punctuation">]</span><span class="token comment"># docker run -d -u root --name=image-policy-webhook \\</span>
<span class="token operator">&gt;</span> <span class="token parameter variable">-v</span> <span class="token environment constant">$PWD</span>/webhook.pem:/data/www/webhook.pem <span class="token punctuation">\\</span>
<span class="token operator">&gt;</span> <span class="token parameter variable">-v</span> <span class="token environment constant">$PWD</span>/webhook-key.pem:/data/www/webhook-key.pem <span class="token punctuation">\\</span>
<span class="token operator">&gt;</span> <span class="token parameter variable">-e</span> <span class="token assign-left variable">PYTHONUNBUFFERED</span><span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">-p</span> <span class="token number">8080</span>:8080 <span class="token punctuation">\\</span>
<span class="token operator">&gt;</span> image-policy-webhook
73a9ae72a7bc8f379fe5414f575b779bf34c969089f6e544e1c7a81a60fc5b9d.


<span class="token punctuation">[</span>root@master01:~/image-webhook/image-policy-webhook<span class="token punctuation">]</span><span class="token comment"># docker logs -f image-policy-webhook </span>
 * Serving Flask app <span class="token string">&#39;main&#39;</span> <span class="token punctuation">(</span>lazy loading<span class="token punctuation">)</span>
 * Environment: production
   WARNING: This is a development server. Do not use it <span class="token keyword">in</span> a production deployment.
   Use a production WSGI server instead.
 * Debug mode: off
 * Running on all addresses <span class="token punctuation">(</span><span class="token number">0.0</span>.0.0<span class="token punctuation">)</span>
   WARNING: This is a development server. Do not use it <span class="token keyword">in</span> a production deployment.
 * Running on https://127.0.0.1:8080
 * Running on https://172.17.0.2:8080 <span class="token punctuation">(</span>Press CTRL+C to quit<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6D4B\u8BD5ImagePolicyWebhook</p><p>\u521B\u5EFADeployment\u4F7F\u7528nginx\u955C\u50CF\uFF0C\u4F7F\u7528nginx:1.16\u7684\u7248\u672C\uFF0C\u67E5\u770B\u65E5\u5FD7\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create deployment web1 --image=nginx:1.16 </span>
deployment.apps/web1 created

<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># docker logs  -f image-policy-webhook </span>
 * Serving Flask app <span class="token string">&#39;main&#39;</span> <span class="token punctuation">(</span>lazy loading<span class="token punctuation">)</span>
 * Environment: production
   WARNING: This is a development server. Do not use it <span class="token keyword">in</span> a production deployment.
   Use a production WSGI server instead.
 * Debug mode: off
 * Running on all addresses <span class="token punctuation">(</span><span class="token number">0.0</span>.0.0<span class="token punctuation">)</span>
   WARNING: This is a development server. Do not use it <span class="token keyword">in</span> a production deployment.
 * Running on https://127.0.0.1:8080
 * Running on https://172.17.0.2:8080 <span class="token punctuation">(</span>Press CTRL+C to quit<span class="token punctuation">)</span>
POST\u6570\u636E: <span class="token punctuation">{</span><span class="token string">&quot;kind&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;ImageReview&quot;</span>,<span class="token string">&quot;apiVersion&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;imagepolicy.k8s.io/v1alpha1&quot;</span>,<span class="token string">&quot;metadata&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;creationTimestamp&quot;</span>:null<span class="token punctuation">}</span>,<span class="token string">&quot;spec&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;containers&quot;</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;image&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;nginx:1.16&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span>,<span class="token string">&quot;namespace&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;status&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;allowed&quot;</span>:false<span class="token punctuation">}</span><span class="token punctuation">}</span>

\u68C0\u67E5\u7ED3\u679C: \u68C0\u67E5\u955C\u50CF\u901A\u8FC7.
<span class="token number">10.11</span>.121.118 - - <span class="token punctuation">[</span><span class="token number">14</span>/Apr/2022 <span class="token number">14</span>:00:46<span class="token punctuation">]</span> <span class="token string">&quot;POST /image_policy?timeout=30s HTTP/1.1&quot;</span> <span class="token number">200</span> -
POST\u6570\u636E: <span class="token punctuation">{</span><span class="token string">&quot;kind&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;ImageReview&quot;</span>,<span class="token string">&quot;apiVersion&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;imagepolicy.k8s.io/v1alpha1&quot;</span>,<span class="token string">&quot;metadata&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;creationTimestamp&quot;</span>:null<span class="token punctuation">}</span>,<span class="token string">&quot;spec&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;containers&quot;</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;image&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;nginx:latest&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span>,<span class="token string">&quot;namespace&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;status&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;allowed&quot;</span>:false<span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u521B\u5EFADeployment\u4F7F\u7528nginx\u955C\u50CF\uFF0C\u4F7F\u7528nginx:latest\u7684\u7248\u672C\uFF0C\u67E5\u770B\u65E5\u5FD7\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create deployment web2 --image=nginx:latest</span>
deployment.apps/web2 created

<span class="token punctuation">[</span>root@master01 image-policy-webhook<span class="token punctuation">]</span><span class="token comment"># docker logs  -f image-policy-webhook </span>
 * Serving Flask app <span class="token string">&#39;main&#39;</span> <span class="token punctuation">(</span>lazy loading<span class="token punctuation">)</span>
 * Environment: production
   WARNING: This is a development server. Do not use it <span class="token keyword">in</span> a production deployment.
   Use a production WSGI server instead.
 * Debug mode: off
 * Running on all addresses <span class="token punctuation">(</span><span class="token number">0.0</span>.0.0<span class="token punctuation">)</span>
   WARNING: This is a development server. Do not use it <span class="token keyword">in</span> a production deployment.
 * Running on https://127.0.0.1:8080
 * Running on https://172.17.0.2:8080 <span class="token punctuation">(</span>Press CTRL+C to quit<span class="token punctuation">)</span>
POST\u6570\u636E: <span class="token punctuation">{</span><span class="token string">&quot;kind&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;ImageReview&quot;</span>,<span class="token string">&quot;apiVersion&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;imagepolicy.k8s.io/v1alpha1&quot;</span>,<span class="token string">&quot;metadata&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;creationTimestamp&quot;</span>:null<span class="token punctuation">}</span>,<span class="token string">&quot;spec&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;containers&quot;</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;image&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;nginx:1.16&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span>,<span class="token string">&quot;namespace&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;status&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;allowed&quot;</span>:false<span class="token punctuation">}</span><span class="token punctuation">}</span>

\u68C0\u67E5\u7ED3\u679C: \u68C0\u67E5\u955C\u50CF\u901A\u8FC7.
<span class="token number">10.11</span>.121.118 - - <span class="token punctuation">[</span><span class="token number">14</span>/Apr/2022 <span class="token number">14</span>:00:46<span class="token punctuation">]</span> <span class="token string">&quot;POST /image_policy?timeout=30s HTTP/1.1&quot;</span> <span class="token number">200</span> -
POST\u6570\u636E: <span class="token punctuation">{</span><span class="token string">&quot;kind&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;ImageReview&quot;</span>,<span class="token string">&quot;apiVersion&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;imagepolicy.k8s.io/v1alpha1&quot;</span>,<span class="token string">&quot;metadata&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;creationTimestamp&quot;</span>:null<span class="token punctuation">}</span>,<span class="token string">&quot;spec&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;containers&quot;</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;image&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;nginx:latest&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span>,<span class="token string">&quot;namespace&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;status&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;allowed&quot;</span>:false<span class="token punctuation">}</span><span class="token punctuation">}</span>

\u68C0\u67E5\u7ED3\u679C: \u68C0\u67E5\u955C\u50CF\u5931\u8D25\uFF01\u955C\u50CF\u6807\u7B7E\u4E0D\u5141\u8BB8\u4F7F\u7528latest<span class="token operator">!</span>
<span class="token number">10.11</span>.121.118 - - <span class="token punctuation">[</span><span class="token number">14</span>/Apr/2022 <span class="token number">14</span>:01:04<span class="token punctuation">]</span> <span class="token string">&quot;POST /image_policy?timeout=30s HTTP/1.1&quot;</span> <span class="token number">200</span> -
POST\u6570\u636E: <span class="token punctuation">{</span><span class="token string">&quot;kind&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;ImageReview&quot;</span>,<span class="token string">&quot;apiVersion&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;imagepolicy.k8s.io/v1alpha1&quot;</span>,<span class="token string">&quot;metadata&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;creationTimestamp&quot;</span>:null<span class="token punctuation">}</span>,<span class="token string">&quot;spec&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;containers&quot;</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;image&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;nginx:latest&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span>,<span class="token string">&quot;namespace&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;status&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;allowed&quot;</span>:false<span class="token punctuation">}</span><span class="token punctuation">}</span>

\u68C0\u67E5\u7ED3\u679C: \u68C0\u67E5\u955C\u50CF\u5931\u8D25\uFF01\u955C\u50CF\u6807\u7B7E\u4E0D\u5141\u8BB8\u4F7F\u7528latest<span class="token operator">!</span>
<span class="token number">10.11</span>.121.118 - - <span class="token punctuation">[</span><span class="token number">14</span>/Apr/2022 <span class="token number">14</span>:02:26<span class="token punctuation">]</span> <span class="token string">&quot;POST /image_policy?timeout=30s HTTP/1.1&quot;</span> <span class="token number">200</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,45);function w(f,_){const a=l("ExternalLinkIcon");return p(),i("div",null,[r,n("p",null,[s("\u9879\u76EE\u5730\u5740\uFF1A"),n("a",u,[s("https://github.com/aquasecurity/trivy"),e(a)])]),k,n("p",null,[s("GitHub\u9879\u76EE\u5730\u5740\uFF1A "),n("a",d,[s("https://github.com/aquasecurity/trivy-db/releases"),e(a)])]),m,n("p",null,[s("\u5B98\u7F51\uFF1A"),n("a",b,[s("https://kubesec.io"),e(a)])]),n("p",null,[s("\u9879\u76EE\u5730\u5740\uFF1A"),n("a",v,[s("https://github.com/controlplaneio/kubesec"),e(a)])]),g,n("blockquote",null,[h,n("p",null,[s("curl -sSX POST --data-binary @deployment.yaml "),n("a",y,[s("http://192.168.31.71:8080/scan"),e(a)])])]),q])}const T=o(c,[["render",w],["__file","05.\u4F9B\u5E94\u94FE\u5B89\u5168.html.vue"]]);export{T as default};
