import{_ as i}from"./_plugin-vue_export-helper.cdc0426e.js";import{o as p,c as l,a as n,b as s,d as e,f as t,r as c}from"./app.ca0279c0.js";const o={},u=t(`<h1 id="\u6700\u5C0F\u5316\u5FAE\u670D\u52A1\u6F0F\u6D1E" tabindex="-1"><a class="header-anchor" href="#\u6700\u5C0F\u5316\u5FAE\u670D\u52A1\u6F0F\u6D1E" aria-hidden="true">#</a> \u6700\u5C0F\u5316\u5FAE\u670D\u52A1\u6F0F\u6D1E</h1><h3 id="\u4E3B\u8981\u5185\u5BB9" tabindex="-1"><a class="header-anchor" href="#\u4E3B\u8981\u5185\u5BB9" aria-hidden="true">#</a> \u4E3B\u8981\u5185\u5BB9</h3><p>\u2756 Pod\u5B89\u5168\u4E0A\u4E0B\u6587</p><p>\u2756 Pod\u5B89\u5168\u7B56\u7565</p><p>\u2756 Secret\u5B58\u50A8\u654F\u611F\u6570\u636E</p><p>\u2756 \u5B89\u5168\u6C99\u7BB1\u8FD0\u884C\u5BB9\u5668</p><h3 id="pod\u5B89\u5168\u4E0A\u4E0B\u6587" tabindex="-1"><a class="header-anchor" href="#pod\u5B89\u5168\u4E0A\u4E0B\u6587" aria-hidden="true">#</a> Pod\u5B89\u5168\u4E0A\u4E0B\u6587</h3><p><code>\u5B89\u5168\u4E0A\u4E0B\u6587\uFF08Security Context\uFF09</code>\uFF1AK8s\u5BF9Pod\u548C\u5BB9\u5668\u63D0\u4F9B\u7684\u5B89\u5168\u673A\u5236\uFF0C\u53EF\u4EE5\u8BBE\u7F6EPod\u7279\u6743\u548C\u8BBF\u95EE\u63A7\u5236\u3002</p><p><strong>\u5B89\u5168\u4E0A\u4E0B\u6587\u9650\u5236\u7EF4\u5EA6\uFF1A</strong></p><ul><li><code>\u81EA\u4E3B\u8BBF\u95EE\u63A7\u5236\uFF08Discretionary Access Control\uFF09</code>\uFF1A\u57FA\u4E8E\u7528\u6237ID\uFF08UID\uFF09\u548C\u7EC4ID\uFF08GID\uFF09\uFF0C\u6765\u5224\u5B9A\u5BF9\u5BF9\u8C61\uFF08\u4F8B\u5982\u6587\u4EF6\uFF09 \u7684\u8BBF\u95EE\u6743\u9650\u3002</li><li><code>\u5B89\u5168\u6027\u589E\u5F3A\u7684 Linux\uFF08SELinux\uFF09</code>\uFF1A \u4E3A\u5BF9\u8C61\u8D4B\u4E88\u5B89\u5168\u6027\u6807\u7B7E\u3002</li><li>\u4EE5<code>\u7279\u6743\u6A21\u5F0F</code>\u6216\u8005\u975E\u7279\u6743\u6A21\u5F0F\u8FD0\u884C\u3002</li><li><code>Linux Capabilities</code>: \u4E3A\u8FDB\u7A0B\u8D4B\u4E88 root \u7528\u6237\u7684\u90E8\u5206\u7279\u6743\u800C\u975E\u5168\u90E8\u7279\u6743\u3002</li><li><code>AppArmor</code>\uFF1A\u5B9A\u4E49Pod\u4F7F\u7528AppArmor\u9650\u5236\u5BB9\u5668\u5BF9\u8D44\u6E90\u8BBF\u95EE\u9650\u5236</li><li><code>Seccomp</code>\uFF1A\u5B9A\u4E49Pod\u4F7F\u7528Seccomp\u9650\u5236\u5BB9\u5668\u8FDB\u7A0B\u7684\u7CFB\u7EDF\u8C03\u7528</li><li><code>AllowPrivilegeEscalation</code>\uFF1A \u7981\u6B62\u5BB9\u5668\u4E2D\u8FDB\u7A0B\uFF08\u901A\u8FC7 SetUID \u6216 SetGID \u6587\u4EF6\u6A21\u5F0F\uFF09\u83B7\u5F97\u7279\u6743\u63D0\u5347\u3002\u5F53\u5BB9\u5668\u4EE5\u7279\u6743\u6A21\u5F0F \u8FD0\u884C\u6216\u8005\u5177\u6709CAP_SYS_ADMIN\u80FD\u529B\u65F6\uFF0CAllowPrivilegeEscalation\u603B\u4E3ATrue\u3002</li><li><code>readOnlyRootFilesystem</code>\uFF1A\u4EE5\u53EA\u8BFB\u65B9\u5F0F\u52A0\u8F7D\u5BB9\u5668\u7684\u6839\u6587\u4EF6\u7CFB\u7EDF\u3002</li></ul><h3 id="\u6848\u4F8B\u5B9E\u65BD" tabindex="-1"><a class="header-anchor" href="#\u6848\u4F8B\u5B9E\u65BD" aria-hidden="true">#</a> \u6848\u4F8B\u5B9E\u65BD</h3><h5 id="\u6848\u4F8B1-\u8BBE\u7F6E\u5BB9\u5668\u4EE5\u666E\u901A\u7528\u6237\u8FD0\u884C" tabindex="-1"><a class="header-anchor" href="#\u6848\u4F8B1-\u8BBE\u7F6E\u5BB9\u5668\u4EE5\u666E\u901A\u7528\u6237\u8FD0\u884C" aria-hidden="true">#</a> \u6848\u4F8B1\uFF1A\u8BBE\u7F6E\u5BB9\u5668\u4EE5\u666E\u901A\u7528\u6237\u8FD0\u884C</h5><p>\u80CC\u666F\uFF1A\u5BB9\u5668\u4E2D\u7684\u5E94\u7528\u7A0B\u5E8F\u9ED8\u8BA4\u4EE5root\u8D26\u53F7\u8FD0\u884C\u7684\uFF0C\u8FD9\u4E2Aroot\u4E0E\u5BBF\u4E3B\u673Aroot\u8D26\u53F7\u662F\u76F8\u540C\u7684\uFF0C \u62E5\u6709\u5927\u90E8\u5206\u5BF9Linux\u5185\u6838\u7684\u7CFB\u7EDF\u8C03\u7528\u6743\u9650\uFF0C\u8FD9\u6837\u662F\u4E0D\u5B89\u5168\u7684\uFF0C\u6240\u4EE5\u6211\u4EEC\u5E94\u8BE5\u5C06\u5BB9\u5668\u4EE5\u666E \u901A\u7528\u6237\u8FD0\u884C\uFF0C\u51CF\u5C11\u5E94\u7528\u7A0B\u5E8F\u5BF9\u6743\u9650\u7684\u4F7F\u7528\u3002</p><p>\u53EF\u4EE5\u901A\u8FC7\u4E24\u79CD\u65B9\u6CD5\u8BBE\u7F6E\u666E\u901A\u7528\u6237\uFF1A</p><ol><li>Dockerfile\u91CC\u4F7F\u7528USER\u6307\u5B9A\u8FD0\u884C\u7528\u6237</li><li>K8s\u91CC\u6307\u5B9Aspec.securityContext.runAsUser\uFF0C\u6307\u5B9A\u5BB9\u5668\u9ED8\u8BA4\u7528\u6237UID</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
    <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">1000</span> 	<span class="token comment"># \u955C\u50CF\u91CC\u5FC5\u987B\u6709\u8FD9\u4E2A\u7528\u6237UID</span>
    <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">1000</span> 		<span class="token comment"># \u6570\u636E\u5377\u6302\u8F7D\u540E\u7684\u76EE\u5F55\u5C5E\u7EC4\u8BBE\u7F6E\u4E3A\u8BE5\u7EC4</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> lizhenliang/flask<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>root
    <span class="token key atrule">name</span><span class="token punctuation">:</span> web
    <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
      <span class="token key atrule">allowPrivilegeEscalation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># \u4E0D\u5141\u8BB8\u63D0\u6743</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u521B\u5EFAPod\u4F7F\u7528\u5B89\u5168\u4E0A\u4E0B\u6587\u6D4B\u8BD5\u662F\u5426\u6539\u4E3Auuid\u8FD0\u884C\u5BB9\u5668:</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span> <span class="token comment"># cat pod-test.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
    <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">1000</span>
    <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">1000</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> lizhenliang/flask<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>root
    <span class="token key atrule">name</span><span class="token punctuation">:</span> test
    <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
      <span class="token key atrule">allowPrivilegeEscalation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6267\u884Cyaml\u4E4B\u540E\u8FDB\u5165\u5BB9\u5668\u67E5\u770B\u5F53\u524D\u7684uuid\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it test -- bash</span>
python@test:/data/www$ <span class="token function">id</span>
<span class="token assign-left variable">uid</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">(</span>python<span class="token punctuation">)</span> <span class="token assign-left variable">gid</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">(</span>python<span class="token punctuation">)</span> <span class="token assign-left variable">groups</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">(</span>python<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="\u6848\u4F8B2-\u907F\u514D\u4F7F\u7528\u7279\u6743\u5BB9\u5668" tabindex="-1"><a class="header-anchor" href="#\u6848\u4F8B2-\u907F\u514D\u4F7F\u7528\u7279\u6743\u5BB9\u5668" aria-hidden="true">#</a> \u6848\u4F8B2\uFF1A\u907F\u514D\u4F7F\u7528\u7279\u6743\u5BB9\u5668</h5><p>\u80CC\u666F\uFF1A\u5BB9\u5668\u4E2D\u6709\u4E9B\u5E94\u7528\u7A0B\u5E8F\u53EF\u80FD\u9700\u8981\u8BBF\u95EE\u5BBF\u4E3B\u673A\u8BBE\u5907\u3001\u4FEE\u6539\u5185\u6838\u7B49\u9700\u6C42\uFF0C\u5728\u9ED8\u8BA4\u60C5\u51B5\u4E0B\uFF0C \u5BB9\u5668\u6CA1\u8FD9\u4E2A\u6709\u8FD9\u4E2A\u80FD\u529B\uFF0C\u56E0\u6B64\u8FD9\u65F6\u4F1A\u8003\u8651\u7ED9\u5BB9\u5668\u8BBE\u7F6E\u7279\u6743\u6A21\u5F0F\u3002</p><p>\u542F\u7528\u7279\u6743\u6A21\u5F0F\uFF1A</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">containers</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> lizhenliang/flask<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>root
  <span class="token key atrule">name</span><span class="token punctuation">:</span> web
  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
    <span class="token key atrule">privileged</span><span class="token punctuation">:</span> true / false 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>\u542F\u7528\u7279\u6743\u6A21\u5F0F\u5C31\u610F\u5473\u7740\uFF0C\u4F60\u8981\u4E3A\u5BB9\u5668\u63D0\u4F9B\u4E86\u8BBF\u95EELinux\u5185\u6838\u7684\u6240\u6709\u80FD\u529B\uFF0C\u8FD9\u662F\u5F88\u5371\u9669\u7684\uFF0C \u4E3A\u4E86\u51CF\u5C11\u7CFB\u7EDF\u8C03\u7528\u7684\u4F9B\u7ED9\uFF0C\u53EF\u4EE5\u4F7F\u7528Capabilities\u4E3A\u5BB9\u5668\u8D4B\u4E88\u4EC5\u6240\u9700\u7684\u80FD\u529B\u3002</p></blockquote><p><code>Linux Capabilities\uFF1ACapabilities \u662F\u4E00\u4E2A\u5185\u6838\u7EA7\u522B\u7684\u6743\u9650</code>\uFF0C\u5B83\u5141\u8BB8\u5BF9\u5185\u6838\u8C03\u7528\u6743 \u9650\u8FDB\u884C\u66F4\u7EC6\u7C92\u5EA6\u7684\u63A7\u5236\uFF0C\u800C\u4E0D\u662F\u7B80\u5355\u5730\u4EE5 root \u8EAB\u4EFD\u80FD\u529B\u6388\u6743\u3002 Capabilities \u5305\u62EC\u66F4\u6539\u6587\u4EF6\u6743\u9650\u3001\u63A7\u5236\u7F51\u7EDC\u5B50\u7CFB\u7EDF\u548C\u6267\u884C\u7CFB\u7EDF\u7BA1\u7406\u7B49\u529F\u80FD\u3002\u5728 securityContext \u4E2D\uFF0C\u53EF\u4EE5\u6DFB\u52A0\u6216\u5220\u9664 Capabilities\uFF0C\u505A\u5230\u5BB9\u5668\u7CBE\u7EC6\u5316\u6743\u9650\u63A7\u5236\u3002</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204141224069.png" alt="image-20220413084355164" loading="lazy"></p><h5 id="\u6848\u4F8B3-\u53D6\u6D88\u6302\u8F7D\u6587\u4EF6\u7CFB\u7EDF" tabindex="-1"><a class="header-anchor" href="#\u6848\u4F8B3-\u53D6\u6D88\u6302\u8F7D\u6587\u4EF6\u7CFB\u7EDF" aria-hidden="true">#</a> \u6848\u4F8B3\uFF1A\u53D6\u6D88\u6302\u8F7D\u6587\u4EF6\u7CFB\u7EDF</h5><p>\u5BB9\u5668\u9ED8\u8BA4\u6CA1\u6709\u6302\u8F7D\u6587\u4EF6\u7CFB\u7EDF\u80FD\u529B\uFF0C\u6DFB\u52A0SYS_ADMIN\u589E\u52A0\u8FD9\u4E2A\u80FD\u529B</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox 
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">name</span><span class="token punctuation">:</span> test
    <span class="token key atrule">command</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> sleep
    <span class="token punctuation">-</span> 24h
    <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
      <span class="token key atrule">capabilities</span><span class="token punctuation">:</span>
        <span class="token key atrule">add</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;SYS_ADMIN&quot;</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u521B\u5EFA\u8FDB\u5165\u5BB9\u5668\u6D4B\u8BD5\u6302\u8F7D\u6743\u9650\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it  busybox -- sh</span>
/ <span class="token comment"># mount /data/ /tmp/</span>
mount: mounting /data/ on /tmp/ failed: Permission denied
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="\u6848\u4F8B4-\u53EA\u8BFB\u6302\u8F7D\u6743\u9650" tabindex="-1"><a class="header-anchor" href="#\u6848\u4F8B4-\u53EA\u8BFB\u6302\u8F7D\u6743\u9650" aria-hidden="true">#</a> \u6848\u4F8B4\uFF1A\u53EA\u8BFB\u6302\u8F7D\u6743\u9650</h5><p>\u53EA\u8BFB\u6302\u8F7D\u5BB9\u5668\u6587\u4EF6\u7CFB\u7EDF\uFF0C\u9632\u6B62\u6076\u610F\u4E8C\u8FDB\u5236\u6587\u4EF6\u521B\u5EFA</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">name</span><span class="token punctuation">:</span> test
    <span class="token key atrule">command</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> sleep
    <span class="token punctuation">-</span> 24h
    <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
      <span class="token key atrule">readOnlyRootFilesystem</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u521B\u5EFA\u8FDB\u5165\u5BB9\u5668\u6D4B\u8BD5\u6587\u4EF6\u6743\u9650\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it  busybox  -- sh</span>
/ <span class="token comment"># mkdir a</span>
mkdir: can<span class="token string">&#39;t create directory &#39;</span>a&#39;: Read-only <span class="token function">file</span> system
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="pod\u5B89\u5168\u7B56\u7565-psp" tabindex="-1"><a class="header-anchor" href="#pod\u5B89\u5168\u7B56\u7565-psp" aria-hidden="true">#</a> Pod\u5B89\u5168\u7B56\u7565\uFF08PSP\uFF09</h3><p><code>PodSecurityPolicy\uFF08\u7B80\u79F0PSP\uFF09</code>\uFF1AKubernetes\u4E2DPod\u90E8\u7F72\u65F6\u91CD\u8981\u7684\u5B89\u5168\u6821\u9A8C\u624B\u6BB5\uFF0C\u80FD\u591F \u6709\u6548\u5730\u7EA6\u675F\u5E94\u7528\u8FD0\u884C\u65F6\u884C\u4E3A\u5B89\u5168\u3002 \u4F7F\u7528PSP\u5BF9\u8C61\u5B9A\u4E49\u4E00\u7EC4Pod\u5728\u8FD0\u884C\u65F6\u5FC5\u987B\u9075\u5FAA\u7684\u6761\u4EF6\u53CA\u76F8\u5173\u5B57\u6BB5\u7684\u9ED8\u8BA4\u503C\uFF0C\u53EA\u6709Pod\u6EE1\u8DB3\u8FD9 \u4E9B\u6761\u4EF6\u624D\u4F1A\u88ABK8s\u63A5\u53D7\u3002</p><h4 id="pod\u5B89\u5168\u7B56\u7565\u9650\u5236\u7EF4\u5EA6" tabindex="-1"><a class="header-anchor" href="#pod\u5B89\u5168\u7B56\u7565\u9650\u5236\u7EF4\u5EA6" aria-hidden="true">#</a> Pod\u5B89\u5168\u7B56\u7565\u9650\u5236\u7EF4\u5EA6</h4><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204141224517.png" alt="image-20220413100840633" loading="lazy"></p><h4 id="\u542F\u7528\u51C6\u5165\u63A7\u5236\u5668" tabindex="-1"><a class="header-anchor" href="#\u542F\u7528\u51C6\u5165\u63A7\u5236\u5668" aria-hidden="true">#</a> \u542F\u7528\u51C6\u5165\u63A7\u5236\u5668</h4><p>Pod\u5B89\u5168\u7B56\u7565\u5B9E\u73B0\u4E3A\u4E00\u4E2A\u51C6\u5165\u63A7\u5236\u5668\uFF0C\u9ED8\u8BA4\u6CA1\u6709\u542F\u7528\uFF0C\u5F53\u542F\u7528\u540E\u4F1A\u5F3A\u5236\u5B9E\u65BD Pod\u5B89\u5168\u7B56\u7565\uFF0C\u6CA1\u6709\u6EE1\u8DB3\u7684Pod\u5C06\u65E0\u6CD5\u521B\u5EFA\u3002\u56E0\u6B64\uFF0C\u5EFA\u8BAE\u5728\u542F\u7528PSP\u4E4B\u524D\u5148\u6DFB\u52A0 \u7B56\u7565\u5E76\u5BF9\u5176\u6388\u6743\u3002</p><p>\u542F\u7528Pod\u5B89\u5168\u7B56\u7565\uFF1A</p><blockquote><p>vi /etc/kubernetes/manifests/kube-apiserver.yaml ... --enable-admission-plugins=NodeRestriction,PodSecurityPolicy ... systemctl restart kubelet</p></blockquote><h4 id="\u5982\u4F55\u4F7F\u7528psp\u8D44\u6E90" tabindex="-1"><a class="header-anchor" href="#\u5982\u4F55\u4F7F\u7528psp\u8D44\u6E90" aria-hidden="true">#</a> \u5982\u4F55\u4F7F\u7528PSP\u8D44\u6E90</h4><p>\u7528\u6237\u4F7F\u7528SA \uFF08ServiceAccount\uFF09\u521B\u5EFA\u4E86\u4E00\u4E2APod\uFF0C<code>K8s\u4F1A\u5148\u9A8C\u8BC1\u8FD9\u4E2ASA\u662F\u5426 \u53EF\u4EE5\u8BBF\u95EEPSP\u8D44\u6E90\u6743\u9650</code>\uFF0C\u5982\u679C\u53EF\u4EE5\u8FDB\u4E00\u6B65\u9A8C\u8BC1Pod\u914D\u7F6E\u662F\u5426\u6EE1\u8DB3PSP\u89C4\u5219\uFF0C\u4EFB \u610F\u4E00\u6B65\u4E0D\u6EE1\u8DB3\u90FD\u4F1A\u62D2\u7EDD\u90E8\u7F72\u3002</p><p>\u56E0\u6B64\uFF0C\u9700\u8981\u5B9E\u65BD\u9700\u8981\u6709\u8FD9\u51E0\u70B9\uFF1A</p><ol><li>\u521B\u5EFASA\u670D\u52A1\u8D26\u53F7</li><li>\u8BE5SA\u9700\u8981\u5177\u5907\u521B\u5EFA\u5BF9\u5E94\u8D44\u6E90\u6743\u9650\uFF0C\u4F8B\u5982\u521B\u5EFAPod\u3001Deployment</li><li>SA\u4F7F\u7528PSP\u8D44\u6E90\u6743\u9650\uFF1A\u521B\u5EFARole\uFF0C\u4F7F\u7528PSP\u8D44\u6E90\u6743\u9650\uFF0C\u518D\u5C06SA\u7ED1\u5B9ARole</li></ol><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204141224319.png" alt="image-20220413102111236" style="zoom:80%;"><h3 id="\u6848\u4F8B\u5B9E\u65BD-1" tabindex="-1"><a class="header-anchor" href="#\u6848\u4F8B\u5B9E\u65BD-1" aria-hidden="true">#</a> \u6848\u4F8B\u5B9E\u65BD</h3><h5 id="\u793A\u4F8B1-\u7981\u6B62\u521B\u5EFA\u7279\u6743\u6A21\u5F0F\u7684pod" tabindex="-1"><a class="header-anchor" href="#\u793A\u4F8B1-\u7981\u6B62\u521B\u5EFA\u7279\u6743\u6A21\u5F0F\u7684pod" aria-hidden="true">#</a> \u793A\u4F8B1\uFF1A\u7981\u6B62\u521B\u5EFA\u7279\u6743\u6A21\u5F0F\u7684Pod</h5><p>\u521B\u5EFAPod\u5B89\u5168\u7B56\u7565\u8D44\u6E90\u5982\u4E0B\uFF1A</p><ul><li>\u4E0D\u5141\u8BB8\u7279\u6743Pod</li><li>\u8FD0\u884CseLinux\u7684\u89C4\u5219</li><li>\u6307\u5B9A\u5BB9\u5668\u542F\u52A8\u7684\u7528\u6237ID\u548C\u4E3B\u7EC4ID\u4F4D\u4EFB\u4F55\u4EBA\u6216\u8005\u7981\u6B62\u6CA1\u6307\u5B9A\u666E\u901A\u7528\u6237\u8FD0\u884C\u7684\u5BB9\u5668\uFF08runAsUser\uFF09</li><li>\u5141\u8BB8\u4F7F\u7528\u6302\u8F7D\u7C7B\u578B\u6570\u636E\u5377</li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># cat psp.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> policy/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PodSecurityPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> psp<span class="token punctuation">-</span>example
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># \u4E0D\u5141\u8BB8\u7279\u6743Pod</span>
  <span class="token comment"># \u4E0B\u9762\u662F\u4E00\u4E9B\u5FC5\u8981\u7684\u5B57\u6BB5</span>
  <span class="token key atrule">seLinux</span><span class="token punctuation">:</span>
    <span class="token key atrule">rule</span><span class="token punctuation">:</span> RunAsAny
  <span class="token key atrule">supplementalGroups</span><span class="token punctuation">:</span>
    <span class="token key atrule">rule</span><span class="token punctuation">:</span> RunAsAny
  <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span>
    <span class="token key atrule">rule</span><span class="token punctuation">:</span> RunAsAny   /  MustRunAsNonRoot
  <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span>
    <span class="token key atrule">rule</span><span class="token punctuation">:</span> RunAsAny
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&#39;*&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6267\u884C\u4E4B\u540E\u67E5\u770B\u5F53\u524D\u7684PSP\u8D44\u6E90\u60C5\u51B5\uFF1A</p><p>\u5728\u540E\u7EED\u76841.25\u4E4B\u540E\u7684\u7248\u672C\u91CC\u9762\uFF0C\u5C06\u4F1A\u5B8C\u5168\u5E9F\u5F03Pod\u5B89\u5168\u7B56\u7565\uFF0C\u91C7\u7528\u5B89\u5168\u4E0A\u4E0B\u6587 \u7684\u65B9\u5F0F\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f psp.yaml</span>
Warning: policy/v1beta1 PodSecurityPolicy is deprecated <span class="token keyword">in</span> v1.21+, unavailable <span class="token keyword">in</span> v1.25+
podsecuritypolicy.policy/psp-example created

<span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl get psp</span>
Warning: policy/v1beta1 PodSecurityPolicy is deprecated <span class="token keyword">in</span> v1.21+, unavailable <span class="token keyword">in</span> v1.25+
NAME          PRIV    CAPS   SELINUX    RUNASUSER   FSGROUP    SUPGROUP   READONLYROOTFS   VOLUMES
psp-example   <span class="token boolean">false</span>          RunAsAny   RunAsAny    RunAsAny   RunAsAny   <span class="token boolean">false</span>            *
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="\u793A\u4F8B2-\u7981\u6B62\u521B\u5EFA\u7279\u6743\u6A21\u5F0F\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#\u793A\u4F8B2-\u7981\u6B62\u521B\u5EFA\u7279\u6743\u6A21\u5F0F\u6D41\u7A0B" aria-hidden="true">#</a> \u793A\u4F8B2\uFF1A\u7981\u6B62\u521B\u5EFA\u7279\u6743\u6A21\u5F0F\u6D41\u7A0B</h5><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u521B\u5EFASA</span>
$ kubectl create serviceaccount aliang

<span class="token comment"># \u5C06SA\u7ED1\u5B9A\u5230\u7CFB\u7EDF\u5185\u7F6ERole</span>
$ kubectl create rolebinding aliang <span class="token parameter variable">--clusterrole</span><span class="token operator">=</span>edit <span class="token parameter variable">--serviceaccount</span><span class="token operator">=</span>default:aliang

<span class="token comment"># \u521B\u5EFA\u4F7F\u7528PSP\u6743\u9650\u7684Role</span>
$ kubectl create role psp:unprivileged <span class="token parameter variable">--verb</span><span class="token operator">=</span>use <span class="token parameter variable">--resource</span><span class="token operator">=</span>podsecuritypolicy --resource-name<span class="token operator">=</span>psp-example

<span class="token comment"># \u5C06SA\u7ED1\u5B9A\u5230Role</span>
$ kubectl create rolebinding aliang:psp:unprivileged <span class="token parameter variable">--role</span><span class="token operator">=</span>psp:unprivileged <span class="token parameter variable">--serviceaccount</span><span class="token operator">=</span>default:aliang

<span class="token comment"># \u521B\u5EFApod\u6D4B\u8BD5</span>
$ kubectl <span class="token parameter variable">--as</span><span class="token operator">=</span>system:serviceaccount:default:psp-sa run nginx <span class="token parameter variable">--image</span><span class="token operator">=</span>nginx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="opa-gatekeeper" tabindex="-1"><a class="header-anchor" href="#opa-gatekeeper" aria-hidden="true">#</a> OPA Gatekeeper</h3><h4 id="opa\u4ECB\u7ECD" tabindex="-1"><a class="header-anchor" href="#opa\u4ECB\u7ECD" aria-hidden="true">#</a> OPA\u4ECB\u7ECD</h4><p>PSP\u4E0D\u8DB3\u4E0E\u72B6\u51B5\uFF1A</p><ul><li>\u5C06\u518D1.21\u7248\u672C\u5F03\u7528PSP\uFF0C\u57281.25\u7248\u672C\u5220\u9664PSP</li><li>\u4EC5\u652F\u6301Pod\u7B56\u7565</li><li>\u4F7F\u7528\u590D\u6742\uFF0C\u6743\u9650\u6A21\u578B\u5B58\u5728\u7F3A\u9677\uFF0C\u63A7\u5236\u4E0D\u660E\u786E</li></ul>`,64),r={href:"https://kubernetes.io/blog/2021/04/06/podsecuritypolicy-deprecation-past-present-and-future/",target:"_blank",rel:"noopener noreferrer"},d={href:"https://github.com/kubernetes/enhancements/issues/2579",target:"_blank",rel:"noopener noreferrer"},k=t(`<p><code>OPA\uFF08Open Policy Agent\uFF09</code>\uFF1A\u662F\u4E00\u4E2A\u5F00\u6E90\u7684\u3001\u901A\u7528\u7B56\u7565\u5F15\u64CE\uFF0C\u53EF\u4EE5\u5C06\u7B56\u7565\u7F16\u5199\u4E3A\u4EE3\u7801\u3002\u63D0\u4F9B \u4E00\u4E2A\u79CD\u9AD8\u7EA7\u58F0\u660E\u6027\u8BED\u8A00-Rego\u6765\u7F16\u5199\u7B56\u7565\uFF0C\u5E76\u628A\u51B3\u7B56\u8FD9\u4E00\u6B65\u9AA4\u4ECE\u590D\u6742\u7684\u4E1A\u52A1\u903B\u8F91\u4E2D\u89E3\u8026\u51FA\u6765\u3002</p><p>OPA\u53EF\u4EE5\u7528\u6765\u505A\u4EC0\u4E48\uFF1F</p><ol><li>\u62D2\u7EDD\u4E0D\u7B26\u5408\u6761\u4EF6\u7684YAML\u90E8\u7F72</li><li>\u5141\u8BB8\u4F7F\u7528\u54EA\u4E9B\u4ED3\u5E93\u4E2D\u7684\u955C\u50CF</li><li>\u5141\u8BB8\u5728\u54EA\u4E2A\u65F6\u95F4\u6BB5\u8BBF\u95EE\u7CFB\u7EDF</li><li>\u7B49...</li></ol><h4 id="opa\u5DE5\u4F5C\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#opa\u5DE5\u4F5C\u6D41\u7A0B" aria-hidden="true">#</a> OPA\u5DE5\u4F5C\u6D41\u7A0B</h4><p>Gatekeeper \u662F\u57FA\u4E8E OPA\u7684\u4E00\u4E2A Kubernetes \u7B56\u7565\u89E3\u51B3\u65B9\u6848\uFF0C\u53EF\u66FF\u4EE3PSP\u6216\u8005\u90E8\u5206RBAC\u529F\u80FD\u3002</p><p>\u5F53\u5728\u96C6\u7FA4\u4E2D\u90E8\u7F72\u4E86Gatekeeper\u7EC4\u4EF6\uFF0CAPIServer\u6240\u6709\u7684\u521B\u5EFA\u3001\u66F4\u65B0\u6216\u8005\u5220\u9664\u64CD\u4F5C\u90FD\u4F1A\u89E6\u53D1 Gatekeeper\u6765\u5904\u7406\uFF0C\u5982\u679C\u4E0D\u6EE1\u8DB3\u7B56\u7565\u5219\u62D2\u7EDD\u3002</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204141223253.png" alt="image-20220413133253793" loading="lazy"></p><h4 id="\u90E8\u7F72opa-gatekeeper" tabindex="-1"><a class="header-anchor" href="#\u90E8\u7F72opa-gatekeeper" aria-hidden="true">#</a> \u90E8\u7F72OPA Gatekeeper</h4><p>Gatekeeper\u7684\u7B56\u7565\u7531\u4E24\u4E2A\u8D44\u6E90\u5BF9\u8C61\u7EC4\u6210\uFF1A</p><ul><li><code>Template</code>\uFF1A\u7B56\u7565\u903B\u8F91\u5B9E\u73B0\u7684\u5730\u65B9\uFF0C\u4F7F\u7528rego\u8BED\u8A00</li><li><code>Contsraint</code>\uFF1A\u8D1F\u8D23Kubernetes\u8D44\u6E90\u5BF9\u8C61\u7684\u8FC7\u6EE4\u6216\u8005\u4E3ATemplate\u63D0\u4F9B\u8F93\u5165\u53C2\u6570</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/open-policy-agent/gatekeeper/release-3.7/deploy/gatekeeper.yaml</span>

<span class="token punctuation">[</span>root@master01:~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n gatekeeper-system</span>
NAME                                             READY   STATUS    RESTARTS   AGE
gatekeeper-controller-manager-66f474f785-kn5fl   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          32s
gatekeeper-controller-manager-66f474f785-xgz7s   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          32s
gatekeeper-controller-manager-66f474f785-xxwdm   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          32s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u6848\u4F8B\u5B9E\u65BD-2" tabindex="-1"><a class="header-anchor" href="#\u6848\u4F8B\u5B9E\u65BD-2" aria-hidden="true">#</a> \u6848\u4F8B\u5B9E\u65BD</h3><h5 id="\u6848\u4F8B1-\u7981\u6B62\u5BB9\u5668\u542F\u7528\u7279\u6743" tabindex="-1"><a class="header-anchor" href="#\u6848\u4F8B1-\u7981\u6B62\u5BB9\u5668\u542F\u7528\u7279\u6743" aria-hidden="true">#</a> \u6848\u4F8B1\uFF1A\u7981\u6B62\u5BB9\u5668\u542F\u7528\u7279\u6743</h5><ul><li>\u9700\u8981\u521B\u5EFA<code>ConstraintTemplate</code>\u7684\u8D44\u6E90</li><li>\u4F7F\u7528<code>rego</code>\u7684\u8BED\u8A00\u7F16\u5199\u5BF9\u542F\u7528\u7279\u6743\u7684\u8D44\u6E90\u53D1\u51FA\u8B66\u544A</li><li>\u9700\u8981\u6307\u5B9A\u7C7B\u578B\u4E3A<code>privileged</code>\u6A21\u5F0F</li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># cat privileged_tpl.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> templates.gatekeeper.sh/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConstraintTemplate
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> privileged
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">crd</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">names</span><span class="token punctuation">:</span>
        <span class="token key atrule">kind</span><span class="token punctuation">:</span> privileged
  <span class="token key atrule">targets</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">target</span><span class="token punctuation">:</span> admission.k8s.gatekeeper.sh
      <span class="token key atrule">rego</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        package admission
        violation[{&quot;msg&quot;: msg}] {  # \u5982\u679Cviolation\u4E3Atrue\u8BF4\u660E\u8FDD\u53CD\u7EA6\u675F
          containers = input.review.object.spec.template.spec.containers
          c_name := containers[0].name
          containers[0].securityContext.privileged # \u5982\u679C\u8FD4\u56DEfalse\u6216\u8005\u6CA1\u83B7\u53D6\u5230\u503C\u8BF4\u660E\u901A\u8FC7
          msg := sprintf(&quot;\u63D0\u793A\uFF1A&#39;%v&#39;\u5BB9\u5668\u7981\u6B62\u542F\u7528\u7279\u6743\uFF01&quot;,[c_name])
        }</span>
        
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl get ConstraintTemplate</span>
NAME         AGE
privileged   32m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u521B\u5EFA\u7EA6\u675F\u3001\u5982\u4E0B\u662F\u7EA6\u675F\u8D44\u6E90\u7C7B\u578B\uFF1A</p><ul><li>Deployment</li><li>DaemonSet</li><li>StatefulSet</li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># cat privileged_constraints.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> constraints.gatekeeper.sh/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> privileged
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> privileged
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">match</span><span class="token punctuation">:</span>  <span class="token comment"># \u5339\u914D\u7684\u8D44\u6E90</span>
    <span class="token key atrule">kinds</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;apps&quot;</span><span class="token punctuation">]</span>
        <span class="token key atrule">kinds</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token string">&quot;Deployment&quot;</span>
        <span class="token punctuation">-</span> <span class="token string">&quot;DaemonSet&quot;</span>
        <span class="token punctuation">-</span> <span class="token string">&quot;StatefulSet&quot;</span>
        
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl get constraints</span>
NAME         AGE
privileged   31m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u521B\u5EFADeployment\u5F00\u542F\u7279\u6743\u6A21\u5F0F\u518D\u6267\u884C\u521B\u5EFA\u4F1A\u53D1\u51FA\u8B66\u544A\u3002</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
          <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f deployment.yaml</span>
Error from server (<span class="token punctuation">[</span>privileged<span class="token punctuation">]</span> \u63D0\u793A\uFF1A&#39;nginx&#39;\u5BB9\u5668\u7981\u6B62\u542F\u7528\u7279\u6743\uFF01)<span class="token punctuation">:</span> <span class="token key atrule">error when creating &quot;dp.yaml&quot;</span><span class="token punctuation">:</span> <span class="token key atrule">admission webhook &quot;validation.gatekeeper.sh&quot; denied the request</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>privileged<span class="token punctuation">]</span> \u63D0\u793A\uFF1A&#39;nginx&#39;\u5BB9\u5668\u7981\u6B62\u542F\u7528\u7279\u6743\uFF01
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="\u6848\u4F8B2-\u53EA\u5141\u8BB8\u4F7F\u7528\u7279\u5B9A\u7684\u955C\u50CF\u4ED3\u5E93" tabindex="-1"><a class="header-anchor" href="#\u6848\u4F8B2-\u53EA\u5141\u8BB8\u4F7F\u7528\u7279\u5B9A\u7684\u955C\u50CF\u4ED3\u5E93" aria-hidden="true">#</a> \u6848\u4F8B2\uFF1A\u53EA\u5141\u8BB8\u4F7F\u7528\u7279\u5B9A\u7684\u955C\u50CF\u4ED3\u5E93</h5><ul><li>\u9700\u8981\u521B\u5EFA<code>ConstraintTemplate</code>\u7684\u8D44\u6E90</li><li>\u4F7F\u7528<code>rego</code>\u7684\u8BED\u8A00\u7F16\u5199\u5BF9\u955C\u50CF\u4ED3\u5E93\u7684\u4FE1\u4EFB</li><li>\u9700\u8981\u6307\u5B9A\u7C7B\u578B\u4E3A<code>image-check</code>\u6A21\u5F0F</li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># cat   image-check_tpl.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> templates.gatekeeper.sh/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConstraintTemplate
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> image<span class="token punctuation">-</span>check
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">crd</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">names</span><span class="token punctuation">:</span>
        <span class="token key atrule">kind</span><span class="token punctuation">:</span> image<span class="token punctuation">-</span>check
      <span class="token key atrule">validation</span><span class="token punctuation">:</span>
        <span class="token key atrule">openAPIV3Schema</span><span class="token punctuation">:</span>
          <span class="token key atrule">properties</span><span class="token punctuation">:</span>  <span class="token comment"># \u9700\u8981\u6EE1\u8DB3\u6761\u4EF6\u7684\u53C2\u6570</span>
            <span class="token key atrule">prefix</span><span class="token punctuation">:</span>
              <span class="token key atrule">type</span><span class="token punctuation">:</span> string
  <span class="token key atrule">targets</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">target</span><span class="token punctuation">:</span> admission.k8s.gatekeeper.sh
      <span class="token key atrule">rego</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        package image
        violation[{&quot;msg&quot;: msg}] {
          containers = input.review.object.spec.template.spec.containers
          image := containers[0].image
          not startswith(image, input.parameters.prefix)
          msg := sprintf(&quot;\u63D0\u793A\uFF1A&#39;%v&#39;\u955C\u50CF\u5730\u5740\u4E0D\u5728\u53EF\u4FE1\u4EFB\u4ED3\u5E93\uFF01&quot;, [image])
        }</span>
        
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl get constrainttemplate</span>
NAME          AGE
image<span class="token punctuation">-</span>check   77s
privileged    35m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u91CC\u9700\u8981\u914D\u7F6E\u4F20\u9012OPA\u7684\u53C2\u6570\u4E3A\uFF1A &quot;lizhenliang/&quot;</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># cat image-check_constraints.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> constraints.gatekeeper.sh/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> image<span class="token punctuation">-</span>check
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> image<span class="token punctuation">-</span>check
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token key atrule">kinds</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;apps&quot;</span><span class="token punctuation">]</span>
        <span class="token key atrule">kinds</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token string">&quot;Deployment&quot;</span>
        <span class="token punctuation">-</span> <span class="token string">&quot;DaemonSet&quot;</span>
        <span class="token punctuation">-</span> <span class="token string">&quot;StatefulSet&quot;</span>
  <span class="token key atrule">parameters</span><span class="token punctuation">:</span>  <span class="token comment"># \u4F20\u9012\u7ED9opa\u7684\u53C2\u6570</span>
    <span class="token key atrule">prefix</span><span class="token punctuation">:</span> <span class="token string">&quot;lizhenliang/&quot;</span>
    
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl get constraints</span>
NAME                                                AGE
image<span class="token punctuation">-</span>check.constraints.gatekeeper.sh/image<span class="token punctuation">-</span>check   77s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6267\u884C\u6D4B\u8BD5\u65F6\u4F7F\u7528docker\u5B98\u65B9\u7684\u955C\u50CF\u4ED3\u5E93\uFF1A</p><ol><li><code>\u7531\u4E8E\u6211\u4EEC\u5F00\u542F\u4E86\u955C\u50CF\u4ED3\u5E93\u7684\u4FE1\u4EFB \u6240\u4EE5\u5BF9docker\u4ED3\u5E93\u4E0D\u652F\u6301</code></li><li><code>\u53EA\u80FD\u4ECElizhenliang\u8BE5\u4ED3\u5E93\u8FDB\u884C\u62C9\u53D6\u955C\u50CF</code></li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl create deployment test --image=nginx</span>
error: failed to create deployment: admission webhook <span class="token string">&quot;validation.gatekeeper.sh&quot;</span> denied the request: <span class="token punctuation">[</span>image-check<span class="token punctuation">]</span> \u63D0\u793A\uFF1A<span class="token string">&#39;nginx&#39;</span>\u955C\u50CF\u5730\u5740\u4E0D\u5728\u53EF\u4FE1\u4EFB\u4ED3\u5E93\uFF01
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="secret\u5B58\u50A8\u654F\u611F\u6570\u636E" tabindex="-1"><a class="header-anchor" href="#secret\u5B58\u50A8\u654F\u611F\u6570\u636E" aria-hidden="true">#</a> Secret\u5B58\u50A8\u654F\u611F\u6570\u636E</h3><p>Secret\u662F\u4E00\u4E2A\u7528\u4E8E\u5B58\u50A8\u654F\u611F\u6570\u636E\u7684\u8D44\u6E90\uFF0C\u6240\u6709\u7684\u6570\u636E\u8981\u7ECF\u8FC7base64\u7F16\u7801\uFF0C\u6570\u636E\u5B9E\u9645\u4F1A\u5B58\u50A8\u5728K8s\u4E2DEtcd\uFF0C \u7136\u540E\u901A\u8FC7\u521B\u5EFAPod\u65F6\u5F15\u7528\u8BE5\u6570\u636E\u3002</p><p>\u5E94\u7528\u573A\u666F\uFF1A\u51ED\u636E</p><p>Pod\u4F7F\u7528secret\u6570\u636E\u6709\u4E24\u79CD\u65B9\u5F0F\uFF1A</p><ul><li><code>\u53D8\u91CF\u6CE8\u5165</code></li><li><code>\u6570\u636E\u5377\u6302\u8F7D</code></li></ul><h4 id="secret\u7684\u7C7B\u578B" tabindex="-1"><a class="header-anchor" href="#secret\u7684\u7C7B\u578B" aria-hidden="true">#</a> secret\u7684\u7C7B\u578B</h4><p>kubectl create secret \u652F\u6301\u4E09\u79CD\u6570\u636E\u7C7B\u578B\uFF1A</p><ul><li>docker-registry\uFF1A\u5B58\u50A8\u955C\u50CF\u4ED3\u5E93\u8BA4\u8BC1\u4FE1\u606F</li><li>generic\uFF1A\u4ECE\u6587\u4EF6\u3001\u76EE\u5F55\u6216\u8005\u5B57\u7B26\u4E32\u521B\u5EFA\uFF0C\u4F8B\u5982\u5B58\u50A8\u7528\u6237\u540D\u5BC6\u7801</li><li>tls\uFF1A\u5B58\u50A8\u8BC1\u4E66\uFF0C\u4F8B\u5982HTTPS\u8BC1\u4E66</li></ul><h4 id="secret\u7684\u4F7F\u7528" tabindex="-1"><a class="header-anchor" href="#secret\u7684\u4F7F\u7528" aria-hidden="true">#</a> secret\u7684\u4F7F\u7528</h4><p>\u4E00\u4E2A Secret \u53EF\u4EE5\u5305\u542B Pod \u8BBF\u95EE\u6570\u636E\u5E93\u6240\u9700\u7684\u7528\u6237\u51ED\u8BC1\u3002 \u4F8B\u5982\uFF0C\u7531\u7528\u6237\u540D\u548C\u5BC6\u7801\u7EC4\u6210\u7684\u6570\u636E\u5E93\u8FDE\u63A5\u5B57\u7B26\u4E32\u3002 \u4F60 \u53EF\u4EE5\u5728\u672C\u5730\u8BA1\u7B97\u673A\u4E0A\uFF0C\u5C06\u7528\u6237\u540D\u5B58\u50A8\u5728\u6587\u4EF6 <code>./username.txt</code> \u4E2D\uFF0C\u5C06\u5BC6\u7801\u5B58\u50A8\u5728\u6587\u4EF6 <code>./password.txt</code> \u4E2D\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># echo -n &#39;admin&#39; &gt; username.txt</span>
<span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># echo -n &#39;1a2b3c4d&#39; &gt; password.txt</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728\u8FD9\u4E9B\u547D\u4EE4\u4E2D\uFF0C -n \u6807\u5FD7\u786E\u4FDD\u751F\u6210\u7684\u6587\u4EF6\u5728\u6587\u672C\u672B\u5C3E\u4E0D\u5305\u542B\u989D\u5916\u7684\u6362\u884C\u7B26\u3002 \u8FD9\u4E00\u70B9\u5F88\u91CD\u8981\uFF0C\u56E0\u4E3A\u5F53 kubectl \u8BFB \u53D6\u6587\u4EF6\u5E76\u5C06\u5185\u5BB9\u7F16\u7801\u4E3A base64 \u5B57\u7B26\u4E32\u65F6\uFF0C\u591A\u4F59\u7684\u6362\u884C\u7B26\u4E5F\u4F1A\u88AB\u7F16\u7801\u3002</p><p>kubectl create secret \u547D\u4EE4\u5C06\u8FD9\u4E9B\u6587\u4EF6\u6253\u5305\u6210\u4E00\u4E2A Secret \u5E76\u5728 API \u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u5BF9\u8C61\u3002</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># kubectl create secret generic db-user-pass --from-file=username.txt --from-file=password.txt</span>
secret/db<span class="token punctuation">-</span>user<span class="token punctuation">-</span>pass created

<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># kubectl get secrets db-user-pass -o yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">password.txt</span><span class="token punctuation">:</span> MWEyYjNjNGQ=
  <span class="token key atrule">username.txt</span><span class="token punctuation">:</span> YWRtaW4=
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">&quot;2022-04-13T06:43:03Z&quot;</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> db<span class="token punctuation">-</span>user<span class="token punctuation">-</span>pass
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">&quot;100098&quot;</span>
  <span class="token key atrule">uid</span><span class="token punctuation">:</span> 440fa829<span class="token punctuation">-</span>0135<span class="token punctuation">-</span>4ef2<span class="token punctuation">-</span>b8dc<span class="token punctuation">-</span>9f06f5a2f2a3
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u89E3\u7801-secret" tabindex="-1"><a class="header-anchor" href="#\u89E3\u7801-secret" aria-hidden="true">#</a> \u89E3\u7801 Secret</h4><p>\u8981\u67E5\u770B\u521B\u5EFA\u7684 Secret \u7684\u5185\u5BB9\uFF0C\u8FD0\u884C\u4EE5\u4E0B\u547D\u4EE4\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl get secrets db-user-pass -o jsonpath=&#39;{.data}&#39;</span>
<span class="token punctuation">{</span><span class="token string">&quot;password.txt&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;MWEyYjNjNGQ=&quot;</span>,<span class="token string">&quot;username.txt&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;YWRtaW4=&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># echo &#39;MWEyYjNjNGQ=&#39; | base64 -d</span>
1a2b3c4d
<span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># echo &#39;YWRtaW4=&#39; | base64 -d</span>
admin
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u6848\u4F8B\u5B9E\u65BD-3" tabindex="-1"><a class="header-anchor" href="#\u6848\u4F8B\u5B9E\u65BD-3" aria-hidden="true">#</a> \u6848\u4F8B\u5B9E\u65BD</h3><h5 id="\u793A\u4F8B-\u5C06mysql\u7528\u6237\u5BC6\u7801\u4FDD\u5B58\u5230secret\u4E2D\u5B58\u50A8" tabindex="-1"><a class="header-anchor" href="#\u793A\u4F8B-\u5C06mysql\u7528\u6237\u5BC6\u7801\u4FDD\u5B58\u5230secret\u4E2D\u5B58\u50A8" aria-hidden="true">#</a> \u793A\u4F8B\uFF1A\u5C06Mysql\u7528\u6237\u5BC6\u7801\u4FDD\u5B58\u5230Secret\u4E2D\u5B58\u50A8</h5><p>\u521B\u5EFAsecret\uFF0Cmysql-root-password\u7684\u952E\u503C\u662F1a2a3a4a</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># kubectl create secret generic mysql --from-literal=mysql-root-password=1a2a3a4a</span>
secret/mysql created

<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># kubectl get secrets mysql -o yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">mysql-root-password</span><span class="token punctuation">:</span> MWEyYTNhNGE=
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">&quot;2022-04-13T07:06:21Z&quot;</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">&quot;102066&quot;</span>
  <span class="token key atrule">uid</span><span class="token punctuation">:</span> 3104256b<span class="token punctuation">-</span>5b46<span class="token punctuation">-</span>43a4<span class="token punctuation">-</span>85ed<span class="token punctuation">-</span>acc66be7ccba
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u521B\u5EFAPod\u6D4B\u8BD5\uFF0C\u4F7F\u7528env\u4ECEsecret\u4E2D\u5F15\u7528\u53D8\u91CF</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># cat pod.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> mysql
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> master01
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span>  mysql<span class="token punctuation">:</span><span class="token number">5.6</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_ROOT_PASSWORD
      <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
        <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
          <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>root<span class="token punctuation">-</span>password
          
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># kubectl get pods</span>
NAME    READY   STATUS    RESTARTS   AGE
mysql   1/1     Running   0          21s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u5B89\u5168\u6C99\u7BB1\u8FD0\u884C\u5BB9\u5668" tabindex="-1"><a class="header-anchor" href="#\u5B89\u5168\u6C99\u7BB1\u8FD0\u884C\u5BB9\u5668" aria-hidden="true">#</a> \u5B89\u5168\u6C99\u7BB1\u8FD0\u884C\u5BB9\u5668</h3><h4 id="gvisor\u4ECB\u7ECD" tabindex="-1"><a class="header-anchor" href="#gvisor\u4ECB\u7ECD" aria-hidden="true">#</a> gVisor\u4ECB\u7ECD</h4><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204141224780.png" alt="image-20220413152858652" style="zoom:80%;"><p>\u6240\u77E5\uFF0C\u5BB9\u5668\u7684\u5E94\u7528\u7A0B\u5E8F\u53EF\u4EE5\u76F4\u63A5\u8BBF\u95EELinux\u5185\u6838\u7684\u7CFB\u7EDF\u8C03\u7528\uFF0C\u5BB9\u5668\u5728\u5B89\u5168\u9694\u79BB\u4E0A\u8FD8\u662F\u6BD4\u8F83\u5F31\uFF0C\u867D\u7136 \u5185\u6838\u5728\u4E0D\u65AD\u5730\u589E\u5F3A\u81EA\u8EAB\u7684\u5B89\u5168\u7279\u6027\uFF0C\u4F46\u7531\u4E8E\u5185\u6838\u81EA\u8EAB\u4EE3\u7801\u6781\u7AEF\u590D\u6742\uFF0CCVE \u6F0F\u6D1E\u5C42\u51FA\u4E0D\u7A77\u3002 \u6240\u4EE5\u8981\u60F3\u51CF\u5C11\u8FD9\u65B9\u9762\u5B89\u5168\u98CE\u9669\uFF0C\u5C31\u662F\u505A\u597D\u5B89\u5168\u9694\u79BB\uFF0C\u963B\u65AD\u5BB9\u5668\u5185\u7A0B\u5E8F\u5BF9\u7269\u7406\u673A\u5185\u6838\u7684\u4F9D\u8D56\u3002 Google\u5F00\u6E90\u7684\u4E00\u79CDgVisor\u5BB9\u5668\u6C99\u7BB1\u6280\u672F\u5C31\u662F\u91C7\u7528\u8FD9\u79CD\u601D\u8DEF\uFF0CgVisor\u9694\u79BB\u5BB9\u5668\u5185\u5E94\u7528\u548C\u5185\u6838\u4E4B\u95F4\u8BBF \u95EE\uFF0C\u63D0\u4F9B\u4E86\u5927\u90E8\u5206Linux\u5185\u6838\u7684\u7CFB\u7EDF\u8C03\u7528\uFF0C\u5DE7\u5999\u7684\u5C06\u5BB9\u5668\u5185\u8FDB\u7A0B\u7684\u7CFB\u7EDF\u8C03\u7528\u8F6C\u5316\u4E3A\u5BF9gVisor\u7684\u8BBF\u95EE\u3002</p><p>gVisor\u517C\u5BB9OCI\uFF0C\u4E0EDocker\u548CK8s\u65E0\u7F1D\u96C6\u6210\uFF0C\u5F88\u65B9\u9762\u4F7F\u7528\u3002</p>`,56),m={href:"https://github.com/google/gvisor",target:"_blank",rel:"noopener noreferrer"},v=t(`<h4 id="gvisor\u5185\u6838\u4EA4\u4E92" tabindex="-1"><a class="header-anchor" href="#gvisor\u5185\u6838\u4EA4\u4E92" aria-hidden="true">#</a> gVisor\u5185\u6838\u4EA4\u4E92</h4><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204131554215.png" alt="image-20220413152923179" loading="lazy"></p><h4 id="gvisor\u67B6\u6784" tabindex="-1"><a class="header-anchor" href="#gvisor\u67B6\u6784" aria-hidden="true">#</a> gVisor\u67B6\u6784</h4><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204131554075.png" alt="image-20220413153011389" loading="lazy"></p><h4 id="gvisor\u4E0Edocker\u96C6\u6210" tabindex="-1"><a class="header-anchor" href="#gvisor\u4E0Edocker\u96C6\u6210" aria-hidden="true">#</a> gVisor\u4E0EDocker\u96C6\u6210</h4><p>gVisor\u5185\u6838\u8981\u6C42\uFF1A</p><p>Linux 3.17+ \u5982\u679C\u7528\u7684\u662FCentOS7\u5219\u9700\u8981\u5347\u7EA7\u5185\u6838\uFF0CUbuntu\u4E0D\u9700\u8981\u3002</p><p>CentOS7\u5185\u6838\u5347\u7EA7\u6B65\u9AA4\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># yum --enablerepo=elrepo-kernel install kernel-ml-devel kernel-ml \u2013y</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># grub2-set-default 0</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># reboot</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># uname -r</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># 5.17.2-1.el7.elrepo.x86_64</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>gVisor\u96C6\u6210Docker\u914D\u7F6E</p>`,10),b={href:"https://gvisor.dev/docs/user_guide/install/",target:"_blank",rel:"noopener noreferrer"},g={href:"https://gvisor.dev/docs/user_guide/compatibility/",target:"_blank",rel:"noopener noreferrer"},h=t(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>\u3001\u51C6\u5907gVisor\u4E8C\u8FDB\u5236\u6587\u4EF6
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># sha512sum -c runsc.sha512</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># rm -f *.sha512</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># chmod a+x runsc </span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># chmod a+x containerd-shim-runsc-v1</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># mv runsc containerd-shim-runsc-v1 /usr/local/bin</span>

<span class="token number">2</span>\u3001Docker\u914D\u7F6E\u4F7F\u7528gVisor
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># runsc install # \u67E5\u770B\u52A0\u7684\u914D\u7F6E/etc/docker/daemon.json</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart docker</span>


\u4F7F\u7528runsc\u8FD0\u884C\u5BB9\u5668\uFF1A
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># docker run -d --runtime=runsc nginx</span>
\u4F7F\u7528dmesg\u9A8C\u8BC1\uFF1A
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># docker run --runtime=runsc -it nginx dmesg</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="gvisor\u4E0Econtainerd\u96C6\u6210" tabindex="-1"><a class="header-anchor" href="#gvisor\u4E0Econtainerd\u96C6\u6210" aria-hidden="true">#</a> gVisor\u4E0EContainerd\u96C6\u6210</h4><p>\u5982\u679C\u8FD9\u91CC\u662FDocker\u7684\u73AF\u5883\uFF0C\u9700\u8981\u5207\u6362\u5230Containerd\u5BB9\u5668\u5F15\u64CE\u3002</p><p>\u4ECD\u7136\u9700\u8981\u5C06runsc \u3001containerd-shim-runsc-v1\u5DE5\u5177\u79FB\u5230/usr/local/bin\u4E0B\u9762</p><p><strong>1.\u51C6\u5907\u914D\u7F6E</strong></p><p>\u5F00\u542Fipv4\u8DEF\u7531\u8F6C\u53D1\u914D\u7F6E\uFF0C\u91CD\u65B0\u751F\u6548\u7CFB\u7EDF\u914D\u7F6E</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat &gt; /etc/sysctl.d/99-kubernetes-cri.conf &lt;&lt; EOF</span>
net.bridge.bridge-nf-call-iptables <span class="token operator">=</span> <span class="token number">1</span>
net.ipv4.ip_forward <span class="token operator">=</span> <span class="token number">1</span>
net.bridge.bridge-nf-call-ip6tables <span class="token operator">=</span> <span class="token number">1</span>
EOF

<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># sysctl -system</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2\u3001\u5B89\u88C5Containerd</strong></p><p>\u5982\u679C\u9ED8\u8BA4\u5B89\u88C5\u4E86docker-ce\u4F1A\u81EA\u52A8\u5B89\u88C5containerd\u7684\u4F9D\u8D56\uFF0C\u6CA1\u6709\u5219\u9700\u8981\u5B89\u88C5containerd\u3002</p><p>ubuntu\u6DFB\u52A0docker-ce\u7684repo\u6E90\u4E4B\u540Eapt-get install\u7684\u65B9\u5F0F\u5B89\u88C5</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cd /etc/yum.repos.d</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># wget http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># yum install -y containerd.io</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3\u3001\u4FEE\u6539\u914D\u7F6E\u6587\u4EF6</strong></p><ol><li>pause\u955C\u50CF\u5730\u5740</li><li>Cgroup\u9A71\u52A8\u6539\u4E3Asystemd</li><li>\u589E\u52A0runsc\u5BB9\u5668\u8FD0\u884C\u65F6</li><li>\u914D\u7F6Edocker\u955C\u50CF\u52A0\u901F\u5668</li></ol><p>\u4FEE\u6539\u914D\u7F6E\u6587\u4EF6\u9ED8\u8BA4\u7684containerd\u7684\u914D\u7F6E\u6587\u4EF6\u662F\u7A7A\u7684\uFF0C\u6240\u4EE5\u9700\u8981\u91CD\u65B0\u751F\u6210\u4E00\u4E2A\u5B8C\u6574\u7684\u914D\u7F6E\u6587\u4EF6\u3002</p><p>containerd\u7684\u76EE\u5F55\u662F\u5728 <code>/etc/containerd</code></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cd /etc/containerd/</span>
<span class="token punctuation">[</span>root@master01 containerd<span class="token punctuation">]</span><span class="token comment"># containerd config  default &gt; config.toml</span>
<span class="token punctuation">[</span>root@master01 containerd<span class="token punctuation">]</span><span class="token comment"># vim config.toml</span>
 <span class="token number">43</span>   <span class="token punctuation">[</span>plugins.<span class="token string">&quot;io.containerd.grpc.v1.cri&quot;</span><span class="token punctuation">]</span>
 		\xB7\xB7\xB7\xB7
 		<span class="token comment"># \u4FEE\u6539\u955C\u50CF\u4E3A\u56FD\u5185\u7684\u955C\u50CF</span>
 <span class="token number">56</span>     sandbox_image <span class="token operator">=</span> <span class="token string">&quot;registry.aliyuncs.com/google_containers/pause:3.2&quot;</span>   
 		\xB7\xB7\xB7\xB7 
 			<span class="token comment"># \u6DFB\u52A0\u4E00\u4E2Arunsc,\u6307\u5B9A\u7C7B\u578B\u4E3Arunsc\uFF0C\u8FD9\u91CC\u662F\u8DDFrunc\u540C\u7EA7</span>
 <span class="token number">90</span>        <span class="token punctuation">[</span>plugins.<span class="token string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.runtimes.runsc<span class="token punctuation">]</span>  
 <span class="token number">91</span>           runtime_type <span class="token operator">=</span> <span class="token string">&quot;io.containerd.runsc.v1&quot;</span>   				  

			<span class="token comment"># \u4FEE\u6539systemd\u9A71\u52A8\u4E3Atrue</span>
 <span class="token number">94</span>        <span class="token punctuation">[</span>plugins.<span class="token string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.runtimes.runc<span class="token punctuation">]</span>
 <span class="token number">103</span>          <span class="token punctuation">[</span>plugins.<span class="token string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.runtimes.runc.options<span class="token punctuation">]</span>
				\xB7\xB7\xB7
 <span class="token number">114</span>            SystemdCgroup <span class="token operator">=</span> <span class="token boolean">true</span>	
 		
 			<span class="token comment"># \u6DFB\u52A0docker\u4ED3\u5E93\u7684\u955C\u50CF\u6E90\uFF0C\u914D\u7F6E\u963F\u91CC\u955C\u50CF\u52A0\u901F</span>
 <span class="token number">139</span>       <span class="token punctuation">[</span>plugins.<span class="token string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors<span class="token punctuation">]</span>
 <span class="token number">140</span>        <span class="token punctuation">[</span>plugins.<span class="token string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors.<span class="token string">&quot;docker.io&quot;</span><span class="token punctuation">]</span>  
 <span class="token number">141</span>          endpoint <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;https://b9pmyelo.mirror.aliyuncs.com&quot;</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u914D\u7F6Ekubelet\u4F7F\u7528containerd</strong></p><p>\u914D\u7F6E\u5B8C\u4E4B\u540E\u5148\u91CD\u542Fcontainerd\uFF0C\u518D\u91CD\u542Fkubelet\uFF0C\u6700\u540E\u5982\u679Cpod\u51FA\u73B0\u62A5\u9519\uFF0C\u91CD\u542Fdocker\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># vi /etc/sysconfig/kubelet </span>
<span class="token assign-left variable">KUBELET_EXTRA_ARGS</span><span class="token operator">=</span>--container-runtime<span class="token operator">=</span>remote --container-runtime-endpoint<span class="token operator">=</span>unix:///run/containerd/containerd.sock --cgroup-driver<span class="token operator">=</span>systemd

<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart containerd</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart kubelet</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart docker</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u9A8C\u8BC1\u5F53\u524D\u7684Kubernetes\u5BB9\u5668\u57FA\u5C42</strong></p><ol><li><code>\u4EE5\u4E0A\u7684\u6B65\u9AA4\u9700\u8981\u5728\u6240\u6709\u96C6\u7FA4\u914D\u7F6E</code></li><li><code>\u5305\u62ECcrictl\u8FDE\u63A5containerd\u7684\u914D\u7F6E\u4E5F\u8981\u5728\u6240\u6709\u96C6\u7FA4\u8FD0\u884C</code></li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get  node -o wide | awk  &#39;{print $1,$2,$5,$NF}&#39; | column -t</span>
NAME      STATUS  VERSION  CONTAINER-RUNTIME
master01  Ready   v1.22.1  containerd://1.5.11
master02  Ready   v1.22.1  containerd://1.5.11
master03  Ready   v1.22.1  containerd://1.5.11
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>crictl\u8FDE\u63A5containerd</strong></p><p>containerd\u4E5F\u6709 ctr \u7BA1\u7406\u5DE5\u5177\uFF0C\u4F46\u529F\u80FD\u6BD4\u8F83\u7B80\u5355\uFF0C\u4E00\u822C\u4F7F\u7528crictl\u5DE5\u5177\u68C0\u67E5\u548C\u8C03\u8BD5\u5BB9\u5668\u3002</p>`,24),y={href:"https://github.com/kubernetes-sigs/cri-tools/",target:"_blank",rel:"noopener noreferrer"},x=t(`<p>\u51C6\u5907crictl\u8FDE\u63A5containerd\u914D\u7F6E\u6587\u4EF6\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat &gt; /etc/crictl.yaml &lt;&lt; EOF</span>
runtime-endpoint: unix:///run/containerd/containerd.sock
EOF
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart  containerd </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0B\u9762\u662Fdocker\u4E0Ecrictl\u547D\u4EE4\u5BF9\u7167\u8868\uFF1A</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204141224352.png" alt="image-20220414115021436" loading="lazy"></p><h3 id="\u6848\u4F8B\u5B9E\u65BD-4" tabindex="-1"><a class="header-anchor" href="#\u6848\u4F8B\u5B9E\u65BD-4" aria-hidden="true">#</a> \u6848\u4F8B\u5B9E\u65BD</h3><h5 id="\u793A\u4F8B-k8s\u4F7F\u7528gvisor\u8FD0\u884C\u5BB9\u5668" tabindex="-1"><a class="header-anchor" href="#\u793A\u4F8B-k8s\u4F7F\u7528gvisor\u8FD0\u884C\u5BB9\u5668" aria-hidden="true">#</a> \u793A\u4F8B\uFF1A K8s\u4F7F\u7528gVisor\u8FD0\u884C\u5BB9\u5668</h5><ul><li>\u521B\u5EFARuntimeClass</li><li>\u7ED1\u5B9ARuntimeClass</li></ul><p>RuntimeClass \u662F\u4E00\u4E2A\u7528\u4E8E\u9009\u62E9\u5BB9\u5668\u8FD0\u884C\u65F6\u914D\u7F6E\u7684\u7279\u6027\uFF0C\u5BB9\u5668\u8FD0\u884C\u65F6\u914D\u7F6E\u7528 \u4E8E\u8FD0\u884C Pod \u4E2D\u7684\u5BB9\u5668\u3002</p><p>\u521B\u5EFARuntimeClass\uFF1A</p><ul><li>\u8FD9\u91CC\u521B\u5EFA\u4E00\u4E2A\u540D\u79F0\u4E3A<code>gvisor</code>\u7684runtimeclass\u8D44\u6E90</li><li>\u53EF\u4EE5\u521B\u5EFA\u591A\u4E2A<code>runtimeclass</code>\u8D44\u6E90\uFF0C\u8D77\u5230\u9694\u79BB\u7684\u6548\u679C</li><li>handler\u4E00\u5B9A\u662F<code>runsc</code>\uFF0C\u5BF9\u5E94CSI\u7684\u914D\u7F6E\u540D\u79F0</li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat runtime.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> node.k8s.io/v1 <span class="token comment"># RuntimeClass \u5B9A\u4E49\u4E8E node.k8s.io API \u7EC4</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RuntimeClass
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> gvisor <span class="token comment"># \u7528\u6765\u5F15\u7528 RuntimeClass \u7684\u540D\u5B57</span>
<span class="token key atrule">handler</span><span class="token punctuation">:</span> runsc <span class="token comment"># \u5BF9\u5E94\u7684 CRI \u914D\u7F6E\u7684\u540D\u79F0</span>

<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get runtimeclasses</span>
NAME     HANDLER   AGE
gvisor   runsc     72m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u521B\u5EFAPod\u6D4B\u8BD5gVisor\uFF1A</p><p>\u8FD9\u91CC\u4F7F\u7528<code>runtimeClassName</code>\u7ED1\u5B9A</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat pod.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> pod
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> <span class="token string">&quot;master01&quot;</span>
  <span class="token key atrule">runtimeClassName</span><span class="token punctuation">:</span> gvisor
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">name</span><span class="token punctuation">:</span> pod
    
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods</span>
NAME   READY   STATUS    RESTARTS   AGE
pod    1/1     Running   0          72m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,14);function f(P,q){const a=c("ExternalLinkIcon");return p(),l("div",null,[u,n("p",null,[s("\u{1F3F7}\uFE0F"),n("a",r,[s("\u5F03\u7528\u6587\u7AE0"),e(a)])]),n("p",null,[s("\u{1F3F7}\uFE0F"),n("a",d,[s("\u66FF\u4EE3\u63D0\u6848"),e(a)])]),k,n("p",null,[s("\u9879\u76EE\u5730\u5740\uFF1A"),n("a",m,[s("https://github.com/google/gvisor"),e(a)])]),v,n("p",null,[s("\u53C2\u8003\u6587\u6863\uFF1A"),n("a",b,[s("https://gvisor.dev/docs/user_guide/install/"),e(a)])]),n("p",null,[s("\u5DF2\u7ECF\u6D4B\u8BD5\u8FC7\u7684\u5E94\u7528\u548C\u5DE5\u5177\uFF1A"),n("a",g,[s("https://gvisor.dev/docs/user_guide/compatibility/"),e(a)])]),h,n("p",null,[s("\u9879\u76EE\u5730\u5740\uFF1A"),n("a",y,[s("https://github.com/kubernetes-sigs/cri-tools/"),e(a)])]),x])}const _=i(o,[["render",f],["__file","04.\u6700\u5C0F\u5316\u5FAE\u670D\u52A1\u6F0F\u6D1E.html.vue"]]);export{_ as default};
