import{_ as i}from"./_plugin-vue_export-helper.cdc0426e.js";import{o as p,c as o,a as n,b as s,d as e,f as t,r as l}from"./app.ca0279c0.js";const c={},r=t('<h1 id="gitlab-gitlab-ci-harbor-kubernetes" tabindex="-1"><a class="header-anchor" href="#gitlab-gitlab-ci-harbor-kubernetes" aria-hidden="true">#</a> GitLab + GitLab CI + Harbor + Kubernetes</h1><h2 id="\u9879\u76EE\u8981\u6C42" tabindex="-1"><a class="header-anchor" href="#\u9879\u76EE\u8981\u6C42" aria-hidden="true">#</a> \u9879\u76EE\u8981\u6C42</h2><p>\u8BE5\u516C\u53F8\u51B3\u5B9A\u91C7\u7528<code>GitLab + GitLab CI + Harbor + Kubernetes</code>\u67B6\u6784\u6765\u6784\u5EFACICD\u73AF\u5883\uFF0C\u4EE5\u7F29\u77ED\u65B0\u529F\u80FD\u5F00\u53D1\u4E0A\u7EBF\u5468\u671F\uFF0C\u53CA\u65F6\u6EE1\u8DB3\u5BA2\u6237\u7684\u9700\u6C42\uFF0C\u5B9E\u73B0DevOps\u7684\u90E8\u5206\u6D41\u7A0B\uFF0C\u6765\u51CF\u8F7B\u90E8\u7F72\u8FD0\u7EF4\u7684\u8D1F\u62C5\uFF0C\u5B9E\u73B0\u53EF\u89C6\u5316\u5BB9\u5668\u751F\u547D\u5468\u671F\u7BA1\u7406\u3001\u5E94\u7528\u53D1\u5E03\u548C\u7248\u672C\u8FED\u4EE3\u66F4\u65B0\uFF0C\u8BF7\u5B8C\u6210CICD\u73AF\u5883\u90E8\u7F72\u3002CICD\u5E94\u7528\u7CFB\u7EDF\u67B6\u6784\u5982\u4E0B\uFF1A</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204250851345.png" alt="image-20220425085103011" loading="lazy"></p><h2 id="\u73AF\u5883\u51C6\u5907" tabindex="-1"><a class="header-anchor" href="#\u73AF\u5883\u51C6\u5907" aria-hidden="true">#</a> \u73AF\u5883\u51C6\u5907</h2><p>\u8FD9\u91CC\u4F7F\u7528\u9879\u76EE\u4E3A2048\u6E38\u620F</p>',6),u=n("strong",null,"\u9879\u76EE\u5730\u5740\uFF1A",-1),d={href:"https://gitee.com/isicman/demo-2048.git",target:"_blank",rel:"noopener noreferrer"},m=t(`<h3 id="_1-\u8282\u70B9\u89C4\u5212" tabindex="-1"><a class="header-anchor" href="#_1-\u8282\u70B9\u89C4\u5212" aria-hidden="true">#</a> 1.\u8282\u70B9\u89C4\u5212</h3><p>\u4F7F\u7528Docker\u6216\u8005\u4F7F\u7528Kubernetes\u96C6\u7FA4\u73AF\u5883\uFF0C\u8FD9\u91CC\u4F7F\u7528\u7684\u662FKubernetes\u96C6\u7FA4\u73AF\u5883\u3002</p><table><thead><tr><th>IP\u5730\u5740</th><th>\u4E3B\u673A\u540D\u79F0</th><th>\u4E3B\u673A\u8D44\u6E90</th><th>\u8282\u70B9\u540D\u79F0</th></tr></thead><tbody><tr><td>10.11.121.111</td><td>k8s-master</td><td>12G/6VCPU</td><td>GitLab+GitLab-Runner</td></tr><tr><td>10.11.121.112</td><td>k8s-node1</td><td>8G/6VCPU</td><td>Harbor</td></tr><tr><td>10.11.121.113</td><td>k8s-node2</td><td>8G/6VCPU</td><td>node</td></tr></tbody></table><h3 id="_2-\u67E5\u770B\u96C6\u7FA4\u72B6\u6001" tabindex="-1"><a class="header-anchor" href="#_2-\u67E5\u770B\u96C6\u7FA4\u72B6\u6001" aria-hidden="true">#</a> 2.\u67E5\u770B\u96C6\u7FA4\u72B6\u6001</h3><p>\u53EF\u4EE5\u901A\u8FC7<code>kubectl cluster-info</code>\u547D\u4EE4\u67E5\u770B\u5F53\u524D\u7684\u96C6\u7FA4\u4FE1\u606F\u3002 \u901A\u8FC7 <code>kubectl get node</code>\u67E5\u770B\u5F53\u524D\u8282\u70B9\u6570\u91CF\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl cluster-info </span>
Kubernetes control plane is running at https://10.11.121.111:6443
KubeDNS is running at https://10.11.121.111:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use <span class="token string">&#39;kubectl cluster-info dump&#39;</span><span class="token builtin class-name">.</span>

<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get node </span>
NAME         STATUS   ROLES                  AGE   VERSION
k8s-master   Ready    control-plane,master   25h   v1.20.0
k8s-node1    Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>                 25h   v1.20.0
k8s-node2    Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>                 25h   v1.20.0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u90E8\u7F72gitlab" tabindex="-1"><a class="header-anchor" href="#\u90E8\u7F72gitlab" aria-hidden="true">#</a> \u90E8\u7F72GitLab</h2><h3 id="_1-gitlab\u6982\u8FF0" tabindex="-1"><a class="header-anchor" href="#_1-gitlab\u6982\u8FF0" aria-hidden="true">#</a> 1.GitLab\u6982\u8FF0</h3><p>GitLab \u662F\u5229\u7528 Ruby on Rails \u4E00\u4E2A\u5F00\u6E90\u7684\u7248\u672C\u7BA1\u7406\u7CFB\u7EDF\uFF0C\u5B9E\u73B0\u4E00\u4E2A\u81EA\u6258\u7BA1\u7684 Git \u9879\u76EE\u4ED3\u5E93\uFF0C\u53EF\u901A\u8FC7 Web \u754C\u9762\u8FDB\u884C\u8BBF\u95EE\u516C\u5F00\u7684\u6216\u8005\u79C1\u4EBA\u9879\u76EE\u3002\u5B83\u62E5\u6709\u4E0E Github \u7C7B\u4F3C\u7684\u529F\u80FD\uFF0C\u80FD\u591F\u6D4F\u89C8\u6E90\u4EE3\u7801\uFF0C\u7BA1\u7406\u7F3A\u9677\u548C\u6CE8\u91CA\u3002\u53EF\u4EE5\u7BA1\u7406\u56E2\u961F\u5BF9\u4ED3\u5E93\u7684\u8BBF\u95EE\uFF0C\u5B83\u975E\u5E38\u6613\u4E8E\u6D4F\u89C8\u63D0\u4EA4\u8FC7\u7684\u7248\u672C\u5E76\u63D0\u4F9B\u4E00\u4E2A\u6587\u4EF6\u5386\u53F2\u5E93\u3002\u56E2\u961F\u6210\u5458\u53EF\u4EE5\u5229\u7528\u5185\u7F6E\u7684\u7B80\u5355\u804A\u5929\u7A0B\u5E8F (Wall) \u8FDB\u884C\u4EA4\u6D41\u3002\u5B83\u8FD8\u63D0\u4F9B\u4E00\u4E2A\u4EE3\u7801\u7247\u6BB5\u6536\u96C6\u529F\u80FD\u53EF\u4EE5\u8F7B\u677E\u5B9E\u73B0\u4EE3\u7801\u590D\u7528\uFF0C\u4FBF\u4E8E\u65E5\u540E\u6709\u9700\u8981\u7684\u65F6\u5019\u8FDB\u884C\u67E5\u627E\u3002</p><h3 id="_2-gitlab\u90E8\u7F72\u65B9\u5F0F" tabindex="-1"><a class="header-anchor" href="#_2-gitlab\u90E8\u7F72\u65B9\u5F0F" aria-hidden="true">#</a> 2.GitLab\u90E8\u7F72\u65B9\u5F0F</h3><p>GitLab \u53EF\u4EE5\u5B89\u88C5\u5728\u5927\u591A\u6570 GNU/Linux \u53D1\u884C\u7248\u4E2D\uFF0C\u5E76\u4E0E\u591A\u4E2A\u4E91\u63D0\u4F9B\u5546\u4E00\u8D77\u5B89\u88C5\u3002\u8981\u4ECE GitLab \u83B7\u5F97\u6700\u4F73\u4F53\u9A8C\uFF0C\u60A8\u5FC5\u987B\u5E73\u8861\u6027\u80FD\u3001\u53EF\u9760\u6027\u3001\u6613\u4E8E\u7BA1\u7406\uFF08\u5907\u4EFD\u3001\u5347\u7EA7\u548C\u6545\u969C\u6392\u9664\uFF09\u4EE5\u53CA\u6258\u7BA1\u6210\u672C\u3002</p><p>\u76EE\u524D\u6BD4\u8F83\u5E38\u89C1\u7684\u90E8\u7F72\u65B9\u5F0F\u6709\u5982\u4E0B\u4E09\u79CD\uFF1A</p><ul><li>\u76F4\u63A5\u5B89\u88C5\u5728\u64CD\u4F5C\u7CFB\u7EDF\u4E0A\uFF0C\u4F8B\u5982\uFF1A <code>Mac/Windows/Linux</code></li><li>\u901A\u8FC7\u5BB9\u5668\u7684\u65B9\u5F0F\u5B89\u88C5\uFF0C\u4F8B\u5982\uFF1A <code>Docker\u3001Kubernetes</code></li><li>\u4F7F\u7528Helm\u5305\u5B89\u88C5\uFF1A <code>Chart\u5305\u7684\u65B9\u5F0F</code></li></ul><h3 id="_3-docker\u90E8\u7F72gitlab" tabindex="-1"><a class="header-anchor" href="#_3-docker\u90E8\u7F72gitlab" aria-hidden="true">#</a> 3.Docker\u90E8\u7F72GitLab</h3><p>1.\u4F7F\u7528Docker\u547D\u4EE4\u90E8\u7F72Gitlab\uFF0C\u7531\u4E8EGitlab\u7684\u955C\u50CF\u5927\u6982\u6709\u51E0\u4E2AG\uFF0C\u6240\u4EE5\u9700\u8981\u7B49\u5F85\u5F88\u4E45\u7684\u65F6\u95F4\uFF0C\u76F4\u5230\u5B8C\u5168\u542F\u52A8\u3002</p><p>\u53C2\u6570\u89E3\u6790\uFF1A</p><p><code>hostname</code> \u57DF\u540D \u6216 ip</p><p><code>publish \u3001-p</code> \u7AEF\u53E3\u6620\u5C04</p><p><code>restart</code> \u91CD\u542F\u65B9\u5F0F</p><p><code>volume\u3001-v</code> \u76EE\u5F55\u6302\u8F7D</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># docker run -d \\</span>
  <span class="token parameter variable">--hostname</span> <span class="token number">10.11</span>.121.111 <span class="token punctuation">\\</span>
  <span class="token parameter variable">-p</span> <span class="token number">443</span>:443 <span class="token parameter variable">-p</span> <span class="token number">80</span>:80 <span class="token parameter variable">-p</span> <span class="token number">222</span>:22 <span class="token punctuation">\\</span>
  <span class="token parameter variable">--name</span> gitlab <span class="token punctuation">\\</span>
  <span class="token parameter variable">--restart</span> always <span class="token punctuation">\\</span>
  <span class="token parameter variable">-v</span> /srv/gitlab/config:/etc/gitlab <span class="token punctuation">\\</span>
  <span class="token parameter variable">-v</span> /srv/gitlab/logs:/var/log/gitlab <span class="token punctuation">\\</span>
  <span class="token parameter variable">-v</span> /srv/gitlab/data:/var/opt/gitlab <span class="token punctuation">\\</span>
  gitlab/gitlab-ce:latest
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2.\u67E5\u770B\u5F53\u524D\u7684Docker\u8FDB\u7A0B\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># docker ps | grep  gitlab </span>
686f123b649c   gitlab/gitlab-ce:latest                             <span class="token string">&quot;/assets/wrapper&quot;</span>        <span class="token number">25</span> hours ago   Up <span class="token number">2</span> hours <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>   <span class="token number">0.0</span>.0.0:80-<span class="token operator">&gt;</span><span class="token number">80</span>/tcp, :::80-<span class="token operator">&gt;</span><span class="token number">80</span>/tcp, <span class="token number">0.0</span>.0.0:443-<span class="token operator">&gt;</span><span class="token number">443</span>/tcp, :::443-<span class="token operator">&gt;</span><span class="token number">443</span>/tcp, <span class="token number">0.0</span>.0.0:222-<span class="token operator">&gt;</span><span class="token number">22</span>/tcp, :::222-<span class="token operator">&gt;</span><span class="token number">22</span>/tcp   gitlab
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div>`,23),k={href:"http://10.11.121.111",target:"_blank",rel:"noopener noreferrer"},b=t(`<p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204242235534.png" alt="image-20220424223532525" loading="lazy"></p><p>4.\u8FD9\u91CC\u9ED8\u8BA4\u7684\u7528\u6237\u662F <code>root</code> \uFF0C\u9ED8\u8BA4\u7684\u5BC6\u7801\u53EA\u670924h\u6709\u6548\uFF0C\u6240\u4EE5\u6211\u4EEC\u9700\u8981\u66F4\u6539\u4E00\u4E0B\u5BC6\u7801\u3002</p><p>\u5148\u67E5\u51FA\u7528\u6237\u7684id\uFF0C\u4F8B\u5982\u4E0B\u9762\u7528\u6237\u662Froot id=1</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># docker exec -it gitlab /bin/bash</span>
<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:1,<span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Administrator&quot;</span>,<span class="token string">&quot;username&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;root&quot;</span>,<span class="token string">&quot;state&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;active&quot;</span>,<span class="token string">&quot;avatar_url&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;https://www.gravatar.com/avatar/e64c7d89f26bd1972efa854d13d7dd61?s=80<span class="token entity" title="\\u0026">\\u0026</span>d=identicon&quot;</span>,<span class="token string">&quot;web_url&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;http://192.168.0.173/root&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span>

root@10:/<span class="token comment"># gitlab-rails console -e production</span>
--------------------------------------------------------------------------------
 Ruby:         ruby <span class="token number">2.7</span>.4p191 <span class="token punctuation">(</span><span class="token number">2021</span>-07-07 revision a21a3b7d23<span class="token punctuation">)</span> <span class="token punctuation">[</span>x86_64-linux<span class="token punctuation">]</span>
 GitLab:       <span class="token number">14.4</span>.1 <span class="token punctuation">(</span>1a23d731c9f<span class="token punctuation">)</span> FOSS
 GitLab Shell: <span class="token number">13.21</span>.1
 PostgreSQL:   <span class="token number">12.7</span>
--------------------------------------------------------------------------------
Loading production environment <span class="token punctuation">(</span>Rails <span class="token number">6.1</span>.4.1<span class="token punctuation">)</span>
irb<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:001:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> <span class="token assign-left variable">u</span><span class="token operator">=</span>User.where<span class="token punctuation">(</span>id:1<span class="token punctuation">)</span>.first
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token comment">#&lt;User id:1 @root&gt;</span>
irb<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:002:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> <span class="token assign-left variable">u.password</span><span class="token operator">=</span><span class="token string">&#39;00000000&#39;</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;00000000&quot;</span>
irb<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:003:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> <span class="token assign-left variable">u.password_confirmation</span><span class="token operator">=</span><span class="token string">&#39;00000000&#39;</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;00000000&quot;</span>
irb<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:004:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> u.save<span class="token operator">!</span>
Enqueued ActionMailer::MailDeliveryJob <span class="token punctuation">(</span>Job ID: d7bc1e90-4941-4125-bf90-b018c92b5d73<span class="token punctuation">)</span> to Sidekiq<span class="token punctuation">(</span>mailers<span class="token punctuation">)</span> with arguments: <span class="token string">&quot;DeviseMailer&quot;</span>, <span class="token string">&quot;password_change&quot;</span>, <span class="token string">&quot;deliver_now&quot;</span>, <span class="token punctuation">{</span>:args<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token comment">#&lt;GlobalID:0x00007f0b99fbc3a8 @uri=#&lt;URI::GID gid://gitlab/User/1&gt;&gt;]}</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>
irb<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:005:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> <span class="token builtin class-name">exit</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-\u521B\u5EFA\u9879\u76EE" tabindex="-1"><a class="header-anchor" href="#_4-\u521B\u5EFA\u9879\u76EE" aria-hidden="true">#</a> 4.\u521B\u5EFA\u9879\u76EE</h3><p>2.\u767B\u5F55Gitlab\u4E4B\u540E\uFF0C\u9700\u8981\u521B\u5EFA\u4E00\u4E2A\u9879\u76EE\u540D\u79F0\u53EB\u505A<code>demo</code>\u3002</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204242237733.png" alt="image-20220424223745243" loading="lazy"></p><p>2.\u9009\u62E9<code>public</code>\uFF0C\u4E5F\u662F\u4E0A\u5E02\u7684\u610F\u601D\uFF0C\u4E0D\u9700\u8981\u521D\u59CB\u5316\u5B58\u50A8\u5E93\u3002</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204242240317.png" alt="image-20220424224043845" loading="lazy"></p><p>3.\u9996\u5148\u6211\u4EEC\u62C9\u53D6gitee\u4E0A\u7684\u6E90\u7801\u5230\u672C\u5730\uFF0C\u518D\u63A8\u9001\u5230Gitlab\u6E90\u7801\u6258\u7BA1demo\u4ED3\u5E93\u7684Master\u5206\u652F\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># git clone https://gitee.com/isicman/demo-2048.git </span>
Cloning into <span class="token string">&#39;demo-2048&#39;</span><span class="token punctuation">..</span>.
Username <span class="token keyword">for</span> <span class="token string">&#39;https://gitee.com&#39;</span><span class="token builtin class-name">:</span> isicman
Password <span class="token keyword">for</span> <span class="token string">&#39;https://isicman@gitee.com&#39;</span><span class="token builtin class-name">:</span> 
remote: Enumerating objects: <span class="token number">71</span>, done.
remote: Counting objects: <span class="token number">100</span>% <span class="token punctuation">(</span><span class="token number">71</span>/71<span class="token punctuation">)</span>, done.
remote: Compressing objects: <span class="token number">100</span>% <span class="token punctuation">(</span><span class="token number">59</span>/59<span class="token punctuation">)</span>, done.
remote: Total <span class="token number">71</span> <span class="token punctuation">(</span>delta <span class="token number">21</span><span class="token punctuation">)</span>, reused <span class="token number">0</span> <span class="token punctuation">(</span>delta <span class="token number">0</span><span class="token punctuation">)</span>, pack-reused <span class="token number">0</span>
Unpacking objects: <span class="token number">100</span>% <span class="token punctuation">(</span><span class="token number">71</span>/71<span class="token punctuation">)</span>, done.
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># cd demo-2048/</span>
<span class="token punctuation">[</span>root@k8s-master demo<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">8</span>
drwxr-xr-x <span class="token number">2</span> root root   <span class="token number">24</span> Apr <span class="token number">23</span> <span class="token number">13</span>:28 Dockerfiles
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1491</span> Apr <span class="token number">23</span> <span class="token number">13</span>:28 pom.xml
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">315</span> Apr <span class="token number">23</span> <span class="token number">13</span>:28 README.md
drwxr-xr-x <span class="token number">3</span> root root   <span class="token number">18</span> Apr <span class="token number">23</span> <span class="token number">13</span>:28 src
drwxr-xr-x <span class="token number">2</span> root root   <span class="token number">28</span> Apr <span class="token number">24</span> <span class="token number">13</span>:06 template

<span class="token punctuation">[</span>root@k8s-master demo-2048<span class="token punctuation">]</span><span class="token comment"># git config --global user.name &quot;Administrator&quot;</span>
<span class="token punctuation">[</span>root@k8s-master demo-2048<span class="token punctuation">]</span><span class="token comment"># git config --global user.email &quot;admin@example.com&quot;</span>
<span class="token punctuation">[</span>root@k8s-master demo-2048<span class="token punctuation">]</span><span class="token comment"># git init</span>
Reinitialized existing Git repository <span class="token keyword">in</span> /opt/demo-2048/.git/
<span class="token punctuation">[</span>root@k8s-master demo-2048<span class="token punctuation">]</span><span class="token comment"># git remote rename origin old-origin</span>
<span class="token punctuation">[</span>root@k8s-master demo-2048<span class="token punctuation">]</span><span class="token comment"># git remote add origin http://10.11.121.111/root/demo.git</span>
<span class="token punctuation">[</span>root@k8s-master demo-2048<span class="token punctuation">]</span><span class="token comment"># git add .</span>
<span class="token punctuation">[</span>root@k8s-master demo-2048<span class="token punctuation">]</span><span class="token comment"># git commit -m &quot;Initial commit&quot;</span>
<span class="token comment"># On branch master</span>
nothing to commit, working directory clean
<span class="token punctuation">[</span>root@k8s-master demo-2048<span class="token punctuation">]</span><span class="token comment"># git push -u origin --all</span>
Username <span class="token keyword">for</span> <span class="token string">&#39;http://10.11.121.111&#39;</span><span class="token builtin class-name">:</span> root
Password <span class="token keyword">for</span> <span class="token string">&#39;http://root@10.11.121.111&#39;</span><span class="token builtin class-name">:</span> 
Counting objects: <span class="token number">71</span>, done.
Delta compression using up to <span class="token number">8</span> threads.
Compressing objects: <span class="token number">100</span>% <span class="token punctuation">(</span><span class="token number">59</span>/59<span class="token punctuation">)</span>, done.
Writing objects: <span class="token number">100</span>% <span class="token punctuation">(</span><span class="token number">71</span>/71<span class="token punctuation">)</span>, <span class="token number">82.04</span> KiB <span class="token operator">|</span> <span class="token number">0</span> bytes/s, done.
Total <span class="token number">71</span> <span class="token punctuation">(</span>delta <span class="token number">21</span><span class="token punctuation">)</span>, reused <span class="token number">0</span> <span class="token punctuation">(</span>delta <span class="token number">0</span><span class="token punctuation">)</span>
To http://10.11.121.111/root/demo2.git
 * <span class="token punctuation">[</span>new branch<span class="token punctuation">]</span>      master -<span class="token operator">&gt;</span> master
Branch master <span class="token builtin class-name">set</span> up to track remote branch master from origin.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4.\u518D\u6B21\u5237\u65B0\u4ED3\u5E93\u67E5\u770B\uFF0C\u6E90\u7801\u5DF2\u7ECF\u63A8\u9001\u6210\u529F\u3002</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204242249037.png" alt="image-20220424224925906" loading="lazy"></p><p>5.\u9700\u8981\u8BB0\u4F4F\u8FD9\u91CC\u7684Runner\u7684<code>URL\u548CToken</code>\uFF0C\u56E0\u4E3A\u540E\u9762\u7684GitLab\u2014Runner\u8FDE\u63A5GitLab\u9700\u8981\u4F7F\u7528\u5230\u3002</p><p>\u6B64\u5904\u6211\u7684URL: <code>http://10.11.121.111/</code></p><p>\u6B64\u5904\u6211\u7684Token\uFF1A<code>o4_NCTZvpnViRE7iGxoi</code></p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204250847343.png" alt="image-20220424225358742" loading="lazy"></p><h2 id="\u90E8\u7F72gitlab-runner" tabindex="-1"><a class="header-anchor" href="#\u90E8\u7F72gitlab-runner" aria-hidden="true">#</a> \u90E8\u7F72GitLab-Runner</h2><h3 id="_1-gitlab-ci\u4ECB\u7ECD" tabindex="-1"><a class="header-anchor" href="#_1-gitlab-ci\u4ECB\u7ECD" aria-hidden="true">#</a> 1.GitLab-CI\u4ECB\u7ECD</h3><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204250847312.webp" alt="img" loading="lazy"></p>`,20),v={href:"https://so.csdn.net/so/search?q=%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE&spm=1001.2101.3001.7020",target:"_blank",rel:"noopener noreferrer"},g=t(`<p>\u4E00\u822C\u6765\u8BF4\uFF0Cgitlab\u4E0A\u5DF2\u7531\u8D1F\u8D23\u4EBA\u914D\u7F6E\u597D\u4E86<code>gitlab-runner</code>\uFF0C\u6211\u4EEC\u53EA\u9700\u8981\u7F16\u5199\u597D<code>.gitlab.yml</code>\u6587\u4EF6\u63D0\u4EA4\u4EE3\u7801\u5373\u53EF\u89E6\u53D1runner\u8FDB\u884C\u5DE5\u4F5C\u3002\u4F46\u5BF9\u4E8E\u521D\u5B66\u8005\u6765\u8BF4\uFF0C\u4F60\u53EF\u80FD\u60F3\u80FD\u4E0D\u80FD\u5728\u63D0\u4EA4\u4EE3\u7801\u524D\u5728\u672C\u5730\u5148\u6267\u884C<code>.gitlab.yml</code>\u6587\u4EF6\u7684job\uFF0C\u672C\u5730\u8C03\u8BD5\u6210\u529F\u68C0\u67E5\u6CA1\u6709\u95EE\u9898\u540E\u518D\u8FDB\u884C\u6700\u7EC8\u4EE3\u7801\u7684\u63D0\u4EA4\uFF0C\u89E6\u53D1\u670D\u52A1\u7AEF\u7684CI\u6D41\u7A0B\u3002\u7B54\u6848\u5F53\u7136\u4E5F\u662F\u53EF\u4EE5\u7684\u3002<code>.gitlab.yml</code>\u6587\u4EF6\u4E2D\u5B9A\u4E49\u7684job\u5176\u5B9E\u662F\u67D0\u4E2A\u670D\u52A1\u5668\u4E2D\u7684<code>gitlab-runner</code>\u5728\u8FD0\u884C\uFF0C\u90A3\u6211\u4EEC\u4E5F\u53EF\u4EE5\u5728\u672C\u5730\u5B89\u88C5\u597D<code>gitlab-runner</code>\u624B\u52A8\u7684\u6765\u6267\u884C\u672C\u5730<code>.gitlab.yml</code>\u4E2D\u7684<code>job</code>\u3002</p><h3 id="_2-gitlab-runner\u90E8\u7F72\u65B9\u5F0F" tabindex="-1"><a class="header-anchor" href="#_2-gitlab-runner\u90E8\u7F72\u65B9\u5F0F" aria-hidden="true">#</a> 2.GitLab-Runner\u90E8\u7F72\u65B9\u5F0F</h3><p>\u4F60\u51E0\u4E4E\u53EF\u4EE5\u5728\u4EFB\u4F55\u673A\u5668\u4E0A\u5B89\u88C5<code>gitlab-runner</code>\uFF0C\u5B89\u88C5\u7684\u65B9\u5F0F\u8FD9\u91CC\u63A8\u8350\u5982\u4E0B\u51E0\u79CD\uFF1A</p><ul><li>Linux\u4F7F\u7528\u4E8C\u8FDB\u5236\u7684\u65B9\u5F0F</li><li>Docker\u4E2D\u4F7F\u7528\u5BB9\u5668\u7684\u65B9\u5F0F\u542F\u52A8Gitlab\u2014Runner</li><li>Helm\u5305\u7684\u65B9\u5F0F\u5B89\u88C5Gitlab-Runner</li></ul><p><code>\u5982\u4E0B\u6211\u5206\u522B\u4F7F\u7528\u4E86\u4E24\u79CD\u4E0D\u540C\u7684\u65B9\u5F0F\u90E8\u7F72Gitlab-Runner\uFF0C\u53EF\u4EE5\u9009\u62E9\u5176\u4E2D\u4E00\u79CD\u3002</code></p><h3 id="_3-docker\u90E8\u7F72runner" tabindex="-1"><a class="header-anchor" href="#_3-docker\u90E8\u7F72runner" aria-hidden="true">#</a> 3.Docker\u90E8\u7F72Runner</h3><p><strong>1.\u5B89\u88C5gitlab runner</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># docker run -d --name gitlab-runner --restart always \\</span>
  <span class="token parameter variable">-v</span> /srv/gitlab-runner/config:/etc/gitlab-runner <span class="token punctuation">\\</span>
  <span class="token parameter variable">-v</span> /var/run/docker.sock:/var/run/docker.sock <span class="token punctuation">\\</span>
  gitlab/gitlab-runner:latest
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2.\u6CE8\u518Cgitlab runner</strong></p><p>\u53C2\u6570\u89E3\u6790\uFF1A</p><ol><li>gitlab-runner register \u662F\u542F\u52A8register\u7684\u547D\u4EE4</li><li>GitLab\u7684Runner\u663E\u793A\u7684URL\u5730\u5740\uFF1A <code>--url</code></li><li>GitLab\u7684Runner\u663E\u793A\u7684Token\u503C\uFF1A <code>--registration-token</code></li><li>\u8BBE\u7F6ERunner\u7684\u6807\u7B7E\uFF1A <code>--tag-list</code></li><li>\u8BBE\u7F6ECICD\u6784\u5EFA\u65F6\u53EF\u4EE5\u4E0D\u542F\u7528Tag\uFF1A<code> --run-untagged</code></li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># docker run --rm -v /srv/gitlab-runner/config:/etc/gitlab-runner gitlab/gitlab-runner register \\</span>
  --non-interactive <span class="token punctuation">\\</span>
  <span class="token parameter variable">--executor</span> <span class="token string">&quot;docker&quot;</span> <span class="token punctuation">\\</span>
  --docker-image alpine:latest <span class="token punctuation">\\</span>
  <span class="token parameter variable">--url</span> <span class="token string">&quot;http://10.11.121.111/&quot;</span> <span class="token punctuation">\\</span>
  --registration-token <span class="token string">&quot;o4_NCTZvpnViRE7iGxoi&quot;</span> <span class="token punctuation">\\</span>
  <span class="token parameter variable">--description</span> <span class="token string">&quot;first-register-runner&quot;</span> <span class="token punctuation">\\</span>
  --tag-list <span class="token string">&quot;k8s&quot;</span> <span class="token punctuation">\\</span>
  --run-untagged<span class="token operator">=</span><span class="token string">&quot;true&quot;</span> <span class="token punctuation">\\</span>
  <span class="token parameter variable">--locked</span><span class="token operator">=</span><span class="token string">&quot;false&quot;</span> <span class="token punctuation">\\</span>
  --access-level<span class="token operator">=</span><span class="token string">&quot;not_protected&quot;</span> 
  
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># docker ps | grep gitlab-runner </span>
3e0a02917540   gitlab/gitlab-runner:latest                         <span class="token string">&quot;/usr/bin/dumb-init \u2026&quot;</span>   <span class="token number">26</span> hours ago   Up <span class="token number">3</span> hours                                                                                                                             gitlab-runner
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2.\u67E5\u770BGitlab\u8FDE\u63A5\u60C5\u51B5</strong></p><p>1.\u8FDB\u5165Gitlab\u7684CICD\u914D\u7F6E\u4E2D\uFF0C\u627E\u5230Runner\u914D\u7F6E\uFF0C\u5237\u65B0\u6B64\u9875\u9762\u3002</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204250848483.png" alt="image-20220424231601423" loading="lazy"></p><p>2.\u6216\u8005\u5728Menu\u7684\u83DC\u5355\u680F\u4E2D\uFF0C\u627E\u5230 <code>Admin</code>, \u7136\u540E\u9009\u62E9 <code>Runner</code>\uFF0C\u53EF\u4EE5\u67E5\u770B\u5230\u5F53\u524D\u7684Runner\u8FDE\u63A5\u60C5\u51B5\u3002</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204250848560.png" alt="image-20220424231816380" loading="lazy"></p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204250848031.png" alt="image-20220424232117034" loading="lazy"></p><h3 id="_4-helm\u90E8\u7F72runner" tabindex="-1"><a class="header-anchor" href="#_4-helm\u90E8\u7F72runner" aria-hidden="true">#</a> 4.Helm\u90E8\u7F72Runner</h3><p><strong>\u4EC0\u4E48\u662FHelm\uFF1F</strong></p><p>\u5C31\u50CF Java \u4F7F\u7528 maven\uFF1Bnode \u4F7F\u7528 npm\uFF1Bpython \u4F7F\u7528 pip\uFF1BLinux \u4F7F\u7528 yum \u6216 Apt \u4E00\u6837\uFF0C\u4E0D\u7BA1\u662F\u4EC0\u4E48\u6837\u7684\u5DE5\u4F5C\uFF0C\u6280\u672F\u4EBA\u5458\u90FD\u4F1A\u5E0C\u671B\u6709\u4E00\u79CD\u8D44\u6E90\u7BA1\u7406\u5668/\u5305\u7BA1\u7406\u5668\uFF0C\u4EE5\u6B64\u6765\u65B9\u4FBF\u5F97\u67E5\u627E\u3001\u4E0B\u8F7D\u3001\u5B89\u88C5\u3001\u4F7F\u7528\u548C\u5206\u53D1\u8F6F\u4EF6\u5305\u3002</p><p>Helm \u4F7F\u7528\u7684\u5305\u683C\u5F0F\u79F0\u4E3A <code>chart</code>\uFF0C\u5B83\u662F\u4E00\u4E2A\u63CF\u8FF0 Kubernetes \u76F8\u5173\u8D44\u6E90\u5BF9\u8C61\u7684\u6587\u4EF6\u96C6\u5408\u3002\u5B83\u7684\u6280\u672F\u7279\u70B9\u7C7B\u4F3C jinja\u6A21\u7248\uFF0C\u4EE5\u6E32\u67D3\u6A21\u7248\u7684\u65B9\u5F0F\uFF0C\u751F\u6210\u8FD0\u884C\u4E00\u4E2A\u670D\u52A1\u5B9E\u4F8B\u6240\u9700\u7684\u4E00\u7CFB\u5217\u8D44\u6E90\u5BF9\u8C61\u6587\u4EF6\uFF0C\u5E76\u4EE5\u6B64\u8FDB\u884C\u670D\u52A1\u7684\u53D1\u5E03\u3002\u901A\u8FC7\u8FD9\u79CD\u65B9\u5F0F\uFF0C\u6211\u4EEC\u4E5F\u53EF\u4EE5\u5341\u5206\u7B80\u5355\u7684\u5236\u4F5C\u81EA\u5B9A\u4E49\u7684 chart\u3002</p><p>\u6240\u4EE5 Helm \u5373\u53EF\u4EE5\u8BF4\u662F <code>K8S\u7684\u5305\u7BA1\u7406\u5668</code>\uFF0C\u5B83\u4F7F\u5F97\u6211\u4EEC\u5BF9\u4E8E K8S \u7684\u64CD\u4F5C\u4E0D\u518D\u9700\u8981\u7EC6\u5316\u5230\u8D44\u6E90\u5BF9\u8C61\uFF0C\u800C\u662F\u53EF\u4EE5\u4F5C\u4E3A\u4E00\u4E2A\u5B9E\u4F8B\u8FDB\u884C\u7BA1\u7406\u3002\u4E0D\u518D\u9700\u8981\u53BB\u5199 <code>deployment</code> \u3001<code>service</code> \u3001<code>ingress</code> \u7684 yaml\uFF0C\u800C\u662F\u53EF\u4EE5\u76F4\u63A5\u901A\u8FC7 <code>install</code> \u547D\u4EE4\u5B9E\u73B0\u670D\u52A1\u5B9E\u4F8B\u7684\u5B89\u88C5\u3002</p><p><strong>1.\u62C9\u53D6Gitlab-Runner\u7684Chart\u5305</strong></p>`,24),h={href:"https://links.jianshu.com/go?to=https%3A%2F%2Fgitlab.com%2Fgitlab-org%2Fcharts%2Fgitlab-runner",target:"_blank",rel:"noopener noreferrer"},y=t(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master gitlab-runner<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">12</span>
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">369</span> Feb <span class="token number">21</span> 03:39 Chart.yaml
drwxr-xr-x <span class="token number">2</span> root root  <span class="token number">236</span> Apr <span class="token number">24</span> 05:48 templates
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">6452</span> Apr <span class="token number">24</span> 05:47 values.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2.\u914D\u7F6EChart\u7684\u6A21\u677F</strong></p><p>\u4FEE\u6539Chart\u5305\u7684values.yaml\u914D\u7F6E\u5982\u4E0B\uFF1A</p><ul><li><code>gitlabUrl:</code> \u914D\u7F6EGitlab\u7684URL</li><li><code>runnerRegistrationToken:</code> \u914D\u7F6EGitlab\u7684Runner\u7684Token</li><li><code>namespace:</code> \u914D\u7F6E\u547D\u540D\u7A7A\u95F4</li><li><code>tags:</code> \u914D\u7F6E\u6807\u7B7E</li><li><code>cachePath:</code> \u914D\u7F6E\u7F13\u5B58\u8DEF\u5F84</li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">image</span><span class="token punctuation">:</span> gitlab/gitlab<span class="token punctuation">-</span>runner<span class="token punctuation">:</span>alpine<span class="token punctuation">-</span>v11.7.0
<span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
<span class="token key atrule">init</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
  <span class="token key atrule">tag</span><span class="token punctuation">:</span> v1.0
<span class="token key atrule">gitlabUrl</span><span class="token punctuation">:</span> <span class="token string">&quot;http://10.11.121.111&quot;</span>
<span class="token key atrule">runnerRegistrationToken</span><span class="token punctuation">:</span> <span class="token string">&quot;o4_NCTZvpnViRE7iGxoi&quot;</span>
<span class="token key atrule">unregisterRunners</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">concurrent</span><span class="token punctuation">:</span> <span class="token number">10</span>
<span class="token key atrule">checkInterval</span><span class="token punctuation">:</span> <span class="token number">30</span>
<span class="token key atrule">rbac</span><span class="token punctuation">:</span>
  <span class="token key atrule">create</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">clusterWideAccess</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">metrics</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">:</span><span class="token number">16.04</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">&quot;k8s&quot;</span>
  <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> demo
  <span class="token key atrule">cachePath</span><span class="token punctuation">:</span> <span class="token string">&quot;/opt/cache&quot;</span>
  <span class="token key atrule">cache</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">builds</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">services</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">helpers</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> 
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3.Helm\u90E8\u7F72Gitlab-Runner</strong></p><p>\u4F7F\u7528<code>helm install</code>\u547D\u4EE4\u521B\u5EFA\u5B89\u88C5Gitlab\u2014Runner\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master gitlab-cicd<span class="token punctuation">]</span><span class="token comment"># helm install k8s-runner gitlab-runner/ -n demo</span>
<span class="token punctuation">[</span>root@k8s-master gitlab-cicd<span class="token punctuation">]</span><span class="token comment"># helm list -n demo </span>
NAME      	NAMESPACE	REVISION	UPDATED                                	STATUS  	CHART               	APP VERSION
k8s-runner	demo     	<span class="token number">1</span>       	<span class="token number">2022</span>-04-24 <span class="token number">13</span>:13:11.742949709 +0000 UTC	deployed	gitlab-runner-0.1.37	
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>4.\u67E5\u770BGitlab\u8FDE\u63A5\u60C5\u51B5</strong></p><p>1.\u67E5\u770B\u5F53\u524D\u7684\u8D44\u6E90\u662F\u5426\u521B\u5EFA\u6210\u529F\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get -n demo all</span>
NAME                                            READY   STATUS    RESTARTS   AGE
pod/k8s-runner-gitlab-runner-544f469c44-9m7zw   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          155m

NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/k8s-runner-gitlab-runner   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           155m

NAME                                                  DESIRED   CURRENT   READY   AGE
replicaset.apps/k8s-runner-gitlab-runner-544f469c44   <span class="token number">1</span>         <span class="token number">1</span>         <span class="token number">1</span>       155m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2.\u56DE\u5230Gitlab\u5237\u65B0CICD\u7684Runner\u7684\u914D\u7F6E\uFF0C\u65B0\u7684Gitlab-Runner\u8FDE\u63A5\u6210\u529F\u3002</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204250848984.png" alt="image-20220424235055148" loading="lazy"></p><p><strong>3.\u6D4B\u8BD5GitLab\u7684CICD\u6D41\u6C34\u7EBF</strong></p><p>1.\u8FDB\u5165demo\u7684\u9879\u76EE,\u70B9\u51FB <code>CI/CD</code>\uFF0C\u7136\u540E\u627E\u5230<code>Editor</code> \uFF0C\u7F16\u5199\u4E00\u4E2A\u6D41\u6C34\u7EBF\u811A\u672C\uFF0C\u8FD0\u884Cjob1\uFF0C\u8F93\u51FAHello Word\u3002</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204250848184.png" alt="image-20220425000049979" loading="lazy"></p><p>\u5982\u4E0A\u7684.gitlab-ci.yaml\u6587\u4EF6\u5982\u4E0B\uFF1A</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">stages</span><span class="token punctuation">:</span> 
  <span class="token punctuation">-</span> .pre
  <span class="token punctuation">-</span> build
  <span class="token punctuation">-</span> test
  <span class="token punctuation">-</span> deploy 

<span class="token key atrule">job1</span><span class="token punctuation">:</span> 
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> .pre
  <span class="token key atrule">script</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> echo &quot;Hello Word&quot;

<span class="token key atrule">job2</span><span class="token punctuation">:</span> 
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> build
  <span class="token key atrule">script</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> echo &quot;This is build&quot;

<span class="token key atrule">job3</span><span class="token punctuation">:</span> 
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> test
  <span class="token key atrule">script</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> echo &quot;This is test&quot;

<span class="token key atrule">job4</span><span class="token punctuation">:</span> 
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> deploy
  <span class="token key atrule">script</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> echo &quot;This is deploy&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2.\u70B9\u51FB <code>Commit changes </code> \u63D0\u4EA4\u6D41\u6C34\u7EBF\u811A\u672C\u3002</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204250848169.png" alt="image-20220425000312131" loading="lazy"></p><p>3.\u6784\u5EFA\u5B8C\u6210\u4E4B\u540E\uFF0C\u67E5\u770B\u5F53\u524D\u7684\u90E8\u7F72\u60C5\u51B5\uFF0C\u53EF\u4EE5\u53D1\u73B0\u56DB\u4E2A\u9636\u6BB5\u7684\u4EFB\u52A1\u90FD\u6B63\u5E38\u90E8\u7F72\uFF0C\u6240\u4EE5\u8BF4\u660EGitlab-CI\u5DF2\u7ECF\u53EF\u4EE5\u6B63\u5E38\u8FD0\u884C\u3002</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204250848335.png" alt="image-20220425000806089" loading="lazy"></p><p>4.\u70B9\u51FBJob1\uFF0C\u67E5\u770B\u5F53\u524D\u7684Job1\u8F93\u51FA\u7684\u65E5\u5FD7\uFF0C\u662F\u5426\u4E3AHello Word\u3002</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204250848471.png" alt="image-20220425001000417" loading="lazy"></p><p>\u5982\u4E0A\u56FE\u53EF\u4EE5\u770B\u5230Job1\u4EFB\u52A1\u8F93\u51FA\u7684\u5185\u5BB9\u6B63\u5E38\u3002</p><h2 id="\u90E8\u7F72harbor" tabindex="-1"><a class="header-anchor" href="#\u90E8\u7F72harbor" aria-hidden="true">#</a> \u90E8\u7F72Harbor</h2><h3 id="_1-harbor\u4ECB\u7ECD" tabindex="-1"><a class="header-anchor" href="#_1-harbor\u4ECB\u7ECD" aria-hidden="true">#</a> 1.Harbor\u4ECB\u7ECD</h3><p>Harbor \u6E90\u4E8E 2014 \u5E74 VMware\u4E2D\u56FD\u7814\u53D1\u4E2D\u5FC3\u4E91\u539F\u751F\u5B9E\u9A8C\u5BA4\u7684\u4E00\u4E2A\u5185\u90E8\u9879\u76EE\uFF0C\u65E8\u5728\u4E3A\u5BB9\u5668\u7684\u5F00\u53D1\u4EBA\u5458\u89E3\u51B3\u955C\u50CF\u7BA1\u7406\u7684\u95EE\u9898\u3002\u968F\u7740 Kubernetes \u548C\u5BB9\u5668\u6280\u672F\u7684\u6D41\u884C\uFF0C\u8BE5\u9879\u76EE\u4E8E 2016 \u5E74\u5F00\u6E90\uFF0C2018 \u5E74 7 \u6708\u6350\u8D60\u7ED9 CNCF\uFF0C\u5728\u540C\u5E74 11 \u6708\u88AB\u6B63\u5F0F\u63A5\u53D7\u4E3A\u5B75\u5316\u9879\u76EE\uFF0C\u5E76\u5728\u4E91\u539F\u751F\u6280\u672F\u8DEF\u7EBF\u4E0E\u751F\u6001\u4E2D\u6F14\u8FDB\u3002</p><p>2020\u5E745\u6708 Harbor 2.0 \u6B63\u5F0F\u53D1\u5E03\uFF0C\u589E\u52A0\u4E86\u5BF9 OCI \u5236\u54C1\u7684\u652F\u6301\uFF0C\u80FD\u591F\u5B58\u50A8\u5927\u91CF\u4E91\u539F\u751F\u5236\u54C1\uFF0C\u4F8B\u5982\u5BB9\u5668\u955C\u50CF\u3001Helm Chart\u3001CNAB\u3001OPA \u548C Singularity \u7B49\u7B49\u3002\u5F00\u53D1\u4EBA\u5458\u53EF\u4F9D\u7167 OCI \u89C4\u8303\uFF0C\u901A\u8FC7 OCI \u7D22\u5F15\u548C OCI \u5236\u54C1\u529F\u80FD\u5F00\u62D3\u66F4\u5E7F\u6CDB\u7684\u5E94\u7528\u573A\u666F\uFF0C\u5305\u62EC\u7B56\u7565\u3001\u8FDC\u7A0B\u590D\u5236\u548C\u57FA\u4E8E\u89D2\u8272\u7684\u8BBF\u95EE\u63A7\u5236\u7B49\u3002</p><h3 id="_2-harbor\u90E8\u7F72" tabindex="-1"><a class="header-anchor" href="#_2-harbor\u90E8\u7F72" aria-hidden="true">#</a> 2.Harbor\u90E8\u7F72</h3><ul><li>\u9996\u9009\u5FC5\u987B\u5B89\u88C5docker-compose\u7684\u63D2\u4EF6\uFF0C\u8FD9\u91CC\u6211\u5DF2\u7ECF\u5B89\u88C5\u4E86docker-compose</li><li>\u7981\u7528https\u7B56\u7565\uFF0C\u4F7F\u7528http\u7B56\u7565</li><li>\u5C06hostname\u4FEE\u6539\u4E3A10.11.121.112</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-node1 harbor<span class="token punctuation">]</span><span class="token comment"># docker-compose version </span>
Docker Compose version v2.2.1
<span class="token punctuation">[</span>root@k8s-node1 opt<span class="token punctuation">]</span><span class="token comment"># tar zxvf harbor-offline.tar.gz </span>
<span class="token punctuation">[</span>root@k8s-node1 opt<span class="token punctuation">]</span><span class="token comment"># cd harbor/</span>
<span class="token punctuation">[</span>root@k8s-node1 opt<span class="token punctuation">]</span><span class="token comment"># vim harbor.yaml </span>
hostname: <span class="token number">10.11</span>.121.112

<span class="token comment"># http related config</span>
http:
  <span class="token comment"># port for http, default is 80. If https enabled, this port will redirect to https port</span>
  port: <span class="token number">80</span>

<span class="token comment"># https related config</span>
<span class="token comment">#https:</span>
  <span class="token comment"># https port for harbor, default is 443</span>
<span class="token comment">#  port: 443</span>
  <span class="token comment"># The path of cert and key files for nginx</span>
<span class="token comment">#  certificate: /your/certificate/path</span>
<span class="token comment">#  private_key: /your/private/key/path</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6267\u884C\u547D\u4EE4\u5B89\u88C5Harbor\uFF0C\u67E5\u770Bharbor\u7684\u8FDB\u7A0B\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-node1 harbor<span class="token punctuation">]</span><span class="token comment"># ./install.sh </span>
<span class="token punctuation">[</span>Step <span class="token number">0</span><span class="token punctuation">]</span>: checking <span class="token keyword">if</span> <span class="token function">docker</span> is installed <span class="token punctuation">..</span>.
Note: <span class="token function">docker</span> version: <span class="token number">20.10</span>.14

<span class="token punctuation">[</span>Step <span class="token number">1</span><span class="token punctuation">]</span>: checking <span class="token function">docker-compose</span> is installed <span class="token punctuation">..</span>.
Note: <span class="token function">docker-compose</span> version: <span class="token number">2.2</span>.1

<span class="token punctuation">[</span>Step <span class="token number">2</span><span class="token punctuation">]</span>: loading Harbor images <span class="token punctuation">..</span>.
\xB7\xB7\xB7
<span class="token punctuation">[</span>Step <span class="token number">5</span><span class="token punctuation">]</span>: starting Harbor <span class="token punctuation">..</span>.
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Running <span class="token number">10</span>/10
 \u283F Network harbor_harbor        Created                                                                                                 <span class="token number">0</span>.1s
 \u283F Container harbor-log         Started                                                                                                 <span class="token number">1</span>.6s
 \u283F Container harbor-db          Started                                                                                                 <span class="token number">2</span>.6s
 \u283F Container registryctl        Started                                                                                                 <span class="token number">3</span>.2s
 \u283F Container harbor-portal      Started                                                                                                 <span class="token number">2</span>.8s
 \u283F Container registry           Started                                                                                                 <span class="token number">3</span>.2s
 \u283F Container redis              Started                                                                                                 <span class="token number">3</span>.2s
 \u283F Container harbor-core        Started                                                                                                 <span class="token number">4</span>.0s
 \u283F Container nginx              Started                                                                                                 <span class="token number">5</span>.3s
 \u283F Container harbor-jobservice  Started                                                                                                 <span class="token number">5</span>.3s
\u2714 ----Harbor has been installed and started successfully.----


<span class="token punctuation">[</span>root@k8s-node1 harbor<span class="token punctuation">]</span><span class="token comment"># docker-compose  ps </span>
NAME                COMMAND                  SERVICE             STATUS              PORTS
harbor-core         <span class="token string">&quot;/harbor/entrypoint.\u2026&quot;</span>   core                running <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>   
harbor-db           <span class="token string">&quot;/docker-entrypoint.\u2026&quot;</span>   postgresql          running <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>   
harbor-jobservice   <span class="token string">&quot;/harbor/entrypoint.\u2026&quot;</span>   jobservice          running <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>   
harbor-log          <span class="token string">&quot;/bin/sh -c /usr/loc\u2026&quot;</span>   log                 running <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>   <span class="token number">127.0</span>.0.1:1514-<span class="token operator">&gt;</span><span class="token number">10514</span>/tcp
harbor-portal       <span class="token string">&quot;nginx -g &#39;daemon of\u2026&quot;</span>   portal              running <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>   
nginx               <span class="token string">&quot;nginx -g &#39;daemon of\u2026&quot;</span>   proxy               running <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>   <span class="token number">0.0</span>.0.0:80-<span class="token operator">&gt;</span><span class="token number">8080</span>/tcp, :::80-<span class="token operator">&gt;</span><span class="token number">8080</span>/tcp
redis               <span class="token string">&quot;redis-server /etc/r\u2026&quot;</span>   redis               running <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>   
registry            <span class="token string">&quot;/home/harbor/entryp\u2026&quot;</span>   registry            running <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>   
registryctl         <span class="token string">&quot;/home/harbor/start.\u2026&quot;</span>   registryctl         running <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,34),x={href:"http://10.11.121.112",target:"_blank",rel:"noopener noreferrer"},f=t(`<p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204250848345.png" alt="image-20220425001823055" loading="lazy"></p><h3 id="_3-\u6DFB\u52A0\u955C\u50CF\u4ED3\u5E93" tabindex="-1"><a class="header-anchor" href="#_3-\u6DFB\u52A0\u955C\u50CF\u4ED3\u5E93" aria-hidden="true">#</a> 3.\u6DFB\u52A0\u955C\u50CF\u4ED3\u5E93</h3><p>\u70B9\u51FB <code>\u65B0\u5EFA\u9879\u76EE</code> \uFF0C\u521B\u5EFA\u9879\u76EE\u540D\u79F0\u4E3A <code>demo</code>\uFF0C\u8BBF\u95EE\u7EA7\u522B\u8BBE\u7F6E\u4E3A <code>\u516C\u5F00</code>\u3002</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204250848880.png" alt="image-20220425002022377" loading="lazy"></p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204250848072.png" alt="image-20220425002121911" loading="lazy"></p><h2 id="\u914D\u7F6Ecicd" tabindex="-1"><a class="header-anchor" href="#\u914D\u7F6Ecicd" aria-hidden="true">#</a> \u914D\u7F6ECICD</h2><h3 id="_1-\u914D\u7F6E-gitlab-ci-yml" tabindex="-1"><a class="header-anchor" href="#_1-\u914D\u7F6E-gitlab-ci-yml" aria-hidden="true">#</a> 1.\u914D\u7F6E.gitlab-ci.yml</h3><p>\u914D\u7F6E.gitlab-ci.yaml\u7684\u6D41\u6C34\u7EBF\u914D\u7F6E\u6587\u4EF6\u5185\u5BB9\u5982\u4E0B\uFF1A</p><ul><li>\u4F7F\u7528<code>docker:v1.0</code>\u7684\u955C\u50CF\u4F5C\u4E3A\u57FA\u7840\u955C\u50CF</li><li>\u9700\u8981\u6784\u5EFA\u4E09\u4E2A\u6B65\u9AA4\uFF1A<code>maven-build\u3001docker-build\u3001deploy</code></li><li>\u4F7F\u7528<code>maven\u955C\u50CF</code>\u6784\u5EFA\u7F16\u8BD1demo-2048\u9879\u76EE</li><li>\u4F7F\u7528<code>docker\u955C\u50CF</code>build\u65B0\u7684\u955C\u50CF\uFF0C\u63A8\u9001\u5230Harbor\u4ED3\u5E93\u4E2D</li><li>\u4F7F\u7528<code>kubelet\u955C\u50CF</code>\u90E8\u7F72demo-2048\u7684yaml\u6587\u4EF6</li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">image</span><span class="token punctuation">:</span> docker<span class="token punctuation">:</span>v1.0
<span class="token key atrule">stages</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> maven<span class="token punctuation">-</span>build
  <span class="token punctuation">-</span> docker<span class="token punctuation">-</span>build
  <span class="token punctuation">-</span> deploy

<span class="token comment"># \u8FD9\u662F\u5B9A\u4E49\u7684\u53D8\u91CF\uFF0C\u662FHarbor\u4ED3\u5E93\u767B\u5F55\u7684\u9A8C\u8BC1\u4FE1\u606F\u3002</span>
<span class="token key atrule">variables</span><span class="token punctuation">:</span>
  <span class="token key atrule">USERNAME</span><span class="token punctuation">:</span> admin
  <span class="token key atrule">PASSWORD</span><span class="token punctuation">:</span> Harbor12345
  <span class="token key atrule">HARBORIP</span><span class="token punctuation">:</span> 10.11.121.112

<span class="token key atrule">maven-build</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> maven<span class="token punctuation">:</span>3.6<span class="token punctuation">-</span>jdk<span class="token punctuation">-</span><span class="token number">8</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> maven<span class="token punctuation">-</span>build 
  <span class="token key atrule">script</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> mkdir <span class="token punctuation">-</span>p /root/.m2/repository
    <span class="token punctuation">-</span> cp <span class="token punctuation">-</span>rvf /opt/repository/*  /root/.m2/repository/
    <span class="token punctuation">-</span> mvn clean install <span class="token punctuation">-</span>Dmaven.test.sktip=true
    <span class="token punctuation">-</span> cp <span class="token punctuation">-</span>rvf /root/demo/target/demo<span class="token punctuation">-</span>2048  /opt/cache

<span class="token key atrule">docker_build</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> docker<span class="token punctuation">:</span>v1.0
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>build
  <span class="token key atrule">script</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> mv /opt/cache/* /root/demo/Dockerfiles/
    <span class="token punctuation">-</span> cd /root/demo/Dockerfiles/ <span class="token important">&amp;&amp;</span> ls
    <span class="token punctuation">-</span> docker build <span class="token punctuation">-</span>t $HARBORIP/demo/demo<span class="token punctuation">-</span>2048<span class="token punctuation">:</span>v1.0 <span class="token punctuation">-</span>f /root/demo/Dockerfiles/Dockerfile . 
    <span class="token punctuation">-</span> docker login <span class="token punctuation">-</span>u $USERNAME <span class="token punctuation">-</span>p $PASSWORD $HARBORIP 
    <span class="token punctuation">-</span> docker push $HARBORIP/demo/demo<span class="token punctuation">-</span>2048<span class="token punctuation">:</span>v1.0

<span class="token comment"># \u8FD9\u91CC\u7684kubectl\u662F\u505A\u7684\u955C\u50CF\uFF0C\u662F\u5728\u672C\u5730\u4ED3\u5E93\uFF0C\u4F7F\u7528config\u8FDE\u63A5Kubernetes\u96C6\u7FA4</span>
<span class="token key atrule">deploy</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> kubectl<span class="token punctuation">:</span>1.16.6
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> deploy 
  <span class="token key atrule">script</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> mkdir $HOME/.kube <span class="token important">&amp;&amp;</span> cat $K8S_CONFIG <span class="token punctuation">&gt;</span> $HOME/.kube/config
    <span class="token punctuation">-</span> cd $HOME/.kube <span class="token important">&amp;&amp;</span> pwd
    <span class="token punctuation">-</span> sed <span class="token punctuation">-</span>i &#39;s/10.24.2.3/10.11.121.112/g&#39; /root/demo/template/demo<span class="token punctuation">-</span>2048.yaml 
    <span class="token punctuation">-</span> sed <span class="token punctuation">-</span>i &#39;s/<span class="token punctuation">{</span><span class="token punctuation">{</span>build_tag<span class="token punctuation">}</span><span class="token punctuation">}</span>/v1.0/g&#39; /root/demo/template/demo<span class="token punctuation">-</span>2048.yaml 
    <span class="token punctuation">-</span> sed <span class="token punctuation">-</span>i &#39;s/8889/30003/g&#39; /root/demo/template/demo<span class="token punctuation">-</span>2048.yaml 
    <span class="token punctuation">-</span> kubectl apply <span class="token punctuation">-</span>f /root/demo/template/demo<span class="token punctuation">-</span>2048.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u5F00\u59CB\u6784\u5EFA" tabindex="-1"><a class="header-anchor" href="#_2-\u5F00\u59CB\u6784\u5EFA" aria-hidden="true">#</a> 2.\u5F00\u59CB\u6784\u5EFA</h3><p>\u70B9\u51FB <code>\u63D0\u4EA4\u5B8C\u6210</code> \u6784\u5EFACICD\u3002</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204250848856.png" alt="image-20220425003143807" loading="lazy"></p><p>\u7B49\u5F85\u7ED3\u679C\uFF1A</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204250848288.png" alt="image-20220425003438600" loading="lazy"></p><h3 id="_3-\u67E5\u770Bgitlab-ci" tabindex="-1"><a class="header-anchor" href="#_3-\u67E5\u770Bgitlab-ci" aria-hidden="true">#</a> 3.\u67E5\u770BGitlab-CI</h3><p>\u67E5\u770B\u6784\u5EFA\u7684\u8F93\u51FA\u65E5\u5FD7\u5185\u5BB9\u3002</p><p>\u5982\u4E0B\u662Fmaven-build\u7684\u8F93\u51FA\u5185\u5BB9\uFF1A</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204250848151.png" alt="image-20220425003531697" loading="lazy"></p><p>\u5982\u4E0B\u662Fdocker-build\u7684\u8F93\u51FA\u5185\u5BB9\uFF1A</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204250848855.png" alt="image-20220425003550405" loading="lazy"></p><p>\u5982\u4E0B\u662Fdeploy\u7684\u8F93\u51FA\u5185\u5BB9\uFF1A</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204250848591.png" alt="image-20220425003605898" loading="lazy"></p><h3 id="_4-\u8BBF\u95EE\u9879\u76EE" tabindex="-1"><a class="header-anchor" href="#_4-\u8BBF\u95EE\u9879\u76EE" aria-hidden="true">#</a> 4.\u8BBF\u95EE\u9879\u76EE</h3><p>\u67E5\u770B\u5F53\u524D\u7684demo\u547D\u540D\u7A7A\u95F4\u4E0B\u7684\u8D44\u6E90\uFF0Cdemo-2048\u5E94\u7528\u7A0B\u5E8F\u90E8\u7F72\u5B8C\u6210\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get  pods -n demo</span>
NAME                                        READY   STATUS    RESTARTS   AGE
demo-2048-6858bb9f8d-522rn                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m19s
k8s-runner-gitlab-runner-544f469c44-9m7zw   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3h23m
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -n demo </span>
NAME        TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>          AGE
demo30003   NodePort   <span class="token number">10.96</span>.113.92   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8080</span>:30003/TCP   3m24s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,26),_={href:"http://10.11.121.112:30003",target:"_blank",rel:"noopener noreferrer"},q=n("p",null,[n("img",{src:"https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204250849199.png",alt:"image-20220425003906131",loading:"lazy"})],-1);function R(C,G){const a=l("ExternalLinkIcon");return p(),o("div",null,[r,n("p",null,[u,s(),n("a",d,[s("https://gitee.com/isicman/demo-2048.git"),e(a)])]),m,n("p",null,[s("3.\u901A\u8FC7\u6D4F\u89C8\u5668\u8BBF\u95EEGitLab\u7684\u9875\u9762\uFF1A "),n("a",k,[s("http://10.11.121.111"),e(a)])]),b,n("p",null,[s("GitLab Runner\u662F\u4E00\u4E2A"),n("a",v,[s("\u5F00\u6E90\u9879\u76EE"),e(a)]),s("\uFF0C\u7528\u4E8E\u8FD0\u884C\u60A8\u7684\u4F5C\u4E1A\u5E76\u5C06\u7ED3\u679C\u53D1\u9001\u56DEGitLab\u3002\u5B83\u4E0EGitLab CI\u4E00\u8D77\u4F7F\u7528\uFF0CGitLab CI\u662FGitLab\u968F\u9644\u7684\u5F00\u6E90\u6301\u7EED\u96C6\u6210\u670D\u52A1\uFF0C\u7528\u4E8E\u534F\u8C03\u4F5C\u4E1A\u3002")]),g,n("p",null,[s("\u9879\u76EE\u5730\u5740\uFF1A"),n("a",h,[s("https://gitlab.com/gitlab-org/charts/gitlab-runner"),e(a)])]),y,n("p",null,[s("\u8BBF\u95EEHarbor\u5730\u5740\uFF1A "),n("a",x,[s("http://10.11.121.112"),e(a)])]),f,n("p",null,[s("\u8BBF\u95EE\u9875\u9762\uFF1A "),n("a",_,[s("http://10.11.121.112:30003"),e(a)])]),q])}const E=i(c,[["render",R],["__file","3.GitLab-CI + Harbor + Kubernetes.html.vue"]]);export{E as default};
